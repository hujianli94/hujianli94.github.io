<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="stay hungry,stay foolish"><meta name=author content=hujainli94><link href=https://hujianli94.github.io/Linux/Ansible/0.Ansible%E5%85%A5%E9%97%A8/ rel=canonical><link href=../../serveices/0.ubuntu-desktop-vmware/ rel=prev><link href=../1.Ansible%E6%89%A9%E5%B1%95%E9%98%85%E8%AF%BB/ rel=next><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-9.1.6"><title>Ansible入门 - DevOps运维开发</title><link rel=stylesheet href=../../../assets/stylesheets/main.ded33207.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.a0c5b2b5.min.css><style>:root{--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.752 1.752 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25ZM6 5a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"/></svg>');--md-admonition-icon--abstract:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.5 1.75v11.5c0 .138.112.25.25.25h3.17a.75.75 0 0 1 0 1.5H2.75A1.75 1.75 0 0 1 1 13.25V1.75C1 .784 1.784 0 2.75 0h8.5C12.216 0 13 .784 13 1.75v7.736a.75.75 0 0 1-1.5 0V1.75a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25Zm13.274 9.537v-.001l-4.557 4.45a.75.75 0 0 1-1.055-.008l-1.943-1.95a.75.75 0 0 1 1.062-1.058l1.419 1.425 4.026-3.932a.75.75 0 1 1 1.048 1.074ZM4.75 4h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM4 7.75A.75.75 0 0 1 4.75 7h2a.75.75 0 0 1 0 1.5h-2A.75.75 0 0 1 4 7.75Z"/></svg>');--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>');--md-admonition-icon--tip:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M3.499.75a.75.75 0 0 1 1.5 0v.996C5.9 2.903 6.793 3.65 7.662 4.376l.24.202c-.036-.694.055-1.422.426-2.163C9.1.873 10.794-.045 12.622.26 14.408.558 16 1.94 16 4.25c0 1.278-.954 2.575-2.44 2.734l.146.508.065.22c.203.701.412 1.455.476 2.226.142 1.707-.4 3.03-1.487 3.898C11.714 14.671 10.27 15 8.75 15h-6a.75.75 0 0 1 0-1.5h1.376a4.484 4.484 0 0 1-.563-1.191 3.835 3.835 0 0 1-.05-2.063 4.647 4.647 0 0 1-2.025-.293.75.75 0 0 1 .525-1.406c1.357.507 2.376-.006 2.698-.318l.009-.01a.747.747 0 0 1 1.06 0 .748.748 0 0 1-.012 1.074c-.912.92-.992 1.835-.768 2.586.221.74.745 1.337 1.196 1.621H8.75c1.343 0 2.398-.296 3.074-.836.635-.507 1.036-1.31.928-2.602-.05-.603-.216-1.224-.422-1.93l-.064-.221c-.12-.407-.246-.84-.353-1.29a2.425 2.425 0 0 1-.507-.441 3.075 3.075 0 0 1-.633-1.248.75.75 0 0 1 1.455-.364c.046.185.144.436.31.627.146.168.353.305.712.305.738 0 1.25-.615 1.25-1.25 0-1.47-.95-2.315-2.123-2.51-1.172-.196-2.227.387-2.706 1.345-.46.92-.27 1.774.019 3.062l.042.19a.884.884 0 0 1 .01.05c.348.443.666.949.94 1.553a.75.75 0 1 1-1.365.62c-.553-1.217-1.32-1.94-2.3-2.768L6.7 5.527c-.814-.68-1.75-1.462-2.692-2.619a3.737 3.737 0 0 0-1.023.88c-.406.495-.663 1.036-.722 1.508.116.122.306.21.591.239.388.038.797-.06 1.032-.19a.75.75 0 0 1 .728 1.31c-.515.287-1.23.439-1.906.373-.682-.067-1.473-.38-1.879-1.193L.75 5.677V5.5c0-.984.48-1.94 1.077-2.664.46-.559 1.05-1.055 1.673-1.353V.75Z"/></svg>');--md-admonition-icon--success:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg>');--md-admonition-icon--question:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.92 6.085h.001a.749.749 0 1 1-1.342-.67c.169-.339.436-.701.849-.977C6.845 4.16 7.369 4 8 4a2.756 2.756 0 0 1 1.637.525c.503.377.863.965.863 1.725 0 .448-.115.83-.329 1.15-.205.307-.47.513-.692.662-.109.072-.22.138-.313.195l-.006.004a6.24 6.24 0 0 0-.26.16.952.952 0 0 0-.276.245.75.75 0 0 1-1.248-.832c.184-.264.42-.489.692-.661.103-.067.207-.132.313-.195l.007-.004c.1-.061.182-.11.258-.161a.969.969 0 0 0 .277-.245C8.96 6.514 9 6.427 9 6.25a.612.612 0 0 0-.262-.525A1.27 1.27 0 0 0 8 5.5c-.369 0-.595.09-.74.187a1.01 1.01 0 0 0-.34.398ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>');--md-admonition-icon--warning:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>');--md-admonition-icon--failure:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.344 2.343h-.001a8 8 0 0 1 11.314 11.314A8.002 8.002 0 0 1 .234 10.089a8 8 0 0 1 2.11-7.746Zm1.06 10.253a6.5 6.5 0 1 0 9.108-9.275 6.5 6.5 0 0 0-9.108 9.275ZM6.03 4.97 8 6.94l1.97-1.97a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l1.97 1.97a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-1.97 1.97a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L6.94 8 4.97 6.03a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018Z"/></svg>');--md-admonition-icon--danger:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M9.504.43a1.516 1.516 0 0 1 2.437 1.713L10.415 5.5h2.123c1.57 0 2.346 1.909 1.22 3.004l-7.34 7.142a1.249 1.249 0 0 1-.871.354h-.302a1.25 1.25 0 0 1-1.157-1.723L5.633 10.5H3.462c-1.57 0-2.346-1.909-1.22-3.004L9.503.429Zm1.047 1.074L3.286 8.571A.25.25 0 0 0 3.462 9H6.75a.75.75 0 0 1 .694 1.034l-1.713 4.188 6.982-6.793A.25.25 0 0 0 12.538 7H9.25a.75.75 0 0 1-.683-1.06l2.008-4.418.003-.006a.036.036 0 0 0-.004-.009l-.006-.006-.008-.001c-.003 0-.006.002-.009.004Z"/></svg>');--md-admonition-icon--bug:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M4.72.22a.75.75 0 0 1 1.06 0l1 .999a3.488 3.488 0 0 1 2.441 0l.999-1a.748.748 0 0 1 1.265.332.75.75 0 0 1-.205.729l-.775.776c.616.63.995 1.493.995 2.444v.327c0 .1-.009.197-.025.292.408.14.764.392 1.029.722l1.968-.787a.75.75 0 0 1 .556 1.392L13 7.258V9h2.25a.75.75 0 0 1 0 1.5H13v.5c0 .409-.049.806-.141 1.186l2.17.868a.75.75 0 0 1-.557 1.392l-2.184-.873A4.997 4.997 0 0 1 8 16a4.997 4.997 0 0 1-4.288-2.427l-2.183.873a.75.75 0 0 1-.558-1.392l2.17-.868A5.036 5.036 0 0 1 3 11v-.5H.75a.75.75 0 0 1 0-1.5H3V7.258L.971 6.446a.75.75 0 0 1 .558-1.392l1.967.787c.265-.33.62-.583 1.03-.722a1.677 1.677 0 0 1-.026-.292V4.5c0-.951.38-1.814.995-2.444L4.72 1.28a.75.75 0 0 1 0-1.06Zm.53 6.28a.75.75 0 0 0-.75.75V11a3.5 3.5 0 1 0 7 0V7.25a.75.75 0 0 0-.75-.75ZM6.173 5h3.654A.172.172 0 0 0 10 4.827V4.5a2 2 0 1 0-4 0v.327c0 .096.077.173.173.173Z"/></svg>');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M5 5.782V2.5h-.25a.75.75 0 0 1 0-1.5h6.5a.75.75 0 0 1 0 1.5H11v3.282l3.666 5.76C15.619 13.04 14.543 15 12.767 15H3.233c-1.776 0-2.852-1.96-1.899-3.458Zm-2.4 6.565a.75.75 0 0 0 .633 1.153h9.534a.75.75 0 0 0 .633-1.153L12.225 10.5h-8.45ZM9.5 2.5h-3V6c0 .143-.04.283-.117.403L4.73 9h6.54L9.617 6.403A.746.746 0 0 1 9.5 6Z"/></svg>');--md-admonition-icon--quote:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1.75 2.5h10.5a.75.75 0 0 1 0 1.5H1.75a.75.75 0 0 1 0-1.5Zm4 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5Zm0 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5ZM2.5 7.75v6a.75.75 0 0 1-1.5 0v-6a.75.75 0 0 1 1.5 0Z"/></svg>');}</style><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../stylesheets/extra.css><link rel=stylesheet href=https://file.cdn.shafish.cn/blog/css/vssue.css><link rel=stylesheet href=https://file.cdn.shafish.cn/blog/css/video-js.min.css><link rel=stylesheet href=https://file.cdn.shafish.cn/blog/css/video.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#ansible入门 class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../.. title=DevOps运维开发 class="md-header__button md-logo" aria-label=DevOps运维开发 data-md-component=logo> <img src=../../../assets/images/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> DevOps运维开发 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Ansible入门 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label=切换至深色模式 type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title=切换至深色模式 for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=blue aria-label=切换至浅色模式 type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title=切换至浅色模式 for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=查找> <a href=javascript:void(0) class="md-search__icon md-icon" title=分享 aria-label=分享 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/hujianli94/hujianli94.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> hujianli94.github.io </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> 首页 </a> </li> <li class=md-tabs__item> <a href=../../../Kubernetes/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Kubernetes/ class=md-tabs__link> Kubernetes </a> </li> <li class=md-tabs__item> <a href=../../../Docker/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Docker/ class=md-tabs__link> Docker </a> </li> <li class=md-tabs__item> <a href=../../../Golang/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Go%20Web%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/ class=md-tabs__link> Golang </a> </li> <li class=md-tabs__item> <a href=../../../Python/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Pythjon-auto-ops/ class=md-tabs__link> Python </a> </li> <li class=md-tabs__item> <a href=../../../Python-vs-Go/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Python-vs-Go/ class=md-tabs__link> Python-vs-Go </a> </li> <li class=md-tabs__item> <a href=../../system/0.Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F%E4%B8%8B%E8%BD%BD/ class="md-tabs__link md-tabs__link--active"> Linux </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=DevOps运维开发 class="md-nav__button md-logo" aria-label=DevOps运维开发 data-md-component=logo> <img src=../../../assets/images/logo.png alt=logo> </a> DevOps运维开发 </label> <div class=md-nav__source> <a href=https://github.com/hujianli94/hujianli94.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> hujianli94.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> 首页 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1> <label class=md-nav__link for=__nav_2_1 id=__nav_2_1_label tabindex=0> 0.学习线路 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> 0.学习线路 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Kubernetes/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Kubernetes/ class=md-nav__link> Kubernetes </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex=0> 1.安装篇 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> 1.安装篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/ class=md-nav__link> Kubeadm安装高可用集群 </a> </li> <li class=md-nav__item> <a href=../../../Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/ class=md-nav__link> 二进制安装高可用K8s集群 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> 2.基础篇 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> 2.基础篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/ class=md-nav__link> Docker基础 </a> </li> <li class=md-nav__item> <a href=../../../Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/4.Kubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/ class=md-nav__link> Kubernetes的基础概念 </a> </li> <li class=md-nav__item> <a href=../../../Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/ class=md-nav__link> Kubernetes调度基础 </a> </li> <li class=md-nav__item> <a href=../../../Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/ class=md-nav__link> Kubernetes服务发布基础 </a> </li> <li class=md-nav__item> <a href=../../../Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/ class=md-nav__link> Kubernetes配置管理 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4 id=__nav_2_4_label tabindex=0> 3.进阶篇 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> 3.进阶篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/ class=md-nav__link> Kubernetes存储入门 </a> </li> <li class=md-nav__item> <a href=../../../Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/ class=md-nav__link> Kubernetes高级调度 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_5> <label class=md-nav__link for=__nav_2_5 id=__nav_2_5_label tabindex=0> 4.高级篇 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_5_label aria-expanded=false> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> 4.高级篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Kubernetes/4.%E9%AB%98%E7%BA%A7%E7%AF%87/12.%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AD%98%E5%82%A8Rook/ class=md-nav__link> 云原生存储Rook </a> </li> <li class=md-nav__item> <a href=../../../Kubernetes/4.%E9%AB%98%E7%BA%A7%E7%AF%87/13.%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%B9%E5%99%A8%E5%8C%96/ class=md-nav__link> 中间件容器化 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_6> <label class=md-nav__link for=__nav_2_6 id=__nav_2_6_label tabindex=0> 5.运维篇 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_6_label aria-expanded=false> <label class=md-nav__title for=__nav_2_6> <span class="md-nav__icon md-icon"></span> 5.运维篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/14.Kubernetes%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/ class=md-nav__link> Kubernetes日志收集 </a> </li> <li class=md-nav__item> <a href=../../../Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/ class=md-nav__link> Kubernetes监控告警 </a> </li> <li class=md-nav__item> <a href=../../../Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/ class=md-nav__link> 服务发布Ingress进阶 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_7> <label class=md-nav__link for=__nav_2_7 id=__nav_2_7_label tabindex=0> 6.DevOps篇 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_7_label aria-expanded=false> <label class=md-nav__title for=__nav_2_7> <span class="md-nav__icon md-icon"></span> 6.DevOps篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/ class=md-nav__link> DevOps实践 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> Docker <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1> <label class=md-nav__link for=__nav_3_1 id=__nav_3_1_label tabindex=0> 0.学习线路 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> 0.学习线路 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Docker/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Docker/ class=md-nav__link> Docker </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex=0> 1.Docker基础 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> 1.Docker基础 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Docker/1.Docker%E5%9F%BA%E7%A1%80/1.%E5%AE%89%E8%A3%85Docker/ class=md-nav__link> 安装Docker </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.Docker%E5%9F%BA%E7%A1%80/2.%E4%BD%BF%E7%94%A8Docker%E9%95%9C%E5%83%8F/ class=md-nav__link> 使用Docker镜像 </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.Docker%E5%9F%BA%E7%A1%80/3.%E6%93%8D%E4%BD%9CDocker%E5%AE%B9%E5%99%A8/ class=md-nav__link> 操作Docker容器 </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.Docker%E5%9F%BA%E7%A1%80/4.%E6%90%AD%E5%BB%BA%E6%9C%AC%E5%9C%B0%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/ class=md-nav__link> 搭建本地私有仓库 </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.Docker%E5%9F%BA%E7%A1%80/5.Docker%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/ class=md-nav__link> Docker数据管理 </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.Docker%E5%9F%BA%E7%A1%80/6.Docker%E4%BD%BF%E7%94%A8%E7%BD%91%E7%BB%9C/ class=md-nav__link> Docker使用网络 </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.Docker%E5%9F%BA%E7%A1%80/7.Dockerfile/ class=md-nav__link> Dockerfile </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.Docker%E5%9F%BA%E7%A1%80/8.docker-compose/ class=md-nav__link> docker-compose </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.Docker%E5%9F%BA%E7%A1%80/9.Docker%E7%9B%B8%E5%85%B3%E8%84%9A%E6%9C%AC/ class=md-nav__link> Docker相关脚本 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex=0> 2.实战案例 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> 2.实战案例 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Docker/2.%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/1.%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/ class=md-nav__link> 操作系统 </a> </li> <li class=md-nav__item> <a href=../../../Docker/2.%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/2.Web%E6%9C%8D%E5%8A%A1%E4%B8%8E%E5%BA%94%E7%94%A8/ class=md-nav__link> Web服务与应用 </a> </li> <li class=md-nav__item> <a href=../../../Docker/2.%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/3.%E6%8C%81%E7%BB%AD%E5%BC%80%E5%8F%91%E4%B8%8E%E7%AE%A1%E7%90%86/ class=md-nav__link> 持续开发与管理 </a> </li> <li class=md-nav__item> <a href=../../../Docker/2.%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/4.%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BA%94%E7%94%A8/ class=md-nav__link> 数据库应用 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex=0> 3.Devops <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> 3.Devops </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Docker/3.Devops/1.ConfCenter/ class=md-nav__link> ConfCenter </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/2.CoreDNS/ class=md-nav__link> Coredns </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/3.Harbor/ class=md-nav__link> Harbor </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/4.Python%E6%93%8D%E4%BD%9CDocker/ class=md-nav__link> Python操作Docker </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/5.Haproxy/ class=md-nav__link> Haproxy </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/6.Nexus/ class=md-nav__link> Nexus </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> Golang <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Golang </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1 id=__nav_4_1_label tabindex=0> 0.学习线路 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> 0.学习线路 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Go%20Web%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/ class=md-nav__link> Go Web开发实战 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex=0> 1.Go基础入门 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> 1.Go基础入门 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/1.Go%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/1.%E5%AE%89%E8%A3%85Go/ class=md-nav__link> 安装Go </a> </li> <li class=md-nav__item> <a href=../../../Golang/1.Go%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/2.%E5%BC%80%E5%90%AFGo%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E7%A8%8B%E5%BA%8F/ class=md-nav__link> 开启Go的第一个程序 </a> </li> <li class=md-nav__item> <a href=../../../Golang/1.Go%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/3.Go%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95%E4%B8%8E%E4%BD%BF%E7%94%A8/ class=md-nav__link> Go基础语法与使用 </a> </li> <li class=md-nav__item> <a href=../../../Golang/1.Go%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/4.Go%20Module%E6%95%99%E7%A8%8B/ class=md-nav__link> Go Module教程 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3 id=__nav_4_3_label tabindex=0> 2.Go-Web开发基础 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> 2.Go-Web开发基础 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/2.Go-Web%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/5.hello%20World%20Web/ class=md-nav__link> hello World Web </a> </li> <li class=md-nav__item> <a href=../../../Golang/2.Go-Web%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/6.Web%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86%E7%AE%80%E4%BB%8B/ class=md-nav__link> Web程序运行原理简介 </a> </li> <li class=md-nav__item> <a href=../../../Golang/2.Go-Web%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/7.net-http%E5%8C%85/ class=md-nav__link> net/http包 </a> </li> <li class=md-nav__item> <a href=../../../Golang/2.Go-Web%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/8.html-template%E5%8C%85/ class=md-nav__link> html/template包 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4 id=__nav_4_4_label tabindex=0> 3.Go-Web请求处理 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> 3.Go-Web请求处理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/3.Go-Web%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86/9.%E7%AE%80%E5%8D%95Go%20Web%E6%9C%8D%E5%8A%A1%E5%99%A8/ class=md-nav__link> 简单Go Web服务器 </a> </li> <li class=md-nav__item> <a href=../../../Golang/3.Go-Web%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86/10.%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82/ class=md-nav__link> 处理请求 </a> </li> <li class=md-nav__item> <a href=../../../Golang/3.Go-Web%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86/11.%E4%BA%86%E8%A7%A3session%E5%92%8Ccookie/ class=md-nav__link> 了解session和cookie </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_5> <label class=md-nav__link for=__nav_4_5 id=__nav_4_5_label tabindex=0> 4.Go访问数据库 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_5_label aria-expanded=false> <label class=md-nav__title for=__nav_4_5> <span class="md-nav__icon md-icon"></span> 4.Go访问数据库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/4.Go%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93/12.MySQL%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/ class=md-nav__link> MySQL的安装与使用 </a> </li> <li class=md-nav__item> <a href=../../../Golang/4.Go%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93/13.Redis%E7%9A%84%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8/ class=md-nav__link> Redis的安装及使用 </a> </li> <li class=md-nav__item> <a href=../../../Golang/4.Go%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93/14.MongoDB%E7%9A%84%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8/ class=md-nav__link> MongoDB的安装及使用 </a> </li> <li class=md-nav__item> <a href=../../../Golang/4.Go%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93/15.Go%E7%9A%84%E5%B8%B8%E8%A7%81ORM%E5%BA%93/ class=md-nav__link> Go的常见ORM库 </a> </li> <li class=md-nav__item> <a href=../../../Golang/4.Go%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93/16.SQLite%E7%9A%84%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8/ class=md-nav__link> SQLite的安装及使用 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_6> <label class=md-nav__link for=__nav_4_6 id=__nav_4_6_label tabindex=0> 5.Go高级网络编程 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_6_label aria-expanded=false> <label class=md-nav__title for=__nav_4_6> <span class="md-nav__icon md-icon"></span> 5.Go高级网络编程 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/5.Go%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/17.Go%20Socket%E7%BC%96%E7%A8%8B/ class=md-nav__link> Go Socket编程 </a> </li> <li class=md-nav__item> <a href=../../../Golang/5.Go%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/18.Go%20RPC%E7%BC%96%E7%A8%8B/ class=md-nav__link> Go RPC编程 </a> </li> <li class=md-nav__item> <a href=../../../Golang/5.Go%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/19.%E5%BE%AE%E6%9C%8D%E5%8A%A1/ class=md-nav__link> 微服务 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_7> <label class=md-nav__link for=__nav_4_7 id=__nav_4_7_label tabindex=0> 6.Go文件处理 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_7_label aria-expanded=false> <label class=md-nav__title for=__nav_4_7> <span class="md-nav__icon md-icon"></span> 6.Go文件处理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/20.%E5%A4%84%E7%90%86%E7%9B%AE%E5%BD%95%E4%B8%8E%E6%96%87%E4%BB%B6/ class=md-nav__link> 处理目录与文件 </a> </li> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/21.%E5%A4%84%E7%90%86XML%E6%96%87%E4%BB%B6/ class=md-nav__link> 处理XML文件 </a> </li> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/22.%E5%A4%84%E7%90%86JSON%E6%96%87%E4%BB%B6/ class=md-nav__link> 处理JSON文件 </a> </li> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/23.%E5%A4%84%E7%90%86CSV%E6%96%87%E4%BB%B6/ class=md-nav__link> 处理CSV文件 </a> </li> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/24.%E5%A4%84%E7%90%86%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95/ class=md-nav__link> 处理日志记录 </a> </li> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/25.%E5%A4%84%E7%90%86%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/ class=md-nav__link> 处理正则表达式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_8> <label class=md-nav__link for=__nav_4_8 id=__nav_4_8_label tabindex=0> 7.Go并发编程 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_8_label aria-expanded=false> <label class=md-nav__title for=__nav_4_8> <span class="md-nav__icon md-icon"></span> 7.Go并发编程 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/26.%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C/ class=md-nav__link> 并发与并行 </a> </li> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/27.%E8%BF%9B%E7%A8%8B%20%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%8D%8F%E7%A8%8B/ class=md-nav__link> 进程 线程和协程 </a> </li> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/28.Go%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B/ class=md-nav__link> Go并发模型简介 </a> </li> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/29.gogoroutine%E5%92%8Cchannel%E5%AE%9E%E7%8E%B0%E5%B9%B6%E5%8F%91/ class=md-nav__link> gogoroutine和channel实现并发 </a> </li> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/30.sync%E5%AE%9E%E7%8E%B0%E5%B9%B6%E5%8F%91/ class=md-nav__link> sync实现并发 </a> </li> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/31.Go%E5%B9%B6%E5%8F%91%E7%9A%84Web%E5%BA%94%E7%94%A8/ class=md-nav__link> Go并发的Web应用 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> Python <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_1> <label class=md-nav__link for=__nav_5_1 id=__nav_5_1_label tabindex=0> 0.学习线路 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_1_label aria-expanded=false> <label class=md-nav__title for=__nav_5_1> <span class="md-nav__icon md-icon"></span> 0.学习线路 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Pythjon-auto-ops/ class=md-nav__link> Pythjon自动化运维 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_2> <label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex=0> 1.基础篇 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=false> <label class=md-nav__title for=__nav_5_2> <span class="md-nav__icon md-icon"></span> 1.基础篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python/1.%E5%9F%BA%E7%A1%80%E7%AF%87/1.Python%E5%86%85%E7%BD%AE%E5%B0%8F%E5%B7%A5%E5%85%B7/ class=md-nav__link> Python内置小工具 </a> </li> <li class=md-nav__item> <a href=../../../Python/1.%E5%9F%BA%E7%A1%80%E7%AF%87/2.Python%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E5%AE%89%E8%A3%85/ class=md-nav__link> Python第三方库安装 </a> </li> <li class=md-nav__item> <a href=../../../Python/1.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Python%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83%E7%AE%A1%E7%90%86/ class=md-nav__link> Python工作环境管理 </a> </li> <li class=md-nav__item> <a href=../../../Python/1.%E5%9F%BA%E7%A1%80%E7%AF%87/4.VSCode%E4%B8%ADPython%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/ class=md-nav__link> VSCode中Python环境配置 </a> </li> <li class=md-nav__item> <a href=../../../Python/1.%E5%9F%BA%E7%A1%80%E7%AF%87/5.%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/ class=md-nav__link> 开发工具 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_3> <label class=md-nav__link for=__nav_5_3 id=__nav_5_3_label tabindex=0> 2.高级篇 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_3_label aria-expanded=false> <label class=md-nav__title for=__nav_5_3> <span class="md-nav__icon md-icon"></span> 2.高级篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python/2.%E9%AB%98%E7%BA%A7%E7%AF%87/1.%E6%89%93%E9%80%A0%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7/ class=md-nav__link> 打造命令行工具 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> Python-vs-Go <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Python-vs-Go </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_1> <label class=md-nav__link for=__nav_6_1 id=__nav_6_1_label tabindex=0> 0.学习线路 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_1_label aria-expanded=false> <label class=md-nav__title for=__nav_6_1> <span class="md-nav__icon md-icon"></span> 0.学习线路 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python-vs-Go/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Python-vs-Go/ class=md-nav__link> Python-vs-Go </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_2> <label class=md-nav__link for=__nav_6_2 id=__nav_6_2_label tabindex=0> 1.对比学习 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_2_label aria-expanded=false> <label class=md-nav__title for=__nav_6_2> <span class="md-nav__icon md-icon"></span> 1.对比学习 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/1.Hello-World/ class=md-nav__link> Hello-World </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/2.Print/ class=md-nav__link> Print </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/3.%E6%B3%A8%E9%87%8A/ class=md-nav__link> 注释 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/4.%E5%A4%9A%E8%A1%8C%E5%AD%97%E7%AC%A6%E4%B8%B2/ class=md-nav__link> 多行字符串 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/5.Lists/ class=md-nav__link> Lists </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/6.Map/ class=md-nav__link> Map </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/7.Booleans/ class=md-nav__link> Booleans </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/8.Forloop/ class=md-nav__link> Forloop </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/9.Range/ class=md-nav__link> Range </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/10.Switch/ class=md-nav__link> Switch </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/11.%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0%E5%87%BD%E6%95%B0/ class=md-nav__link> 可变参数函数 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/12.%E6%97%B6%E9%97%B4%E8%AE%A1%E7%AE%97/ class=md-nav__link> 时间计算 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/13.%E5%87%BD%E6%95%B0%E7%9A%84%E9%97%AD%E5%8C%85/ class=md-nav__link> 函数的闭包 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/14.%E9%80%80%E5%87%BA%E5%A4%84%E7%90%86/ class=md-nav__link> 退出处理 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/15.%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7/ class=md-nav__link> 异常捕获 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/16.%E5%8F%AF%E5%8F%98%E9%A1%B9/ class=md-nav__link> 可变项 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/17.%E7%B1%BB/ class=md-nav__link> 类 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/18.%E6%96%B9%E6%B3%95/ class=md-nav__link> 方法 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/19.%E5%B9%B6%E5%8F%91/ class=md-nav__link> 并发 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/20.Args/ class=md-nav__link> Args </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/21.%E5%AF%BC%E5%85%A5%E6%A8%A1%E5%9D%97%E5%88%AB%E5%90%8D/ class=md-nav__link> 导入模块别名 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/22.%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%A0%BC%E5%BC%8F%E5%8C%96/ class=md-nav__link> 字符串格式化 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/23.%E5%8E%BB%E9%87%8D/ class=md-nav__link> 去重 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/24.%E5%B8%A6%E9%A2%9C%E8%89%B2%E6%89%93%E5%8D%B0/ class=md-nav__link> 带颜色打印 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_3> <label class=md-nav__link for=__nav_6_3 id=__nav_6_3_label tabindex=0> 2.进阶 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_3_label aria-expanded=false> <label class=md-nav__title for=__nav_6_3> <span class="md-nav__icon md-icon"></span> 2.进阶 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python-vs-Go/2.%E8%BF%9B%E9%98%B6/1.%E4%BD%BF%E7%94%A8RPC/ class=md-nav__link> 使用RPC </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/2.%E8%BF%9B%E9%98%B6/2.%E4%BD%BF%E7%94%A8MySQL/ class=md-nav__link> 使用MySQL </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/2.%E8%BF%9B%E9%98%B6/3.%E4%BD%BF%E7%94%A8Redis/ class=md-nav__link> 使用Redis </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/2.%E8%BF%9B%E9%98%B6/4.%E4%BD%BF%E7%94%A8MongoDB/ class=md-nav__link> 使用MongoDB </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7 checked> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> Linux <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=true> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_1> <label class=md-nav__link for=__nav_7_1 id=__nav_7_1_label tabindex=0> system <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_1_label aria-expanded=false> <label class=md-nav__title for=__nav_7_1> <span class="md-nav__icon md-icon"></span> system </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../system/0.Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F%E4%B8%8B%E8%BD%BD/ class=md-nav__link> Linux操作系统镜像下载 </a> </li> <li class=md-nav__item> <a href=../../system/1.Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/ class=md-nav__link> Linux 系统安全加固最佳实践 </a> </li> <li class=md-nav__item> <a href=../../system/2.systemd/ class=md-nav__link> systemd </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_2> <label class=md-nav__link for=__nav_7_2 id=__nav_7_2_label tabindex=0> serveices <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_2_label aria-expanded=false> <label class=md-nav__title for=__nav_7_2> <span class="md-nav__icon md-icon"></span> serveices </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../serveices/0.ubuntu-desktop-vmware/ class=md-nav__link> ubuntu-desktop-vmware </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_3 checked> <label class=md-nav__link for=__nav_7_3 id=__nav_7_3_label tabindex=0> Ansible <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_3_label aria-expanded=true> <label class=md-nav__title for=__nav_7_3> <span class="md-nav__icon md-icon"></span> Ansible </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Ansible入门 <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Ansible入门 </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1ansible介绍 class=md-nav__link> 1.Ansible介绍 </a> <nav class=md-nav aria-label=1.Ansible介绍> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ansible-的目标 class=md-nav__link> Ansible 的目标 </a> </li> <li class=md-nav__item> <a href=#ansible的使用范围 class=md-nav__link> Ansible的使用范围 </a> </li> <li class=md-nav__item> <a href=#ansible是怎么工作的 class=md-nav__link> Ansible是怎么工作的 </a> </li> <li class=md-nav__item> <a href=#对管理主机的要求 class=md-nav__link> 对管理主机的要求 </a> </li> <li class=md-nav__item> <a href=#对节点主机的要求 class=md-nav__link> 对节点主机的要求 </a> </li> <li class=md-nav__item> <a href=#ansible-概念 class=md-nav__link> Ansible 概念 </a> <nav class=md-nav aria-label="Ansible 概念"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#控制节点control-node class=md-nav__link> 控制节点(Control node) </a> </li> <li class=md-nav__item> <a href=#管理节点managed-nodes class=md-nav__link> 管理节点(Managed nodes) </a> </li> <li class=md-nav__item> <a href=#主机清单inventory class=md-nav__link> 主机清单(Inventory) </a> </li> <li class=md-nav__item> <a href=#模块modules class=md-nav__link> 模块(Modules) </a> </li> <li class=md-nav__item> <a href=#任务tasks class=md-nav__link> 任务(Tasks) </a> </li> <li class=md-nav__item> <a href=#剧本playbooks class=md-nav__link> 剧本(Playbooks) </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#社区活跃 class=md-nav__link> 社区活跃 </a> </li> <li class=md-nav__item> <a href=#ansible项目 class=md-nav__link> ansible项目 </a> </li> <li class=md-nav__item> <a href=#ansible-证书 class=md-nav__link> Ansible 证书 </a> </li> <li class=md-nav__item> <a href=#ansible-与其它配置管理的对比 class=md-nav__link> Ansible 与其它配置管理的对比 </a> </li> <li class=md-nav__item> <a href=#资源 class=md-nav__link> 资源 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2安装ansible class=md-nav__link> 2.安装Ansible </a> <nav class=md-nav aria-label=2.安装Ansible> <ul class=md-nav__list> <li class=md-nav__item> <a href=#在管理节点上安装ansible class=md-nav__link> 在管理节点上安装ansible </a> </li> <li class=md-nav__item> <a href=#bash命令行自动补全 class=md-nav__link> bash命令行自动补全 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3快速开始 class=md-nav__link> 3.快速开始 </a> <nav class=md-nav aria-label=3.快速开始> <ul class=md-nav__list> <li class=md-nav__item> <a href=#环境信息 class=md-nav__link> 环境信息 </a> </li> <li class=md-nav__item> <a href=#任务 class=md-nav__link> 任务 </a> </li> <li class=md-nav__item> <a href=#步骤 class=md-nav__link> 步骤 </a> <nav class=md-nav aria-label=步骤> <ul class=md-nav__list> <li class=md-nav__item> <a href=#0-安装ansible class=md-nav__link> 0. 安装ansible </a> </li> <li class=md-nav__item> <a href=#1-定义主机清单 class=md-nav__link> 1. 定义主机清单 </a> </li> <li class=md-nav__item> <a href=#2-执行ansible命令 class=md-nav__link> 2. 执行ansible命令 </a> </li> <li class=md-nav__item> <a href=#3-验证 class=md-nav__link> 3. 验证 </a> </li> <li class=md-nav__item> <a href=#4-执行ansible-playbook class=md-nav__link> 4. 执行ansible playbook </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4认识主机清单 class=md-nav__link> 4.认识主机清单 </a> <nav class=md-nav aria-label=4.认识主机清单> <ul class=md-nav__list> <li class=md-nav__item> <a href=#主机清单示例 class=md-nav__link> 主机清单示例 </a> </li> <li class=md-nav__item> <a href=#默认组 class=md-nav__link> 默认组 </a> </li> <li class=md-nav__item> <a href=#主机变量和组变量 class=md-nav__link> 主机变量和组变量 </a> </li> <li class=md-nav__item> <a href=#变量合并 class=md-nav__link> 变量合并 </a> </li> <li class=md-nav__item> <a href=#使用多个主机清单 class=md-nav__link> 使用多个主机清单 </a> </li> <li class=md-nav__item> <a href=#主机内置变量列表 class=md-nav__link> 主机内置变量列表 </a> </li> <li class=md-nav__item> <a href=#在运行的时候增加主机 class=md-nav__link> 在运行的时候增加主机 </a> </li> <li class=md-nav__item> <a href=#限定主机清单的运行主机 class=md-nav__link> 限定主机清单的运行主机 </a> </li> <li class=md-nav__item> <a href=#示例 class=md-nav__link> 示例 </a> <nav class=md-nav aria-label=示例> <ul class=md-nav__list> <li class=md-nav__item> <a href=#连接本地主机 class=md-nav__link> 连接本地主机 </a> </li> <li class=md-nav__item> <a href=#使用别名连接主机 class=md-nav__link> 使用别名连接主机 </a> </li> <li class=md-nav__item> <a href=#使用-ssh-秘钥连接主机 class=md-nav__link> 使用 ssh 秘钥连接主机 </a> </li> <li class=md-nav__item> <a href=#使用-跳板机-连接主机 class=md-nav__link> 使用 跳板机 连接主机 </a> </li> <li class=md-nav__item> <a href=#命令行指定主机清单 class=md-nav__link> 命令行指定主机清单 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#动态主机清单 class=md-nav__link> 动态主机清单 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#5patterns-匹配 class=md-nav__link> 5.Patterns 匹配 </a> <nav class=md-nav aria-label="5.Patterns 匹配"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#常用匹配 class=md-nav__link> 常用匹配 </a> </li> <li class=md-nav__item> <a href=#局限性 class=md-nav__link> 局限性 </a> </li> <li class=md-nav__item> <a href=#高级特性 class=md-nav__link> 高级特性 </a> <nav class=md-nav aria-label=高级特性> <ul class=md-nav__list> <li class=md-nav__item> <a href=#使用变量 class=md-nav__link> 使用变量 </a> </li> <li class=md-nav__item> <a href=#使用切片 class=md-nav__link> 使用切片 </a> </li> <li class=md-nav__item> <a href=#正则表达式 class=md-nav__link> 正则表达式 </a> </li> <li class=md-nav__item> <a href=#限定主机 class=md-nav__link> 限定主机 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#6使用ad-hoc命令 class=md-nav__link> 6.使用ad-hoc命令 </a> <nav class=md-nav aria-label=6.使用ad-hoc命令> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ad-hoc-命令 class=md-nav__link> ad-hoc 命令 </a> </li> <li class=md-nav__item> <a href=#ad-hoc-示例 class=md-nav__link> ad-hoc 示例 </a> <nav class=md-nav aria-label="ad-hoc 示例"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#执行shell命令 class=md-nav__link> 执行shell命令 </a> <nav class=md-nav aria-label=执行shell命令> <ul class=md-nav__list> <li class=md-nav__item> <a href=#command class=md-nav__link> command </a> </li> <li class=md-nav__item> <a href=#shell class=md-nav__link> shell </a> </li> <li class=md-nav__item> <a href=#raw class=md-nav__link> raw </a> </li> <li class=md-nav__item> <a href=#script class=md-nav__link> script </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#文件管理 class=md-nav__link> 文件管理 </a> <nav class=md-nav aria-label=文件管理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#copy class=md-nav__link> copy </a> </li> <li class=md-nav__item> <a href=#fetch class=md-nav__link> fetch </a> </li> <li class=md-nav__item> <a href=#file class=md-nav__link> file </a> </li> <li class=md-nav__item> <a href=#unarchive class=md-nav__link> unarchive </a> </li> <li class=md-nav__item> <a href=#stat class=md-nav__link> stat </a> </li> <li class=md-nav__item> <a href=#get_url class=md-nav__link> get_url </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#管理软件包 class=md-nav__link> 管理软件包 </a> <nav class=md-nav aria-label=管理软件包> <ul class=md-nav__list> <li class=md-nav__item> <a href=#apt class=md-nav__link> apt </a> </li> <li class=md-nav__item> <a href=#yum class=md-nav__link> yum </a> </li> <li class=md-nav__item> <a href=#package class=md-nav__link> package </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#用户和用户组 class=md-nav__link> 用户和用户组 </a> <nav class=md-nav aria-label=用户和用户组> <ul class=md-nav__list> <li class=md-nav__item> <a href=#user class=md-nav__link> user </a> </li> <li class=md-nav__item> <a href=#group class=md-nav__link> group </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#版本控制 class=md-nav__link> 版本控制 </a> <nav class=md-nav aria-label=版本控制> <ul class=md-nav__list> <li class=md-nav__item> <a href=#git class=md-nav__link> git </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#服务管理 class=md-nav__link> 服务管理 </a> <nav class=md-nav aria-label=服务管理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#service class=md-nav__link> service </a> </li> <li class=md-nav__item> <a href=#systemd class=md-nav__link> systemd </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#防火墙管理 class=md-nav__link> 防火墙管理 </a> <nav class=md-nav aria-label=防火墙管理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#iptables class=md-nav__link> iptables </a> </li> <li class=md-nav__item> <a href=#firewalld class=md-nav__link> firewalld </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#文件内容操作 class=md-nav__link> 文件内容操作 </a> <nav class=md-nav aria-label=文件内容操作> <ul class=md-nav__list> <li class=md-nav__item> <a href=#lineinfile class=md-nav__link> lineinfile </a> </li> <li class=md-nav__item> <a href=#replace class=md-nav__link> replace </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#定时任务 class=md-nav__link> 定时任务 </a> </li> <li class=md-nav__item> <a href=#搜集系统信息 class=md-nav__link> 搜集系统信息 </a> </li> <li class=md-nav__item> <a href=#指定连接方式 class=md-nav__link> 指定连接方式 </a> </li> <li class=md-nav__item> <a href=#后台运行 class=md-nav__link> 后台运行 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#练习 class=md-nav__link> 练习 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#7熟悉ansible命令 class=md-nav__link> 7.熟悉ansible命令 </a> <nav class=md-nav aria-label=7.熟悉ansible命令> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ansible class=md-nav__link> ansible </a> </li> <li class=md-nav__item> <a href=#ansible-console class=md-nav__link> ansible-console </a> </li> <li class=md-nav__item> <a href=#ansible-doc class=md-nav__link> ansible-doc </a> </li> <li class=md-nav__item> <a href=#ansible-galaxy class=md-nav__link> ansible-galaxy </a> </li> <li class=md-nav__item> <a href=#ansible-playbook class=md-nav__link> ansible-playbook </a> </li> <li class=md-nav__item> <a href=#ansible-pull class=md-nav__link> ansible-pull </a> </li> <li class=md-nav__item> <a href=#ansible-config class=md-nav__link> ansible-config </a> </li> <li class=md-nav__item> <a href=#ansible-inventory class=md-nav__link> ansible-inventory </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#8使用-playbook class=md-nav__link> 8.使用 Playbook </a> <nav class=md-nav aria-label="8.使用 Playbook"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#playbook-示例 class=md-nav__link> Playbook 示例 </a> </li> <li class=md-nav__item> <a href=#主机和用户 class=md-nav__link> 主机和用户 </a> <nav class=md-nav aria-label=主机和用户> <ul class=md-nav__list> <li class=md-nav__item> <a href=#主机的执行顺序 class=md-nav__link> 主机的执行顺序 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#任务列表 class=md-nav__link> 任务列表 </a> </li> <li class=md-nav__item> <a href=#事件处理handlers class=md-nav__link> 事件处理Handlers </a> </li> <li class=md-nav__item> <a href=#执行-playbook class=md-nav__link> 执行 Playbook </a> <nav class=md-nav aria-label="执行 Playbook"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#playbook执行顺序 class=md-nav__link> playbook执行顺序 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#9包含和角色 class=md-nav__link> 9.包含和角色 </a> <nav class=md-nav aria-label=9.包含和角色> <ul class=md-nav__list> <li class=md-nav__item> <a href=#动态和静态 class=md-nav__link> 动态和静态 </a> </li> <li class=md-nav__item> <a href=#静态导入 class=md-nav__link> 静态导入 </a> </li> <li class=md-nav__item> <a href=#动态包含 class=md-nav__link> 动态包含 </a> </li> <li class=md-nav__item> <a href=#动态与静态两者的区别 class=md-nav__link> 动态与静态两者的区别 </a> </li> <li class=md-nav__item> <a href=#角色role class=md-nav__link> 角色ROLE </a> </li> <li class=md-nav__item> <a href=#角色目录结构 class=md-nav__link> 角色目录结构 </a> </li> <li class=md-nav__item> <a href=#角色使用 class=md-nav__link> 角色使用 </a> </li> <li class=md-nav__item> <a href=#角色重复执行 class=md-nav__link> 角色重复执行 </a> </li> <li class=md-nav__item> <a href=#角色默认变量 class=md-nav__link> 角色默认变量 </a> </li> <li class=md-nav__item> <a href=#角色依赖 class=md-nav__link> 角色依赖 </a> </li> <li class=md-nav__item> <a href=#嵌入模块和插件 class=md-nav__link> 嵌入模块和插件 </a> </li> <li class=md-nav__item> <a href=#角色搜索路径 class=md-nav__link> 角色搜索路径 </a> </li> <li class=md-nav__item> <a href=#ansible-galaxy_1 class=md-nav__link> Ansible Galaxy </a> </li> <li class=md-nav__item> <a href=#角色示例参考 class=md-nav__link> 角色示例参考 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#10使用变量 class=md-nav__link> 10.使用变量 </a> <nav class=md-nav aria-label=10.使用变量> <ul class=md-nav__list> <li class=md-nav__item> <a href=#创建有效的变量名 class=md-nav__link> 创建有效的变量名 </a> </li> <li class=md-nav__item> <a href=#变量使用 class=md-nav__link> 变量使用 </a> <nav class=md-nav aria-label=变量使用> <ul class=md-nav__list> <li class=md-nav__item> <a href=#通过命令行传递变量extra-vars class=md-nav__link> 通过命令行传递变量(extra vars) </a> </li> <li class=md-nav__item> <a href=#在inventory-中定义变量inventory-vars class=md-nav__link> 在inventory 中定义变量（inventory vars) </a> </li> <li class=md-nav__item> <a href=#在play中定义变量play-vars class=md-nav__link> 在play中定义变量（play vars） </a> </li> <li class=md-nav__item> <a href=#在角色和文件包含中定义变量play-include_vars class=md-nav__link> 在角色和文件包含中定义变量(play include_vars) </a> </li> <li class=md-nav__item> <a href=#在play中包含变量文件play-vars_files class=md-nav__link> 在play中包含变量文件(play vars_files) </a> </li> <li class=md-nav__item> <a href=#定义角色默认变量role-defaults-vars class=md-nav__link> 定义角色默认变量（role defaults vars） </a> </li> <li class=md-nav__item> <a href=#定义角色变量role--vars class=md-nav__link> 定义角色变量（role vars） </a> </li> <li class=md-nav__item> <a href=#以交互方式获取变量值-play-vars_prompt class=md-nav__link> 以交互方式获取变量值( play vars_prompt) </a> </li> <li class=md-nav__item> <a href=#定义角色变量role-and-include-vars class=md-nav__link> 定义角色变量（role and include vars) </a> </li> <li class=md-nav__item> <a href=#注册变量registered-vars class=md-nav__link> 注册变量（registered vars） </a> </li> <li class=md-nav__item> <a href=#动态创建fact变量 class=md-nav__link> 动态创建fact变量 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#变量优先级 class=md-nav__link> 变量优先级 </a> </li> <li class=md-nav__item> <a href=#变量范围 class=md-nav__link> 变量范围 </a> </li> <li class=md-nav__item> <a href=#使用变量_1 class=md-nav__link> 使用变量 </a> <nav class=md-nav aria-label=使用变量> <ul class=md-nav__list> <li class=md-nav__item> <a href=#在jinja2中使用 class=md-nav__link> 在jinja2中使用 </a> </li> <li class=md-nav__item> <a href=#使用jinja2过滤器转换变量 class=md-nav__link> 使用Jinja2过滤器转换变量 </a> </li> <li class=md-nav__item> <a href=#从系统中发现变量facts class=md-nav__link> 从系统中发现变量:Facts </a> </li> <li class=md-nav__item> <a href=#访问复杂变量数据 class=md-nav__link> 访问复杂变量数据 </a> </li> <li class=md-nav__item> <a href=#使用内置变量 class=md-nav__link> 使用内置变量 </a> <nav class=md-nav aria-label=使用内置变量> <ul class=md-nav__list> <li class=md-nav__item> <a href=#魔术变量 class=md-nav__link> 魔术变量 </a> </li> <li class=md-nav__item> <a href=#facts-变量 class=md-nav__link> Facts 变量 </a> </li> <li class=md-nav__item> <a href=#连接变量 class=md-nav__link> 连接变量 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#11facts-数据 class=md-nav__link> 11.Facts 数据 </a> <nav class=md-nav aria-label="11.Facts 数据"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#获取facts信息 class=md-nav__link> 获取Facts信息 </a> <nav class=md-nav aria-label=获取Facts信息> <ul class=md-nav__list> <li class=md-nav__item> <a href=#使用setup模块来获取目标系统信息 class=md-nav__link> 使用setup模块来获取目标系统信息 </a> </li> <li class=md-nav__item> <a href=#使用playbook来获取目标系统信息 class=md-nav__link> 使用playbook来获取目标系统信息 </a> </li> <li class=md-nav__item> <a href=#在task中设置facts信息 class=md-nav__link> 在task中设置facts信息 </a> </li> <li class=md-nav__item> <a href=#自定义目标系统facts class=md-nav__link> 自定义目标系统facts </a> </li> <li class=md-nav__item> <a href=#facts-返回的信息 class=md-nav__link> Facts 返回的信息 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#缓存facts信息 class=md-nav__link> 缓存Facts信息 </a> <nav class=md-nav aria-label=缓存Facts信息> <ul class=md-nav__list> <li class=md-nav__item> <a href=#使用文件作为缓存 class=md-nav__link> 使用文件作为缓存 </a> </li> <li class=md-nav__item> <a href=#使用redis作为缓存 class=md-nav__link> 使用redis作为缓存 </a> </li> <li class=md-nav__item> <a href=#使用memcached作为缓存 class=md-nav__link> 使用memcached作为缓存 </a> </li> <li class=md-nav__item> <a href=#刷新缓存 class=md-nav__link> 刷新缓存 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#12jinja2-模板语法 class=md-nav__link> 12.Jinja2 模板语法 </a> <nav class=md-nav aria-label="12.Jinja2 模板语法"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#jinja2-模版中的一些语法 class=md-nav__link> jinja2 模版中的一些语法 </a> <nav class=md-nav aria-label="jinja2 模版中的一些语法"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#变量 class=md-nav__link> 变量 </a> </li> <li class=md-nav__item> <a href=#注释 class=md-nav__link> 注释 </a> </li> <li class=md-nav__item> <a href=#转义 class=md-nav__link> 转义 </a> </li> <li class=md-nav__item> <a href=#空白控制 class=md-nav__link> 空白控制 </a> </li> <li class=md-nav__item> <a href=#控制结构 class=md-nav__link> 控制结构 </a> <nav class=md-nav aria-label=控制结构> <ul class=md-nav__list> <li class=md-nav__item> <a href=#for class=md-nav__link> For </a> </li> <li class=md-nav__item> <a href=#if-语句 class=md-nav__link> if 语句 </a> </li> <li class=md-nav__item> <a href=#过滤器 class=md-nav__link> 过滤器 </a> </li> <li class=md-nav__item> <a href=#赋值 class=md-nav__link> 赋值 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#表达式 class=md-nav__link> 表达式 </a> </li> <li class=md-nav__item> <a href=#字面量 class=md-nav__link> 字面量 </a> </li> <li class=md-nav__item> <a href=#算术 class=md-nav__link> 算术 </a> </li> <li class=md-nav__item> <a href=#python对象方法 class=md-nav__link> Python对象方法 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#在-ansible-中使用jinja2 class=md-nav__link> 在 ansible 中使用Jinja2 </a> <nav class=md-nav aria-label="在 ansible 中使用Jinja2"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#获取当前时间 class=md-nav__link> 获取当前时间 </a> </li> <li class=md-nav__item> <a href=#过滤器_1 class=md-nav__link> 过滤器 </a> <nav class=md-nav aria-label=过滤器> <ul class=md-nav__list> <li class=md-nav__item> <a href=#格式化数据过滤器 class=md-nav__link> 格式化数据过滤器 </a> </li> <li class=md-nav__item> <a href=#强制定义变量 class=md-nav__link> 强制定义变量 </a> </li> <li class=md-nav__item> <a href=#未定义的变量默认值 class=md-nav__link> 未定义的变量默认值 </a> </li> <li class=md-nav__item> <a href=#省略参数 class=md-nav__link> 省略参数 </a> </li> <li class=md-nav__item> <a href=#列表过滤 class=md-nav__link> 列表过滤 </a> </li> <li class=md-nav__item> <a href=#数据集过滤 class=md-nav__link> 数据集过滤 </a> </li> <li class=md-nav__item> <a href=#字典过滤 class=md-nav__link> 字典过滤 </a> </li> <li class=md-nav__item> <a href=#zip-过滤 class=md-nav__link> zip 过滤 </a> </li> <li class=md-nav__item> <a href=#子元素过滤器 class=md-nav__link> 子元素过滤器 </a> </li> <li class=md-nav__item> <a href=#随机mac地址过滤器 class=md-nav__link> 随机Mac地址过滤器 </a> </li> <li class=md-nav__item> <a href=#随机数过滤 class=md-nav__link> 随机数过滤 </a> </li> <li class=md-nav__item> <a href=#随机列表过滤 class=md-nav__link> 随机列表过滤 </a> </li> <li class=md-nav__item> <a href=#数学 class=md-nav__link> 数学 </a> </li> <li class=md-nav__item> <a href=#json查询过滤 class=md-nav__link> JSON查询过滤 </a> </li> <li class=md-nav__item> <a href=#ip地址过滤 class=md-nav__link> ip地址过滤 </a> </li> <li class=md-nav__item> <a href=#network-cli-过滤器 class=md-nav__link> Network CLI 过滤器 </a> </li> <li class=md-nav__item> <a href=#network-xml-过滤器 class=md-nav__link> Network XML 过滤器 </a> </li> <li class=md-nav__item> <a href=#network-vlan-过滤器 class=md-nav__link> Network VLAN 过滤器 </a> </li> <li class=md-nav__item> <a href=#哈希过滤器 class=md-nav__link> 哈希过滤器 </a> </li> <li class=md-nav__item> <a href=#合并散列 class=md-nav__link> 合并散列 </a> </li> <li class=md-nav__item> <a href=#提取过滤器 class=md-nav__link> 提取过滤器 </a> </li> <li class=md-nav__item> <a href=#注释过滤 class=md-nav__link> 注释过滤 </a> </li> <li class=md-nav__item> <a href=#url-分割过滤器 class=md-nav__link> url 分割过滤器 </a> </li> <li class=md-nav__item> <a href=#正则匹配 class=md-nav__link> 正则匹配 </a> </li> <li class=md-nav__item> <a href=#kubernetes-过滤器 class=md-nav__link> Kubernetes 过滤器 </a> </li> <li class=md-nav__item> <a href=#其他的常用过滤 class=md-nav__link> 其他的常用过滤 </a> </li> <li class=md-nav__item> <a href=#组合过滤器 class=md-nav__link> 组合过滤器 </a> </li> <li class=md-nav__item> <a href=#product--过滤器 class=md-nav__link> Product 过滤器 </a> </li> <li class=md-nav__item> <a href=#debug-过滤器 class=md-nav__link> debug 过滤器 </a> </li> <li class=md-nav__item> <a href=#字节转换 class=md-nav__link> 字节转换 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#测试 class=md-nav__link> 测试 </a> <nav class=md-nav aria-label=测试> <ul class=md-nav__list> <li class=md-nav__item> <a href=#测试语法 class=md-nav__link> 测试语法 </a> </li> <li class=md-nav__item> <a href=#测试字符串 class=md-nav__link> 测试字符串 </a> </li> <li class=md-nav__item> <a href=#版本比较 class=md-nav__link> 版本比较 </a> </li> <li class=md-nav__item> <a href=#包含测试 class=md-nav__link> 包含测试 </a> </li> <li class=md-nav__item> <a href=#路径测试 class=md-nav__link> 路径测试 </a> </li> <li class=md-nav__item> <a href=#测试命令结果 class=md-nav__link> 测试命令结果 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#lookup-插件 class=md-nav__link> lookup 插件 </a> </li> <li class=md-nav__item> <a href=#if-语句_1 class=md-nav__link> if 语句 </a> </li> <li class=md-nav__item> <a href=#for-语句 class=md-nav__link> for 语句 </a> </li> <li class=md-nav__item> <a href=#在-when-里使用-jinja2-表达式 class=md-nav__link> 在 when 里使用 jinja2 表达式 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#13条件判断与循环 class=md-nav__link> 13.条件判断与循环 </a> <nav class=md-nav aria-label=13.条件判断与循环> <ul class=md-nav__list> <li class=md-nav__item> <a href=#条件判断 class=md-nav__link> 条件判断 </a> <nav class=md-nav aria-label=条件判断> <ul class=md-nav__list> <li class=md-nav__item> <a href=#when-语句 class=md-nav__link> When 语句 </a> </li> <li class=md-nav__item> <a href=#与循环一起使用 class=md-nav__link> 与循环一起使用 </a> </li> <li class=md-nav__item> <a href=#使用自定义的facts值做判断 class=md-nav__link> 使用自定义的facts值做判断 </a> </li> <li class=md-nav__item> <a href=#角色包含使使用when class=md-nav__link> 角色包含使使用when </a> </li> <li class=md-nav__item> <a href=#有条件的导入 class=md-nav__link> 有条件的导入 </a> </li> <li class=md-nav__item> <a href=#基于变量选择文件和模板 class=md-nav__link> 基于变量选择文件和模板 </a> </li> <li class=md-nav__item> <a href=#使用注册变量判断 class=md-nav__link> 使用注册变量判断 </a> </li> <li class=md-nav__item> <a href=#failed_when class=md-nav__link> failed_when </a> </li> <li class=md-nav__item> <a href=#changed_when class=md-nav__link> changed_when </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#循环 class=md-nav__link> 循环 </a> <nav class=md-nav aria-label=循环> <ul class=md-nav__list> <li class=md-nav__item> <a href=#比较loop-和-with_ class=md-nav__link> 比较loop 和 with_* </a> </li> <li class=md-nav__item> <a href=#标准循环 class=md-nav__link> 标准循环 </a> <nav class=md-nav aria-label=标准循环> <ul class=md-nav__list> <li class=md-nav__item> <a href=#遍历列表 class=md-nav__link> 遍历列表 </a> </li> <li class=md-nav__item> <a href=#遍历散列列表 class=md-nav__link> 遍历散列列表 </a> </li> <li class=md-nav__item> <a href=#遍历字典 class=md-nav__link> 遍历字典 </a> </li> <li class=md-nav__item> <a href=#循环中注册变量 class=md-nav__link> 循环中注册变量 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#复杂循环 class=md-nav__link> 复杂循环 </a> <nav class=md-nav aria-label=复杂循环> <ul class=md-nav__list> <li class=md-nav__item> <a href=#遍历嵌套列表 class=md-nav__link> 遍历嵌套列表 </a> </li> <li class=md-nav__item> <a href=#在满足条件之前重试任务 class=md-nav__link> 在满足条件之前重试任务 </a> </li> <li class=md-nav__item> <a href=#循环主机清单 class=md-nav__link> 循环主机清单 </a> </li> <li class=md-nav__item> <a href=#使用query还是lookup class=md-nav__link> 使用query还是lookup </a> </li> <li class=md-nav__item> <a href=#循环控制 class=md-nav__link> 循环控制 </a> <nav class=md-nav aria-label=循环控制> <ul class=md-nav__list> <li class=md-nav__item> <a href=#使用label限制loop的输出 class=md-nav__link> 使用label限制loop的输出 </a> </li> <li class=md-nav__item> <a href=#循环间隔时间 class=md-nav__link> 循环间隔时间 </a> </li> <li class=md-nav__item> <a href=#循环索引 class=md-nav__link> 循环索引 </a> </li> <li class=md-nav__item> <a href=#更改循环的变量名称 class=md-nav__link> 更改循环的变量名称 </a> </li> <li class=md-nav__item> <a href=#扩展变量 class=md-nav__link> 扩展变量 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#获取loop_var的名称 class=md-nav__link> 获取loop_var的名称 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#从with_迁移到loop class=md-nav__link> 从with_*迁移到loop </a> <nav class=md-nav aria-label=从with_*迁移到loop> <ul class=md-nav__list> <li class=md-nav__item> <a href=#with_list class=md-nav__link> with_list </a> </li> <li class=md-nav__item> <a href=#with_items class=md-nav__link> with_items </a> </li> <li class=md-nav__item> <a href=#with_indexed_items class=md-nav__link> with_indexed_items </a> </li> <li class=md-nav__item> <a href=#with_flattened class=md-nav__link> with_flattened </a> </li> <li class=md-nav__item> <a href=#with_together class=md-nav__link> with_together </a> </li> <li class=md-nav__item> <a href=#with_dict class=md-nav__link> with_dict </a> </li> <li class=md-nav__item> <a href=#with_sequence class=md-nav__link> with_sequence </a> </li> <li class=md-nav__item> <a href=#with_subelements class=md-nav__link> with_subelements </a> </li> <li class=md-nav__item> <a href=#with_random_choice class=md-nav__link> with_random_choice </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#14blocks class=md-nav__link> 14.Blocks </a> <nav class=md-nav aria-label=14.Blocks> <ul class=md-nav__list> <li class=md-nav__item> <a href=#块的错误处理 class=md-nav__link> 块的错误处理 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#15playbook高级特性 class=md-nav__link> 15.Playbook高级特性 </a> <nav class=md-nav aria-label=15.Playbook高级特性> <ul class=md-nav__list> <li class=md-nav__item> <a href=#权限提升 class=md-nav__link> 权限提升 </a> <nav class=md-nav aria-label=权限提升> <ul class=md-nav__list> <li class=md-nav__item> <a href=#使用become class=md-nav__link> 使用become </a> <nav class=md-nav aria-label=使用become> <ul class=md-nav__list> <li class=md-nav__item> <a href=#become-指令 class=md-nav__link> become 指令 </a> </li> <li class=md-nav__item> <a href=#become-变量 class=md-nav__link> become 变量 </a> </li> <li class=md-nav__item> <a href=#become-命令行选项 class=md-nav__link> become 命令行选项 </a> </li> <li class=md-nav__item> <a href=#become的一些限制和风险 class=md-nav__link> become的一些限制和风险 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#网络模块使用become class=md-nav__link> 网络模块使用become </a> <nav class=md-nav aria-label=网络模块使用become> <ul class=md-nav__list> <li class=md-nav__item> <a href=#设置所有任务的enable模式 class=md-nav__link> 设置所有任务的enable模式 </a> </li> <li class=md-nav__item> <a href=#enable模式的密码 class=md-nav__link> enable模式的密码 </a> </li> <li class=md-nav__item> <a href=#authorize-和-auth_pass class=md-nav__link> authorize 和 auth_pass </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#windows-使用become class=md-nav__link> windows 使用become </a> <nav class=md-nav aria-label="windows 使用become"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#localservice账号 class=md-nav__link> LocalService账号 </a> </li> <li class=md-nav__item> <a href=#无需为become设置密码 class=md-nav__link> 无需为become设置密码 </a> </li> <li class=md-nav__item> <a href=#没有密码的帐户 class=md-nav__link> 没有密码的帐户 </a> </li> <li class=md-nav__item> <a href=#become的参数 class=md-nav__link> become的参数 </a> </li> <li class=md-nav__item> <a href=#限制 class=md-nav__link> 限制 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#异步操作和轮询 class=md-nav__link> 异步操作和轮询 </a> <nav class=md-nav aria-label=异步操作和轮询> <ul class=md-nav__list> <li class=md-nav__item> <a href=#异步任务的状态文件 class=md-nav__link> 异步任务的状态文件 </a> </li> <li class=md-nav__item> <a href=#异步任务的返回值 class=md-nav__link> 异步任务的返回值 </a> </li> <li class=md-nav__item> <a href=#异步任务状态的返回值 class=md-nav__link> 异步任务状态的返回值 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#检查模式 class=md-nav__link> 检查模式 </a> </li> <li class=md-nav__item> <a href=#debug-功能 class=md-nav__link> debug 功能 </a> <nav class=md-nav aria-label="debug 功能"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#使用-debugger-关键字 class=md-nav__link> 使用 debugger 关键字 </a> </li> <li class=md-nav__item> <a href=#配置或环境变量 class=md-nav__link> 配置或环境变量 </a> </li> <li class=md-nav__item> <a href=#使用-strategy-插件 class=md-nav__link> 使用 strategy 插件 </a> </li> <li class=md-nav__item> <a href=#调试-debugger class=md-nav__link> 调试 debugger </a> </li> <li class=md-nav__item> <a href=#与free策略一起使用 class=md-nav__link> 与free策略一起使用 </a> </li> <li class=md-nav__item> <a href=#使用-debug-模块 class=md-nav__link> 使用 debug 模块 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#滚动执行 class=md-nav__link> 滚动执行 </a> </li> <li class=md-nav__item> <a href=#指定最大失败数目 class=md-nav__link> 指定最大失败数目 </a> </li> <li class=md-nav__item> <a href=#委托 class=md-nav__link> 委托 </a> </li> <li class=md-nav__item> <a href=#任务只运行一次 class=md-nav__link> 任务只运行一次 </a> </li> <li class=md-nav__item> <a href=#本地执行 class=md-nav__link> 本地执行 </a> </li> <li class=md-nav__item> <a href=#设置环境变量 class=md-nav__link> 设置环境变量 </a> </li> <li class=md-nav__item> <a href=#错误处理 class=md-nav__link> 错误处理 </a> <nav class=md-nav aria-label=错误处理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#忽略错误 class=md-nav__link> 忽略错误 </a> </li> <li class=md-nav__item> <a href=#重置无法访问的主机 class=md-nav__link> 重置无法访问的主机 </a> </li> <li class=md-nav__item> <a href=#即使任务失败handlers也执行 class=md-nav__link> 即使任务失败，handlers也执行 </a> </li> <li class=md-nav__item> <a href=#控制任务失败 class=md-nav__link> 控制任务失败 </a> </li> <li class=md-nav__item> <a href=#更改任务changed状态 class=md-nav__link> 更改任务changed状态 </a> </li> <li class=md-nav__item> <a href=#出现错误时立即中断执行 class=md-nav__link> 出现错误时立即中断执行 </a> </li> <li class=md-nav__item> <a href=#使用blocks class=md-nav__link> 使用blocks </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#yaml-语法 class=md-nav__link> YAML 语法 </a> </li> <li class=md-nav__item> <a href=#prompts-运行时提示输入内容 class=md-nav__link> Prompts: 运行时，提示输入内容 </a> </li> <li class=md-nav__item> <a href=#标记 class=md-nav__link> 标记 </a> <nav class=md-nav aria-label=标记> <ul class=md-nav__list> <li class=md-nav__item> <a href=#标记任务 class=md-nav__link> 标记任务 </a> </li> <li class=md-nav__item> <a href=#标记playbook class=md-nav__link> 标记playbook </a> </li> <li class=md-nav__item> <a href=#标记role class=md-nav__link> 标记role </a> </li> <li class=md-nav__item> <a href=#标记包含 class=md-nav__link> 标记包含 </a> </li> <li class=md-nav__item> <a href=#特殊标记 class=md-nav__link> 特殊标记 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#vault-加密 class=md-nav__link> Vault 加密 </a> </li> <li class=md-nav__item> <a href=#从某个任务开始执行 class=md-nav__link> 从某个任务开始执行 </a> </li> <li class=md-nav__item> <a href=#一步一步的执行 class=md-nav__link> 一步一步的执行 </a> </li> <li class=md-nav__item> <a href=#模块默认值 class=md-nav__link> 模块默认值 </a> </li> <li class=md-nav__item> <a href=#等待 class=md-nav__link> 等待 </a> </li> <li class=md-nav__item> <a href=#playbook-关键字 class=md-nav__link> Playbook 关键字 </a> </li> <li class=md-nav__item> <a href=#lookup-插件_1 class=md-nav__link> lookup 插件 </a> <nav class=md-nav aria-label="lookup 插件"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#使用-file-获取文件内容 class=md-nav__link> 使用 file 获取文件内容 </a> </li> <li class=md-nav__item> <a href=#使用-env-获取变量 class=md-nav__link> 使用 env 获取变量 </a> </li> <li class=md-nav__item> <a href=#使用-password-生成密码字符串 class=md-nav__link> 使用 password 生成密码字符串 </a> </li> <li class=md-nav__item> <a href=#使用-csvfile-读取csv文件 class=md-nav__link> 使用 csvfile 读取csv文件 </a> </li> <li class=md-nav__item> <a href=#使用-ini--读取ini文件 class=md-nav__link> 使用 ini 读取ini文件 </a> </li> <li class=md-nav__item> <a href=#使用-dig-dns查询 class=md-nav__link> 使用 dig dns查询 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../1.Ansible%E6%89%A9%E5%B1%95%E9%98%85%E8%AF%BB/ class=md-nav__link> Ansible扩展阅读 </a> </li> <li class=md-nav__item> <a href=../2.%E7%AE%A1%E7%90%86windows%E4%B8%BB%E6%9C%BA/ class=md-nav__link> 管理windows主机 </a> </li> <li class=md-nav__item> <a href=../3.Ansible%E8%BF%9B%E9%98%B6/ class=md-nav__link> Ansible进阶 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_4> <label class=md-nav__link for=__nav_7_4 id=__nav_7_4_label tabindex=0> Shell <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_4_label aria-expanded=false> <label class=md-nav__title for=__nav_7_4> <span class="md-nav__icon md-icon"></span> Shell </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../shell/Shell%E7%AE%80%E4%BB%8B/ class=md-nav__link> Shell 教程概述 </a> </li> <li class=md-nav__item> <a href=../../shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/ class=md-nav__link> 1.第一个 Shell 程序 </a> </li> <li class=md-nav__item> <a href=../../shell/2.Shell%E5%8F%98%E9%87%8F/ class=md-nav__link> 2.Shell 变量 </a> </li> <li class=md-nav__item> <a href=../../shell/3.Shell%E5%8F%82%E6%95%B0/ class=md-nav__link> 3.Shell 参数 </a> </li> <li class=md-nav__item> <a href=../../shell/4.Shell%E6%95%B0%E7%BB%84/ class=md-nav__link> 4.Shell数组 </a> </li> <li class=md-nav__item> <a href=../../shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/ class=md-nav__link> 5.Shell 运算符 </a> </li> <li class=md-nav__item> <a href=../../shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/ class=md-nav__link> 6.Shell echo/printf 命令 </a> </li> <li class=md-nav__item> <a href=../../shell/7.Shell%20test%E5%91%BD%E4%BB%A4/ class=md-nav__link> 7.Shell test 命令 </a> </li> <li class=md-nav__item> <a href=../../shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/ class=md-nav__link> 8.Shell 流程控制 </a> </li> <li class=md-nav__item> <a href=../../shell/9.Shell%E5%87%BD%E6%95%B0/ class=md-nav__link> 8.Shell 函数 </a> </li> <li class=md-nav__item> <a href=../../shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/ class=md-nav__link> 10.Shell输入/输出重定向 </a> </li> <li class=md-nav__item> <a href=../../shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/ class=md-nav__link> 11.Shell 正则表达式 </a> </li> <li class=md-nav__item> <a href=../../shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/ class=md-nav__link> 12.Shell 三剑客之grep </a> </li> <li class=md-nav__item> <a href=../../shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/ class=md-nav__link> 13.Shell三剑客之sed </a> </li> <li class=md-nav__item> <a href=../../shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/ class=md-nav__link> 14.Shell三剑客之awk </a> </li> <li class=md-nav__item> <a href=../../shell/15.Shell%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/ class=md-nav__link> 15.Shell常用工具 </a> </li> <li class=md-nav__item> <a href=../../shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/ class=md-nav__link> 16.Shell实战项目 </a> </li> <li class=md-nav__item> <a href=../../shell/17.Shell%E8%84%9A%E6%9C%AC%E7%A4%BA%E4%BE%8B/ class=md-nav__link> 17.Shell脚本示例 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1ansible介绍 class=md-nav__link> 1.Ansible介绍 </a> <nav class=md-nav aria-label=1.Ansible介绍> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ansible-的目标 class=md-nav__link> Ansible 的目标 </a> </li> <li class=md-nav__item> <a href=#ansible的使用范围 class=md-nav__link> Ansible的使用范围 </a> </li> <li class=md-nav__item> <a href=#ansible是怎么工作的 class=md-nav__link> Ansible是怎么工作的 </a> </li> <li class=md-nav__item> <a href=#对管理主机的要求 class=md-nav__link> 对管理主机的要求 </a> </li> <li class=md-nav__item> <a href=#对节点主机的要求 class=md-nav__link> 对节点主机的要求 </a> </li> <li class=md-nav__item> <a href=#ansible-概念 class=md-nav__link> Ansible 概念 </a> <nav class=md-nav aria-label="Ansible 概念"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#控制节点control-node class=md-nav__link> 控制节点(Control node) </a> </li> <li class=md-nav__item> <a href=#管理节点managed-nodes class=md-nav__link> 管理节点(Managed nodes) </a> </li> <li class=md-nav__item> <a href=#主机清单inventory class=md-nav__link> 主机清单(Inventory) </a> </li> <li class=md-nav__item> <a href=#模块modules class=md-nav__link> 模块(Modules) </a> </li> <li class=md-nav__item> <a href=#任务tasks class=md-nav__link> 任务(Tasks) </a> </li> <li class=md-nav__item> <a href=#剧本playbooks class=md-nav__link> 剧本(Playbooks) </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#社区活跃 class=md-nav__link> 社区活跃 </a> </li> <li class=md-nav__item> <a href=#ansible项目 class=md-nav__link> ansible项目 </a> </li> <li class=md-nav__item> <a href=#ansible-证书 class=md-nav__link> Ansible 证书 </a> </li> <li class=md-nav__item> <a href=#ansible-与其它配置管理的对比 class=md-nav__link> Ansible 与其它配置管理的对比 </a> </li> <li class=md-nav__item> <a href=#资源 class=md-nav__link> 资源 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2安装ansible class=md-nav__link> 2.安装Ansible </a> <nav class=md-nav aria-label=2.安装Ansible> <ul class=md-nav__list> <li class=md-nav__item> <a href=#在管理节点上安装ansible class=md-nav__link> 在管理节点上安装ansible </a> </li> <li class=md-nav__item> <a href=#bash命令行自动补全 class=md-nav__link> bash命令行自动补全 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3快速开始 class=md-nav__link> 3.快速开始 </a> <nav class=md-nav aria-label=3.快速开始> <ul class=md-nav__list> <li class=md-nav__item> <a href=#环境信息 class=md-nav__link> 环境信息 </a> </li> <li class=md-nav__item> <a href=#任务 class=md-nav__link> 任务 </a> </li> <li class=md-nav__item> <a href=#步骤 class=md-nav__link> 步骤 </a> <nav class=md-nav aria-label=步骤> <ul class=md-nav__list> <li class=md-nav__item> <a href=#0-安装ansible class=md-nav__link> 0. 安装ansible </a> </li> <li class=md-nav__item> <a href=#1-定义主机清单 class=md-nav__link> 1. 定义主机清单 </a> </li> <li class=md-nav__item> <a href=#2-执行ansible命令 class=md-nav__link> 2. 执行ansible命令 </a> </li> <li class=md-nav__item> <a href=#3-验证 class=md-nav__link> 3. 验证 </a> </li> <li class=md-nav__item> <a href=#4-执行ansible-playbook class=md-nav__link> 4. 执行ansible playbook </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4认识主机清单 class=md-nav__link> 4.认识主机清单 </a> <nav class=md-nav aria-label=4.认识主机清单> <ul class=md-nav__list> <li class=md-nav__item> <a href=#主机清单示例 class=md-nav__link> 主机清单示例 </a> </li> <li class=md-nav__item> <a href=#默认组 class=md-nav__link> 默认组 </a> </li> <li class=md-nav__item> <a href=#主机变量和组变量 class=md-nav__link> 主机变量和组变量 </a> </li> <li class=md-nav__item> <a href=#变量合并 class=md-nav__link> 变量合并 </a> </li> <li class=md-nav__item> <a href=#使用多个主机清单 class=md-nav__link> 使用多个主机清单 </a> </li> <li class=md-nav__item> <a href=#主机内置变量列表 class=md-nav__link> 主机内置变量列表 </a> </li> <li class=md-nav__item> <a href=#在运行的时候增加主机 class=md-nav__link> 在运行的时候增加主机 </a> </li> <li class=md-nav__item> <a href=#限定主机清单的运行主机 class=md-nav__link> 限定主机清单的运行主机 </a> </li> <li class=md-nav__item> <a href=#示例 class=md-nav__link> 示例 </a> <nav class=md-nav aria-label=示例> <ul class=md-nav__list> <li class=md-nav__item> <a href=#连接本地主机 class=md-nav__link> 连接本地主机 </a> </li> <li class=md-nav__item> <a href=#使用别名连接主机 class=md-nav__link> 使用别名连接主机 </a> </li> <li class=md-nav__item> <a href=#使用-ssh-秘钥连接主机 class=md-nav__link> 使用 ssh 秘钥连接主机 </a> </li> <li class=md-nav__item> <a href=#使用-跳板机-连接主机 class=md-nav__link> 使用 跳板机 连接主机 </a> </li> <li class=md-nav__item> <a href=#命令行指定主机清单 class=md-nav__link> 命令行指定主机清单 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#动态主机清单 class=md-nav__link> 动态主机清单 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#5patterns-匹配 class=md-nav__link> 5.Patterns 匹配 </a> <nav class=md-nav aria-label="5.Patterns 匹配"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#常用匹配 class=md-nav__link> 常用匹配 </a> </li> <li class=md-nav__item> <a href=#局限性 class=md-nav__link> 局限性 </a> </li> <li class=md-nav__item> <a href=#高级特性 class=md-nav__link> 高级特性 </a> <nav class=md-nav aria-label=高级特性> <ul class=md-nav__list> <li class=md-nav__item> <a href=#使用变量 class=md-nav__link> 使用变量 </a> </li> <li class=md-nav__item> <a href=#使用切片 class=md-nav__link> 使用切片 </a> </li> <li class=md-nav__item> <a href=#正则表达式 class=md-nav__link> 正则表达式 </a> </li> <li class=md-nav__item> <a href=#限定主机 class=md-nav__link> 限定主机 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#6使用ad-hoc命令 class=md-nav__link> 6.使用ad-hoc命令 </a> <nav class=md-nav aria-label=6.使用ad-hoc命令> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ad-hoc-命令 class=md-nav__link> ad-hoc 命令 </a> </li> <li class=md-nav__item> <a href=#ad-hoc-示例 class=md-nav__link> ad-hoc 示例 </a> <nav class=md-nav aria-label="ad-hoc 示例"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#执行shell命令 class=md-nav__link> 执行shell命令 </a> <nav class=md-nav aria-label=执行shell命令> <ul class=md-nav__list> <li class=md-nav__item> <a href=#command class=md-nav__link> command </a> </li> <li class=md-nav__item> <a href=#shell class=md-nav__link> shell </a> </li> <li class=md-nav__item> <a href=#raw class=md-nav__link> raw </a> </li> <li class=md-nav__item> <a href=#script class=md-nav__link> script </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#文件管理 class=md-nav__link> 文件管理 </a> <nav class=md-nav aria-label=文件管理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#copy class=md-nav__link> copy </a> </li> <li class=md-nav__item> <a href=#fetch class=md-nav__link> fetch </a> </li> <li class=md-nav__item> <a href=#file class=md-nav__link> file </a> </li> <li class=md-nav__item> <a href=#unarchive class=md-nav__link> unarchive </a> </li> <li class=md-nav__item> <a href=#stat class=md-nav__link> stat </a> </li> <li class=md-nav__item> <a href=#get_url class=md-nav__link> get_url </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#管理软件包 class=md-nav__link> 管理软件包 </a> <nav class=md-nav aria-label=管理软件包> <ul class=md-nav__list> <li class=md-nav__item> <a href=#apt class=md-nav__link> apt </a> </li> <li class=md-nav__item> <a href=#yum class=md-nav__link> yum </a> </li> <li class=md-nav__item> <a href=#package class=md-nav__link> package </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#用户和用户组 class=md-nav__link> 用户和用户组 </a> <nav class=md-nav aria-label=用户和用户组> <ul class=md-nav__list> <li class=md-nav__item> <a href=#user class=md-nav__link> user </a> </li> <li class=md-nav__item> <a href=#group class=md-nav__link> group </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#版本控制 class=md-nav__link> 版本控制 </a> <nav class=md-nav aria-label=版本控制> <ul class=md-nav__list> <li class=md-nav__item> <a href=#git class=md-nav__link> git </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#服务管理 class=md-nav__link> 服务管理 </a> <nav class=md-nav aria-label=服务管理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#service class=md-nav__link> service </a> </li> <li class=md-nav__item> <a href=#systemd class=md-nav__link> systemd </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#防火墙管理 class=md-nav__link> 防火墙管理 </a> <nav class=md-nav aria-label=防火墙管理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#iptables class=md-nav__link> iptables </a> </li> <li class=md-nav__item> <a href=#firewalld class=md-nav__link> firewalld </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#文件内容操作 class=md-nav__link> 文件内容操作 </a> <nav class=md-nav aria-label=文件内容操作> <ul class=md-nav__list> <li class=md-nav__item> <a href=#lineinfile class=md-nav__link> lineinfile </a> </li> <li class=md-nav__item> <a href=#replace class=md-nav__link> replace </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#定时任务 class=md-nav__link> 定时任务 </a> </li> <li class=md-nav__item> <a href=#搜集系统信息 class=md-nav__link> 搜集系统信息 </a> </li> <li class=md-nav__item> <a href=#指定连接方式 class=md-nav__link> 指定连接方式 </a> </li> <li class=md-nav__item> <a href=#后台运行 class=md-nav__link> 后台运行 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#练习 class=md-nav__link> 练习 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#7熟悉ansible命令 class=md-nav__link> 7.熟悉ansible命令 </a> <nav class=md-nav aria-label=7.熟悉ansible命令> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ansible class=md-nav__link> ansible </a> </li> <li class=md-nav__item> <a href=#ansible-console class=md-nav__link> ansible-console </a> </li> <li class=md-nav__item> <a href=#ansible-doc class=md-nav__link> ansible-doc </a> </li> <li class=md-nav__item> <a href=#ansible-galaxy class=md-nav__link> ansible-galaxy </a> </li> <li class=md-nav__item> <a href=#ansible-playbook class=md-nav__link> ansible-playbook </a> </li> <li class=md-nav__item> <a href=#ansible-pull class=md-nav__link> ansible-pull </a> </li> <li class=md-nav__item> <a href=#ansible-config class=md-nav__link> ansible-config </a> </li> <li class=md-nav__item> <a href=#ansible-inventory class=md-nav__link> ansible-inventory </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#8使用-playbook class=md-nav__link> 8.使用 Playbook </a> <nav class=md-nav aria-label="8.使用 Playbook"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#playbook-示例 class=md-nav__link> Playbook 示例 </a> </li> <li class=md-nav__item> <a href=#主机和用户 class=md-nav__link> 主机和用户 </a> <nav class=md-nav aria-label=主机和用户> <ul class=md-nav__list> <li class=md-nav__item> <a href=#主机的执行顺序 class=md-nav__link> 主机的执行顺序 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#任务列表 class=md-nav__link> 任务列表 </a> </li> <li class=md-nav__item> <a href=#事件处理handlers class=md-nav__link> 事件处理Handlers </a> </li> <li class=md-nav__item> <a href=#执行-playbook class=md-nav__link> 执行 Playbook </a> <nav class=md-nav aria-label="执行 Playbook"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#playbook执行顺序 class=md-nav__link> playbook执行顺序 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#9包含和角色 class=md-nav__link> 9.包含和角色 </a> <nav class=md-nav aria-label=9.包含和角色> <ul class=md-nav__list> <li class=md-nav__item> <a href=#动态和静态 class=md-nav__link> 动态和静态 </a> </li> <li class=md-nav__item> <a href=#静态导入 class=md-nav__link> 静态导入 </a> </li> <li class=md-nav__item> <a href=#动态包含 class=md-nav__link> 动态包含 </a> </li> <li class=md-nav__item> <a href=#动态与静态两者的区别 class=md-nav__link> 动态与静态两者的区别 </a> </li> <li class=md-nav__item> <a href=#角色role class=md-nav__link> 角色ROLE </a> </li> <li class=md-nav__item> <a href=#角色目录结构 class=md-nav__link> 角色目录结构 </a> </li> <li class=md-nav__item> <a href=#角色使用 class=md-nav__link> 角色使用 </a> </li> <li class=md-nav__item> <a href=#角色重复执行 class=md-nav__link> 角色重复执行 </a> </li> <li class=md-nav__item> <a href=#角色默认变量 class=md-nav__link> 角色默认变量 </a> </li> <li class=md-nav__item> <a href=#角色依赖 class=md-nav__link> 角色依赖 </a> </li> <li class=md-nav__item> <a href=#嵌入模块和插件 class=md-nav__link> 嵌入模块和插件 </a> </li> <li class=md-nav__item> <a href=#角色搜索路径 class=md-nav__link> 角色搜索路径 </a> </li> <li class=md-nav__item> <a href=#ansible-galaxy_1 class=md-nav__link> Ansible Galaxy </a> </li> <li class=md-nav__item> <a href=#角色示例参考 class=md-nav__link> 角色示例参考 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#10使用变量 class=md-nav__link> 10.使用变量 </a> <nav class=md-nav aria-label=10.使用变量> <ul class=md-nav__list> <li class=md-nav__item> <a href=#创建有效的变量名 class=md-nav__link> 创建有效的变量名 </a> </li> <li class=md-nav__item> <a href=#变量使用 class=md-nav__link> 变量使用 </a> <nav class=md-nav aria-label=变量使用> <ul class=md-nav__list> <li class=md-nav__item> <a href=#通过命令行传递变量extra-vars class=md-nav__link> 通过命令行传递变量(extra vars) </a> </li> <li class=md-nav__item> <a href=#在inventory-中定义变量inventory-vars class=md-nav__link> 在inventory 中定义变量（inventory vars) </a> </li> <li class=md-nav__item> <a href=#在play中定义变量play-vars class=md-nav__link> 在play中定义变量（play vars） </a> </li> <li class=md-nav__item> <a href=#在角色和文件包含中定义变量play-include_vars class=md-nav__link> 在角色和文件包含中定义变量(play include_vars) </a> </li> <li class=md-nav__item> <a href=#在play中包含变量文件play-vars_files class=md-nav__link> 在play中包含变量文件(play vars_files) </a> </li> <li class=md-nav__item> <a href=#定义角色默认变量role-defaults-vars class=md-nav__link> 定义角色默认变量（role defaults vars） </a> </li> <li class=md-nav__item> <a href=#定义角色变量role--vars class=md-nav__link> 定义角色变量（role vars） </a> </li> <li class=md-nav__item> <a href=#以交互方式获取变量值-play-vars_prompt class=md-nav__link> 以交互方式获取变量值( play vars_prompt) </a> </li> <li class=md-nav__item> <a href=#定义角色变量role-and-include-vars class=md-nav__link> 定义角色变量（role and include vars) </a> </li> <li class=md-nav__item> <a href=#注册变量registered-vars class=md-nav__link> 注册变量（registered vars） </a> </li> <li class=md-nav__item> <a href=#动态创建fact变量 class=md-nav__link> 动态创建fact变量 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#变量优先级 class=md-nav__link> 变量优先级 </a> </li> <li class=md-nav__item> <a href=#变量范围 class=md-nav__link> 变量范围 </a> </li> <li class=md-nav__item> <a href=#使用变量_1 class=md-nav__link> 使用变量 </a> <nav class=md-nav aria-label=使用变量> <ul class=md-nav__list> <li class=md-nav__item> <a href=#在jinja2中使用 class=md-nav__link> 在jinja2中使用 </a> </li> <li class=md-nav__item> <a href=#使用jinja2过滤器转换变量 class=md-nav__link> 使用Jinja2过滤器转换变量 </a> </li> <li class=md-nav__item> <a href=#从系统中发现变量facts class=md-nav__link> 从系统中发现变量:Facts </a> </li> <li class=md-nav__item> <a href=#访问复杂变量数据 class=md-nav__link> 访问复杂变量数据 </a> </li> <li class=md-nav__item> <a href=#使用内置变量 class=md-nav__link> 使用内置变量 </a> <nav class=md-nav aria-label=使用内置变量> <ul class=md-nav__list> <li class=md-nav__item> <a href=#魔术变量 class=md-nav__link> 魔术变量 </a> </li> <li class=md-nav__item> <a href=#facts-变量 class=md-nav__link> Facts 变量 </a> </li> <li class=md-nav__item> <a href=#连接变量 class=md-nav__link> 连接变量 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#11facts-数据 class=md-nav__link> 11.Facts 数据 </a> <nav class=md-nav aria-label="11.Facts 数据"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#获取facts信息 class=md-nav__link> 获取Facts信息 </a> <nav class=md-nav aria-label=获取Facts信息> <ul class=md-nav__list> <li class=md-nav__item> <a href=#使用setup模块来获取目标系统信息 class=md-nav__link> 使用setup模块来获取目标系统信息 </a> </li> <li class=md-nav__item> <a href=#使用playbook来获取目标系统信息 class=md-nav__link> 使用playbook来获取目标系统信息 </a> </li> <li class=md-nav__item> <a href=#在task中设置facts信息 class=md-nav__link> 在task中设置facts信息 </a> </li> <li class=md-nav__item> <a href=#自定义目标系统facts class=md-nav__link> 自定义目标系统facts </a> </li> <li class=md-nav__item> <a href=#facts-返回的信息 class=md-nav__link> Facts 返回的信息 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#缓存facts信息 class=md-nav__link> 缓存Facts信息 </a> <nav class=md-nav aria-label=缓存Facts信息> <ul class=md-nav__list> <li class=md-nav__item> <a href=#使用文件作为缓存 class=md-nav__link> 使用文件作为缓存 </a> </li> <li class=md-nav__item> <a href=#使用redis作为缓存 class=md-nav__link> 使用redis作为缓存 </a> </li> <li class=md-nav__item> <a href=#使用memcached作为缓存 class=md-nav__link> 使用memcached作为缓存 </a> </li> <li class=md-nav__item> <a href=#刷新缓存 class=md-nav__link> 刷新缓存 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#12jinja2-模板语法 class=md-nav__link> 12.Jinja2 模板语法 </a> <nav class=md-nav aria-label="12.Jinja2 模板语法"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#jinja2-模版中的一些语法 class=md-nav__link> jinja2 模版中的一些语法 </a> <nav class=md-nav aria-label="jinja2 模版中的一些语法"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#变量 class=md-nav__link> 变量 </a> </li> <li class=md-nav__item> <a href=#注释 class=md-nav__link> 注释 </a> </li> <li class=md-nav__item> <a href=#转义 class=md-nav__link> 转义 </a> </li> <li class=md-nav__item> <a href=#空白控制 class=md-nav__link> 空白控制 </a> </li> <li class=md-nav__item> <a href=#控制结构 class=md-nav__link> 控制结构 </a> <nav class=md-nav aria-label=控制结构> <ul class=md-nav__list> <li class=md-nav__item> <a href=#for class=md-nav__link> For </a> </li> <li class=md-nav__item> <a href=#if-语句 class=md-nav__link> if 语句 </a> </li> <li class=md-nav__item> <a href=#过滤器 class=md-nav__link> 过滤器 </a> </li> <li class=md-nav__item> <a href=#赋值 class=md-nav__link> 赋值 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#表达式 class=md-nav__link> 表达式 </a> </li> <li class=md-nav__item> <a href=#字面量 class=md-nav__link> 字面量 </a> </li> <li class=md-nav__item> <a href=#算术 class=md-nav__link> 算术 </a> </li> <li class=md-nav__item> <a href=#python对象方法 class=md-nav__link> Python对象方法 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#在-ansible-中使用jinja2 class=md-nav__link> 在 ansible 中使用Jinja2 </a> <nav class=md-nav aria-label="在 ansible 中使用Jinja2"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#获取当前时间 class=md-nav__link> 获取当前时间 </a> </li> <li class=md-nav__item> <a href=#过滤器_1 class=md-nav__link> 过滤器 </a> <nav class=md-nav aria-label=过滤器> <ul class=md-nav__list> <li class=md-nav__item> <a href=#格式化数据过滤器 class=md-nav__link> 格式化数据过滤器 </a> </li> <li class=md-nav__item> <a href=#强制定义变量 class=md-nav__link> 强制定义变量 </a> </li> <li class=md-nav__item> <a href=#未定义的变量默认值 class=md-nav__link> 未定义的变量默认值 </a> </li> <li class=md-nav__item> <a href=#省略参数 class=md-nav__link> 省略参数 </a> </li> <li class=md-nav__item> <a href=#列表过滤 class=md-nav__link> 列表过滤 </a> </li> <li class=md-nav__item> <a href=#数据集过滤 class=md-nav__link> 数据集过滤 </a> </li> <li class=md-nav__item> <a href=#字典过滤 class=md-nav__link> 字典过滤 </a> </li> <li class=md-nav__item> <a href=#zip-过滤 class=md-nav__link> zip 过滤 </a> </li> <li class=md-nav__item> <a href=#子元素过滤器 class=md-nav__link> 子元素过滤器 </a> </li> <li class=md-nav__item> <a href=#随机mac地址过滤器 class=md-nav__link> 随机Mac地址过滤器 </a> </li> <li class=md-nav__item> <a href=#随机数过滤 class=md-nav__link> 随机数过滤 </a> </li> <li class=md-nav__item> <a href=#随机列表过滤 class=md-nav__link> 随机列表过滤 </a> </li> <li class=md-nav__item> <a href=#数学 class=md-nav__link> 数学 </a> </li> <li class=md-nav__item> <a href=#json查询过滤 class=md-nav__link> JSON查询过滤 </a> </li> <li class=md-nav__item> <a href=#ip地址过滤 class=md-nav__link> ip地址过滤 </a> </li> <li class=md-nav__item> <a href=#network-cli-过滤器 class=md-nav__link> Network CLI 过滤器 </a> </li> <li class=md-nav__item> <a href=#network-xml-过滤器 class=md-nav__link> Network XML 过滤器 </a> </li> <li class=md-nav__item> <a href=#network-vlan-过滤器 class=md-nav__link> Network VLAN 过滤器 </a> </li> <li class=md-nav__item> <a href=#哈希过滤器 class=md-nav__link> 哈希过滤器 </a> </li> <li class=md-nav__item> <a href=#合并散列 class=md-nav__link> 合并散列 </a> </li> <li class=md-nav__item> <a href=#提取过滤器 class=md-nav__link> 提取过滤器 </a> </li> <li class=md-nav__item> <a href=#注释过滤 class=md-nav__link> 注释过滤 </a> </li> <li class=md-nav__item> <a href=#url-分割过滤器 class=md-nav__link> url 分割过滤器 </a> </li> <li class=md-nav__item> <a href=#正则匹配 class=md-nav__link> 正则匹配 </a> </li> <li class=md-nav__item> <a href=#kubernetes-过滤器 class=md-nav__link> Kubernetes 过滤器 </a> </li> <li class=md-nav__item> <a href=#其他的常用过滤 class=md-nav__link> 其他的常用过滤 </a> </li> <li class=md-nav__item> <a href=#组合过滤器 class=md-nav__link> 组合过滤器 </a> </li> <li class=md-nav__item> <a href=#product--过滤器 class=md-nav__link> Product 过滤器 </a> </li> <li class=md-nav__item> <a href=#debug-过滤器 class=md-nav__link> debug 过滤器 </a> </li> <li class=md-nav__item> <a href=#字节转换 class=md-nav__link> 字节转换 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#测试 class=md-nav__link> 测试 </a> <nav class=md-nav aria-label=测试> <ul class=md-nav__list> <li class=md-nav__item> <a href=#测试语法 class=md-nav__link> 测试语法 </a> </li> <li class=md-nav__item> <a href=#测试字符串 class=md-nav__link> 测试字符串 </a> </li> <li class=md-nav__item> <a href=#版本比较 class=md-nav__link> 版本比较 </a> </li> <li class=md-nav__item> <a href=#包含测试 class=md-nav__link> 包含测试 </a> </li> <li class=md-nav__item> <a href=#路径测试 class=md-nav__link> 路径测试 </a> </li> <li class=md-nav__item> <a href=#测试命令结果 class=md-nav__link> 测试命令结果 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#lookup-插件 class=md-nav__link> lookup 插件 </a> </li> <li class=md-nav__item> <a href=#if-语句_1 class=md-nav__link> if 语句 </a> </li> <li class=md-nav__item> <a href=#for-语句 class=md-nav__link> for 语句 </a> </li> <li class=md-nav__item> <a href=#在-when-里使用-jinja2-表达式 class=md-nav__link> 在 when 里使用 jinja2 表达式 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#13条件判断与循环 class=md-nav__link> 13.条件判断与循环 </a> <nav class=md-nav aria-label=13.条件判断与循环> <ul class=md-nav__list> <li class=md-nav__item> <a href=#条件判断 class=md-nav__link> 条件判断 </a> <nav class=md-nav aria-label=条件判断> <ul class=md-nav__list> <li class=md-nav__item> <a href=#when-语句 class=md-nav__link> When 语句 </a> </li> <li class=md-nav__item> <a href=#与循环一起使用 class=md-nav__link> 与循环一起使用 </a> </li> <li class=md-nav__item> <a href=#使用自定义的facts值做判断 class=md-nav__link> 使用自定义的facts值做判断 </a> </li> <li class=md-nav__item> <a href=#角色包含使使用when class=md-nav__link> 角色包含使使用when </a> </li> <li class=md-nav__item> <a href=#有条件的导入 class=md-nav__link> 有条件的导入 </a> </li> <li class=md-nav__item> <a href=#基于变量选择文件和模板 class=md-nav__link> 基于变量选择文件和模板 </a> </li> <li class=md-nav__item> <a href=#使用注册变量判断 class=md-nav__link> 使用注册变量判断 </a> </li> <li class=md-nav__item> <a href=#failed_when class=md-nav__link> failed_when </a> </li> <li class=md-nav__item> <a href=#changed_when class=md-nav__link> changed_when </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#循环 class=md-nav__link> 循环 </a> <nav class=md-nav aria-label=循环> <ul class=md-nav__list> <li class=md-nav__item> <a href=#比较loop-和-with_ class=md-nav__link> 比较loop 和 with_* </a> </li> <li class=md-nav__item> <a href=#标准循环 class=md-nav__link> 标准循环 </a> <nav class=md-nav aria-label=标准循环> <ul class=md-nav__list> <li class=md-nav__item> <a href=#遍历列表 class=md-nav__link> 遍历列表 </a> </li> <li class=md-nav__item> <a href=#遍历散列列表 class=md-nav__link> 遍历散列列表 </a> </li> <li class=md-nav__item> <a href=#遍历字典 class=md-nav__link> 遍历字典 </a> </li> <li class=md-nav__item> <a href=#循环中注册变量 class=md-nav__link> 循环中注册变量 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#复杂循环 class=md-nav__link> 复杂循环 </a> <nav class=md-nav aria-label=复杂循环> <ul class=md-nav__list> <li class=md-nav__item> <a href=#遍历嵌套列表 class=md-nav__link> 遍历嵌套列表 </a> </li> <li class=md-nav__item> <a href=#在满足条件之前重试任务 class=md-nav__link> 在满足条件之前重试任务 </a> </li> <li class=md-nav__item> <a href=#循环主机清单 class=md-nav__link> 循环主机清单 </a> </li> <li class=md-nav__item> <a href=#使用query还是lookup class=md-nav__link> 使用query还是lookup </a> </li> <li class=md-nav__item> <a href=#循环控制 class=md-nav__link> 循环控制 </a> <nav class=md-nav aria-label=循环控制> <ul class=md-nav__list> <li class=md-nav__item> <a href=#使用label限制loop的输出 class=md-nav__link> 使用label限制loop的输出 </a> </li> <li class=md-nav__item> <a href=#循环间隔时间 class=md-nav__link> 循环间隔时间 </a> </li> <li class=md-nav__item> <a href=#循环索引 class=md-nav__link> 循环索引 </a> </li> <li class=md-nav__item> <a href=#更改循环的变量名称 class=md-nav__link> 更改循环的变量名称 </a> </li> <li class=md-nav__item> <a href=#扩展变量 class=md-nav__link> 扩展变量 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#获取loop_var的名称 class=md-nav__link> 获取loop_var的名称 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#从with_迁移到loop class=md-nav__link> 从with_*迁移到loop </a> <nav class=md-nav aria-label=从with_*迁移到loop> <ul class=md-nav__list> <li class=md-nav__item> <a href=#with_list class=md-nav__link> with_list </a> </li> <li class=md-nav__item> <a href=#with_items class=md-nav__link> with_items </a> </li> <li class=md-nav__item> <a href=#with_indexed_items class=md-nav__link> with_indexed_items </a> </li> <li class=md-nav__item> <a href=#with_flattened class=md-nav__link> with_flattened </a> </li> <li class=md-nav__item> <a href=#with_together class=md-nav__link> with_together </a> </li> <li class=md-nav__item> <a href=#with_dict class=md-nav__link> with_dict </a> </li> <li class=md-nav__item> <a href=#with_sequence class=md-nav__link> with_sequence </a> </li> <li class=md-nav__item> <a href=#with_subelements class=md-nav__link> with_subelements </a> </li> <li class=md-nav__item> <a href=#with_random_choice class=md-nav__link> with_random_choice </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#14blocks class=md-nav__link> 14.Blocks </a> <nav class=md-nav aria-label=14.Blocks> <ul class=md-nav__list> <li class=md-nav__item> <a href=#块的错误处理 class=md-nav__link> 块的错误处理 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#15playbook高级特性 class=md-nav__link> 15.Playbook高级特性 </a> <nav class=md-nav aria-label=15.Playbook高级特性> <ul class=md-nav__list> <li class=md-nav__item> <a href=#权限提升 class=md-nav__link> 权限提升 </a> <nav class=md-nav aria-label=权限提升> <ul class=md-nav__list> <li class=md-nav__item> <a href=#使用become class=md-nav__link> 使用become </a> <nav class=md-nav aria-label=使用become> <ul class=md-nav__list> <li class=md-nav__item> <a href=#become-指令 class=md-nav__link> become 指令 </a> </li> <li class=md-nav__item> <a href=#become-变量 class=md-nav__link> become 变量 </a> </li> <li class=md-nav__item> <a href=#become-命令行选项 class=md-nav__link> become 命令行选项 </a> </li> <li class=md-nav__item> <a href=#become的一些限制和风险 class=md-nav__link> become的一些限制和风险 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#网络模块使用become class=md-nav__link> 网络模块使用become </a> <nav class=md-nav aria-label=网络模块使用become> <ul class=md-nav__list> <li class=md-nav__item> <a href=#设置所有任务的enable模式 class=md-nav__link> 设置所有任务的enable模式 </a> </li> <li class=md-nav__item> <a href=#enable模式的密码 class=md-nav__link> enable模式的密码 </a> </li> <li class=md-nav__item> <a href=#authorize-和-auth_pass class=md-nav__link> authorize 和 auth_pass </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#windows-使用become class=md-nav__link> windows 使用become </a> <nav class=md-nav aria-label="windows 使用become"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#localservice账号 class=md-nav__link> LocalService账号 </a> </li> <li class=md-nav__item> <a href=#无需为become设置密码 class=md-nav__link> 无需为become设置密码 </a> </li> <li class=md-nav__item> <a href=#没有密码的帐户 class=md-nav__link> 没有密码的帐户 </a> </li> <li class=md-nav__item> <a href=#become的参数 class=md-nav__link> become的参数 </a> </li> <li class=md-nav__item> <a href=#限制 class=md-nav__link> 限制 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#异步操作和轮询 class=md-nav__link> 异步操作和轮询 </a> <nav class=md-nav aria-label=异步操作和轮询> <ul class=md-nav__list> <li class=md-nav__item> <a href=#异步任务的状态文件 class=md-nav__link> 异步任务的状态文件 </a> </li> <li class=md-nav__item> <a href=#异步任务的返回值 class=md-nav__link> 异步任务的返回值 </a> </li> <li class=md-nav__item> <a href=#异步任务状态的返回值 class=md-nav__link> 异步任务状态的返回值 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#检查模式 class=md-nav__link> 检查模式 </a> </li> <li class=md-nav__item> <a href=#debug-功能 class=md-nav__link> debug 功能 </a> <nav class=md-nav aria-label="debug 功能"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#使用-debugger-关键字 class=md-nav__link> 使用 debugger 关键字 </a> </li> <li class=md-nav__item> <a href=#配置或环境变量 class=md-nav__link> 配置或环境变量 </a> </li> <li class=md-nav__item> <a href=#使用-strategy-插件 class=md-nav__link> 使用 strategy 插件 </a> </li> <li class=md-nav__item> <a href=#调试-debugger class=md-nav__link> 调试 debugger </a> </li> <li class=md-nav__item> <a href=#与free策略一起使用 class=md-nav__link> 与free策略一起使用 </a> </li> <li class=md-nav__item> <a href=#使用-debug-模块 class=md-nav__link> 使用 debug 模块 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#滚动执行 class=md-nav__link> 滚动执行 </a> </li> <li class=md-nav__item> <a href=#指定最大失败数目 class=md-nav__link> 指定最大失败数目 </a> </li> <li class=md-nav__item> <a href=#委托 class=md-nav__link> 委托 </a> </li> <li class=md-nav__item> <a href=#任务只运行一次 class=md-nav__link> 任务只运行一次 </a> </li> <li class=md-nav__item> <a href=#本地执行 class=md-nav__link> 本地执行 </a> </li> <li class=md-nav__item> <a href=#设置环境变量 class=md-nav__link> 设置环境变量 </a> </li> <li class=md-nav__item> <a href=#错误处理 class=md-nav__link> 错误处理 </a> <nav class=md-nav aria-label=错误处理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#忽略错误 class=md-nav__link> 忽略错误 </a> </li> <li class=md-nav__item> <a href=#重置无法访问的主机 class=md-nav__link> 重置无法访问的主机 </a> </li> <li class=md-nav__item> <a href=#即使任务失败handlers也执行 class=md-nav__link> 即使任务失败，handlers也执行 </a> </li> <li class=md-nav__item> <a href=#控制任务失败 class=md-nav__link> 控制任务失败 </a> </li> <li class=md-nav__item> <a href=#更改任务changed状态 class=md-nav__link> 更改任务changed状态 </a> </li> <li class=md-nav__item> <a href=#出现错误时立即中断执行 class=md-nav__link> 出现错误时立即中断执行 </a> </li> <li class=md-nav__item> <a href=#使用blocks class=md-nav__link> 使用blocks </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#yaml-语法 class=md-nav__link> YAML 语法 </a> </li> <li class=md-nav__item> <a href=#prompts-运行时提示输入内容 class=md-nav__link> Prompts: 运行时，提示输入内容 </a> </li> <li class=md-nav__item> <a href=#标记 class=md-nav__link> 标记 </a> <nav class=md-nav aria-label=标记> <ul class=md-nav__list> <li class=md-nav__item> <a href=#标记任务 class=md-nav__link> 标记任务 </a> </li> <li class=md-nav__item> <a href=#标记playbook class=md-nav__link> 标记playbook </a> </li> <li class=md-nav__item> <a href=#标记role class=md-nav__link> 标记role </a> </li> <li class=md-nav__item> <a href=#标记包含 class=md-nav__link> 标记包含 </a> </li> <li class=md-nav__item> <a href=#特殊标记 class=md-nav__link> 特殊标记 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#vault-加密 class=md-nav__link> Vault 加密 </a> </li> <li class=md-nav__item> <a href=#从某个任务开始执行 class=md-nav__link> 从某个任务开始执行 </a> </li> <li class=md-nav__item> <a href=#一步一步的执行 class=md-nav__link> 一步一步的执行 </a> </li> <li class=md-nav__item> <a href=#模块默认值 class=md-nav__link> 模块默认值 </a> </li> <li class=md-nav__item> <a href=#等待 class=md-nav__link> 等待 </a> </li> <li class=md-nav__item> <a href=#playbook-关键字 class=md-nav__link> Playbook 关键字 </a> </li> <li class=md-nav__item> <a href=#lookup-插件_1 class=md-nav__link> lookup 插件 </a> <nav class=md-nav aria-label="lookup 插件"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#使用-file-获取文件内容 class=md-nav__link> 使用 file 获取文件内容 </a> </li> <li class=md-nav__item> <a href=#使用-env-获取变量 class=md-nav__link> 使用 env 获取变量 </a> </li> <li class=md-nav__item> <a href=#使用-password-生成密码字符串 class=md-nav__link> 使用 password 生成密码字符串 </a> </li> <li class=md-nav__item> <a href=#使用-csvfile-读取csv文件 class=md-nav__link> 使用 csvfile 读取csv文件 </a> </li> <li class=md-nav__item> <a href=#使用-ini--读取ini文件 class=md-nav__link> 使用 ini 读取ini文件 </a> </li> <li class=md-nav__item> <a href=#使用-dig-dns查询 class=md-nav__link> 使用 dig dns查询 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=ansible入门>Ansible入门<a class=headerlink href=#ansible入门 title="Permanent link">&para;</a></h1> <h2 id=1ansible介绍>1.Ansible介绍<a class=headerlink href=#1ansible介绍 title="Permanent link">&para;</a></h2> <p>Ansible 是2012年推出的一种通用自动化工具，可用于配置管理或工作流程自动化。配置管理是一种" 基础架构代码 "实践，它将事物编码，例如应该在系统上安装什么包和版本，或者应该运行什么守护进程。工作流自动化可能是从配置基础架构到部署软件的任何事情。Ansible 在2015年时被Redhat公司收购。</p> <p>Ansible是用Python编写的，它使用SSH在不同的机器上执行命令。Ansible是无代理的，这使得入手更容易。您只需要在相关机器上安装SSH和Python。</p> <p>Ansible使用声明式YAML语言"playbook"将一组主机（"hosts"）映射到定义明确的角色。</p> <p>声明性用于指示Ansible如何设置或更改事物，Ansible才进行必要的更改。</p> <h3 id=ansible-的目标>Ansible 的目标<a class=headerlink href=#ansible-的目标 title="Permanent link">&para;</a></h3> <p>一切自动化</p> <h3 id=ansible的使用范围>Ansible的使用范围<a class=headerlink href=#ansible的使用范围 title="Permanent link">&para;</a></h3> <ul> <li>自动化部署应用 </li> <li>自动化管理配置 </li> <li>自动化的持续交付 </li> <li>自动化的云服务管理 </li> <li>自动化网络设备管理</li> </ul> <p>更多信息请参考：</p> <ul> <li> <p>Ansible官方地址：<a href=https://docs.ansible.com/ >https://docs.ansible.com/</a></p> </li> <li> <p>GitHub地址：<a href=https://github.com/ansible/ansible/blob/devel/docsite/rst/index.rst>https://github.com/ansible/ansible/blob/devel/docsite/rst/index.rst</a></p> </li> <li> <p>Ansible中文权威地址：<a href=http://www.ansible.com.cn/ >http://www.ansible.com.cn/</a></p> </li> </ul> <h3 id=ansible是怎么工作的>Ansible是怎么工作的<a class=headerlink href=#ansible是怎么工作的 title="Permanent link">&para;</a></h3> <p><img alt src=https://ansible.leops.cn/images/basic/ansible-arch.png></p> <p>从上图可以看出，运行ansible的先决条件是，安装ansible到管理节点，定义主机清单，并有一些playbooks定义。</p> <p>简要的步骤</p> <ul> <li>在控制节点上安装ansible </li> <li>配置主机清单: 将被控节点的连接信息配置到主机清单中。 </li> <li>定义playbook: 指定运行主机和执行任务</li> </ul> <p>让我们来看看我们如何使用Ansible将我们的Ubuntu虚拟机转换为Web服务器。 </p> <p>您在管理节点上运行Ansible Playbook，它查看您在playbook中定义的命令参数，并通知我们定位到网络组中的节点。 </p> <p>Ansible然后读取主机清单以查找分配给Web组的节点。</p> <p>在这一点上，Ansible已经准备好开始工作，所以它将通过ssh远程连接到定义的机器，通常你会想要通过预共享密钥建立一些类型的ssh信任，这样你就不必在进行ssh登陆的时候输入密码。然后Ansible将开始逐步执行playbook中的任务，一次一个任务，从顶部到底部的顺序遍历它们，就像你手动登录执行任务一样。所以，它安装软件包，更新配置文件，使用git部署我们的网站代码，最后启动我们的Web服务。当Ansible很愉快的把一切都按预期的完成，你会得到一个执行成功的状态报告。</p> <p>可以用动图说明下此次过程。</p> <p><img alt src=https://ansible.leops.cn/images/basic/ansible-arch.gif></p> <h3 id=对管理主机的要求>对管理主机的要求<a class=headerlink href=#对管理主机的要求 title="Permanent link">&para;</a></h3> <p>目前,只要机器上安装了 Python 2（版本2.6或2.7）或Python 3（版本3.5及更高版本）都可以运行Ansible (windows系统不可以做管理主机) 管理主机的系统可以是 Red Hat, Debian, CentOS, OS X, BSD的各种版本.</p> <h3 id=对节点主机的要求>对节点主机的要求<a class=headerlink href=#对节点主机的要求 title="Permanent link">&para;</a></h3> <p>通常我们使用 ssh 与节点通信，默认使用 sftp. 如果 sftp 不可用，可在 ansible.cfg 配置文件中配置成 scp 的方式. </p> <p>在节点上也需要安装Python 2（2.6或更高版本）或Python 3（3.5或更高版本）</p> <h3 id=ansible-概念>Ansible 概念<a class=headerlink href=#ansible-概念 title="Permanent link">&para;</a></h3> <h4 id=控制节点control-node>控制节点(Control node)<a class=headerlink href=#控制节点control-node title="Permanent link">&para;</a></h4> <p>任何装有Ansible的机器可称为**控制节点**。 您可以从任何控制节点运行命令和剧本，并调用<code>/usr/bin/ansible</code>或<code>/usr/bin/ansible-playbook</code>。 </p> <p>您可以将任何安装了Python的计算机用作控制节点,笔记本电脑,共享桌面和服务器都可以运行Ansible。 但是，不能将Windows计算机用作控制节点。您也可以有多个控制节点。</p> <h4 id=管理节点managed-nodes>管理节点(Managed nodes)<a class=headerlink href=#管理节点managed-nodes title="Permanent link">&para;</a></h4> <p>使用Ansible管理的网络设备或服务器可称为**管理节点**。 受管节点有时也称为**主机**。 受管节点上是不需要安装Ansible的。</p> <h4 id=主机清单inventory>主机清单(Inventory)<a class=headerlink href=#主机清单inventory title="Permanent link">&para;</a></h4> <p>托管节点的列表。库存文件有时也称为主机文件。您的目录可以为每个托管节点指定诸如IP地址之类的信息。库存还可以组织托管节点，创建和嵌套组，以便于扩展。要了解更多关于库存的信息，请参见使用主机清单一节。</p> <h4 id=模块modules>模块(Modules)<a class=headerlink href=#模块modules title="Permanent link">&para;</a></h4> <p>Ansible执行的具体代码。每个模块都有特定的用途，从管理特定类型数据库的用户到管理特定类型网络设备上的VLAN接口。您可以使用任务调用单个模块，也可以调用剧本中的几个不同模块。要了解Ansible包含多少个模块，请查看所有模块的列表。</p> <h4 id=任务tasks>任务(Tasks)<a class=headerlink href=#任务tasks title="Permanent link">&para;</a></h4> <p>Ansible的行动单位。tasks包含一组由module组成的任务列表, 您可以使用特别的命令一次性执行单个任务。</p> <h4 id=剧本playbooks>剧本(Playbooks)<a class=headerlink href=#剧本playbooks title="Permanent link">&para;</a></h4> <p>保存了已排序的任务列表，因此可以按此顺序重复运行这些任务。 剧本可以包括变量和任务。剧本是用 YAML 编写的，易于阅读、编写、共享和理解。 要了解更多关于剧本的信息，请查看剧本。</p> <h3 id=社区活跃>社区活跃<a class=headerlink href=#社区活跃 title="Permanent link">&para;</a></h3> <blockquote> <p>统计时间: 2020年04月06日</p> </blockquote> <ul> <li>Ansible releases 304 </li> <li>Ansible modules 3387 </li> <li>Galaxy Roles 24,251 </li> <li>Github Starts 42,547 </li> <li>Github Fork 18,764 </li> <li>Github Contributors 4,955</li> </ul> <h3 id=ansible项目>ansible项目<a class=headerlink href=#ansible项目 title="Permanent link">&para;</a></h3> <p>Ansible Galaxy是一个用于查找，共享，使用Ansible role的在线社区。 <a href=https://galaxy.ansible.com/ >https://galaxy.ansible.com/</a></p> <p>Ansible Container是一个开源项目，旨在实现整个容器构建，部署和管理过程的自动化。 <a href=https://github.com/ansible/ansible-container>https://github.com/ansible/ansible-container</a></p> <p>Ansible tower 商业项目，使用可视化仪表板，基于角色的访问控制，作业调度，集成通知和图形库存管理来集中和控制IT基础架构。 <a href=https://www.ansible.com/products/tower>https://www.ansible.com/products/tower</a></p> <h3 id=ansible-证书>Ansible 证书<a class=headerlink href=#ansible-证书 title="Permanent link">&para;</a></h3> <ul> <li>AUTOMATION WITH ANSIBLE I (DO407) 了解如何安装和配置Ansible，创建和运行剧本以配置系统，并学习管理主机。</li> <li>AUTOMATION WITH ANSIBLE II: RED HAT ANSIBLE TOWER (DO409) 了解使用 Ansible Tower。</li> <li>RED HAT CERTIFICATE OF EXPERTISE IN ANSIBLE AUTOMATION (EX407) 测试您使用Ansible自动配置系统和应用程序的技能，知识和能力。 通过此考试，您将获得Ansible Automation的红帽认证证书。</li> </ul> <h3 id=ansible-与其它配置管理的对比>Ansible 与其它配置管理的对比<a class=headerlink href=#ansible-与其它配置管理的对比 title="Permanent link">&para;</a></h3> <p>笔者选择了目前几款主流的与 Ansible 功能类似的配置管理软件chef、 Puppet、Saltstack，这里所做的对比不针对各个软件的性能作比较，只是对各个软件的特性做个对比。</p> <table> <thead> <tr> <th></th> <th><strong>Ansible</strong></th> <th><strong>Chef</strong></th> <th><strong>Puppet</strong></th> <th><strong>SaltStack</strong></th> </tr> </thead> <tbody> <tr> <td><strong>程序语言</strong></td> <td>Python</td> <td>Ruby，Erlang</td> <td>C++, Clojure</td> <td>Python2</td> </tr> <tr> <td><strong>配置文件语言</strong></td> <td>YAML，JSON</td> <td>Ruby</td> <td>Propfietary</td> <td>YAML</td> </tr> <tr> <td><strong>数据库</strong></td> <td>否</td> <td>PostgreSQL</td> <td>PuppetDB</td> <td>无</td> </tr> <tr> <td><strong>传输方式</strong></td> <td>Ssh</td> <td>RabbitMQ</td> <td>Mcollective</td> <td>ZeroMQ</td> </tr> <tr> <td><strong>发布方式</strong></td> <td>Push</td> <td>Pull</td> <td>Pull</td> <td>Push</td> </tr> <tr> <td><strong>管理节点</strong></td> <td>A，B，L，O，S</td> <td>Linux</td> <td>Linux</td> <td>L，B</td> </tr> <tr> <td><strong>客户端</strong></td> <td>否</td> <td>A，B，L，O，S，W</td> <td>A，B，L，O，S，W</td> <td>A，B，L，O，S，W</td> </tr> <tr> <td><strong>无代理</strong></td> <td>是</td> <td>否</td> <td>否</td> <td>否</td> </tr> <tr> <td><strong>公有云版本</strong></td> <td>AM</td> <td>AM/AZ/PR</td> <td>否</td> <td>否</td> </tr> <tr> <td><strong>公有云管理</strong></td> <td>AM/AZ/OS/GCP</td> <td>Fog driver</td> <td>AM/AZ/VM/GCP</td> <td>salt Cloud</td> </tr> <tr> <td><strong>架构</strong></td> <td>Server</td> <td>server/client</td> <td>server/client</td> <td>server/client</td> </tr> <tr> <td><strong>逐步部署</strong></td> <td>是</td> <td>是</td> <td>否</td> <td>否</td> </tr> <tr> <td><strong>企业版UI</strong></td> <td>Ansible Tower</td> <td>opscode Manage</td> <td>Puppet Enterprise</td> <td>SaltStack Enterprise</td> </tr> <tr> <td><strong>开源版UI</strong></td> <td>Semaphore</td> <td>Chef Manage</td> <td>Foreman</td> <td>Slatpad，Saltshaker</td> </tr> <tr> <td><strong>企业版本</strong></td> <td>是</td> <td>是</td> <td>是</td> <td>是</td> </tr> <tr> <td></td> <td></td> <td></td> <td></td> <td></td> </tr> <tr> <td><strong>创建时间</strong></td> <td>2012年3月6日</td> <td>2009年1月16日</td> <td>2010年9月15日</td> <td>2011年2月21日</td> </tr> <tr> <td><strong>Github Starts</strong></td> <td>42,547</td> <td>6,198</td> <td>5,710</td> <td>10,747</td> </tr> <tr> <td><strong>Github Forks</strong></td> <td>18,764</td> <td>2,417</td> <td>2,138</td> <td>4,815</td> </tr> <tr> <td><strong>Contributors</strong></td> <td>4,955</td> <td>586</td> <td>536</td> <td>2,078</td> </tr> <tr> <td><strong>Commits</strong></td> <td>49,775</td> <td>26,017</td> <td>31,751</td> <td>106,129</td> </tr> </tbody> </table> <blockquote> <p>统计时间: 2020年04月06日</p> </blockquote> <h3 id=资源>资源<a class=headerlink href=#资源 title="Permanent link">&para;</a></h3> <ul> <li>源码：<a href=https://github.com/ansible/ansible>https://github.com/ansible/ansible</a></li> <li>官方文档： <a href=http://docs.ansible.com/ >http://docs.ansible.com/</a></li> <li>Jinja2 中文文档： <a href=http://docs.jinkan.org/docs/jinja2/ >http://docs.jinkan.org/docs/jinja2/</a></li> <li>yaml语法： <a href=http://www.yaml.org/ >http://www.yaml.org/</a></li> <li>ansible 电子书: <a href=https://www.ansible.com/resources/ebooks>https://www.ansible.com/resources/ebooks</a></li> <li>白皮书: <a href=https://www.ansible.com/resources/whitepapers>https://www.ansible.com/resources/whitepapers</a></li> <li>用户案例: <a href=https://www.ansible.com/resources/case-studies>https://www.ansible.com/resources/case-studies</a></li> </ul> <h2 id=2安装ansible>2.安装Ansible<a class=headerlink href=#2安装ansible title="Permanent link">&para;</a></h2> <p>学会一个软件的第一件事，就是要在各种环境上安装这个软件，安装好，我们才能进入下一步，跟着我一起来安装 <code>ansible</code> 吧</p> <div class="admonition note"> <p class=admonition-title>对管理主机的要求</p> <p>目前,只要机器上安装了 Python 2（版本2.6或2.7）或Python 3（版本3.5及更高版本）都可以运行Ansible (windows系统不可以做管理主机) 管理主机的系统可以是 Red Hat, Debian, CentOS, macOS, BSD的各种版本.</p> </div> <div class="admonition note"> <p class=admonition-title>对节点主机的要求</p> <p>通常我们使用 ssh 与节点通信，默认使用 sftp. 如果 sftp 不可用，可在 ansible.cfg 配置文件中配置成 scp 的方式. 在节点上也需要安装Python 2（2.6或更高版本）或Python 3（3.5或更高版本）</p> <p>如果节点启用了<code>selinux</code>, 在使用<code>copy</code>/<code>file</code>/<code>template</code>时需要安装 <code>libselinux-python</code> 包。</p> <p>如果想通过ansible给节点主机安装python模块，可以使用<code>raw</code>模块，命令如: </p> <p><div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>ansible<span class=w> </span>myhost<span class=w> </span>--become<span class=w> </span>-m<span class=w> </span>raw<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;yum install -y python2&quot;</span>
</code></pre></div> <code>raw</code> 模块 可以原生执行shell命令</p> </div> <h3 id=在管理节点上安装ansible>在管理节点上安装ansible<a class=headerlink href=#在管理节点上安装ansible title="Permanent link">&para;</a></h3> <blockquote> <p>大家选择下面的一种方式进行安装 <code>ansible</code></p> </blockquote> <div class="tabbed-set tabbed-alternate" data-tabs=1:10><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><input id=__tabbed_1_3 name=__tabbed_1 type=radio><input id=__tabbed_1_4 name=__tabbed_1 type=radio><input id=__tabbed_1_5 name=__tabbed_1 type=radio><input id=__tabbed_1_6 name=__tabbed_1 type=radio><input id=__tabbed_1_7 name=__tabbed_1 type=radio><input id=__tabbed_1_8 name=__tabbed_1 type=radio><input id=__tabbed_1_9 name=__tabbed_1 type=radio><input id=__tabbed_1_10 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>CentOS/RHEL</label><label for=__tabbed_1_2>Ubuntu</label><label for=__tabbed_1_3>Debian</label><label for=__tabbed_1_4>FreeBSD</label><label for=__tabbed_1_5>dnf</label><label for=__tabbed_1_6>mac</label><label for=__tabbed_1_7>pip</label><label for=__tabbed_1_8>Python3</label><label for=__tabbed_1_9>源码</label><label for=__tabbed_1_10>离线安装</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>sed<span class=w> </span>-e<span class=w> </span><span class=s1>&#39;s!^#baseurl=!baseurl=!g&#39;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=w>       </span>-e<span class=w>  </span><span class=s1>&#39;s!^mirrorlist=!#mirrorlist=!g&#39;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>       </span>-e<span class=w> </span><span class=s1>&#39;s!mirror.centos.org!mirrors.aliyun.com!g&#39;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>       </span>-i<span class=w>  </span>/etc/yum.repos.d/CentOS-Base.repo
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>yum<span class=w> </span>install<span class=w> </span>-y<span class=w> </span>epel-release
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>sed<span class=w> </span>-e<span class=w> </span><span class=s1>&#39;s!^mirrorlist=!#mirrorlist=!g&#39;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=w>    </span>-e<span class=w> </span><span class=s1>&#39;s!^metalink=!#metalink=!g&#39;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=w>    </span>-e<span class=w> </span><span class=s1>&#39;s!^#baseurl=!baseurl=!g&#39;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=w>    </span>-e<span class=w> </span><span class=s1>&#39;s!//download\.fedoraproject\.org/pub!//mirrors.aliyun.com!g&#39;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=w>    </span>-e<span class=w> </span><span class=s1>&#39;s!http://mirrors\.aliyun!https://mirrors.aliyun!g&#39;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=w>    </span>-i<span class=w> </span>/etc/yum.repos.d/epel.repo<span class=w> </span>/etc/yum.repos.d/epel-testing.repo
<a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>
<a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>yum<span class=w> </span>install<span class=w> </span>-y<span class=w> </span>ansible
</code></pre></div> </div> <div class=tabbed-block> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>$<span class=w> </span>sudo<span class=w> </span>apt<span class=w> </span>update
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>$<span class=w> </span>sudo<span class=w> </span>apt<span class=w> </span>install<span class=w> </span>software-properties-common
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>$<span class=w> </span>sudo<span class=w> </span>apt-add-repository<span class=w> </span>--yes<span class=w> </span>--update<span class=w> </span>ppa:ansible/ansible
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>$<span class=w> </span>sudo<span class=w> </span>apt<span class=w> </span>install<span class=w> </span>ansible
</code></pre></div> </div> <div class=tabbed-block> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>deb<span class=w> </span>http://ppa.launchpad.net/ansible/ansible/ubuntu<span class=w> </span>trusty<span class=w> </span>main
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>$<span class=w> </span>sudo<span class=w> </span>apt-key<span class=w> </span>adv<span class=w> </span>--keyserver<span class=w> </span>keyserver.ubuntu.com<span class=w> </span>--recv-keys<span class=w> </span>93C4A3FD7BB9C367
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>$<span class=w> </span>sudo<span class=w> </span>apt<span class=w> </span>update
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>$<span class=w> </span>sudo<span class=w> </span>apt<span class=w> </span>install<span class=w> </span>ansible
</code></pre></div> </div> <div class=tabbed-block> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>$<span class=w> </span>sudo<span class=w> </span>pkg<span class=w> </span>install<span class=w> </span>py27-ansible
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=c1># or</span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>$<span class=w> </span>sudo<span class=w> </span>pkg<span class=w> </span>install<span class=w> </span>py36-ansible
</code></pre></div> </div> <div class=tabbed-block> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>$<span class=w> </span>sudo<span class=w> </span>dnf<span class=w> </span>install<span class=w> </span>ansible
</code></pre></div> </div> <div class=tabbed-block> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>curl<span class=w> </span>https://bootstrap.pypa.io/get-pip.py<span class=w> </span>-o<span class=w> </span>get-pip.py
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>python<span class=w> </span>get-pip.py
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>sudo<span class=w> </span><span class=nv>CFLAGS</span><span class=o>=</span>-Qunused-arguments<span class=w> </span><span class=nv>CPPFLAGS</span><span class=o>=</span>-Qunused-arguments<span class=w> </span>pip<span class=w> </span>install<span class=w> </span>ansible<span class=w> </span>-i<span class=w> </span>https://mirrors.ustc.edu.cn/pypi/web/simple
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=c1># 通过此方式安装的没有生成/etc/ansible文件，可以手动生成，配置文件示例到https://github.com/ansible/ansible/tree/devel/examples</span>
</code></pre></div> </div> <div class=tabbed-block> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>curl<span class=w> </span>https://bootstrap.pypa.io/get-pip.py<span class=w> </span>-o<span class=w> </span>get-pip.py
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>python<span class=w> </span>get-pip.py
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>pip<span class=w> </span>install<span class=w> </span>ansible<span class=w> </span>-i<span class=w> </span>https://mirrors.ustc.edu.cn/pypi/web/simple
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=c1># 通过此方式安装的没有生成/etc/ansible文件，可以手动生成，配置文件示例到https://github.com/ansible/ansible/tree/devel/examples</span>
</code></pre></div> </div> <div class=tabbed-block> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>yum<span class=w> </span>install<span class=w> </span>-y<span class=w> </span>python36<span class=w> </span>python36-tools
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>curl<span class=w> </span>https://bootstrap.pypa.io/get-pip.py<span class=w> </span>-o<span class=w> </span>get-pip.py
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>python3.6<span class=w> </span>get-pip.py<span class=w> </span>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>pip3.6<span class=w> </span>install<span class=w> </span>ansible<span class=w> </span>-i<span class=w> </span>https://mirrors.ustc.edu.cn/pypi/web/simple
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=c1># 通过此方式安装的没有生成/etc/ansible文件，可以手动生成，配置文件示例到https://github.com/ansible/ansible/tree/devel/examples</span>
</code></pre></div> </div> <div class=tabbed-block> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>yum<span class=w> </span>install<span class=w> </span>-y<span class=w>  </span>python-setuptools
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>easy_install<span class=w> </span>pip
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>wget<span class=w> </span>https://github.com/ansible/ansible/archive/v2.9.6.tar.gz
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>tar<span class=w> </span>zxf<span class=w> </span>v2.9.6.tar.gz
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=nb>cd</span><span class=w> </span>./ansible-2.9.6
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>pip<span class=w> </span>install<span class=w> </span>-r<span class=w> </span>./requirements.txt
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>python<span class=w> </span>setup.py<span class=w> </span>install
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>mkdir<span class=w> </span>/etc/ansible/
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>cp<span class=w> </span>examples/<span class=o>{</span>ansible.cfg,hosts<span class=o>}</span><span class=w> </span>/etc/ansible/
</code></pre></div> </div> <div class=tabbed-block> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=c1># 以目标主机centos7为测试</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=c1># 1. 下载ansible及依赖系统包</span>
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>curl<span class=w> </span>-sSL<span class=w> </span>https://cdn.jsdelivr.net/gh/lework/script/shell/get_packages.sh<span class=w> </span><span class=p>|</span><span class=w> </span>bash<span class=w> </span>-s<span class=w> </span>-<span class=w> </span>centos7<span class=w> </span>ansible
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=c1># 2. 下载好的离线包在当前目录的package_centos7_ansible</span>
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>ls<span class=w> </span>package_centos7_ansible
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=c1># 3. 将目录拷贝到目标主机,在当前目录安装</span>
<a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a>yum<span class=w> </span>localinstall<span class=w> </span>*.rpm
</code></pre></div> </div> </div> </div> <h3 id=bash命令行自动补全>bash命令行自动补全<a class=headerlink href=#bash命令行自动补全 title="Permanent link">&para;</a></h3> <blockquote> <p>在Ansible 2.9之后，就支持了命令行参数补齐功能</p> </blockquote> <div class="tabbed-set tabbed-alternate" data-tabs=2:3><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><input id=__tabbed_2_2 name=__tabbed_2 type=radio><input id=__tabbed_2_3 name=__tabbed_2 type=radio><div class=tabbed-labels><label for=__tabbed_2_1>CentOS/RHEL</label><label for=__tabbed_2_2>apt</label><label for=__tabbed_2_3>pip</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a>yum<span class=w> </span>install<span class=w> </span>epel-release
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>yum<span class=w> </span>install<span class=w> </span>python-argcomplete
</code></pre></div> </div> <div class=tabbed-block> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>$<span class=w> </span>sudo<span class=w> </span>apt<span class=w> </span>install<span class=w> </span>python-argcomplete
</code></pre></div> </div> <div class=tabbed-block> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>pip<span class=w> </span>install<span class=w> </span>argcomplete
</code></pre></div> </div> </div> </div> <p><strong>将补全加入环境变量</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a>activate-global-python-argcomplete
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=nb>source</span><span class=w> </span>/etc/profile
</code></pre></div> <p>在bash 小于4.2 时，使用下列命令注册</p> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a>$<span class=w> </span><span class=nb>eval</span><span class=w> </span><span class=k>$(</span>register-python-argcomplete<span class=w> </span>ansible<span class=k>)</span>
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>$<span class=w> </span><span class=nb>eval</span><span class=w> </span><span class=k>$(</span>register-python-argcomplete<span class=w> </span>ansible-config<span class=k>)</span>
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>$<span class=w> </span><span class=nb>eval</span><span class=w> </span><span class=k>$(</span>register-python-argcomplete<span class=w> </span>ansible-console<span class=k>)</span>
<a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>$<span class=w> </span><span class=nb>eval</span><span class=w> </span><span class=k>$(</span>register-python-argcomplete<span class=w> </span>ansible-doc<span class=k>)</span>
<a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a>$<span class=w> </span><span class=nb>eval</span><span class=w> </span><span class=k>$(</span>register-python-argcomplete<span class=w> </span>ansible-galaxy<span class=k>)</span>
<a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a>$<span class=w> </span><span class=nb>eval</span><span class=w> </span><span class=k>$(</span>register-python-argcomplete<span class=w> </span>ansible-inventory<span class=k>)</span>
<a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a>$<span class=w> </span><span class=nb>eval</span><span class=w> </span><span class=k>$(</span>register-python-argcomplete<span class=w> </span>ansible-playbook<span class=k>)</span>
<a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a>$<span class=w> </span><span class=nb>eval</span><span class=w> </span><span class=k>$(</span>register-python-argcomplete<span class=w> </span>ansible-pull<span class=k>)</span>
<a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a>$<span class=w> </span><span class=nb>eval</span><span class=w> </span><span class=k>$(</span>register-python-argcomplete<span class=w> </span>ansible-vault<span class=k>)</span>
<a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=nb>source</span><span class=w> </span>/etc/profile
</code></pre></div> <h2 id=3快速开始>3.快速开始<a class=headerlink href=#3快速开始 title="Permanent link">&para;</a></h2> <p>跟着我，一步一步的开始 ansible 神奇之旅吧！</p> <h3 id=环境信息>环境信息<a class=headerlink href=#环境信息 title="Permanent link">&para;</a></h3> <p>control os: <code>centos 7.7</code></p> <p>ansible version: <code>2.9.6</code></p> <h3 id=任务>任务<a class=headerlink href=#任务 title="Permanent link">&para;</a></h3> <p>我们将要在目标主机上安装部署<code>nginx</code>服务</p> <h3 id=步骤>步骤<a class=headerlink href=#步骤 title="Permanent link">&para;</a></h3> <h4 id=0-安装ansible>0. 安装ansible<a class=headerlink href=#0-安装ansible title="Permanent link">&para;</a></h4> <blockquote> <p>本次使用的是 <code>Centos 7.7 x64</code> 系统</p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a>yum<span class=w> </span>install<span class=w> </span>-y<span class=w> </span>epel-release
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a>
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>sed<span class=w> </span>-e<span class=w> </span><span class=s1>&#39;s!^metalink=!#metalink=!g&#39;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=w>    </span>-e<span class=w> </span><span class=s1>&#39;s!^#baseurl=!baseurl=!g&#39;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=w>    </span>-e<span class=w> </span><span class=s1>&#39;s!http://download\.fedoraproject\.org/pub/epel!https://mirrors.tuna.tsinghua.edu.cn/epel!g&#39;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=w>    </span>-e<span class=w> </span><span class=s1>&#39;s!http://download\.example/pub/epel!https://mirrors.tuna.tsinghua.edu.cn/epel!g&#39;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=w>    </span>-i<span class=w> </span>/etc/yum.repos.d/epel*.repo
<a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a>
<a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a>yum<span class=w> </span>install<span class=w> </span>-y<span class=w> </span>ansible
<a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a>yum<span class=w> </span>update<span class=w> </span>python-jinja2
</code></pre></div> <h4 id=1-定义主机清单>1. 定义主机清单<a class=headerlink href=#1-定义主机清单 title="Permanent link">&para;</a></h4> <blockquote> <p>定义一个简单的通过ssh认证的主机清单，更多配置见</p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a>cat /etc/ansible/hosts
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>192.168.77.131 ansible_ssh_user=root ansible_ssh_pass=xxxx
</code></pre></div> <p>主机清单中的配置含义</p> <ul> <li><code>192.168.77.131</code> 定义远程主机ip地址</li> <li><code>ansible_ssh_user</code> 连接远程主机的用户</li> <li><code>ansible_ssh_pass</code> 连接远程主机的用户密码</li> </ul> <h4 id=2-执行ansible命令>2. 执行ansible命令<a class=headerlink href=#2-执行ansible命令 title="Permanent link">&para;</a></h4> <p><strong>测试连接状态</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a>ansible<span class=w> </span><span class=m>192</span>.168.77.131<span class=w> </span>-m<span class=w> </span>ping
</code></pre></div> <p>命令中的含义 - <code>192.168.77.131</code> 用于匹配主机清单中的主机名称 - <code>-m ping</code> 指定 <code>ping</code> 模块，用于测试与远程主机的连接状态</p> <p><strong>安装Nginx</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=c1># 安装</span>
<a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a>ansible<span class=w> </span><span class=m>192</span>.168.77.131<span class=w> </span>-m<span class=w> </span>yum<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;name=nginx&#39;</span>
<a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=c1>#卸载</span>
<a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a>ansible<span class=w> </span><span class=m>192</span>.168.77.131<span class=w> </span>-m<span class=w> </span>yum<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;name=nginx state=absent&#39;</span>
</code></pre></div> <p>命令中的含义 - <code>192.168.77.131</code> 用于匹配主机清单中的主机名称 - <code>-m yum</code> 指定 <code>yum</code> 模块，用于安装软件 - <code>-a 'name=nginx'</code> 指定模块的参数，<code>name</code>是软件的名称，默认操作是安装。</p> <p><strong>启动Nginx</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=c1># 启动</span>
<a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a>ansible<span class=w> </span><span class=m>192</span>.168.77.131<span class=w> </span>-m<span class=w> </span>systemd<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;name=nginx state=started enabled=yes&#39;</span>
<a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a>
<a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a>
<a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=c1># 关闭</span>
<a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a>ansible<span class=w> </span><span class=m>192</span>.168.1.131<span class=w> </span>-m<span class=w> </span>systemd<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;name=nginx state=stopped enabled=yes&#39;</span>
</code></pre></div> <p>命令中的含义 - <code>192.168.77.131</code> 用于匹配主机清单中的主机名称 - <code>-m systemd</code> 指定 <code>systemd</code> 模块，用于管理系统服务 - <code>-a 'name=nginx state=started enabled=yes'</code> 指定模块的参数，<code>name</code>是软件的名称，<code>state</code> 指定管理状态，<code>enabled</code> 是否开启自启动。</p> <h4 id=3-验证>3. 验证<a class=headerlink href=#3-验证 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a>curl<span class=w> </span>http://192.168.77.131:80
</code></pre></div> <h4 id=4-执行ansible-playbook>4. 执行ansible playbook<a class=headerlink href=#4-执行ansible-playbook title="Permanent link">&para;</a></h4> <p><strong>定义 playbook</strong></p> <blockquote> <p>也就是任务编排，将上面3个步骤合并在一起。</p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=c1># File: install_nginx.yml</span>
<a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a>
<a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a>---
<a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a>-<span class=w> </span>hosts:<span class=w> </span><span class=m>192</span>.168.77.135
<a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=w>  </span>tasks:
<a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=w>    </span>-<span class=w> </span>name:<span class=w> </span>安装<span class=w> </span>nginx.
<a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a><span class=w>      </span>yum:<span class=w> </span><span class=nv>name</span><span class=o>=</span>nginx
<a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a><span class=w>    </span>-<span class=w> </span>name:<span class=w> </span>启动<span class=w> </span>nginx.
<a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a><span class=w>      </span>systemd:<span class=w> </span><span class=nv>name</span><span class=o>=</span>nginx<span class=w> </span><span class=nv>state</span><span class=o>=</span>started<span class=w> </span><span class=nv>enabled</span><span class=o>=</span>yes
<a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a><span class=w>    </span>-<span class=w> </span>name:<span class=w> </span>检查<span class=w> </span>nginx.
<a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a><span class=w>      </span>uri:<span class=w> </span><span class=nv>url</span><span class=o>=</span>http://127.0.0.1
<a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a><span class=w>      </span>register:<span class=w> </span>curl_result
<a id=__codelineno-22-13 name=__codelineno-22-13 href=#__codelineno-22-13></a><span class=w>      </span><span class=k>until</span>:<span class=w> </span>curl_result.status<span class=w> </span><span class=o>==</span><span class=w> </span><span class=m>200</span>
<a id=__codelineno-22-14 name=__codelineno-22-14 href=#__codelineno-22-14></a><span class=w>      </span>retries:<span class=w> </span><span class=m>5</span>
<a id=__codelineno-22-15 name=__codelineno-22-15 href=#__codelineno-22-15></a><span class=w>      </span>delay:<span class=w> </span><span class=m>3</span>
<a id=__codelineno-22-16 name=__codelineno-22-16 href=#__codelineno-22-16></a><span class=w>      </span>changed_when:<span class=w> </span><span class=nb>false</span>
<a id=__codelineno-22-17 name=__codelineno-22-17 href=#__codelineno-22-17></a><span class=w>      </span>check_mode:<span class=w> </span>no
</code></pre></div> <p><strong>执行 playbook</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a>ansible-playbook<span class=w> </span>install_nginx.yml
</code></pre></div> <p>卸载nginx： <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=c1># File: remove_nginx.yml</span>
<a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a>---
<a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a>-<span class=w> </span>hosts:<span class=w> </span><span class=m>192</span>.168.77.135
<a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a>
<a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=w>  </span>tasks:
<a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=w>    </span>-<span class=w> </span>name:<span class=w> </span>stop<span class=w> </span>nginx
<a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=w>      </span>service:<span class=w> </span><span class=nv>name</span><span class=o>=</span>nginx<span class=w> </span><span class=nv>state</span><span class=o>=</span>stopped<span class=w> </span><span class=nv>enabled</span><span class=o>=</span>no
<a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=w>    </span>-<span class=w> </span>name:<span class=w> </span>remove<span class=w> </span>nginx
<a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=w>      </span>yum:<span class=w> </span><span class=nv>name</span><span class=o>=</span>nginx<span class=w> </span><span class=nv>state</span><span class=o>=</span>absent
<a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=w>    </span>-<span class=w> </span>name:<span class=w> </span>remove<span class=w> </span>user<span class=w> </span>nginx
<a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=w>      </span>user:<span class=w> </span><span class=nv>name</span><span class=o>=</span>nginx<span class=w> </span><span class=nv>state</span><span class=o>=</span>absent
<a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=w>    </span>-<span class=w> </span>name:<span class=w> </span>remove<span class=w> </span>group<span class=w> </span>nginx
<a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=w>      </span>group:<span class=w> </span><span class=nv>name</span><span class=o>=</span>nginx<span class=w> </span><span class=nv>state</span><span class=o>=</span>absent
<a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=w>    </span>-<span class=w> </span>name:<span class=w> </span>web<span class=w> </span>page
<a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=w>      </span>file:<span class=w> </span>
<a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=w>        </span>path:<span class=w> </span>/usr/share/nginx/html/index.html<span class=w> </span>
<a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a><span class=w>        </span>state:<span class=w> </span>absent
</code></pre></div></p> <p>恭喜你，你已经学会怎么使用ansible了。下面的课程会使你更加深入的了解 ansible 。</p> <h2 id=4认识主机清单>4.认识主机清单<a class=headerlink href=#4认识主机清单 title="Permanent link">&para;</a></h2> <p>Ansible 可同时操作属于一个组的多台主机, 组和主机之间的关系通过 <code>inventory</code> 文件配置. 默认的文件路径为 <code>/etc/ansible/hosts</code>, 执行命令的时候使用 <code>-i</code> 参数即可指定主机清单。</p> <h3 id=主机清单示例>主机清单示例<a class=headerlink href=#主机清单示例 title="Permanent link">&para;</a></h3> <p>主机清单文件主要有 <code>ini</code> 和 <code>yaml</code> 格式两种语法格式</p> <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=na>mail.example.com       # 定义主机fqdn地址, 且已经与控制节点ssh互信</span>
<a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a>
<a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=na>[webservers]  # 方括号[]中是组名</span>
<a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=na>host1  # 定义主机名称, 且已经与控制节点ssh互信</span>
<a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=na>host2</span><span class=o>:</span><span class=s>5522</span><span class=w>  </span><span class=c1># 指定连接主机和端口号</span>
<a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=na>localhost ansible_connection</span><span class=o>=</span><span class=s>local</span><span class=w>  </span><span class=c1># ansible_connection可以定义连接类型, local是在本地执行</span>
<a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class=na>host3 http_port</span><span class=o>=</span><span class=s>80 maxRequestsPerChild=808</span><span class=w>  </span><span class=c1># 定义主机变量, 除了ansible定义的特殊名称外，其他的都是主机变量</span>
<a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=na>host4 ansible_host</span><span class=o>=</span><span class=s>192.168.1.50 ansible_port=2222 ansible_user=root ansible_password=12345</span><span class=w> </span><span class=c1># 指定别名，定义主机ssh连接信息</span>
<a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=na>www[1</span><span class=o>:</span><span class=s>50].example.com</span><span class=w> </span><span class=c1># 定义 1-50范围内的主机</span>
<a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=na>www-[a</span><span class=o>:</span><span class=s>f].example.com</span><span class=w> </span><span class=c1># 定义 a-f 范围内内的主机</span>
<a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a>
<a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a><span class=k>[dbservers]</span>
<a id=__codelineno-25-13 name=__codelineno-25-13 href=#__codelineno-25-13></a><span class=na>three.example.com  ansible_python_interpreter</span><span class=o>=</span><span class=s>/usr/local/bin/python3</span><span class=w>  </span><span class=c1># 定义python执行ansible，这个是指定被控节点的。</span>
<a id=__codelineno-25-14 name=__codelineno-25-14 href=#__codelineno-25-14></a><span class=na>192.168.77.123  ansible_ruby_interpreter</span><span class=o>=</span><span class=s>/usr/bin/ruby.1.9.3</span><span class=w>  </span><span class=c1># 定义ruby执行文件</span>
<a id=__codelineno-25-15 name=__codelineno-25-15 href=#__codelineno-25-15></a>
<a id=__codelineno-25-16 name=__codelineno-25-16 href=#__codelineno-25-16></a>
<a id=__codelineno-25-17 name=__codelineno-25-17 href=#__codelineno-25-17></a><span class=na>[webservers</span><span class=o>:</span><span class=s>vars]</span><span class=w> </span><span class=c1># 定义webservers组的变量</span>
<a id=__codelineno-25-18 name=__codelineno-25-18 href=#__codelineno-25-18></a><span class=na>ntp_server</span><span class=o>=</span><span class=s>ntp.example.com</span>
<a id=__codelineno-25-19 name=__codelineno-25-19 href=#__codelineno-25-19></a><span class=na>proxy</span><span class=o>=</span><span class=s>proxy.example.com</span>
<a id=__codelineno-25-20 name=__codelineno-25-20 href=#__codelineno-25-20></a>
<a id=__codelineno-25-21 name=__codelineno-25-21 href=#__codelineno-25-21></a><span class=na>[server</span><span class=o>:</span><span class=s>children]</span><span class=w> </span><span class=c1># 定义server组的子成员</span>
<a id=__codelineno-25-22 name=__codelineno-25-22 href=#__codelineno-25-22></a><span class=na>webservers</span>
<a id=__codelineno-25-23 name=__codelineno-25-23 href=#__codelineno-25-23></a><span class=na>dbservers</span>
<a id=__codelineno-25-24 name=__codelineno-25-24 href=#__codelineno-25-24></a>
<a id=__codelineno-25-25 name=__codelineno-25-25 href=#__codelineno-25-25></a><span class=na>[server</span><span class=o>:</span><span class=s>vars]</span><span class=w> </span><span class=c1># 定义server组的变量</span>
<a id=__codelineno-25-26 name=__codelineno-25-26 href=#__codelineno-25-26></a><span class=na>zabbix_server</span><span class=o>:</span><span class=s>192.168.77.121</span>
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>注意！组名称中不要带<code>-</code></p> </div> <p>上列配置的一些解释：</p> <ul> <li>主机可以在多个组中配置。</li> <li><code>ansible_connection</code> 是执行主机的连接类型，默认是smart</li> <li><code>ansible_host</code> 主机ssh连接地址</li> <li><code>ansible_port</code> 主机ssh连接端口</li> <li><code>ansible_user</code> 主机ssh连接用户</li> <li><code>ansible_password</code> 主机ssh连接用户密码</li> <li><code>ansible_python_interpreter</code> 指定python的执行路径</li> <li><code>[webservers:vars]</code> 定义webservers组的变量</li> <li><code>[server:children]</code> 定义server组的子成员</li> </ul> <p>也可使使用yaml格式来表示</p> <div class=highlight><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=nt>all</span><span class=p>:</span>
<a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=w>  </span><span class=nt>children</span><span class=p>:</span>
<a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=w>    </span><span class=nt>usa</span><span class=p>:</span>
<a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=w>      </span><span class=nt>children</span><span class=p>:</span>
<a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=w>        </span><span class=nt>southeast</span><span class=p>:</span>
<a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=w>          </span><span class=nt>children</span><span class=p>:</span>
<a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=w>            </span><span class=nt>atlanta</span><span class=p>:</span>
<a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=w>              </span><span class=nt>hosts</span><span class=p>:</span>
<a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=w>                </span><span class=nt>host1</span><span class=p>:</span>
<a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a><span class=w>                </span><span class=nt>host2</span><span class=p>:</span>
<a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=w>            </span><span class=nt>raleigh</span><span class=p>:</span>
<a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a><span class=w>              </span><span class=nt>hosts</span><span class=p>:</span>
<a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a><span class=w>                </span><span class=nt>host2</span><span class=p>:</span>
<a id=__codelineno-26-14 name=__codelineno-26-14 href=#__codelineno-26-14></a><span class=w>                </span><span class=nt>host3</span><span class=p>:</span>
<a id=__codelineno-26-15 name=__codelineno-26-15 href=#__codelineno-26-15></a><span class=w>          </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-26-16 name=__codelineno-26-16 href=#__codelineno-26-16></a><span class=w>            </span><span class=nt>some_server</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo.southeast.example.com</span>
<a id=__codelineno-26-17 name=__codelineno-26-17 href=#__codelineno-26-17></a><span class=w>            </span><span class=nt>halon_system_timeout</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<a id=__codelineno-26-18 name=__codelineno-26-18 href=#__codelineno-26-18></a><span class=w>            </span><span class=nt>self_destruct_countdown</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<a id=__codelineno-26-19 name=__codelineno-26-19 href=#__codelineno-26-19></a><span class=w>            </span><span class=nt>escape_pods</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a id=__codelineno-26-20 name=__codelineno-26-20 href=#__codelineno-26-20></a><span class=w>        </span><span class=nt>northeast</span><span class=p>:</span>
<a id=__codelineno-26-21 name=__codelineno-26-21 href=#__codelineno-26-21></a><span class=w>        </span><span class=nt>northwest</span><span class=p>:</span>
<a id=__codelineno-26-22 name=__codelineno-26-22 href=#__codelineno-26-22></a><span class=w>        </span><span class=nt>southwest</span><span class=p>:</span>
</code></pre></div> <blockquote> <p>yaml格式配置的还是挺复杂的，可读性也差，建议使用<code>ini</code>方式来设置主机清单。 </p> </blockquote> <h3 id=默认组>默认组<a class=headerlink href=#默认组 title="Permanent link">&para;</a></h3> <p>在主机清单中，ansible会自动的生成两个组。</p> <ul> <li><code>all</code> 所有的主机。</li> <li><code>ungrouped</code> 包含没有组的主机。</li> </ul> <p>尽管这两个组是永远存在的，但也有可能是隐藏的，不会出现group_names之类的组列表中。</p> <h3 id=主机变量和组变量>主机变量和组变量<a class=headerlink href=#主机变量和组变量 title="Permanent link">&para;</a></h3> <p>如果你不想在主机清单中定义主机的变量或者组的变量，ansible还支持在特定的目录中定义变量。</p> <p>变量文件必须以yaml语法定义。</p> <p>如默认在<code>/etc/ansible/host_vars/</code> 目录中定义主机变量，文件名称以主机名称命名，结束可以用'.yml', '.yaml', '.json'三种格式。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a>cat<span class=w> </span>/etc/ansible/host_vars/host1
<a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a>---
<a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a>ntp_server:<span class=w> </span>acme.example.org
<a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a>database_server:<span class=w> </span>storage.example.org
</code></pre></div> <p>如默认在<code>/etc/ansible/group_vars/</code> 目录中定义组变量，文件名称以组名称命名，结束可以用'.yml', '.yaml', '.json'三种格式。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a>cat<span class=w> </span>/etc/ansible/group_vars/webservers
<a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a>---
<a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a>ntp_server:<span class=w> </span>acme.example.org
<a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a>database_server:<span class=w> </span>storage.example.org
</code></pre></div> <h3 id=变量合并>变量合并<a class=headerlink href=#变量合并 title="Permanent link">&para;</a></h3> <p>我们可以通过多种方式给主机定义变量，如果在各个环节都设置了变量，到底哪个变量生效呢？这就要看ansible的变量优先级，优先级高的会覆盖优先级低的变量。</p> <p>优先顺序，all最低，host最高</p> <ul> <li>all group</li> <li>parent group</li> <li>child group</li> <li>host</li> </ul> <p>相同组时，默认情况下，按字母顺序后面组的定义会覆盖前面的。也可以使用ansible_group_priority调整优先级，数值越大优先级越高，默认为1，相同优先级时，后者优先。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=k>[a_group:vars]</span>
<a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=na>testvar</span><span class=o>=</span><span class=s>a</span>
<a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=na>ansible_group_priority</span><span class=o>=</span><span class=s>10</span>
<a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=k>[b_group]</span>
<a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=na>testvar</span><span class=o>=</span><span class=s>b</span>
</code></pre></div> <h3 id=使用多个主机清单>使用多个主机清单<a class=headerlink href=#使用多个主机清单 title="Permanent link">&para;</a></h3> <p>在命令参数中，使用多个 <code>-i</code> 就可以指定多个主机清单 </p> <div class=highlight><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a>ansible<span class=w> </span>all<span class=w> </span>-i<span class=w> </span>staging<span class=w> </span>-i<span class=w> </span>production<span class=w> </span>-m<span class=w> </span>ping
<a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a>ansible<span class=w> </span>all<span class=w> </span>-i<span class=w> </span>/tmp/staging<span class=w> </span>-i<span class=w> </span>/tmp/production<span class=w> </span>-m<span class=w> </span>ping
</code></pre></div> <p>也可以指定一个目录</p> <div class=highlight><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a>inventory/
<a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a>  01-openstack.yml          # configure inventory plugin to get hosts from Openstack cloud
<a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a>  02-dynamic-inventory.py   # add additional hosts with dynamic inventory script
<a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a>  03-static-inventory       # add static hosts
<a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a>  group_vars/
<a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a>    all.yml                 # assign variables to all hosts
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a>ansible<span class=w> </span>all<span class=w> </span>-i<span class=w> </span>inventory<span class=w> </span>-m<span class=w> </span>ping
</code></pre></div> <h3 id=主机内置变量列表>主机内置变量列表<a class=headerlink href=#主机内置变量列表 title="Permanent link">&para;</a></h3> <p><strong>用于主机连接</strong></p> <table> <thead> <tr> <th>参数</th> <th>描述</th> </tr> </thead> <tbody> <tr> <td>ansible_connection</td> <td>与主机的连接类型.比如:local, ssh 或者 paramiko. Ansible 1.2 以前默认使用 paramiko.1.2 以后默认使用 'smart','smart' 方式会根据是否支持 ControlPersist, 来判断'ssh' 方式是否可行.</td> </tr> </tbody> </table> <p><strong>用于所有连接</strong></p> <table> <thead> <tr> <th>参数</th> <th>描述</th> </tr> </thead> <tbody> <tr> <td>ansible_host</td> <td>将要连接的远程主机名.与你想要设定的主机的别名不同的话,可通过此变量设置.</td> </tr> <tr> <td>ansible_port</td> <td>连接端口号，如果是ssh的话，默认是22</td> </tr> <tr> <td>ansible_user</td> <td>用于连接认证的用户名</td> </tr> <tr> <td>ansible_password</td> <td>用于连接认证的用户名密码</td> </tr> </tbody> </table> <p><strong>ssh连接参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>描述</th> </tr> </thead> <tbody> <tr> <td>ansible_ssh_private_key_file</td> <td>ssh 使用的私钥文件.适用于有多个密钥,而你不想使用 SSH 代理的情况.</td> </tr> <tr> <td>ansible_ssh_common_args</td> <td>此设置附加到sftp，scp和ssh的缺省命令行</td> </tr> <tr> <td>ansible_sftp_extra_args</td> <td>此设置附加到默认sftp命令行。</td> </tr> <tr> <td>ansible_scp_extra_args</td> <td>此设置附加到默认scp命令行。</td> </tr> <tr> <td>ansible_ssh_extra_args</td> <td>此设置附加到默认ssh命令行。</td> </tr> <tr> <td>ansible_ssh_pipelining</td> <td>确定是否使用SSH管道。这可以覆盖ansible.cfg中得设置。</td> </tr> <tr> <td>ansible_ssh_executable</td> <td>ssh可执行文件</td> </tr> </tbody> </table> <p><strong>权限提升参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>描述</th> </tr> </thead> <tbody> <tr> <td>ansible_become</td> <td>开启提权，等同于<code>ansible_sudo</code>，<code>ansible_su</code></td> </tr> <tr> <td>ansible_become_method</td> <td>提权方式</td> </tr> <tr> <td>ansible_become_user</td> <td>提权用户，等同于<code>ansible_sudo_user</code>，<code>ansible_su_user</code></td> </tr> <tr> <td>ansible_become_password</td> <td>提权密码,等同于<code>ansible_sudo_password</code>，<code>ansible_su_password</code></td> </tr> <tr> <td>ansible_become_exe</td> <td>提权所用的可执行文件，等同于<code>ansible_sudo_exe</code>,<code>ansible_su_exe</code></td> </tr> <tr> <td>ansible_become_flags</td> <td>提权命令的参数，等同于<code>ansible_sudo_flags</code>,<code>ansible_su_flags</code></td> </tr> </tbody> </table> <p><strong>远程主机环境参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>描述</th> </tr> </thead> <tbody> <tr> <td>ansible_shell_type</td> <td>目标系统的shell类型.默认情况下,命令的执行使用 'sh' 语法,可设置为 'csh' 或 'fish'.</td> </tr> <tr> <td>ansible_python_interpreter</td> <td>目标主机的 python 路径.适用于的情况: 系统中有多个 Python, 或者命令路径不是"/usr/bin/python",比如 *BSD, 或者 /usr/bin/python</td> </tr> <tr> <td>ansible_*_interpreter</td> <td>这里的"*"可以是 ruby 或 perl 或其他语言的解释器，作用和ansible_python_interpreter 类似</td> </tr> <tr> <td>ansible_shell_executable</td> <td>这将设置ansible控制器将在目标机器上使用的shell，覆盖ansible.cfg中的配置，默认为/bin/sh。</td> </tr> </tbody> </table> <p><strong>非SSH连接类型参数</strong></p> <p>ansible默认是使用 <code>ssh</code> 连接主机，但也不限制于这种方式，可以通过使用主机特定参数 <code>ansible_connection = &lt;connector&gt;</code>，来更改连接类型。以下是支持的连接类型。</p> <table> <thead> <tr> <th>参数</th> <th>描述</th> </tr> </thead> <tbody> <tr> <td>local</td> <td>在控制端本地执行</td> </tr> <tr> <td>docker</td> <td>使用本地Docker客户端</td> </tr> <tr> <td>ansible_host</td> <td>容器连接的主机</td> </tr> <tr> <td>ansible_port</td> <td>容器连接的端口</td> </tr> <tr> <td>ansible_become</td> <td>如果设置为true，则会使用begin_user在容器内进行操作。</td> </tr> <tr> <td>ansible_docker_extra_args</td> <td>Docker 的额外参数</td> </tr> </tbody> </table> <p>一个创建容器的小例子</p> <div class=highlight><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">create jenkins container</span>
<a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=w>  </span><span class=nt>docker_container</span><span class=p>:</span>
<a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a><span class=w>    </span><span class=nt>docker_host</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myserver.net:4243</span>
<a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my_jenkins</span>
<a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a>
<a id=__codelineno-33-7 name=__codelineno-33-7 href=#__codelineno-33-7></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">add container to inventory</span>
<a id=__codelineno-33-8 name=__codelineno-33-8 href=#__codelineno-33-8></a><span class=w>  </span><span class=nt>add_host</span><span class=p>:</span>
<a id=__codelineno-33-9 name=__codelineno-33-9 href=#__codelineno-33-9></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my_jenkins</span>
<a id=__codelineno-33-10 name=__codelineno-33-10 href=#__codelineno-33-10></a><span class=w>    </span><span class=nt>ansible_connection</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker</span>
<a id=__codelineno-33-11 name=__codelineno-33-11 href=#__codelineno-33-11></a><span class=w>    </span><span class=nt>ansible_docker_extra_args</span><span class=p>:</span><span class=w> </span><span class=s>&quot;--tlsverify</span><span class=nv> </span><span class=s>--tlscacert=/path/to/ca.pem</span><span class=nv> </span><span class=s>--tlscert=/path/to/client-cert.pem</span><span class=nv> </span><span class=s>--tlskey=/path/to/client-key.pem</span><span class=nv> </span><span class=s>-H=tcp://myserver.net:4243&quot;</span>
<a id=__codelineno-33-12 name=__codelineno-33-12 href=#__codelineno-33-12></a><span class=w>    </span><span class=nt>ansible_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<a id=__codelineno-33-13 name=__codelineno-33-13 href=#__codelineno-33-13></a><span class=w>  </span><span class=nt>changed_when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id=__codelineno-33-14 name=__codelineno-33-14 href=#__codelineno-33-14></a>
<a id=__codelineno-33-15 name=__codelineno-33-15 href=#__codelineno-33-15></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">create directory for ssh keys</span>
<a id=__codelineno-33-16 name=__codelineno-33-16 href=#__codelineno-33-16></a><span class=w>  </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my_jenkins</span>
<a id=__codelineno-33-17 name=__codelineno-33-17 href=#__codelineno-33-17></a><span class=w>  </span><span class=nt>file</span><span class=p>:</span>
<a id=__codelineno-33-18 name=__codelineno-33-18 href=#__codelineno-33-18></a><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s>&quot;/var/jenkins_home/.ssh/jupiter&quot;</span>
<a id=__codelineno-33-19 name=__codelineno-33-19 href=#__codelineno-33-19></a><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">directory</span>
</code></pre></div> <h3 id=在运行的时候增加主机>在运行的时候增加主机<a class=headerlink href=#在运行的时候增加主机 title="Permanent link">&para;</a></h3> <p>使用 <code>add_host</code> 模块动态添加运行主机，此类主机只有在运行时才会向内存中添加，运行结束后，也不会添加到静态主机清单文件中。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">add new node into runtime inventory</span>
<a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=w>  </span><span class=nt>add_host</span><span class=p>:</span>
<a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=w>    </span><span class=nt>hostname</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webserver</span>
<a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=w>    </span><span class=nt>groups</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=nt>​    ansible_host</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">192.168.77.129</span>
<a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">ansible_port</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">22</span>
</code></pre></div> <h3 id=限定主机清单的运行主机>限定主机清单的运行主机<a class=headerlink href=#限定主机清单的运行主机 title="Permanent link">&para;</a></h3> <p>使用<code>--limit hostname</code>可以在运行任务的时候，只允许在此主机上运行。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class="p p-Indicator">[</span><span class=nv>root@master ansible</span><span class="p p-Indicator">]</span><span class=c1># ansible-playbook test.yml --list-hosts</span>
<a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=w> </span><span class=nt>playbook</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test.yml</span>
<a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">play</span><span class=w> </span><span class=c1>#1 (test2): test2        TAGS: []</span>
<a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=w>    </span><span class=nt>pattern</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>u&#39;test2&#39;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=w>    </span><span class=nt>hosts (3)</span><span class=p>:</span>
<a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=w>      </span><span class="l l-Scalar l-Scalar-Plain">node1</span>
<a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=w>      </span><span class="l l-Scalar l-Scalar-Plain">node3</span>
<a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a><span class=w>      </span><span class="l l-Scalar l-Scalar-Plain">node2</span>
<a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a><span class="p p-Indicator">[</span><span class=nv>root@master ansible</span><span class="p p-Indicator">]</span><span class=c1># ansible-playbook test.yml --list-hosts --limit node3,node2</span>
<a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a><span class=nt>playbook</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test.yml</span>
<a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">play</span><span class=w> </span><span class=c1>#1 (test2): test2        TAGS: []</span>
<a id=__codelineno-35-12 name=__codelineno-35-12 href=#__codelineno-35-12></a><span class=w>    </span><span class=nt>pattern</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>u&#39;test2&#39;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-35-13 name=__codelineno-35-13 href=#__codelineno-35-13></a><span class=w>    </span><span class=nt>hosts (2)</span><span class=p>:</span>
<a id=__codelineno-35-14 name=__codelineno-35-14 href=#__codelineno-35-14></a><span class=w>      </span><span class="l l-Scalar l-Scalar-Plain">node3</span>
<a id=__codelineno-35-15 name=__codelineno-35-15 href=#__codelineno-35-15></a><span class=w>      </span><span class="l l-Scalar l-Scalar-Plain">node2</span>
</code></pre></div> <h3 id=示例>示例<a class=headerlink href=#示例 title="Permanent link">&para;</a></h3> <h4 id=连接本地主机>连接本地主机<a class=headerlink href=#连接本地主机 title="Permanent link">&para;</a></h4> <p>不需要在主机清单里定义，直接使用 <code>localhost</code> 或 <code>127.0.0.1</code> 就可以连接本地了</p> <div class=highlight><pre><span></span><code><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=c1># ansible localhost -m ping</span>
<a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a>localhost<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>SUCCESS</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span>
<a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a><span class=w>    </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>false,<span class=w> </span>
<a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a><span class=w>    </span><span class=s2>&quot;ping&quot;</span>:<span class=w> </span><span class=s2>&quot;pong&quot;</span>
<a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a><span class=o>}</span>
<a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a>
<a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a><span class=c1># ansible 127.0.0.1 -m ping</span>
<a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a><span class=m>127</span>.0.0.1<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>SUCCESS</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span>
<a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a><span class=w>    </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>false,<span class=w> </span>
<a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a><span class=w>    </span><span class=s2>&quot;ping&quot;</span>:<span class=w> </span><span class=s2>&quot;pong&quot;</span>
<a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a><span class=o>}</span>
</code></pre></div> <h4 id=使用别名连接主机>使用别名连接主机<a class=headerlink href=#使用别名连接主机 title="Permanent link">&para;</a></h4> <p><strong>定义主机清单</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=c1># cat /etc/ansible/hosts</span>
<a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a>
<a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a>alias_host<span class=w> </span><span class=nv>ansible_host</span><span class=o>=</span><span class=m>192</span>.168.77.131<span class=w> </span><span class=nv>ansible_port</span><span class=o>=</span><span class=m>22</span><span class=w> </span><span class=nv>ansible_user</span><span class=o>=</span>root<span class=w> </span><span class=nv>ansible_password</span><span class=o>=</span><span class=m>123456</span><span class=w> </span><span class=c1># 指定别名，定义主机ssh连接信息</span>
</code></pre></div> <strong>测试连通性</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=c1># ansible alias_host -m ping</span>
<a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a>alias_host<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>SUCCESS</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span>
<a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=w>    </span><span class=s2>&quot;ansible_facts&quot;</span>:<span class=w> </span><span class=o>{</span>
<a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=w>        </span><span class=s2>&quot;discovered_interpreter_python&quot;</span>:<span class=w> </span><span class=s2>&quot;/usr/bin/python&quot;</span>
<a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a><span class=w>    </span><span class=o>}</span>,<span class=w> </span>
<a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a><span class=w>    </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>false,<span class=w> </span>
<a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a><span class=w>    </span><span class=s2>&quot;ping&quot;</span>:<span class=w> </span><span class=s2>&quot;pong&quot;</span>
<a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a><span class=o>}</span>
</code></pre></div></p> <h4 id=使用-ssh-秘钥连接主机>使用 ssh 秘钥连接主机<a class=headerlink href=#使用-ssh-秘钥连接主机 title="Permanent link">&para;</a></h4> <p><strong>开启远程主机秘钥认证</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=c1># echo &#39;PubkeyAuthentication yes&#39; &gt;&gt; /etc/ssh/sshd_config</span>
<a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=c1># systemctl restart sshd</span>
</code></pre></div></p> <p><strong>配置远程主机秘钥</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=c1># ssh-keygen -t rsa -P &#39;&#39; -b 4096 -f ~/.ssh/id_rsa</span>
<a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=c1># cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span>
<a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a><span class=c1># chmod 600 ~/.ssh/authorized_keys</span>
</code></pre></div></p> <p><strong>将刚刚生成的私钥 <code>~/.ssh/id_rsa</code> 拷贝到 ansible 节点</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=c1># mv id_rsa /opt/131.key</span>
<a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=c1># chmod 600 /opt/131.key</span>
</code></pre></div></p> <p><strong>定义主机清单</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=c1># cat /etc/ansible/hosts</span>
<a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=m>192</span>.168.77.131<span class=w> </span><span class=nv>ansible_ssh_private_key_file</span><span class=o>=</span>/opt/131.key
</code></pre></div></p> <blockquote> <p>不指定 <code>ansible_user</code> 则使用运行ansible命令的用户</p> </blockquote> <div class="admonition note"> <p class=admonition-title>Note</p> <p>如果 <code>private_key</code> 使用了 <strong>passphrase</strong> ，可使用下列命令，将密码保存在 ssh-agent 中。 <div class=highlight><pre><span></span><code><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a>ssh-agent<span class=w> </span>bash
<a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a>ssh-add<span class=w> </span>/opt/131.key
</code></pre></div></p> </div> <p><strong>测试连通性</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a><span class=c1># ansible 192.168.77.131 -m ping</span>
<a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a><span class=m>192</span>.168.77.131<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>SUCCESS</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span>
<a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a><span class=w>    </span><span class=s2>&quot;ansible_facts&quot;</span>:<span class=w> </span><span class=o>{</span>
<a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a><span class=w>        </span><span class=s2>&quot;discovered_interpreter_python&quot;</span>:<span class=w> </span><span class=s2>&quot;/usr/bin/python&quot;</span>
<a id=__codelineno-44-5 name=__codelineno-44-5 href=#__codelineno-44-5></a><span class=w>    </span><span class=o>}</span>,<span class=w> </span>
<a id=__codelineno-44-6 name=__codelineno-44-6 href=#__codelineno-44-6></a><span class=w>    </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>false,<span class=w> </span>
<a id=__codelineno-44-7 name=__codelineno-44-7 href=#__codelineno-44-7></a><span class=w>    </span><span class=s2>&quot;ping&quot;</span>:<span class=w> </span><span class=s2>&quot;pong&quot;</span>
<a id=__codelineno-44-8 name=__codelineno-44-8 href=#__codelineno-44-8></a><span class=o>}</span>
</code></pre></div></p> <h4 id=使用-跳板机-连接主机>使用 跳板机 连接主机<a class=headerlink href=#使用-跳板机-连接主机 title="Permanent link">&para;</a></h4> <blockquote> <p>通过 192.168.77.132 连接192.168.77.131， 192.168.77.132 需安装<code>nc</code></p> </blockquote> <p><strong>添加132节点到kown_hosts</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a><span class=c1># ssh 192.168.77.132</span>
<a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a>The<span class=w> </span>authenticity<span class=w> </span>of<span class=w> </span>host<span class=w> </span><span class=s1>&#39;192.168.77.132 (192.168.77.132)&#39;</span><span class=w> </span>can<span class=s1>&#39;t be established.</span>
<a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a><span class=s1>ECDSA key fingerprint is SHA256:2lWSIJMF9r8hnfLwlKONY07eQCeZaDVZ/xWZizr9wqs.</span>
<a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a><span class=s1>ECDSA key fingerprint is MD5:be:82:d9:23:45:18:f2:e3:fa:32:56:65:c9:b1:4b:07.</span>
<a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a><span class=s1>Are you sure you want to continue connecting (yes/no)? yes</span>
<a id=__codelineno-45-6 name=__codelineno-45-6 href=#__codelineno-45-6></a><span class=s1>Warning: Permanently added &#39;</span><span class=m>192</span>.168.77.132<span class=err>&#39;</span><span class=w> </span><span class=o>(</span>ECDSA<span class=o>)</span><span class=w> </span>to<span class=w> </span>the<span class=w> </span>list<span class=w> </span>of<span class=w> </span>known<span class=w> </span>hosts.
</code></pre></div></p> <ol> <li>使用ssh代理参数配置</li> </ol> <p><strong>定义主机清单</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a><span class=c1># cat /etc/ansible/hosts</span>
<a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a><span class=m>192</span>.168.77.131<span class=w> </span><span class=nv>ansible_ssh_private_key_file</span><span class=o>=</span>/root/131.key<span class=w> </span><span class=nv>ansible_ssh_common_args</span><span class=o>=</span><span class=s2>&quot;-o ProxyCommand=\&quot;sshpass -p &#39;123456&#39; ssh -qay -p 22 root@192.168.77.132 &#39;nc %h %p&#39;\&quot;&quot;</span>
</code></pre></div></p> <blockquote> <p>ansible_ssh_common_args 配置ssh连接的参数</p> </blockquote> <p><strong>测试连通性</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=c1># ansible 192.168.77.131 -m ping</span>
<a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a><span class=m>192</span>.168.77.131<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>SUCCESS</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span>
<a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a><span class=w>    </span><span class=s2>&quot;ansible_facts&quot;</span>:<span class=w> </span><span class=o>{</span>
<a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a><span class=w>        </span><span class=s2>&quot;discovered_interpreter_python&quot;</span>:<span class=w> </span><span class=s2>&quot;/usr/bin/python&quot;</span>
<a id=__codelineno-47-5 name=__codelineno-47-5 href=#__codelineno-47-5></a><span class=w>    </span><span class=o>}</span>,<span class=w> </span>
<a id=__codelineno-47-6 name=__codelineno-47-6 href=#__codelineno-47-6></a><span class=w>    </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>false,<span class=w> </span>
<a id=__codelineno-47-7 name=__codelineno-47-7 href=#__codelineno-47-7></a><span class=w>    </span><span class=s2>&quot;ping&quot;</span>:<span class=w> </span><span class=s2>&quot;pong&quot;</span>
<a id=__codelineno-47-8 name=__codelineno-47-8 href=#__codelineno-47-8></a><span class=o>}</span>
</code></pre></div> <ol> <li>使用本地ssh配置主机代理</li> </ol> <p><strong>配置ssh</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=c1># cat ~/.ssh/config </span>
<a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a>Host<span class=w> </span><span class=m>192</span>.168.77.131
<a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a><span class=w>        </span>User<span class=w> </span>root
<a id=__codelineno-48-4 name=__codelineno-48-4 href=#__codelineno-48-4></a><span class=w>        </span>Port<span class=w> </span><span class=m>22</span>
<a id=__codelineno-48-5 name=__codelineno-48-5 href=#__codelineno-48-5></a><span class=w>        </span>TCPKeepAlive<span class=w> </span>yes
<a id=__codelineno-48-6 name=__codelineno-48-6 href=#__codelineno-48-6></a><span class=w>        </span>ForwardAgent<span class=w> </span>yes
<a id=__codelineno-48-7 name=__codelineno-48-7 href=#__codelineno-48-7></a><span class=w>        </span>ProxyCommand<span class=w> </span>sshpass<span class=w> </span>-p<span class=w> </span><span class=s1>&#39;123456&#39;</span><span class=w> </span>ssh<span class=w> </span>-qaY<span class=w> </span>-p<span class=w> </span><span class=m>22</span><span class=w> </span>root@192.168.77.132<span class=w> </span><span class=s1>&#39;nc %h %p&#39;</span>
</code></pre></div> <p><strong>定义主机清单</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a><span class=c1># cat /etc/ansible/hosts</span>
<a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a><span class=m>192</span>.168.77.131<span class=w> </span><span class=nv>ansible_ssh_private_key_file</span><span class=o>=</span>/opt/131.key
</code></pre></div></p> <p><strong>测试连通性</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a><span class=c1># ansible 192.168.77.131 -m ping</span>
<a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a><span class=m>192</span>.168.77.131<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>SUCCESS</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span>
<a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a><span class=w>    </span><span class=s2>&quot;ansible_facts&quot;</span>:<span class=w> </span><span class=o>{</span>
<a id=__codelineno-50-4 name=__codelineno-50-4 href=#__codelineno-50-4></a><span class=w>        </span><span class=s2>&quot;discovered_interpreter_python&quot;</span>:<span class=w> </span><span class=s2>&quot;/usr/bin/python&quot;</span>
<a id=__codelineno-50-5 name=__codelineno-50-5 href=#__codelineno-50-5></a><span class=w>    </span><span class=o>}</span>,<span class=w> </span>
<a id=__codelineno-50-6 name=__codelineno-50-6 href=#__codelineno-50-6></a><span class=w>    </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>false,<span class=w> </span>
<a id=__codelineno-50-7 name=__codelineno-50-7 href=#__codelineno-50-7></a><span class=w>    </span><span class=s2>&quot;ping&quot;</span>:<span class=w> </span><span class=s2>&quot;pong&quot;</span>
<a id=__codelineno-50-8 name=__codelineno-50-8 href=#__codelineno-50-8></a><span class=o>}</span>
</code></pre></div> <ol> <li>使用ssh代理</li> </ol> <blockquote> <p>不需要在192.168.77.132上安装nc软件了</p> </blockquote> <p><strong>定义主机清单</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=c1># cat /etc/ansible/hosts</span>
<a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=m>192</span>.168.77.131<span class=w> </span><span class=nv>ansible_ssh_private_key_file</span><span class=o>=</span>/root/131.key<span class=w> </span><span class=nv>ansible_ssh_common_args</span><span class=o>=</span><span class=s2>&quot;-o ProxyCommand=\&quot;sshpass -p &#39;123456&#39; ssh -W %h:%p -q -p 22 root@192.168.77.132\&quot;&quot;</span>
</code></pre></div></p> <blockquote> <p>ansible_ssh_common_args 配置ssh连接的参数</p> </blockquote> <p><strong>测试连通性</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a><span class=c1># ansible 192.168.77.131 -m ping</span>
<a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a><span class=m>192</span>.168.77.131<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>SUCCESS</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span>
<a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a><span class=w>    </span><span class=s2>&quot;ansible_facts&quot;</span>:<span class=w> </span><span class=o>{</span>
<a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a><span class=w>        </span><span class=s2>&quot;discovered_interpreter_python&quot;</span>:<span class=w> </span><span class=s2>&quot;/usr/bin/python&quot;</span>
<a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a><span class=w>    </span><span class=o>}</span>,<span class=w> </span>
<a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a><span class=w>    </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>false,<span class=w> </span>
<a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a><span class=w>    </span><span class=s2>&quot;ping&quot;</span>:<span class=w> </span><span class=s2>&quot;pong&quot;</span>
<a id=__codelineno-52-8 name=__codelineno-52-8 href=#__codelineno-52-8></a><span class=o>}</span>
</code></pre></div> <h4 id=命令行指定主机清单>命令行指定主机清单<a class=headerlink href=#命令行指定主机清单 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a><span class=c1># ansible -i &#39;192.168.77.131,192.168.77.132&#39; 192.168.77.* -m ping -k</span>
<a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a>SSH<span class=w> </span>password:<span class=w> </span>
<a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a><span class=m>192</span>.168.77.131<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>SUCCESS</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span>
<a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a><span class=w>    </span><span class=s2>&quot;ansible_facts&quot;</span>:<span class=w> </span><span class=o>{</span>
<a id=__codelineno-53-5 name=__codelineno-53-5 href=#__codelineno-53-5></a><span class=w>        </span><span class=s2>&quot;discovered_interpreter_python&quot;</span>:<span class=w> </span><span class=s2>&quot;/usr/bin/python&quot;</span>
<a id=__codelineno-53-6 name=__codelineno-53-6 href=#__codelineno-53-6></a><span class=w>    </span><span class=o>}</span>,<span class=w> </span>
<a id=__codelineno-53-7 name=__codelineno-53-7 href=#__codelineno-53-7></a><span class=w>    </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>false,<span class=w> </span>
<a id=__codelineno-53-8 name=__codelineno-53-8 href=#__codelineno-53-8></a><span class=w>    </span><span class=s2>&quot;ping&quot;</span>:<span class=w> </span><span class=s2>&quot;pong&quot;</span>
<a id=__codelineno-53-9 name=__codelineno-53-9 href=#__codelineno-53-9></a><span class=o>}</span>
<a id=__codelineno-53-10 name=__codelineno-53-10 href=#__codelineno-53-10></a><span class=m>192</span>.168.77.132<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>SUCCESS</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span>
<a id=__codelineno-53-11 name=__codelineno-53-11 href=#__codelineno-53-11></a><span class=w>    </span><span class=s2>&quot;ansible_facts&quot;</span>:<span class=w> </span><span class=o>{</span>
<a id=__codelineno-53-12 name=__codelineno-53-12 href=#__codelineno-53-12></a><span class=w>        </span><span class=s2>&quot;discovered_interpreter_python&quot;</span>:<span class=w> </span><span class=s2>&quot;/usr/bin/python&quot;</span>
<a id=__codelineno-53-13 name=__codelineno-53-13 href=#__codelineno-53-13></a><span class=w>    </span><span class=o>}</span>,<span class=w> </span>
<a id=__codelineno-53-14 name=__codelineno-53-14 href=#__codelineno-53-14></a><span class=w>    </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>false,<span class=w> </span>
<a id=__codelineno-53-15 name=__codelineno-53-15 href=#__codelineno-53-15></a><span class=w>    </span><span class=s2>&quot;ping&quot;</span>:<span class=w> </span><span class=s2>&quot;pong&quot;</span>
<a id=__codelineno-53-16 name=__codelineno-53-16 href=#__codelineno-53-16></a><span class=o>}</span>
</code></pre></div> <p>通过 <code>-i</code> 参数， 指定用逗号分隔的主机列表即可。 </p> <p>不过不能指定<code>ansible_*</code> 开头的变量，即不能定义连接密码。</p> <h3 id=动态主机清单>动态主机清单<a class=headerlink href=#动态主机清单 title="Permanent link">&para;</a></h3> <p>ansible 不仅可以使用<code>yaml</code>,<code>ini</code>等格式的静态文件配置主机清单，还可以使用动态的源作为主机清单，详细内容请见使用动态主机</p> <h2 id=5patterns-匹配>5.Patterns 匹配<a class=headerlink href=#5patterns-匹配 title="Permanent link">&para;</a></h2> <p><strong>Patterns</strong> 是定义Ansible要执行的主机。Ansible Patterns 可以引用一个主机，一个IP地址，一个清单组，一个集合组或清单中的所有主机。 Patterns 具有高度的灵活性，您可以排除或要求主机的子集，使用 <strong>通配符</strong> 或 <strong>正则表达式</strong> 来定义 Patterns 。</p> <p><strong>命令格式</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a>ansible &lt;pattern&gt; -m &lt;module_name&gt; -a &quot;&lt;module options&gt;&quot;
<a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a>
<a id=__codelineno-54-3 name=__codelineno-54-3 href=#__codelineno-54-3></a>ansible-playbook -l &lt;pattern&gt;  [options] playbook.yml
</code></pre></div> <p><strong>使用示例</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a>ansible * -m service -a &quot;name=httpd state=restarted&quot;
<a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a>
<a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a>ansible-playbook  -l all playbook.yml
</code></pre></div> <p>在 <strong>playbook</strong> 的剧本中，需要在每个 <strong>play</strong> 中<code>hosts:</code>行中定义</p> <div class=highlight><pre><span></span><code><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a>- name: &lt;play_name&gt;
<a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a>  hosts: &lt;pattern&gt;
</code></pre></div> <p><strong>使用示例</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a>- name: restart webservers
<a id=__codelineno-57-2 name=__codelineno-57-2 href=#__codelineno-57-2></a>  hosts: webservers
</code></pre></div> <h3 id=常用匹配>常用匹配<a class=headerlink href=#常用匹配 title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>描述</th> <th>Pattern(s)</th> <th>Targets</th> </tr> </thead> <tbody> <tr> <td>所有主机</td> <td><code>all</code> 或者 <code>*</code></td> <td>主机清单中的所有主机</td> </tr> <tr> <td>一个主机(精确匹配)</td> <td><code>host1</code> 或者 <code>192.168.77.131</code></td> <td><code>host1</code> 或者 <code>192.168.77.131</code></td> </tr> <tr> <td>多个主机</td> <td><code>host1:host2</code> 或者<code>host1,host2</code></td> <td><code>host1:host2</code> 或者<code>host1,host2</code></td> </tr> <tr> <td>一个组</td> <td><code>webservers</code></td> <td><code>webservers</code>组中的主机</td> </tr> <tr> <td>多个组(或匹配)</td> <td><code>webservers:dbservers</code></td> <td><code>webservers</code>和<code>dbservers</code>所有的主机</td> </tr> <tr> <td>排除组(非模式匹配)</td> <td>webservers:!atlanta</td> <td><code>webservers</code>组中除<code>atlanta</code>之外的所有主机</td> </tr> <tr> <td>交集组(交集匹配)</td> <td>webservers:&amp;dbservers</td> <td><code>webservers</code>和<code>dbservers</code>都存在的主机</td> </tr> </tbody> </table> <p><strong>通配符匹配</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a>*.com
<a id=__codelineno-58-2 name=__codelineno-58-2 href=#__codelineno-58-2></a>web*.com:dbserver
</code></pre></div> <p><code>*</code>表示所有字符</p> <p><strong>组合匹配</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a>webservers:dbservers:&amp;staging:!phoenix
</code></pre></div> <p>在webservers 或者dbservers 组中，必须还存在于staging 组中，但是不在phoenix 组中</p> <h3 id=局限性>局限性<a class=headerlink href=#局限性 title="Permanent link">&para;</a></h3> <p><strong>Patterns</strong> 依赖于 <strong>主机清单</strong> (inventory)，如果说匹配不到主机清单里的数据，则会返回如下警告</p> <div class=highlight><pre><span></span><code><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a><span class=c1># ansible none -m ping </span>
<a id=__codelineno-60-2 name=__codelineno-60-2 href=#__codelineno-60-2></a><span class=o>[</span>WARNING<span class=o>]</span>:<span class=w> </span>Could<span class=w> </span>not<span class=w> </span>match<span class=w> </span>supplied<span class=w> </span>host<span class=w> </span>pattern,<span class=w> </span>ignoring:<span class=w> </span>none
<a id=__codelineno-60-3 name=__codelineno-60-3 href=#__codelineno-60-3></a><span class=o>[</span>WARNING<span class=o>]</span>:<span class=w> </span>No<span class=w> </span>hosts<span class=w> </span>matched,<span class=w> </span>nothing<span class=w> </span>to<span class=w> </span><span class=k>do</span>
</code></pre></div> <h3 id=高级特性>高级特性<a class=headerlink href=#高级特性 title="Permanent link">&para;</a></h3> <h4 id=使用变量>使用变量<a class=headerlink href=#使用变量 title="Permanent link">&para;</a></h4> <p>在ansible-palybook 命令中，你也可以使用变量来组成这样的表达式，但是你必须使用<code>-e</code>的选项来指定这个表达式</p> <p><strong>playbook</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a><span class=c1># cat  playbook.yml</span>
<a id=__codelineno-61-2 name=__codelineno-61-2 href=#__codelineno-61-2></a>---
<a id=__codelineno-61-3 name=__codelineno-61-3 href=#__codelineno-61-3></a>-<span class=w> </span>name:<span class=w> </span>Using<span class=w> </span>variables<span class=w> </span><span class=k>in</span><span class=w> </span>patterns
<a id=__codelineno-61-4 name=__codelineno-61-4 href=#__codelineno-61-4></a><span class=w>  </span>hosts:<span class=w> </span><span class=s2>&quot;{{ hosts }}&quot;</span>
<a id=__codelineno-61-5 name=__codelineno-61-5 href=#__codelineno-61-5></a><span class=w>  </span>tasks:
<a id=__codelineno-61-6 name=__codelineno-61-6 href=#__codelineno-61-6></a><span class=w>    </span>-<span class=w> </span>name:<span class=w> </span>ping
<a id=__codelineno-61-7 name=__codelineno-61-7 href=#__codelineno-61-7></a><span class=w>      </span>ping:
</code></pre></div> <p><strong>执行playbook</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a>ansible-playbook<span class=w> </span>playbook.yml<span class=w> </span>-e<span class=w> </span><span class=s2>&quot;hosts=192.168.77.131&quot;</span>
<a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a>ansible-playbook<span class=w> </span>playbook.yml<span class=w> </span>-e<span class=w> </span><span class=s2>&quot;hosts=192.168.77.132&quot;</span>
</code></pre></div> <h4 id=使用切片>使用切片<a class=headerlink href=#使用切片 title="Permanent link">&para;</a></h4> <p>可以使用下标来选择组中的各个主机或范围，类似python中的切片</p> <div class=highlight><pre><span></span><code><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a>webservers[0]
<a id=__codelineno-63-2 name=__codelineno-63-2 href=#__codelineno-63-2></a>webservers[1:]
<a id=__codelineno-63-3 name=__codelineno-63-3 href=#__codelineno-63-3></a>webservers[0:25]
</code></pre></div> <ul> <li> <p><code>[0]</code>表示组第一个成员</p> </li> <li> <p><code>[1:]</code> 表示组内第2个含第2个之后的所有成员</p> </li> <li><code>[0:25]</code>表示组第1个到第24个成员</li> </ul> <h4 id=正则表达式>正则表达式<a class=headerlink href=#正则表达式 title="Permanent link">&para;</a></h4> <p>在开头的地方使用“~”，表示这是一个正则表达式</p> <div class=highlight><pre><span></span><code><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a>~(web|db).*\.example\.com
</code></pre></div> <h4 id=限定主机>限定主机<a class=headerlink href=#限定主机 title="Permanent link">&para;</a></h4> <p>可以使用命令行选项更改playbook中定义的Patterns 的行为</p> <div class=highlight><pre><span></span><code><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a>ansible-playbook site.yml -l 192.168.77.129
<a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a>
<a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a>ansible-playbook site.yml -l @retry_hosts.txt
</code></pre></div> <p>只执行<code>-l</code>后的主机, <code>@</code>开头指定文件</p> <h2 id=6使用ad-hoc命令>6.使用ad-hoc命令<a class=headerlink href=#6使用ad-hoc命令 title="Permanent link">&para;</a></h2> <p>Ansible ad-hoc 命令使用 <code>/usr/bin/ansible</code>命令行工具来自动化一个或多个受管节点上的单个任务。 临时命令既快速又简单，但不可重用。</p> <h3 id=ad-hoc-命令>ad-hoc 命令<a class=headerlink href=#ad-hoc-命令 title="Permanent link">&para;</a></h3> <p><div class=highlight><pre><span></span><code><a id=__codelineno-66-1 name=__codelineno-66-1 href=#__codelineno-66-1></a>ansible<span class=w> </span><span class=o>[</span>pattern<span class=o>]</span><span class=w> </span>-m<span class=w> </span><span class=o>[</span>module<span class=o>]</span><span class=w> </span>-a<span class=w> </span><span class=s2>&quot;[module options]&quot;</span>
</code></pre></div> 执行结果说明</p> <p>rc: 命令返回码（0表示成功）</p> <h3 id=ad-hoc-示例>ad-hoc 示例<a class=headerlink href=#ad-hoc-示例 title="Permanent link">&para;</a></h3> <h4 id=执行shell命令>执行shell命令<a class=headerlink href=#执行shell命令 title="Permanent link">&para;</a></h4> <h5 id=command>command<a class=headerlink href=#command title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-67-1 name=__codelineno-67-1 href=#__codelineno-67-1></a><span class=c1>#Execute commands on target 在目标主机上执行指令</span>
<a id=__codelineno-67-2 name=__codelineno-67-2 href=#__codelineno-67-2></a><span class=w> </span>ARG：
<a id=__codelineno-67-3 name=__codelineno-67-3 href=#__codelineno-67-3></a><span class=w>    </span>chdir<span class=w>       </span><span class=c1>#切换目录执行command</span>
<a id=__codelineno-67-4 name=__codelineno-67-4 href=#__codelineno-67-4></a>
<a id=__codelineno-67-5 name=__codelineno-67-5 href=#__codelineno-67-5></a>example：
<a id=__codelineno-67-6 name=__codelineno-67-6 href=#__codelineno-67-6></a><span class=w>    </span>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span><span class=nb>command</span><span class=w> </span>-a<span class=w> </span><span class=s1>&#39;whoami&#39;</span>
<a id=__codelineno-67-7 name=__codelineno-67-7 href=#__codelineno-67-7></a>
<a id=__codelineno-67-8 name=__codelineno-67-8 href=#__codelineno-67-8></a><span class=c1>#command模块不能解析shell语句</span>
</code></pre></div> <p>重启服务器</p> <div class=highlight><pre><span></span><code><a id=__codelineno-68-1 name=__codelineno-68-1 href=#__codelineno-68-1></a>ansible<span class=w> </span>servers<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;reboot&quot;</span>
</code></pre></div> <p>不指定<code>-m</code> 模块时，将使用ansible的默认模块command，它不会通过shell进行处理，所以像<code>$HOME</code>和像<code>“&lt;”</code>，<code>“&gt;”</code>，<code>“|”</code>，<code>“;”</code>和<code>“＆”</code>将不工作</p> <p>默认情况下，Ansible使用5个并发进程。 如果你要扩大并发，使用<code>-f 10</code> 参数指定数量即可。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-69-1 name=__codelineno-69-1 href=#__codelineno-69-1></a>ansible<span class=w> </span>servers<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;reboot&quot;</span><span class=w> </span>-f<span class=w> </span><span class=m>10</span>
</code></pre></div> <p>默认情况下，Ansible连接远端用户是当前用户，使用<code>-u</code> 参数可以修改</p> <div class=highlight><pre><span></span><code><a id=__codelineno-70-1 name=__codelineno-70-1 href=#__codelineno-70-1></a>ansible<span class=w> </span>servers<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;reboot&quot;</span><span class=w> </span>-f<span class=w> </span><span class=m>10</span><span class=w> </span>-u<span class=w> </span>root
</code></pre></div> <p>如果运行用户没有权限执行，使用<code>--become</code> 可以提升权限,默认是<code>sudo</code>方式</p> <div class=highlight><pre><span></span><code><a id=__codelineno-71-1 name=__codelineno-71-1 href=#__codelineno-71-1></a>ansible<span class=w> </span>servers<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;reboot&quot;</span><span class=w> </span>-f<span class=w> </span><span class=m>10</span><span class=w> </span>-u<span class=w> </span>root<span class=w> </span>--become
<a id=__codelineno-71-2 name=__codelineno-71-2 href=#__codelineno-71-2></a>ansible<span class=w> </span>servers<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;reboot&quot;</span><span class=w> </span>-f<span class=w> </span><span class=m>10</span><span class=w> </span>-u<span class=w> </span><span class=nb>test</span><span class=w> </span>--become<span class=w> </span>--become-method<span class=w> </span>sudo<span class=w> </span>--become-user<span class=w> </span>root<span class=w> </span>--ask-become-pass
</code></pre></div> <p><code>--become-method</code> 指定提升方式，<code>--become-user</code> 指定提升用户 <code>--ask-become-pass</code> 告知提升密码</p> <h5 id=shell>shell<a class=headerlink href=#shell title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-72-1 name=__codelineno-72-1 href=#__codelineno-72-1></a><span class=c1>#Execute shell commands on targets在目标主机上执行shell指令</span>
<a id=__codelineno-72-2 name=__codelineno-72-2 href=#__codelineno-72-2></a><span class=w> </span>ARG：
<a id=__codelineno-72-3 name=__codelineno-72-3 href=#__codelineno-72-3></a><span class=w>    </span>chdir<span class=w>       </span><span class=c1>#切换目录执行command</span>
<a id=__codelineno-72-4 name=__codelineno-72-4 href=#__codelineno-72-4></a><span class=w>    </span>executable<span class=w>  </span><span class=c1>#使用其他的shell解析</span>
<a id=__codelineno-72-5 name=__codelineno-72-5 href=#__codelineno-72-5></a>
<a id=__codelineno-72-6 name=__codelineno-72-6 href=#__codelineno-72-6></a><span class=w> </span>example:
<a id=__codelineno-72-7 name=__codelineno-72-7 href=#__codelineno-72-7></a><span class=w>    </span>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>shell<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;echo &quot;123465&quot;|passwd --stdin root&#39;</span>
</code></pre></div> <p>获取web组里得eth0接口信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-73-1 name=__codelineno-73-1 href=#__codelineno-73-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>shell<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;ifconfig eth0|grep addr&quot;</span>
</code></pre></div> <h5 id=raw>raw<a class=headerlink href=#raw title="Permanent link">&para;</a></h5> <p>如果说远程主机没有<code>python</code> 模块时，可以使用<code>raw</code> 模块执行命令</p> <div class=highlight><pre><span></span><code><a id=__codelineno-74-1 name=__codelineno-74-1 href=#__codelineno-74-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>raw<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;ifconfig eth0|grep addr&quot;</span>
</code></pre></div> <h5 id=script>script<a class=headerlink href=#script title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-75-1 name=__codelineno-75-1 href=#__codelineno-75-1></a><span class=c1>#Runs a local script on a remote node after transferring it 在远程主机上执行本地脚本</span>
<a id=__codelineno-75-2 name=__codelineno-75-2 href=#__codelineno-75-2></a>
<a id=__codelineno-75-3 name=__codelineno-75-3 href=#__codelineno-75-3></a>example：
<a id=__codelineno-75-4 name=__codelineno-75-4 href=#__codelineno-75-4></a><span class=w>    </span>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>script<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;/root/a.sh&quot;</span><span class=w>       </span><span class=c1>#直接指定本地脚本</span>
</code></pre></div> <p>执行脚本 <div class=highlight><pre><span></span><code><a id=__codelineno-76-1 name=__codelineno-76-1 href=#__codelineno-76-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>script<span class=w> </span>-a<span class=w> </span>ip.sh
</code></pre></div></p> <blockquote> <p>将本地脚本传送到远程节点上运行</p> </blockquote> <h4 id=文件管理>文件管理<a class=headerlink href=#文件管理 title="Permanent link">&para;</a></h4> <h5 id=copy>copy<a class=headerlink href=#copy title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-77-1 name=__codelineno-77-1 href=#__codelineno-77-1></a><span class=c1>#copy files to remote locations</span>
<a id=__codelineno-77-2 name=__codelineno-77-2 href=#__codelineno-77-2></a>ARG:
<a id=__codelineno-77-3 name=__codelineno-77-3 href=#__codelineno-77-3></a><span class=w>    </span>backup
<a id=__codelineno-77-4 name=__codelineno-77-4 href=#__codelineno-77-4></a><span class=w>    </span>content<span class=w>         </span><span class=c1>#不指定src，由content生成的内容即为复制内容</span>
<a id=__codelineno-77-5 name=__codelineno-77-5 href=#__codelineno-77-5></a><span class=w>    </span>dest<span class=w>            </span><span class=c1>#目标路径</span>
<a id=__codelineno-77-6 name=__codelineno-77-6 href=#__codelineno-77-6></a><span class=w>    </span>directory_mode<span class=w>  </span><span class=c1>#</span>
<a id=__codelineno-77-7 name=__codelineno-77-7 href=#__codelineno-77-7></a><span class=w>    </span>src<span class=w>             </span><span class=c1>#本机路径，如果复制目录，有&quot;/&quot;则表示复制目录下所有文件，否则递归复制整个目录</span>
<a id=__codelineno-77-8 name=__codelineno-77-8 href=#__codelineno-77-8></a><span class=w>    </span>remote_src<span class=w>      </span><span class=c1>#从远程主机复制到另一个远程主机</span>
<a id=__codelineno-77-9 name=__codelineno-77-9 href=#__codelineno-77-9></a><span class=w>    </span>group<span class=w>           </span>
<a id=__codelineno-77-10 name=__codelineno-77-10 href=#__codelineno-77-10></a><span class=w>    </span>owner<span class=w>           </span><span class=c1>#copy之后的属主，属组，权限</span>
<a id=__codelineno-77-11 name=__codelineno-77-11 href=#__codelineno-77-11></a><span class=w>    </span>mode
<a id=__codelineno-77-12 name=__codelineno-77-12 href=#__codelineno-77-12></a>
<a id=__codelineno-77-13 name=__codelineno-77-13 href=#__codelineno-77-13></a>example：
<a id=__codelineno-77-14 name=__codelineno-77-14 href=#__codelineno-77-14></a><span class=w>    </span><span class=m>1</span>.ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>copy<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;src=/etc/passwd dest=/tmp/passwd.ansible mode=644&quot;</span>
<a id=__codelineno-77-15 name=__codelineno-77-15 href=#__codelineno-77-15></a>
<a id=__codelineno-77-16 name=__codelineno-77-16 href=#__codelineno-77-16></a><span class=w>    </span><span class=m>2</span>.ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>copy<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;content=&quot;hello world\n&quot; dest=/tmp/hello.txt mode=600&#39;</span>
<a id=__codelineno-77-17 name=__codelineno-77-17 href=#__codelineno-77-17></a><span class=w>    </span><span class=c1>#用content生成的内容复制到目标主机名称为hello.txt</span>
<a id=__codelineno-77-18 name=__codelineno-77-18 href=#__codelineno-77-18></a>
<a id=__codelineno-77-19 name=__codelineno-77-19 href=#__codelineno-77-19></a><span class=w>    </span><span class=m>3</span>.ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>copy<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;src=/home/linxi dest=/tmp/&#39;</span>
<a id=__codelineno-77-20 name=__codelineno-77-20 href=#__codelineno-77-20></a><span class=w>    </span><span class=c1>#复制改目录到指定目录下</span>
<a id=__codelineno-77-21 name=__codelineno-77-21 href=#__codelineno-77-21></a>
<a id=__codelineno-77-22 name=__codelineno-77-22 href=#__codelineno-77-22></a><span class=c1>#copy 可以创建文件</span>
</code></pre></div> <p>拷贝本地的/etc/hosts 文件到web组所有主机的/tmp/hosts（空目录除外）</p> <div class=highlight><pre><span></span><code><a id=__codelineno-78-1 name=__codelineno-78-1 href=#__codelineno-78-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>copy<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;src=/etc/hosts dest=/tmp/hosts&quot;</span>
</code></pre></div> <p>拷贝本地的ntp文件到目的地址，设置其用户及权限，如果目标地址存在相同的文件，则备份源文件。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-79-1 name=__codelineno-79-1 href=#__codelineno-79-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>copy<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;src=/mine/ntp.conf dest=/etc/ntp.conf owner=root group=root mode=644 backup=yes force=yes&quot;</span>
</code></pre></div> <h5 id=fetch>fetch<a class=headerlink href=#fetch title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-80-1 name=__codelineno-80-1 href=#__codelineno-80-1></a><span class=c1>#Fetch files from remote nodes 从远程主机获取文件</span>
<a id=__codelineno-80-2 name=__codelineno-80-2 href=#__codelineno-80-2></a><span class=w> </span>ARG：<span class=w> </span>
<a id=__codelineno-80-3 name=__codelineno-80-3 href=#__codelineno-80-3></a><span class=w>    </span>dest<span class=w>                </span><span class=c1>#目标</span>
<a id=__codelineno-80-4 name=__codelineno-80-4 href=#__codelineno-80-4></a><span class=w>    </span>src<span class=w>                 </span><span class=c1>#源</span>
<a id=__codelineno-80-5 name=__codelineno-80-5 href=#__codelineno-80-5></a><span class=w>    </span>fail_on_missing<span class=w>     </span><span class=c1>#由于任何原因无法读取远程文件，则任务将失败</span>
<a id=__codelineno-80-6 name=__codelineno-80-6 href=#__codelineno-80-6></a>
<a id=__codelineno-80-7 name=__codelineno-80-7 href=#__codelineno-80-7></a>example：
<a id=__codelineno-80-8 name=__codelineno-80-8 href=#__codelineno-80-8></a><span class=w>    </span>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>fetch<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;dest=/tmp/backup.ansible？ src=/etc/passwd&#39;</span>
<a id=__codelineno-80-9 name=__codelineno-80-9 href=#__codelineno-80-9></a>
<a id=__codelineno-80-10 name=__codelineno-80-10 href=#__codelineno-80-10></a><span class=c1>#fetch复制文件时，会在本地创建目录，将多个主机上的文件都放在改目录下</span>
</code></pre></div> <p>从远端服务器拷贝到本机</p> <div class=highlight><pre><span></span><code><a id=__codelineno-81-1 name=__codelineno-81-1 href=#__codelineno-81-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>fetch<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;src=/etc/hosts dest=/tmp/temp_hosts flat=yes&quot;</span>
</code></pre></div> <h5 id=file>file<a class=headerlink href=#file title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-82-1 name=__codelineno-82-1 href=#__codelineno-82-1></a><span class=c1>#Manage files and file properties管理文件和文件属性</span>
<a id=__codelineno-82-2 name=__codelineno-82-2 href=#__codelineno-82-2></a>ARG：
<a id=__codelineno-82-3 name=__codelineno-82-3 href=#__codelineno-82-3></a><span class=w>    </span>state<span class=w>   </span><span class=c1>#文件属性directory，file,link</span>
<a id=__codelineno-82-4 name=__codelineno-82-4 href=#__codelineno-82-4></a><span class=w>    </span>src<span class=w>     </span><span class=c1>#在目标主机上创建符号链接</span>
<a id=__codelineno-82-5 name=__codelineno-82-5 href=#__codelineno-82-5></a><span class=w>    </span>path<span class=w>    </span><span class=c1>#创建文件或目录路径</span>
<a id=__codelineno-82-6 name=__codelineno-82-6 href=#__codelineno-82-6></a><span class=w>    </span>mode
<a id=__codelineno-82-7 name=__codelineno-82-7 href=#__codelineno-82-7></a><span class=w>    </span>owner
<a id=__codelineno-82-8 name=__codelineno-82-8 href=#__codelineno-82-8></a><span class=w>    </span>group
<a id=__codelineno-82-9 name=__codelineno-82-9 href=#__codelineno-82-9></a>
<a id=__codelineno-82-10 name=__codelineno-82-10 href=#__codelineno-82-10></a>example:
<a id=__codelineno-82-11 name=__codelineno-82-11 href=#__codelineno-82-11></a><span class=w>    </span>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>file<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;path=/root/ansible state=directory mode=644 owner=root&quot;</span>
<a id=__codelineno-82-12 name=__codelineno-82-12 href=#__codelineno-82-12></a><span class=w>    </span><span class=c1>#在目标主机上创建目录</span>
<a id=__codelineno-82-13 name=__codelineno-82-13 href=#__codelineno-82-13></a><span class=w>    </span>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>file<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;src=/etc/fstab path=/root/fatab.link state=link&quot;</span>
<a id=__codelineno-82-14 name=__codelineno-82-14 href=#__codelineno-82-14></a><span class=w>    </span><span class=c1>#在目标主机创建链接</span>
<a id=__codelineno-82-15 name=__codelineno-82-15 href=#__codelineno-82-15></a>
<a id=__codelineno-82-16 name=__codelineno-82-16 href=#__codelineno-82-16></a><span class=c1>#不建议创建文件，</span>
</code></pre></div> <p>更改文件的用户及权限</p> <div class=highlight><pre><span></span><code><a id=__codelineno-83-1 name=__codelineno-83-1 href=#__codelineno-83-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>file<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;dest=/tmp/a.txt mode=600 owner=user group=user&quot;</span>
</code></pre></div> <p>创建目录，类似mkdir -p</p> <div class=highlight><pre><span></span><code><a id=__codelineno-84-1 name=__codelineno-84-1 href=#__codelineno-84-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>file<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;dest=/tmp/test mode=755 owner=user group=user state=directory&quot;</span>
</code></pre></div> <p>删除文件或者目录</p> <div class=highlight><pre><span></span><code><a id=__codelineno-85-1 name=__codelineno-85-1 href=#__codelineno-85-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>file<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;dest=/tmp/test state=absent&quot;</span>
</code></pre></div> <p>创建软连接，并设置所属用户和用户组</p> <div class=highlight><pre><span></span><code><a id=__codelineno-86-1 name=__codelineno-86-1 href=#__codelineno-86-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>file<span class=w> </span>-a<span class=w>  </span><span class=s2>&quot;src=/file/to/link/to dest=/path/to/symlink owner=user group=user state=link&quot;</span>
</code></pre></div> <p>touch 一个文件并添加用户读写权限，用户组去除写执行权限，其他组减去读写执行权限</p> <div class=highlight><pre><span></span><code><a id=__codelineno-87-1 name=__codelineno-87-1 href=#__codelineno-87-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>file<span class=w> </span>-a<span class=w>  </span><span class=s2>&quot;path=/etc/foo.conf state=touch mode=&#39;u+rw,g-wx,o-rwx&#39;&quot;</span>
</code></pre></div> <h5 id=unarchive>unarchive<a class=headerlink href=#unarchive title="Permanent link">&para;</a></h5> <p>将本地的压缩文件解压到目标主机</p> <div class=highlight><pre><span></span><code><a id=__codelineno-88-1 name=__codelineno-88-1 href=#__codelineno-88-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>unarchive<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;src=foo.tgz dest=/opt/foo“</span>
</code></pre></div> <h5 id=stat>stat<a class=headerlink href=#stat title="Permanent link">&para;</a></h5> <p>获取远程文件状态信息，包括atime、ctime、mtime、md5、uid、gid等信息。</p> <p>例子 <div class=highlight><pre><span></span><code><a id=__codelineno-89-1 name=__codelineno-89-1 href=#__codelineno-89-1></a>ansible<span class=w> </span>webservers<span class=w> </span>-m<span class=w> </span>stat<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;path=/etc/sysctl.conf&quot;</span>
</code></pre></div></p> <h5 id=get_url>get_url<a class=headerlink href=#get_url title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-90-1 name=__codelineno-90-1 href=#__codelineno-90-1></a>功能：
<a id=__codelineno-90-2 name=__codelineno-90-2 href=#__codelineno-90-2></a>用于从http、ftp、https服务器上下载文件（类似于wget）
<a id=__codelineno-90-3 name=__codelineno-90-3 href=#__codelineno-90-3></a>
<a id=__codelineno-90-4 name=__codelineno-90-4 href=#__codelineno-90-4></a>
<a id=__codelineno-90-5 name=__codelineno-90-5 href=#__codelineno-90-5></a>参数：
<a id=__codelineno-90-6 name=__codelineno-90-6 href=#__codelineno-90-6></a>sha256sum：下载完成后进行sha256<span class=w> </span>check；
<a id=__codelineno-90-7 name=__codelineno-90-7 href=#__codelineno-90-7></a>timeout：下载超时时间，默认10s
<a id=__codelineno-90-8 name=__codelineno-90-8 href=#__codelineno-90-8></a>url：下载的URL
<a id=__codelineno-90-9 name=__codelineno-90-9 href=#__codelineno-90-9></a>url_password、url_username：主要用于需要用户名密码进行验证的情况
<a id=__codelineno-90-10 name=__codelineno-90-10 href=#__codelineno-90-10></a>use_proxy：是事使用代理，代理需事先在环境变更中定义
<a id=__codelineno-90-11 name=__codelineno-90-11 href=#__codelineno-90-11></a>
<a id=__codelineno-90-12 name=__codelineno-90-12 href=#__codelineno-90-12></a>例子：
<a id=__codelineno-90-13 name=__codelineno-90-13 href=#__codelineno-90-13></a>
<a id=__codelineno-90-14 name=__codelineno-90-14 href=#__codelineno-90-14></a>get_url:<span class=w> </span><span class=nv>url</span><span class=o>=</span>http://example.com/path/file.conf<span class=w> </span><span class=nv>dest</span><span class=o>=</span>/etc/foo.conf<span class=w> </span><span class=nv>mode</span><span class=o>=</span><span class=m>0440</span>
<a id=__codelineno-90-15 name=__codelineno-90-15 href=#__codelineno-90-15></a>
<a id=__codelineno-90-16 name=__codelineno-90-16 href=#__codelineno-90-16></a>
<a id=__codelineno-90-17 name=__codelineno-90-17 href=#__codelineno-90-17></a>get_url:<span class=w> </span><span class=nv>url</span><span class=o>=</span>http://example.com/path/file.conf<span class=w> </span><span class=nv>dest</span><span class=o>=</span>/etc/foo.conf<span class=w> </span><span class=nv>sha256sum</span><span class=o>=</span>b5bb9d8014a0f9b1d61e21e796d78dccdf1352f23cd32812f4850b878ae4944c
<a id=__codelineno-90-18 name=__codelineno-90-18 href=#__codelineno-90-18></a>
<a id=__codelineno-90-19 name=__codelineno-90-19 href=#__codelineno-90-19></a>ansible<span class=w> </span>webservers<span class=w> </span>-m<span class=w> </span>get_url<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;url=http：//www.baidu.com dest=/tmp/index.html mode=0440 force=yes&quot;</span>
</code></pre></div> <h4 id=管理软件包>管理软件包<a class=headerlink href=#管理软件包 title="Permanent link">&para;</a></h4> <p>apt、yum 模块分表用于管理Ubuntu 系列和RedHat 系列系统软件包</p> <h5 id=apt>apt<a class=headerlink href=#apt title="Permanent link">&para;</a></h5> <p>更新仓库缓存，并安装"foo"</p> <div class=highlight><pre><span></span><code><a id=__codelineno-91-1 name=__codelineno-91-1 href=#__codelineno-91-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>apt<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=foo update_cache=yes&quot;</span>
</code></pre></div> <p>删除 "foo" <div class=highlight><pre><span></span><code><a id=__codelineno-92-1 name=__codelineno-92-1 href=#__codelineno-92-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>apt<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=foo state=absent&quot;</span>
</code></pre></div></p> <p>安装 "foo" <div class=highlight><pre><span></span><code><a id=__codelineno-93-1 name=__codelineno-93-1 href=#__codelineno-93-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>apt<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=foo state=present&quot;</span>
</code></pre></div></p> <p>安装 1.0版本的 "foo" <div class=highlight><pre><span></span><code><a id=__codelineno-94-1 name=__codelineno-94-1 href=#__codelineno-94-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>apt<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=foo=1.00 state=present&quot;</span>
</code></pre></div></p> <p>安装最新得"foo" <div class=highlight><pre><span></span><code><a id=__codelineno-95-1 name=__codelineno-95-1 href=#__codelineno-95-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>apt<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=foo state=latest&quot;</span>
</code></pre></div></p> <p>注释：Ansible 支持很多操作系统的软件包管理，使用时-m 指定相应的软件包管理工具模块，如果没有这样的模块，可以自己定义类似的模块或者使用command 模块来安装软件包</p> <h5 id=yum>yum<a class=headerlink href=#yum title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-96-1 name=__codelineno-96-1 href=#__codelineno-96-1></a><span class=c1>#Manages packages with the `yum&#39; package manager 使用yum管理程序包</span>
<a id=__codelineno-96-2 name=__codelineno-96-2 href=#__codelineno-96-2></a>ARG：
<a id=__codelineno-96-3 name=__codelineno-96-3 href=#__codelineno-96-3></a><span class=w>    </span>name<span class=w>        </span><span class=c1>#软件包名称</span>
<a id=__codelineno-96-4 name=__codelineno-96-4 href=#__codelineno-96-4></a><span class=w>    </span>state<span class=w>       </span><span class=c1>#install(present or latest),remove(absten or removed)</span>
<a id=__codelineno-96-5 name=__codelineno-96-5 href=#__codelineno-96-5></a><span class=w>    </span>disable<span class=w>     </span><span class=c1>#禁用某个安装仓库</span>
<a id=__codelineno-96-6 name=__codelineno-96-6 href=#__codelineno-96-6></a><span class=w>    </span><span class=nb>enable</span><span class=w>      </span><span class=c1>#启用某个安装仓库</span>
<a id=__codelineno-96-7 name=__codelineno-96-7 href=#__codelineno-96-7></a><span class=w>    </span>disable_gpg_check<span class=w>   </span><span class=c1>#是否使用gpgcheck</span>
<a id=__codelineno-96-8 name=__codelineno-96-8 href=#__codelineno-96-8></a>
<a id=__codelineno-96-9 name=__codelineno-96-9 href=#__codelineno-96-9></a>example:
<a id=__codelineno-96-10 name=__codelineno-96-10 href=#__codelineno-96-10></a><span class=w>    </span>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>yum<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=nginx state=present&quot;</span>
</code></pre></div> <p>安装 最新的 Apache <div class=highlight><pre><span></span><code><a id=__codelineno-97-1 name=__codelineno-97-1 href=#__codelineno-97-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>yum<span class=w> </span>-a<span class=w>  </span><span class=s2>&quot;name=httpd state=latest&quot;</span>
</code></pre></div></p> <p>删除apache <div class=highlight><pre><span></span><code><a id=__codelineno-98-1 name=__codelineno-98-1 href=#__codelineno-98-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>yum<span class=w> </span>-a<span class=w>  </span><span class=s2>&quot;name=httpd state=absent&quot;</span>
</code></pre></div></p> <p>从testing 仓库中安装最后一个版本得apache <div class=highlight><pre><span></span><code><a id=__codelineno-99-1 name=__codelineno-99-1 href=#__codelineno-99-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>yum<span class=w> </span>-a<span class=w>  </span><span class=s2>&quot;name=httpd enablerepo=testing state=present&quot;</span>
</code></pre></div></p> <p>更新所有的包 <div class=highlight><pre><span></span><code><a id=__codelineno-100-1 name=__codelineno-100-1 href=#__codelineno-100-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>yum<span class=w> </span>-a<span class=w>  </span><span class=s2>&quot;name=* state=latest&quot;</span>
</code></pre></div></p> <p>安装远程的rpm包 <div class=highlight><pre><span></span><code><a id=__codelineno-101-1 name=__codelineno-101-1 href=#__codelineno-101-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>yum<span class=w> </span>-a<span class=w>  </span><span class=s2>&quot;name=http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm state=present&quot;</span>
</code></pre></div></p> <p>安装 'Development tools' 包组 <div class=highlight><pre><span></span><code><a id=__codelineno-102-1 name=__codelineno-102-1 href=#__codelineno-102-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>yum<span class=w> </span>-a<span class=w>  </span><span class=s2>&quot;name=&#39;@Development tools&#39; state=present&quot;</span>
</code></pre></div></p> <h5 id=package>package<a class=headerlink href=#package title="Permanent link">&para;</a></h5> <p>使用远程主机的包管理器进行安装，卸载，更新软件。相对于<code>apt</code>,<code>yum</code>而言，兼容性更好。</p> <p>安装ntpdate</p> <div class=highlight><pre><span></span><code><a id=__codelineno-103-1 name=__codelineno-103-1 href=#__codelineno-103-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>package<span class=w> </span>-a<span class=w>  </span><span class=s2>&quot;name=ntpdate stat=present&quot;</span>
</code></pre></div> <h4 id=用户和用户组>用户和用户组<a class=headerlink href=#用户和用户组 title="Permanent link">&para;</a></h4> <h5 id=user>user<a class=headerlink href=#user title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-104-1 name=__codelineno-104-1 href=#__codelineno-104-1></a><span class=c1>#Manage user accounts,管理用户账户</span>
<a id=__codelineno-104-2 name=__codelineno-104-2 href=#__codelineno-104-2></a>ARG：
<a id=__codelineno-104-3 name=__codelineno-104-3 href=#__codelineno-104-3></a><span class=w>    </span>comment<span class=w>     </span><span class=c1>#描述信息</span>
<a id=__codelineno-104-4 name=__codelineno-104-4 href=#__codelineno-104-4></a><span class=w>    </span>expires<span class=w>     </span><span class=c1>#过期时间</span>
<a id=__codelineno-104-5 name=__codelineno-104-5 href=#__codelineno-104-5></a><span class=w>    </span>group<span class=w>       </span><span class=c1>#基本组</span>
<a id=__codelineno-104-6 name=__codelineno-104-6 href=#__codelineno-104-6></a><span class=w>    </span>groups<span class=w>      </span><span class=c1>#附加组</span>
<a id=__codelineno-104-7 name=__codelineno-104-7 href=#__codelineno-104-7></a><span class=w>    </span>home<span class=w>        </span><span class=c1>#家目录路径</span>
<a id=__codelineno-104-8 name=__codelineno-104-8 href=#__codelineno-104-8></a><span class=w>    </span>password<span class=w>    </span><span class=c1>#密码</span>
<a id=__codelineno-104-9 name=__codelineno-104-9 href=#__codelineno-104-9></a><span class=w>    </span>shell<span class=w>       </span><span class=c1>#用户的shell</span>
<a id=__codelineno-104-10 name=__codelineno-104-10 href=#__codelineno-104-10></a><span class=w>    </span>state<span class=w>       </span><span class=c1>#present or absent 创建还是删除</span>
<a id=__codelineno-104-11 name=__codelineno-104-11 href=#__codelineno-104-11></a><span class=w>    </span>system<span class=w>      </span><span class=c1>#系统用户</span>
<a id=__codelineno-104-12 name=__codelineno-104-12 href=#__codelineno-104-12></a><span class=w>    </span>uid<span class=w>         </span><span class=c1>#用户id</span>
<a id=__codelineno-104-13 name=__codelineno-104-13 href=#__codelineno-104-13></a><span class=w>    </span>move_home<span class=w>   </span><span class=c1>#两次创建一个用户，家目录不是同一路径，是否需要直接移动家目录</span>
<a id=__codelineno-104-14 name=__codelineno-104-14 href=#__codelineno-104-14></a><span class=w>    </span>generate_ssh_key<span class=w>    </span><span class=c1>#创建用户时，是否同时生成一对秘钥</span>
<a id=__codelineno-104-15 name=__codelineno-104-15 href=#__codelineno-104-15></a><span class=w>    </span>create_home<span class=w> </span><span class=c1>#当创建用户或者家目录不存在时，是否为用户创建家目录</span>
<a id=__codelineno-104-16 name=__codelineno-104-16 href=#__codelineno-104-16></a>
<a id=__codelineno-104-17 name=__codelineno-104-17 href=#__codelineno-104-17></a>example：
<a id=__codelineno-104-18 name=__codelineno-104-18 href=#__codelineno-104-18></a><span class=w>    </span>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>user<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=aa uid=5555 state=present shell=/sbin/nologin create_home=no&quot;</span>
</code></pre></div> <p>添加用户 'user'并设置其 uid 和主要的组'admin' <div class=highlight><pre><span></span><code><a id=__codelineno-105-1 name=__codelineno-105-1 href=#__codelineno-105-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>user<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=user comment=&#39;I am user&#39; uid=1040 group=admin&quot;</span>
</code></pre></div></p> <p>添加用户 'user'并设置其登陆shell，并将其假如admins和developers组 <div class=highlight><pre><span></span><code><a id=__codelineno-106-1 name=__codelineno-106-1 href=#__codelineno-106-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>user<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=user shell=/bin/bash groups=admins,developers append=yes&quot;</span>
</code></pre></div></p> <p>删除用户 'user' <div class=highlight><pre><span></span><code><a id=__codelineno-107-1 name=__codelineno-107-1 href=#__codelineno-107-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>user<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=user state=absent remove=yes&quot;</span>
</code></pre></div></p> <p>创建 user 用户得 2048-bit SSH key，并存放在 ~user/.ssh/id_rsa <div class=highlight><pre><span></span><code><a id=__codelineno-108-1 name=__codelineno-108-1 href=#__codelineno-108-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>user<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=user generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=.ssh/id_rsa&quot;</span>
</code></pre></div></p> <p>设置用户过期日期 <div class=highlight><pre><span></span><code><a id=__codelineno-109-1 name=__codelineno-109-1 href=#__codelineno-109-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>user<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=user shell=/bin/zsh groups=nobdy expires=1422403387&quot;</span>
</code></pre></div></p> <h5 id=group>group<a class=headerlink href=#group title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-110-1 name=__codelineno-110-1 href=#__codelineno-110-1></a><span class=c1>#该模块用于添加或者删除一个group</span>
<a id=__codelineno-110-2 name=__codelineno-110-2 href=#__codelineno-110-2></a>ARG：
<a id=__codelineno-110-3 name=__codelineno-110-3 href=#__codelineno-110-3></a><span class=w>    </span>gid<span class=w>         </span><span class=c1>#set group id</span>
<a id=__codelineno-110-4 name=__codelineno-110-4 href=#__codelineno-110-4></a><span class=w>    </span><span class=nv>name</span><span class=o>=</span><span class=w>       </span><span class=c1>#set group name</span>
<a id=__codelineno-110-5 name=__codelineno-110-5 href=#__codelineno-110-5></a><span class=w>    </span>state<span class=w>       </span><span class=c1>#set group state;the values is &quot;present&quot; or &quot;absent&quot;</span>
<a id=__codelineno-110-6 name=__codelineno-110-6 href=#__codelineno-110-6></a><span class=w>    </span>system<span class=w>      </span><span class=c1>#if &quot;yes&quot;,indicates that the group create is system group</span>
<a id=__codelineno-110-7 name=__codelineno-110-7 href=#__codelineno-110-7></a>
<a id=__codelineno-110-8 name=__codelineno-110-8 href=#__codelineno-110-8></a>example:
<a id=__codelineno-110-9 name=__codelineno-110-9 href=#__codelineno-110-9></a><span class=w>    </span><span class=m>1</span>.ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>group<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;gid=3000 name=mygroup state=present system=no&quot;</span>
<a id=__codelineno-110-10 name=__codelineno-110-10 href=#__codelineno-110-10></a><span class=w>    </span><span class=c1>#创建一个gid为3000 名称为mygroup的组</span>
<a id=__codelineno-110-11 name=__codelineno-110-11 href=#__codelineno-110-11></a>
<a id=__codelineno-110-12 name=__codelineno-110-12 href=#__codelineno-110-12></a><span class=w>    </span><span class=m>2</span>.ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>group<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;gid=3000 name=mygroup state=absent system=no&quot;</span>
<a id=__codelineno-110-13 name=__codelineno-110-13 href=#__codelineno-110-13></a><span class=w>    </span><span class=c1>#删除一个gid为3000 名称为mygroup的组</span>
<a id=__codelineno-110-14 name=__codelineno-110-14 href=#__codelineno-110-14></a>
<a id=__codelineno-110-15 name=__codelineno-110-15 href=#__codelineno-110-15></a>注意:带等号为必填
</code></pre></div> <p>创建 test 组，并设置 gid 为1000 <div class=highlight><pre><span></span><code><a id=__codelineno-111-1 name=__codelineno-111-1 href=#__codelineno-111-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>group<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=test gid=1000 state=present&quot;</span>
</code></pre></div></p> <p>删除 test 组 <div class=highlight><pre><span></span><code><a id=__codelineno-112-1 name=__codelineno-112-1 href=#__codelineno-112-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>group<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=test state=absent&quot;</span>
</code></pre></div></p> <h4 id=版本控制>版本控制<a class=headerlink href=#版本控制 title="Permanent link">&para;</a></h4> <h5 id=git>git<a class=headerlink href=#git title="Permanent link">&para;</a></h5> <p>Ansible 模块能够通知变更，当代码更新时，可以告诉 Ansible 做一些特定的任务，比如从git 部署代码然后重启 apache 服务等 <div class=highlight><pre><span></span><code><a id=__codelineno-113-1 name=__codelineno-113-1 href=#__codelineno-113-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>git<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;repo=https://github.com/Icinga/icinga2.git dest=/tmp/myapp   version=HEAD&quot;</span>
</code></pre></div></p> <h4 id=服务管理>服务管理<a class=headerlink href=#服务管理 title="Permanent link">&para;</a></h4> <h5 id=service>service<a class=headerlink href=#service title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-114-1 name=__codelineno-114-1 href=#__codelineno-114-1></a><span class=c1>#Manage services</span>
<a id=__codelineno-114-2 name=__codelineno-114-2 href=#__codelineno-114-2></a>ARG：
<a id=__codelineno-114-3 name=__codelineno-114-3 href=#__codelineno-114-3></a><span class=w>    </span><span class=nb>enable</span><span class=w>      </span><span class=c1>#开机自启</span>
<a id=__codelineno-114-4 name=__codelineno-114-4 href=#__codelineno-114-4></a><span class=w>    </span>name<span class=w>        </span><span class=c1>#服务名称</span>
<a id=__codelineno-114-5 name=__codelineno-114-5 href=#__codelineno-114-5></a><span class=w>    </span>pattern<span class=w>     </span><span class=c1>#服务不支持status，无法获取服务状态信息时，可以使用pattern过滤关键字</span>
<a id=__codelineno-114-6 name=__codelineno-114-6 href=#__codelineno-114-6></a><span class=w>    </span>runlevel<span class=w>    </span><span class=c1>#启动级别</span>
<a id=__codelineno-114-7 name=__codelineno-114-7 href=#__codelineno-114-7></a><span class=w>    </span>state<span class=w>       </span><span class=c1>#设置服务是启动还是停止，reloaded, restarted, started, stopped</span>
<a id=__codelineno-114-8 name=__codelineno-114-8 href=#__codelineno-114-8></a>
<a id=__codelineno-114-9 name=__codelineno-114-9 href=#__codelineno-114-9></a>example：
<a id=__codelineno-114-10 name=__codelineno-114-10 href=#__codelineno-114-10></a><span class=w>    </span>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>service<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=nginx state=started &quot;</span>
</code></pre></div> <p>确保 web 组所有主机的 httpd 是启动的 <div class=highlight><pre><span></span><code><a id=__codelineno-115-1 name=__codelineno-115-1 href=#__codelineno-115-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>service<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=httpd state=started&quot;</span>
</code></pre></div></p> <p>重启 web 组所有主机的httpd 服务 <div class=highlight><pre><span></span><code><a id=__codelineno-116-1 name=__codelineno-116-1 href=#__codelineno-116-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>service<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=httpd state=restarted&quot;</span>
</code></pre></div></p> <p>确保web组所有主机的httpd 是关闭的 <div class=highlight><pre><span></span><code><a id=__codelineno-117-1 name=__codelineno-117-1 href=#__codelineno-117-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>service<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=httpd state=stopped&quot;</span>
</code></pre></div></p> <h5 id=systemd>systemd<a class=headerlink href=#systemd title="Permanent link">&para;</a></h5> <p>启动服务</p> <div class=highlight><pre><span></span><code><a id=__codelineno-118-1 name=__codelineno-118-1 href=#__codelineno-118-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>systemd<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;state=started name=httpd&quot;</span>
</code></pre></div> <p>重载配置</p> <div class=highlight><pre><span></span><code><a id=__codelineno-119-1 name=__codelineno-119-1 href=#__codelineno-119-1></a>ansible<span class=w> </span>web<span class=w> </span>-m<span class=w> </span>systemd<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;daemon_reload=yes&quot;</span>
</code></pre></div> <h4 id=防火墙管理>防火墙管理<a class=headerlink href=#防火墙管理 title="Permanent link">&para;</a></h4> <h5 id=iptables>iptables<a class=headerlink href=#iptables title="Permanent link">&para;</a></h5> <p>允许tcp 22端口通过 <div class=highlight><pre><span></span><code><a id=__codelineno-120-1 name=__codelineno-120-1 href=#__codelineno-120-1></a>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>iptables<span class=w>  </span>-a<span class=w> </span><span class=s2>&quot;chain=INPUT destination_port=22 protocol=tcp jump=ACCEPT&quot;</span>
</code></pre></div></p> <h5 id=firewalld>firewalld<a class=headerlink href=#firewalld title="Permanent link">&para;</a></h5> <p>运行https端口通过</p> <div class=highlight><pre><span></span><code><a id=__codelineno-121-1 name=__codelineno-121-1 href=#__codelineno-121-1></a>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>firewalld<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;service=https permanent=yes state=enabled&quot;</span>
</code></pre></div> <h4 id=文件内容操作>文件内容操作<a class=headerlink href=#文件内容操作 title="Permanent link">&para;</a></h4> <h5 id=lineinfile>lineinfile<a class=headerlink href=#lineinfile title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-122-1 name=__codelineno-122-1 href=#__codelineno-122-1></a>功能：
<a id=__codelineno-122-2 name=__codelineno-122-2 href=#__codelineno-122-2></a>lineinfile模块用于替换文本内容和删除文本内容
<a id=__codelineno-122-3 name=__codelineno-122-3 href=#__codelineno-122-3></a>
<a id=__codelineno-122-4 name=__codelineno-122-4 href=#__codelineno-122-4></a>参数：
<a id=__codelineno-122-5 name=__codelineno-122-5 href=#__codelineno-122-5></a>path<span class=w>         </span>指定要操作的文件对象<span class=w> </span>
<a id=__codelineno-122-6 name=__codelineno-122-6 href=#__codelineno-122-6></a>dest<span class=w>         </span>指定要操作的文件对象
<a id=__codelineno-122-7 name=__codelineno-122-7 href=#__codelineno-122-7></a>regexp<span class=w>       </span>使用正则表达式（匹配条件，用于替换文件内容使用）
<a id=__codelineno-122-8 name=__codelineno-122-8 href=#__codelineno-122-8></a>state<span class=w>        </span>当需要删除对应文本时，需要设置state值absent,absent为缺席之意，表示删除，默认值present
<a id=__codelineno-122-9 name=__codelineno-122-9 href=#__codelineno-122-9></a>insertbefore<span class=w> </span>在某行之前插入
<a id=__codelineno-122-10 name=__codelineno-122-10 href=#__codelineno-122-10></a>insertafter<span class=w>  </span>在莫行之后插入
<a id=__codelineno-122-11 name=__codelineno-122-11 href=#__codelineno-122-11></a>line<span class=w>         </span>要写入文件的内容
<a id=__codelineno-122-12 name=__codelineno-122-12 href=#__codelineno-122-12></a>
<a id=__codelineno-122-13 name=__codelineno-122-13 href=#__codelineno-122-13></a>例子：
<a id=__codelineno-122-14 name=__codelineno-122-14 href=#__codelineno-122-14></a><span class=c1># 在文件末行插入文件</span>
<a id=__codelineno-122-15 name=__codelineno-122-15 href=#__codelineno-122-15></a>ansible<span class=w> </span><span class=o>[</span>清单<span class=o>]</span><span class=w> </span>-m<span class=w> </span>lineinfile<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;path=/root/test.txt insertafter=&quot;EOF&quot; line=&quot;1&quot;&#39;</span>
<a id=__codelineno-122-16 name=__codelineno-122-16 href=#__codelineno-122-16></a>
<a id=__codelineno-122-17 name=__codelineno-122-17 href=#__codelineno-122-17></a><span class=c1># 在文件首行插入文件</span>
<a id=__codelineno-122-18 name=__codelineno-122-18 href=#__codelineno-122-18></a>ansible<span class=w> </span><span class=o>[</span>清单<span class=o>]</span><span class=w> </span>-m<span class=w> </span>lineinfile<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;path=/root/test.txt insertbefore=&quot;BOF&quot; line=&quot;1&quot; state=present&#39;</span>
<a id=__codelineno-122-19 name=__codelineno-122-19 href=#__codelineno-122-19></a>
<a id=__codelineno-122-20 name=__codelineno-122-20 href=#__codelineno-122-20></a><span class=c1># 替换某行内容</span>
<a id=__codelineno-122-21 name=__codelineno-122-21 href=#__codelineno-122-21></a>ansible<span class=w> </span><span class=o>[</span>清单<span class=o>]</span><span class=w> </span>-m<span class=w> </span>lineinfile<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;path=/root/test.txt regexp=5 line=1&#39;</span>
<a id=__codelineno-122-22 name=__codelineno-122-22 href=#__codelineno-122-22></a>
<a id=__codelineno-122-23 name=__codelineno-122-23 href=#__codelineno-122-23></a><span class=c1># 删除某行内容</span>
<a id=__codelineno-122-24 name=__codelineno-122-24 href=#__codelineno-122-24></a>ansible<span class=w> </span><span class=o>[</span>清单<span class=o>]</span><span class=w> </span>-m<span class=w> </span>lineinfile<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;path=/root/test.txt regexp=&quot;1&quot; state=absent&#39;</span>
</code></pre></div> <p>开启selinux， 替换以SELINUX=开头的行，如果没有匹配到，则新增一条数据。 <div class=highlight><pre><span></span><code><a id=__codelineno-123-1 name=__codelineno-123-1 href=#__codelineno-123-1></a>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>lineinfile<span class=w>  </span>-a<span class=w> </span><span class=s2>&quot;dest=/etc/selinux/config regexp=^SELINUX= line=SELINUX=enforcing&quot;</span>
</code></pre></div></p> <p>删除以SELINUX=开头的行 <div class=highlight><pre><span></span><code><a id=__codelineno-124-1 name=__codelineno-124-1 href=#__codelineno-124-1></a>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>lineinfile<span class=w>  </span>-a<span class=w> </span><span class=s2>&quot;dest=/tmp/config regexp=^SELINUX= state=absent&quot;</span>
</code></pre></div></p> <p>如果文件中, line值不存在，则向文件中添加line的内容 <div class=highlight><pre><span></span><code><a id=__codelineno-125-1 name=__codelineno-125-1 href=#__codelineno-125-1></a>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>lineinfile<span class=w>  </span>-a<span class=w> </span><span class=s2>&quot;dest=/tmp/config  line=&#39;test&#39;&quot;</span>
</code></pre></div></p> <h5 id=replace>replace<a class=headerlink href=#replace title="Permanent link">&para;</a></h5> <p>替换文件内容</p> <div class=highlight><pre><span></span><code><a id=__codelineno-126-1 name=__codelineno-126-1 href=#__codelineno-126-1></a>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w>  </span>replace<span class=w>  </span>-a<span class=w> </span><span class=s2>&quot;dest=/etc/selinux/config regexp=^SELINUX=disabled replace=SELINUX=enforcing&quot;</span>
</code></pre></div> <h4 id=定时任务>定时任务<a class=headerlink href=#定时任务 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-127-1 name=__codelineno-127-1 href=#__codelineno-127-1></a><span class=w> </span><span class=c1>#Manage cron.d and crontab entries管理cron.d和contab条目</span>
<a id=__codelineno-127-2 name=__codelineno-127-2 href=#__codelineno-127-2></a><span class=w> </span>ARG：
<a id=__codelineno-127-3 name=__codelineno-127-3 href=#__codelineno-127-3></a><span class=w>    </span>day<span class=w>         </span><span class=c1>#天</span>
<a id=__codelineno-127-4 name=__codelineno-127-4 href=#__codelineno-127-4></a><span class=w>    </span>hour<span class=w>        </span><span class=c1>#小时</span>
<a id=__codelineno-127-5 name=__codelineno-127-5 href=#__codelineno-127-5></a><span class=w>    </span>minute<span class=w>      </span><span class=c1>#分钟</span>
<a id=__codelineno-127-6 name=__codelineno-127-6 href=#__codelineno-127-6></a><span class=w>    </span>job<span class=w>         </span><span class=c1>#执行指令</span>
<a id=__codelineno-127-7 name=__codelineno-127-7 href=#__codelineno-127-7></a><span class=w>    </span>name<span class=w>        </span><span class=c1>#任务名</span>
<a id=__codelineno-127-8 name=__codelineno-127-8 href=#__codelineno-127-8></a><span class=w>    </span>state<span class=w>       </span><span class=c1>#present or absent</span>
<a id=__codelineno-127-9 name=__codelineno-127-9 href=#__codelineno-127-9></a><span class=w>    </span>user<span class=w>        </span><span class=c1>#执行任务的用户</span>
<a id=__codelineno-127-10 name=__codelineno-127-10 href=#__codelineno-127-10></a><span class=w>    </span>weekday<span class=w>     </span><span class=c1>#星期</span>
<a id=__codelineno-127-11 name=__codelineno-127-11 href=#__codelineno-127-11></a>
<a id=__codelineno-127-12 name=__codelineno-127-12 href=#__codelineno-127-12></a><span class=w> </span>example：
<a id=__codelineno-127-13 name=__codelineno-127-13 href=#__codelineno-127-13></a><span class=w>    </span>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>cron<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;name=&quot;sync time&quot; minute=*/1 job=&quot;/usr/sbin/ntpdate 192.168.10.11 &amp;&gt; /dev/null&quot; state=present&#39;</span>
</code></pre></div> <p>每天5点，2点得时候执行 ls -alh &gt; /dev/null</p> <div class=highlight><pre><span></span><code><a id=__codelineno-128-1 name=__codelineno-128-1 href=#__codelineno-128-1></a>ansible<span class=w> </span><span class=nb>test</span><span class=w> </span>-m<span class=w> </span>cron<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;name=&#39;check dirs&#39; minute=&#39;0&#39; hour=&#39;5,2&#39; job=&#39;ls -alh &gt; /dev/null&#39;&quot;</span>
</code></pre></div> <h4 id=搜集系统信息>搜集系统信息<a class=headerlink href=#搜集系统信息 title="Permanent link">&para;</a></h4> <p>搜集主机的所有系统信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-129-1 name=__codelineno-129-1 href=#__codelineno-129-1></a>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>setup
</code></pre></div> <p>搜集系统信息并以主机名为文件名分别保存在/tmp/facts 目录</p> <div class=highlight><pre><span></span><code><a id=__codelineno-130-1 name=__codelineno-130-1 href=#__codelineno-130-1></a>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>setup<span class=w> </span>--tree<span class=w> </span>/tmp/facts
</code></pre></div> <p>搜集和内存相关的信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-131-1 name=__codelineno-131-1 href=#__codelineno-131-1></a>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>setup<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;filter=ansible_*_mb&#39;</span>
</code></pre></div> <p>搜集网卡信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-132-1 name=__codelineno-132-1 href=#__codelineno-132-1></a>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>setup<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;filter=ansible_eth[0-2]&#39;</span>
</code></pre></div> <h4 id=指定连接方式>指定连接方式<a class=headerlink href=#指定连接方式 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-133-1 name=__codelineno-133-1 href=#__codelineno-133-1></a>ansible<span class=w> </span>all<span class=w> </span>-i<span class=w> </span><span class=s1>&#39;centos,&#39;</span><span class=w> </span>-c<span class=w> </span>docker<span class=w> </span>-m<span class=w> </span>shell<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;ps aux&#39;</span>
<a id=__codelineno-133-2 name=__codelineno-133-2 href=#__codelineno-133-2></a>ansible<span class=w> </span>all<span class=w> </span>-i<span class=w> </span><span class=s1>&#39;centos,&#39;</span><span class=w> </span>-c<span class=w> </span><span class=nb>local</span><span class=w> </span>-m<span class=w> </span>shell<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;ifconfig&#39;</span>
</code></pre></div> <h4 id=后台运行>后台运行<a class=headerlink href=#后台运行 title="Permanent link">&para;</a></h4> <p>长时间运行的操作可以放到后台执行，ansible 会检查任务的状态；在主机上执行的同一个任</p> <p>务会分配同一个job ID</p> <p>后台执行命令3600s，-B 表示后台执行的时间</p> <div class=highlight><pre><span></span><code><a id=__codelineno-134-1 name=__codelineno-134-1 href=#__codelineno-134-1></a>ansible<span class=w> </span>all<span class=w> </span>-B<span class=w> </span><span class=m>3600</span><span class=w> </span>-a<span class=w> </span><span class=s2>&quot;/usr/bin/long_running_operation --do-stuff&quot;</span>
</code></pre></div> <p><strong>检查任务的状态</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-135-1 name=__codelineno-135-1 href=#__codelineno-135-1></a>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>async_status<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;jid=123456789&quot;</span>
</code></pre></div> <p>后台执行命令最大时间是1800s 即30 分钟，-P 每60s 检查下状态默认15s</p> <div class=highlight><pre><span></span><code><a id=__codelineno-136-1 name=__codelineno-136-1 href=#__codelineno-136-1></a>ansible<span class=w> </span>all<span class=w> </span>-B<span class=w> </span><span class=m>1800</span><span class=w> </span>-P<span class=w> </span><span class=m>60</span><span class=w> </span>-a<span class=w> </span><span class=s2>&quot;/usr/bin/long_running_operation --do-stuff&quot;</span>
</code></pre></div> <h3 id=练习>练习<a class=headerlink href=#练习 title="Permanent link">&para;</a></h3> <p>大家通过下列命令来查看帮助，练习下表格中常用模块的使用。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-137-1 name=__codelineno-137-1 href=#__codelineno-137-1></a>ansible-doc<span class=w> </span>file
</code></pre></div> <table> <thead> <tr> <th>类型</th> <th>模块</th> </tr> </thead> <tbody> <tr> <td>文件操作</td> <td>stat find file lineinfile blockinfile template replace</td> </tr> <tr> <td>包管理</td> <td>apt gem npm pip yum package easy_install rpm_key</td> </tr> <tr> <td>传输</td> <td>fetch copy unarchive get_url</td> </tr> <tr> <td>用户组</td> <td>user group</td> </tr> <tr> <td>文件包含</td> <td>import_tasks include_tasks include_vars</td> </tr> <tr> <td>mysql数据库</td> <td>mysql_db mysql_replication mysql_user</td> </tr> <tr> <td>服务</td> <td>service systemd supervisorctl</td> </tr> <tr> <td>检查</td> <td>uri wait_for</td> </tr> <tr> <td>其他</td> <td>debug fail selinux set_fact sysctl authorized_key</td> </tr> </tbody> </table> <h2 id=7熟悉ansible命令>7.熟悉ansible命令<a class=headerlink href=#7熟悉ansible命令 title="Permanent link">&para;</a></h2> <p>本文以 <strong>Ansible</strong> 版本 <code>2.9.6</code>为准</p> <h3 id=ansible>ansible<a class=headerlink href=#ansible title="Permanent link">&para;</a></h3> <p><code>ansible</code>命令是 <strong>Ansible</strong> 的核心部分，其主要用于执行ad-hoc命令，即单条命令。默认后面需要跟主机和选项部分，默认不指定模块时，使用的是command模块。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-138-1 name=__codelineno-138-1 href=#__codelineno-138-1></a><span class=c1># ansible --help</span>
<a id=__codelineno-138-2 name=__codelineno-138-2 href=#__codelineno-138-2></a>usage:<span class=w> </span>ansible<span class=w> </span><span class=o>[</span>-h<span class=o>]</span><span class=w> </span><span class=o>[</span>--version<span class=o>]</span><span class=w> </span><span class=o>[</span>-v<span class=o>]</span><span class=w> </span><span class=o>[</span>-b<span class=o>]</span><span class=w> </span><span class=o>[</span>--become-method<span class=w> </span>BECOME_METHOD<span class=o>]</span>
<a id=__codelineno-138-3 name=__codelineno-138-3 href=#__codelineno-138-3></a><span class=w>               </span><span class=o>[</span>--become-user<span class=w> </span>BECOME_USER<span class=o>]</span><span class=w> </span><span class=o>[</span>-K<span class=o>]</span><span class=w> </span><span class=o>[</span>-i<span class=w> </span>INVENTORY<span class=o>]</span><span class=w> </span><span class=o>[</span>--list-hosts<span class=o>]</span>
<a id=__codelineno-138-4 name=__codelineno-138-4 href=#__codelineno-138-4></a><span class=w>               </span><span class=o>[</span>-l<span class=w> </span>SUBSET<span class=o>]</span><span class=w> </span><span class=o>[</span>-P<span class=w> </span>POLL_INTERVAL<span class=o>]</span><span class=w> </span><span class=o>[</span>-B<span class=w> </span>SECONDS<span class=o>]</span><span class=w> </span><span class=o>[</span>-o<span class=o>]</span><span class=w> </span><span class=o>[</span>-t<span class=w> </span>TREE<span class=o>]</span><span class=w> </span><span class=o>[</span>-k<span class=o>]</span>
<a id=__codelineno-138-5 name=__codelineno-138-5 href=#__codelineno-138-5></a><span class=w>               </span><span class=o>[</span>--private-key<span class=w> </span>PRIVATE_KEY_FILE<span class=o>]</span><span class=w> </span><span class=o>[</span>-u<span class=w> </span>REMOTE_USER<span class=o>]</span>
<a id=__codelineno-138-6 name=__codelineno-138-6 href=#__codelineno-138-6></a><span class=w>               </span><span class=o>[</span>-c<span class=w> </span>CONNECTION<span class=o>]</span><span class=w> </span><span class=o>[</span>-T<span class=w> </span>TIMEOUT<span class=o>]</span>
<a id=__codelineno-138-7 name=__codelineno-138-7 href=#__codelineno-138-7></a><span class=w>               </span><span class=o>[</span>--ssh-common-args<span class=w> </span>SSH_COMMON_ARGS<span class=o>]</span>
<a id=__codelineno-138-8 name=__codelineno-138-8 href=#__codelineno-138-8></a><span class=w>               </span><span class=o>[</span>--sftp-extra-args<span class=w> </span>SFTP_EXTRA_ARGS<span class=o>]</span>
<a id=__codelineno-138-9 name=__codelineno-138-9 href=#__codelineno-138-9></a><span class=w>               </span><span class=o>[</span>--scp-extra-args<span class=w> </span>SCP_EXTRA_ARGS<span class=o>]</span>
<a id=__codelineno-138-10 name=__codelineno-138-10 href=#__codelineno-138-10></a><span class=w>               </span><span class=o>[</span>--ssh-extra-args<span class=w> </span>SSH_EXTRA_ARGS<span class=o>]</span><span class=w> </span><span class=o>[</span>-C<span class=o>]</span><span class=w> </span><span class=o>[</span>--syntax-check<span class=o>]</span><span class=w> </span><span class=o>[</span>-D<span class=o>]</span>
<a id=__codelineno-138-11 name=__codelineno-138-11 href=#__codelineno-138-11></a><span class=w>               </span><span class=o>[</span>-e<span class=w> </span>EXTRA_VARS<span class=o>]</span><span class=w> </span><span class=o>[</span>--vault-id<span class=w> </span>VAULT_IDS<span class=o>]</span>
<a id=__codelineno-138-12 name=__codelineno-138-12 href=#__codelineno-138-12></a><span class=w>               </span><span class=o>[</span>--ask-vault-pass<span class=w> </span><span class=p>|</span><span class=w> </span>--vault-password-file<span class=w> </span>VAULT_PASSWORD_FILES<span class=o>]</span>
<a id=__codelineno-138-13 name=__codelineno-138-13 href=#__codelineno-138-13></a><span class=w>               </span><span class=o>[</span>-f<span class=w> </span>FORKS<span class=o>]</span><span class=w> </span><span class=o>[</span>-M<span class=w> </span>MODULE_PATH<span class=o>]</span><span class=w> </span><span class=o>[</span>--playbook-dir<span class=w> </span>BASEDIR<span class=o>]</span>
<a id=__codelineno-138-14 name=__codelineno-138-14 href=#__codelineno-138-14></a><span class=w>               </span><span class=o>[</span>-a<span class=w> </span>MODULE_ARGS<span class=o>]</span><span class=w> </span><span class=o>[</span>-m<span class=w> </span>MODULE_NAME<span class=o>]</span>
<a id=__codelineno-138-15 name=__codelineno-138-15 href=#__codelineno-138-15></a><span class=w>               </span>pattern
</code></pre></div> <p><strong>位置参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>pattern</td> <td>主机匹配</td> </tr> </tbody> </table> <p><strong>选项参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>--ask-vault-pass</td> <td>提示输入vault 密码。</td> </tr> <tr> <td>--list-hosts</td> <td>输出匹配主机的列表。</td> </tr> <tr> <td>--playbook-dir BASEDIR</td> <td>指定playbook目录，为<code>role</code>,<code>group_vars/etc</code>指定相对路径</td> </tr> <tr> <td>--syntax-check</td> <td>对playbook进行语法检查，且不执行playbook。</td> </tr> <tr> <td>--vault-id=VAULT_IDS</td> <td>标识使用的vault id</td> </tr> <tr> <td>--vault-password-file=VAULT_PASSWORD_FILE</td> <td>指定vault密码文件</td> </tr> <tr> <td>--version</td> <td>显示程序版本信息</td> </tr> <tr> <td>-B SECONDS, --background SECONDS</td> <td>异步运行时，多长时间超时。</td> </tr> <tr> <td>-C, --check</td> <td>只是测试一下会改变什么内容，不会真正去执行;相反,试图预测一些可能发生的变化。</td> </tr> <tr> <td>-D, --diff</td> <td>当更改文件和模板时，显示这些文件得差异，比--check效果好。</td> </tr> <tr> <td>-M MODULE_PATH, --module-path MODULE_PATH</td> <td>要执行的模块的路径，默认路径<code>~/.ansible/plugins/modules:/usr/share/ansible/plu&lt;br/&gt; gins/modules)</code></td> </tr> <tr> <td>-P POLL_INTERVAL, --poll POLL_INTERVAL</td> <td>设置轮询间隔，默认15秒</td> </tr> <tr> <td>-a MODULE_ARGS, --args MODULE_ARGS</td> <td>指定模块参数</td> </tr> <tr> <td>-e EXTRA_VARS, --extra-vars EXTRA_VARS</td> <td>添加附加变量，比如key=value，yaml，json格式。使用<code>@</code>指定文件</td> </tr> <tr> <td>-f FORKS, --forks FORKS</td> <td>指定定要使用的并行进程数，默认为5个。</td> </tr> <tr> <td>-h, --help</td> <td>显示此帮助信息。</td> </tr> <tr> <td>-i INVENTORY, --inventory INVENTORY, --inventory-file INVENTORY</td> <td>指定主机清单文件或逗号分隔的主机，默认为/etc/ansible/hosts。</td> </tr> <tr> <td>-l SUBSET, --limit SUBSET</td> <td>进一步限制所选主机/组模式，只执行<code>-l</code>后的主机和组。</td> </tr> <tr> <td>-m MODULE_NAME, --module-name MODULE_NAME</td> <td>要执行的模块，默认为command。</td> </tr> <tr> <td>-o, --one-line</td> <td>压缩输出，尝试将所有内容都在一行上输出。</td> </tr> <tr> <td>-t TREE, --tree</td> <td>指定tree的输出目录</td> </tr> <tr> <td>-v, --verbose</td> <td>输出执行的详细信息，使用-vvv获得更多，-vvvv 启用连接调试</td> </tr> </tbody> </table> <p><strong>特权升级选项</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>--become-method=BECOME_METHOD</td> <td>权限升级方法使用 ，默认为sudo，有效选择：[sudo | su | pbrun | pfexec | runas | doas | dzdo]</td> </tr> <tr> <td>--become-user=BECOME_USER</td> <td>使用哪个用户运行，默认为root</td> </tr> <tr> <td>-K, --ask-become-pass</td> <td>提供权限提升密码</td> </tr> <tr> <td>-b, --become</td> <td>运行权限提升</td> </tr> </tbody> </table> <p><strong>连接选项</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>--private-key=PRIVATE_KEY_FILE, --key-file=PRIVATE_KEY_FILE</td> <td>私钥路径，使用这个文件来验证连接</td> </tr> <tr> <td>--scp-extra-args SCP_EXTRA_ARGS</td> <td>指定额外的参数传递给<code>scp</code> ，例如<code>-l</code></td> </tr> <tr> <td>--sftp-extra-args SFTP_EXTRA_ARGS</td> <td>指定额外的参数传递给<code>sftp</code> ，例如<code>-f</code></td> </tr> <tr> <td>--ssh-common-args SSH_COMMON_ARGS</td> <td>指定要传递给sftp / scp / ssh的通用参数（例如 ProxyCommand）</td> </tr> <tr> <td>--ssh-extra-args SSH_EXTRA_ARGS</td> <td>指定额外的参数传递给<code>ssh</code> ，例如<code>-R</code></td> </tr> <tr> <td>-T TIMEOUT, --timeout=TIMEOUT</td> <td>指定默认超时时间，默认是10S</td> </tr> <tr> <td>-c CONNECTION, --connection=CONNECTION</td> <td>指定连接类型，默认smart</td> </tr> <tr> <td>-k, --ask-pass</td> <td>要求用户输入请求连接密码</td> </tr> <tr> <td>-u REMOTE_USER, --user=REMOTE_USER</td> <td>指定连接用户</td> </tr> </tbody> </table> <p><strong>示例</strong>：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-139-1 name=__codelineno-139-1 href=#__codelineno-139-1></a>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>ping
<a id=__codelineno-139-2 name=__codelineno-139-2 href=#__codelineno-139-2></a>
<a id=__codelineno-139-3 name=__codelineno-139-3 href=#__codelineno-139-3></a>ansible<span class=w> </span><span class=m>192</span>.168.77.*<span class=w> </span>-m<span class=w> </span>ping
<a id=__codelineno-139-4 name=__codelineno-139-4 href=#__codelineno-139-4></a>
<a id=__codelineno-139-5 name=__codelineno-139-5 href=#__codelineno-139-5></a>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span><span class=nb>command</span><span class=w> </span>-a<span class=w> </span>ifconfig
<a id=__codelineno-139-6 name=__codelineno-139-6 href=#__codelineno-139-6></a>
<a id=__codelineno-139-7 name=__codelineno-139-7 href=#__codelineno-139-7></a>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>shell<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;ifconfig eth0 |grep &#39;inet addr&#39; &quot;</span>
<a id=__codelineno-139-8 name=__codelineno-139-8 href=#__codelineno-139-8></a>
<a id=__codelineno-139-9 name=__codelineno-139-9 href=#__codelineno-139-9></a>ansible<span class=w> </span>-i<span class=w> </span><span class=s2>&quot;192.168.77.129,192.168.77.130&quot;</span><span class=w> </span><span class=m>192</span>.168.77.129<span class=w>  </span>-m<span class=w> </span>ping
<a id=__codelineno-139-10 name=__codelineno-139-10 href=#__codelineno-139-10></a>
<a id=__codelineno-139-11 name=__codelineno-139-11 href=#__codelineno-139-11></a>ansible<span class=w> </span>-i<span class=w> </span>hosts<span class=w>  </span>all<span class=w> </span>--list-host
<a id=__codelineno-139-12 name=__codelineno-139-12 href=#__codelineno-139-12></a>
<a id=__codelineno-139-13 name=__codelineno-139-13 href=#__codelineno-139-13></a>ansible<span class=w> </span>-i<span class=w> </span>hosts<span class=w> </span>-l<span class=w> </span><span class=m>192</span>.168.77.130<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>ping<span class=w> </span>-t<span class=w> </span>/tmp<span class=w> </span>-vvvv
<a id=__codelineno-139-14 name=__codelineno-139-14 href=#__codelineno-139-14></a>
<a id=__codelineno-139-15 name=__codelineno-139-15 href=#__codelineno-139-15></a>ansible<span class=w> </span>web<span class=w> </span>-l<span class=w> </span>@retry_hosts.txt<span class=w> </span>--list-hosts
<a id=__codelineno-139-16 name=__codelineno-139-16 href=#__codelineno-139-16></a>
<a id=__codelineno-139-17 name=__codelineno-139-17 href=#__codelineno-139-17></a>ansible<span class=w> </span>all<span class=w> </span>-i<span class=w> </span><span class=m>192</span>.168.77.133,<span class=w> </span>-m<span class=w> </span>ping<span class=w> </span>-k
</code></pre></div> <h3 id=ansible-console>ansible-console<a class=headerlink href=#ansible-console title="Permanent link">&para;</a></h3> <p>交互式命令执行界面</p> <div class=highlight><pre><span></span><code><a id=__codelineno-140-1 name=__codelineno-140-1 href=#__codelineno-140-1></a><span class=c1># ansible-console --help</span>
<a id=__codelineno-140-2 name=__codelineno-140-2 href=#__codelineno-140-2></a>usage:<span class=w> </span>ansible-console<span class=w> </span><span class=o>[</span>-h<span class=o>]</span><span class=w> </span><span class=o>[</span>--version<span class=o>]</span><span class=w> </span><span class=o>[</span>-v<span class=o>]</span><span class=w> </span><span class=o>[</span>-b<span class=o>]</span>
<a id=__codelineno-140-3 name=__codelineno-140-3 href=#__codelineno-140-3></a><span class=w>                       </span><span class=o>[</span>--become-method<span class=w> </span>BECOME_METHOD<span class=o>]</span>
<a id=__codelineno-140-4 name=__codelineno-140-4 href=#__codelineno-140-4></a><span class=w>                       </span><span class=o>[</span>--become-user<span class=w> </span>BECOME_USER<span class=o>]</span><span class=w> </span><span class=o>[</span>-K<span class=o>]</span><span class=w> </span><span class=o>[</span>-i<span class=w> </span>INVENTORY<span class=o>]</span>
<a id=__codelineno-140-5 name=__codelineno-140-5 href=#__codelineno-140-5></a><span class=w>                       </span><span class=o>[</span>--list-hosts<span class=o>]</span><span class=w> </span><span class=o>[</span>-l<span class=w> </span>SUBSET<span class=o>]</span><span class=w> </span><span class=o>[</span>-k<span class=o>]</span>
<a id=__codelineno-140-6 name=__codelineno-140-6 href=#__codelineno-140-6></a><span class=w>                       </span><span class=o>[</span>--private-key<span class=w> </span>PRIVATE_KEY_FILE<span class=o>]</span><span class=w> </span><span class=o>[</span>-u<span class=w> </span>REMOTE_USER<span class=o>]</span>
<a id=__codelineno-140-7 name=__codelineno-140-7 href=#__codelineno-140-7></a><span class=w>                       </span><span class=o>[</span>-c<span class=w> </span>CONNECTION<span class=o>]</span><span class=w> </span><span class=o>[</span>-T<span class=w> </span>TIMEOUT<span class=o>]</span>
<a id=__codelineno-140-8 name=__codelineno-140-8 href=#__codelineno-140-8></a><span class=w>                       </span><span class=o>[</span>--ssh-common-args<span class=w> </span>SSH_COMMON_ARGS<span class=o>]</span>
<a id=__codelineno-140-9 name=__codelineno-140-9 href=#__codelineno-140-9></a><span class=w>                       </span><span class=o>[</span>--sftp-extra-args<span class=w> </span>SFTP_EXTRA_ARGS<span class=o>]</span>
<a id=__codelineno-140-10 name=__codelineno-140-10 href=#__codelineno-140-10></a><span class=w>                       </span><span class=o>[</span>--scp-extra-args<span class=w> </span>SCP_EXTRA_ARGS<span class=o>]</span>
<a id=__codelineno-140-11 name=__codelineno-140-11 href=#__codelineno-140-11></a><span class=w>                       </span><span class=o>[</span>--ssh-extra-args<span class=w> </span>SSH_EXTRA_ARGS<span class=o>]</span><span class=w> </span><span class=o>[</span>-C<span class=o>]</span><span class=w> </span><span class=o>[</span>--syntax-check<span class=o>]</span>
<a id=__codelineno-140-12 name=__codelineno-140-12 href=#__codelineno-140-12></a><span class=w>                       </span><span class=o>[</span>-D<span class=o>]</span><span class=w> </span><span class=o>[</span>--vault-id<span class=w> </span>VAULT_IDS<span class=o>]</span>
<a id=__codelineno-140-13 name=__codelineno-140-13 href=#__codelineno-140-13></a><span class=w>                       </span><span class=o>[</span>--ask-vault-pass<span class=w> </span><span class=p>|</span><span class=w> </span>--vault-password-file<span class=w> </span>VAULT_PASSWORD_FILES<span class=o>]</span>
<a id=__codelineno-140-14 name=__codelineno-140-14 href=#__codelineno-140-14></a><span class=w>                       </span><span class=o>[</span>-f<span class=w> </span>FORKS<span class=o>]</span><span class=w> </span><span class=o>[</span>-M<span class=w> </span>MODULE_PATH<span class=o>]</span><span class=w> </span><span class=o>[</span>--playbook-dir<span class=w> </span>BASEDIR<span class=o>]</span>
<a id=__codelineno-140-15 name=__codelineno-140-15 href=#__codelineno-140-15></a><span class=w>                       </span><span class=o>[</span>--step<span class=o>]</span>
<a id=__codelineno-140-16 name=__codelineno-140-16 href=#__codelineno-140-16></a><span class=w>                       </span><span class=o>[</span>pattern<span class=o>]</span>
</code></pre></div> <p><strong>位置参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>pattern</td> <td>主机匹配</td> </tr> </tbody> </table> <p><strong>选项参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>--ask-vault-pass</td> <td>提示输入vault 密码。</td> </tr> <tr> <td>--list-hosts</td> <td>输出匹配主机的列表。</td> </tr> <tr> <td>--playbook-dir BASEDIR</td> <td>指定playbook目录，为<code>role</code>,<code>group_vars/etc</code>指定相对路径</td> </tr> <tr> <td>--step</td> <td>一步一步的运行，每个任务都会循环是否执行</td> </tr> <tr> <td>--syntax-check</td> <td>对playbook进行语法检查，且不执行playbook。</td> </tr> <tr> <td>--vault-id=VAULT_IDS</td> <td>标识使用的vault id</td> </tr> <tr> <td>--vault-password-file=VAULT_PASSWORD_FILE</td> <td>指定vault密码文件</td> </tr> <tr> <td>--version</td> <td>显示程序版本信息</td> </tr> <tr> <td>-C, --check</td> <td>只是测试一下会改变什么内容，不会真正去执行;相反,试图预测一些可能发生的变化。</td> </tr> <tr> <td>-D, --diff</td> <td>当更改文件和模板时，显示这些文件得差异，比--check效果好。</td> </tr> <tr> <td>-M MODULE_PATH, --module-path MODULE_PATH</td> <td>要执行的模块的路径，默认路径<code>~/.ansible/plugins/modules:/usr/share/ansible/plu&lt;br/&gt; gins/modules)</code></td> </tr> <tr> <td>-f FORKS, --forks FORKS</td> <td>指定定要使用的并行进程数，默认为5个。</td> </tr> <tr> <td>-h, --help</td> <td>显示此帮助信息。</td> </tr> <tr> <td>-i INVENTORY, --inventory INVENTORY, --inventory-file INVENTORY</td> <td>指定主机清单文件或逗号分隔的主机，默认为/etc/ansible/hosts。</td> </tr> <tr> <td>-l SUBSET, --limit SUBSET</td> <td>进一步限制所选主机/组模式，只执行<code>-l</code>后的主机和组。</td> </tr> <tr> <td>-v, --verbose</td> <td>输出执行的详细信息，使用-vvv获得更多，-vvvv 启用连接调试</td> </tr> </tbody> </table> <p><strong>特权升级选项</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>--become-method=BECOME_METHOD</td> <td>权限升级方法使用 ，默认为sudo，有效选择：[sudo | su | pbrun | pfexec | runas | doas | dzdo]</td> </tr> <tr> <td>--become-user=BECOME_USER</td> <td>使用哪个用户运行，默认为root</td> </tr> <tr> <td>-K, --ask-become-pass</td> <td>提供权限提升密码</td> </tr> <tr> <td>-b, --become</td> <td>运行权限提升</td> </tr> </tbody> </table> <p><strong>连接选项</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>--private-key=PRIVATE_KEY_FILE, --key-file=PRIVATE_KEY_FILE</td> <td>私钥路径，使用这个文件来验证连接</td> </tr> <tr> <td>--scp-extra-args SCP_EXTRA_ARGS</td> <td>指定额外的参数传递给<code>scp</code> ，例如<code>-l</code></td> </tr> <tr> <td>--sftp-extra-args SFTP_EXTRA_ARGS</td> <td>指定额外的参数传递给<code>sftp</code> ，例如<code>-f</code></td> </tr> <tr> <td>--ssh-common-args SSH_COMMON_ARGS</td> <td>指定要传递给sftp / scp / ssh的通用参数（例如 ProxyCommand）</td> </tr> <tr> <td>--ssh-extra-args SSH_EXTRA_ARGS</td> <td>指定额外的参数传递给<code>ssh</code> ，例如<code>-R</code></td> </tr> <tr> <td>-T TIMEOUT, --timeout=TIMEOUT</td> <td>指定默认超时时间，默认是10S</td> </tr> <tr> <td>-c CONNECTION, --connection=CONNECTION</td> <td>指定连接类型，默认smart</td> </tr> <tr> <td>-k, --ask-pass</td> <td>要求用户输入请求连接密码</td> </tr> <tr> <td>-u REMOTE_USER, --user=REMOTE_USER</td> <td>指定连接用户</td> </tr> </tbody> </table> <p><strong>示例：</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-141-1 name=__codelineno-141-1 href=#__codelineno-141-1></a>ansible-console<span class=w> </span>all<span class=w> </span>-i<span class=w> </span><span class=m>192</span>.168.77.133,<span class=w> </span>-m<span class=w> </span>ping<span class=w> </span>-k
<a id=__codelineno-141-2 name=__codelineno-141-2 href=#__codelineno-141-2></a>
<a id=__codelineno-141-3 name=__codelineno-141-3 href=#__codelineno-141-3></a>root@all<span class=w> </span><span class=o>(</span><span class=m>1</span><span class=o>)[</span>f:5<span class=o>]</span>$<span class=w> </span>ping
<a id=__codelineno-141-4 name=__codelineno-141-4 href=#__codelineno-141-4></a>
<a id=__codelineno-141-5 name=__codelineno-141-5 href=#__codelineno-141-5></a><span class=m>192</span>.168.77.133<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>SUCCESS</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span>
<a id=__codelineno-141-6 name=__codelineno-141-6 href=#__codelineno-141-6></a><span class=w>    </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>false,<span class=w> </span>
<a id=__codelineno-141-7 name=__codelineno-141-7 href=#__codelineno-141-7></a><span class=w>    </span><span class=s2>&quot;ping&quot;</span>:<span class=w> </span><span class=s2>&quot;pong&quot;</span>
<a id=__codelineno-141-8 name=__codelineno-141-8 href=#__codelineno-141-8></a>
<a id=__codelineno-141-9 name=__codelineno-141-9 href=#__codelineno-141-9></a><span class=o>}</span>
</code></pre></div> <h3 id=ansible-doc>ansible-doc<a class=headerlink href=#ansible-doc title="Permanent link">&para;</a></h3> <p>该指令用于查看模块信息，常用参数有两个-l 和 -s </p> <div class=highlight><pre><span></span><code><a id=__codelineno-142-1 name=__codelineno-142-1 href=#__codelineno-142-1></a><span class=c1># ansible-doc --help</span>
<a id=__codelineno-142-2 name=__codelineno-142-2 href=#__codelineno-142-2></a>usage:<span class=w> </span>ansible-doc<span class=w> </span><span class=o>[</span>-h<span class=o>]</span><span class=w> </span><span class=o>[</span>--version<span class=o>]</span><span class=w> </span><span class=o>[</span>-v<span class=o>]</span><span class=w> </span><span class=o>[</span>-M<span class=w> </span>MODULE_PATH<span class=o>]</span>
<a id=__codelineno-142-3 name=__codelineno-142-3 href=#__codelineno-142-3></a><span class=w>                   </span><span class=o>[</span>--playbook-dir<span class=w> </span>BASEDIR<span class=o>]</span>
<a id=__codelineno-142-4 name=__codelineno-142-4 href=#__codelineno-142-4></a><span class=w>                   </span><span class=o>[</span>-t<span class=w> </span><span class=o>{</span>become,cache,callback,cliconf,connection,httpapi,inventory,lookup,netconf,shell,module,strategy,vars<span class=o>}]</span>
<a id=__codelineno-142-5 name=__codelineno-142-5 href=#__codelineno-142-5></a><span class=w>                   </span><span class=o>[</span>-j<span class=o>]</span><span class=w> </span><span class=o>[</span>-F<span class=w> </span><span class=p>|</span><span class=w> </span>-l<span class=w> </span><span class=p>|</span><span class=w> </span>-s<span class=w> </span><span class=p>|</span><span class=w> </span>--metadata-dump<span class=o>]</span>
<a id=__codelineno-142-6 name=__codelineno-142-6 href=#__codelineno-142-6></a><span class=w>                   </span><span class=o>[</span>plugin<span class=w> </span><span class=o>[</span>plugin<span class=w> </span>...<span class=o>]]</span>
</code></pre></div> <p><strong>位置参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>plugin</td> <td>插件</td> </tr> </tbody> </table> <p><strong>选项参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>--metadata-dump</td> <td>获取所有插件的metadata json数据</td> </tr> <tr> <td>--playbook-dir BASEDIR</td> <td>指定playbook目录，为<code>role</code>,<code>group_vars/etc</code>指定相对路径</td> </tr> <tr> <td>--version</td> <td>显示程序版本信息</td> </tr> <tr> <td>-F, --list_files</td> <td>显示插件名称及其源文件，不显示摘要</td> </tr> <tr> <td>-h, --help</td> <td>显示帮助文件</td> </tr> <tr> <td>-j, --json</td> <td>使用json格式输出</td> </tr> <tr> <td>-l, --list</td> <td>列出可用的插件</td> </tr> <tr> <td>-s, --snippet</td> <td>显示指定插件的<code>playbook</code>摘要</td> </tr> <tr> <td become_cache_callback_wzxhzdk:1230_cliconf_connection_httpapi_wzxhzdk:1231_inventory_lookup_netconf_wzxhzdk:1232_shell_module_strategy_vars="become,cache,callback,<br />cliconf,connection,httpapi,<br />inventory,lookup,netconf,<br />shell,module,strategy,vars">-t {become,cache,callback,<br>cliconf,connection,httpapi,<br>inventory,lookup,netconf,<br>shell,module,strategy,vars},<br> --type</td> <td>指定插件类型，默认<code>module</code></td> </tr> </tbody> </table> <p><strong>示例：</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-143-1 name=__codelineno-143-1 href=#__codelineno-143-1></a>ansible-doc<span class=w> </span>-l
<a id=__codelineno-143-2 name=__codelineno-143-2 href=#__codelineno-143-2></a>ansible-doc<span class=w> </span>yum
<a id=__codelineno-143-3 name=__codelineno-143-3 href=#__codelineno-143-3></a>ansible-doc<span class=w> </span>yum<span class=w> </span>-s
<a id=__codelineno-143-4 name=__codelineno-143-4 href=#__codelineno-143-4></a>ansible-doc<span class=w> </span>-t<span class=w> </span>cache<span class=w> </span>-l
<a id=__codelineno-143-5 name=__codelineno-143-5 href=#__codelineno-143-5></a>ansible-doc<span class=w> </span>-t<span class=w> </span>become<span class=w> </span>-l
</code></pre></div> <h3 id=ansible-galaxy>ansible-galaxy<a class=headerlink href=#ansible-galaxy title="Permanent link">&para;</a></h3> <p>ansible-galaxy 指令用于方便的从https://galaxy.ansible.com/ 站点下载第三方扩展模块，我们可以形象的理解其类似于centos下的yum、python下的pip或easy_install</p> <div class=highlight><pre><span></span><code><a id=__codelineno-144-1 name=__codelineno-144-1 href=#__codelineno-144-1></a><span class=c1># ansible-galaxy --help</span>
<a id=__codelineno-144-2 name=__codelineno-144-2 href=#__codelineno-144-2></a>usage:<span class=w> </span>ansible-galaxy<span class=w> </span><span class=o>[</span>-h<span class=o>]</span><span class=w> </span><span class=o>[</span>--version<span class=o>]</span><span class=w> </span><span class=o>[</span>-v<span class=o>]</span><span class=w> </span>TYPE<span class=w> </span>...
</code></pre></div> <p><strong>位置参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>collection</td> <td>管理Ansible Galaxy。</td> </tr> <tr> <td>role</td> <td>管理Ansible Galaxy role。</td> </tr> </tbody> </table> <p><strong>选项参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>--version</td> <td>显示程序版本号</td> </tr> <tr> <td>-h, --help</td> <td>显示此帮助信息</td> </tr> <tr> <td>-v, --verbose</td> <td>详细模式（-vvv表示更多，-vvvv表示启用连接调试）</td> </tr> </tbody> </table> <p><strong>示例：</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-145-1 name=__codelineno-145-1 href=#__codelineno-145-1></a>ansible-galaxy<span class=w> </span>search<span class=w> </span>tomcat<span class=w>  </span><span class=c1># 搜索角色</span>
<a id=__codelineno-145-2 name=__codelineno-145-2 href=#__codelineno-145-2></a>ansible-galaxy<span class=w> </span>install<span class=w> </span>aeriscloud.docker<span class=w> </span><span class=c1>#下载角色</span>
<a id=__codelineno-145-3 name=__codelineno-145-3 href=#__codelineno-145-3></a>
<a id=__codelineno-145-4 name=__codelineno-145-4 href=#__codelineno-145-4></a>ansible-galaxy<span class=w> </span>list<span class=w> </span>ragingbal.tomcat<span class=w>  </span>
<a id=__codelineno-145-5 name=__codelineno-145-5 href=#__codelineno-145-5></a>
<a id=__codelineno-145-6 name=__codelineno-145-6 href=#__codelineno-145-6></a>ansible-galaxy<span class=w> </span>info<span class=w> </span>ragingbal.tomcat
<a id=__codelineno-145-7 name=__codelineno-145-7 href=#__codelineno-145-7></a>
<a id=__codelineno-145-8 name=__codelineno-145-8 href=#__codelineno-145-8></a>ansible-galaxy<span class=w> </span>init<span class=w> </span>abc<span class=w>  </span><span class=c1># 创建角色模板</span>
<a id=__codelineno-145-9 name=__codelineno-145-9 href=#__codelineno-145-9></a><span class=c1># 安装的role在 /root/.ansible/roles/</span>
</code></pre></div> <h3 id=ansible-playbook>ansible-playbook<a class=headerlink href=#ansible-playbook title="Permanent link">&para;</a></h3> <p>对于需反复执行的、较为复杂的任务，我们可以通过定义 Playbook 来搞定。Playbook 是 Ansible 真正强大的地方，它允许使用变量、条件、循环、以及模板，也能通过角色 及包含指令来重用既有内容。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-146-1 name=__codelineno-146-1 href=#__codelineno-146-1></a><span class=c1># ansible-playbook --help</span>
<a id=__codelineno-146-2 name=__codelineno-146-2 href=#__codelineno-146-2></a>usage:<span class=w> </span>ansible-playbook<span class=w> </span><span class=o>[</span>-h<span class=o>]</span><span class=w> </span><span class=o>[</span>--version<span class=o>]</span><span class=w> </span><span class=o>[</span>-v<span class=o>]</span><span class=w> </span><span class=o>[</span>-k<span class=o>]</span>
<a id=__codelineno-146-3 name=__codelineno-146-3 href=#__codelineno-146-3></a><span class=w>                        </span><span class=o>[</span>--private-key<span class=w> </span>PRIVATE_KEY_FILE<span class=o>]</span><span class=w> </span><span class=o>[</span>-u<span class=w> </span>REMOTE_USER<span class=o>]</span>
<a id=__codelineno-146-4 name=__codelineno-146-4 href=#__codelineno-146-4></a><span class=w>                        </span><span class=o>[</span>-c<span class=w> </span>CONNECTION<span class=o>]</span><span class=w> </span><span class=o>[</span>-T<span class=w> </span>TIMEOUT<span class=o>]</span>
<a id=__codelineno-146-5 name=__codelineno-146-5 href=#__codelineno-146-5></a><span class=w>                        </span><span class=o>[</span>--ssh-common-args<span class=w> </span>SSH_COMMON_ARGS<span class=o>]</span>
<a id=__codelineno-146-6 name=__codelineno-146-6 href=#__codelineno-146-6></a><span class=w>                        </span><span class=o>[</span>--sftp-extra-args<span class=w> </span>SFTP_EXTRA_ARGS<span class=o>]</span>
<a id=__codelineno-146-7 name=__codelineno-146-7 href=#__codelineno-146-7></a><span class=w>                        </span><span class=o>[</span>--scp-extra-args<span class=w> </span>SCP_EXTRA_ARGS<span class=o>]</span>
<a id=__codelineno-146-8 name=__codelineno-146-8 href=#__codelineno-146-8></a><span class=w>                        </span><span class=o>[</span>--ssh-extra-args<span class=w> </span>SSH_EXTRA_ARGS<span class=o>]</span><span class=w> </span><span class=o>[</span>--force-handlers<span class=o>]</span>
<a id=__codelineno-146-9 name=__codelineno-146-9 href=#__codelineno-146-9></a><span class=w>                        </span><span class=o>[</span>--flush-cache<span class=o>]</span><span class=w> </span><span class=o>[</span>-b<span class=o>]</span><span class=w> </span><span class=o>[</span>--become-method<span class=w> </span>BECOME_METHOD<span class=o>]</span>
<a id=__codelineno-146-10 name=__codelineno-146-10 href=#__codelineno-146-10></a><span class=w>                        </span><span class=o>[</span>--become-user<span class=w> </span>BECOME_USER<span class=o>]</span><span class=w> </span><span class=o>[</span>-K<span class=o>]</span><span class=w> </span><span class=o>[</span>-t<span class=w> </span>TAGS<span class=o>]</span>
<a id=__codelineno-146-11 name=__codelineno-146-11 href=#__codelineno-146-11></a><span class=w>                        </span><span class=o>[</span>--skip-tags<span class=w> </span>SKIP_TAGS<span class=o>]</span><span class=w> </span><span class=o>[</span>-C<span class=o>]</span><span class=w> </span><span class=o>[</span>--syntax-check<span class=o>]</span><span class=w> </span><span class=o>[</span>-D<span class=o>]</span>
<a id=__codelineno-146-12 name=__codelineno-146-12 href=#__codelineno-146-12></a><span class=w>                        </span><span class=o>[</span>-i<span class=w> </span>INVENTORY<span class=o>]</span><span class=w> </span><span class=o>[</span>--list-hosts<span class=o>]</span><span class=w> </span><span class=o>[</span>-l<span class=w> </span>SUBSET<span class=o>]</span>
<a id=__codelineno-146-13 name=__codelineno-146-13 href=#__codelineno-146-13></a><span class=w>                        </span><span class=o>[</span>-e<span class=w> </span>EXTRA_VARS<span class=o>]</span><span class=w> </span><span class=o>[</span>--vault-id<span class=w> </span>VAULT_IDS<span class=o>]</span>
<a id=__codelineno-146-14 name=__codelineno-146-14 href=#__codelineno-146-14></a><span class=w>                        </span><span class=o>[</span>--ask-vault-pass<span class=w> </span><span class=p>|</span><span class=w> </span>--vault-password-file<span class=w> </span>VAULT_PASSWORD_FILES<span class=o>]</span>
<a id=__codelineno-146-15 name=__codelineno-146-15 href=#__codelineno-146-15></a><span class=w>                        </span><span class=o>[</span>-f<span class=w> </span>FORKS<span class=o>]</span><span class=w> </span><span class=o>[</span>-M<span class=w> </span>MODULE_PATH<span class=o>]</span><span class=w> </span><span class=o>[</span>--list-tasks<span class=o>]</span>
<a id=__codelineno-146-16 name=__codelineno-146-16 href=#__codelineno-146-16></a><span class=w>                        </span><span class=o>[</span>--list-tags<span class=o>]</span><span class=w> </span><span class=o>[</span>--step<span class=o>]</span><span class=w> </span><span class=o>[</span>--start-at-task<span class=w> </span>START_AT_TASK<span class=o>]</span>
<a id=__codelineno-146-17 name=__codelineno-146-17 href=#__codelineno-146-17></a><span class=w>                        </span>playbook<span class=w> </span><span class=o>[</span>playbook<span class=w> </span>...<span class=o>]</span>
</code></pre></div> <p><strong>位置参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>playbook</td> <td>playbook文件</td> </tr> </tbody> </table> <p><strong>选项参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>--ask-vault-pass</td> <td>提示输入vault 密码。</td> </tr> <tr> <td>--flush-cache</td> <td>清除fact缓存</td> </tr> <tr> <td>--force-handlers</td> <td>如果任务失败，也要运行handlers</td> </tr> <tr> <td>--list-hosts</td> <td>输出匹配主机的列表。</td> </tr> <tr> <td>--list-tags</td> <td>列出所有可用的标签</td> </tr> <tr> <td>--list-tasks</td> <td>列出将要执行的所有任务</td> </tr> <tr> <td>--skip-tags=SKIP_TAGS</td> <td>跳过运行标记此标签的任务</td> </tr> <tr> <td>-start-at-task=START_AT_TASK</td> <td>在此任务处开始运行</td> </tr> <tr> <td>--step</td> <td>一步一步的执行：在运行之前确认每个任务</td> </tr> <tr> <td>--syntax-check</td> <td>对playbook进行语法检查，且不执行playbook。</td> </tr> <tr> <td>--vault-id=VAULT_IDS</td> <td>标识使用的vault id</td> </tr> <tr> <td>--vault-password-file=VAULT_PASSWORD_FILE</td> <td>指定vault密码文件</td> </tr> <tr> <td>--version</td> <td>显示程序版本信息</td> </tr> <tr> <td>-C, --check</td> <td>只是测试一下会改变什么内容，不会真正去执行;相反,试图预测一些可能发生的变化。</td> </tr> <tr> <td>-D, --diff</td> <td>当更改文件和模板时，显示这些文件得差异，比--check效果好。</td> </tr> <tr> <td>-M MODULE_PATH, --module-path MODULE_PATH</td> <td>要执行的模块的路径，默认路径<code>~/.ansible/plugins/modules:/usr/share/ansible/plu&lt;br/&gt; gins/modules)</code></td> </tr> <tr> <td>-e EXTRA_VARS, --extra-vars EXTRA_VARS</td> <td>添加附加变量，比如key=value，yaml，json格式。使用<code>@</code>指定文件</td> </tr> <tr> <td>-f FORKS, --forks FORKS</td> <td>指定定要使用的并行进程数，默认为5个。</td> </tr> <tr> <td>-h, --help</td> <td>显示此帮助信息。</td> </tr> <tr> <td>-i INVENTORY, --inventory INVENTORY, --inventory-file INVENTORY</td> <td>指定主机清单文件或逗号分隔的主机，默认为/etc/ansible/hosts。</td> </tr> <tr> <td>-l SUBSET, --limit SUBSET</td> <td>进一步限制所选主机/组模式，只执行<code>-l</code>后的主机和组。</td> </tr> <tr> <td>-t TAGS, --tags TAGS</td> <td>运行指定的带有tags任务</td> </tr> <tr> <td>-v, --verbose</td> <td>输出执行的详细信息，使用-vvv获得更多，-vvvv 启用连接调试</td> </tr> </tbody> </table> <p><strong>特权升级选项</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>--become-method=BECOME_METHOD</td> <td>权限升级方法使用 ，默认为sudo，有效选择：[sudo | su | pbrun | pfexec | runas | doas | dzdo]</td> </tr> <tr> <td>--become-user=BECOME_USER</td> <td>使用哪个用户运行，默认为root</td> </tr> <tr> <td>-K, --ask-become-pass</td> <td>提供权限提升密码</td> </tr> <tr> <td>-b, --become</td> <td>运行权限提升</td> </tr> </tbody> </table> <p><strong>连接选项</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>--private-key=PRIVATE_KEY_FILE, --key-file=PRIVATE_KEY_FILE</td> <td>私钥路径，使用这个文件来验证连接</td> </tr> <tr> <td>--scp-extra-args SCP_EXTRA_ARGS</td> <td>指定额外的参数传递给<code>scp</code> ，例如<code>-l</code></td> </tr> <tr> <td>--sftp-extra-args SFTP_EXTRA_ARGS</td> <td>指定额外的参数传递给<code>sftp</code> ，例如<code>-f</code></td> </tr> <tr> <td>--ssh-common-args SSH_COMMON_ARGS</td> <td>指定要传递给sftp / scp / ssh的通用参数（例如 ProxyCommand）</td> </tr> <tr> <td>--ssh-extra-args SSH_EXTRA_ARGS</td> <td>指定额外的参数传递给<code>ssh</code> ，例如<code>-R</code></td> </tr> <tr> <td>-T TIMEOUT, --timeout=TIMEOUT</td> <td>指定默认超时时间，默认是10S</td> </tr> <tr> <td>-c CONNECTION, --connection=CONNECTION</td> <td>指定连接类型，默认smart</td> </tr> <tr> <td>-k, --ask-pass</td> <td>要求用户输入请求连接密码</td> </tr> <tr> <td>-u REMOTE_USER, --user=REMOTE_USER</td> <td>指定连接用户</td> </tr> </tbody> </table> <p><strong>示例：</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-147-1 name=__codelineno-147-1 href=#__codelineno-147-1></a>ansible-playbook<span class=w> </span>-i<span class=w> </span>hosts<span class=w> </span>ssh-addkey.yml<span class=w>   </span><span class=c1># 指定主机清单文件</span>
<a id=__codelineno-147-2 name=__codelineno-147-2 href=#__codelineno-147-2></a>
<a id=__codelineno-147-3 name=__codelineno-147-3 href=#__codelineno-147-3></a>ansible-playbook<span class=w> </span>-i<span class=w> </span>hosts<span class=w> </span>ssh-addkey.yml<span class=w>  </span>--list-tags<span class=w>   </span><span class=c1># 列出tags</span>
<a id=__codelineno-147-4 name=__codelineno-147-4 href=#__codelineno-147-4></a>
<a id=__codelineno-147-5 name=__codelineno-147-5 href=#__codelineno-147-5></a>ansible-playbook<span class=w> </span>-i<span class=w> </span>hosts<span class=w> </span>ssh-addkey.yml<span class=w>  </span>-t<span class=w> </span>install<span class=w>  </span><span class=c1># 执行install标签的任务</span>
<a id=__codelineno-147-6 name=__codelineno-147-6 href=#__codelineno-147-6></a>
<a id=__codelineno-147-7 name=__codelineno-147-7 href=#__codelineno-147-7></a>ansible-playbook<span class=w> </span>-i<span class=w> </span>hosts<span class=w> </span>ssh-addkey.yml<span class=w>  </span>-t<span class=w> </span>install<span class=w> </span>-e<span class=w> </span><span class=nv>a</span><span class=o>=</span><span class=m>1</span><span class=w>  </span><span class=c1># 指定变量</span>
</code></pre></div> <h3 id=ansible-pull>ansible-pull<a class=headerlink href=#ansible-pull title="Permanent link">&para;</a></h3> <p>pull模式在被配置的机器上运行，速度很快。在这种模式下，你需要提供一个git仓库来供Ansible下载来配置你的机器。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-148-1 name=__codelineno-148-1 href=#__codelineno-148-1></a><span class=c1># ansible-pull --help</span>
<a id=__codelineno-148-2 name=__codelineno-148-2 href=#__codelineno-148-2></a>usage:<span class=w> </span>ansible-pull<span class=w> </span><span class=o>[</span>-h<span class=o>]</span><span class=w> </span><span class=o>[</span>--version<span class=o>]</span><span class=w> </span><span class=o>[</span>-v<span class=o>]</span><span class=w> </span><span class=o>[</span>-k<span class=o>]</span>
<a id=__codelineno-148-3 name=__codelineno-148-3 href=#__codelineno-148-3></a><span class=w>                    </span><span class=o>[</span>--private-key<span class=w> </span>PRIVATE_KEY_FILE<span class=o>]</span><span class=w> </span><span class=o>[</span>-u<span class=w> </span>REMOTE_USER<span class=o>]</span>
<a id=__codelineno-148-4 name=__codelineno-148-4 href=#__codelineno-148-4></a><span class=w>                    </span><span class=o>[</span>-c<span class=w> </span>CONNECTION<span class=o>]</span><span class=w> </span><span class=o>[</span>-T<span class=w> </span>TIMEOUT<span class=o>]</span>
<a id=__codelineno-148-5 name=__codelineno-148-5 href=#__codelineno-148-5></a><span class=w>                    </span><span class=o>[</span>--ssh-common-args<span class=w> </span>SSH_COMMON_ARGS<span class=o>]</span>
<a id=__codelineno-148-6 name=__codelineno-148-6 href=#__codelineno-148-6></a><span class=w>                    </span><span class=o>[</span>--sftp-extra-args<span class=w> </span>SFTP_EXTRA_ARGS<span class=o>]</span>
<a id=__codelineno-148-7 name=__codelineno-148-7 href=#__codelineno-148-7></a><span class=w>                    </span><span class=o>[</span>--scp-extra-args<span class=w> </span>SCP_EXTRA_ARGS<span class=o>]</span>
<a id=__codelineno-148-8 name=__codelineno-148-8 href=#__codelineno-148-8></a><span class=w>                    </span><span class=o>[</span>--ssh-extra-args<span class=w> </span>SSH_EXTRA_ARGS<span class=o>]</span><span class=w> </span><span class=o>[</span>--vault-id<span class=w> </span>VAULT_IDS<span class=o>]</span>
<a id=__codelineno-148-9 name=__codelineno-148-9 href=#__codelineno-148-9></a><span class=w>                    </span><span class=o>[</span>--ask-vault-pass<span class=w> </span><span class=p>|</span><span class=w> </span>--vault-password-file<span class=w> </span>VAULT_PASSWORD_FILES<span class=o>]</span>
<a id=__codelineno-148-10 name=__codelineno-148-10 href=#__codelineno-148-10></a><span class=w>                    </span><span class=o>[</span>-e<span class=w> </span>EXTRA_VARS<span class=o>]</span><span class=w> </span><span class=o>[</span>-t<span class=w> </span>TAGS<span class=o>]</span><span class=w> </span><span class=o>[</span>--skip-tags<span class=w> </span>SKIP_TAGS<span class=o>]</span>
<a id=__codelineno-148-11 name=__codelineno-148-11 href=#__codelineno-148-11></a><span class=w>                    </span><span class=o>[</span>-i<span class=w> </span>INVENTORY<span class=o>]</span><span class=w> </span><span class=o>[</span>--list-hosts<span class=o>]</span><span class=w> </span><span class=o>[</span>-l<span class=w> </span>SUBSET<span class=o>]</span><span class=w> </span><span class=o>[</span>-M<span class=w> </span>MODULE_PATH<span class=o>]</span>
<a id=__codelineno-148-12 name=__codelineno-148-12 href=#__codelineno-148-12></a><span class=w>                    </span><span class=o>[</span>-K<span class=o>]</span><span class=w> </span><span class=o>[</span>--purge<span class=o>]</span><span class=w> </span><span class=o>[</span>-o<span class=o>]</span><span class=w> </span><span class=o>[</span>-s<span class=w> </span>SLEEP<span class=o>]</span><span class=w> </span><span class=o>[</span>-f<span class=o>]</span><span class=w> </span><span class=o>[</span>-d<span class=w> </span>DEST<span class=o>]</span><span class=w> </span><span class=o>[</span>-U<span class=w> </span>URL<span class=o>]</span>
<a id=__codelineno-148-13 name=__codelineno-148-13 href=#__codelineno-148-13></a><span class=w>                    </span><span class=o>[</span>--full<span class=o>]</span><span class=w> </span><span class=o>[</span>-C<span class=w> </span>CHECKOUT<span class=o>]</span><span class=w> </span><span class=o>[</span>--accept-host-key<span class=o>]</span>
<a id=__codelineno-148-14 name=__codelineno-148-14 href=#__codelineno-148-14></a><span class=w>                    </span><span class=o>[</span>-m<span class=w> </span>MODULE_NAME<span class=o>]</span><span class=w> </span><span class=o>[</span>--verify-commit<span class=o>]</span><span class=w> </span><span class=o>[</span>--clean<span class=o>]</span>
<a id=__codelineno-148-15 name=__codelineno-148-15 href=#__codelineno-148-15></a><span class=w>                    </span><span class=o>[</span>--track-subs<span class=o>]</span><span class=w> </span><span class=o>[</span>--check<span class=o>]</span><span class=w> </span><span class=o>[</span>--diff<span class=o>]</span>
<a id=__codelineno-148-16 name=__codelineno-148-16 href=#__codelineno-148-16></a><span class=w>                    </span><span class=o>[</span>playbook.yml<span class=w> </span><span class=o>[</span>playbook.yml<span class=w> </span>...<span class=o>]]</span>
</code></pre></div> <p><strong>位置参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>playbook</td> <td>playbook文件</td> </tr> </tbody> </table> <p><strong>选项参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>--accept-host-key</td> <td>指定仓库的主机秘钥</td> </tr> <tr> <td>--ask-vault-pass</td> <td>提示输入vault 密码。</td> </tr> <tr> <td>--check</td> <td>只做检查，不做更改</td> </tr> <tr> <td>--clean</td> <td>工作存储库中的已修改文件将被删除</td> </tr> <tr> <td>--diff</td> <td>更改（小的）文件和模板时，显示这些文件中的差异</td> </tr> <tr> <td>--full</td> <td>完整克隆</td> </tr> <tr> <td>--list-hosts</td> <td>输出匹配主机列表</td> </tr> <tr> <td>--purge</td> <td>运行后清除</td> </tr> <tr> <td>--skip-tags SKIP_TAGS</td> <td>跳过运行标记此标签的任务</td> </tr> <tr> <td>--track-subs</td> <td>模块将跟踪最新的变化。 这相当于指定--remote标志来git子模块更新</td> </tr> <tr> <td>--vault-id=VAULT_IDS</td> <td>标识使用的vault id</td> </tr> <tr> <td>--vault-password-file=VAULT_PASSWORD_FILE</td> <td>指定vault密码文件</td> </tr> <tr> <td>--verify-commit</td> <td>验证已检出提交的GPG签名，如果失败则中止运行剧本。</td> </tr> <tr> <td>--version</td> <td>显示程序版本信息</td> </tr> <tr> <td>-C CHECKOUT, --checkout=CHECKOUT</td> <td>指定克隆的分支</td> </tr> <tr> <td>-M MODULE_PATH, --module-path MODULE_PATH</td> <td>要执行的模块的路径，默认路径<code>~/.ansible/plugins/modules:/usr/share/ansible/plu&lt;br/&gt; gins/modules)</code></td> </tr> <tr> <td>-U URL, --url URL</td> <td>playbook仓库的地址</td> </tr> <tr> <td>-d DEST, --directory DEST</td> <td>指定检出目录</td> </tr> <tr> <td>-e EXTRA_VARS, --extra-vars EXTRA_VARS</td> <td>添加附加变量，比如key=value，yaml，json格式。使用<code>@</code>指定文件</td> </tr> <tr> <td>-f FORKS, --forks FORKS</td> <td>指定定要使用的并行进程数，默认为5个。</td> </tr> <tr> <td>-h, --help</td> <td>显示此帮助信息。</td> </tr> <tr> <td>-i INVENTORY, --inventory INVENTORY, --inventory-file INVENTORY</td> <td>指定主机清单文件或逗号分隔的主机，默认为/etc/ansible/hosts。</td> </tr> <tr> <td>-l SUBSET, --limit SUBSET</td> <td>进一步限制所选主机/组模式，只执行<code>-l</code>后的主机和组。</td> </tr> <tr> <td>-m MODULE_NAME, --module-name MODULE_NAME</td> <td>仓库模块名称，可选值('git', 'subversion', 'hg', 'bzr')默认为git。</td> </tr> <tr> <td>-o, --only-if-changed</td> <td>当存储库已更新时才运行剧本</td> </tr> <tr> <td>-s SLEEP, --sleep SLEEP</td> <td>指定睡眠时间</td> </tr> <tr> <td>-t TAGS, --tags TAGS</td> <td>运行指定的带有tags任务</td> </tr> <tr> <td>-v, --verbose</td> <td>输出执行的详细信息，使用-vvv获得更多，-vvvv 启用连接调试</td> </tr> </tbody> </table> <p><strong>特权升级选项</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>-K, --ask-become-pass</td> <td>提供权限提升密码</td> </tr> </tbody> </table> <p><strong>连接选项</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>--private-key=PRIVATE_KEY_FILE, --key-file=PRIVATE_KEY_FILE</td> <td>私钥路径，使用这个文件来验证连接</td> </tr> <tr> <td>--scp-extra-args SCP_EXTRA_ARGS</td> <td>指定额外的参数传递给<code>scp</code> ，例如<code>-l</code></td> </tr> <tr> <td>--sftp-extra-args SFTP_EXTRA_ARGS</td> <td>指定额外的参数传递给<code>sftp</code> ，例如<code>-f</code></td> </tr> <tr> <td>--ssh-common-args SSH_COMMON_ARGS</td> <td>指定要传递给sftp / scp / ssh的通用参数（例如 ProxyCommand）</td> </tr> <tr> <td>--ssh-extra-args SSH_EXTRA_ARGS</td> <td>指定额外的参数传递给<code>ssh</code> ，例如<code>-R</code></td> </tr> <tr> <td>-T TIMEOUT, --timeout=TIMEOUT</td> <td>指定默认超时时间，默认是10S</td> </tr> <tr> <td>-c CONNECTION, --connection=CONNECTION</td> <td>指定连接类型，默认smart</td> </tr> <tr> <td>-K, --ask-become-pass</td> <td>要求用户输入请求连接密码</td> </tr> <tr> <td>-u REMOTE_USER, --user=REMOTE_USER</td> <td>指定连接用户</td> </tr> </tbody> </table> <p><strong>示例：</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-149-1 name=__codelineno-149-1 href=#__codelineno-149-1></a>ansible-pull<span class=w> </span>-o<span class=w> </span>-C<span class=w> </span>master<span class=w> </span>-d<span class=w> </span>/tmp/pull<span class=w> </span>-i<span class=w> </span>/tmp/pull/hosts<span class=w> </span>-U<span class=w> </span>https://github.com/lework/Ansible-Pull-Example.git
</code></pre></div> <h3 id=ansible-config>ansible-config<a class=headerlink href=#ansible-config title="Permanent link">&para;</a></h3> <p>编辑管理ansible配置</p> <div class=highlight><pre><span></span><code><a id=__codelineno-150-1 name=__codelineno-150-1 href=#__codelineno-150-1></a><span class=c1># ansible-config --help</span>
<a id=__codelineno-150-2 name=__codelineno-150-2 href=#__codelineno-150-2></a>usage:<span class=w> </span>ansible-config<span class=w> </span><span class=o>[</span>-h<span class=o>]</span><span class=w> </span><span class=o>[</span>--version<span class=o>]</span><span class=w> </span><span class=o>[</span>-v<span class=o>]</span><span class=w> </span><span class=o>{</span>list,dump,view<span class=o>}</span><span class=w> </span>...
</code></pre></div> <p><strong>位置参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>list</td> <td>显示所有的参数配置</td> </tr> <tr> <td>dump</td> <td>dump配置</td> </tr> <tr> <td>view</td> <td>查看配置文件</td> </tr> </tbody> </table> <p><strong>选项参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>--version</td> <td>显示程序版本号</td> </tr> <tr> <td>-h, --help</td> <td>显示此帮助信息</td> </tr> <tr> <td>-v, --verbose</td> <td>详细模式（-vvv表示更多，-vvvv表示启用连接调试）</td> </tr> </tbody> </table> <p><strong>示例：</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-151-1 name=__codelineno-151-1 href=#__codelineno-151-1></a>ansible-config<span class=w> </span>view
<a id=__codelineno-151-2 name=__codelineno-151-2 href=#__codelineno-151-2></a>
<a id=__codelineno-151-3 name=__codelineno-151-3 href=#__codelineno-151-3></a>ansible-config<span class=w>  </span>list
<a id=__codelineno-151-4 name=__codelineno-151-4 href=#__codelineno-151-4></a>
<a id=__codelineno-151-5 name=__codelineno-151-5 href=#__codelineno-151-5></a>ansible-config<span class=w>  </span>dump
</code></pre></div> <h3 id=ansible-inventory>ansible-inventory<a class=headerlink href=#ansible-inventory title="Permanent link">&para;</a></h3> <p>查看主机清单信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-152-1 name=__codelineno-152-1 href=#__codelineno-152-1></a><span class=c1># ansible-inventory --help </span>
<a id=__codelineno-152-2 name=__codelineno-152-2 href=#__codelineno-152-2></a>usage:<span class=w> </span>ansible-inventory<span class=w> </span><span class=o>[</span>-h<span class=o>]</span><span class=w> </span><span class=o>[</span>--version<span class=o>]</span><span class=w> </span><span class=o>[</span>-v<span class=o>]</span><span class=w> </span><span class=o>[</span>-i<span class=w> </span>INVENTORY<span class=o>]</span>
<a id=__codelineno-152-3 name=__codelineno-152-3 href=#__codelineno-152-3></a><span class=w>                         </span><span class=o>[</span>--vault-id<span class=w> </span>VAULT_IDS<span class=o>]</span>
<a id=__codelineno-152-4 name=__codelineno-152-4 href=#__codelineno-152-4></a><span class=w>                         </span><span class=o>[</span>--ask-vault-pass<span class=w> </span><span class=p>|</span><span class=w> </span>--vault-password-file<span class=w> </span>VAULT_PASSWORD_FILES<span class=o>]</span>
<a id=__codelineno-152-5 name=__codelineno-152-5 href=#__codelineno-152-5></a><span class=w>                         </span><span class=o>[</span>--playbook-dir<span class=w> </span>BASEDIR<span class=o>]</span><span class=w> </span><span class=o>[</span>--list<span class=o>]</span><span class=w> </span><span class=o>[</span>--host<span class=w> </span>HOST<span class=o>]</span>
<a id=__codelineno-152-6 name=__codelineno-152-6 href=#__codelineno-152-6></a><span class=w>                         </span><span class=o>[</span>--graph<span class=o>]</span><span class=w> </span><span class=o>[</span>-y<span class=o>]</span><span class=w> </span><span class=o>[</span>--toml<span class=o>]</span><span class=w> </span><span class=o>[</span>--vars<span class=o>]</span><span class=w> </span><span class=o>[</span>--export<span class=o>]</span>
<a id=__codelineno-152-7 name=__codelineno-152-7 href=#__codelineno-152-7></a><span class=w>                         </span><span class=o>[</span>--output<span class=w> </span>OUTPUT_FILE<span class=o>]</span>
<a id=__codelineno-152-8 name=__codelineno-152-8 href=#__codelineno-152-8></a><span class=w>                         </span><span class=o>[</span>host<span class=p>|</span>group<span class=o>]</span>
</code></pre></div> <p><strong>位置参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>host/group</td> <td>主机/主机组</td> </tr> </tbody> </table> <p><strong>选项参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>--accept-host-key</td> <td>指定仓库的主机秘钥</td> </tr> <tr> <td>--export</td> <td>导出信息，与--list或--graph一起使用</td> </tr> <tr> <td>--output OUTPUT_FILE</td> <td>导出信息到文件，与--list或--graph一起使用</td> </tr> <tr> <td>--playbook-dir BASEDIR</td> <td>指定playbook目录，为<code>role</code>,<code>group_vars/etc</code>指定相对路径</td> </tr> <tr> <td>--toml</td> <td>使用toml格式输出,默认是json格式</td> </tr> <tr> <td>--vars</td> <td>输出变量信息，与--list或--graph一起使用</td> </tr> <tr> <td>--vault-id=VAULT_IDS</td> <td>标识使用的vault id</td> </tr> <tr> <td>--vault-password-file=VAULT_PASSWORD_FILE</td> <td>指定vault密码文件</td> </tr> <tr> <td>--version</td> <td>显示程序版本信息</td> </tr> <tr> <td>-h, --help</td> <td>显示此帮助信息。</td> </tr> <tr> <td>-i INVENTORY, --inventory INVENTORY, --inventory-file INVENTORY</td> <td>指定主机清单文件或逗号分隔的主机，默认为/etc/ansible/hosts。</td> </tr> <tr> <td>-v, --verbose</td> <td>输出执行的详细信息，使用-vvv获得更多，-vvvv 启用连接调试</td> </tr> <tr> <td>-y, --yaml</td> <td>使用yaml格式输出,默认是json格式</td> </tr> </tbody> </table> <p><strong>动作选项</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>--graph</td> <td>创建主机清单图</td> </tr> <tr> <td>--host HOST</td> <td>输出主机清单信息</td> </tr> <tr> <td>--list</td> <td>以json的格式输出所有主机清单信息</td> </tr> </tbody> </table> <p><strong>示例：</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-153-1 name=__codelineno-153-1 href=#__codelineno-153-1></a>ansible-inventory<span class=w> </span>--export<span class=w> </span>--graph
<a id=__codelineno-153-2 name=__codelineno-153-2 href=#__codelineno-153-2></a>
<a id=__codelineno-153-3 name=__codelineno-153-3 href=#__codelineno-153-3></a>ansible-inventory<span class=w> </span>-i<span class=w> </span>/etc/ansible/hosts<span class=w> </span>--export<span class=w> </span>--list
<a id=__codelineno-153-4 name=__codelineno-153-4 href=#__codelineno-153-4></a>
<a id=__codelineno-153-5 name=__codelineno-153-5 href=#__codelineno-153-5></a>ansible-inventory<span class=w> </span>--host<span class=o>=</span><span class=m>192</span>.168.1.100
<a id=__codelineno-153-6 name=__codelineno-153-6 href=#__codelineno-153-6></a>
<a id=__codelineno-153-7 name=__codelineno-153-7 href=#__codelineno-153-7></a>ansible-inventory<span class=w> </span>--vars<span class=w> </span>--list
<a id=__codelineno-153-8 name=__codelineno-153-8 href=#__codelineno-153-8></a><span class=w> </span><span class=sb>```</span>
<a id=__codelineno-153-9 name=__codelineno-153-9 href=#__codelineno-153-9></a>
<a id=__codelineno-153-10 name=__codelineno-153-10 href=#__codelineno-153-10></a>
<a id=__codelineno-153-11 name=__codelineno-153-11 href=#__codelineno-153-11></a>
<a id=__codelineno-153-12 name=__codelineno-153-12 href=#__codelineno-153-12></a><span class=c1>### ansible-vault</span>
<a id=__codelineno-153-13 name=__codelineno-153-13 href=#__codelineno-153-13></a>
<a id=__codelineno-153-14 name=__codelineno-153-14 href=#__codelineno-153-14></a>ansible-vault主要应用于配置文件中含有敏感信息，又不希望他能被人看到，vault可以帮你加密/解密这个配置文件。这种playbook文件在执行时，需要加上<span class=w> </span><span class=sb>`</span>--ask-vault-pass<span class=sb>`</span>参数，同样需要输入密码后才能正常执行。
<a id=__codelineno-153-15 name=__codelineno-153-15 href=#__codelineno-153-15></a>
<a id=__codelineno-153-16 name=__codelineno-153-16 href=#__codelineno-153-16></a><span class=sb>```</span>bash
<a id=__codelineno-153-17 name=__codelineno-153-17 href=#__codelineno-153-17></a><span class=c1># ansible-vault --help</span>
<a id=__codelineno-153-18 name=__codelineno-153-18 href=#__codelineno-153-18></a>usage:<span class=w> </span>ansible-vault<span class=w> </span><span class=o>[</span>-h<span class=o>]</span><span class=w> </span><span class=o>[</span>--version<span class=o>]</span><span class=w> </span><span class=o>[</span>-v<span class=o>]</span>
<a id=__codelineno-153-19 name=__codelineno-153-19 href=#__codelineno-153-19></a><span class=w>                     </span><span class=o>{</span>create,decrypt,edit,view,encrypt,encrypt_string,rekey<span class=o>}</span>
<a id=__codelineno-153-20 name=__codelineno-153-20 href=#__codelineno-153-20></a><span class=w>                     </span>...
</code></pre></div> <p><strong>位置参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>create</td> <td>创建加密文件</td> </tr> <tr> <td>decrypt</td> <td>解密文件</td> </tr> <tr> <td>edit</td> <td>编辑加密文件</td> </tr> <tr> <td>view</td> <td>查看加密文件</td> </tr> <tr> <td>encrypt</td> <td>加密文件</td> </tr> <tr> <td>encrypt_string</td> <td>输出加密字符串</td> </tr> <tr> <td>rekey</td> <td>重新加密文件</td> </tr> </tbody> </table> <p><strong>选项参数</strong></p> <table> <thead> <tr> <th>参数</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>--version</td> <td>显示程序版本号</td> </tr> <tr> <td>-h, --help</td> <td>显示此帮助信息</td> </tr> <tr> <td>-v, --verbose</td> <td>详细模式（-vvv表示更多，-vvvv表示启用连接调试）</td> </tr> </tbody> </table> <p><strong>示例：</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-154-1 name=__codelineno-154-1 href=#__codelineno-154-1></a>ansible-vault<span class=w> </span>create<span class=w> </span><span class=c1># /tmp/123 创建加密文件</span>
<a id=__codelineno-154-2 name=__codelineno-154-2 href=#__codelineno-154-2></a>
<a id=__codelineno-154-3 name=__codelineno-154-3 href=#__codelineno-154-3></a>ansible-vault<span class=w> </span>view<span class=w>  </span><span class=c1># /tmp/123 查看加密文件</span>
<a id=__codelineno-154-4 name=__codelineno-154-4 href=#__codelineno-154-4></a>
<a id=__codelineno-154-5 name=__codelineno-154-5 href=#__codelineno-154-5></a>ansible-vault<span class=w> </span>encrypt<span class=w>  </span><span class=c1># /tmp/abc 加密文件</span>
<a id=__codelineno-154-6 name=__codelineno-154-6 href=#__codelineno-154-6></a>
<a id=__codelineno-154-7 name=__codelineno-154-7 href=#__codelineno-154-7></a>ansible-vault<span class=w> </span>decrypt<span class=w>  </span><span class=c1># /tmp/abc 解密文件</span>
<a id=__codelineno-154-8 name=__codelineno-154-8 href=#__codelineno-154-8></a>
<a id=__codelineno-154-9 name=__codelineno-154-9 href=#__codelineno-154-9></a>ansible-vault<span class=w> </span>edit<span class=w>  </span><span class=c1># /tmp/abc 编辑加密文件</span>
<a id=__codelineno-154-10 name=__codelineno-154-10 href=#__codelineno-154-10></a>
<a id=__codelineno-154-11 name=__codelineno-154-11 href=#__codelineno-154-11></a>ansible-vault<span class=w> </span>encrypt_string<span class=w> </span><span class=s1>&#39;123&#39;</span><span class=w>  </span><span class=c1># 输出加密字符串</span>
</code></pre></div> <h2 id=8使用-playbook>8.使用 Playbook<a class=headerlink href=#8使用-playbook title="Permanent link">&para;</a></h2> <p><strong>Playbook</strong>（剧本） 是 <strong>Ansible</strong> 指令的集合，其利用 YAML 语言编写，自上而下按顺序一次执行。</p> <p>如果Ansible模块是你的车间的工具，那playbook则是你的指导手册，你的主机清单(inventory)是你的原材料。</p> <p>play的主要功能在于将事先归并为一组的主机装扮成事先通过ansible中的task定义好的角色。从根本上来讲所谓task无非是调用ansible的一个module。将多个play组织在一个playbook中即可以让它们联同起来按事先编排的机制同唱一台大戏。其主要有以下四部分构成:</p> <ul> <li> <p>Target section： 定义将要执行 playbook 的远程主机组</p> </li> <li> <p>Variable section： 定义 playbook 运行时需要使用的变量</p> </li> <li> <p>Task section： 定义将要在远程主机上执行的任务列表</p> </li> <li> <p>Handler section： 定义 task 执行完成以后需要调用的任务</p> </li> </ul> <h3 id=playbook-示例>Playbook 示例<a class=headerlink href=#playbook-示例 title="Permanent link">&para;</a></h3> <blockquote> <p>centos7 环境</p> </blockquote> <p>开始书写我们第一个playbook</p> <p><strong>第一步：</strong> 定义我们得主机清单</p> <div class=highlight><pre><span></span><code><a id=__codelineno-155-1 name=__codelineno-155-1 href=#__codelineno-155-1></a><span class=k>[web]</span>
<a id=__codelineno-155-2 name=__codelineno-155-2 href=#__codelineno-155-2></a><span class=na>192.168.77.129 ansible_ssh_pass</span><span class=o>=</span><span class=s>123456</span>
<a id=__codelineno-155-3 name=__codelineno-155-3 href=#__codelineno-155-3></a><span class=na>192.168.77.130 ansible_ssh_pass</span><span class=o>=</span><span class=s>123456</span>
</code></pre></div> <blockquote> <p>注：这里如果做了ssh免密码登陆，可以去掉ansible_ssh_pass</p> </blockquote> <p><strong>第二步：</strong> 明确playbook做哪些任务</p> <p>web组的主机完成下列任务</p> <ol> <li>远程执行用户为root</li> <li>安装httpd</li> <li>apache配置文件实现自定义http端口和客户端连接数</li> <li>在配置文件变更的时候，重启httpd</li> <li>启动httpd，并设置其开机自启动</li> </ol> <p><strong>第三步：</strong> 书写playbook</p> <blockquote> <p>playbook 使用 YAML 标记语言 (see <a href=https://docs.ansible.com/ansible/latest/reference_appendices/YAMLSyntax.html#yaml-syntax>YAML Syntax</a>) 来描述任务的编排</p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-156-1 name=__codelineno-156-1 href=#__codelineno-156-1></a><span class=nn>---</span>
<a id=__codelineno-156-2 name=__codelineno-156-2 href=#__codelineno-156-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class=w>                 </span><span class=c1># Target section</span>
<a id=__codelineno-156-3 name=__codelineno-156-3 href=#__codelineno-156-3></a><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<a id=__codelineno-156-4 name=__codelineno-156-4 href=#__codelineno-156-4></a><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>                      </span><span class=c1># Variable section</span>
<a id=__codelineno-156-5 name=__codelineno-156-5 href=#__codelineno-156-5></a><span class=w>    </span><span class=nt>http_port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<a id=__codelineno-156-6 name=__codelineno-156-6 href=#__codelineno-156-6></a><span class=w>    </span><span class=nt>max_clients</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">200</span>
<a id=__codelineno-156-7 name=__codelineno-156-7 href=#__codelineno-156-7></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>                     </span><span class=c1># Task section</span>
<a id=__codelineno-156-8 name=__codelineno-156-8 href=#__codelineno-156-8></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ensure apache is at the latest version</span>
<a id=__codelineno-156-9 name=__codelineno-156-9 href=#__codelineno-156-9></a><span class=w>    </span><span class=nt>yum</span><span class=p>:</span>
<a id=__codelineno-156-10 name=__codelineno-156-10 href=#__codelineno-156-10></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id=__codelineno-156-11 name=__codelineno-156-11 href=#__codelineno-156-11></a><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">latest</span>
<a id=__codelineno-156-12 name=__codelineno-156-12 href=#__codelineno-156-12></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">write the apache config file</span>
<a id=__codelineno-156-13 name=__codelineno-156-13 href=#__codelineno-156-13></a><span class=w>    </span><span class=nt>template</span><span class=p>:</span>
<a id=__codelineno-156-14 name=__codelineno-156-14 href=#__codelineno-156-14></a><span class=w>      </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">httpd.j2</span>
<a id=__codelineno-156-15 name=__codelineno-156-15 href=#__codelineno-156-15></a><span class=w>      </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/etc/httpd/conf/httpd.conf</span>
<a id=__codelineno-156-16 name=__codelineno-156-16 href=#__codelineno-156-16></a><span class=w>    </span><span class=nt>notify</span><span class=p>:</span>
<a id=__codelineno-156-17 name=__codelineno-156-17 href=#__codelineno-156-17></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">restart apache</span>
<a id=__codelineno-156-18 name=__codelineno-156-18 href=#__codelineno-156-18></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ensure apache is running</span>
<a id=__codelineno-156-19 name=__codelineno-156-19 href=#__codelineno-156-19></a><span class=w>    </span><span class=nt>service</span><span class=p>:</span>
<a id=__codelineno-156-20 name=__codelineno-156-20 href=#__codelineno-156-20></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id=__codelineno-156-21 name=__codelineno-156-21 href=#__codelineno-156-21></a><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">started</span>
<a id=__codelineno-156-22 name=__codelineno-156-22 href=#__codelineno-156-22></a><span class=w>  </span><span class=nt>handlers</span><span class=p>:</span><span class=w>                 </span><span class=c1># Handler section</span>
<a id=__codelineno-156-23 name=__codelineno-156-23 href=#__codelineno-156-23></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">restart apache</span>
<a id=__codelineno-156-24 name=__codelineno-156-24 href=#__codelineno-156-24></a><span class=w>      </span><span class=nt>service</span><span class=p>:</span>
<a id=__codelineno-156-25 name=__codelineno-156-25 href=#__codelineno-156-25></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id=__codelineno-156-26 name=__codelineno-156-26 href=#__codelineno-156-26></a><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">restarted</span>
</code></pre></div> <blockquote> <p><code>remote_user</code> <code>vars</code> 等等这些都是ansible的playbook对象的关键字, 全部可用的关键字列表见 <a href=/basic/Reference/Keywords/ >Ansible 关键字</a></p> </blockquote> <p>当前目录下的 <code>httpd.j2</code> 文件内容</p> <div class=highlight><pre><span></span><code><a id=__codelineno-157-1 name=__codelineno-157-1 href=#__codelineno-157-1></a>ServerRoot &quot;/etc/httpd&quot;
<a id=__codelineno-157-2 name=__codelineno-157-2 href=#__codelineno-157-2></a>Listen {{ http_port }}
<a id=__codelineno-157-3 name=__codelineno-157-3 href=#__codelineno-157-3></a>
<a id=__codelineno-157-4 name=__codelineno-157-4 href=#__codelineno-157-4></a>Include conf.modules.d/*.conf
<a id=__codelineno-157-5 name=__codelineno-157-5 href=#__codelineno-157-5></a>
<a id=__codelineno-157-6 name=__codelineno-157-6 href=#__codelineno-157-6></a>User apache
<a id=__codelineno-157-7 name=__codelineno-157-7 href=#__codelineno-157-7></a>Group apache
<a id=__codelineno-157-8 name=__codelineno-157-8 href=#__codelineno-157-8></a>
<a id=__codelineno-157-9 name=__codelineno-157-9 href=#__codelineno-157-9></a>ServerAdmin root@localhost
<a id=__codelineno-157-10 name=__codelineno-157-10 href=#__codelineno-157-10></a>
<a id=__codelineno-157-11 name=__codelineno-157-11 href=#__codelineno-157-11></a>&lt;Directory /&gt;
<a id=__codelineno-157-12 name=__codelineno-157-12 href=#__codelineno-157-12></a>    AllowOverride none
<a id=__codelineno-157-13 name=__codelineno-157-13 href=#__codelineno-157-13></a>    Require all denied
<a id=__codelineno-157-14 name=__codelineno-157-14 href=#__codelineno-157-14></a>&lt;/Directory&gt;
<a id=__codelineno-157-15 name=__codelineno-157-15 href=#__codelineno-157-15></a>
<a id=__codelineno-157-16 name=__codelineno-157-16 href=#__codelineno-157-16></a>DocumentRoot &quot;/var/www/html&quot;
<a id=__codelineno-157-17 name=__codelineno-157-17 href=#__codelineno-157-17></a>
<a id=__codelineno-157-18 name=__codelineno-157-18 href=#__codelineno-157-18></a>&lt;Directory &quot;/var/www&quot;&gt;
<a id=__codelineno-157-19 name=__codelineno-157-19 href=#__codelineno-157-19></a>    AllowOverride None
<a id=__codelineno-157-20 name=__codelineno-157-20 href=#__codelineno-157-20></a>    Require all granted
<a id=__codelineno-157-21 name=__codelineno-157-21 href=#__codelineno-157-21></a>&lt;/Directory&gt;
<a id=__codelineno-157-22 name=__codelineno-157-22 href=#__codelineno-157-22></a>
<a id=__codelineno-157-23 name=__codelineno-157-23 href=#__codelineno-157-23></a>&lt;Directory &quot;/var/www/html&quot;&gt;
<a id=__codelineno-157-24 name=__codelineno-157-24 href=#__codelineno-157-24></a>    Options Indexes FollowSymLinks
<a id=__codelineno-157-25 name=__codelineno-157-25 href=#__codelineno-157-25></a>    AllowOverride None
<a id=__codelineno-157-26 name=__codelineno-157-26 href=#__codelineno-157-26></a>    Require all granted
<a id=__codelineno-157-27 name=__codelineno-157-27 href=#__codelineno-157-27></a>&lt;/Directory&gt;
<a id=__codelineno-157-28 name=__codelineno-157-28 href=#__codelineno-157-28></a>
<a id=__codelineno-157-29 name=__codelineno-157-29 href=#__codelineno-157-29></a>&lt;IfModule dir_module&gt;
<a id=__codelineno-157-30 name=__codelineno-157-30 href=#__codelineno-157-30></a>    DirectoryIndex index.html
<a id=__codelineno-157-31 name=__codelineno-157-31 href=#__codelineno-157-31></a>&lt;/IfModule&gt;
<a id=__codelineno-157-32 name=__codelineno-157-32 href=#__codelineno-157-32></a>
<a id=__codelineno-157-33 name=__codelineno-157-33 href=#__codelineno-157-33></a>&lt;Files &quot;.ht*&quot;&gt;
<a id=__codelineno-157-34 name=__codelineno-157-34 href=#__codelineno-157-34></a>    Require all denied
<a id=__codelineno-157-35 name=__codelineno-157-35 href=#__codelineno-157-35></a>&lt;/Files&gt;
<a id=__codelineno-157-36 name=__codelineno-157-36 href=#__codelineno-157-36></a>
<a id=__codelineno-157-37 name=__codelineno-157-37 href=#__codelineno-157-37></a>ErrorLog &quot;logs/error_log&quot;
<a id=__codelineno-157-38 name=__codelineno-157-38 href=#__codelineno-157-38></a>LogLevel warn
<a id=__codelineno-157-39 name=__codelineno-157-39 href=#__codelineno-157-39></a>
<a id=__codelineno-157-40 name=__codelineno-157-40 href=#__codelineno-157-40></a>&lt;IfModule log_config_module&gt;
<a id=__codelineno-157-41 name=__codelineno-157-41 href=#__codelineno-157-41></a>    LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot;&quot; combined
<a id=__codelineno-157-42 name=__codelineno-157-42 href=#__codelineno-157-42></a>    LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b&quot; common
<a id=__codelineno-157-43 name=__codelineno-157-43 href=#__codelineno-157-43></a>    &lt;IfModule logio_module&gt;
<a id=__codelineno-157-44 name=__codelineno-157-44 href=#__codelineno-157-44></a>      LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot; %I %O&quot; combinedio
<a id=__codelineno-157-45 name=__codelineno-157-45 href=#__codelineno-157-45></a>    &lt;/IfModule&gt;
<a id=__codelineno-157-46 name=__codelineno-157-46 href=#__codelineno-157-46></a>    CustomLog &quot;logs/access_log&quot; combined
<a id=__codelineno-157-47 name=__codelineno-157-47 href=#__codelineno-157-47></a>&lt;/IfModule&gt;
<a id=__codelineno-157-48 name=__codelineno-157-48 href=#__codelineno-157-48></a>
<a id=__codelineno-157-49 name=__codelineno-157-49 href=#__codelineno-157-49></a>&lt;IfModule alias_module&gt;
<a id=__codelineno-157-50 name=__codelineno-157-50 href=#__codelineno-157-50></a>    ScriptAlias /cgi-bin/ &quot;/var/www/cgi-bin/&quot;
<a id=__codelineno-157-51 name=__codelineno-157-51 href=#__codelineno-157-51></a>&lt;/IfModule&gt;
<a id=__codelineno-157-52 name=__codelineno-157-52 href=#__codelineno-157-52></a>
<a id=__codelineno-157-53 name=__codelineno-157-53 href=#__codelineno-157-53></a>&lt;Directory &quot;/var/www/cgi-bin&quot;&gt;
<a id=__codelineno-157-54 name=__codelineno-157-54 href=#__codelineno-157-54></a>    AllowOverride None
<a id=__codelineno-157-55 name=__codelineno-157-55 href=#__codelineno-157-55></a>    Options None
<a id=__codelineno-157-56 name=__codelineno-157-56 href=#__codelineno-157-56></a>    Require all granted
<a id=__codelineno-157-57 name=__codelineno-157-57 href=#__codelineno-157-57></a>&lt;/Directory&gt;
<a id=__codelineno-157-58 name=__codelineno-157-58 href=#__codelineno-157-58></a>
<a id=__codelineno-157-59 name=__codelineno-157-59 href=#__codelineno-157-59></a>&lt;IfModule mime_module&gt;
<a id=__codelineno-157-60 name=__codelineno-157-60 href=#__codelineno-157-60></a>    TypesConfig /etc/mime.types
<a id=__codelineno-157-61 name=__codelineno-157-61 href=#__codelineno-157-61></a>    AddType application/x-compress .Z
<a id=__codelineno-157-62 name=__codelineno-157-62 href=#__codelineno-157-62></a>    AddType application/x-gzip .gz .tgz
<a id=__codelineno-157-63 name=__codelineno-157-63 href=#__codelineno-157-63></a>    AddType text/html .shtml
<a id=__codelineno-157-64 name=__codelineno-157-64 href=#__codelineno-157-64></a>    AddOutputFilter INCLUDES .shtml
<a id=__codelineno-157-65 name=__codelineno-157-65 href=#__codelineno-157-65></a>&lt;/IfModule&gt;
<a id=__codelineno-157-66 name=__codelineno-157-66 href=#__codelineno-157-66></a>
<a id=__codelineno-157-67 name=__codelineno-157-67 href=#__codelineno-157-67></a>AddDefaultCharset UTF-8
<a id=__codelineno-157-68 name=__codelineno-157-68 href=#__codelineno-157-68></a>&lt;IfModule mime_magic_module&gt;
<a id=__codelineno-157-69 name=__codelineno-157-69 href=#__codelineno-157-69></a>    MIMEMagicFile conf/magic
<a id=__codelineno-157-70 name=__codelineno-157-70 href=#__codelineno-157-70></a>&lt;/IfModule&gt;
<a id=__codelineno-157-71 name=__codelineno-157-71 href=#__codelineno-157-71></a>
<a id=__codelineno-157-72 name=__codelineno-157-72 href=#__codelineno-157-72></a>&lt;IfModule mpm_prefork_module&gt;
<a id=__codelineno-157-73 name=__codelineno-157-73 href=#__codelineno-157-73></a>    ServerLimit        256
<a id=__codelineno-157-74 name=__codelineno-157-74 href=#__codelineno-157-74></a>    StartServers         5
<a id=__codelineno-157-75 name=__codelineno-157-75 href=#__codelineno-157-75></a>    MinSpareServers      5
<a id=__codelineno-157-76 name=__codelineno-157-76 href=#__codelineno-157-76></a>    MaxSpareServers     10
<a id=__codelineno-157-77 name=__codelineno-157-77 href=#__codelineno-157-77></a>    MaxClients          {{ max_clients }}
<a id=__codelineno-157-78 name=__codelineno-157-78 href=#__codelineno-157-78></a>    MaxRequestsPerChild  0
<a id=__codelineno-157-79 name=__codelineno-157-79 href=#__codelineno-157-79></a>&lt;/IfModule&gt;
<a id=__codelineno-157-80 name=__codelineno-157-80 href=#__codelineno-157-80></a>
<a id=__codelineno-157-81 name=__codelineno-157-81 href=#__codelineno-157-81></a>EnableSendfile on
<a id=__codelineno-157-82 name=__codelineno-157-82 href=#__codelineno-157-82></a>IncludeOptional conf.d/*.conf
</code></pre></div> <p>题外：一个playbook文件可以拥有多个play, 比如我们在加一个<code>databases</code>组的数据库安装操作</p> <div class=highlight><pre><span></span><code><a id=__codelineno-158-1 name=__codelineno-158-1 href=#__codelineno-158-1></a><span class=nn>---</span>
<a id=__codelineno-158-2 name=__codelineno-158-2 href=#__codelineno-158-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-158-3 name=__codelineno-158-3 href=#__codelineno-158-3></a><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<a id=__codelineno-158-4 name=__codelineno-158-4 href=#__codelineno-158-4></a>
<a id=__codelineno-158-5 name=__codelineno-158-5 href=#__codelineno-158-5></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-158-6 name=__codelineno-158-6 href=#__codelineno-158-6></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ensure apache is at the latest version</span>
<a id=__codelineno-158-7 name=__codelineno-158-7 href=#__codelineno-158-7></a><span class=w>    </span><span class=nt>yum</span><span class=p>:</span>
<a id=__codelineno-158-8 name=__codelineno-158-8 href=#__codelineno-158-8></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id=__codelineno-158-9 name=__codelineno-158-9 href=#__codelineno-158-9></a><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">latest</span>
<a id=__codelineno-158-10 name=__codelineno-158-10 href=#__codelineno-158-10></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">write the apache config file</span>
<a id=__codelineno-158-11 name=__codelineno-158-11 href=#__codelineno-158-11></a><span class=w>    </span><span class=nt>template</span><span class=p>:</span>
<a id=__codelineno-158-12 name=__codelineno-158-12 href=#__codelineno-158-12></a><span class=w>      </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">httpd.j2</span>
<a id=__codelineno-158-13 name=__codelineno-158-13 href=#__codelineno-158-13></a><span class=w>      </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/etc/httpd/conf/httpd.conf</span>
<a id=__codelineno-158-14 name=__codelineno-158-14 href=#__codelineno-158-14></a>
<a id=__codelineno-158-15 name=__codelineno-158-15 href=#__codelineno-158-15></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">databases</span>
<a id=__codelineno-158-16 name=__codelineno-158-16 href=#__codelineno-158-16></a><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<a id=__codelineno-158-17 name=__codelineno-158-17 href=#__codelineno-158-17></a>
<a id=__codelineno-158-18 name=__codelineno-158-18 href=#__codelineno-158-18></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-158-19 name=__codelineno-158-19 href=#__codelineno-158-19></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ensure postgresql is at the latest version</span>
<a id=__codelineno-158-20 name=__codelineno-158-20 href=#__codelineno-158-20></a><span class=w>    </span><span class=nt>yum</span><span class=p>:</span>
<a id=__codelineno-158-21 name=__codelineno-158-21 href=#__codelineno-158-21></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">postgresql</span>
<a id=__codelineno-158-22 name=__codelineno-158-22 href=#__codelineno-158-22></a><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">latest</span>
<a id=__codelineno-158-23 name=__codelineno-158-23 href=#__codelineno-158-23></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ensure that postgresql is started</span>
<a id=__codelineno-158-24 name=__codelineno-158-24 href=#__codelineno-158-24></a><span class=w>    </span><span class=nt>service</span><span class=p>:</span>
<a id=__codelineno-158-25 name=__codelineno-158-25 href=#__codelineno-158-25></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">postgresql</span>
<a id=__codelineno-158-26 name=__codelineno-158-26 href=#__codelineno-158-26></a><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">started</span>
</code></pre></div> <p><strong>第四步：</strong> 运行playbok</p> <div class=highlight><pre><span></span><code><a id=__codelineno-159-1 name=__codelineno-159-1 href=#__codelineno-159-1></a>ansible-playbook<span class=w> </span>-i<span class=w> </span>hosts<span class=w> </span>test.yml
</code></pre></div> <div class="admonition note"> <p class=admonition-title>注：还有一种运行方式</p> <p>在yml文件头部加入</p> <div class=highlight><pre><span></span><code><a id=__codelineno-160-1 name=__codelineno-160-1 href=#__codelineno-160-1></a>#!/bin/env ansible-playbook
</code></pre></div> <p>在给yml文件执行权限</p> <div class=highlight><pre><span></span><code><a id=__codelineno-161-1 name=__codelineno-161-1 href=#__codelineno-161-1></a>chmod<span class=w> </span>+x<span class=w> </span>t.yml
</code></pre></div> <p>运行playbook</p> <div class=highlight><pre><span></span><code><a id=__codelineno-162-1 name=__codelineno-162-1 href=#__codelineno-162-1></a>./t.yml
</code></pre></div> </div> <h3 id=主机和用户>主机和用户<a class=headerlink href=#主机和用户 title="Permanent link">&para;</a></h3> <p>对于每个playbok的play,都会有一个主机和远程用户来确定哪些主机为目标</p> <div class=highlight><pre><span></span><code><a id=__codelineno-163-1 name=__codelineno-163-1 href=#__codelineno-163-1></a><span class=nn>---</span>
<a id=__codelineno-163-2 name=__codelineno-163-2 href=#__codelineno-163-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-163-3 name=__codelineno-163-3 href=#__codelineno-163-3></a><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
</code></pre></div> <p><code>hosts</code> 定义了主机清单的<code>patterns</code> 来确定哪些主机为执行目标。<code>remote_user</code>指定执行目标主机的执行用户。</p> <p><code>remote_user</code> 也可以为每个<code>task</code>设置</p> <div class=highlight><pre><span></span><code><a id=__codelineno-164-1 name=__codelineno-164-1 href=#__codelineno-164-1></a><span class=nn>---</span>
<a id=__codelineno-164-2 name=__codelineno-164-2 href=#__codelineno-164-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-164-3 name=__codelineno-164-3 href=#__codelineno-164-3></a><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<a id=__codelineno-164-4 name=__codelineno-164-4 href=#__codelineno-164-4></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-164-5 name=__codelineno-164-5 href=#__codelineno-164-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test connection</span>
<a id=__codelineno-164-6 name=__codelineno-164-6 href=#__codelineno-164-6></a><span class=w>      </span><span class=nt>ping</span><span class=p>:</span>
<a id=__codelineno-164-7 name=__codelineno-164-7 href=#__codelineno-164-7></a><span class=w>      </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yourname</span>
</code></pre></div> <p>如果你想要为执行提升权限，可以设置<code>become</code>提权参数</p> <div class=highlight><pre><span></span><code><a id=__codelineno-165-1 name=__codelineno-165-1 href=#__codelineno-165-1></a><span class=nn>---</span>
<a id=__codelineno-165-2 name=__codelineno-165-2 href=#__codelineno-165-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-165-3 name=__codelineno-165-3 href=#__codelineno-165-3></a><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yourname</span>
<a id=__codelineno-165-4 name=__codelineno-165-4 href=#__codelineno-165-4></a><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div> <p>当然，你也可以为每个<code>task</code>设置</p> <div class=highlight><pre><span></span><code><a id=__codelineno-166-1 name=__codelineno-166-1 href=#__codelineno-166-1></a><span class=nn>---</span>
<a id=__codelineno-166-2 name=__codelineno-166-2 href=#__codelineno-166-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-166-3 name=__codelineno-166-3 href=#__codelineno-166-3></a><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yourname</span>
<a id=__codelineno-166-4 name=__codelineno-166-4 href=#__codelineno-166-4></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-166-5 name=__codelineno-166-5 href=#__codelineno-166-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>service</span><span class=p>:</span>
<a id=__codelineno-166-6 name=__codelineno-166-6 href=#__codelineno-166-6></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id=__codelineno-166-7 name=__codelineno-166-7 href=#__codelineno-166-7></a><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">started</span>
<a id=__codelineno-166-8 name=__codelineno-166-8 href=#__codelineno-166-8></a><span class=w>      </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-166-9 name=__codelineno-166-9 href=#__codelineno-166-9></a><span class=w>      </span><span class=nt>become_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<a id=__codelineno-166-10 name=__codelineno-166-10 href=#__codelineno-166-10></a><span class=w>      </span><span class=nt>become_method</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">sudo</span>
</code></pre></div> <p>become 相关参数</p> <ul> <li> <p><code>become</code>是否开启提权 </p> </li> <li> <p><code>become_method</code> 指定提升方式</p> </li> <li> <p><code>become_user</code> 指定提升用户</p> </li> <li><code>become_flags</code> 提权命令的参数</li> </ul> <h4 id=主机的执行顺序>主机的执行顺序<a class=headerlink href=#主机的执行顺序 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-167-1 name=__codelineno-167-1 href=#__codelineno-167-1></a><span class=nn>---</span>
<a id=__codelineno-167-2 name=__codelineno-167-2 href=#__codelineno-167-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">exec order</span>
<a id=__codelineno-167-3 name=__codelineno-167-3 href=#__codelineno-167-3></a><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
<a id=__codelineno-167-4 name=__codelineno-167-4 href=#__codelineno-167-4></a><span class=w>  </span><span class=nt>order</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">sorted</span>
<a id=__codelineno-167-5 name=__codelineno-167-5 href=#__codelineno-167-5></a><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<a id=__codelineno-167-6 name=__codelineno-167-6 href=#__codelineno-167-6></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-167-7 name=__codelineno-167-7 href=#__codelineno-167-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-167-8 name=__codelineno-167-8 href=#__codelineno-167-8></a><span class=w>        </span><span class=nt>var</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">inventory_hostname</span>
</code></pre></div> <blockquote> <p><code>play</code> 也可以加上<code>name</code>来标识名称, <code>gather_facts</code> 定义不获取主机fact数据</p> </blockquote> <p><code>order</code> 参数可以控制主机的 <strong>运行顺序</strong>， 默认是<code>inventory</code> 按主机清单的从上到下顺序依次执行，其他的可选值如下表：</p> <table> <thead> <tr> <th>可选值</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>inventory</td> <td>默认值，按主机清单的从上到下顺序依次执行</td> </tr> <tr> <td>reverse_inventory</td> <td>按主机清单的从下到上顺序依次执行</td> </tr> <tr> <td>sorted</td> <td>以主机名称按字母顺序排序</td> </tr> <tr> <td>reverse_sorted</td> <td>以主机名称按字母顺序反序排序</td> </tr> <tr> <td>shuffle</td> <td>随机排序</td> </tr> </tbody> </table> <h3 id=任务列表>任务列表<a class=headerlink href=#任务列表 title="Permanent link">&para;</a></h3> <p>每个play包含一组任务列表， 任务之间是按照从上往下顺序执行的，执行完上一个任务再去执行下一个任务。</p> <p>运行从上到下运行的剧本时，任务失败的主机将从整个剧本的轮换中删除。 如果失败，只需更正剧本文件并重新运行即可。</p> <p>每个任务(task)的目标是执行带有特定参数的模块。 变量可以在模块的参数中使用。</p> <p>模块应该是幂等的，也就是说，在一个序列中多次运行一个模块应该与只运行它一次具有相同的效果。实现幂等性的一种方法是让一个模块检查它所期望的最终状态是否已经实现，如果已经实现，则退出而不执行任何操作。如果playbook使用的所有模块都是幂等的，那么playbook本身可能也是幂等的，所以重新运行playbook应该是安全的。</p> <p>每个任务都应该有一个名称(names)，它包含在运行剧本的输出中。这是人类可读的输出，因此提供每个任务步骤的良好描述非常有用。但是，如果没有提供名称，那么将使用提供给 ‘action’ 的字符串作为输出。</p> <p>任务示例</p> <div class=highlight><pre><span></span><code><a id=__codelineno-168-1 name=__codelineno-168-1 href=#__codelineno-168-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-168-2 name=__codelineno-168-2 href=#__codelineno-168-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">make sure apache is running</span>
<a id=__codelineno-168-3 name=__codelineno-168-3 href=#__codelineno-168-3></a><span class=w>    </span><span class=nt>service</span><span class=p>:</span>
<a id=__codelineno-168-4 name=__codelineno-168-4 href=#__codelineno-168-4></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id=__codelineno-168-5 name=__codelineno-168-5 href=#__codelineno-168-5></a><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">started</span>
</code></pre></div> <p>也可以使用<code>key=value</code>的形式表示模块参数</p> <div class=highlight><pre><span></span><code><a id=__codelineno-169-1 name=__codelineno-169-1 href=#__codelineno-169-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-169-2 name=__codelineno-169-2 href=#__codelineno-169-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">make sure apache is running</span>
<a id=__codelineno-169-3 name=__codelineno-169-3 href=#__codelineno-169-3></a><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">name=httpd state=started</span>
</code></pre></div> <p><code>command</code>和<code>shell</code>模块只有一组参数，可以直接写在模块后面</p> <div class=highlight><pre><span></span><code><a id=__codelineno-170-1 name=__codelineno-170-1 href=#__codelineno-170-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-170-2 name=__codelineno-170-2 href=#__codelineno-170-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">enable selinux</span>
<a id=__codelineno-170-3 name=__codelineno-170-3 href=#__codelineno-170-3></a><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/sbin/setenforce 1</span>
<a id=__codelineno-170-4 name=__codelineno-170-4 href=#__codelineno-170-4></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">run this command and ignore the result</span>
<a id=__codelineno-170-5 name=__codelineno-170-5 href=#__codelineno-170-5></a><span class=w>    </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/somecommand || /bin/true</span>
</code></pre></div> <p>如果想忽略模块的执行错误，可以为模块添加<code>ignore_errors</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-171-1 name=__codelineno-171-1 href=#__codelineno-171-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-171-2 name=__codelineno-171-2 href=#__codelineno-171-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">run this command and ignore the result</span>
<a id=__codelineno-171-3 name=__codelineno-171-3 href=#__codelineno-171-3></a><span class=w>    </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/somecommand</span>
<a id=__codelineno-171-4 name=__codelineno-171-4 href=#__codelineno-171-4></a><span class=w>    </span><span class=nt>ignore_errors</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
</code></pre></div> <p>如果行太长了，可以换行缩进表示</p> <div class=highlight><pre><span></span><code><a id=__codelineno-172-1 name=__codelineno-172-1 href=#__codelineno-172-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-172-2 name=__codelineno-172-2 href=#__codelineno-172-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Copy ansible inventory file to client</span>
<a id=__codelineno-172-3 name=__codelineno-172-3 href=#__codelineno-172-3></a><span class=w>    </span><span class=nt>copy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">src=/etc/ansible/hosts dest=/etc/ansible/hosts</span>
<a id=__codelineno-172-4 name=__codelineno-172-4 href=#__codelineno-172-4></a><span class=w>            </span><span class="l l-Scalar l-Scalar-Plain">owner=root group=root mode=0644</span>
</code></pre></div> <p>也可以使用变量<code>vhost</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-173-1 name=__codelineno-173-1 href=#__codelineno-173-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-173-2 name=__codelineno-173-2 href=#__codelineno-173-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">create a virtual host file for {{ vhost }}</span>
<a id=__codelineno-173-3 name=__codelineno-173-3 href=#__codelineno-173-3></a><span class=w>    </span><span class=nt>template</span><span class=p>:</span>
<a id=__codelineno-173-4 name=__codelineno-173-4 href=#__codelineno-173-4></a><span class=w>      </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">somefile.j2</span>
<a id=__codelineno-173-5 name=__codelineno-173-5 href=#__codelineno-173-5></a><span class=w>      </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/etc/httpd/conf.d/{{ vhost }}</span>
</code></pre></div> <p>task还有一种古老的标记方法，不建议使用这类形式来标记任务。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-174-1 name=__codelineno-174-1 href=#__codelineno-174-1></a><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">template src=templates/foo.j2 dest=/etc/foo.conf</span>
</code></pre></div> <h3 id=事件处理handlers>事件处理Handlers<a class=headerlink href=#事件处理handlers title="Permanent link">&para;</a></h3> <p>这些<code>notify</code>动作在play中每个任务块结束时触发，并且即使由多个不同的任务通知，也只会触发一次。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-175-1 name=__codelineno-175-1 href=#__codelineno-175-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">template configuration file</span>
<a id=__codelineno-175-2 name=__codelineno-175-2 href=#__codelineno-175-2></a><span class=w>  </span><span class=nt>template</span><span class=p>:</span>
<a id=__codelineno-175-3 name=__codelineno-175-3 href=#__codelineno-175-3></a><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">template.j2</span>
<a id=__codelineno-175-4 name=__codelineno-175-4 href=#__codelineno-175-4></a><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/etc/foo.conf</span>
<a id=__codelineno-175-5 name=__codelineno-175-5 href=#__codelineno-175-5></a><span class=w>  </span><span class=nt>notify</span><span class=p>:</span>
<a id=__codelineno-175-6 name=__codelineno-175-6 href=#__codelineno-175-6></a><span class=w>     </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">restart memcached</span>
<a id=__codelineno-175-7 name=__codelineno-175-7 href=#__codelineno-175-7></a><span class=w>     </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">restart apache</span>
</code></pre></div> <blockquote> <p><code>notify</code> 定义的时handlers里的任务名称列表</p> </blockquote> <p>Handlers 也是任务列表，与常规任务没有什么不同，它们由全局惟一的名称引用，并由<code>notify</code>动作通知。如果没有通知处理程序，它将不会运行。不管有多少任务通知一个处理程序，它都将只运行一次，即在一个特定<code>play</code>中的所有任务完成之后。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-176-1 name=__codelineno-176-1 href=#__codelineno-176-1></a><span class=nt>handlers</span><span class=p>:</span>
<a id=__codelineno-176-2 name=__codelineno-176-2 href=#__codelineno-176-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">restart memcached</span>
<a id=__codelineno-176-3 name=__codelineno-176-3 href=#__codelineno-176-3></a><span class=w>    </span><span class=nt>service</span><span class=p>:</span>
<a id=__codelineno-176-4 name=__codelineno-176-4 href=#__codelineno-176-4></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">memcached</span>
<a id=__codelineno-176-5 name=__codelineno-176-5 href=#__codelineno-176-5></a><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">restarted</span>
<a id=__codelineno-176-6 name=__codelineno-176-6 href=#__codelineno-176-6></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">restart apache</span>
<a id=__codelineno-176-7 name=__codelineno-176-7 href=#__codelineno-176-7></a><span class=w>    </span><span class=nt>service</span><span class=p>:</span>
<a id=__codelineno-176-8 name=__codelineno-176-8 href=#__codelineno-176-8></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apache</span>
<a id=__codelineno-176-9 name=__codelineno-176-9 href=#__codelineno-176-9></a><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">restarted</span>
</code></pre></div> <p>Handlers 里的任务名称 <strong>不能使用</strong> 变量</p> <p>在 ansible 2.2之后，handlers 支持<code>listen</code> 来实现监听一个通知程序来实现执行多个通知任务。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-177-1 name=__codelineno-177-1 href=#__codelineno-177-1></a><span class=nt>handlers</span><span class=p>:</span>
<a id=__codelineno-177-2 name=__codelineno-177-2 href=#__codelineno-177-2></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">restart memcached</span>
<a id=__codelineno-177-3 name=__codelineno-177-3 href=#__codelineno-177-3></a><span class=w>      </span><span class=nt>service</span><span class=p>:</span>
<a id=__codelineno-177-4 name=__codelineno-177-4 href=#__codelineno-177-4></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">memcached</span>
<a id=__codelineno-177-5 name=__codelineno-177-5 href=#__codelineno-177-5></a><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">restarted</span>
<a id=__codelineno-177-6 name=__codelineno-177-6 href=#__codelineno-177-6></a><span class=w>      </span><span class=nt>listen</span><span class=p>:</span><span class=w> </span><span class=s>&quot;restart</span><span class=nv> </span><span class=s>web</span><span class=nv> </span><span class=s>services&quot;</span>
<a id=__codelineno-177-7 name=__codelineno-177-7 href=#__codelineno-177-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">restart apache</span>
<a id=__codelineno-177-8 name=__codelineno-177-8 href=#__codelineno-177-8></a><span class=w>      </span><span class=nt>service</span><span class=p>:</span>
<a id=__codelineno-177-9 name=__codelineno-177-9 href=#__codelineno-177-9></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apache</span>
<a id=__codelineno-177-10 name=__codelineno-177-10 href=#__codelineno-177-10></a><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">restarted</span>
<a id=__codelineno-177-11 name=__codelineno-177-11 href=#__codelineno-177-11></a><span class=w>      </span><span class=nt>listen</span><span class=p>:</span><span class=w> </span><span class=s>&quot;restart</span><span class=nv> </span><span class=s>web</span><span class=nv> </span><span class=s>services&quot;</span>
<a id=__codelineno-177-12 name=__codelineno-177-12 href=#__codelineno-177-12></a>
<a id=__codelineno-177-13 name=__codelineno-177-13 href=#__codelineno-177-13></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-177-14 name=__codelineno-177-14 href=#__codelineno-177-14></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">restart everything</span>
<a id=__codelineno-177-15 name=__codelineno-177-15 href=#__codelineno-177-15></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;this task will restart the web services&quot;</span>
<a id=__codelineno-177-16 name=__codelineno-177-16 href=#__codelineno-177-16></a><span class=w>      </span><span class=nt>notify</span><span class=p>:</span><span class=w> </span><span class=s>&quot;restart</span><span class=nv> </span><span class=s>web</span><span class=nv> </span><span class=s>services&quot;</span>
</code></pre></div> <h3 id=执行-playbook>执行 Playbook<a class=headerlink href=#执行-playbook title="Permanent link">&para;</a></h3> <p>使用<code>ansible-playbook</code>命令执行<code>playbook</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-178-1 name=__codelineno-178-1 href=#__codelineno-178-1></a>ansible-playbook<span class=w> </span>playbook.yml<span class=w> </span>-f<span class=w> </span><span class=m>10</span>
</code></pre></div> <p>在执行playbook前，可以做些检查</p> <ol> <li>检查palybook语法</li> </ol> <div class=highlight><pre><span></span><code><a id=__codelineno-179-1 name=__codelineno-179-1 href=#__codelineno-179-1></a>ansible-playbook<span class=w> </span>-i<span class=w> </span>hosts<span class=w> </span>httpd.yml<span class=w> </span>--syntax-check
</code></pre></div> <ol> <li>列出要执行的主机</li> </ol> <div class=highlight><pre><span></span><code><a id=__codelineno-180-1 name=__codelineno-180-1 href=#__codelineno-180-1></a>ansible-playbook<span class=w> </span>-i<span class=w> </span>hosts<span class=w> </span>httpd.yml<span class=w> </span>--list-hosts
</code></pre></div> <ol> <li>列出要执行得任务</li> </ol> <div class=highlight><pre><span></span><code><a id=__codelineno-181-1 name=__codelineno-181-1 href=#__codelineno-181-1></a>ansible-playbook<span class=w> </span>-i<span class=w> </span>hosts<span class=w> </span>httpd.yml<span class=w> </span>--list-tasks
</code></pre></div> <p>也可以使用<code>ansible-lint</code> 命令进行详细检查playbook文件</p> <div class=highlight><pre><span></span><code><a id=__codelineno-182-1 name=__codelineno-182-1 href=#__codelineno-182-1></a>ansible-lint<span class=w> </span>httpd.yml
</code></pre></div> <p><a href=https://docs.ansible.com/ansible-lint/rules/default_rules.html>ansible-lint 默认规则</a> 页面描述了每一个错误信息。</p> <h4 id=playbook执行顺序>playbook执行顺序<a class=headerlink href=#playbook执行顺序 title="Permanent link">&para;</a></h4> <p>一个playbook的内容，是按照下列表依次执行的</p> <ol> <li> <p>Variable loading 变量加载</p> </li> <li> <p>Fact gatherin 是否获取fact数据</p> </li> <li> <p>The pre_tasks execution 执行pre_tasks任务</p> </li> <li> <p>Handlers notified from the pre_tasks execution 执行pre_tasks任务里的事件通知</p> </li> <li> <p>Roles execution 执行roles角色</p> </li> <li> <p>Tasks execution 执行tasks任务</p> </li> <li> <p>Handlers notified from roles or tasks execution 执行tasks任务里的事件通知</p> </li> <li> <p>The post_tasks execution 执行post_tasks任务</p> </li> <li> <p>Handlers notified from post_tasks execution 执行post_tasks任务里的事件通知</p> </li> </ol> <h2 id=9包含和角色>9.包含和角色<a class=headerlink href=#9包含和角色 title="Permanent link">&para;</a></h2> <p>虽然可以在一个非常大的文件中编写 playbook (您可能以这种方式开始学习 palybook)，但最终您将希望重用文件并开始组织工作。在Ansible中，有三种方法可以做到这一点: <code>includes</code>, <code>imports</code>, and<code>roles</code>。</p> <p><code>includes</code> 和<code>imports</code>（在Ansible 2.4版中添加）允许用户将大型playbook拆分成较小的文件，这些文件可以在多个父级playbook中使用，甚至可以在同一Playbook中多次使用。</p> <h3 id=动态和静态>动态和静态<a class=headerlink href=#动态和静态 title="Permanent link">&para;</a></h3> <p>对于可重用的内容，Ansible有两种操作模式: <strong>动态</strong> 和 <strong>静态</strong> 。</p> <p>在Ansible 2.0中，引入了动态包含的概念。由于以这种方式实现<code>all include</code>的一些限制，Ansible 2.1中引入了将<code>force include</code>设置为静态的能力。因为<code>include</code>任务被重载，包含了静态和动态语法，而且由于<code>include</code>的默认行为可能会根据任务上设置的其他选项而更改，所以Ansible 2.4引入了<code>include</code>与<code>import</code>的概念。</p> <h3 id=静态导入>静态导入<a class=headerlink href=#静态导入 title="Permanent link">&para;</a></h3> <ul> <li> <p>使用<code>import_tasks</code>模块来导入<code>tasks</code>文件</p> </li> <li> <p>使用<code>import_role</code>模块来导入<code>role</code></p> </li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-183-1 name=__codelineno-183-1 href=#__codelineno-183-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-183-2 name=__codelineno-183-2 href=#__codelineno-183-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>import_tasks</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">tasks/foo.yml</span>
<a id=__codelineno-183-3 name=__codelineno-183-3 href=#__codelineno-183-3></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>import_role</span><span class=p>:</span>
<a id=__codelineno-183-4 name=__codelineno-183-4 href=#__codelineno-183-4></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">example</span>
</code></pre></div> <p><code>import_tasks</code>还允许 传递变量</p> <div class=highlight><pre><span></span><code><a id=__codelineno-184-1 name=__codelineno-184-1 href=#__codelineno-184-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>import_tasks</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">wordpress.yml wp_user=timmy</span>
<a id=__codelineno-184-2 name=__codelineno-184-2 href=#__codelineno-184-2></a>
<a id=__codelineno-184-3 name=__codelineno-184-3 href=#__codelineno-184-3></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>import_tasks</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">wordpress.yml</span>
<a id=__codelineno-184-4 name=__codelineno-184-4 href=#__codelineno-184-4></a><span class=w>  </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-184-5 name=__codelineno-184-5 href=#__codelineno-184-5></a><span class=w>    </span><span class=nt>wp_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">timmy</span>
<a id=__codelineno-184-6 name=__codelineno-184-6 href=#__codelineno-184-6></a><span class=w>    </span><span class=nt>ssh_keys</span><span class=p>:</span>
<a id=__codelineno-184-7 name=__codelineno-184-7 href=#__codelineno-184-7></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">keys/one.txt</span>
<a id=__codelineno-184-8 name=__codelineno-184-8 href=#__codelineno-184-8></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">keys/two.txt</span>
</code></pre></div> <h3 id=动态包含>动态包含<a class=headerlink href=#动态包含 title="Permanent link">&para;</a></h3> <ul> <li> <p>使用<code>include_tasks</code>模块来包含<code>tasks</code>文件</p> </li> <li> <p>使用<code>include_role</code>模块来包含<code>role</code></p> </li> </ul> <p>动态包含可以用作循环引用</p> <div class=highlight><pre><span></span><code><a id=__codelineno-185-1 name=__codelineno-185-1 href=#__codelineno-185-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo.yml param={{item}}</span>
<a id=__codelineno-185-2 name=__codelineno-185-2 href=#__codelineno-185-2></a><span class=w>  </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=c1># 循环引用3次</span>
<a id=__codelineno-185-3 name=__codelineno-185-3 href=#__codelineno-185-3></a><span class=w>   </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-185-4 name=__codelineno-185-4 href=#__codelineno-185-4></a><span class=w>   </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a id=__codelineno-185-5 name=__codelineno-185-5 href=#__codelineno-185-5></a><span class=w>   </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id=__codelineno-185-6 name=__codelineno-185-6 href=#__codelineno-185-6></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>include_role</span><span class=p>:</span>
<a id=__codelineno-185-7 name=__codelineno-185-7 href=#__codelineno-185-7></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">example</span>
</code></pre></div> <p>还可以使用变量引入task文件</p> <div class=highlight><pre><span></span><code><a id=__codelineno-186-1 name=__codelineno-186-1 href=#__codelineno-186-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{inventory_hostname}}.yml&quot;</span>
</code></pre></div> <p><strong>变量包含</strong></p> <p><code>include_vars</code> 在 <strong>task</strong> 中动态加载 <strong>yaml</strong> 或 <strong>json</strong> 文件类型中的变量</p> <p><code>yaml - include_vars: myvars.yml</code></p> <p>根据操作系统类型加载变量文件，如果找不到，则为默认值。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-187-1 name=__codelineno-187-1 href=#__codelineno-187-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>include_vars</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-187-2 name=__codelineno-187-2 href=#__codelineno-187-2></a><span class=w>  </span><span class=nt>with_first_found</span><span class=p>:</span>
<a id=__codelineno-187-3 name=__codelineno-187-3 href=#__codelineno-187-3></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>ansible_distribution</span><span class=nv> </span><span class=s>}}.yml&quot;</span>
<a id=__codelineno-187-4 name=__codelineno-187-4 href=#__codelineno-187-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>ansible_os_family</span><span class=nv> </span><span class=s>}}.yml&quot;</span>
<a id=__codelineno-187-5 name=__codelineno-187-5 href=#__codelineno-187-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;default.yml&quot;</span>
</code></pre></div> <h3 id=动态与静态两者的区别>动态与静态两者的区别<a class=headerlink href=#动态与静态两者的区别 title="Permanent link">&para;</a></h3> <ul> <li>Ansible在Playbook解析时间预处理所有 <strong>静态导入</strong> 。在执行前导入配置文件，出现错误会立即停止</li> <li><strong>动态包含</strong> 是在运行期间遇到该任务时处理的。在执行时导入配置文件，出现错误不会立即停止</li> </ul> <p>当涉及Ansible任务选项时，例如<code>tags</code>和条件语句<code>when</code>：</p> <ul> <li>对于 <strong>动态包含</strong>，任务选项将仅在评估动态任务时应用于该任务，而不会复制到子任务。</li> <li>对于 <strong>静态导入</strong>，父任务选项将被复制到导入中包含的所有子任务。</li> </ul> <p>使用<code>include*</code> vs.<code>import*</code>有一些优点，也有一些缺点，用户在选择使用它们时应该加以考虑</p> <p>使用<code>include*</code>语句的主要优点是 <strong>循环</strong>。 当 <strong>循环与包含</strong> 一起使用时，将对循环中的 <strong>每个项目执行一次包含的task或role</strong> 。</p> <p><strong>与静态导入相比，动态包含的一些限制</strong></p> <ul> <li>您不能使用<code>notify</code>来触发来自动态包含的处理程序名称。</li> <li>您不能使用<code>--start-at-task</code>在动态包含内的任务开始执行。</li> <li>仅存在于动态包含内的标记不会显示在<code>-list-tags</code>输出中。</li> <li>只存在于动态包含内的任务将不会显示在<code>-list-tasks</code>输出中。</li> </ul> <p><strong>与动态包含相比, 静态导入的一些限制</strong></p> <ul> <li> <p>静态导入 <strong>不能用循环</strong></p> </li> <li> <p>当使用目标文件或角色名称的变量时，不能使用主机清单中的 <strong>变量</strong></p> </li> <li><strong>handlers</strong> 使用 <code>import</code> 导入的处理程序在被其名称通知时不会被触发，因为<code>import</code>会用导入的任务列表覆盖 <strong>handler’s</strong> 的指定任务。</li> </ul> <h3 id=角色role>角色ROLE<a class=headerlink href=#角色role title="Permanent link">&para;</a></h3> <p>角色是基于已知文件结构自动加载某些<code>vars_files</code>，<code>tasks</code>和<code>handlers</code>的方法。 按角色分组的内容还允许与其他用户轻松共享角色。</p> <h3 id=角色目录结构>角色目录结构<a class=headerlink href=#角色目录结构 title="Permanent link">&para;</a></h3> <p>文件结构如下</p> <div class=highlight><pre><span></span><code><a id=__codelineno-188-1 name=__codelineno-188-1 href=#__codelineno-188-1></a>webservers.yml
<a id=__codelineno-188-2 name=__codelineno-188-2 href=#__codelineno-188-2></a>fooservers.yml
<a id=__codelineno-188-3 name=__codelineno-188-3 href=#__codelineno-188-3></a>
<a id=__codelineno-188-4 name=__codelineno-188-4 href=#__codelineno-188-4></a>group_vars/
<a id=__codelineno-188-5 name=__codelineno-188-5 href=#__codelineno-188-5></a><span class=w>   </span>all.yml
<a id=__codelineno-188-6 name=__codelineno-188-6 href=#__codelineno-188-6></a><span class=w>   </span>group1.yml
<a id=__codelineno-188-7 name=__codelineno-188-7 href=#__codelineno-188-7></a><span class=w>   </span>group2.yml
<a id=__codelineno-188-8 name=__codelineno-188-8 href=#__codelineno-188-8></a>host_vars/
<a id=__codelineno-188-9 name=__codelineno-188-9 href=#__codelineno-188-9></a><span class=w>   </span>hostname1.yml
<a id=__codelineno-188-10 name=__codelineno-188-10 href=#__codelineno-188-10></a><span class=w>   </span>hostname2.yml
<a id=__codelineno-188-11 name=__codelineno-188-11 href=#__codelineno-188-11></a>
<a id=__codelineno-188-12 name=__codelineno-188-12 href=#__codelineno-188-12></a>library/
<a id=__codelineno-188-13 name=__codelineno-188-13 href=#__codelineno-188-13></a>module_utils/
<a id=__codelineno-188-14 name=__codelineno-188-14 href=#__codelineno-188-14></a>filter_plugins/
<a id=__codelineno-188-15 name=__codelineno-188-15 href=#__codelineno-188-15></a>
<a id=__codelineno-188-16 name=__codelineno-188-16 href=#__codelineno-188-16></a>roles/
<a id=__codelineno-188-17 name=__codelineno-188-17 href=#__codelineno-188-17></a><span class=w>    </span>common/
<a id=__codelineno-188-18 name=__codelineno-188-18 href=#__codelineno-188-18></a><span class=w>        </span>tasks/
<a id=__codelineno-188-19 name=__codelineno-188-19 href=#__codelineno-188-19></a><span class=w>        </span>handlers/
<a id=__codelineno-188-20 name=__codelineno-188-20 href=#__codelineno-188-20></a><span class=w>        </span>files/
<a id=__codelineno-188-21 name=__codelineno-188-21 href=#__codelineno-188-21></a><span class=w>        </span>templates/
<a id=__codelineno-188-22 name=__codelineno-188-22 href=#__codelineno-188-22></a><span class=w>        </span>vars/
<a id=__codelineno-188-23 name=__codelineno-188-23 href=#__codelineno-188-23></a><span class=w>        </span>defaults/
<a id=__codelineno-188-24 name=__codelineno-188-24 href=#__codelineno-188-24></a><span class=w>        </span>meta/
<a id=__codelineno-188-25 name=__codelineno-188-25 href=#__codelineno-188-25></a><span class=w>    </span>webservers/
<a id=__codelineno-188-26 name=__codelineno-188-26 href=#__codelineno-188-26></a><span class=w>        </span>tasks/
<a id=__codelineno-188-27 name=__codelineno-188-27 href=#__codelineno-188-27></a><span class=w>        </span>defaults/
<a id=__codelineno-188-28 name=__codelineno-188-28 href=#__codelineno-188-28></a><span class=w>        </span>meta/<span class=w> </span>
</code></pre></div> <p>角色必须包含至少一个这样的目录，但是完全可以排除任何没有使用的目录。在使用时，每个目录必须包含一个<code>main.yml</code>文件，其中包含相关内容:</p> <ul> <li><code>tasks</code> - 包含角色要执行的主要任务列表。</li> <li><code>handlers</code> - 包含处理程序，可以由此角色使用，甚至可以在此角色以外的任何地方使用。</li> <li><code>defaults</code>- 角色的默认变量（有关更多信息，请参阅变量）。</li> <li><code>vars</code>- 角色的其他变量（有关更多信息，请参阅变量）。</li> <li><code>files</code> - 包含可以通过此角色部署的文件。</li> <li><code>templates</code> - 包含可以通过此角色部署的模板。</li> <li><code>meta</code> - 为这个角色定义了一些元数据。</li> <li><code>library</code>- 如果有任何自定义模块，将其放在这里（可选）</li> <li><code>filter_plugins</code> - 如果有任何自定义过滤器插件，将其放在这里（可选）</li> <li><code>group_var/all</code> - 如果<code>group_var/all</code>存在，其中列出的变量将被添加到所有的主机组中</li> <li><code>group_var/groupname1</code> - 如果<code>group_var/groupname1</code>存在，其中列出的变量将被添加到groupname1主机组中</li> <li><code>host_vars/hostname1</code> - 如果<code>host_vars/hostname1</code>存在，其中列出的变量将被添加到hostname1主机组中</li> </ul> <p>除了特定的文件和目录外，也可以包含自定义的文件和目录，比如下面的为每个操作系统设置一个文件</p> <div class=highlight><pre><span></span><code><a id=__codelineno-189-1 name=__codelineno-189-1 href=#__codelineno-189-1></a><span class=c1># roles/example/tasks/main.yml</span>
<a id=__codelineno-189-2 name=__codelineno-189-2 href=#__codelineno-189-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">added in 2.4, previously you used &#39;include&#39;</span>
<a id=__codelineno-189-3 name=__codelineno-189-3 href=#__codelineno-189-3></a><span class=w>  </span><span class=nt>import_tasks</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">redhat.yml</span>
<a id=__codelineno-189-4 name=__codelineno-189-4 href=#__codelineno-189-4></a><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ansible_facts[&#39;os_family&#39;]|lower == &#39;redhat&#39;</span>
<a id=__codelineno-189-5 name=__codelineno-189-5 href=#__codelineno-189-5></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>import_tasks</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">debian.yml</span>
<a id=__codelineno-189-6 name=__codelineno-189-6 href=#__codelineno-189-6></a><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ansible_facts[&#39;os_family&#39;]|lower == &#39;debian&#39;</span>
<a id=__codelineno-189-7 name=__codelineno-189-7 href=#__codelineno-189-7></a>
<a id=__codelineno-189-8 name=__codelineno-189-8 href=#__codelineno-189-8></a><span class=c1># roles/example/tasks/redhat.yml</span>
<a id=__codelineno-189-9 name=__codelineno-189-9 href=#__codelineno-189-9></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>yum</span><span class=p>:</span>
<a id=__codelineno-189-10 name=__codelineno-189-10 href=#__codelineno-189-10></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;httpd&quot;</span>
<a id=__codelineno-189-11 name=__codelineno-189-11 href=#__codelineno-189-11></a><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id=__codelineno-189-12 name=__codelineno-189-12 href=#__codelineno-189-12></a>
<a id=__codelineno-189-13 name=__codelineno-189-13 href=#__codelineno-189-13></a><span class=c1># roles/example/tasks/debian.yml</span>
<a id=__codelineno-189-14 name=__codelineno-189-14 href=#__codelineno-189-14></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apt</span><span class=p>:</span>
<a id=__codelineno-189-15 name=__codelineno-189-15 href=#__codelineno-189-15></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;apache2&quot;</span>
<a id=__codelineno-189-16 name=__codelineno-189-16 href=#__codelineno-189-16></a><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</code></pre></div> <h3 id=角色使用>角色使用<a class=headerlink href=#角色使用 title="Permanent link">&para;</a></h3> <p>在<code>play</code>中使用<code>roles:</code> 来定义使用哪些role</p> <div class=highlight><pre><span></span><code><a id=__codelineno-190-1 name=__codelineno-190-1 href=#__codelineno-190-1></a><span class=nn>---</span>
<a id=__codelineno-190-2 name=__codelineno-190-2 href=#__codelineno-190-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-190-3 name=__codelineno-190-3 href=#__codelineno-190-3></a><span class=w>  </span><span class=nt>roles</span><span class=p>:</span>
<a id=__codelineno-190-4 name=__codelineno-190-4 href=#__codelineno-190-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">common</span>
<a id=__codelineno-190-5 name=__codelineno-190-5 href=#__codelineno-190-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
</code></pre></div> <p>这个 playbook 为一个角色 ‘x’ 指定了如下的行为</p> <ul> <li> <p>如果 <code>roles/x/tasks/main.yml</code> 存在, 其中列出的 tasks 将被添加到 play 中</p> </li> <li> <p>如果 <code>roles/x/handlers/main.yml</code> 存在, 其中列出的 handlers 将被添加到 play 中</p> </li> <li> <p>如果 <code>roles/x/vars/main.yml</code> 存在, 其中列出的 变量将被添加到 play 中</p> </li> <li> <p>如果 <code>roles/ x/defaults/main.yml</code>存在，其中列出的角色默认变量将被添加到play 中</p> </li> <li> <p>如果 <code>roles/x/meta/main.yml</code> 存在, 其中列出的 “角色依赖” 将被添加到 roles 列表中</p> </li> <li> <p>所有 <code>copy</code> tasks 可以引用 <code>roles/x/files/</code> 中的文件，不需要指明文件的全路径。</p> </li> <li> <p>所有 <code>script</code> tasks 可以引用 <code>roles/x/files/</code>中的脚本，不需要指明文件的全路径。</p> </li> <li> <p>所有 <code>template</code> tasks 可以引用 <code>roles/x/templates/</code> 中的文件，不需要指明文件的全路径。</p> </li> <li> <p>所有 <code>include</code> tasks 可以引用 <code>roles/x/tasks/</code> 中的文件，不需要指明文件的全路径。如果 roles 目录下有文件不存在，这些文件将被忽略。</p> </li> </ul> <p>当以这种方式使用时，playbook 的执行顺序如下:</p> <ul> <li><code>pre_tasks</code> 定义的所有任务</li> <li>到目前触发的<code>handlers</code>任务</li> <li><code>roles</code>中列出的每个角色将依次执行。 角色<code>meta/main.yml</code>中定义的任何角色依赖关系都将首先运行，但要遵循标签过滤和条件。</li> <li><code>tasks</code> 定义的所有任务</li> <li>到目前触发的<code>handlers</code>任务</li> <li><code>post_tasks</code> 定义的所有任务</li> <li>到目前触发的<code>handlers</code>任务</li> </ul> <p>从Ansible 2.4开始，您现在可以使用<code>import role</code>或<code>include role</code>将角色内联到任何其他任务中</p> <div class=highlight><pre><span></span><code><a id=__codelineno-191-1 name=__codelineno-191-1 href=#__codelineno-191-1></a><span class=nn>---</span>
<a id=__codelineno-191-2 name=__codelineno-191-2 href=#__codelineno-191-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-191-3 name=__codelineno-191-3 href=#__codelineno-191-3></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-191-4 name=__codelineno-191-4 href=#__codelineno-191-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-191-5 name=__codelineno-191-5 href=#__codelineno-191-5></a><span class=w>        </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;before</span><span class=nv> </span><span class=s>we</span><span class=nv> </span><span class=s>run</span><span class=nv> </span><span class=s>our</span><span class=nv> </span><span class=s>role&quot;</span>
<a id=__codelineno-191-6 name=__codelineno-191-6 href=#__codelineno-191-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>import_role</span><span class=p>:</span>
<a id=__codelineno-191-7 name=__codelineno-191-7 href=#__codelineno-191-7></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">example</span>
<a id=__codelineno-191-8 name=__codelineno-191-8 href=#__codelineno-191-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>include_role</span><span class=p>:</span>
<a id=__codelineno-191-9 name=__codelineno-191-9 href=#__codelineno-191-9></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">example</span>
<a id=__codelineno-191-10 name=__codelineno-191-10 href=#__codelineno-191-10></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-191-11 name=__codelineno-191-11 href=#__codelineno-191-11></a><span class=w>        </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;after</span><span class=nv> </span><span class=s>we</span><span class=nv> </span><span class=s>ran</span><span class=nv> </span><span class=s>our</span><span class=nv> </span><span class=s>role&quot;</span>
</code></pre></div> <p>使用角色可以用简单的名称，也可以使用绝对路径引入</p> <div class=highlight><pre><span></span><code><a id=__codelineno-192-1 name=__codelineno-192-1 href=#__codelineno-192-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-192-2 name=__codelineno-192-2 href=#__codelineno-192-2></a><span class=w>  </span><span class=nt>roles</span><span class=p>:</span>
<a id=__codelineno-192-3 name=__codelineno-192-3 href=#__codelineno-192-3></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=s>&#39;/path/to/my/roles/common&#39;</span>
</code></pre></div> <p><code>roles</code> 也可以接受其他关键字</p> <div class=highlight><pre><span></span><code><a id=__codelineno-193-1 name=__codelineno-193-1 href=#__codelineno-193-1></a><span class=nn>---</span>
<a id=__codelineno-193-2 name=__codelineno-193-2 href=#__codelineno-193-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-193-3 name=__codelineno-193-3 href=#__codelineno-193-3></a><span class=w>  </span><span class=nt>roles</span><span class=p>:</span>
<a id=__codelineno-193-4 name=__codelineno-193-4 href=#__codelineno-193-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">common</span>
<a id=__codelineno-193-5 name=__codelineno-193-5 href=#__codelineno-193-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo_app_instance</span>
<a id=__codelineno-193-6 name=__codelineno-193-6 href=#__codelineno-193-6></a><span class=w>      </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-193-7 name=__codelineno-193-7 href=#__codelineno-193-7></a><span class=w>        </span><span class=nt>dir</span><span class=p>:</span><span class=w> </span><span class=s>&#39;/opt/a&#39;</span>
<a id=__codelineno-193-8 name=__codelineno-193-8 href=#__codelineno-193-8></a><span class=w>        </span><span class=nt>app_port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5000</span>
<a id=__codelineno-193-9 name=__codelineno-193-9 href=#__codelineno-193-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo_app_instance</span>
<a id=__codelineno-193-10 name=__codelineno-193-10 href=#__codelineno-193-10></a><span class=w>      </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-193-11 name=__codelineno-193-11 href=#__codelineno-193-11></a><span class=w>        </span><span class=nt>dir</span><span class=p>:</span><span class=w> </span><span class=s>&#39;/opt/b&#39;</span>
<a id=__codelineno-193-12 name=__codelineno-193-12 href=#__codelineno-193-12></a><span class=w>        </span><span class=nt>app_port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5001</span>
</code></pre></div> <p>也可以换种语法书写</p> <div class=highlight><pre><span></span><code><a id=__codelineno-194-1 name=__codelineno-194-1 href=#__codelineno-194-1></a><span class=nn>---</span>
<a id=__codelineno-194-2 name=__codelineno-194-2 href=#__codelineno-194-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-194-3 name=__codelineno-194-3 href=#__codelineno-194-3></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-194-4 name=__codelineno-194-4 href=#__codelineno-194-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>include_role</span><span class=p>:</span>
<a id=__codelineno-194-5 name=__codelineno-194-5 href=#__codelineno-194-5></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo_app_instance</span>
<a id=__codelineno-194-6 name=__codelineno-194-6 href=#__codelineno-194-6></a><span class=w>      </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-194-7 name=__codelineno-194-7 href=#__codelineno-194-7></a><span class=w>        </span><span class=nt>dir</span><span class=p>:</span><span class=w> </span><span class=s>&#39;/opt/a&#39;</span>
<a id=__codelineno-194-8 name=__codelineno-194-8 href=#__codelineno-194-8></a><span class=w>        </span><span class=nt>app_port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5000</span>
<a id=__codelineno-194-9 name=__codelineno-194-9 href=#__codelineno-194-9></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div> <p>可以有条件的导入role</p> <div class=highlight><pre><span></span><code><a id=__codelineno-195-1 name=__codelineno-195-1 href=#__codelineno-195-1></a><span class=nn>---</span>
<a id=__codelineno-195-2 name=__codelineno-195-2 href=#__codelineno-195-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-195-3 name=__codelineno-195-3 href=#__codelineno-195-3></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-195-4 name=__codelineno-195-4 href=#__codelineno-195-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>include_role</span><span class=p>:</span>
<a id=__codelineno-195-5 name=__codelineno-195-5 href=#__codelineno-195-5></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">some_role</span>
<a id=__codelineno-195-6 name=__codelineno-195-6 href=#__codelineno-195-6></a><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=s>&quot;ansible_facts[&#39;os_family&#39;]</span><span class=nv> </span><span class=s>==</span><span class=nv> </span><span class=s>&#39;RedHat&#39;&quot;</span>
</code></pre></div> <p>也可以为角色内的任务分配标签</p> <div class=highlight><pre><span></span><code><a id=__codelineno-196-1 name=__codelineno-196-1 href=#__codelineno-196-1></a><span class=nn>---</span>
<a id=__codelineno-196-2 name=__codelineno-196-2 href=#__codelineno-196-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-196-3 name=__codelineno-196-3 href=#__codelineno-196-3></a><span class=w>  </span><span class=nt>roles</span><span class=p>:</span>
<a id=__codelineno-196-4 name=__codelineno-196-4 href=#__codelineno-196-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo</span>
<a id=__codelineno-196-5 name=__codelineno-196-5 href=#__codelineno-196-5></a><span class=w>      </span><span class=nt>tags</span><span class=p>:</span>
<a id=__codelineno-196-6 name=__codelineno-196-6 href=#__codelineno-196-6></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bar</span>
<a id=__codelineno-196-7 name=__codelineno-196-7 href=#__codelineno-196-7></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">baz</span>
<a id=__codelineno-196-8 name=__codelineno-196-8 href=#__codelineno-196-8></a><span class=w>    </span><span class=c1># using YAML shorthand, this is equivalent to the above:</span>
<a id=__codelineno-196-9 name=__codelineno-196-9 href=#__codelineno-196-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="p p-Indicator">{</span><span class=nt> role</span><span class=p>:</span><span class=w> </span><span class=nv>foo</span><span class="p p-Indicator">,</span><span class=nt> tags</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;bar&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;baz&quot;</span><span class="p p-Indicator">]</span><span class=w> </span><span class="p p-Indicator">}</span>
</code></pre></div> <p>换一种语法书写</p> <div class=highlight><pre><span></span><code><a id=__codelineno-197-1 name=__codelineno-197-1 href=#__codelineno-197-1></a><span class=nn>---</span>
<a id=__codelineno-197-2 name=__codelineno-197-2 href=#__codelineno-197-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-197-3 name=__codelineno-197-3 href=#__codelineno-197-3></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-197-4 name=__codelineno-197-4 href=#__codelineno-197-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>import_role</span><span class=p>:</span>
<a id=__codelineno-197-5 name=__codelineno-197-5 href=#__codelineno-197-5></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo</span>
<a id=__codelineno-197-6 name=__codelineno-197-6 href=#__codelineno-197-6></a><span class=w>      </span><span class=nt>tags</span><span class=p>:</span>
<a id=__codelineno-197-7 name=__codelineno-197-7 href=#__codelineno-197-7></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bar</span>
<a id=__codelineno-197-8 name=__codelineno-197-8 href=#__codelineno-197-8></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">baz</span>
</code></pre></div> <p>如果你想只给这个角色本身打上标记</p> <div class=highlight><pre><span></span><code><a id=__codelineno-198-1 name=__codelineno-198-1 href=#__codelineno-198-1></a><span class=nn>---</span>
<a id=__codelineno-198-2 name=__codelineno-198-2 href=#__codelineno-198-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-198-3 name=__codelineno-198-3 href=#__codelineno-198-3></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-198-4 name=__codelineno-198-4 href=#__codelineno-198-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>include_role</span><span class=p>:</span>
<a id=__codelineno-198-5 name=__codelineno-198-5 href=#__codelineno-198-5></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bar</span>
<a id=__codelineno-198-6 name=__codelineno-198-6 href=#__codelineno-198-6></a><span class=w>      </span><span class=nt>tags</span><span class=p>:</span>
<a id=__codelineno-198-7 name=__codelineno-198-7 href=#__codelineno-198-7></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo</span>
</code></pre></div> <blockquote> <p>本例中的标记不会被添加到include角色中的任务中</p> </blockquote> <h3 id=角色重复执行>角色重复执行<a class=headerlink href=#角色重复执行 title="Permanent link">&para;</a></h3> <p>Ansible只允许一个角色执行一次，即使定义了多次，如果角色上定义的参数对于每个定义都是相同的。例如</p> <div class=highlight><pre><span></span><code><a id=__codelineno-199-1 name=__codelineno-199-1 href=#__codelineno-199-1></a><span class=nn>---</span>
<a id=__codelineno-199-2 name=__codelineno-199-2 href=#__codelineno-199-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-199-3 name=__codelineno-199-3 href=#__codelineno-199-3></a><span class=w>  </span><span class=nt>roles</span><span class=p>:</span>
<a id=__codelineno-199-4 name=__codelineno-199-4 href=#__codelineno-199-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo</span>
<a id=__codelineno-199-5 name=__codelineno-199-5 href=#__codelineno-199-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo</span>
</code></pre></div> <p>鉴于以上所述，角色foo将只运行一次。</p> <p>要使角色多次运行，有两种选择：</p> <ul> <li>在每个角色定义中传递不同的参数。</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-200-1 name=__codelineno-200-1 href=#__codelineno-200-1></a><span class=nn>---</span>
<a id=__codelineno-200-2 name=__codelineno-200-2 href=#__codelineno-200-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-200-3 name=__codelineno-200-3 href=#__codelineno-200-3></a><span class=w>  </span><span class=nt>roles</span><span class=p>:</span>
<a id=__codelineno-200-4 name=__codelineno-200-4 href=#__codelineno-200-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo</span>
<a id=__codelineno-200-5 name=__codelineno-200-5 href=#__codelineno-200-5></a><span class=w>      </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-200-6 name=__codelineno-200-6 href=#__codelineno-200-6></a><span class=w>        </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=s>&quot;first&quot;</span>
<a id=__codelineno-200-7 name=__codelineno-200-7 href=#__codelineno-200-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="p p-Indicator">{</span><span class=nt> role</span><span class=p>:</span><span class=w> </span><span class=nv>foo</span><span class="p p-Indicator">,</span><span class=nt> vars</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{</span><span class=nt> message</span><span class=p>:</span><span class=w> </span><span class=s>&quot;second&quot;</span><span class=w> </span><span class="p p-Indicator">}</span><span class=w> </span><span class="p p-Indicator">}</span>
</code></pre></div> <ul> <li>在角色的 <code>meta/main.yml</code> 文件中添加 <code>allow_duplicates：true</code>。</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-201-1 name=__codelineno-201-1 href=#__codelineno-201-1></a><span class=c1># playbook.yml</span>
<a id=__codelineno-201-2 name=__codelineno-201-2 href=#__codelineno-201-2></a><span class=nn>---</span>
<a id=__codelineno-201-3 name=__codelineno-201-3 href=#__codelineno-201-3></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-201-4 name=__codelineno-201-4 href=#__codelineno-201-4></a><span class=w>  </span><span class=nt>roles</span><span class=p>:</span>
<a id=__codelineno-201-5 name=__codelineno-201-5 href=#__codelineno-201-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo</span>
<a id=__codelineno-201-6 name=__codelineno-201-6 href=#__codelineno-201-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo</span>
<a id=__codelineno-201-7 name=__codelineno-201-7 href=#__codelineno-201-7></a>
<a id=__codelineno-201-8 name=__codelineno-201-8 href=#__codelineno-201-8></a><span class=c1># roles/foo/meta/main.yml</span>
<a id=__codelineno-201-9 name=__codelineno-201-9 href=#__codelineno-201-9></a><span class=nn>---</span>
<a id=__codelineno-201-10 name=__codelineno-201-10 href=#__codelineno-201-10></a><span class=nt>allow_duplicates</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div> <h3 id=角色默认变量>角色默认变量<a class=headerlink href=#角色默认变量 title="Permanent link">&para;</a></h3> <p>定义角色默认变量，只需在角色目录中添加一个<code>defaults/main.yml</code>文件。角色默认变量优先级最低,很容易被其他变量覆盖掉。</p> <h3 id=角色依赖>角色依赖<a class=headerlink href=#角色依赖 title="Permanent link">&para;</a></h3> <p>角色依赖性使您可以在使用角色时 <strong>自动导入</strong> 其他角色。 角色相关性存储在角色目录中包含的<code>meta/main.yml</code>文件中，如上所述。 该文件应包含要在指定角色之前插入的角色和参数的列表，例如在<code>role/myapp/meta/main.yml</code>示例中的以下内容：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-202-1 name=__codelineno-202-1 href=#__codelineno-202-1></a><span class=nn>---</span>
<a id=__codelineno-202-2 name=__codelineno-202-2 href=#__codelineno-202-2></a><span class=nt>dependencies</span><span class=p>:</span>
<a id=__codelineno-202-3 name=__codelineno-202-3 href=#__codelineno-202-3></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">common</span>
<a id=__codelineno-202-4 name=__codelineno-202-4 href=#__codelineno-202-4></a><span class=w>    </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-202-5 name=__codelineno-202-5 href=#__codelineno-202-5></a><span class=w>      </span><span class=nt>some_parameter</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id=__codelineno-202-6 name=__codelineno-202-6 href=#__codelineno-202-6></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apache</span>
<a id=__codelineno-202-7 name=__codelineno-202-7 href=#__codelineno-202-7></a><span class=w>    </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-202-8 name=__codelineno-202-8 href=#__codelineno-202-8></a><span class=w>      </span><span class=nt>apache_port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<a id=__codelineno-202-9 name=__codelineno-202-9 href=#__codelineno-202-9></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<a id=__codelineno-202-10 name=__codelineno-202-10 href=#__codelineno-202-10></a><span class=w>    </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-202-11 name=__codelineno-202-11 href=#__codelineno-202-11></a><span class=w>      </span><span class=nt>dbname</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">blarg</span>
<a id=__codelineno-202-12 name=__codelineno-202-12 href=#__codelineno-202-12></a><span class=w>      </span><span class=nt>other_parameter</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">12</span>
</code></pre></div> <blockquote> <p>角色依赖项必须使用经典的角色定义样式。</p> </blockquote> <p>角色依赖项始终在包含它们的角色之前执行，并且可能是递归的。 依赖性也遵循上面指定的复制规则。 如果另一个角色也将其列为依赖项，则不会根据上述相同规则再次运行它。</p> <blockquote> <p>永远记住，当使用<code>allow_duplicates：true</code>时，它必须位于从属角色的<code>meta/main.yml</code>中，而不是父角色中。</p> </blockquote> <p>例如，一个名为car的角色依赖于一个名为wheel的角色，如下所示</p> <div class=highlight><pre><span></span><code><a id=__codelineno-203-1 name=__codelineno-203-1 href=#__codelineno-203-1></a><span class=nn>---</span>
<a id=__codelineno-203-2 name=__codelineno-203-2 href=#__codelineno-203-2></a><span class=nt>dependencies</span><span class=p>:</span>
<a id=__codelineno-203-3 name=__codelineno-203-3 href=#__codelineno-203-3></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">wheel</span>
<a id=__codelineno-203-4 name=__codelineno-203-4 href=#__codelineno-203-4></a><span class=w>    </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-203-5 name=__codelineno-203-5 href=#__codelineno-203-5></a><span class=w>      </span><span class=nt>n</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-203-6 name=__codelineno-203-6 href=#__codelineno-203-6></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">wheel</span>
<a id=__codelineno-203-7 name=__codelineno-203-7 href=#__codelineno-203-7></a><span class=w>    </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-203-8 name=__codelineno-203-8 href=#__codelineno-203-8></a><span class=w>      </span><span class=nt>n</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a id=__codelineno-203-9 name=__codelineno-203-9 href=#__codelineno-203-9></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">wheel</span>
<a id=__codelineno-203-10 name=__codelineno-203-10 href=#__codelineno-203-10></a><span class=w>    </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-203-11 name=__codelineno-203-11 href=#__codelineno-203-11></a><span class=w>      </span><span class=nt>n</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id=__codelineno-203-12 name=__codelineno-203-12 href=#__codelineno-203-12></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">wheel</span>
<a id=__codelineno-203-13 name=__codelineno-203-13 href=#__codelineno-203-13></a><span class=w>    </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-203-14 name=__codelineno-203-14 href=#__codelineno-203-14></a><span class=w>      </span><span class=nt>n</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
</code></pre></div> <p><code>wheel</code>角色又依赖两个角色：<code>tire</code>和<code>brake</code>。 wheel的<code>meta/main.yml</code>包含以下内容：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-204-1 name=__codelineno-204-1 href=#__codelineno-204-1></a><span class=nn>---</span>
<a id=__codelineno-204-2 name=__codelineno-204-2 href=#__codelineno-204-2></a><span class=nt>dependencies</span><span class=p>:</span>
<a id=__codelineno-204-3 name=__codelineno-204-3 href=#__codelineno-204-3></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">tire</span>
<a id=__codelineno-204-4 name=__codelineno-204-4 href=#__codelineno-204-4></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">brake</span>
</code></pre></div> <p><code>tire</code>和<code>brake</code>的<code>meta/main.yml</code>将包含以下内容：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-205-1 name=__codelineno-205-1 href=#__codelineno-205-1></a><span class=nn>---</span>
<a id=__codelineno-205-2 name=__codelineno-205-2 href=#__codelineno-205-2></a><span class=nt>allow_duplicates</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div> <p>产生的执行顺序如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-206-1 name=__codelineno-206-1 href=#__codelineno-206-1></a><span class="l l-Scalar l-Scalar-Plain">tire(n=1)</span>
<a id=__codelineno-206-2 name=__codelineno-206-2 href=#__codelineno-206-2></a><span class="l l-Scalar l-Scalar-Plain">brake(n=1)</span>
<a id=__codelineno-206-3 name=__codelineno-206-3 href=#__codelineno-206-3></a><span class="l l-Scalar l-Scalar-Plain">wheel(n=1)</span>
<a id=__codelineno-206-4 name=__codelineno-206-4 href=#__codelineno-206-4></a><span class="l l-Scalar l-Scalar-Plain">tire(n=2)</span>
<a id=__codelineno-206-5 name=__codelineno-206-5 href=#__codelineno-206-5></a><span class="l l-Scalar l-Scalar-Plain">brake(n=2)</span>
<a id=__codelineno-206-6 name=__codelineno-206-6 href=#__codelineno-206-6></a><span class="l l-Scalar l-Scalar-Plain">wheel(n=2)</span>
<a id=__codelineno-206-7 name=__codelineno-206-7 href=#__codelineno-206-7></a><span class=nn>...</span>
<a id=__codelineno-206-8 name=__codelineno-206-8 href=#__codelineno-206-8></a><span class="l l-Scalar l-Scalar-Plain">car</span>
</code></pre></div> <blockquote> <p>注意，我们在wheel可以不必使用<code>allow duplicate: true</code> ，因为car定义的每个role使用不同的参数值。</p> </blockquote> <h3 id=嵌入模块和插件>嵌入模块和插件<a class=headerlink href=#嵌入模块和插件 title="Permanent link">&para;</a></h3> <p>如果您编写了自定义模块或插件，您可能希望将其作为角色的一部分进行分享。</p> <p>除了角色的<code>tasks</code>和<code>handlers</code>结构之外，还要添加一个名为<code>library</code>的目录。在这个库目录中，然后将模块直接包含在其中。</p> <p>比如下面这样</p> <div class=highlight><pre><span></span><code><a id=__codelineno-207-1 name=__codelineno-207-1 href=#__codelineno-207-1></a><span class="l l-Scalar l-Scalar-Plain">roles/</span>
<a id=__codelineno-207-2 name=__codelineno-207-2 href=#__codelineno-207-2></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">my_custom_modules/</span>
<a id=__codelineno-207-3 name=__codelineno-207-3 href=#__codelineno-207-3></a><span class=w>        </span><span class="l l-Scalar l-Scalar-Plain">library/</span>
<a id=__codelineno-207-4 name=__codelineno-207-4 href=#__codelineno-207-4></a><span class=w>            </span><span class="l l-Scalar l-Scalar-Plain">module1</span>
<a id=__codelineno-207-5 name=__codelineno-207-5 href=#__codelineno-207-5></a><span class=w>            </span><span class="l l-Scalar l-Scalar-Plain">module2</span>
</code></pre></div> <p>该自定义的模块在角色本身以及在此角色之后调用的任何角色中都是可用的</p> <div class=highlight><pre><span></span><code><a id=__codelineno-208-1 name=__codelineno-208-1 href=#__codelineno-208-1></a><span class=nn>---</span>
<a id=__codelineno-208-2 name=__codelineno-208-2 href=#__codelineno-208-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-208-3 name=__codelineno-208-3 href=#__codelineno-208-3></a><span class=w>  </span><span class=nt>roles</span><span class=p>:</span>
<a id=__codelineno-208-4 name=__codelineno-208-4 href=#__codelineno-208-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my_custom_modules</span>
<a id=__codelineno-208-5 name=__codelineno-208-5 href=#__codelineno-208-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">some_other_role_using_my_custom_modules</span>
<a id=__codelineno-208-6 name=__codelineno-208-6 href=#__codelineno-208-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yet_another_role_using_my_custom_modules</span>
</code></pre></div> <p>相同的情况，如果开发自定义的插件，需要放在<code>filter_plugins</code>目录中，角色就可以使用了</p> <div class=highlight><pre><span></span><code><a id=__codelineno-209-1 name=__codelineno-209-1 href=#__codelineno-209-1></a>roles/
<a id=__codelineno-209-2 name=__codelineno-209-2 href=#__codelineno-209-2></a>    my_custom_filter/
<a id=__codelineno-209-3 name=__codelineno-209-3 href=#__codelineno-209-3></a>        filter_plugins
<a id=__codelineno-209-4 name=__codelineno-209-4 href=#__codelineno-209-4></a>            filter1
<a id=__codelineno-209-5 name=__codelineno-209-5 href=#__codelineno-209-5></a>            filter2
</code></pre></div> <p>如果说模块和插件需要给多个role使用，那就可以放置在ansible的插件目录中，这样，任何role都可以使用了。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-210-1 name=__codelineno-210-1 href=#__codelineno-210-1></a>/etc/ansible/roles/
<a id=__codelineno-210-2 name=__codelineno-210-2 href=#__codelineno-210-2></a>    filter_plugins
<a id=__codelineno-210-3 name=__codelineno-210-3 href=#__codelineno-210-3></a>        filter1
<a id=__codelineno-210-4 name=__codelineno-210-4 href=#__codelineno-210-4></a>    library/
<a id=__codelineno-210-5 name=__codelineno-210-5 href=#__codelineno-210-5></a>        module1
<a id=__codelineno-210-6 name=__codelineno-210-6 href=#__codelineno-210-6></a>    my_custom_filter/
<a id=__codelineno-210-7 name=__codelineno-210-7 href=#__codelineno-210-7></a>    my_custom_modules/
</code></pre></div> <h3 id=角色搜索路径>角色搜索路径<a class=headerlink href=#角色搜索路径 title="Permanent link">&para;</a></h3> <ul> <li>位于playbook目录下的<code>roles/</code>目录</li> <li>默认情况下的<code>/etc/ansible/roles</code>目录</li> </ul> <p>在Ansible 1.4和更高版本中，您可以配置其他<code>role_path</code>来搜索角色。 使用此功能可以将所有常见角色签到一个位置，并在多个剧本项目之间轻松共享它们。 有关如何在<code>ansible.cfg</code>中进行设置的详细信息，请参见配置Ansible。</p> <h3 id=ansible-galaxy_1>Ansible Galaxy<a class=headerlink href=#ansible-galaxy_1 title="Permanent link">&para;</a></h3> <p>Ansible Galaxy是一个免费的网站，可以找到，下载，评级，并审查各种社区开发的Ansible角色，可以是一个伟大的方式来启动你的自动化项目。</p> <p>可以使用<code>ansible-galaxy</code> 初始化一个角色基础目录结构</p> <div class=highlight><pre><span></span><code><a id=__codelineno-211-1 name=__codelineno-211-1 href=#__codelineno-211-1></a><span class=c1># ansible-galaxy init demo</span>
<a id=__codelineno-211-2 name=__codelineno-211-2 href=#__codelineno-211-2></a>-<span class=w> </span>Role<span class=w> </span>demo<span class=w> </span>was<span class=w> </span>created<span class=w> </span>successfully
<a id=__codelineno-211-3 name=__codelineno-211-3 href=#__codelineno-211-3></a><span class=c1># tree demo</span>
<a id=__codelineno-211-4 name=__codelineno-211-4 href=#__codelineno-211-4></a>demo
<a id=__codelineno-211-5 name=__codelineno-211-5 href=#__codelineno-211-5></a>├──<span class=w> </span>defaults
<a id=__codelineno-211-6 name=__codelineno-211-6 href=#__codelineno-211-6></a><span class=w>    </span>└──<span class=w> </span>main.yml
<a id=__codelineno-211-7 name=__codelineno-211-7 href=#__codelineno-211-7></a>├──<span class=w> </span>files
<a id=__codelineno-211-8 name=__codelineno-211-8 href=#__codelineno-211-8></a>├──<span class=w> </span>handlers
<a id=__codelineno-211-9 name=__codelineno-211-9 href=#__codelineno-211-9></a><span class=w>    </span>└──<span class=w> </span>main.yml
<a id=__codelineno-211-10 name=__codelineno-211-10 href=#__codelineno-211-10></a>├──<span class=w> </span>meta
<a id=__codelineno-211-11 name=__codelineno-211-11 href=#__codelineno-211-11></a><span class=w>    </span>└──<span class=w> </span>main.yml
<a id=__codelineno-211-12 name=__codelineno-211-12 href=#__codelineno-211-12></a>├──<span class=w> </span>README.md
<a id=__codelineno-211-13 name=__codelineno-211-13 href=#__codelineno-211-13></a>├──<span class=w> </span>tasks
<a id=__codelineno-211-14 name=__codelineno-211-14 href=#__codelineno-211-14></a><span class=w>    </span>└──<span class=w> </span>main.yml
<a id=__codelineno-211-15 name=__codelineno-211-15 href=#__codelineno-211-15></a>├──<span class=w> </span>templates
<a id=__codelineno-211-16 name=__codelineno-211-16 href=#__codelineno-211-16></a>├──<span class=w> </span>tests
<a id=__codelineno-211-17 name=__codelineno-211-17 href=#__codelineno-211-17></a><span class=w>    </span>├──<span class=w> </span>inventory
<a id=__codelineno-211-18 name=__codelineno-211-18 href=#__codelineno-211-18></a><span class=w>    </span>└──<span class=w> </span>test.yml
<a id=__codelineno-211-19 name=__codelineno-211-19 href=#__codelineno-211-19></a>└──<span class=w> </span>vars
<a id=__codelineno-211-20 name=__codelineno-211-20 href=#__codelineno-211-20></a><span class=w>    </span>└──<span class=w> </span>main.yml
<a id=__codelineno-211-21 name=__codelineno-211-21 href=#__codelineno-211-21></a>
<a id=__codelineno-211-22 name=__codelineno-211-22 href=#__codelineno-211-22></a><span class=m>8</span><span class=w> </span>directories,<span class=w> </span><span class=m>8</span><span class=w> </span>files
</code></pre></div> <h3 id=角色示例参考>角色示例参考<a class=headerlink href=#角色示例参考 title="Permanent link">&para;</a></h3> <p><a href=https://galaxy.ansible.com/ >https://galaxy.ansible.com/</a></p> <p><a href=https://github.com/ansible/ansible-examples>https://github.com/ansible/ansible-examples</a> </p> <p><a href=https://github.com/lework/Ansible-roles>https://github.com/lework/Ansible-roles</a></p> <p><a href=https://github.com/geerlingguy>https://github.com/geerlingguy</a></p> <p><a href=https://github.com/debops>https://github.com/debops</a></p> <h2 id=10使用变量>10.使用变量<a class=headerlink href=#10使用变量 title="Permanent link">&para;</a></h2> <p>虽然自动化的存在是为了让事情更容易重复，但并非所有的系统都是完全相同的;有些可能需要的配置与其他的稍有不同。在某些情况下，所观察到的一个系统的行为或状态可能会影响您配置其他系统的方式。例如，您可能需要找到一个系统的IP地址，并将其用作另一个系统上的配置值。</p> <p>Ansible使用 <strong>变量(<em>variables</em> )</strong> 来帮助处理系统之间的差异。</p> <h3 id=创建有效的变量名>创建有效的变量名<a class=headerlink href=#创建有效的变量名 title="Permanent link">&para;</a></h3> <p>在使用变量之前，你要先知道什么是 <strong>有效</strong> 的变量名称, 以下是变量名的遵循规则</p> <ul> <li> <p>变量名称应为 <strong>字母</strong>，<strong>数字</strong> 和 <strong>下划线</strong>。 </p> </li> <li> <p>变量应始终 <strong>以字母开头</strong>。</p> </li> <li> <p>变量名不应与python属性和方法名冲突。</p> </li> </ul> <p>YAML还支持将键映射到值的字典</p> <div class=highlight><pre><span></span><code><a id=__codelineno-212-1 name=__codelineno-212-1 href=#__codelineno-212-1></a><span class=nt>foo</span><span class=p>:</span>
<a id=__codelineno-212-2 name=__codelineno-212-2 href=#__codelineno-212-2></a><span class=w>  </span><span class=nt>field1</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">one</span>
<a id=__codelineno-212-3 name=__codelineno-212-3 href=#__codelineno-212-3></a><span class=w>  </span><span class=nt>field2</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">two</span>
</code></pre></div> <p>然后，您可以使用方括号符号或点符号来引用字典中的特定字段</p> <div class=highlight><pre><span></span><code><a id=__codelineno-213-1 name=__codelineno-213-1 href=#__codelineno-213-1></a><span class="l l-Scalar l-Scalar-Plain">foo[&#39;field1&#39;]</span>
<a id=__codelineno-213-2 name=__codelineno-213-2 href=#__codelineno-213-2></a><span class="l l-Scalar l-Scalar-Plain">foo.field2</span>
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>如果选择使用点表示法，请注意某些键可能会引起问题，因为它们与python词典的属性和方法冲突。 如果您使用以两个下划线开头和结尾的键（这些键在python中保留了特殊含义）或为任何已知的公共属性，则应使用方括号而不是点符号。add<code>,</code>append<code>,</code>as_integer_ratio<code>,</code>bit_length<code>,</code>capitalize<code>,</code>center<code>,</code>clear<code>,</code>conjugate<code>,</code>copy<code>,</code>count<code>,</code>decode<code>,</code>denominator<code>,</code>difference<code>,</code>difference_update<code>,</code>discard<code>,</code>encode<code>,</code>endswith<code>,</code>expandtabs<code>,</code>extend<code>,</code>find<code>,</code>format<code>,</code>fromhex<code>,</code>fromkeys<code>,</code>get<code>,</code>has_key<code>,</code>hex<code>,</code>imag<code>,</code>index<code>,</code>insert<code>,</code>intersection<code>,</code>intersection_update<code>,</code>isalnum<code>,</code>isalpha<code>,</code>isdecimal<code>,</code>isdigit<code>,</code>isdisjoint<code>,</code>is_integer<code>,</code>islower<code>,</code>isnumeric<code>,</code>isspace<code>,</code>issubset<code>,</code>issuperset<code>,</code>istitle<code>,</code>isupper<code>,</code>items<code>,</code>iteritems<code>,</code>iterkeys<code>,</code>itervalues<code>,</code>join<code>,</code>keys<code>,</code>ljust<code>,</code>lower<code>,</code>lstrip<code>,</code>numerator<code>,</code>partition<code>,</code>pop<code>,</code>popitem<code>,</code>real<code>,</code>remove<code>,</code>replace<code>,</code>reverse<code>,</code>rfind<code>,</code>rindex<code>,</code>rjust<code>,</code>rpartition<code>,</code>rsplit<code>,</code>rstrip<code>,</code>setdefault<code>,</code>sort<code>,</code>split<code>,</code>splitlines<code>,</code>startswith<code>,</code>strip<code>,</code>swapcase<code>,</code>symmetric_difference<code>,</code>symmetric_difference_update<code>,</code>title<code>,</code>translate<code>,</code>union<code>,</code>update<code>,</code>upper<code>,</code>values<code>,</code>viewitems<code>,</code>viewkeys<code>,</code>viewvalues<code>,</code>zfill</p> </div> <h3 id=变量使用>变量使用<a class=headerlink href=#变量使用 title="Permanent link">&para;</a></h3> <h4 id=通过命令行传递变量extra-vars>通过命令行传递变量(extra vars)<a class=headerlink href=#通过命令行传递变量extra-vars title="Permanent link">&para;</a></h4> <p>通过<code>--extra-vars</code>或<code>-e</code>选项来传递<code>key=value</code>变量</p> <div class=highlight><pre><span></span><code><a id=__codelineno-214-1 name=__codelineno-214-1 href=#__codelineno-214-1></a>ansible-playbook<span class=w> </span>release.yml<span class=w> </span>-e<span class=w> </span><span class=s2>&quot;user=starbuck&quot;</span>
</code></pre></div> <p>当然，也可以传递字典</p> <div class=highlight><pre><span></span><code><a id=__codelineno-215-1 name=__codelineno-215-1 href=#__codelineno-215-1></a>ansible-playbook<span class=w> </span>arcade.yml<span class=w> </span>-e<span class=w> </span><span class=s1>&#39;{&quot;pacman&quot;:&quot;mrs&quot;,&quot;ghosts&quot;:[&quot;inky&quot;,&quot;pinky&quot;,&quot;clyde&quot;,&quot;sue&quot;]}&#39;</span>
</code></pre></div> <p>变量文件的话，也是可以的</p> <div class=highlight><pre><span></span><code><a id=__codelineno-216-1 name=__codelineno-216-1 href=#__codelineno-216-1></a>ansible-playbook<span class=w> </span>test.yml<span class=w> </span>-e<span class=w> </span>@variables.yaml
</code></pre></div> <p>yaml格式的变量，也是可以传递的</p> <div class=highlight><pre><span></span><code><a id=__codelineno-217-1 name=__codelineno-217-1 href=#__codelineno-217-1></a>ansible-playbook<span class=w> </span>arcade.yml<span class=w> </span>--extra-vars<span class=w> </span><span class=s1>&#39;</span>
<a id=__codelineno-217-2 name=__codelineno-217-2 href=#__codelineno-217-2></a><span class=s1>pacman: mrs</span>
<a id=__codelineno-217-3 name=__codelineno-217-3 href=#__codelineno-217-3></a><span class=s1>ghosts:</span>
<a id=__codelineno-217-4 name=__codelineno-217-4 href=#__codelineno-217-4></a><span class=s1>  - inky</span>
<a id=__codelineno-217-5 name=__codelineno-217-5 href=#__codelineno-217-5></a><span class=s1>  - pinky</span>
<a id=__codelineno-217-6 name=__codelineno-217-6 href=#__codelineno-217-6></a><span class=s1>  - clyde</span>
<a id=__codelineno-217-7 name=__codelineno-217-7 href=#__codelineno-217-7></a><span class=s1>  - sue&#39;</span>
</code></pre></div> <h4 id=在inventory-中定义变量inventory-vars>在inventory 中定义变量（inventory vars)<a class=headerlink href=#在inventory-中定义变量inventory-vars title="Permanent link">&para;</a></h4> <p>通常，您需要为单个主机或清单中的一组主机设置变量。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-218-1 name=__codelineno-218-1 href=#__codelineno-218-1></a><span class=na>host3 http_port</span><span class=o>=</span><span class=s>80</span><span class=w>                        </span><span class=c1># 定义主机变量</span>
<a id=__codelineno-218-2 name=__codelineno-218-2 href=#__codelineno-218-2></a><span class=na>[webservers</span><span class=o>:</span><span class=s>vars]</span><span class=w>                        </span><span class=c1># 定义组的变量</span>
<a id=__codelineno-218-3 name=__codelineno-218-3 href=#__codelineno-218-3></a><span class=na>ntp_server</span><span class=o>=</span><span class=w> </span><span class=s>ntp.example.com</span>
</code></pre></div> <h4 id=在play中定义变量play-vars>在play中定义变量（play vars）<a class=headerlink href=#在play中定义变量play-vars title="Permanent link">&para;</a></h4> <p>你可以通过<code>play</code>的<code>vars</code> 关键字来定义变量</p> <div class=highlight><pre><span></span><code><a id=__codelineno-219-1 name=__codelineno-219-1 href=#__codelineno-219-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-219-2 name=__codelineno-219-2 href=#__codelineno-219-2></a><span class=w>  </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-219-3 name=__codelineno-219-3 href=#__codelineno-219-3></a><span class=w>    </span><span class=nt>http_port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div> <h4 id=在角色和文件包含中定义变量play-include_vars>在角色和文件包含中定义变量(play include_vars)<a class=headerlink href=#在角色和文件包含中定义变量play-include_vars title="Permanent link">&para;</a></h4> <p>通过在playbook中定义<code>include_vars</code> 模块，来包含变量文件</p> <div class=highlight><pre><span></span><code><a id=__codelineno-220-1 name=__codelineno-220-1 href=#__codelineno-220-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-220-2 name=__codelineno-220-2 href=#__codelineno-220-2></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-220-3 name=__codelineno-220-3 href=#__codelineno-220-3></a><span class=w>    </span><span class=nt>include_vars</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myvars.yml</span>
</code></pre></div> <h4 id=在play中包含变量文件play-vars_files>在play中包含变量文件(play vars_files)<a class=headerlink href=#在play中包含变量文件play-vars_files title="Permanent link">&para;</a></h4> <p>你可以通过<code>play</code>的<code>vars_files</code> 关键字来定义变量的文件</p> <div class=highlight><pre><span></span><code><a id=__codelineno-221-1 name=__codelineno-221-1 href=#__codelineno-221-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-221-2 name=__codelineno-221-2 href=#__codelineno-221-2></a><span class=w>  </span><span class=nt>vars_files</span><span class=p>:</span>
<a id=__codelineno-221-3 name=__codelineno-221-3 href=#__codelineno-221-3></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/vars/external_vars.yml</span>
</code></pre></div> <h4 id=定义角色默认变量role-defaults-vars>定义角色默认变量（role defaults vars）<a class=headerlink href=#定义角色默认变量role-defaults-vars title="Permanent link">&para;</a></h4> <p>在角色目录中添加一个<code>defaults/main.yml</code>文件。文件里存储着<code>yaml</code>或<code>json</code>格式的数据。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-222-1 name=__codelineno-222-1 href=#__codelineno-222-1></a><span class=c1># file: roles/x/defaults/main.yml</span>
<a id=__codelineno-222-2 name=__codelineno-222-2 href=#__codelineno-222-2></a><span class=nt>http_port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div> <h4 id=定义角色变量role--vars>定义角色变量（role vars）<a class=headerlink href=#定义角色变量role--vars title="Permanent link">&para;</a></h4> <p>在角色目录中添加一个<code>vars/main.yml</code>文件。文件里存储着<code>yaml</code>或<code>json</code>格式的数据。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-223-1 name=__codelineno-223-1 href=#__codelineno-223-1></a><span class=c1># file: roles/x/vars/main.yml</span>
<a id=__codelineno-223-2 name=__codelineno-223-2 href=#__codelineno-223-2></a><span class=nt>http_port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</code></pre></div> <h4 id=以交互方式获取变量值-play-vars_prompt>以交互方式获取变量值( play vars_prompt)<a class=headerlink href=#以交互方式获取变量值-play-vars_prompt title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-224-1 name=__codelineno-224-1 href=#__codelineno-224-1></a><span class=nn>---</span>
<a id=__codelineno-224-2 name=__codelineno-224-2 href=#__codelineno-224-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<a id=__codelineno-224-3 name=__codelineno-224-3 href=#__codelineno-224-3></a><span class=w>  </span><span class=nt>vars_prompt</span><span class=p>:</span>
<a id=__codelineno-224-4 name=__codelineno-224-4 href=#__codelineno-224-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<a id=__codelineno-224-5 name=__codelineno-224-5 href=#__codelineno-224-5></a><span class=w>      </span><span class=nt>prompt</span><span class=p>:</span><span class=w> </span><span class=s>&#39;Please</span><span class=nv> </span><span class=s>input</span><span class=nv> </span><span class=s>the</span><span class=nv> </span><span class=s>web</span><span class=nv> </span><span class=s>server:&#39;</span>
<a id=__codelineno-224-6 name=__codelineno-224-6 href=#__codelineno-224-6></a><span class=w>      </span><span class=nt>private</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
</code></pre></div> <h4 id=定义角色变量role-and-include-vars>定义角色变量（role and include vars)<a class=headerlink href=#定义角色变量role-and-include-vars title="Permanent link">&para;</a></h4> <p>在引入角色的时候，可以像角色传递一些变量</p> <div class=highlight><pre><span></span><code><a id=__codelineno-225-1 name=__codelineno-225-1 href=#__codelineno-225-1></a><span class=nt>roles</span><span class=p>:</span>
<a id=__codelineno-225-2 name=__codelineno-225-2 href=#__codelineno-225-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="p p-Indicator">{</span><span class=nt> role</span><span class=p>:</span><span class=w> </span><span class=nv>app_user</span><span class="p p-Indicator">,</span><span class=nt> name</span><span class=p>:</span><span class=w> </span><span class=nv>Ian</span><span class=w>    </span><span class="p p-Indicator">}</span>
</code></pre></div> <blockquote> <p><code>name</code> 就是传递给角色的变量</p> </blockquote> <h4 id=注册变量registered-vars>注册变量（registered vars）<a class=headerlink href=#注册变量registered-vars title="Permanent link">&para;</a></h4> <p>变量的另一个主要用途是运行命令并将该命令的结果注册为变量。当您执行一个任务并将返回值保存在一个变量中供以后的任务使用时，您将创建一个已注册的变量。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-226-1 name=__codelineno-226-1 href=#__codelineno-226-1></a><span class=nn>---</span>
<a id=__codelineno-226-2 name=__codelineno-226-2 href=#__codelineno-226-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">all</span><span class=w> </span>
<a id=__codelineno-226-3 name=__codelineno-226-3 href=#__codelineno-226-3></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-226-4 name=__codelineno-226-4 href=#__codelineno-226-4></a>
<a id=__codelineno-226-5 name=__codelineno-226-5 href=#__codelineno-226-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">uptime</span>
<a id=__codelineno-226-6 name=__codelineno-226-6 href=#__codelineno-226-6></a><span class=w>      </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">result</span>
<a id=__codelineno-226-7 name=__codelineno-226-7 href=#__codelineno-226-7></a>
<a id=__codelineno-226-8 name=__codelineno-226-8 href=#__codelineno-226-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">show uptime</span>
<a id=__codelineno-226-9 name=__codelineno-226-9 href=#__codelineno-226-9></a><span class=w>      </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">var=result</span>
</code></pre></div> <blockquote> <p>此选项将任务的结果存储在变量中，结果参数可以用在模版中。名称为result，使用debug来输出result的信息。也可以使用 <code>{{ hostvars[inventory_hostname].result.stdout }}</code> 可以获得注册变量的</p> </blockquote> <p>结果因模块而异。 每个模块的文档都包含一个<code>RETURN</code>部分，描述该模块的返回值。 要查看特定任务的值，请使用<code>-v</code>运行您的剧本。</p> <p>注册变量仅存储在内存中, 当您用循环在任务中注册一个变量时，已注册的变量包含循环中每个项的值。在循环期间放置在变量中的数据结构将包含一个results属性，它是来自模块的所有响应的列表。</p> <p>以下是一些重要的注册变量的组件：</p> <ul> <li>changed: 显示是否已更改</li> <li>cmd: 执行的命令</li> <li>rc: 命令的返回码</li> <li>stdout:命令的输出</li> <li>stdout_lines: 逐行输出</li> <li>stderr: 如果有错误，则输出错误的信息</li> <li>stderr_lines: 逐行输出错误信息</li> </ul> <h4 id=动态创建fact变量>动态创建fact变量<a class=headerlink href=#动态创建fact变量 title="Permanent link">&para;</a></h4> <p>使用<code>set_fact</code> 在运行中设置 facts 变量</p> <div class=highlight><pre><span></span><code><a id=__codelineno-227-1 name=__codelineno-227-1 href=#__codelineno-227-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-227-2 name=__codelineno-227-2 href=#__codelineno-227-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">whoami</span>
<a id=__codelineno-227-3 name=__codelineno-227-3 href=#__codelineno-227-3></a><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">result</span>
<a id=__codelineno-227-4 name=__codelineno-227-4 href=#__codelineno-227-4></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>set_fact</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">w={{result.stdout}}</span>
<a id=__codelineno-227-5 name=__codelineno-227-5 href=#__codelineno-227-5></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">var=w</span>
</code></pre></div> <h3 id=变量优先级>变量优先级<a class=headerlink href=#变量优先级 title="Permanent link">&para;</a></h3> <p>上面列出了大部分的变量定义位置，这些不同位置的变量都是有优先级的，在不同位置上同时设置时，高优先级的会覆盖掉低优先级的变量，</p> <p>下面是优先级从最小到最大的顺序(最后列出的变量是最高优先级)</p> <ol> <li>command line values (eg “-u user”) </li> <li>role defaults </li> <li>inventory file or script group vars</li> <li>inventory group_vars/all</li> <li>playbook group_vars/all</li> <li>inventory group_vars/*</li> <li>playbook group_vars/* </li> <li>inventory file or script host vars</li> <li>inventory host_vars/* </li> <li>playbook host_vars/* </li> <li>host facts / cached set_facts </li> <li>play vars</li> <li>play vars_prompt</li> <li>play vars_files</li> <li>role vars (defined in role/vars/main.yml)</li> <li>block vars (only for tasks in block)</li> <li>task vars (only for the task)</li> <li>include_vars</li> <li>set_facts / registered vars</li> <li>role (and include_role) params</li> <li>include params</li> <li>extra vars (always win precedence) 命令行变量</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>上述描述的是默认规则变量覆盖<code>hash_behaviour=replace</code>, 使用<code>merge</code> 可以更改为合并。</p> </div> <h3 id=变量范围>变量范围<a class=headerlink href=#变量范围 title="Permanent link">&para;</a></h3> <p>您可以根据希望的范围来决定在何处设置变量。Ansible有三个主要的范围 </p> <ul> <li> <p>全局：这是由config，环境变量和命令行设置的</p> </li> <li> <p>play：每个play和包含的结构，vars条目(vars; vars_files; vars_prompt)，角色默认变量和vars。</p> </li> <li> <p>主机：直接与主机相关联的变量，像inventory, include_vars, facts or registered </p> </li> </ul> <h3 id=使用变量_1>使用变量<a class=headerlink href=#使用变量_1 title="Permanent link">&para;</a></h3> <h4 id=在jinja2中使用>在jinja2中使用<a class=headerlink href=#在jinja2中使用 title="Permanent link">&para;</a></h4> <p>一旦定义了变量，就可以在使用Jinja2模板系统的剧本中使用它们。这是一个简单的Jinja2模板</p> <div class=highlight><pre><span></span><code><a id=__codelineno-228-1 name=__codelineno-228-1 href=#__codelineno-228-1></a>My amp goes to {{ max_amp_value }}
</code></pre></div> <p>这个表达式提供了最基本的变量替换形式。</p> <p>您可以在剧本中使用相同的语法。例如</p> <div class=highlight><pre><span></span><code><a id=__codelineno-229-1 name=__codelineno-229-1 href=#__codelineno-229-1></a><span class=nt>template</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">src=foo.cfg.j2 dest={{ remote_install_path }}/foo.cfg</span>
</code></pre></div> <h4 id=使用jinja2过滤器转换变量>使用Jinja2过滤器转换变量<a class=headerlink href=#使用jinja2过滤器转换变量 title="Permanent link">&para;</a></h4> <p>Jinja2过滤器允许您在模板表达式中转换变量的值。例如，<code>capitalize</code>过滤器将传递给它的任何值都大写;<code>to_yaml</code>和<code>to_json</code>过滤器会更改变量值的格式。</p> <p>YAML语法要求，如果您以<code>{{foo}}</code>开始一个值，则必须 <strong>用引号包裹整行</strong>，因为它希望确保您没有试图启动YAML字典。YAML语法文档对此进行了介绍。</p> <p>下面这个时错误的写法</p> <div class=highlight><pre><span></span><code><a id=__codelineno-230-1 name=__codelineno-230-1 href=#__codelineno-230-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">app_servers</span>
<a id=__codelineno-230-2 name=__codelineno-230-2 href=#__codelineno-230-2></a><span class=w>  </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-230-3 name=__codelineno-230-3 href=#__codelineno-230-3></a><span class=w>      </span><span class=nt>app_path</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{{</span><span class=w> </span><span class=nv>base_path</span><span class=w> </span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">/22</span>
</code></pre></div> <p>这样写，才是对的。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-231-1 name=__codelineno-231-1 href=#__codelineno-231-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">app_servers</span>
<a id=__codelineno-231-2 name=__codelineno-231-2 href=#__codelineno-231-2></a><span class=w>  </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-231-3 name=__codelineno-231-3 href=#__codelineno-231-3></a><span class=w>       </span><span class=nt>app_path</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>base_path</span><span class=nv> </span><span class=s>}}/22&quot;</span>
</code></pre></div> <h4 id=从系统中发现变量facts>从系统中发现变量:Facts<a class=headerlink href=#从系统中发现变量facts title="Permanent link">&para;</a></h4> <p>还有其他地方可以使用变量，但是这些是被发现的变量类型，不是由用户设置的。</p> <p><code>Facts</code>是通过与远程系统对话而获得的信息。数据存储在<code>ansible_facts</code>变量中，你可以通过下列示例来获取变量中的信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-232-1 name=__codelineno-232-1 href=#__codelineno-232-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">var=ansible_facts</span>
</code></pre></div> <p>或者使用<code>setup</code>模块</p> <div class=highlight><pre><span></span><code><a id=__codelineno-233-1 name=__codelineno-233-1 href=#__codelineno-233-1></a>ansible<span class=w> </span>hostname<span class=w> </span>-m<span class=w> </span>setup
</code></pre></div> <h4 id=访问复杂变量数据>访问复杂变量数据<a class=headerlink href=#访问复杂变量数据 title="Permanent link">&para;</a></h4> <p>使用嵌套数据结构访问变量</p> <div class=highlight><pre><span></span><code><a id=__codelineno-234-1 name=__codelineno-234-1 href=#__codelineno-234-1></a>{{ ansible_facts[&quot;eth0&quot;][&quot;ipv4&quot;][&quot;address&quot;] }}
</code></pre></div> <p>或者使用<code>.</code>符号</p> <div class=highlight><pre><span></span><code><a id=__codelineno-235-1 name=__codelineno-235-1 href=#__codelineno-235-1></a>{{ ansible_facts.eth0.ipv4.address }}
</code></pre></div> <p>类似地，这是我们访问数组的第一个元素的方式</p> <div class=highlight><pre><span></span><code><a id=__codelineno-236-1 name=__codelineno-236-1 href=#__codelineno-236-1></a>{{ foo[0] }}
</code></pre></div> <h4 id=使用内置变量>使用内置变量<a class=headerlink href=#使用内置变量 title="Permanent link">&para;</a></h4> <p>ansible 提供了许多内置变量，来帮助大家获取当前运行的诸多信息，通过内置变量，我们可以做更多的事情，比如获取主机的自定义fact，获取当前运行的主机等等。</p> <h5 id=魔术变量>魔术变量<a class=headerlink href=#魔术变量 title="Permanent link">&para;</a></h5> <table> <thead> <tr> <th>变量名称</th> <th>说明</th> <th>使用</th> </tr> </thead> <tbody> <tr> <td>ansible_check_mode</td> <td>是否处于检查模式，返回布尔值</td> <td><code>{{ ansible_check_mode }}</code></td> </tr> <tr> <td>ansible_dependent_role_names</td> <td>当前剧本依赖的角色名称</td> <td><code>{{ ansible_dependent_role_names}}</code></td> </tr> <tr> <td>ansible_diff_mode</td> <td>是否处于对比模式，返回布尔值</td> <td><code>{{ ansible_diff_mode }}</code></td> </tr> <tr> <td>ansible_forks</td> <td>返回最大并行运行的数量</td> <td><code>{{ ansible_forks }}</code></td> </tr> <tr> <td>ansible_inventory_sources</td> <td>用作主机清单的资源列表</td> <td><code>{{ ansible_inventory_sources }}</code></td> </tr> <tr> <td>ansible_limit</td> <td>CLI选项<code>--limit</code>的内容</td> <td><code>{{ ansible_limit }}</code></td> </tr> <tr> <td>ansible_loop</td> <td>通过<code>loop_control.extended</code>启用时，包含扩展循环信息的字典/映射</td> <td><code>{{ ansible_loop }}</code></td> </tr> <tr> <td>ansible_loop_var</td> <td>提供给<code>loop_control.loop_var</code>的值的名称</td> <td><code>{{ ansible_loop_var }}</code></td> </tr> <tr> <td>ansible_index_var</td> <td>提供给<code>loop_control.index_var</code>的值的名称</td> <td><code>{{ ansible_index_var }}</code></td> </tr> <tr> <td>ansible_parent_role_paths</td> <td>当通过<code>include_role</code>或<code>import_role</code>操作执行当前角色时，此变量包含所有父角色的列表，而最新角色（即包含/导入该角色的角色）是列表中的第一项。</td> <td><code>{{ ansible_parent_role_paths }}</code></td> </tr> <tr> <td>ansible_play_hosts<br>ansible_play_batch</td> <td>包含当前运行的主机列表，受serial参数影响</td> <td><code>{{ ansible_play_hosts }}</code><br><code>{{ ansible_play_batch }}</code></td> </tr> <tr> <td>ansible_play_hosts_all</td> <td>所有执行主机的列表</td> <td><code>{{ ansible_play_hosts_all }}</code></td> </tr> <tr> <td>ansible_play_role_names</td> <td>当前导入到当前剧本中的角色的名称</td> <td><code>{{ ansible_play_role_names }}</code></td> </tr> <tr> <td>ansible_playbook_python</td> <td>控制器上Ansible使用的python解释器的路径</td> <td><code>{{ ansible_playbook_python }}</code></td> </tr> <tr> <td>ansible_role_names</td> <td>当前导入角色的名称</td> <td><code>{{ ansible_role_names }}</code></td> </tr> <tr> <td>ansible_run_tags</td> <td><code>--tags</code> CLI选项的内容，该选项指定当前运行将包括哪些标签。</td> <td><code>{{ ansible_run_tags}}</code></td> </tr> <tr> <td>ansible_search_path</td> <td><code>action</code>插件<code>lookups</code>的当前搜索路径</td> <td><code>{{ ansible_search_path}}</code></td> </tr> <tr> <td>ansible_skip_tags</td> <td><code>--skip</code>标记CLI选项的内容，该选项指定在当前运行中将跳过哪些标记。</td> <td><code>{{ ansible_skip_tags}}</code></td> </tr> <tr> <td>ansible_verbosity</td> <td>Ansible的详细版本信息</td> <td><code>{{ ansible_verbosity }}</code></td> </tr> <tr> <td>ansible_version</td> <td>ansible版本信息</td> <td><code>{{ ansible_version }}</code></td> </tr> <tr> <td>ansible_playbook_python</td> <td>ansible的python可执行路径</td> <td><code>{{ ansible_playbook_python }}</code></td> </tr> <tr> <td>groups_name</td> <td>当前主机所在组的主机列表</td> <td><code>{% if 'webserver' in group_names %} # some part of a configuration file that only applies to webservers {% endif %}</code></td> </tr> <tr> <td>groups</td> <td>包含设备清单组内的所有主机</td> <td><code>{% for host in groups[‘db_servers’] %} {{ host }} {% endfor %}</code></td> </tr> <tr> <td>hostvars</td> <td>包含运行的所有变量信息</td> <td><code>{{ hostvars['db.example.com'].ansible_eth0.ipv4.address }}</code></td> </tr> <tr> <td>inventory_hostname</td> <td>当前运行主机的库存配置名称</td> <td><code>{{ inventory_hostname }}</code><br><code>{{ hostvars[inventory_hostname] }}</code></td> </tr> <tr> <td>inventory_hostname_short</td> <td><code>inventory_hostname</code>的简短版本</td> <td><code>{{ inventory_hostname_short }}</code></td> </tr> <tr> <td>inventory_dir</td> <td>存放主机清单的目录</td> <td><code>{{ inventory_dir }}</code></td> </tr> <tr> <td>inventory_file</td> <td>主机清单的文件名</td> <td><code>{{ inventory_file }}</code></td> </tr> <tr> <td>omit</td> <td>允许您忽略某个选项的特殊变量</td> <td><code>- user: name=bob home={{ bobs_home</code></td> </tr> <tr> <td>ansible_play_name</td> <td>当前正在执行的<code>play</code> name</td> <td><code>{{ ansible_play_name }}</code></td> </tr> <tr> <td>playbook_dir</td> <td>playbook的路径</td> <td><code>{{ playbook_dir }}</code></td> </tr> <tr> <td>role_name</td> <td>当前正在执行的角色名称。</td> <td><code>{{ role_name }}</code></td> </tr> <tr> <td>role_path</td> <td>返回的当前角色路径，只在role中起作用</td> <td><code>{{ role_path }}</code></td> </tr> </tbody> </table> <h5 id=facts-变量>Facts 变量<a class=headerlink href=#facts-变量 title="Permanent link">&para;</a></h5> <table> <thead> <tr> <th>变量名称</th> <th>说明</th> <th>使用</th> </tr> </thead> <tbody> <tr> <td>ansible_facts</td> <td>包含所有运行的主机收集数据</td> <td><code>{{ ansible_facts }}</code></td> </tr> <tr> <td>ansible_local</td> <td><code>inventory_hostname</code> 主机自定义的本地fact变量</td> <td><code>{{ ansible_local }}</code></td> </tr> </tbody> </table> <h5 id=连接变量>连接变量<a class=headerlink href=#连接变量 title="Permanent link">&para;</a></h5> <table> <thead> <tr> <th>变量名称</th> <th>说明</th> <th>使用</th> </tr> </thead> <tbody> <tr> <td>ansible_become_user</td> <td>权限提升的用户</td> <td><code>{{ ansible_become_user }}</code></td> </tr> <tr> <td>ansible_connection</td> <td>使用的连接插件</td> <td><code>{{ ansible_connection }}</code></td> </tr> <tr> <td>ansible_host</td> <td>当前使用的远端主机的<code>ip/name</code>名称</td> <td><code>{{ ansible_host }}</code></td> </tr> <tr> <td>ansible_python_interpreter</td> <td>ansible在远端的python可执行路径</td> <td><code>{{ ansible_python_interpreter }}</code></td> </tr> <tr> <td>ansible_user</td> <td>使用ansible登录远端的用户</td> <td><code>{{ ansible_user }}</code></td> </tr> </tbody> </table> <h2 id=11facts-数据>11.Facts 数据<a class=headerlink href=#11facts-数据 title="Permanent link">&para;</a></h2> <p>Facts主要是用来采集目标系统信息的，采集到信息存储在<code>ansible_facts</code>变量中，也有许多信息存储在以<code>ansible_</code>开头的变量。</p> <h3 id=获取facts信息>获取Facts信息<a class=headerlink href=#获取facts信息 title="Permanent link">&para;</a></h3> <h4 id=使用setup模块来获取目标系统信息>使用setup模块来获取目标系统信息<a class=headerlink href=#使用setup模块来获取目标系统信息 title="Permanent link">&para;</a></h4> <p>可以使用<code>setup</code>模块手动的获取目标系统信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-237-1 name=__codelineno-237-1 href=#__codelineno-237-1></a>ansible<span class=w> </span>hostname<span class=w> </span>-m<span class=w> </span>setup
</code></pre></div> <p>向<code>setup</code>模块传递<code>filter</code>选项，就可以选择获取哪些内容，例如仅显示与ansible相关的内存信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-238-1 name=__codelineno-238-1 href=#__codelineno-238-1></a>ansible<span class=w> </span>all<span class=w> </span>-m<span class=w> </span>setup<span class=w> </span>-a<span class=w> </span><span class=s1>&#39;filter=ansible_*_mb&#39;</span>
</code></pre></div> <h4 id=使用playbook来获取目标系统信息>使用playbook来获取目标系统信息<a class=headerlink href=#使用playbook来获取目标系统信息 title="Permanent link">&para;</a></h4> <p>默认情况下，playbook的第一个任务就是<code>Facts</code>信息，显示的结果如下:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-239-1 name=__codelineno-239-1 href=#__codelineno-239-1></a><span class="l l-Scalar l-Scalar-Plain">PLAY [192.168.77.130] ******************************************</span>
<a id=__codelineno-239-2 name=__codelineno-239-2 href=#__codelineno-239-2></a><span class="l l-Scalar l-Scalar-Plain">TASK [Gathering Facts] ****************************************************************</span>
<a id=__codelineno-239-3 name=__codelineno-239-3 href=#__codelineno-239-3></a><span class="l l-Scalar l-Scalar-Plain">ok</span><span class="p p-Indicator">:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>192.168.77.130</span><span class="p p-Indicator">]</span>
<a id=__codelineno-239-4 name=__codelineno-239-4 href=#__codelineno-239-4></a><span class="l l-Scalar l-Scalar-Plain">TASK [test] ****************************************************</span>
<a id=__codelineno-239-5 name=__codelineno-239-5 href=#__codelineno-239-5></a><span class=nt>changed</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>192.168.77.130</span><span class="p p-Indicator">]</span>
</code></pre></div> <p>如果要关闭playbook的这一操作，就需要为play添加<code>gather_facts</code>关键字</p> <div class=highlight><pre><span></span><code><a id=__codelineno-240-1 name=__codelineno-240-1 href=#__codelineno-240-1></a><span class=c1># 关闭关闭自动采集Facts</span>
<a id=__codelineno-240-2 name=__codelineno-240-2 href=#__codelineno-240-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">whatever</span>
<a id=__codelineno-240-3 name=__codelineno-240-3 href=#__codelineno-240-3></a><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
</code></pre></div> <p>默认情况下，是收集所有的facts信息，可以通过修改ansible配置文件来达到只获取某一类型的信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-241-1 name=__codelineno-241-1 href=#__codelineno-241-1></a><span class=c1># /etc/ansible/ansible.cfg</span>
<a id=__codelineno-241-2 name=__codelineno-241-2 href=#__codelineno-241-2></a>
<a id=__codelineno-241-3 name=__codelineno-241-3 href=#__codelineno-241-3></a><span class=c1># all - 收集所有子集，默认</span>
<a id=__codelineno-241-4 name=__codelineno-241-4 href=#__codelineno-241-4></a><span class=c1># network - 收集网络信息子集</span>
<a id=__codelineno-241-5 name=__codelineno-241-5 href=#__codelineno-241-5></a><span class=c1># hardware - 收集硬件信息子集</span>
<a id=__codelineno-241-6 name=__codelineno-241-6 href=#__codelineno-241-6></a><span class=c1># virtual - 收集虚拟相关的信息</span>
<a id=__codelineno-241-7 name=__codelineno-241-7 href=#__codelineno-241-7></a><span class=c1># facter - 收集自定义的fact信息</span>
<a id=__codelineno-241-8 name=__codelineno-241-8 href=#__codelineno-241-8></a><span class=c1># ohai -  收集ohai信息</span>
<a id=__codelineno-241-9 name=__codelineno-241-9 href=#__codelineno-241-9></a><span class=c1># 可以使用多个子集 (ex: network,virtual)</span>
<a id=__codelineno-241-10 name=__codelineno-241-10 href=#__codelineno-241-10></a><span class=c1># 可以排除子集 (ex: !hardware,!facter,!ohai)</span>
<a id=__codelineno-241-11 name=__codelineno-241-11 href=#__codelineno-241-11></a><span class=na>gather_subset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>all</span>
</code></pre></div> <h4 id=在task中设置facts信息>在task中设置facts信息<a class=headerlink href=#在task中设置facts信息 title="Permanent link">&para;</a></h4> <p>可以使用<code>set_fact</code> 来设置当前运行主机的facts信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-242-1 name=__codelineno-242-1 href=#__codelineno-242-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">hostname</span>
<a id=__codelineno-242-2 name=__codelineno-242-2 href=#__codelineno-242-2></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-242-3 name=__codelineno-242-3 href=#__codelineno-242-3></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">whoami</span>
<a id=__codelineno-242-4 name=__codelineno-242-4 href=#__codelineno-242-4></a><span class=w>      </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">result</span>
<a id=__codelineno-242-5 name=__codelineno-242-5 href=#__codelineno-242-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>set_fact</span><span class=p>:</span>
<a id=__codelineno-242-6 name=__codelineno-242-6 href=#__codelineno-242-6></a><span class=w>        </span><span class=nt>one</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>result.stdout</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-242-7 name=__codelineno-242-7 href=#__codelineno-242-7></a><span class=w>        </span><span class=nt>two</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-242-8 name=__codelineno-242-8 href=#__codelineno-242-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">var=one</span>
<a id=__codelineno-242-9 name=__codelineno-242-9 href=#__codelineno-242-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">var=two</span>
</code></pre></div> <h4 id=自定义目标系统facts>自定义目标系统facts<a class=headerlink href=#自定义目标系统facts title="Permanent link">&para;</a></h4> <p>在远程主机/etc/ansible/facts.d/目录下创建.fact 结尾的文件，也可以是json、ini 或者返回json 格式数据的可执行文件，这些将被作为远程主机本地的facts 执行</p> <p><strong>在远程主机上操作</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-243-1 name=__codelineno-243-1 href=#__codelineno-243-1></a>mkdir<span class=w> </span>-p<span class=w> </span>/etc/ansible/facts.d
<a id=__codelineno-243-2 name=__codelineno-243-2 href=#__codelineno-243-2></a>cat<span class=w> </span><span class=s>&lt;&lt; EOF &gt; /etc/ansible/facts.d/hello.fact</span>
<a id=__codelineno-243-3 name=__codelineno-243-3 href=#__codelineno-243-3></a><span class=s>[test]</span>
<a id=__codelineno-243-4 name=__codelineno-243-4 href=#__codelineno-243-4></a><span class=s>h=hello</span>
<a id=__codelineno-243-5 name=__codelineno-243-5 href=#__codelineno-243-5></a><span class=s>p=world</span>
<a id=__codelineno-243-6 name=__codelineno-243-6 href=#__codelineno-243-6></a><span class=s>EOF</span>
</code></pre></div> <p><strong>在ansible控制节点上操作</strong></p> <p>远程主机的自定义facts信息，存储在<code>ansible_local</code>变量中，可以通过<code>setup</code>模块过滤获取</p> <div class=highlight><pre><span></span><code><a id=__codelineno-244-1 name=__codelineno-244-1 href=#__codelineno-244-1></a>ansible<span class=w> </span><span class=m>192</span>.168.77.130<span class=w> </span>-m<span class=w> </span>setup<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;filter=ansible_local&quot;</span><span class=w> </span>
<a id=__codelineno-244-2 name=__codelineno-244-2 href=#__codelineno-244-2></a><span class=m>192</span>.168.77.130<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>SUCCESS</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span>
<a id=__codelineno-244-3 name=__codelineno-244-3 href=#__codelineno-244-3></a><span class=w>    </span><span class=s2>&quot;ansible_facts&quot;</span>:<span class=w> </span><span class=o>{</span>
<a id=__codelineno-244-4 name=__codelineno-244-4 href=#__codelineno-244-4></a><span class=w>        </span><span class=s2>&quot;ansible_local&quot;</span>:<span class=w> </span><span class=o>{</span>
<a id=__codelineno-244-5 name=__codelineno-244-5 href=#__codelineno-244-5></a><span class=w>            </span><span class=s2>&quot;hello&quot;</span>:<span class=w> </span><span class=o>{</span>
<a id=__codelineno-244-6 name=__codelineno-244-6 href=#__codelineno-244-6></a><span class=w>                </span><span class=s2>&quot;test&quot;</span>:<span class=w> </span><span class=o>{</span>
<a id=__codelineno-244-7 name=__codelineno-244-7 href=#__codelineno-244-7></a><span class=w>                    </span><span class=s2>&quot;h&quot;</span>:<span class=w> </span><span class=s2>&quot;hello&quot;</span>,<span class=w> </span>
<a id=__codelineno-244-8 name=__codelineno-244-8 href=#__codelineno-244-8></a><span class=w>                    </span><span class=s2>&quot;p&quot;</span>:<span class=w> </span><span class=s2>&quot;world&quot;</span>
<a id=__codelineno-244-9 name=__codelineno-244-9 href=#__codelineno-244-9></a><span class=w>                </span><span class=o>}</span>
<a id=__codelineno-244-10 name=__codelineno-244-10 href=#__codelineno-244-10></a><span class=w>            </span><span class=o>}</span>
<a id=__codelineno-244-11 name=__codelineno-244-11 href=#__codelineno-244-11></a><span class=w>        </span><span class=o>}</span>,<span class=w> </span>
<a id=__codelineno-244-12 name=__codelineno-244-12 href=#__codelineno-244-12></a><span class=w>        </span><span class=s2>&quot;discovered_interpreter_python&quot;</span>:<span class=w> </span><span class=s2>&quot;/usr/bin/python&quot;</span>
<a id=__codelineno-244-13 name=__codelineno-244-13 href=#__codelineno-244-13></a><span class=w>    </span><span class=o>}</span>,<span class=w> </span>
<a id=__codelineno-244-14 name=__codelineno-244-14 href=#__codelineno-244-14></a><span class=w>    </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span><span class=nb>false</span>
<a id=__codelineno-244-15 name=__codelineno-244-15 href=#__codelineno-244-15></a><span class=o>}</span>
</code></pre></div> <p>也可以通过在任务中使用<code>{{ ansible_local.hello }}</code>的方式访问该变量</p> <div class=highlight><pre><span></span><code><a id=__codelineno-245-1 name=__codelineno-245-1 href=#__codelineno-245-1></a>---
<a id=__codelineno-245-2 name=__codelineno-245-2 href=#__codelineno-245-2></a>-<span class=w> </span>hosts:<span class=w> </span><span class=m>192</span>.168.77.130
<a id=__codelineno-245-3 name=__codelineno-245-3 href=#__codelineno-245-3></a><span class=w>  </span>tasks:
<a id=__codelineno-245-4 name=__codelineno-245-4 href=#__codelineno-245-4></a><span class=w>    </span>-<span class=w> </span>debug:<span class=w> </span><span class=nv>var</span><span class=o>=</span>ansible_local.hello
<a id=__codelineno-245-5 name=__codelineno-245-5 href=#__codelineno-245-5></a><span class=w>    </span>-<span class=w> </span>debug:<span class=w> </span><span class=nv>var</span><span class=o>=</span>ansible_local.hello.test.h
</code></pre></div> <p>当然，我们可以把上面的步骤，通过playbook来实现</p> <blockquote> <p>运用playbook 定义远端facts.d，并加载到fact中</p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-246-1 name=__codelineno-246-1 href=#__codelineno-246-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">node1</span>
<a id=__codelineno-246-2 name=__codelineno-246-2 href=#__codelineno-246-2></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-246-3 name=__codelineno-246-3 href=#__codelineno-246-3></a><span class=w>     </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">create directory for ansible custom facts</span>
<a id=__codelineno-246-4 name=__codelineno-246-4 href=#__codelineno-246-4></a><span class=w>       </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">state=directory recurse=yes path=/etc/ansible/facts.d</span>
<a id=__codelineno-246-5 name=__codelineno-246-5 href=#__codelineno-246-5></a><span class=w>     </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">install custom test fact</span>
<a id=__codelineno-246-6 name=__codelineno-246-6 href=#__codelineno-246-6></a><span class=w>       </span><span class=nt>copy</span><span class=p>:</span>
<a id=__codelineno-246-7 name=__codelineno-246-7 href=#__codelineno-246-7></a><span class=w>         </span><span class=nt>content</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span>
<a id=__codelineno-246-8 name=__codelineno-246-8 href=#__codelineno-246-8></a><span class=w>           </span><span class=no>[test]</span>
<a id=__codelineno-246-9 name=__codelineno-246-9 href=#__codelineno-246-9></a><span class=w>           </span><span class=no>h=hello</span>
<a id=__codelineno-246-10 name=__codelineno-246-10 href=#__codelineno-246-10></a><span class=w>           </span><span class=no>p=world</span>
<a id=__codelineno-246-11 name=__codelineno-246-11 href=#__codelineno-246-11></a><span class=w>         </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/etc/ansible/facts.d/test.fact</span>
<a id=__codelineno-246-12 name=__codelineno-246-12 href=#__codelineno-246-12></a><span class=w>     </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">re-read facts after adding custom fact</span>
<a id=__codelineno-246-13 name=__codelineno-246-13 href=#__codelineno-246-13></a><span class=w>       </span><span class=nt>setup</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">filter=ansible_local</span>
<a id=__codelineno-246-14 name=__codelineno-246-14 href=#__codelineno-246-14></a><span class=w>     </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ansible_local vars</span>
<a id=__codelineno-246-15 name=__codelineno-246-15 href=#__codelineno-246-15></a><span class=w>       </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">var=ansible_local</span>
</code></pre></div> <h4 id=facts-返回的信息>Facts 返回的信息<a class=headerlink href=#facts-返回的信息 title="Permanent link">&para;</a></h4> <p>以<code>ansible 2.9.1</code>版本返回<code>centos 7</code>系统的Facts信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-247-1 name=__codelineno-247-1 href=#__codelineno-247-1></a><span class=nt>&quot;ansible_facts&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-2 name=__codelineno-247-2 href=#__codelineno-247-2></a><span class=w>    </span><span class=nt>&quot;ansible_all_ipv4_addresses&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-3 name=__codelineno-247-3 href=#__codelineno-247-3></a><span class=w>        </span><span class=s2>&quot;192.168.77.130&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-4 name=__codelineno-247-4 href=#__codelineno-247-4></a><span class=w>        </span><span class=s2>&quot;172.17.0.1&quot;</span>
<a id=__codelineno-247-5 name=__codelineno-247-5 href=#__codelineno-247-5></a><span class=w>    </span><span class=p>],</span><span class=w> </span>
<a id=__codelineno-247-6 name=__codelineno-247-6 href=#__codelineno-247-6></a><span class=w>    </span><span class=nt>&quot;ansible_all_ipv6_addresses&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-7 name=__codelineno-247-7 href=#__codelineno-247-7></a><span class=w>        </span><span class=s2>&quot;fe80::6d73:3667:2ed6:a7c2&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-8 name=__codelineno-247-8 href=#__codelineno-247-8></a><span class=w>        </span><span class=s2>&quot;fe80::4d03:8744:2f0d:2085&quot;</span>
<a id=__codelineno-247-9 name=__codelineno-247-9 href=#__codelineno-247-9></a><span class=w>    </span><span class=p>],</span><span class=w> </span>
<a id=__codelineno-247-10 name=__codelineno-247-10 href=#__codelineno-247-10></a><span class=w>    </span><span class=nt>&quot;ansible_apparmor&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-11 name=__codelineno-247-11 href=#__codelineno-247-11></a><span class=w>        </span><span class=nt>&quot;status&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;disabled&quot;</span>
<a id=__codelineno-247-12 name=__codelineno-247-12 href=#__codelineno-247-12></a><span class=w>    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-13 name=__codelineno-247-13 href=#__codelineno-247-13></a><span class=w>    </span><span class=nt>&quot;ansible_architecture&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;x86_64&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-14 name=__codelineno-247-14 href=#__codelineno-247-14></a><span class=w>    </span><span class=nt>&quot;ansible_bios_date&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;07/29/2019&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-15 name=__codelineno-247-15 href=#__codelineno-247-15></a><span class=w>    </span><span class=nt>&quot;ansible_bios_version&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;6.00&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-16 name=__codelineno-247-16 href=#__codelineno-247-16></a><span class=w>    </span><span class=nt>&quot;ansible_cmdline&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-17 name=__codelineno-247-17 href=#__codelineno-247-17></a><span class=w>        </span><span class=nt>&quot;BOOT_IMAGE&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/vmlinuz-5.1.11-1.el7.elrepo.x86_64&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-18 name=__codelineno-247-18 href=#__codelineno-247-18></a><span class=w>        </span><span class=nt>&quot;crashkernel&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;auto&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-19 name=__codelineno-247-19 href=#__codelineno-247-19></a><span class=w>        </span><span class=nt>&quot;quiet&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-20 name=__codelineno-247-20 href=#__codelineno-247-20></a><span class=w>        </span><span class=nt>&quot;rhgb&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-21 name=__codelineno-247-21 href=#__codelineno-247-21></a><span class=w>        </span><span class=nt>&quot;ro&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-22 name=__codelineno-247-22 href=#__codelineno-247-22></a><span class=w>        </span><span class=nt>&quot;root&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;UUID=a7d49533-e756-4a71-a977-5efb174eb09c&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-23 name=__codelineno-247-23 href=#__codelineno-247-23></a><span class=w>        </span><span class=nt>&quot;user_namespace.enable&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;1&quot;</span>
<a id=__codelineno-247-24 name=__codelineno-247-24 href=#__codelineno-247-24></a><span class=w>    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-25 name=__codelineno-247-25 href=#__codelineno-247-25></a><span class=w>    </span><span class=nt>&quot;ansible_date_time&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-26 name=__codelineno-247-26 href=#__codelineno-247-26></a><span class=w>        </span><span class=nt>&quot;date&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2020-03-31&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-27 name=__codelineno-247-27 href=#__codelineno-247-27></a><span class=w>        </span><span class=nt>&quot;day&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;31&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-28 name=__codelineno-247-28 href=#__codelineno-247-28></a><span class=w>        </span><span class=nt>&quot;epoch&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;1585627320&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-29 name=__codelineno-247-29 href=#__codelineno-247-29></a><span class=w>        </span><span class=nt>&quot;hour&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;12&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-30 name=__codelineno-247-30 href=#__codelineno-247-30></a><span class=w>        </span><span class=nt>&quot;iso8601&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2020-03-31T04:02:00Z&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-31 name=__codelineno-247-31 href=#__codelineno-247-31></a><span class=w>        </span><span class=nt>&quot;iso8601_basic&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;20200331T120200260891&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-32 name=__codelineno-247-32 href=#__codelineno-247-32></a><span class=w>        </span><span class=nt>&quot;iso8601_basic_short&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;20200331T120200&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-33 name=__codelineno-247-33 href=#__codelineno-247-33></a><span class=w>        </span><span class=nt>&quot;iso8601_micro&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2020-03-31T04:02:00.260966Z&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-34 name=__codelineno-247-34 href=#__codelineno-247-34></a><span class=w>        </span><span class=nt>&quot;minute&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;02&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-35 name=__codelineno-247-35 href=#__codelineno-247-35></a><span class=w>        </span><span class=nt>&quot;month&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;03&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-36 name=__codelineno-247-36 href=#__codelineno-247-36></a><span class=w>        </span><span class=nt>&quot;second&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;00&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-37 name=__codelineno-247-37 href=#__codelineno-247-37></a><span class=w>        </span><span class=nt>&quot;time&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;12:02:00&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-38 name=__codelineno-247-38 href=#__codelineno-247-38></a><span class=w>        </span><span class=nt>&quot;tz&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;CST&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-39 name=__codelineno-247-39 href=#__codelineno-247-39></a><span class=w>        </span><span class=nt>&quot;tz_offset&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;+0800&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-40 name=__codelineno-247-40 href=#__codelineno-247-40></a><span class=w>        </span><span class=nt>&quot;weekday&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;星期二&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-41 name=__codelineno-247-41 href=#__codelineno-247-41></a><span class=w>        </span><span class=nt>&quot;weekday_number&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-42 name=__codelineno-247-42 href=#__codelineno-247-42></a><span class=w>        </span><span class=nt>&quot;weeknumber&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;13&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-43 name=__codelineno-247-43 href=#__codelineno-247-43></a><span class=w>        </span><span class=nt>&quot;year&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2020&quot;</span>
<a id=__codelineno-247-44 name=__codelineno-247-44 href=#__codelineno-247-44></a><span class=w>    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-45 name=__codelineno-247-45 href=#__codelineno-247-45></a><span class=w>    </span><span class=nt>&quot;ansible_default_ipv4&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-46 name=__codelineno-247-46 href=#__codelineno-247-46></a><span class=w>        </span><span class=nt>&quot;address&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;192.168.77.130&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-47 name=__codelineno-247-47 href=#__codelineno-247-47></a><span class=w>        </span><span class=nt>&quot;alias&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;ens33&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-48 name=__codelineno-247-48 href=#__codelineno-247-48></a><span class=w>        </span><span class=nt>&quot;broadcast&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;192.168.77.255&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-49 name=__codelineno-247-49 href=#__codelineno-247-49></a><span class=w>        </span><span class=nt>&quot;gateway&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;192.168.77.2&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-50 name=__codelineno-247-50 href=#__codelineno-247-50></a><span class=w>        </span><span class=nt>&quot;interface&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;ens33&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-51 name=__codelineno-247-51 href=#__codelineno-247-51></a><span class=w>        </span><span class=nt>&quot;macaddress&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;00:0c:29:88:01:c0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-52 name=__codelineno-247-52 href=#__codelineno-247-52></a><span class=w>        </span><span class=nt>&quot;mtu&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1500</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-53 name=__codelineno-247-53 href=#__codelineno-247-53></a><span class=w>        </span><span class=nt>&quot;netmask&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;255.255.255.0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-54 name=__codelineno-247-54 href=#__codelineno-247-54></a><span class=w>        </span><span class=nt>&quot;network&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;192.168.77.0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-55 name=__codelineno-247-55 href=#__codelineno-247-55></a><span class=w>        </span><span class=nt>&quot;type&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;ether&quot;</span>
<a id=__codelineno-247-56 name=__codelineno-247-56 href=#__codelineno-247-56></a><span class=w>    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-57 name=__codelineno-247-57 href=#__codelineno-247-57></a><span class=w>    </span><span class=nt>&quot;ansible_default_ipv6&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{},</span><span class=w> </span>
<a id=__codelineno-247-58 name=__codelineno-247-58 href=#__codelineno-247-58></a><span class=w>    </span><span class=nt>&quot;ansible_device_links&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-59 name=__codelineno-247-59 href=#__codelineno-247-59></a><span class=w>        </span><span class=nt>&quot;ids&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-60 name=__codelineno-247-60 href=#__codelineno-247-60></a><span class=w>            </span><span class=nt>&quot;sr0&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-61 name=__codelineno-247-61 href=#__codelineno-247-61></a><span class=w>                </span><span class=s2>&quot;ata-VMware_Virtual_IDE_CDROM_Drive_10000000000000000001&quot;</span>
<a id=__codelineno-247-62 name=__codelineno-247-62 href=#__codelineno-247-62></a><span class=w>            </span><span class=p>]</span>
<a id=__codelineno-247-63 name=__codelineno-247-63 href=#__codelineno-247-63></a><span class=w>        </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-64 name=__codelineno-247-64 href=#__codelineno-247-64></a><span class=w>        </span><span class=nt>&quot;labels&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{},</span><span class=w> </span>
<a id=__codelineno-247-65 name=__codelineno-247-65 href=#__codelineno-247-65></a><span class=w>        </span><span class=nt>&quot;masters&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{},</span><span class=w> </span>
<a id=__codelineno-247-66 name=__codelineno-247-66 href=#__codelineno-247-66></a><span class=w>        </span><span class=nt>&quot;uuids&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-67 name=__codelineno-247-67 href=#__codelineno-247-67></a><span class=w>            </span><span class=nt>&quot;sda1&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-68 name=__codelineno-247-68 href=#__codelineno-247-68></a><span class=w>                </span><span class=s2>&quot;93556f71-6dad-4761-9207-edee35d47129&quot;</span>
<a id=__codelineno-247-69 name=__codelineno-247-69 href=#__codelineno-247-69></a><span class=w>            </span><span class=p>],</span><span class=w> </span>
<a id=__codelineno-247-70 name=__codelineno-247-70 href=#__codelineno-247-70></a><span class=w>            </span><span class=nt>&quot;sda2&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-71 name=__codelineno-247-71 href=#__codelineno-247-71></a><span class=w>                </span><span class=s2>&quot;0c0f8a5a-58dd-4fc6-a49e-fc5e63f5d8a3&quot;</span>
<a id=__codelineno-247-72 name=__codelineno-247-72 href=#__codelineno-247-72></a><span class=w>            </span><span class=p>],</span><span class=w> </span>
<a id=__codelineno-247-73 name=__codelineno-247-73 href=#__codelineno-247-73></a><span class=w>            </span><span class=nt>&quot;sda3&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-74 name=__codelineno-247-74 href=#__codelineno-247-74></a><span class=w>                </span><span class=s2>&quot;a7d49533-e756-4a71-a977-5efb174eb09c&quot;</span>
<a id=__codelineno-247-75 name=__codelineno-247-75 href=#__codelineno-247-75></a><span class=w>            </span><span class=p>]</span>
<a id=__codelineno-247-76 name=__codelineno-247-76 href=#__codelineno-247-76></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-247-77 name=__codelineno-247-77 href=#__codelineno-247-77></a><span class=w>    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-78 name=__codelineno-247-78 href=#__codelineno-247-78></a><span class=w>    </span><span class=nt>&quot;ansible_devices&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-79 name=__codelineno-247-79 href=#__codelineno-247-79></a><span class=w>        </span><span class=nt>&quot;sda&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-80 name=__codelineno-247-80 href=#__codelineno-247-80></a><span class=w>            </span><span class=nt>&quot;holders&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-81 name=__codelineno-247-81 href=#__codelineno-247-81></a><span class=w>            </span><span class=nt>&quot;host&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;SCSI storage controller: LSI Logic / Symbios Logic 53c1030 PCI-X Fusion-MPT Dual Ultra320 SCSI (rev 01)&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-82 name=__codelineno-247-82 href=#__codelineno-247-82></a><span class=w>            </span><span class=nt>&quot;links&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-83 name=__codelineno-247-83 href=#__codelineno-247-83></a><span class=w>                </span><span class=nt>&quot;ids&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-84 name=__codelineno-247-84 href=#__codelineno-247-84></a><span class=w>                </span><span class=nt>&quot;labels&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-85 name=__codelineno-247-85 href=#__codelineno-247-85></a><span class=w>                </span><span class=nt>&quot;masters&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-86 name=__codelineno-247-86 href=#__codelineno-247-86></a><span class=w>                </span><span class=nt>&quot;uuids&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[]</span>
<a id=__codelineno-247-87 name=__codelineno-247-87 href=#__codelineno-247-87></a><span class=w>            </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-88 name=__codelineno-247-88 href=#__codelineno-247-88></a><span class=w>            </span><span class=nt>&quot;model&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;VMware Virtual S&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-89 name=__codelineno-247-89 href=#__codelineno-247-89></a><span class=w>            </span><span class=nt>&quot;partitions&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-90 name=__codelineno-247-90 href=#__codelineno-247-90></a><span class=w>                </span><span class=nt>&quot;sda1&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-91 name=__codelineno-247-91 href=#__codelineno-247-91></a><span class=w>                    </span><span class=nt>&quot;holders&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-92 name=__codelineno-247-92 href=#__codelineno-247-92></a><span class=w>                    </span><span class=nt>&quot;links&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-93 name=__codelineno-247-93 href=#__codelineno-247-93></a><span class=w>                        </span><span class=nt>&quot;ids&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-94 name=__codelineno-247-94 href=#__codelineno-247-94></a><span class=w>                        </span><span class=nt>&quot;labels&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-95 name=__codelineno-247-95 href=#__codelineno-247-95></a><span class=w>                        </span><span class=nt>&quot;masters&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-96 name=__codelineno-247-96 href=#__codelineno-247-96></a><span class=w>                        </span><span class=nt>&quot;uuids&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-97 name=__codelineno-247-97 href=#__codelineno-247-97></a><span class=w>                            </span><span class=s2>&quot;93556f71-6dad-4761-9207-edee35d47129&quot;</span>
<a id=__codelineno-247-98 name=__codelineno-247-98 href=#__codelineno-247-98></a><span class=w>                        </span><span class=p>]</span>
<a id=__codelineno-247-99 name=__codelineno-247-99 href=#__codelineno-247-99></a><span class=w>                    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-100 name=__codelineno-247-100 href=#__codelineno-247-100></a><span class=w>                    </span><span class=nt>&quot;sectors&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;409600&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-101 name=__codelineno-247-101 href=#__codelineno-247-101></a><span class=w>                    </span><span class=nt>&quot;sectorsize&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>512</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-102 name=__codelineno-247-102 href=#__codelineno-247-102></a><span class=w>                    </span><span class=nt>&quot;size&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;200.00 MB&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-103 name=__codelineno-247-103 href=#__codelineno-247-103></a><span class=w>                    </span><span class=nt>&quot;start&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2048&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-104 name=__codelineno-247-104 href=#__codelineno-247-104></a><span class=w>                    </span><span class=nt>&quot;uuid&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;93556f71-6dad-4761-9207-edee35d47129&quot;</span>
<a id=__codelineno-247-105 name=__codelineno-247-105 href=#__codelineno-247-105></a><span class=w>                </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-106 name=__codelineno-247-106 href=#__codelineno-247-106></a><span class=w>                </span><span class=nt>&quot;sda2&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-107 name=__codelineno-247-107 href=#__codelineno-247-107></a><span class=w>                    </span><span class=nt>&quot;holders&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-108 name=__codelineno-247-108 href=#__codelineno-247-108></a><span class=w>                    </span><span class=nt>&quot;links&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-109 name=__codelineno-247-109 href=#__codelineno-247-109></a><span class=w>                        </span><span class=nt>&quot;ids&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-110 name=__codelineno-247-110 href=#__codelineno-247-110></a><span class=w>                        </span><span class=nt>&quot;labels&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-111 name=__codelineno-247-111 href=#__codelineno-247-111></a><span class=w>                        </span><span class=nt>&quot;masters&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-112 name=__codelineno-247-112 href=#__codelineno-247-112></a><span class=w>                        </span><span class=nt>&quot;uuids&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-113 name=__codelineno-247-113 href=#__codelineno-247-113></a><span class=w>                            </span><span class=s2>&quot;0c0f8a5a-58dd-4fc6-a49e-fc5e63f5d8a3&quot;</span>
<a id=__codelineno-247-114 name=__codelineno-247-114 href=#__codelineno-247-114></a><span class=w>                        </span><span class=p>]</span>
<a id=__codelineno-247-115 name=__codelineno-247-115 href=#__codelineno-247-115></a><span class=w>                    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-116 name=__codelineno-247-116 href=#__codelineno-247-116></a><span class=w>                    </span><span class=nt>&quot;sectors&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;20971520&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-117 name=__codelineno-247-117 href=#__codelineno-247-117></a><span class=w>                    </span><span class=nt>&quot;sectorsize&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>512</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-118 name=__codelineno-247-118 href=#__codelineno-247-118></a><span class=w>                    </span><span class=nt>&quot;size&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;10.00 GB&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-119 name=__codelineno-247-119 href=#__codelineno-247-119></a><span class=w>                    </span><span class=nt>&quot;start&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;411648&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-120 name=__codelineno-247-120 href=#__codelineno-247-120></a><span class=w>                    </span><span class=nt>&quot;uuid&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;0c0f8a5a-58dd-4fc6-a49e-fc5e63f5d8a3&quot;</span>
<a id=__codelineno-247-121 name=__codelineno-247-121 href=#__codelineno-247-121></a><span class=w>                </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-122 name=__codelineno-247-122 href=#__codelineno-247-122></a><span class=w>                </span><span class=nt>&quot;sda3&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-123 name=__codelineno-247-123 href=#__codelineno-247-123></a><span class=w>                    </span><span class=nt>&quot;holders&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-124 name=__codelineno-247-124 href=#__codelineno-247-124></a><span class=w>                    </span><span class=nt>&quot;links&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-125 name=__codelineno-247-125 href=#__codelineno-247-125></a><span class=w>                        </span><span class=nt>&quot;ids&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-126 name=__codelineno-247-126 href=#__codelineno-247-126></a><span class=w>                        </span><span class=nt>&quot;labels&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-127 name=__codelineno-247-127 href=#__codelineno-247-127></a><span class=w>                        </span><span class=nt>&quot;masters&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-128 name=__codelineno-247-128 href=#__codelineno-247-128></a><span class=w>                        </span><span class=nt>&quot;uuids&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-129 name=__codelineno-247-129 href=#__codelineno-247-129></a><span class=w>                            </span><span class=s2>&quot;a7d49533-e756-4a71-a977-5efb174eb09c&quot;</span>
<a id=__codelineno-247-130 name=__codelineno-247-130 href=#__codelineno-247-130></a><span class=w>                        </span><span class=p>]</span>
<a id=__codelineno-247-131 name=__codelineno-247-131 href=#__codelineno-247-131></a><span class=w>                    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-132 name=__codelineno-247-132 href=#__codelineno-247-132></a><span class=w>                    </span><span class=nt>&quot;sectors&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;62502912&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-133 name=__codelineno-247-133 href=#__codelineno-247-133></a><span class=w>                    </span><span class=nt>&quot;sectorsize&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>512</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-134 name=__codelineno-247-134 href=#__codelineno-247-134></a><span class=w>                    </span><span class=nt>&quot;size&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;29.80 GB&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-135 name=__codelineno-247-135 href=#__codelineno-247-135></a><span class=w>                    </span><span class=nt>&quot;start&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;21383168&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-136 name=__codelineno-247-136 href=#__codelineno-247-136></a><span class=w>                    </span><span class=nt>&quot;uuid&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;a7d49533-e756-4a71-a977-5efb174eb09c&quot;</span>
<a id=__codelineno-247-137 name=__codelineno-247-137 href=#__codelineno-247-137></a><span class=w>                </span><span class=p>}</span>
<a id=__codelineno-247-138 name=__codelineno-247-138 href=#__codelineno-247-138></a><span class=w>            </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-139 name=__codelineno-247-139 href=#__codelineno-247-139></a><span class=w>            </span><span class=nt>&quot;removable&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-140 name=__codelineno-247-140 href=#__codelineno-247-140></a><span class=w>            </span><span class=nt>&quot;rotational&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;1&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-141 name=__codelineno-247-141 href=#__codelineno-247-141></a><span class=w>            </span><span class=nt>&quot;sas_address&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-142 name=__codelineno-247-142 href=#__codelineno-247-142></a><span class=w>            </span><span class=nt>&quot;sas_device_handle&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-143 name=__codelineno-247-143 href=#__codelineno-247-143></a><span class=w>            </span><span class=nt>&quot;scheduler_mode&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;mq-deadline&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-144 name=__codelineno-247-144 href=#__codelineno-247-144></a><span class=w>            </span><span class=nt>&quot;sectors&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;83886080&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-145 name=__codelineno-247-145 href=#__codelineno-247-145></a><span class=w>            </span><span class=nt>&quot;sectorsize&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;512&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-146 name=__codelineno-247-146 href=#__codelineno-247-146></a><span class=w>            </span><span class=nt>&quot;size&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;40.00 GB&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-147 name=__codelineno-247-147 href=#__codelineno-247-147></a><span class=w>            </span><span class=nt>&quot;support_discard&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-148 name=__codelineno-247-148 href=#__codelineno-247-148></a><span class=w>            </span><span class=nt>&quot;vendor&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;VMware,&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-149 name=__codelineno-247-149 href=#__codelineno-247-149></a><span class=w>            </span><span class=nt>&quot;virtual&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span>
<a id=__codelineno-247-150 name=__codelineno-247-150 href=#__codelineno-247-150></a><span class=w>        </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-151 name=__codelineno-247-151 href=#__codelineno-247-151></a><span class=w>        </span><span class=nt>&quot;sr0&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-152 name=__codelineno-247-152 href=#__codelineno-247-152></a><span class=w>            </span><span class=nt>&quot;holders&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-153 name=__codelineno-247-153 href=#__codelineno-247-153></a><span class=w>            </span><span class=nt>&quot;host&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;IDE interface: Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-154 name=__codelineno-247-154 href=#__codelineno-247-154></a><span class=w>            </span><span class=nt>&quot;links&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-155 name=__codelineno-247-155 href=#__codelineno-247-155></a><span class=w>                </span><span class=nt>&quot;ids&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-156 name=__codelineno-247-156 href=#__codelineno-247-156></a><span class=w>                    </span><span class=s2>&quot;ata-VMware_Virtual_IDE_CDROM_Drive_10000000000000000001&quot;</span>
<a id=__codelineno-247-157 name=__codelineno-247-157 href=#__codelineno-247-157></a><span class=w>                </span><span class=p>],</span><span class=w> </span>
<a id=__codelineno-247-158 name=__codelineno-247-158 href=#__codelineno-247-158></a><span class=w>                </span><span class=nt>&quot;labels&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-159 name=__codelineno-247-159 href=#__codelineno-247-159></a><span class=w>                </span><span class=nt>&quot;masters&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-160 name=__codelineno-247-160 href=#__codelineno-247-160></a><span class=w>                </span><span class=nt>&quot;uuids&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[]</span>
<a id=__codelineno-247-161 name=__codelineno-247-161 href=#__codelineno-247-161></a><span class=w>            </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-162 name=__codelineno-247-162 href=#__codelineno-247-162></a><span class=w>            </span><span class=nt>&quot;model&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;VMware IDE CDR10&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-163 name=__codelineno-247-163 href=#__codelineno-247-163></a><span class=w>            </span><span class=nt>&quot;partitions&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{},</span><span class=w> </span>
<a id=__codelineno-247-164 name=__codelineno-247-164 href=#__codelineno-247-164></a><span class=w>            </span><span class=nt>&quot;removable&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;1&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-165 name=__codelineno-247-165 href=#__codelineno-247-165></a><span class=w>            </span><span class=nt>&quot;rotational&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;1&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-166 name=__codelineno-247-166 href=#__codelineno-247-166></a><span class=w>            </span><span class=nt>&quot;sas_address&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-167 name=__codelineno-247-167 href=#__codelineno-247-167></a><span class=w>            </span><span class=nt>&quot;sas_device_handle&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-168 name=__codelineno-247-168 href=#__codelineno-247-168></a><span class=w>            </span><span class=nt>&quot;scheduler_mode&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;mq-deadline&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-169 name=__codelineno-247-169 href=#__codelineno-247-169></a><span class=w>            </span><span class=nt>&quot;sectors&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2097151&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-170 name=__codelineno-247-170 href=#__codelineno-247-170></a><span class=w>            </span><span class=nt>&quot;sectorsize&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;512&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-171 name=__codelineno-247-171 href=#__codelineno-247-171></a><span class=w>            </span><span class=nt>&quot;size&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;1024.00 MB&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-172 name=__codelineno-247-172 href=#__codelineno-247-172></a><span class=w>            </span><span class=nt>&quot;support_discard&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-173 name=__codelineno-247-173 href=#__codelineno-247-173></a><span class=w>            </span><span class=nt>&quot;vendor&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;NECVMWar&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-174 name=__codelineno-247-174 href=#__codelineno-247-174></a><span class=w>            </span><span class=nt>&quot;virtual&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span>
<a id=__codelineno-247-175 name=__codelineno-247-175 href=#__codelineno-247-175></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-247-176 name=__codelineno-247-176 href=#__codelineno-247-176></a><span class=w>    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-177 name=__codelineno-247-177 href=#__codelineno-247-177></a><span class=w>    </span><span class=nt>&quot;ansible_distribution&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;CentOS&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-178 name=__codelineno-247-178 href=#__codelineno-247-178></a><span class=w>    </span><span class=nt>&quot;ansible_distribution_file_parsed&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-179 name=__codelineno-247-179 href=#__codelineno-247-179></a><span class=w>    </span><span class=nt>&quot;ansible_distribution_file_path&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/etc/redhat-release&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-180 name=__codelineno-247-180 href=#__codelineno-247-180></a><span class=w>    </span><span class=nt>&quot;ansible_distribution_file_variety&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;RedHat&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-181 name=__codelineno-247-181 href=#__codelineno-247-181></a><span class=w>    </span><span class=nt>&quot;ansible_distribution_major_version&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;7&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-182 name=__codelineno-247-182 href=#__codelineno-247-182></a><span class=w>    </span><span class=nt>&quot;ansible_distribution_release&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;Core&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-183 name=__codelineno-247-183 href=#__codelineno-247-183></a><span class=w>    </span><span class=nt>&quot;ansible_distribution_version&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;7.6&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-184 name=__codelineno-247-184 href=#__codelineno-247-184></a><span class=w>    </span><span class=nt>&quot;ansible_dns&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-185 name=__codelineno-247-185 href=#__codelineno-247-185></a><span class=w>        </span><span class=nt>&quot;nameservers&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-186 name=__codelineno-247-186 href=#__codelineno-247-186></a><span class=w>            </span><span class=s2>&quot;192.168.77.2&quot;</span>
<a id=__codelineno-247-187 name=__codelineno-247-187 href=#__codelineno-247-187></a><span class=w>        </span><span class=p>]</span>
<a id=__codelineno-247-188 name=__codelineno-247-188 href=#__codelineno-247-188></a><span class=w>    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-189 name=__codelineno-247-189 href=#__codelineno-247-189></a><span class=w>    </span><span class=nt>&quot;ansible_docker0&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-190 name=__codelineno-247-190 href=#__codelineno-247-190></a><span class=w>        </span><span class=nt>&quot;active&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-191 name=__codelineno-247-191 href=#__codelineno-247-191></a><span class=w>        </span><span class=nt>&quot;device&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;docker0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-192 name=__codelineno-247-192 href=#__codelineno-247-192></a><span class=w>        </span><span class=nt>&quot;features&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-193 name=__codelineno-247-193 href=#__codelineno-247-193></a><span class=w>            </span><span class=nt>&quot;esp_hw_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-194 name=__codelineno-247-194 href=#__codelineno-247-194></a><span class=w>            </span><span class=nt>&quot;esp_tx_csum_hw_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-195 name=__codelineno-247-195 href=#__codelineno-247-195></a><span class=w>            </span><span class=nt>&quot;fcoe_mtu&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-196 name=__codelineno-247-196 href=#__codelineno-247-196></a><span class=w>            </span><span class=nt>&quot;generic_receive_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-197 name=__codelineno-247-197 href=#__codelineno-247-197></a><span class=w>            </span><span class=nt>&quot;generic_segmentation_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-198 name=__codelineno-247-198 href=#__codelineno-247-198></a><span class=w>            </span><span class=nt>&quot;highdma&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-199 name=__codelineno-247-199 href=#__codelineno-247-199></a><span class=w>            </span><span class=nt>&quot;hw_tc_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-200 name=__codelineno-247-200 href=#__codelineno-247-200></a><span class=w>            </span><span class=nt>&quot;l2_fwd_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-201 name=__codelineno-247-201 href=#__codelineno-247-201></a><span class=w>            </span><span class=nt>&quot;large_receive_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-202 name=__codelineno-247-202 href=#__codelineno-247-202></a><span class=w>            </span><span class=nt>&quot;loopback&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-203 name=__codelineno-247-203 href=#__codelineno-247-203></a><span class=w>            </span><span class=nt>&quot;netns_local&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-204 name=__codelineno-247-204 href=#__codelineno-247-204></a><span class=w>            </span><span class=nt>&quot;ntuple_filters&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-205 name=__codelineno-247-205 href=#__codelineno-247-205></a><span class=w>            </span><span class=nt>&quot;receive_hashing&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-206 name=__codelineno-247-206 href=#__codelineno-247-206></a><span class=w>            </span><span class=nt>&quot;rx_all&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-207 name=__codelineno-247-207 href=#__codelineno-247-207></a><span class=w>            </span><span class=nt>&quot;rx_checksumming&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-208 name=__codelineno-247-208 href=#__codelineno-247-208></a><span class=w>            </span><span class=nt>&quot;rx_fcs&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-209 name=__codelineno-247-209 href=#__codelineno-247-209></a><span class=w>            </span><span class=nt>&quot;rx_gro_hw&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-210 name=__codelineno-247-210 href=#__codelineno-247-210></a><span class=w>            </span><span class=nt>&quot;rx_udp_tunnel_port_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-211 name=__codelineno-247-211 href=#__codelineno-247-211></a><span class=w>            </span><span class=nt>&quot;rx_vlan_filter&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-212 name=__codelineno-247-212 href=#__codelineno-247-212></a><span class=w>            </span><span class=nt>&quot;rx_vlan_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-213 name=__codelineno-247-213 href=#__codelineno-247-213></a><span class=w>            </span><span class=nt>&quot;rx_vlan_stag_filter&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-214 name=__codelineno-247-214 href=#__codelineno-247-214></a><span class=w>            </span><span class=nt>&quot;rx_vlan_stag_hw_parse&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-215 name=__codelineno-247-215 href=#__codelineno-247-215></a><span class=w>            </span><span class=nt>&quot;scatter_gather&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-216 name=__codelineno-247-216 href=#__codelineno-247-216></a><span class=w>            </span><span class=nt>&quot;tcp_segmentation_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-217 name=__codelineno-247-217 href=#__codelineno-247-217></a><span class=w>            </span><span class=nt>&quot;tls_hw_record&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-218 name=__codelineno-247-218 href=#__codelineno-247-218></a><span class=w>            </span><span class=nt>&quot;tls_hw_rx_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-219 name=__codelineno-247-219 href=#__codelineno-247-219></a><span class=w>            </span><span class=nt>&quot;tls_hw_tx_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-220 name=__codelineno-247-220 href=#__codelineno-247-220></a><span class=w>            </span><span class=nt>&quot;tx_checksum_fcoe_crc&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-221 name=__codelineno-247-221 href=#__codelineno-247-221></a><span class=w>            </span><span class=nt>&quot;tx_checksum_ip_generic&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-222 name=__codelineno-247-222 href=#__codelineno-247-222></a><span class=w>            </span><span class=nt>&quot;tx_checksum_ipv4&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-223 name=__codelineno-247-223 href=#__codelineno-247-223></a><span class=w>            </span><span class=nt>&quot;tx_checksum_ipv6&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-224 name=__codelineno-247-224 href=#__codelineno-247-224></a><span class=w>            </span><span class=nt>&quot;tx_checksum_sctp&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-225 name=__codelineno-247-225 href=#__codelineno-247-225></a><span class=w>            </span><span class=nt>&quot;tx_checksumming&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-226 name=__codelineno-247-226 href=#__codelineno-247-226></a><span class=w>            </span><span class=nt>&quot;tx_esp_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-227 name=__codelineno-247-227 href=#__codelineno-247-227></a><span class=w>            </span><span class=nt>&quot;tx_fcoe_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-228 name=__codelineno-247-228 href=#__codelineno-247-228></a><span class=w>            </span><span class=nt>&quot;tx_gre_csum_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-229 name=__codelineno-247-229 href=#__codelineno-247-229></a><span class=w>            </span><span class=nt>&quot;tx_gre_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-230 name=__codelineno-247-230 href=#__codelineno-247-230></a><span class=w>            </span><span class=nt>&quot;tx_gso_partial&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-231 name=__codelineno-247-231 href=#__codelineno-247-231></a><span class=w>            </span><span class=nt>&quot;tx_gso_robust&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-232 name=__codelineno-247-232 href=#__codelineno-247-232></a><span class=w>            </span><span class=nt>&quot;tx_ipxip4_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-233 name=__codelineno-247-233 href=#__codelineno-247-233></a><span class=w>            </span><span class=nt>&quot;tx_ipxip6_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-234 name=__codelineno-247-234 href=#__codelineno-247-234></a><span class=w>            </span><span class=nt>&quot;tx_lockless&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-235 name=__codelineno-247-235 href=#__codelineno-247-235></a><span class=w>            </span><span class=nt>&quot;tx_nocache_copy&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-236 name=__codelineno-247-236 href=#__codelineno-247-236></a><span class=w>            </span><span class=nt>&quot;tx_scatter_gather&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-237 name=__codelineno-247-237 href=#__codelineno-247-237></a><span class=w>            </span><span class=nt>&quot;tx_scatter_gather_fraglist&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-238 name=__codelineno-247-238 href=#__codelineno-247-238></a><span class=w>            </span><span class=nt>&quot;tx_sctp_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-239 name=__codelineno-247-239 href=#__codelineno-247-239></a><span class=w>            </span><span class=nt>&quot;tx_tcp6_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-240 name=__codelineno-247-240 href=#__codelineno-247-240></a><span class=w>            </span><span class=nt>&quot;tx_tcp_ecn_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-241 name=__codelineno-247-241 href=#__codelineno-247-241></a><span class=w>            </span><span class=nt>&quot;tx_tcp_mangleid_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-242 name=__codelineno-247-242 href=#__codelineno-247-242></a><span class=w>            </span><span class=nt>&quot;tx_tcp_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-243 name=__codelineno-247-243 href=#__codelineno-247-243></a><span class=w>            </span><span class=nt>&quot;tx_udp_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-244 name=__codelineno-247-244 href=#__codelineno-247-244></a><span class=w>            </span><span class=nt>&quot;tx_udp_tnl_csum_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-245 name=__codelineno-247-245 href=#__codelineno-247-245></a><span class=w>            </span><span class=nt>&quot;tx_udp_tnl_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-246 name=__codelineno-247-246 href=#__codelineno-247-246></a><span class=w>            </span><span class=nt>&quot;tx_vlan_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-247 name=__codelineno-247-247 href=#__codelineno-247-247></a><span class=w>            </span><span class=nt>&quot;tx_vlan_stag_hw_insert&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-248 name=__codelineno-247-248 href=#__codelineno-247-248></a><span class=w>            </span><span class=nt>&quot;udp_fragmentation_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-249 name=__codelineno-247-249 href=#__codelineno-247-249></a><span class=w>            </span><span class=nt>&quot;vlan_challenged&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span>
<a id=__codelineno-247-250 name=__codelineno-247-250 href=#__codelineno-247-250></a><span class=w>        </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-251 name=__codelineno-247-251 href=#__codelineno-247-251></a><span class=w>        </span><span class=nt>&quot;hw_timestamp_filters&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-252 name=__codelineno-247-252 href=#__codelineno-247-252></a><span class=w>        </span><span class=nt>&quot;id&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;8000.024238d96cf4&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-253 name=__codelineno-247-253 href=#__codelineno-247-253></a><span class=w>        </span><span class=nt>&quot;interfaces&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-254 name=__codelineno-247-254 href=#__codelineno-247-254></a><span class=w>        </span><span class=nt>&quot;ipv4&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-255 name=__codelineno-247-255 href=#__codelineno-247-255></a><span class=w>            </span><span class=nt>&quot;address&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;172.17.0.1&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-256 name=__codelineno-247-256 href=#__codelineno-247-256></a><span class=w>            </span><span class=nt>&quot;broadcast&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;172.17.255.255&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-257 name=__codelineno-247-257 href=#__codelineno-247-257></a><span class=w>            </span><span class=nt>&quot;netmask&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;255.255.0.0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-258 name=__codelineno-247-258 href=#__codelineno-247-258></a><span class=w>            </span><span class=nt>&quot;network&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;172.17.0.0&quot;</span>
<a id=__codelineno-247-259 name=__codelineno-247-259 href=#__codelineno-247-259></a><span class=w>        </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-260 name=__codelineno-247-260 href=#__codelineno-247-260></a><span class=w>        </span><span class=nt>&quot;macaddress&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;02:42:38:d9:6c:f4&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-261 name=__codelineno-247-261 href=#__codelineno-247-261></a><span class=w>        </span><span class=nt>&quot;mtu&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1500</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-262 name=__codelineno-247-262 href=#__codelineno-247-262></a><span class=w>        </span><span class=nt>&quot;promisc&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-263 name=__codelineno-247-263 href=#__codelineno-247-263></a><span class=w>        </span><span class=nt>&quot;stp&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-264 name=__codelineno-247-264 href=#__codelineno-247-264></a><span class=w>        </span><span class=nt>&quot;timestamping&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-265 name=__codelineno-247-265 href=#__codelineno-247-265></a><span class=w>            </span><span class=s2>&quot;rx_software&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-266 name=__codelineno-247-266 href=#__codelineno-247-266></a><span class=w>            </span><span class=s2>&quot;software&quot;</span>
<a id=__codelineno-247-267 name=__codelineno-247-267 href=#__codelineno-247-267></a><span class=w>        </span><span class=p>],</span><span class=w> </span>
<a id=__codelineno-247-268 name=__codelineno-247-268 href=#__codelineno-247-268></a><span class=w>        </span><span class=nt>&quot;type&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;bridge&quot;</span>
<a id=__codelineno-247-269 name=__codelineno-247-269 href=#__codelineno-247-269></a><span class=w>    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-270 name=__codelineno-247-270 href=#__codelineno-247-270></a><span class=w>    </span><span class=nt>&quot;ansible_domain&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-271 name=__codelineno-247-271 href=#__codelineno-247-271></a><span class=w>    </span><span class=nt>&quot;ansible_effective_group_id&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-272 name=__codelineno-247-272 href=#__codelineno-247-272></a><span class=w>    </span><span class=nt>&quot;ansible_effective_user_id&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-273 name=__codelineno-247-273 href=#__codelineno-247-273></a><span class=w>    </span><span class=nt>&quot;ansible_ens33&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-274 name=__codelineno-247-274 href=#__codelineno-247-274></a><span class=w>        </span><span class=nt>&quot;active&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-275 name=__codelineno-247-275 href=#__codelineno-247-275></a><span class=w>        </span><span class=nt>&quot;device&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;ens33&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-276 name=__codelineno-247-276 href=#__codelineno-247-276></a><span class=w>        </span><span class=nt>&quot;features&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-277 name=__codelineno-247-277 href=#__codelineno-247-277></a><span class=w>            </span><span class=nt>&quot;esp_hw_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-278 name=__codelineno-247-278 href=#__codelineno-247-278></a><span class=w>            </span><span class=nt>&quot;esp_tx_csum_hw_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-279 name=__codelineno-247-279 href=#__codelineno-247-279></a><span class=w>            </span><span class=nt>&quot;fcoe_mtu&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-280 name=__codelineno-247-280 href=#__codelineno-247-280></a><span class=w>            </span><span class=nt>&quot;generic_receive_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-281 name=__codelineno-247-281 href=#__codelineno-247-281></a><span class=w>            </span><span class=nt>&quot;generic_segmentation_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-282 name=__codelineno-247-282 href=#__codelineno-247-282></a><span class=w>            </span><span class=nt>&quot;highdma&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-283 name=__codelineno-247-283 href=#__codelineno-247-283></a><span class=w>            </span><span class=nt>&quot;hw_tc_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-284 name=__codelineno-247-284 href=#__codelineno-247-284></a><span class=w>            </span><span class=nt>&quot;l2_fwd_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-285 name=__codelineno-247-285 href=#__codelineno-247-285></a><span class=w>            </span><span class=nt>&quot;large_receive_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-286 name=__codelineno-247-286 href=#__codelineno-247-286></a><span class=w>            </span><span class=nt>&quot;loopback&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-287 name=__codelineno-247-287 href=#__codelineno-247-287></a><span class=w>            </span><span class=nt>&quot;netns_local&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-288 name=__codelineno-247-288 href=#__codelineno-247-288></a><span class=w>            </span><span class=nt>&quot;ntuple_filters&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-289 name=__codelineno-247-289 href=#__codelineno-247-289></a><span class=w>            </span><span class=nt>&quot;receive_hashing&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-290 name=__codelineno-247-290 href=#__codelineno-247-290></a><span class=w>            </span><span class=nt>&quot;rx_all&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-291 name=__codelineno-247-291 href=#__codelineno-247-291></a><span class=w>            </span><span class=nt>&quot;rx_checksumming&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-292 name=__codelineno-247-292 href=#__codelineno-247-292></a><span class=w>            </span><span class=nt>&quot;rx_fcs&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-293 name=__codelineno-247-293 href=#__codelineno-247-293></a><span class=w>            </span><span class=nt>&quot;rx_gro_hw&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-294 name=__codelineno-247-294 href=#__codelineno-247-294></a><span class=w>            </span><span class=nt>&quot;rx_udp_tunnel_port_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-295 name=__codelineno-247-295 href=#__codelineno-247-295></a><span class=w>            </span><span class=nt>&quot;rx_vlan_filter&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-296 name=__codelineno-247-296 href=#__codelineno-247-296></a><span class=w>            </span><span class=nt>&quot;rx_vlan_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-297 name=__codelineno-247-297 href=#__codelineno-247-297></a><span class=w>            </span><span class=nt>&quot;rx_vlan_stag_filter&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-298 name=__codelineno-247-298 href=#__codelineno-247-298></a><span class=w>            </span><span class=nt>&quot;rx_vlan_stag_hw_parse&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-299 name=__codelineno-247-299 href=#__codelineno-247-299></a><span class=w>            </span><span class=nt>&quot;scatter_gather&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-300 name=__codelineno-247-300 href=#__codelineno-247-300></a><span class=w>            </span><span class=nt>&quot;tcp_segmentation_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-301 name=__codelineno-247-301 href=#__codelineno-247-301></a><span class=w>            </span><span class=nt>&quot;tls_hw_record&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-302 name=__codelineno-247-302 href=#__codelineno-247-302></a><span class=w>            </span><span class=nt>&quot;tls_hw_rx_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-303 name=__codelineno-247-303 href=#__codelineno-247-303></a><span class=w>            </span><span class=nt>&quot;tls_hw_tx_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-304 name=__codelineno-247-304 href=#__codelineno-247-304></a><span class=w>            </span><span class=nt>&quot;tx_checksum_fcoe_crc&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-305 name=__codelineno-247-305 href=#__codelineno-247-305></a><span class=w>            </span><span class=nt>&quot;tx_checksum_ip_generic&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-306 name=__codelineno-247-306 href=#__codelineno-247-306></a><span class=w>            </span><span class=nt>&quot;tx_checksum_ipv4&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-307 name=__codelineno-247-307 href=#__codelineno-247-307></a><span class=w>            </span><span class=nt>&quot;tx_checksum_ipv6&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-308 name=__codelineno-247-308 href=#__codelineno-247-308></a><span class=w>            </span><span class=nt>&quot;tx_checksum_sctp&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-309 name=__codelineno-247-309 href=#__codelineno-247-309></a><span class=w>            </span><span class=nt>&quot;tx_checksumming&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-310 name=__codelineno-247-310 href=#__codelineno-247-310></a><span class=w>            </span><span class=nt>&quot;tx_esp_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-311 name=__codelineno-247-311 href=#__codelineno-247-311></a><span class=w>            </span><span class=nt>&quot;tx_fcoe_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-312 name=__codelineno-247-312 href=#__codelineno-247-312></a><span class=w>            </span><span class=nt>&quot;tx_gre_csum_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-313 name=__codelineno-247-313 href=#__codelineno-247-313></a><span class=w>            </span><span class=nt>&quot;tx_gre_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-314 name=__codelineno-247-314 href=#__codelineno-247-314></a><span class=w>            </span><span class=nt>&quot;tx_gso_partial&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-315 name=__codelineno-247-315 href=#__codelineno-247-315></a><span class=w>            </span><span class=nt>&quot;tx_gso_robust&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-316 name=__codelineno-247-316 href=#__codelineno-247-316></a><span class=w>            </span><span class=nt>&quot;tx_ipxip4_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-317 name=__codelineno-247-317 href=#__codelineno-247-317></a><span class=w>            </span><span class=nt>&quot;tx_ipxip6_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-318 name=__codelineno-247-318 href=#__codelineno-247-318></a><span class=w>            </span><span class=nt>&quot;tx_lockless&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-319 name=__codelineno-247-319 href=#__codelineno-247-319></a><span class=w>            </span><span class=nt>&quot;tx_nocache_copy&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-320 name=__codelineno-247-320 href=#__codelineno-247-320></a><span class=w>            </span><span class=nt>&quot;tx_scatter_gather&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-321 name=__codelineno-247-321 href=#__codelineno-247-321></a><span class=w>            </span><span class=nt>&quot;tx_scatter_gather_fraglist&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-322 name=__codelineno-247-322 href=#__codelineno-247-322></a><span class=w>            </span><span class=nt>&quot;tx_sctp_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-323 name=__codelineno-247-323 href=#__codelineno-247-323></a><span class=w>            </span><span class=nt>&quot;tx_tcp6_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-324 name=__codelineno-247-324 href=#__codelineno-247-324></a><span class=w>            </span><span class=nt>&quot;tx_tcp_ecn_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-325 name=__codelineno-247-325 href=#__codelineno-247-325></a><span class=w>            </span><span class=nt>&quot;tx_tcp_mangleid_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-326 name=__codelineno-247-326 href=#__codelineno-247-326></a><span class=w>            </span><span class=nt>&quot;tx_tcp_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-327 name=__codelineno-247-327 href=#__codelineno-247-327></a><span class=w>            </span><span class=nt>&quot;tx_udp_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-328 name=__codelineno-247-328 href=#__codelineno-247-328></a><span class=w>            </span><span class=nt>&quot;tx_udp_tnl_csum_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-329 name=__codelineno-247-329 href=#__codelineno-247-329></a><span class=w>            </span><span class=nt>&quot;tx_udp_tnl_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-330 name=__codelineno-247-330 href=#__codelineno-247-330></a><span class=w>            </span><span class=nt>&quot;tx_vlan_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-331 name=__codelineno-247-331 href=#__codelineno-247-331></a><span class=w>            </span><span class=nt>&quot;tx_vlan_stag_hw_insert&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-332 name=__codelineno-247-332 href=#__codelineno-247-332></a><span class=w>            </span><span class=nt>&quot;udp_fragmentation_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-333 name=__codelineno-247-333 href=#__codelineno-247-333></a><span class=w>            </span><span class=nt>&quot;vlan_challenged&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span>
<a id=__codelineno-247-334 name=__codelineno-247-334 href=#__codelineno-247-334></a><span class=w>        </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-335 name=__codelineno-247-335 href=#__codelineno-247-335></a><span class=w>        </span><span class=nt>&quot;hw_timestamp_filters&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-336 name=__codelineno-247-336 href=#__codelineno-247-336></a><span class=w>        </span><span class=nt>&quot;ipv4&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-337 name=__codelineno-247-337 href=#__codelineno-247-337></a><span class=w>            </span><span class=nt>&quot;address&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;192.168.77.130&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-338 name=__codelineno-247-338 href=#__codelineno-247-338></a><span class=w>            </span><span class=nt>&quot;broadcast&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;192.168.77.255&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-339 name=__codelineno-247-339 href=#__codelineno-247-339></a><span class=w>            </span><span class=nt>&quot;netmask&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;255.255.255.0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-340 name=__codelineno-247-340 href=#__codelineno-247-340></a><span class=w>            </span><span class=nt>&quot;network&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;192.168.77.0&quot;</span>
<a id=__codelineno-247-341 name=__codelineno-247-341 href=#__codelineno-247-341></a><span class=w>        </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-342 name=__codelineno-247-342 href=#__codelineno-247-342></a><span class=w>        </span><span class=nt>&quot;ipv6&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-343 name=__codelineno-247-343 href=#__codelineno-247-343></a><span class=w>            </span><span class=p>{</span>
<a id=__codelineno-247-344 name=__codelineno-247-344 href=#__codelineno-247-344></a><span class=w>                </span><span class=nt>&quot;address&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;fe80::6d73:3667:2ed6:a7c2&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-345 name=__codelineno-247-345 href=#__codelineno-247-345></a><span class=w>                </span><span class=nt>&quot;prefix&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;64&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-346 name=__codelineno-247-346 href=#__codelineno-247-346></a><span class=w>                </span><span class=nt>&quot;scope&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;link&quot;</span>
<a id=__codelineno-247-347 name=__codelineno-247-347 href=#__codelineno-247-347></a><span class=w>            </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-348 name=__codelineno-247-348 href=#__codelineno-247-348></a><span class=w>            </span><span class=p>{</span>
<a id=__codelineno-247-349 name=__codelineno-247-349 href=#__codelineno-247-349></a><span class=w>                </span><span class=nt>&quot;address&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;fe80::4d03:8744:2f0d:2085&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-350 name=__codelineno-247-350 href=#__codelineno-247-350></a><span class=w>                </span><span class=nt>&quot;prefix&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;64&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-351 name=__codelineno-247-351 href=#__codelineno-247-351></a><span class=w>                </span><span class=nt>&quot;scope&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;link&quot;</span>
<a id=__codelineno-247-352 name=__codelineno-247-352 href=#__codelineno-247-352></a><span class=w>            </span><span class=p>}</span>
<a id=__codelineno-247-353 name=__codelineno-247-353 href=#__codelineno-247-353></a><span class=w>        </span><span class=p>],</span><span class=w> </span>
<a id=__codelineno-247-354 name=__codelineno-247-354 href=#__codelineno-247-354></a><span class=w>        </span><span class=nt>&quot;macaddress&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;00:0c:29:88:01:c0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-355 name=__codelineno-247-355 href=#__codelineno-247-355></a><span class=w>        </span><span class=nt>&quot;module&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;e1000&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-356 name=__codelineno-247-356 href=#__codelineno-247-356></a><span class=w>        </span><span class=nt>&quot;mtu&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1500</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-357 name=__codelineno-247-357 href=#__codelineno-247-357></a><span class=w>        </span><span class=nt>&quot;pciid&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;0000:02:01.0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-358 name=__codelineno-247-358 href=#__codelineno-247-358></a><span class=w>        </span><span class=nt>&quot;promisc&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-359 name=__codelineno-247-359 href=#__codelineno-247-359></a><span class=w>        </span><span class=nt>&quot;speed&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1000</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-360 name=__codelineno-247-360 href=#__codelineno-247-360></a><span class=w>        </span><span class=nt>&quot;timestamping&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-361 name=__codelineno-247-361 href=#__codelineno-247-361></a><span class=w>            </span><span class=s2>&quot;tx_software&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-362 name=__codelineno-247-362 href=#__codelineno-247-362></a><span class=w>            </span><span class=s2>&quot;rx_software&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-363 name=__codelineno-247-363 href=#__codelineno-247-363></a><span class=w>            </span><span class=s2>&quot;software&quot;</span>
<a id=__codelineno-247-364 name=__codelineno-247-364 href=#__codelineno-247-364></a><span class=w>        </span><span class=p>],</span><span class=w> </span>
<a id=__codelineno-247-365 name=__codelineno-247-365 href=#__codelineno-247-365></a><span class=w>        </span><span class=nt>&quot;type&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;ether&quot;</span>
<a id=__codelineno-247-366 name=__codelineno-247-366 href=#__codelineno-247-366></a><span class=w>    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-367 name=__codelineno-247-367 href=#__codelineno-247-367></a><span class=w>    </span><span class=nt>&quot;ansible_env&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-368 name=__codelineno-247-368 href=#__codelineno-247-368></a><span class=w>        </span><span class=nt>&quot;HOME&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/root&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-369 name=__codelineno-247-369 href=#__codelineno-247-369></a><span class=w>        </span><span class=nt>&quot;LANG&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;zh_CN.UTF-8&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-370 name=__codelineno-247-370 href=#__codelineno-247-370></a><span class=w>        </span><span class=nt>&quot;LESSOPEN&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;||/usr/bin/lesspipe.sh %s&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-371 name=__codelineno-247-371 href=#__codelineno-247-371></a><span class=w>        </span><span class=nt>&quot;LOGNAME&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;root&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-372 name=__codelineno-247-372 href=#__codelineno-247-372></a><span class=w>        </span><span class=nt>&quot;LS_COLORS&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=01;05;37;41:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.axv=01;35:*.anx=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=01;36:*.au=01;36:*.flac=01;36:*.mid=01;36:*.midi=01;36:*.mka=01;36:*.mp3=01;36:*.mpc=01;36:*.ogg=01;36:*.ra=01;36:*.wav=01;36:*.axa=01;36:*.oga=01;36:*.spx=01;36:*.xspf=01;36:&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-373 name=__codelineno-247-373 href=#__codelineno-247-373></a><span class=w>        </span><span class=nt>&quot;MAIL&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/var/mail/root&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-374 name=__codelineno-247-374 href=#__codelineno-247-374></a><span class=w>        </span><span class=nt>&quot;PATH&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-375 name=__codelineno-247-375 href=#__codelineno-247-375></a><span class=w>        </span><span class=nt>&quot;PWD&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/root&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-376 name=__codelineno-247-376 href=#__codelineno-247-376></a><span class=w>        </span><span class=nt>&quot;SHELL&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/bin/bash&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-377 name=__codelineno-247-377 href=#__codelineno-247-377></a><span class=w>        </span><span class=nt>&quot;SHLVL&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-378 name=__codelineno-247-378 href=#__codelineno-247-378></a><span class=w>        </span><span class=nt>&quot;SSH_CLIENT&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;192.168.77.128 46964 22&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-379 name=__codelineno-247-379 href=#__codelineno-247-379></a><span class=w>        </span><span class=nt>&quot;SSH_CONNECTION&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;192.168.77.128 46964 192.168.77.130 22&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-380 name=__codelineno-247-380 href=#__codelineno-247-380></a><span class=w>        </span><span class=nt>&quot;SSH_TTY&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/dev/pts/1&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-381 name=__codelineno-247-381 href=#__codelineno-247-381></a><span class=w>        </span><span class=nt>&quot;TERM&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;linux&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-382 name=__codelineno-247-382 href=#__codelineno-247-382></a><span class=w>        </span><span class=nt>&quot;USER&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;root&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-383 name=__codelineno-247-383 href=#__codelineno-247-383></a><span class=w>        </span><span class=nt>&quot;XDG_RUNTIME_DIR&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/run/user/0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-384 name=__codelineno-247-384 href=#__codelineno-247-384></a><span class=w>        </span><span class=nt>&quot;XDG_SESSION_ID&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;22&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-385 name=__codelineno-247-385 href=#__codelineno-247-385></a><span class=w>        </span><span class=nt>&quot;_&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/usr/bin/python&quot;</span>
<a id=__codelineno-247-386 name=__codelineno-247-386 href=#__codelineno-247-386></a><span class=w>    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-387 name=__codelineno-247-387 href=#__codelineno-247-387></a><span class=w>    </span><span class=nt>&quot;ansible_fibre_channel_wwn&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-388 name=__codelineno-247-388 href=#__codelineno-247-388></a><span class=w>    </span><span class=nt>&quot;ansible_fips&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-389 name=__codelineno-247-389 href=#__codelineno-247-389></a><span class=w>    </span><span class=nt>&quot;ansible_form_factor&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;Other&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-390 name=__codelineno-247-390 href=#__codelineno-247-390></a><span class=w>    </span><span class=nt>&quot;ansible_fqdn&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;node130&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-391 name=__codelineno-247-391 href=#__codelineno-247-391></a><span class=w>    </span><span class=nt>&quot;ansible_hostname&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;node130&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-392 name=__codelineno-247-392 href=#__codelineno-247-392></a><span class=w>    </span><span class=nt>&quot;ansible_hostnqn&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-393 name=__codelineno-247-393 href=#__codelineno-247-393></a><span class=w>    </span><span class=nt>&quot;ansible_interfaces&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-394 name=__codelineno-247-394 href=#__codelineno-247-394></a><span class=w>        </span><span class=s2>&quot;lo&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-395 name=__codelineno-247-395 href=#__codelineno-247-395></a><span class=w>        </span><span class=s2>&quot;docker0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-396 name=__codelineno-247-396 href=#__codelineno-247-396></a><span class=w>        </span><span class=s2>&quot;ens33&quot;</span>
<a id=__codelineno-247-397 name=__codelineno-247-397 href=#__codelineno-247-397></a><span class=w>    </span><span class=p>],</span><span class=w> </span>
<a id=__codelineno-247-398 name=__codelineno-247-398 href=#__codelineno-247-398></a><span class=w>    </span><span class=nt>&quot;ansible_is_chroot&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-399 name=__codelineno-247-399 href=#__codelineno-247-399></a><span class=w>    </span><span class=nt>&quot;ansible_iscsi_iqn&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-400 name=__codelineno-247-400 href=#__codelineno-247-400></a><span class=w>    </span><span class=nt>&quot;ansible_kernel&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;5.1.11-1.el7.elrepo.x86_64&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-401 name=__codelineno-247-401 href=#__codelineno-247-401></a><span class=w>    </span><span class=nt>&quot;ansible_kernel_version&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;#1 SMP Mon Jun 17 15:51:08 EDT 2019&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-402 name=__codelineno-247-402 href=#__codelineno-247-402></a><span class=w>    </span><span class=nt>&quot;ansible_lo&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-403 name=__codelineno-247-403 href=#__codelineno-247-403></a><span class=w>        </span><span class=nt>&quot;active&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-404 name=__codelineno-247-404 href=#__codelineno-247-404></a><span class=w>        </span><span class=nt>&quot;device&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;lo&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-405 name=__codelineno-247-405 href=#__codelineno-247-405></a><span class=w>        </span><span class=nt>&quot;features&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-406 name=__codelineno-247-406 href=#__codelineno-247-406></a><span class=w>            </span><span class=nt>&quot;esp_hw_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-407 name=__codelineno-247-407 href=#__codelineno-247-407></a><span class=w>            </span><span class=nt>&quot;esp_tx_csum_hw_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-408 name=__codelineno-247-408 href=#__codelineno-247-408></a><span class=w>            </span><span class=nt>&quot;fcoe_mtu&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-409 name=__codelineno-247-409 href=#__codelineno-247-409></a><span class=w>            </span><span class=nt>&quot;generic_receive_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-410 name=__codelineno-247-410 href=#__codelineno-247-410></a><span class=w>            </span><span class=nt>&quot;generic_segmentation_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-411 name=__codelineno-247-411 href=#__codelineno-247-411></a><span class=w>            </span><span class=nt>&quot;highdma&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-412 name=__codelineno-247-412 href=#__codelineno-247-412></a><span class=w>            </span><span class=nt>&quot;hw_tc_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-413 name=__codelineno-247-413 href=#__codelineno-247-413></a><span class=w>            </span><span class=nt>&quot;l2_fwd_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-414 name=__codelineno-247-414 href=#__codelineno-247-414></a><span class=w>            </span><span class=nt>&quot;large_receive_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-415 name=__codelineno-247-415 href=#__codelineno-247-415></a><span class=w>            </span><span class=nt>&quot;loopback&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-416 name=__codelineno-247-416 href=#__codelineno-247-416></a><span class=w>            </span><span class=nt>&quot;netns_local&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-417 name=__codelineno-247-417 href=#__codelineno-247-417></a><span class=w>            </span><span class=nt>&quot;ntuple_filters&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-418 name=__codelineno-247-418 href=#__codelineno-247-418></a><span class=w>            </span><span class=nt>&quot;receive_hashing&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-419 name=__codelineno-247-419 href=#__codelineno-247-419></a><span class=w>            </span><span class=nt>&quot;rx_all&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-420 name=__codelineno-247-420 href=#__codelineno-247-420></a><span class=w>            </span><span class=nt>&quot;rx_checksumming&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-421 name=__codelineno-247-421 href=#__codelineno-247-421></a><span class=w>            </span><span class=nt>&quot;rx_fcs&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-422 name=__codelineno-247-422 href=#__codelineno-247-422></a><span class=w>            </span><span class=nt>&quot;rx_gro_hw&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-423 name=__codelineno-247-423 href=#__codelineno-247-423></a><span class=w>            </span><span class=nt>&quot;rx_udp_tunnel_port_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-424 name=__codelineno-247-424 href=#__codelineno-247-424></a><span class=w>            </span><span class=nt>&quot;rx_vlan_filter&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-425 name=__codelineno-247-425 href=#__codelineno-247-425></a><span class=w>            </span><span class=nt>&quot;rx_vlan_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-426 name=__codelineno-247-426 href=#__codelineno-247-426></a><span class=w>            </span><span class=nt>&quot;rx_vlan_stag_filter&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-427 name=__codelineno-247-427 href=#__codelineno-247-427></a><span class=w>            </span><span class=nt>&quot;rx_vlan_stag_hw_parse&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-428 name=__codelineno-247-428 href=#__codelineno-247-428></a><span class=w>            </span><span class=nt>&quot;scatter_gather&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-429 name=__codelineno-247-429 href=#__codelineno-247-429></a><span class=w>            </span><span class=nt>&quot;tcp_segmentation_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-430 name=__codelineno-247-430 href=#__codelineno-247-430></a><span class=w>            </span><span class=nt>&quot;tls_hw_record&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-431 name=__codelineno-247-431 href=#__codelineno-247-431></a><span class=w>            </span><span class=nt>&quot;tls_hw_rx_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-432 name=__codelineno-247-432 href=#__codelineno-247-432></a><span class=w>            </span><span class=nt>&quot;tls_hw_tx_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-433 name=__codelineno-247-433 href=#__codelineno-247-433></a><span class=w>            </span><span class=nt>&quot;tx_checksum_fcoe_crc&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-434 name=__codelineno-247-434 href=#__codelineno-247-434></a><span class=w>            </span><span class=nt>&quot;tx_checksum_ip_generic&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-435 name=__codelineno-247-435 href=#__codelineno-247-435></a><span class=w>            </span><span class=nt>&quot;tx_checksum_ipv4&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-436 name=__codelineno-247-436 href=#__codelineno-247-436></a><span class=w>            </span><span class=nt>&quot;tx_checksum_ipv6&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-437 name=__codelineno-247-437 href=#__codelineno-247-437></a><span class=w>            </span><span class=nt>&quot;tx_checksum_sctp&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-438 name=__codelineno-247-438 href=#__codelineno-247-438></a><span class=w>            </span><span class=nt>&quot;tx_checksumming&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-439 name=__codelineno-247-439 href=#__codelineno-247-439></a><span class=w>            </span><span class=nt>&quot;tx_esp_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-440 name=__codelineno-247-440 href=#__codelineno-247-440></a><span class=w>            </span><span class=nt>&quot;tx_fcoe_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-441 name=__codelineno-247-441 href=#__codelineno-247-441></a><span class=w>            </span><span class=nt>&quot;tx_gre_csum_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-442 name=__codelineno-247-442 href=#__codelineno-247-442></a><span class=w>            </span><span class=nt>&quot;tx_gre_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-443 name=__codelineno-247-443 href=#__codelineno-247-443></a><span class=w>            </span><span class=nt>&quot;tx_gso_partial&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-444 name=__codelineno-247-444 href=#__codelineno-247-444></a><span class=w>            </span><span class=nt>&quot;tx_gso_robust&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-445 name=__codelineno-247-445 href=#__codelineno-247-445></a><span class=w>            </span><span class=nt>&quot;tx_ipxip4_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-446 name=__codelineno-247-446 href=#__codelineno-247-446></a><span class=w>            </span><span class=nt>&quot;tx_ipxip6_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-447 name=__codelineno-247-447 href=#__codelineno-247-447></a><span class=w>            </span><span class=nt>&quot;tx_lockless&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-448 name=__codelineno-247-448 href=#__codelineno-247-448></a><span class=w>            </span><span class=nt>&quot;tx_nocache_copy&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-449 name=__codelineno-247-449 href=#__codelineno-247-449></a><span class=w>            </span><span class=nt>&quot;tx_scatter_gather&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-450 name=__codelineno-247-450 href=#__codelineno-247-450></a><span class=w>            </span><span class=nt>&quot;tx_scatter_gather_fraglist&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-451 name=__codelineno-247-451 href=#__codelineno-247-451></a><span class=w>            </span><span class=nt>&quot;tx_sctp_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-452 name=__codelineno-247-452 href=#__codelineno-247-452></a><span class=w>            </span><span class=nt>&quot;tx_tcp6_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-453 name=__codelineno-247-453 href=#__codelineno-247-453></a><span class=w>            </span><span class=nt>&quot;tx_tcp_ecn_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-454 name=__codelineno-247-454 href=#__codelineno-247-454></a><span class=w>            </span><span class=nt>&quot;tx_tcp_mangleid_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-455 name=__codelineno-247-455 href=#__codelineno-247-455></a><span class=w>            </span><span class=nt>&quot;tx_tcp_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-456 name=__codelineno-247-456 href=#__codelineno-247-456></a><span class=w>            </span><span class=nt>&quot;tx_udp_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-457 name=__codelineno-247-457 href=#__codelineno-247-457></a><span class=w>            </span><span class=nt>&quot;tx_udp_tnl_csum_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-458 name=__codelineno-247-458 href=#__codelineno-247-458></a><span class=w>            </span><span class=nt>&quot;tx_udp_tnl_segmentation&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-459 name=__codelineno-247-459 href=#__codelineno-247-459></a><span class=w>            </span><span class=nt>&quot;tx_vlan_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-460 name=__codelineno-247-460 href=#__codelineno-247-460></a><span class=w>            </span><span class=nt>&quot;tx_vlan_stag_hw_insert&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off [fixed]&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-461 name=__codelineno-247-461 href=#__codelineno-247-461></a><span class=w>            </span><span class=nt>&quot;udp_fragmentation_offload&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;off&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-462 name=__codelineno-247-462 href=#__codelineno-247-462></a><span class=w>            </span><span class=nt>&quot;vlan_challenged&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;on [fixed]&quot;</span>
<a id=__codelineno-247-463 name=__codelineno-247-463 href=#__codelineno-247-463></a><span class=w>        </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-464 name=__codelineno-247-464 href=#__codelineno-247-464></a><span class=w>        </span><span class=nt>&quot;hw_timestamp_filters&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-247-465 name=__codelineno-247-465 href=#__codelineno-247-465></a><span class=w>        </span><span class=nt>&quot;ipv4&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-466 name=__codelineno-247-466 href=#__codelineno-247-466></a><span class=w>            </span><span class=nt>&quot;address&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;127.0.0.1&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-467 name=__codelineno-247-467 href=#__codelineno-247-467></a><span class=w>            </span><span class=nt>&quot;broadcast&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;host&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-468 name=__codelineno-247-468 href=#__codelineno-247-468></a><span class=w>            </span><span class=nt>&quot;netmask&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;255.0.0.0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-469 name=__codelineno-247-469 href=#__codelineno-247-469></a><span class=w>            </span><span class=nt>&quot;network&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;127.0.0.0&quot;</span>
<a id=__codelineno-247-470 name=__codelineno-247-470 href=#__codelineno-247-470></a><span class=w>        </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-471 name=__codelineno-247-471 href=#__codelineno-247-471></a><span class=w>        </span><span class=nt>&quot;ipv6&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-472 name=__codelineno-247-472 href=#__codelineno-247-472></a><span class=w>            </span><span class=p>{</span>
<a id=__codelineno-247-473 name=__codelineno-247-473 href=#__codelineno-247-473></a><span class=w>                </span><span class=nt>&quot;address&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;::1&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-474 name=__codelineno-247-474 href=#__codelineno-247-474></a><span class=w>                </span><span class=nt>&quot;prefix&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;128&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-475 name=__codelineno-247-475 href=#__codelineno-247-475></a><span class=w>                </span><span class=nt>&quot;scope&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;host&quot;</span>
<a id=__codelineno-247-476 name=__codelineno-247-476 href=#__codelineno-247-476></a><span class=w>            </span><span class=p>}</span>
<a id=__codelineno-247-477 name=__codelineno-247-477 href=#__codelineno-247-477></a><span class=w>        </span><span class=p>],</span><span class=w> </span>
<a id=__codelineno-247-478 name=__codelineno-247-478 href=#__codelineno-247-478></a><span class=w>        </span><span class=nt>&quot;mtu&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>65536</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-479 name=__codelineno-247-479 href=#__codelineno-247-479></a><span class=w>        </span><span class=nt>&quot;promisc&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-480 name=__codelineno-247-480 href=#__codelineno-247-480></a><span class=w>        </span><span class=nt>&quot;timestamping&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-481 name=__codelineno-247-481 href=#__codelineno-247-481></a><span class=w>            </span><span class=s2>&quot;tx_software&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-482 name=__codelineno-247-482 href=#__codelineno-247-482></a><span class=w>            </span><span class=s2>&quot;rx_software&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-483 name=__codelineno-247-483 href=#__codelineno-247-483></a><span class=w>            </span><span class=s2>&quot;software&quot;</span>
<a id=__codelineno-247-484 name=__codelineno-247-484 href=#__codelineno-247-484></a><span class=w>        </span><span class=p>],</span><span class=w> </span>
<a id=__codelineno-247-485 name=__codelineno-247-485 href=#__codelineno-247-485></a><span class=w>        </span><span class=nt>&quot;type&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;loopback&quot;</span>
<a id=__codelineno-247-486 name=__codelineno-247-486 href=#__codelineno-247-486></a><span class=w>    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-487 name=__codelineno-247-487 href=#__codelineno-247-487></a><span class=w>    </span><span class=nt>&quot;ansible_local&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-488 name=__codelineno-247-488 href=#__codelineno-247-488></a><span class=w>        </span><span class=nt>&quot;hello&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-489 name=__codelineno-247-489 href=#__codelineno-247-489></a><span class=w>            </span><span class=nt>&quot;test&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-490 name=__codelineno-247-490 href=#__codelineno-247-490></a><span class=w>                </span><span class=nt>&quot;h&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;hello&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-491 name=__codelineno-247-491 href=#__codelineno-247-491></a><span class=w>                </span><span class=nt>&quot;p&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;world&quot;</span>
<a id=__codelineno-247-492 name=__codelineno-247-492 href=#__codelineno-247-492></a><span class=w>            </span><span class=p>}</span>
<a id=__codelineno-247-493 name=__codelineno-247-493 href=#__codelineno-247-493></a><span class=w>        </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-494 name=__codelineno-247-494 href=#__codelineno-247-494></a><span class=w>        </span><span class=nt>&quot;test&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-495 name=__codelineno-247-495 href=#__codelineno-247-495></a><span class=w>            </span><span class=nt>&quot;test&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-496 name=__codelineno-247-496 href=#__codelineno-247-496></a><span class=w>                </span><span class=nt>&quot;h&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;hello&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-497 name=__codelineno-247-497 href=#__codelineno-247-497></a><span class=w>                </span><span class=nt>&quot;p&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;world&quot;</span>
<a id=__codelineno-247-498 name=__codelineno-247-498 href=#__codelineno-247-498></a><span class=w>            </span><span class=p>}</span>
<a id=__codelineno-247-499 name=__codelineno-247-499 href=#__codelineno-247-499></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-247-500 name=__codelineno-247-500 href=#__codelineno-247-500></a><span class=w>    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-501 name=__codelineno-247-501 href=#__codelineno-247-501></a><span class=w>    </span><span class=nt>&quot;ansible_lsb&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{},</span><span class=w> </span>
<a id=__codelineno-247-502 name=__codelineno-247-502 href=#__codelineno-247-502></a><span class=w>    </span><span class=nt>&quot;ansible_machine&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;x86_64&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-503 name=__codelineno-247-503 href=#__codelineno-247-503></a><span class=w>    </span><span class=nt>&quot;ansible_machine_id&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;c6e2cb0cdbad41f19c30d690896aabe0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-504 name=__codelineno-247-504 href=#__codelineno-247-504></a><span class=w>    </span><span class=nt>&quot;ansible_memfree_mb&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>476</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-505 name=__codelineno-247-505 href=#__codelineno-247-505></a><span class=w>    </span><span class=nt>&quot;ansible_memory_mb&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-506 name=__codelineno-247-506 href=#__codelineno-247-506></a><span class=w>        </span><span class=nt>&quot;nocache&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-507 name=__codelineno-247-507 href=#__codelineno-247-507></a><span class=w>            </span><span class=nt>&quot;free&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>695</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-508 name=__codelineno-247-508 href=#__codelineno-247-508></a><span class=w>            </span><span class=nt>&quot;used&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>265</span>
<a id=__codelineno-247-509 name=__codelineno-247-509 href=#__codelineno-247-509></a><span class=w>        </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-510 name=__codelineno-247-510 href=#__codelineno-247-510></a><span class=w>        </span><span class=nt>&quot;real&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-511 name=__codelineno-247-511 href=#__codelineno-247-511></a><span class=w>            </span><span class=nt>&quot;free&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>476</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-512 name=__codelineno-247-512 href=#__codelineno-247-512></a><span class=w>            </span><span class=nt>&quot;total&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>960</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-513 name=__codelineno-247-513 href=#__codelineno-247-513></a><span class=w>            </span><span class=nt>&quot;used&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>484</span>
<a id=__codelineno-247-514 name=__codelineno-247-514 href=#__codelineno-247-514></a><span class=w>        </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-515 name=__codelineno-247-515 href=#__codelineno-247-515></a><span class=w>        </span><span class=nt>&quot;swap&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-516 name=__codelineno-247-516 href=#__codelineno-247-516></a><span class=w>            </span><span class=nt>&quot;cached&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-517 name=__codelineno-247-517 href=#__codelineno-247-517></a><span class=w>            </span><span class=nt>&quot;free&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>10239</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-518 name=__codelineno-247-518 href=#__codelineno-247-518></a><span class=w>            </span><span class=nt>&quot;total&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>10239</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-519 name=__codelineno-247-519 href=#__codelineno-247-519></a><span class=w>            </span><span class=nt>&quot;used&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span>
<a id=__codelineno-247-520 name=__codelineno-247-520 href=#__codelineno-247-520></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-247-521 name=__codelineno-247-521 href=#__codelineno-247-521></a><span class=w>    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-522 name=__codelineno-247-522 href=#__codelineno-247-522></a><span class=w>    </span><span class=nt>&quot;ansible_memtotal_mb&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>960</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-523 name=__codelineno-247-523 href=#__codelineno-247-523></a><span class=w>    </span><span class=nt>&quot;ansible_mounts&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-524 name=__codelineno-247-524 href=#__codelineno-247-524></a><span class=w>        </span><span class=p>{</span>
<a id=__codelineno-247-525 name=__codelineno-247-525 href=#__codelineno-247-525></a><span class=w>            </span><span class=nt>&quot;block_available&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>10389</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-526 name=__codelineno-247-526 href=#__codelineno-247-526></a><span class=w>            </span><span class=nt>&quot;block_size&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>4096</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-527 name=__codelineno-247-527 href=#__codelineno-247-527></a><span class=w>            </span><span class=nt>&quot;block_total&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>50345</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-528 name=__codelineno-247-528 href=#__codelineno-247-528></a><span class=w>            </span><span class=nt>&quot;block_used&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>39956</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-529 name=__codelineno-247-529 href=#__codelineno-247-529></a><span class=w>            </span><span class=nt>&quot;device&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/dev/sda1&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-530 name=__codelineno-247-530 href=#__codelineno-247-530></a><span class=w>            </span><span class=nt>&quot;fstype&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;xfs&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-531 name=__codelineno-247-531 href=#__codelineno-247-531></a><span class=w>            </span><span class=nt>&quot;inode_available&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>83285</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-532 name=__codelineno-247-532 href=#__codelineno-247-532></a><span class=w>            </span><span class=nt>&quot;inode_total&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>83624</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-533 name=__codelineno-247-533 href=#__codelineno-247-533></a><span class=w>            </span><span class=nt>&quot;inode_used&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>339</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-534 name=__codelineno-247-534 href=#__codelineno-247-534></a><span class=w>            </span><span class=nt>&quot;mount&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/boot&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-535 name=__codelineno-247-535 href=#__codelineno-247-535></a><span class=w>            </span><span class=nt>&quot;options&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;rw,relatime,attr2,inode64,noquota&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-536 name=__codelineno-247-536 href=#__codelineno-247-536></a><span class=w>            </span><span class=nt>&quot;size_available&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>42553344</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-537 name=__codelineno-247-537 href=#__codelineno-247-537></a><span class=w>            </span><span class=nt>&quot;size_total&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>206213120</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-538 name=__codelineno-247-538 href=#__codelineno-247-538></a><span class=w>            </span><span class=nt>&quot;uuid&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;93556f71-6dad-4761-9207-edee35d47129&quot;</span>
<a id=__codelineno-247-539 name=__codelineno-247-539 href=#__codelineno-247-539></a><span class=w>        </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-540 name=__codelineno-247-540 href=#__codelineno-247-540></a><span class=w>        </span><span class=p>{</span>
<a id=__codelineno-247-541 name=__codelineno-247-541 href=#__codelineno-247-541></a><span class=w>            </span><span class=nt>&quot;block_available&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>7234718</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-542 name=__codelineno-247-542 href=#__codelineno-247-542></a><span class=w>            </span><span class=nt>&quot;block_size&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>4096</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-543 name=__codelineno-247-543 href=#__codelineno-247-543></a><span class=w>            </span><span class=nt>&quot;block_total&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>7809050</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-544 name=__codelineno-247-544 href=#__codelineno-247-544></a><span class=w>            </span><span class=nt>&quot;block_used&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>574332</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-545 name=__codelineno-247-545 href=#__codelineno-247-545></a><span class=w>            </span><span class=nt>&quot;device&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/dev/sda3&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-546 name=__codelineno-247-546 href=#__codelineno-247-546></a><span class=w>            </span><span class=nt>&quot;fstype&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;xfs&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-547 name=__codelineno-247-547 href=#__codelineno-247-547></a><span class=w>            </span><span class=nt>&quot;inode_available&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>15558107</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-548 name=__codelineno-247-548 href=#__codelineno-247-548></a><span class=w>            </span><span class=nt>&quot;inode_total&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>15625728</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-549 name=__codelineno-247-549 href=#__codelineno-247-549></a><span class=w>            </span><span class=nt>&quot;inode_used&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>67621</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-550 name=__codelineno-247-550 href=#__codelineno-247-550></a><span class=w>            </span><span class=nt>&quot;mount&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-551 name=__codelineno-247-551 href=#__codelineno-247-551></a><span class=w>            </span><span class=nt>&quot;options&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;rw,relatime,attr2,inode64,noquota&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-552 name=__codelineno-247-552 href=#__codelineno-247-552></a><span class=w>            </span><span class=nt>&quot;size_available&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>29633404928</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-553 name=__codelineno-247-553 href=#__codelineno-247-553></a><span class=w>            </span><span class=nt>&quot;size_total&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>31985868800</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-554 name=__codelineno-247-554 href=#__codelineno-247-554></a><span class=w>            </span><span class=nt>&quot;uuid&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;a7d49533-e756-4a71-a977-5efb174eb09c&quot;</span>
<a id=__codelineno-247-555 name=__codelineno-247-555 href=#__codelineno-247-555></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-247-556 name=__codelineno-247-556 href=#__codelineno-247-556></a><span class=w>    </span><span class=p>],</span><span class=w> </span>
<a id=__codelineno-247-557 name=__codelineno-247-557 href=#__codelineno-247-557></a><span class=w>    </span><span class=nt>&quot;ansible_nodename&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;node130&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-558 name=__codelineno-247-558 href=#__codelineno-247-558></a><span class=w>    </span><span class=nt>&quot;ansible_os_family&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;RedHat&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-559 name=__codelineno-247-559 href=#__codelineno-247-559></a><span class=w>    </span><span class=nt>&quot;ansible_pkg_mgr&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;yum&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-560 name=__codelineno-247-560 href=#__codelineno-247-560></a><span class=w>    </span><span class=nt>&quot;ansible_proc_cmdline&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-561 name=__codelineno-247-561 href=#__codelineno-247-561></a><span class=w>        </span><span class=nt>&quot;BOOT_IMAGE&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/vmlinuz-5.1.11-1.el7.elrepo.x86_64&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-562 name=__codelineno-247-562 href=#__codelineno-247-562></a><span class=w>        </span><span class=nt>&quot;crashkernel&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;auto&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-563 name=__codelineno-247-563 href=#__codelineno-247-563></a><span class=w>        </span><span class=nt>&quot;quiet&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-564 name=__codelineno-247-564 href=#__codelineno-247-564></a><span class=w>        </span><span class=nt>&quot;rhgb&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-565 name=__codelineno-247-565 href=#__codelineno-247-565></a><span class=w>        </span><span class=nt>&quot;ro&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-566 name=__codelineno-247-566 href=#__codelineno-247-566></a><span class=w>        </span><span class=nt>&quot;root&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;UUID=a7d49533-e756-4a71-a977-5efb174eb09c&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-567 name=__codelineno-247-567 href=#__codelineno-247-567></a><span class=w>        </span><span class=nt>&quot;user_namespace.enable&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;1&quot;</span>
<a id=__codelineno-247-568 name=__codelineno-247-568 href=#__codelineno-247-568></a><span class=w>    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-569 name=__codelineno-247-569 href=#__codelineno-247-569></a><span class=w>    </span><span class=nt>&quot;ansible_processor&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-570 name=__codelineno-247-570 href=#__codelineno-247-570></a><span class=w>        </span><span class=s2>&quot;0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-571 name=__codelineno-247-571 href=#__codelineno-247-571></a><span class=w>        </span><span class=s2>&quot;GenuineIntel&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-572 name=__codelineno-247-572 href=#__codelineno-247-572></a><span class=w>        </span><span class=s2>&quot;Intel(R) Core(TM) i3-4160 CPU @ 3.60GHz&quot;</span>
<a id=__codelineno-247-573 name=__codelineno-247-573 href=#__codelineno-247-573></a><span class=w>    </span><span class=p>],</span><span class=w> </span>
<a id=__codelineno-247-574 name=__codelineno-247-574 href=#__codelineno-247-574></a><span class=w>    </span><span class=nt>&quot;ansible_processor_cores&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-575 name=__codelineno-247-575 href=#__codelineno-247-575></a><span class=w>    </span><span class=nt>&quot;ansible_processor_count&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-576 name=__codelineno-247-576 href=#__codelineno-247-576></a><span class=w>    </span><span class=nt>&quot;ansible_processor_threads_per_core&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-577 name=__codelineno-247-577 href=#__codelineno-247-577></a><span class=w>    </span><span class=nt>&quot;ansible_processor_vcpus&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-578 name=__codelineno-247-578 href=#__codelineno-247-578></a><span class=w>    </span><span class=nt>&quot;ansible_product_name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;VMware Virtual Platform&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-579 name=__codelineno-247-579 href=#__codelineno-247-579></a><span class=w>    </span><span class=nt>&quot;ansible_product_serial&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;VMware-56 4d 4b f0 c3 97 be 18-aa c9 56 08 cb 88 01 c0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-580 name=__codelineno-247-580 href=#__codelineno-247-580></a><span class=w>    </span><span class=nt>&quot;ansible_product_uuid&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;f04b4d56-97c3-18be-aac9-5608cb8801c0&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-581 name=__codelineno-247-581 href=#__codelineno-247-581></a><span class=w>    </span><span class=nt>&quot;ansible_product_version&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;None&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-582 name=__codelineno-247-582 href=#__codelineno-247-582></a><span class=w>    </span><span class=nt>&quot;ansible_python&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-583 name=__codelineno-247-583 href=#__codelineno-247-583></a><span class=w>        </span><span class=nt>&quot;executable&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/usr/bin/python&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-584 name=__codelineno-247-584 href=#__codelineno-247-584></a><span class=w>        </span><span class=nt>&quot;has_sslcontext&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-585 name=__codelineno-247-585 href=#__codelineno-247-585></a><span class=w>        </span><span class=nt>&quot;type&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;CPython&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-586 name=__codelineno-247-586 href=#__codelineno-247-586></a><span class=w>        </span><span class=nt>&quot;version&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-587 name=__codelineno-247-587 href=#__codelineno-247-587></a><span class=w>            </span><span class=nt>&quot;major&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-588 name=__codelineno-247-588 href=#__codelineno-247-588></a><span class=w>            </span><span class=nt>&quot;micro&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>5</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-589 name=__codelineno-247-589 href=#__codelineno-247-589></a><span class=w>            </span><span class=nt>&quot;minor&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>7</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-590 name=__codelineno-247-590 href=#__codelineno-247-590></a><span class=w>            </span><span class=nt>&quot;releaselevel&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;final&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-591 name=__codelineno-247-591 href=#__codelineno-247-591></a><span class=w>            </span><span class=nt>&quot;serial&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span>
<a id=__codelineno-247-592 name=__codelineno-247-592 href=#__codelineno-247-592></a><span class=w>        </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-593 name=__codelineno-247-593 href=#__codelineno-247-593></a><span class=w>        </span><span class=nt>&quot;version_info&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-594 name=__codelineno-247-594 href=#__codelineno-247-594></a><span class=w>            </span><span class=mi>2</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-595 name=__codelineno-247-595 href=#__codelineno-247-595></a><span class=w>            </span><span class=mi>7</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-596 name=__codelineno-247-596 href=#__codelineno-247-596></a><span class=w>            </span><span class=mi>5</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-597 name=__codelineno-247-597 href=#__codelineno-247-597></a><span class=w>            </span><span class=s2>&quot;final&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-598 name=__codelineno-247-598 href=#__codelineno-247-598></a><span class=w>            </span><span class=mi>0</span>
<a id=__codelineno-247-599 name=__codelineno-247-599 href=#__codelineno-247-599></a><span class=w>        </span><span class=p>]</span>
<a id=__codelineno-247-600 name=__codelineno-247-600 href=#__codelineno-247-600></a><span class=w>    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-601 name=__codelineno-247-601 href=#__codelineno-247-601></a><span class=w>    </span><span class=nt>&quot;ansible_python_version&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2.7.5&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-602 name=__codelineno-247-602 href=#__codelineno-247-602></a><span class=w>    </span><span class=nt>&quot;ansible_real_group_id&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-603 name=__codelineno-247-603 href=#__codelineno-247-603></a><span class=w>    </span><span class=nt>&quot;ansible_real_user_id&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-604 name=__codelineno-247-604 href=#__codelineno-247-604></a><span class=w>    </span><span class=nt>&quot;ansible_selinux&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-247-605 name=__codelineno-247-605 href=#__codelineno-247-605></a><span class=w>        </span><span class=nt>&quot;status&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;disabled&quot;</span>
<a id=__codelineno-247-606 name=__codelineno-247-606 href=#__codelineno-247-606></a><span class=w>    </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-247-607 name=__codelineno-247-607 href=#__codelineno-247-607></a><span class=w>    </span><span class=nt>&quot;ansible_selinux_python_present&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-608 name=__codelineno-247-608 href=#__codelineno-247-608></a><span class=w>    </span><span class=nt>&quot;ansible_service_mgr&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;systemd&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-609 name=__codelineno-247-609 href=#__codelineno-247-609></a><span class=w>    </span><span class=nt>&quot;ansible_ssh_host_key_ecdsa_public&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBK2zovckFKduH7EsvGaWar2mA+LdC4kTjgFG4h9RQlxZ1v5kEPx8Bs7jWnj94Cd8lY8BGb7RU7akUFpq3V59WIY=&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-610 name=__codelineno-247-610 href=#__codelineno-247-610></a><span class=w>    </span><span class=nt>&quot;ansible_ssh_host_key_ed25519_public&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;AAAAC3NzaC1lZDI1NTE5AAAAIEgM8JK59UtnryS0IhtNoPJHbOSqy7Xy2jExPYMvAex5&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-611 name=__codelineno-247-611 href=#__codelineno-247-611></a><span class=w>    </span><span class=nt>&quot;ansible_ssh_host_key_rsa_public&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;AAAAB3NzaC1yc2EAAAADAQABAAABAQDfNgNsUWXmYOD7Iz94nO98XRmw4dWKREbxWz6rZBP2QHYFN38nzdo9h5UT4HMuUM/FraPwwbfPubznNgn0/cXfMkqu8JIssxizpIRBZv82HFqwHTYRvkFAEII8ftkHs2RVlq64+ljPZzWvGL14nkfU7P+kc8Ym4jZGtorKRBoHFCeu67fycmZSCLFJxkKSumOaZ9TbNzP6bziyfmdDIGfj8UgzJRSuBW+B5XNeJp/QtsQZTjgpxSZZ9QRf/FeRx1NDR5Si91Fkd0NILIgoOSz536lP+aCCUOx7ukaoV1T/kyUKOj8a3wpBGiBWWZUGZa6O02Ig0eHnx8F4lZ2iOnNN&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-612 name=__codelineno-247-612 href=#__codelineno-247-612></a><span class=w>    </span><span class=nt>&quot;ansible_swapfree_mb&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>10239</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-613 name=__codelineno-247-613 href=#__codelineno-247-613></a><span class=w>    </span><span class=nt>&quot;ansible_swaptotal_mb&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>10239</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-614 name=__codelineno-247-614 href=#__codelineno-247-614></a><span class=w>    </span><span class=nt>&quot;ansible_system&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;Linux&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-615 name=__codelineno-247-615 href=#__codelineno-247-615></a><span class=w>    </span><span class=nt>&quot;ansible_system_capabilities&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-616 name=__codelineno-247-616 href=#__codelineno-247-616></a><span class=w>        </span><span class=s2>&quot;cap_chown&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-617 name=__codelineno-247-617 href=#__codelineno-247-617></a><span class=w>        </span><span class=s2>&quot;cap_dac_override&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-618 name=__codelineno-247-618 href=#__codelineno-247-618></a><span class=w>        </span><span class=s2>&quot;cap_dac_read_search&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-619 name=__codelineno-247-619 href=#__codelineno-247-619></a><span class=w>        </span><span class=s2>&quot;cap_fowner&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-620 name=__codelineno-247-620 href=#__codelineno-247-620></a><span class=w>        </span><span class=s2>&quot;cap_fsetid&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-621 name=__codelineno-247-621 href=#__codelineno-247-621></a><span class=w>        </span><span class=s2>&quot;cap_kill&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-622 name=__codelineno-247-622 href=#__codelineno-247-622></a><span class=w>        </span><span class=s2>&quot;cap_setgid&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-623 name=__codelineno-247-623 href=#__codelineno-247-623></a><span class=w>        </span><span class=s2>&quot;cap_setuid&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-624 name=__codelineno-247-624 href=#__codelineno-247-624></a><span class=w>        </span><span class=s2>&quot;cap_setpcap&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-625 name=__codelineno-247-625 href=#__codelineno-247-625></a><span class=w>        </span><span class=s2>&quot;cap_linux_immutable&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-626 name=__codelineno-247-626 href=#__codelineno-247-626></a><span class=w>        </span><span class=s2>&quot;cap_net_bind_service&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-627 name=__codelineno-247-627 href=#__codelineno-247-627></a><span class=w>        </span><span class=s2>&quot;cap_net_broadcast&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-628 name=__codelineno-247-628 href=#__codelineno-247-628></a><span class=w>        </span><span class=s2>&quot;cap_net_admin&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-629 name=__codelineno-247-629 href=#__codelineno-247-629></a><span class=w>        </span><span class=s2>&quot;cap_net_raw&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-630 name=__codelineno-247-630 href=#__codelineno-247-630></a><span class=w>        </span><span class=s2>&quot;cap_ipc_lock&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-631 name=__codelineno-247-631 href=#__codelineno-247-631></a><span class=w>        </span><span class=s2>&quot;cap_ipc_owner&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-632 name=__codelineno-247-632 href=#__codelineno-247-632></a><span class=w>        </span><span class=s2>&quot;cap_sys_module&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-633 name=__codelineno-247-633 href=#__codelineno-247-633></a><span class=w>        </span><span class=s2>&quot;cap_sys_rawio&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-634 name=__codelineno-247-634 href=#__codelineno-247-634></a><span class=w>        </span><span class=s2>&quot;cap_sys_chroot&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-635 name=__codelineno-247-635 href=#__codelineno-247-635></a><span class=w>        </span><span class=s2>&quot;cap_sys_ptrace&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-636 name=__codelineno-247-636 href=#__codelineno-247-636></a><span class=w>        </span><span class=s2>&quot;cap_sys_pacct&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-637 name=__codelineno-247-637 href=#__codelineno-247-637></a><span class=w>        </span><span class=s2>&quot;cap_sys_admin&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-638 name=__codelineno-247-638 href=#__codelineno-247-638></a><span class=w>        </span><span class=s2>&quot;cap_sys_boot&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-639 name=__codelineno-247-639 href=#__codelineno-247-639></a><span class=w>        </span><span class=s2>&quot;cap_sys_nice&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-640 name=__codelineno-247-640 href=#__codelineno-247-640></a><span class=w>        </span><span class=s2>&quot;cap_sys_resource&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-641 name=__codelineno-247-641 href=#__codelineno-247-641></a><span class=w>        </span><span class=s2>&quot;cap_sys_time&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-642 name=__codelineno-247-642 href=#__codelineno-247-642></a><span class=w>        </span><span class=s2>&quot;cap_sys_tty_config&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-643 name=__codelineno-247-643 href=#__codelineno-247-643></a><span class=w>        </span><span class=s2>&quot;cap_mknod&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-644 name=__codelineno-247-644 href=#__codelineno-247-644></a><span class=w>        </span><span class=s2>&quot;cap_lease&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-645 name=__codelineno-247-645 href=#__codelineno-247-645></a><span class=w>        </span><span class=s2>&quot;cap_audit_write&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-646 name=__codelineno-247-646 href=#__codelineno-247-646></a><span class=w>        </span><span class=s2>&quot;cap_audit_control&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-647 name=__codelineno-247-647 href=#__codelineno-247-647></a><span class=w>        </span><span class=s2>&quot;cap_setfcap&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-648 name=__codelineno-247-648 href=#__codelineno-247-648></a><span class=w>        </span><span class=s2>&quot;cap_mac_override&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-649 name=__codelineno-247-649 href=#__codelineno-247-649></a><span class=w>        </span><span class=s2>&quot;cap_mac_admin&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-650 name=__codelineno-247-650 href=#__codelineno-247-650></a><span class=w>        </span><span class=s2>&quot;cap_syslog&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-651 name=__codelineno-247-651 href=#__codelineno-247-651></a><span class=w>        </span><span class=s2>&quot;35&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-652 name=__codelineno-247-652 href=#__codelineno-247-652></a><span class=w>        </span><span class=s2>&quot;36&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-653 name=__codelineno-247-653 href=#__codelineno-247-653></a><span class=w>        </span><span class=s2>&quot;37+ep&quot;</span>
<a id=__codelineno-247-654 name=__codelineno-247-654 href=#__codelineno-247-654></a><span class=w>    </span><span class=p>],</span><span class=w> </span>
<a id=__codelineno-247-655 name=__codelineno-247-655 href=#__codelineno-247-655></a><span class=w>    </span><span class=nt>&quot;ansible_system_capabilities_enforced&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;True&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-656 name=__codelineno-247-656 href=#__codelineno-247-656></a><span class=w>    </span><span class=nt>&quot;ansible_system_vendor&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;VMware, Inc.&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-657 name=__codelineno-247-657 href=#__codelineno-247-657></a><span class=w>    </span><span class=nt>&quot;ansible_uptime_seconds&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>4004</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-658 name=__codelineno-247-658 href=#__codelineno-247-658></a><span class=w>    </span><span class=nt>&quot;ansible_user_dir&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/root&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-659 name=__codelineno-247-659 href=#__codelineno-247-659></a><span class=w>    </span><span class=nt>&quot;ansible_user_gecos&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;root&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-660 name=__codelineno-247-660 href=#__codelineno-247-660></a><span class=w>    </span><span class=nt>&quot;ansible_user_gid&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-661 name=__codelineno-247-661 href=#__codelineno-247-661></a><span class=w>    </span><span class=nt>&quot;ansible_user_id&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;root&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-662 name=__codelineno-247-662 href=#__codelineno-247-662></a><span class=w>    </span><span class=nt>&quot;ansible_user_shell&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/bin/bash&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-663 name=__codelineno-247-663 href=#__codelineno-247-663></a><span class=w>    </span><span class=nt>&quot;ansible_user_uid&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-664 name=__codelineno-247-664 href=#__codelineno-247-664></a><span class=w>    </span><span class=nt>&quot;ansible_userspace_architecture&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;x86_64&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-665 name=__codelineno-247-665 href=#__codelineno-247-665></a><span class=w>    </span><span class=nt>&quot;ansible_userspace_bits&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;64&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-666 name=__codelineno-247-666 href=#__codelineno-247-666></a><span class=w>    </span><span class=nt>&quot;ansible_virtualization_role&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;guest&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-667 name=__codelineno-247-667 href=#__codelineno-247-667></a><span class=w>    </span><span class=nt>&quot;ansible_virtualization_type&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;VMware&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-247-668 name=__codelineno-247-668 href=#__codelineno-247-668></a><span class=w>    </span><span class=nt>&quot;gather_subset&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-247-669 name=__codelineno-247-669 href=#__codelineno-247-669></a><span class=w>        </span><span class=s2>&quot;all&quot;</span>
<a id=__codelineno-247-670 name=__codelineno-247-670 href=#__codelineno-247-670></a><span class=w>    </span><span class=p>],</span><span class=w> </span>
<a id=__codelineno-247-671 name=__codelineno-247-671 href=#__codelineno-247-671></a><span class=w>    </span><span class=nt>&quot;module_setup&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span>
<a id=__codelineno-247-672 name=__codelineno-247-672 href=#__codelineno-247-672></a><span class=p>}</span>
</code></pre></div> <p>其中较为常用的变量</p> <ul> <li> <p>ansible_distribution </p> </li> <li> <p>ansible_distribution_release</p> </li> <li> <p>ansible_distribution_version </p> </li> <li> <p>ansible_fqdn</p> </li> <li> <p>ansible_hostname</p> </li> <li> <p>ansible_os_family</p> </li> <li> <p>ansible_pkg_mgr</p> </li> <li> <p>ansible_default_ipv4.address</p> </li> <li> <p>ansible_default_ipv6.address</p> </li> </ul> <h3 id=缓存facts信息>缓存Facts信息<a class=headerlink href=#缓存facts信息 title="Permanent link">&para;</a></h3> <p>Facts信息默认存储在内存中，即每次运行后，信息就不会存在了，这样会导致我们每次都需要重新去获取主机的所有Facts信息，浪费了很多时间，Facts给了几种缓存方式。</p> <h4 id=使用文件作为缓存>使用文件作为缓存<a class=headerlink href=#使用文件作为缓存 title="Permanent link">&para;</a></h4> <p>创建缓存存放的目录</p> <div class=highlight><pre><span></span><code><a id=__codelineno-248-1 name=__codelineno-248-1 href=#__codelineno-248-1></a>mkdir<span class=w> </span>/tmp/facts_cache
</code></pre></div> <p>修改ansible配置文件</p> <div class=highlight><pre><span></span><code><a id=__codelineno-249-1 name=__codelineno-249-1 href=#__codelineno-249-1></a><span class=c1># /etc/ansible/ansible.cfg</span>
<a id=__codelineno-249-2 name=__codelineno-249-2 href=#__codelineno-249-2></a>
<a id=__codelineno-249-3 name=__codelineno-249-3 href=#__codelineno-249-3></a><span class=na>gathering</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>smart</span>
<a id=__codelineno-249-4 name=__codelineno-249-4 href=#__codelineno-249-4></a><span class=na>fact_caching</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>jsonfile</span>
<a id=__codelineno-249-5 name=__codelineno-249-5 href=#__codelineno-249-5></a><span class=na>fact_caching_timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>86400</span>
<a id=__codelineno-249-6 name=__codelineno-249-6 href=#__codelineno-249-6></a><span class=na>fact_caching_connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>/tmp/facts_cache</span>
</code></pre></div> <p>获取主机的Facts信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-250-1 name=__codelineno-250-1 href=#__codelineno-250-1></a>ansible<span class=w> </span><span class=m>192</span>.168.77.130<span class=w> </span>-m<span class=w> </span>setup
</code></pre></div> <p>查看缓存目录</p> <div class=highlight><pre><span></span><code><a id=__codelineno-251-1 name=__codelineno-251-1 href=#__codelineno-251-1></a>ll<span class=w> </span>/tmp/facts_cache/
<a id=__codelineno-251-2 name=__codelineno-251-2 href=#__codelineno-251-2></a>总用量<span class=w> </span><span class=m>28</span>
<a id=__codelineno-251-3 name=__codelineno-251-3 href=#__codelineno-251-3></a>-rw-r--r--<span class=w> </span><span class=m>1</span><span class=w> </span>root<span class=w> </span>root<span class=w> </span><span class=m>25241</span><span class=w> </span>3月<span class=w>  </span><span class=m>31</span><span class=w> </span><span class=m>11</span>:39<span class=w> </span><span class=m>192</span>.168.77.130
</code></pre></div> <blockquote> <p>上述文件中存储着json序列化的facts数据</p> </blockquote> <h4 id=使用redis作为缓存>使用redis作为缓存<a class=headerlink href=#使用redis作为缓存 title="Permanent link">&para;</a></h4> <p>安装redis</p> <div class=highlight><pre><span></span><code><a id=__codelineno-252-1 name=__codelineno-252-1 href=#__codelineno-252-1></a><span class=c1># centos 7</span>
<a id=__codelineno-252-2 name=__codelineno-252-2 href=#__codelineno-252-2></a>yum<span class=w> </span>-y<span class=w> </span>install<span class=w> </span>redis
<a id=__codelineno-252-3 name=__codelineno-252-3 href=#__codelineno-252-3></a>easy_install<span class=w> </span>pip
<a id=__codelineno-252-4 name=__codelineno-252-4 href=#__codelineno-252-4></a>pip<span class=w> </span>install<span class=w> </span>redis
</code></pre></div> <p>配置redis，使用密码登陆</p> <div class=highlight><pre><span></span><code><a id=__codelineno-253-1 name=__codelineno-253-1 href=#__codelineno-253-1></a><span class=nb>echo</span><span class=w> </span><span class=s1>&#39;requirepass &quot;admin&quot;&#39;</span><span class=w> </span>&gt;<span class=w> </span>/etc/redis.conf
</code></pre></div> <p>启动redis</p> <div class=highlight><pre><span></span><code><a id=__codelineno-254-1 name=__codelineno-254-1 href=#__codelineno-254-1></a>systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>--now<span class=w> </span>redis
</code></pre></div> <p>修改ansible配置文件</p> <div class=highlight><pre><span></span><code><a id=__codelineno-255-1 name=__codelineno-255-1 href=#__codelineno-255-1></a><span class=c1># /etc/ansible/ansible.cfg</span>
<a id=__codelineno-255-2 name=__codelineno-255-2 href=#__codelineno-255-2></a>
<a id=__codelineno-255-3 name=__codelineno-255-3 href=#__codelineno-255-3></a><span class=na>gathering</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>smart</span>
<a id=__codelineno-255-4 name=__codelineno-255-4 href=#__codelineno-255-4></a><span class=na>fact_caching</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>redis</span>
<a id=__codelineno-255-5 name=__codelineno-255-5 href=#__codelineno-255-5></a><span class=na>fact_caching_timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>86400</span>
<a id=__codelineno-255-6 name=__codelineno-255-6 href=#__codelineno-255-6></a><span class=na>fact_caching_connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>localhost:6379:0:admin</span>
</code></pre></div> <p>获取主机的Facts信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-256-1 name=__codelineno-256-1 href=#__codelineno-256-1></a>ansible<span class=w> </span><span class=m>192</span>.168.77.130<span class=w> </span>-m<span class=w> </span>setup
</code></pre></div> <p>查看redis内容</p> <div class=highlight><pre><span></span><code><a id=__codelineno-257-1 name=__codelineno-257-1 href=#__codelineno-257-1></a><span class=c1># redis-cli</span>
<a id=__codelineno-257-2 name=__codelineno-257-2 href=#__codelineno-257-2></a><span class=m>127</span>.0.0.1:6379&gt;<span class=w> </span>auth<span class=w> </span>admin
<a id=__codelineno-257-3 name=__codelineno-257-3 href=#__codelineno-257-3></a>OK
<a id=__codelineno-257-4 name=__codelineno-257-4 href=#__codelineno-257-4></a><span class=m>127</span>.0.0.1:6379&gt;<span class=w> </span>keys<span class=w> </span>*
<a id=__codelineno-257-5 name=__codelineno-257-5 href=#__codelineno-257-5></a><span class=m>1</span><span class=o>)</span><span class=w> </span><span class=s2>&quot;ansible_cache_keys&quot;</span>
<a id=__codelineno-257-6 name=__codelineno-257-6 href=#__codelineno-257-6></a><span class=m>2</span><span class=o>)</span><span class=w> </span><span class=s2>&quot;ansible_facts192.168.77.130&quot;</span>
<a id=__codelineno-257-7 name=__codelineno-257-7 href=#__codelineno-257-7></a><span class=m>127</span>.0.0.1:6379&gt;<span class=w> </span>get<span class=w> </span>ansible_facts192.168.77.130
<a id=__codelineno-257-8 name=__codelineno-257-8 href=#__codelineno-257-8></a>.....
</code></pre></div> <h4 id=使用memcached作为缓存>使用memcached作为缓存<a class=headerlink href=#使用memcached作为缓存 title="Permanent link">&para;</a></h4> <p>安装 memcached</p> <div class=highlight><pre><span></span><code><a id=__codelineno-258-1 name=__codelineno-258-1 href=#__codelineno-258-1></a><span class=c1># centos 7</span>
<a id=__codelineno-258-2 name=__codelineno-258-2 href=#__codelineno-258-2></a>yum<span class=w> </span>install<span class=w> </span>memcached
<a id=__codelineno-258-3 name=__codelineno-258-3 href=#__codelineno-258-3></a>
<a id=__codelineno-258-4 name=__codelineno-258-4 href=#__codelineno-258-4></a>easy_install<span class=w> </span>pip
<a id=__codelineno-258-5 name=__codelineno-258-5 href=#__codelineno-258-5></a>pip<span class=w> </span>install<span class=w> </span>python-memcached
</code></pre></div> <p>启动memcached</p> <div class=highlight><pre><span></span><code><a id=__codelineno-259-1 name=__codelineno-259-1 href=#__codelineno-259-1></a>systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>--now<span class=w> </span>memcached
</code></pre></div> <p>修改ansible配置文件</p> <div class=highlight><pre><span></span><code><a id=__codelineno-260-1 name=__codelineno-260-1 href=#__codelineno-260-1></a><span class=c1># /etc/ansible/ansible.cfg</span>
<a id=__codelineno-260-2 name=__codelineno-260-2 href=#__codelineno-260-2></a>
<a id=__codelineno-260-3 name=__codelineno-260-3 href=#__codelineno-260-3></a><span class=na>gathering</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>smart</span>
<a id=__codelineno-260-4 name=__codelineno-260-4 href=#__codelineno-260-4></a><span class=na>fact_caching</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>memcached</span>
<a id=__codelineno-260-5 name=__codelineno-260-5 href=#__codelineno-260-5></a><span class=na>fact_caching_timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>86400</span>
<a id=__codelineno-260-6 name=__codelineno-260-6 href=#__codelineno-260-6></a><span class=na>fact_caching_connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>localhost:11211</span>
</code></pre></div> <p>获取主机的Facts信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-261-1 name=__codelineno-261-1 href=#__codelineno-261-1></a>ansible<span class=w> </span><span class=m>192</span>.168.77.130<span class=w> </span>-m<span class=w> </span>setup
</code></pre></div> <p>查看memcached内容</p> <div class=highlight><pre><span></span><code><a id=__codelineno-262-1 name=__codelineno-262-1 href=#__codelineno-262-1></a><span class=c1># telnet 127.0.0.1 11211</span>
<a id=__codelineno-262-2 name=__codelineno-262-2 href=#__codelineno-262-2></a>Trying<span class=w> </span><span class=m>127</span>.0.0.1...
<a id=__codelineno-262-3 name=__codelineno-262-3 href=#__codelineno-262-3></a>Connected<span class=w> </span>to<span class=w> </span><span class=m>127</span>.0.0.1.
<a id=__codelineno-262-4 name=__codelineno-262-4 href=#__codelineno-262-4></a>Escape<span class=w> </span>character<span class=w> </span>is<span class=w> </span><span class=s1>&#39;^]&#39;</span>.
<a id=__codelineno-262-5 name=__codelineno-262-5 href=#__codelineno-262-5></a>stats<span class=w> </span>items
<a id=__codelineno-262-6 name=__codelineno-262-6 href=#__codelineno-262-6></a>STAT<span class=w> </span>items:3:number<span class=w> </span><span class=m>1</span>
<a id=__codelineno-262-7 name=__codelineno-262-7 href=#__codelineno-262-7></a>STAT<span class=w> </span>items:3:age<span class=w> </span><span class=m>135</span>
<a id=__codelineno-262-8 name=__codelineno-262-8 href=#__codelineno-262-8></a>STAT<span class=w> </span>items:3:evicted<span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-9 name=__codelineno-262-9 href=#__codelineno-262-9></a>STAT<span class=w> </span>items:3:evicted_nonzero<span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-10 name=__codelineno-262-10 href=#__codelineno-262-10></a>STAT<span class=w> </span>items:3:evicted_time<span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-11 name=__codelineno-262-11 href=#__codelineno-262-11></a>STAT<span class=w> </span>items:3:outofmemory<span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-12 name=__codelineno-262-12 href=#__codelineno-262-12></a>STAT<span class=w> </span>items:3:tailrepairs<span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-13 name=__codelineno-262-13 href=#__codelineno-262-13></a>STAT<span class=w> </span>items:3:reclaimed<span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-14 name=__codelineno-262-14 href=#__codelineno-262-14></a>STAT<span class=w> </span>items:3:expired_unfetched<span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-15 name=__codelineno-262-15 href=#__codelineno-262-15></a>STAT<span class=w> </span>items:3:evicted_unfetched<span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-16 name=__codelineno-262-16 href=#__codelineno-262-16></a>STAT<span class=w> </span>items:21:number<span class=w> </span><span class=m>1</span>
<a id=__codelineno-262-17 name=__codelineno-262-17 href=#__codelineno-262-17></a>STAT<span class=w> </span>items:21:age<span class=w> </span><span class=m>135</span>
<a id=__codelineno-262-18 name=__codelineno-262-18 href=#__codelineno-262-18></a>STAT<span class=w> </span>items:21:evicted<span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-19 name=__codelineno-262-19 href=#__codelineno-262-19></a>STAT<span class=w> </span>items:21:evicted_nonzero<span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-20 name=__codelineno-262-20 href=#__codelineno-262-20></a>STAT<span class=w> </span>items:21:evicted_time<span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-21 name=__codelineno-262-21 href=#__codelineno-262-21></a>STAT<span class=w> </span>items:21:outofmemory<span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-22 name=__codelineno-262-22 href=#__codelineno-262-22></a>STAT<span class=w> </span>items:21:tailrepairs<span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-23 name=__codelineno-262-23 href=#__codelineno-262-23></a>STAT<span class=w> </span>items:21:reclaimed<span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-24 name=__codelineno-262-24 href=#__codelineno-262-24></a>STAT<span class=w> </span>items:21:expired_unfetched<span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-25 name=__codelineno-262-25 href=#__codelineno-262-25></a>STAT<span class=w> </span>items:21:evicted_unfetched<span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-26 name=__codelineno-262-26 href=#__codelineno-262-26></a>END
<a id=__codelineno-262-27 name=__codelineno-262-27 href=#__codelineno-262-27></a>stats<span class=w> </span>cachedump<span class=w> </span><span class=m>3</span><span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-28 name=__codelineno-262-28 href=#__codelineno-262-28></a>ITEM<span class=w> </span>ansible_cache_keys<span class=w> </span><span class=o>[</span><span class=m>46</span><span class=w> </span>b<span class=p>;</span><span class=w> </span><span class=m>1585626688</span><span class=w> </span>s<span class=o>]</span>
<a id=__codelineno-262-29 name=__codelineno-262-29 href=#__codelineno-262-29></a>END
<a id=__codelineno-262-30 name=__codelineno-262-30 href=#__codelineno-262-30></a>stats<span class=w> </span>cachedump<span class=w> </span><span class=m>21</span><span class=w> </span><span class=m>0</span>
<a id=__codelineno-262-31 name=__codelineno-262-31 href=#__codelineno-262-31></a>ITEM<span class=w> </span>ansible_facts192.168.77.130<span class=w> </span><span class=o>[</span><span class=m>8349</span><span class=w> </span>b<span class=p>;</span><span class=w> </span><span class=m>1585713251</span><span class=w> </span>s<span class=o>]</span>
<a id=__codelineno-262-32 name=__codelineno-262-32 href=#__codelineno-262-32></a>END
</code></pre></div> <h4 id=刷新缓存>刷新缓存<a class=headerlink href=#刷新缓存 title="Permanent link">&para;</a></h4> <p>默认情况下，缓存的生存时间是<code>fact_caching_timeout</code>控制的，如果我们想强制刷新缓存的话，可以使用<code>--flush-cache</code>选项</p> <div class=highlight><pre><span></span><code><a id=__codelineno-263-1 name=__codelineno-263-1 href=#__codelineno-263-1></a>ansible-playbook<span class=w> </span>--flush-cache<span class=w> </span>/etc/ansible/test3.yaml
</code></pre></div> <h2 id=12jinja2-模板语法>12.Jinja2 模板语法<a class=headerlink href=#12jinja2-模板语法 title="Permanent link">&para;</a></h2> <p>Ansible使用 <a href=https://jinja.palletsprojects.com/ >Jinja2</a> 模板来启用动态表达式和对变量的访问。</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Jinja2 是一个 Python 的功能齐全的模板引擎。它有完整的 unicode 支持，一个可选 的集成沙箱执行环境，被广泛使用，以 BSD 许可证授权。</p> </div> <h3 id=jinja2-模版中的一些语法>jinja2 模版中的一些语法<a class=headerlink href=#jinja2-模版中的一些语法 title="Permanent link">&para;</a></h3> <blockquote> <p>关于 Jinja2 完整的中文说明 请移步：<a href=http://docs.jinkan.org/docs/jinja2/ >http://docs.jinkan.org/docs/jinja2/</a></p> </blockquote> <h4 id=变量>变量<a class=headerlink href=#变量 title="Permanent link">&para;</a></h4> <p>可以使用点<code>.</code>来访问变量的属性，作为替代，也可以使用下标语法<code>[]</code>, 下面2种方式效果是一样的</p> <div class=highlight><pre><span></span><code><a id=__codelineno-264-1 name=__codelineno-264-1 href=#__codelineno-264-1></a>{{ foo.bar }}
<a id=__codelineno-264-2 name=__codelineno-264-2 href=#__codelineno-264-2></a>
<a id=__codelineno-264-3 name=__codelineno-264-3 href=#__codelineno-264-3></a>{{ foo[&#39;bar&#39;] }}
</code></pre></div> <p>如果变量或属性不存在，会返回一个未定义值。</p> <h4 id=注释>注释<a class=headerlink href=#注释 title="Permanent link">&para;</a></h4> <p>要把模板中一行的部分注释掉，默认使用 <code>{# ... #}</code>注释语法。</p> <h4 id=转义>转义<a class=headerlink href=#转义 title="Permanent link">&para;</a></h4> <p>简单的使用单引号进行转义</p> <p>对于较大的段落，使用raw进行转义 <div class=highlight><pre><span></span><code><a id=__codelineno-265-1 name=__codelineno-265-1 href=#__codelineno-265-1></a>{% raw %}
<a id=__codelineno-265-2 name=__codelineno-265-2 href=#__codelineno-265-2></a>     &lt;ul&gt;
<a id=__codelineno-265-3 name=__codelineno-265-3 href=#__codelineno-265-3></a>     {% for item in seq %}
<a id=__codelineno-265-4 name=__codelineno-265-4 href=#__codelineno-265-4></a>         &lt;li&gt;{{ item }}&lt;/li&gt;
<a id=__codelineno-265-5 name=__codelineno-265-5 href=#__codelineno-265-5></a>     {% endfor %}
<a id=__codelineno-265-6 name=__codelineno-265-6 href=#__codelineno-265-6></a>     &lt;/ul&gt;
<a id=__codelineno-265-7 name=__codelineno-265-7 href=#__codelineno-265-7></a> {% endraw %}
</code></pre></div></p> <p>包含 &gt; 、 &lt; 、 &amp; 或 " 字符的变量，必须要手动转义, 使用<code>e</code> 顾虑器可以转义这些。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-266-1 name=__codelineno-266-1 href=#__codelineno-266-1></a>{{ user.username | e }} 
</code></pre></div> <h4 id=空白控制>空白控制<a class=headerlink href=#空白控制 title="Permanent link">&para;</a></h4> <p>在开始或结束放置一个减号（ <code>-</code> ），可以移除块前或块后的空白。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-267-1 name=__codelineno-267-1 href=#__codelineno-267-1></a>{% for item in seq -%}
<a id=__codelineno-267-2 name=__codelineno-267-2 href=#__codelineno-267-2></a>    {{ item }}
<a id=__codelineno-267-3 name=__codelineno-267-3 href=#__codelineno-267-3></a>{%- endfor %}
<a id=__codelineno-267-4 name=__codelineno-267-4 href=#__codelineno-267-4></a>
<a id=__codelineno-267-5 name=__codelineno-267-5 href=#__codelineno-267-5></a>{%- if foo -%}...{% endif %}
</code></pre></div> <h4 id=控制结构>控制结构<a class=headerlink href=#控制结构 title="Permanent link">&para;</a></h4> <p>控制结构指的是所有的那些可以控制程序流的东西 —— 条件（比如 if/elif/ekse ）、 for 循环、以及宏和块之类的东西。控制结构在默认语法中以 {% .. %} 块的形式 出现。</p> <h5 id=for>For<a class=headerlink href=#for title="Permanent link">&para;</a></h5> <p>遍历序列 <div class=highlight><pre><span></span><code><a id=__codelineno-268-1 name=__codelineno-268-1 href=#__codelineno-268-1></a>{% for user in users %}
<a id=__codelineno-268-2 name=__codelineno-268-2 href=#__codelineno-268-2></a>  &lt;li&gt;{{ user.username|e }}&lt;/li&gt;
<a id=__codelineno-268-3 name=__codelineno-268-3 href=#__codelineno-268-3></a>{% endfor %}
</code></pre></div></p> <p>迭代字典 <div class=highlight><pre><span></span><code><a id=__codelineno-269-1 name=__codelineno-269-1 href=#__codelineno-269-1></a>{% for key, value in my_dict.iteritems() %}
<a id=__codelineno-269-2 name=__codelineno-269-2 href=#__codelineno-269-2></a>    &lt;dt&gt;{{ key|e }}&lt;/dt&gt;
<a id=__codelineno-269-3 name=__codelineno-269-3 href=#__codelineno-269-3></a>    &lt;dd&gt;{{ value|e }}&lt;/dd&gt;
<a id=__codelineno-269-4 name=__codelineno-269-4 href=#__codelineno-269-4></a>{% endfor %}
</code></pre></div></p> <p>循环 10 次迭代之后会终止处理 <div class=highlight><pre><span></span><code><a id=__codelineno-270-1 name=__codelineno-270-1 href=#__codelineno-270-1></a>{% for user in users %}
<a id=__codelineno-270-2 name=__codelineno-270-2 href=#__codelineno-270-2></a>
<a id=__codelineno-270-3 name=__codelineno-270-3 href=#__codelineno-270-3></a>    {%- if loop.index &gt;= 10 %}{% break %}{% endif %}
<a id=__codelineno-270-4 name=__codelineno-270-4 href=#__codelineno-270-4></a>
<a id=__codelineno-270-5 name=__codelineno-270-5 href=#__codelineno-270-5></a>{%- endfor %}
</code></pre></div></p> <p>条件过滤 <div class=highlight><pre><span></span><code><a id=__codelineno-271-1 name=__codelineno-271-1 href=#__codelineno-271-1></a>{% for dir in data_dirs if dir != &quot;/&quot; %}
<a id=__codelineno-271-2 name=__codelineno-271-2 href=#__codelineno-271-2></a>data_dir = {{ dir }}
<a id=__codelineno-271-3 name=__codelineno-271-3 href=#__codelineno-271-3></a>{% else %}
<a id=__codelineno-271-4 name=__codelineno-271-4 href=#__codelineno-271-4></a># no data dirs found
<a id=__codelineno-271-5 name=__codelineno-271-5 href=#__codelineno-271-5></a>{% endfor %}
</code></pre></div></p> <p>在一个 for 循环块中你可以访问这些特殊的变量:</p> <table> <thead> <tr> <th align=left>变量</th> <th align=left>描述</th> </tr> </thead> <tbody> <tr> <td align=left>loop.index</td> <td align=left>当前循环迭代的次数（从 1 开始）</td> </tr> <tr> <td align=left>loop.index0</td> <td align=left>当前循环迭代的次数（从 0 开始）</td> </tr> <tr> <td align=left>loop.revindex</td> <td align=left>到循环结束需要迭代的次数（从 1 开始）</td> </tr> <tr> <td align=left>loop.revindex0</td> <td align=left>到循环结束需要迭代的次数（从 0 开始）</td> </tr> <tr> <td align=left>loop.first</td> <td align=left>如果是第一次迭代，为 True 。</td> </tr> <tr> <td align=left>loop.last</td> <td align=left>如果是最后一次迭代，为 True 。</td> </tr> <tr> <td align=left>loop.length</td> <td align=left>序列中的项目数。</td> </tr> <tr> <td align=left>loop.cycle</td> <td align=left>在一串序列间期取值的辅助函数</td> </tr> <tr> <td align=left>loop.depth</td> <td align=left>指示当前渲染在递归循环中的深度。 从1开始</td> </tr> <tr> <td align=left>loop.depth0</td> <td align=left>指示当前渲染在递归循环中的深度。 从0开始</td> </tr> <tr> <td align=left>loop.previtem</td> <td align=left>循环的上一个迭代中的项目。 在第一次迭代中未定义。</td> </tr> <tr> <td align=left>loop.nextitem</td> <td align=left>循环的以下迭代中的项目。 在上一次迭代期间未定义。</td> </tr> <tr> <td align=left>loop.changed(*val)</td> <td align=left>如果以前使用其他值调用（或根本未调用），则为true。</td> </tr> </tbody> </table> <h5 id=if-语句>if 语句<a class=headerlink href=#if-语句 title="Permanent link">&para;</a></h5> <p>Jinja 中的 if 语句可比 Python 中的 if 语句。 <div class=highlight><pre><span></span><code><a id=__codelineno-272-1 name=__codelineno-272-1 href=#__codelineno-272-1></a>{% if kenny.sick %}
<a id=__codelineno-272-2 name=__codelineno-272-2 href=#__codelineno-272-2></a>     Kenny is sick.
<a id=__codelineno-272-3 name=__codelineno-272-3 href=#__codelineno-272-3></a> {% elif kenny.dead %}
<a id=__codelineno-272-4 name=__codelineno-272-4 href=#__codelineno-272-4></a>     You killed Kenny!  You bastard!!!
<a id=__codelineno-272-5 name=__codelineno-272-5 href=#__codelineno-272-5></a> {% else %}
<a id=__codelineno-272-6 name=__codelineno-272-6 href=#__codelineno-272-6></a>     Kenny looks okay --- so far
<a id=__codelineno-272-7 name=__codelineno-272-7 href=#__codelineno-272-7></a> {% endif %}
</code></pre></div></p> <h5 id=过滤器>过滤器<a class=headerlink href=#过滤器 title="Permanent link">&para;</a></h5> <p>变量可以通过 过滤器 修改。过滤器与变量用管道符号（ <code>|</code> ）分割，并且也 可以用圆括号传递可选参数。多个过滤器可以链式调用，前一个过滤器的输出会被作为 后一个过滤器的输入。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-273-1 name=__codelineno-273-1 href=#__codelineno-273-1></a>{{ name | striptags | title }} 
</code></pre></div> <p>过滤器段允许你在一块模板数据上应用常规 Jinja2 过滤器。只需要把代码用 filter 节包裹起来:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-274-1 name=__codelineno-274-1 href=#__codelineno-274-1></a>{% filter upper %}
<a id=__codelineno-274-2 name=__codelineno-274-2 href=#__codelineno-274-2></a>    This text becomes uppercase
<a id=__codelineno-274-3 name=__codelineno-274-3 href=#__codelineno-274-3></a>{% endfilter %}
</code></pre></div> <h5 id=赋值>赋值<a class=headerlink href=#赋值 title="Permanent link">&para;</a></h5> <p>在代码块中，你也可以为变量赋值。在顶层的（块、宏、循环之外）赋值是可导出的，即 可以从别的模板中导入。</p> <p>赋值使用 set 标签，并且可以为多个变量赋值:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-275-1 name=__codelineno-275-1 href=#__codelineno-275-1></a>{% set navigation = [(&#39;index.html&#39;, &#39;Index&#39;), (&#39;about.html&#39;, &#39;About&#39;)] %}
<a id=__codelineno-275-2 name=__codelineno-275-2 href=#__codelineno-275-2></a>
<a id=__codelineno-275-3 name=__codelineno-275-3 href=#__codelineno-275-3></a>{% set key, value = call_something() %}
</code></pre></div> <h4 id=表达式>表达式<a class=headerlink href=#表达式 title="Permanent link">&para;</a></h4> <p><code>{% ... %}</code> 用于执行诸如 for 循环 或赋值的语句</p> <p><code>{{ ... }}</code> 把表达式的结果打印到模板上</p> <p><strong>if 表达式</strong></p> <p>一般的语法是<code>&lt;do something&gt; if &lt;something is true&gt; else &lt;do something else&gt;</code>。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-276-1 name=__codelineno-276-1 href=#__codelineno-276-1></a>{{ &#39;[%s]&#39; % page.title if page.title is defined else &#39;undefined&#39; }}
</code></pre></div> <h4 id=字面量>字面量<a class=headerlink href=#字面量 title="Permanent link">&para;</a></h4> <p>表达式最简单的形式就是字面量。字面量表示诸如字符串和数值的 Python 对象。下面 的字面量是可用的:</p> <table> <thead> <tr> <th>值</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>"Hello World"</td> <td>双引号或单引号中间的一切都是字符串。无论何时你需要在模板中使用一个字 符串（比如函数调用、过滤器或只是包含或继承一个模板的参数），它们都是 有用的。</td> </tr> <tr> <td>42/42.23</td> <td>直接写下数值就可以创建整数和浮点数。如果有小数点，则为浮点数，否则为 整数。记住在 Python 里， 42 和 42.0 是不一样的。</td> </tr> <tr> <td>['list','of','objects']</td> <td>一对中括号括起来的东西是一个列表。列表用于存储和迭代序列化的数据。</td> </tr> <tr> <td>('tuple','of','values')</td> <td>元组与列表类似，只是你不能修改元组。如果元组中只有一个项，你需要以逗号 结尾它。元组通常用于表示两个或更多元素的项。更多细节见上面的例子。</td> </tr> <tr> <td>{dict':'of','key':'and','value':'pairs'}</td> <td>Python 中的字典是一种关联键和值的结构。键必须是唯一的，并且键必须只有一个 值。字典在模板中很少使用，罕用于诸如 <a href=http://docs.jinkan.org/docs/jinja2/templates.html#xmlattr>xmlattr()</a> 过滤器之类。</td> </tr> <tr> <td>true/false</td> <td>true 永远是 true ，而 false 始终是 false 。</td> </tr> </tbody> </table> <div class="admonition note 提示"> <p class=admonition-title>Note</p> <p>特殊常量 true 、 false 和 none 实际上是小写的。因为这在过去会导致 混淆，过去 True扩展为一个被认为false 的未定义的变量。所有的这三个 常量也可以被写成首字母大写（ True 、 False 和 None ）。尽管如此， 为了一致性（所有的 Jinja 标识符是小写的），你应该使用小写的版本。</p> </div> <h4 id=算术>算术<a class=headerlink href=#算术 title="Permanent link">&para;</a></h4> <p>Jinja 允许你用计算值。这在模板中很少用到，但是为了完整性允许其存在。支持下面的 运算符:</p> <table> <thead> <tr> <th>运算符</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>+</td> <td>把两个对象加到一起。通常对象是素质，但是如果两者是字符串或列表，你可以用这 种方式来衔接它们。无论如何这不是首选的连接字符串的方式！连接字符串见 ~ 运算符。 {{ 1 + 1 }} 等于 2 。</td> </tr> <tr> <td>-</td> <td>用第一个数减去第二个数。 {{ 3 - 2 }} 等于 1 。</td> </tr> <tr> <td>/</td> <td>对两个数做除法。返回值会是一个浮点数。 {{ 1 / 2 }} 等于 {{ 0.5 }} 。</td> </tr> <tr> <td>//</td> <td>对两个数做除法，返回整数商。 {{ 20 // 7 }} 等于 2 。</td> </tr> <tr> <td>%</td> <td>计算整数除法的余数。 {{ 11 % 7 }} 等于 4 。</td> </tr> <tr> <td>*</td> <td>用右边的数乘左边的操作数。 {{ 2 * 2 }} 会返回 4 。也可以用于重 复一个字符串多次。 {{ ‘=’ * 80 }} 会打印 80 个等号的横条。</td> </tr> <tr> <td>**</td> <td>取左操作数的右操作数次幂。 {{ 2**3 }} 会返回 8 。</td> </tr> </tbody> </table> <p><strong>比较运算符</strong> </p> <table> <thead> <tr> <th>运算符</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>==</td> <td>比较两个对象是否相等。</td> </tr> <tr> <td>!=</td> <td>比较两个对象是否不等。</td> </tr> <tr> <td>&gt;</td> <td>如果左边大于右边，返回 true 。</td> </tr> <tr> <td>&gt;=</td> <td>如果左边大于等于右边，返回 true 。</td> </tr> <tr> <td>&lt;</td> <td>如果左边小于右边，返回 true 。</td> </tr> <tr> <td>&lt;=</td> <td>如果左边小于等于右边，返回 true 。</td> </tr> </tbody> </table> <p><strong>逻辑运算符</strong></p> <p>对于 if 语句，在 for 过滤或 if 表达式中，它可以用于联合多个表达式:</p> <table> <thead> <tr> <th>运算符</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>and</td> <td>如果左操作数和右操作数同为真，返回 true 。</td> </tr> <tr> <td>or</td> <td>如果左操作数和右操作数有一个为真，返回 true 。</td> </tr> <tr> <td>not</td> <td>对一个表达式取反（见下）。</td> </tr> <tr> <td>(expr)</td> <td>表达式组。</td> </tr> </tbody> </table> <div class="admonition note 提示"> <p class=admonition-title>Note</p> <p>is 和 in 运算符同样支持使用中缀记法: foo is not bar 和 foo not in bar 而不是 not foo is bar 和 not foo in bar 。所有的 其它表达式需要前缀记法 not (foo and bar) 。</p> </div> <p><strong>其它运算符</strong></p> <p>下面的运算符非常有用，但不适用于其它的两个分类:</p> <table> <thead> <tr> <th>运算符</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>in</td> <td>运行序列/映射包含检查。如果左操作数包含于右操作数，返回 true 。比如 {{ 1 in[1,2,3] }} 会返回 true 。</td> </tr> <tr> <td>is</td> <td>运行一个 <a href=http://docs.jinkan.org/docs/jinja2/templates.html#tests>测试</a> 。</td> </tr> <tr> <td>|</td> <td>应用一个 <a href=http://docs.jinkan.org/docs/jinja2/templates.html#filters>过滤器</a> 。</td> </tr> <tr> <td>~</td> <td>把所有的操作数转换为字符串，并且连接它们。 {{ "Hello " ~ name ~ "!" }} 会返回（假设 name 值为 ''John' ） Hello John! 。</td> </tr> <tr> <td>()</td> <td>调用一个可调用量:{{ post.render() }} 。在圆括号中，你可以像在 python 中一样使用位置参数和关键字参数: {{ post.render(user, full=true) }} 。</td> </tr> <tr> <td>. / []</td> <td>获取一个对象的属性。</td> </tr> </tbody> </table> <h4 id=python对象方法>Python对象方法<a class=headerlink href=#python对象方法 title="Permanent link">&para;</a></h4> <p>在模板中，也是可以使用python的对象方法</p> <p>字符串方法</p> <ul> <li>endswith: 用于判断字符串是否以指定后缀结尾，如果以指定后缀结尾返回True，否则返回False</li> <li>startswith: 用于检查字符串是否是以指定子字符串开头，如果是则返回 True，否则返回 False。</li> <li>split: 指定分隔符对字符串进行切片，默认为空格</li> <li>rsplit: 与split相同，但从字符串的末尾开始切片</li> <li>splitlines: 按照行('\r', '\r\n', \n')分隔，返回一个包含各行作为元素的列表</li> <li>upper: 返回全部大写的字符串</li> <li>lower: 返回全部小写的字符串</li> <li>capitalize: 将字符串的第一个字母变成大写,其他字母变小写</li> </ul> <p>列表方法</p> <ul> <li> <p>index 返回提供值的第一个索引位置</p> </li> <li> <p>count 统计某个元素在列表中出现的次数</p> </li> </ul> <p><strong>python 版本处理</strong></p> <p>在python2中，使用<code>dict.keys()</code>, <code>dict.values()</code>, <code>dict.items()</code> 返回字典的列表形式。但是在python3中，这些方法则返回字典形式</p> <div class=highlight><pre><span></span><code><a id=__codelineno-277-1 name=__codelineno-277-1 href=#__codelineno-277-1></a># Only works with Python 2
<a id=__codelineno-277-2 name=__codelineno-277-2 href=#__codelineno-277-2></a>{{ hosts.keys() }}
<a id=__codelineno-277-3 name=__codelineno-277-3 href=#__codelineno-277-3></a># Works with both Python 2 and Python 3
<a id=__codelineno-277-4 name=__codelineno-277-4 href=#__codelineno-277-4></a>{{ hosts.keys() | list }}
</code></pre></div> <p>在python2中，字典有<code>iterkeys()</code>, <code>itervalues()</code>, and <code>iteritems()</code>方法，但是在python3中这些方法被删除，python3则使用 <code>dict.keys()</code>, <code>dict.values()</code>, <code>dict.items()</code> </p> <div class=highlight><pre><span></span><code><a id=__codelineno-278-1 name=__codelineno-278-1 href=#__codelineno-278-1></a># Only works with Python 2
<a id=__codelineno-278-2 name=__codelineno-278-2 href=#__codelineno-278-2></a>{{ hosts.iteritems() }}
<a id=__codelineno-278-3 name=__codelineno-278-3 href=#__codelineno-278-3></a>
<a id=__codelineno-278-4 name=__codelineno-278-4 href=#__codelineno-278-4></a># Works with both Python 2 and Python 3
<a id=__codelineno-278-5 name=__codelineno-278-5 href=#__codelineno-278-5></a>{{ hosts.items() | list }}
</code></pre></div> <h3 id=在-ansible-中使用jinja2>在 ansible 中使用Jinja2<a class=headerlink href=#在-ansible-中使用jinja2 title="Permanent link">&para;</a></h3> <h4 id=获取当前时间>获取当前时间<a class=headerlink href=#获取当前时间 title="Permanent link">&para;</a></h4> <p>使用 <code>now()</code> jinja2 函数可以获取当前的时间</p> <div class=highlight><pre><span></span><code><a id=__codelineno-279-1 name=__codelineno-279-1 href=#__codelineno-279-1></a><span class="l l-Scalar l-Scalar-Plain">ansible localhost -m debug -a &quot;msg={{ now(utc=&#39;True&#39;,fmt=&#39;%H-%m-%d %T&#39;) }}&quot;</span>
</code></pre></div> <blockquote> <p>utc 参数可以开启utc时间， fmt参数为时间的格式化输出。</p> <p><code>{{ }}</code> 代表把表达式的结果打印到模板上</p> </blockquote> <h4 id=过滤器_1>过滤器<a class=headerlink href=#过滤器_1 title="Permanent link">&para;</a></h4> <p>Ansible中的过滤器来自<code>Jinja2</code>，用于在模板表达式中转换数据。</p> <p>过滤器与变量用管道符号 <code>|</code> 分割</p> <h5 id=格式化数据过滤器>格式化数据过滤器<a class=headerlink href=#格式化数据过滤器 title="Permanent link">&para;</a></h5> <p>更改数据格式，其结果是对应的字符串</p> <div class=highlight><pre><span></span><code><a id=__codelineno-280-1 name=__codelineno-280-1 href=#__codelineno-280-1></a>{{ some_variable | to_json }} 
<a id=__codelineno-280-2 name=__codelineno-280-2 href=#__codelineno-280-2></a>
<a id=__codelineno-280-3 name=__codelineno-280-3 href=#__codelineno-280-3></a>{{ some_variable | to_yaml }}
</code></pre></div> <p>对于人类可读得输出</p> <div class=highlight><pre><span></span><code><a id=__codelineno-281-1 name=__codelineno-281-1 href=#__codelineno-281-1></a>{{ some_variable | to_nice_json }} 
<a id=__codelineno-281-2 name=__codelineno-281-2 href=#__codelineno-281-2></a>
<a id=__codelineno-281-3 name=__codelineno-281-3 href=#__codelineno-281-3></a>{{ some_variable | to_nice_yaml }}
</code></pre></div> <p>还可以增加参数( new in 2.2)</p> <div class=highlight><pre><span></span><code><a id=__codelineno-282-1 name=__codelineno-282-1 href=#__codelineno-282-1></a>{{ some_variable | to_nice_json(indent=2) }}
<a id=__codelineno-282-2 name=__codelineno-282-2 href=#__codelineno-282-2></a>
<a id=__codelineno-282-3 name=__codelineno-282-3 href=#__codelineno-282-3></a>{{ some_variable | to_nice_yaml(indent=8) }}
<a id=__codelineno-282-4 name=__codelineno-282-4 href=#__codelineno-282-4></a>
<a id=__codelineno-282-5 name=__codelineno-282-5 href=#__codelineno-282-5></a>{{ some_variable | to_nice_yaml(indent=8, width=1337) }}
</code></pre></div> <blockquote> <p>indent 指定缩进字符数， width限制行数宽度</p> </blockquote> <p>从json字符串读取，其结果为json类型</p> <div class=highlight><pre><span></span><code><a id=__codelineno-283-1 name=__codelineno-283-1 href=#__codelineno-283-1></a>{{ some_variable | from_json }}
</code></pre></div> <p>从yaml字符串读取，其结果为yaml类型</p> <div class=highlight><pre><span></span><code><a id=__codelineno-284-1 name=__codelineno-284-1 href=#__codelineno-284-1></a>{{ some_variable | from_yaml }}
</code></pre></div> <p>示例：将json文件内容赋值给变量</p> <div class=highlight><pre><span></span><code><a id=__codelineno-285-1 name=__codelineno-285-1 href=#__codelineno-285-1></a>tasks:
<a id=__codelineno-285-2 name=__codelineno-285-2 href=#__codelineno-285-2></a>  - shell: cat /some/path/to/file.json
<a id=__codelineno-285-3 name=__codelineno-285-3 href=#__codelineno-285-3></a>    register: result
<a id=__codelineno-285-4 name=__codelineno-285-4 href=#__codelineno-285-4></a>
<a id=__codelineno-285-5 name=__codelineno-285-5 href=#__codelineno-285-5></a>  - set_fact:
<a id=__codelineno-285-6 name=__codelineno-285-6 href=#__codelineno-285-6></a>      myvar: &quot;{{ result.stdout | from_json }}&quot;
</code></pre></div> <p>使用`from_yaml_all 解析多段yaml字符串</p> <div class=highlight><pre><span></span><code><a id=__codelineno-286-1 name=__codelineno-286-1 href=#__codelineno-286-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-286-2 name=__codelineno-286-2 href=#__codelineno-286-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cat /some/path/to/multidoc-file.yaml</span>
<a id=__codelineno-286-3 name=__codelineno-286-3 href=#__codelineno-286-3></a><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">result</span>
<a id=__codelineno-286-4 name=__codelineno-286-4 href=#__codelineno-286-4></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-286-5 name=__codelineno-286-5 href=#__codelineno-286-5></a><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&#39;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&#39;</span>
<a id=__codelineno-286-6 name=__codelineno-286-6 href=#__codelineno-286-6></a><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&#39;{{</span><span class=nv> </span><span class=s>result.stdout</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>from_yaml_all</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>list</span><span class=nv> </span><span class=s>}}&#39;</span>
</code></pre></div> <h5 id=强制定义变量>强制定义变量<a class=headerlink href=#强制定义变量 title="Permanent link">&para;</a></h5> <p>如果变量未定义，则来自 <strong>ansible</strong> 和 <strong>ansible.cfg</strong> 的默认行为为失败，但您可以将其关闭。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-287-1 name=__codelineno-287-1 href=#__codelineno-287-1></a>{{ variable | mandatory }}
</code></pre></div> <h5 id=未定义的变量默认值>未定义的变量默认值<a class=headerlink href=#未定义的变量默认值 title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-288-1 name=__codelineno-288-1 href=#__codelineno-288-1></a>{{ result.cmd|default(5) }}
<a id=__codelineno-288-2 name=__codelineno-288-2 href=#__codelineno-288-2></a>
<a id=__codelineno-288-3 name=__codelineno-288-3 href=#__codelineno-288-3></a>{{ lookup(&#39;env&#39;, &#39;MY_USER&#39;) | default(&#39;admin&#39;, true) }}
<a id=__codelineno-288-4 name=__codelineno-288-4 href=#__codelineno-288-4></a>
<a id=__codelineno-288-5 name=__codelineno-288-5 href=#__codelineno-288-5></a>{{ lookup(&#39;env&#39;, &#39;MY_USER&#39;) | default(&#39;admin&#39;, false) }}
</code></pre></div> <p>如果变量未定义，则将默认值赋值给变量，如果希望变量值为空的时候也赋值，需将 <strong>default</strong> 第二个值为<code>true</code></p> <h5 id=省略参数>省略参数<a class=headerlink href=#省略参数 title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-289-1 name=__codelineno-289-1 href=#__codelineno-289-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">touch files with an optional mode</span>
<a id=__codelineno-289-2 name=__codelineno-289-2 href=#__codelineno-289-2></a><span class=w>  </span><span class=nt>file</span><span class=p>:</span>
<a id=__codelineno-289-3 name=__codelineno-289-3 href=#__codelineno-289-3></a><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.path</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-289-4 name=__codelineno-289-4 href=#__codelineno-289-4></a><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">touch</span>
<a id=__codelineno-289-5 name=__codelineno-289-5 href=#__codelineno-289-5></a><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.mode</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>default(omit)</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-289-6 name=__codelineno-289-6 href=#__codelineno-289-6></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span>
<a id=__codelineno-289-7 name=__codelineno-289-7 href=#__codelineno-289-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/foo</span>
<a id=__codelineno-289-8 name=__codelineno-289-8 href=#__codelineno-289-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/bar</span>
<a id=__codelineno-289-9 name=__codelineno-289-9 href=#__codelineno-289-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/baz</span>
<a id=__codelineno-289-10 name=__codelineno-289-10 href=#__codelineno-289-10></a><span class=w>      </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=s>&quot;0444&quot;</span>
</code></pre></div> <p>对于列表中的前两个文件，默认mode将由系统的umask确定，因为 <code>mode=parameter</code> 不会发送到文件模块，而最后得文件将接收<code>mode=0444</code>选项。</p> <h5 id=列表过滤>列表过滤<a class=headerlink href=#列表过滤 title="Permanent link">&para;</a></h5> <p>取最小的值 <div class=highlight><pre><span></span><code><a id=__codelineno-290-1 name=__codelineno-290-1 href=#__codelineno-290-1></a>{{ list1 | min }}
</code></pre></div></p> <p>取最大的值 <div class=highlight><pre><span></span><code><a id=__codelineno-291-1 name=__codelineno-291-1 href=#__codelineno-291-1></a>{{ [3, 4, 2] | max }}
</code></pre></div></p> <p>展平列表 <div class=highlight><pre><span></span><code><a id=__codelineno-292-1 name=__codelineno-292-1 href=#__codelineno-292-1></a>{{ [3, [4, 2] ] | flatten }}
<a id=__codelineno-292-2 name=__codelineno-292-2 href=#__codelineno-292-2></a>
<a id=__codelineno-292-3 name=__codelineno-292-3 href=#__codelineno-292-3></a>{{ [3, [4, [2]] ] | flatten(levels=1) }}  # 展平第一级
</code></pre></div></p> <h5 id=数据集过滤>数据集过滤<a class=headerlink href=#数据集过滤 title="Permanent link">&para;</a></h5> <p>对列表唯一过滤 <div class=highlight><pre><span></span><code><a id=__codelineno-293-1 name=__codelineno-293-1 href=#__codelineno-293-1></a>{{ list1 | unique }}
</code></pre></div></p> <p>对两个列表去重合并 <div class=highlight><pre><span></span><code><a id=__codelineno-294-1 name=__codelineno-294-1 href=#__codelineno-294-1></a>{{ list1 | union(list2) }}
</code></pre></div></p> <p>对两个列表做交集 <div class=highlight><pre><span></span><code><a id=__codelineno-295-1 name=__codelineno-295-1 href=#__codelineno-295-1></a>{{ list1 | intersect(list2) }}
</code></pre></div></p> <p>找到两个列表差异部分(在list1 不在list2 的差异) <div class=highlight><pre><span></span><code><a id=__codelineno-296-1 name=__codelineno-296-1 href=#__codelineno-296-1></a>{{ list1 | difference(list2) }}
</code></pre></div></p> <p>找到两个列表都互相不在对方列表的部分 <div class=highlight><pre><span></span><code><a id=__codelineno-297-1 name=__codelineno-297-1 href=#__codelineno-297-1></a>{{ list1 | symmetric_difference(list2) }}
</code></pre></div></p> <h5 id=字典过滤>字典过滤<a class=headerlink href=#字典过滤 title="Permanent link">&para;</a></h5> <p>将字典变为列表</p> <div class=highlight><pre><span></span><code><a id=__codelineno-298-1 name=__codelineno-298-1 href=#__codelineno-298-1></a>{{ dict | dict2items }}
</code></pre></div> <p>返回的列表</p> <div class=highlight><pre><span></span><code><a id=__codelineno-299-1 name=__codelineno-299-1 href=#__codelineno-299-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Application</span>
<a id=__codelineno-299-2 name=__codelineno-299-2 href=#__codelineno-299-2></a><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">payment</span>
<a id=__codelineno-299-3 name=__codelineno-299-3 href=#__codelineno-299-3></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Environment</span>
<a id=__codelineno-299-4 name=__codelineno-299-4 href=#__codelineno-299-4></a><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dev</span>
</code></pre></div> <p>可指定列表<code>key/vaule</code>的名字</p> <div class=highlight><pre><span></span><code><a id=__codelineno-300-1 name=__codelineno-300-1 href=#__codelineno-300-1></a>{{ files | dict2items(key_name=&#39;file&#39;, value_name=&#39;path&#39;) }}
</code></pre></div> <p>将列表转换为字典</p> <div class=highlight><pre><span></span><code><a id=__codelineno-301-1 name=__codelineno-301-1 href=#__codelineno-301-1></a>{{ tags | items2dict }}
</code></pre></div> <p>返回的字典</p> <div class=highlight><pre><span></span><code><a id=__codelineno-302-1 name=__codelineno-302-1 href=#__codelineno-302-1></a><span class=nt>Application</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">payment</span>
<a id=__codelineno-302-2 name=__codelineno-302-2 href=#__codelineno-302-2></a><span class=nt>Environment</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dev</span>
</code></pre></div> <p>可指定列表<code>key/vaule</code>的名字</p> <div class=highlight><pre><span></span><code><a id=__codelineno-303-1 name=__codelineno-303-1 href=#__codelineno-303-1></a>{{ tags | items2dict(key_name=&#39;key&#39;, value_name=&#39;value&#39;) }}
</code></pre></div> <h5 id=zip-过滤>zip 过滤<a class=headerlink href=#zip-过滤 title="Permanent link">&para;</a></h5> <p>使用 <code>zip</code> 来合并其他列表</p> <div class=highlight><pre><span></span><code><a id=__codelineno-304-1 name=__codelineno-304-1 href=#__codelineno-304-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">give me list combo of two lists</span>
<a id=__codelineno-304-2 name=__codelineno-304-2 href=#__codelineno-304-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-304-3 name=__codelineno-304-3 href=#__codelineno-304-3></a><span class=w>   </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>[1,2,3,4,5]</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>zip([&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;,&#39;e&#39;,&#39;f&#39;])</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>list</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-304-4 name=__codelineno-304-4 href=#__codelineno-304-4></a>
<a id=__codelineno-304-5 name=__codelineno-304-5 href=#__codelineno-304-5></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">give me shortest combo of two lists</span>
<a id=__codelineno-304-6 name=__codelineno-304-6 href=#__codelineno-304-6></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-304-7 name=__codelineno-304-7 href=#__codelineno-304-7></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>[1,2,3]</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>zip([&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;,&#39;e&#39;,&#39;f&#39;])</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>list</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <p>使用 <code>zip_longest</code> 以元素最多为合并对象</p> <div class=highlight><pre><span></span><code><a id=__codelineno-305-1 name=__codelineno-305-1 href=#__codelineno-305-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">give me longest combo of three lists , fill with X</span>
<a id=__codelineno-305-2 name=__codelineno-305-2 href=#__codelineno-305-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-305-3 name=__codelineno-305-3 href=#__codelineno-305-3></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>[1,2,3]</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>zip_longest([&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;,&#39;e&#39;,&#39;f&#39;],</span><span class=nv> </span><span class=s>[21,</span><span class=nv> </span><span class=s>22,</span><span class=nv> </span><span class=s>23],</span><span class=nv> </span><span class=s>fillvalue=&#39;X&#39;)</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>list</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <p>zip 也可以用于构造字典</p> <div class=highlight><pre><span></span><code><a id=__codelineno-306-1 name=__codelineno-306-1 href=#__codelineno-306-1></a>{{ dict(keys_list | zip(values_list)) }}
</code></pre></div> <p>变量</p> <div class=highlight><pre><span></span><code><a id=__codelineno-307-1 name=__codelineno-307-1 href=#__codelineno-307-1></a><span class=nt>keys_list</span><span class=p>:</span>
<a id=__codelineno-307-2 name=__codelineno-307-2 href=#__codelineno-307-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">one</span>
<a id=__codelineno-307-3 name=__codelineno-307-3 href=#__codelineno-307-3></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">two</span>
<a id=__codelineno-307-4 name=__codelineno-307-4 href=#__codelineno-307-4></a><span class=nt>values_list</span><span class=p>:</span>
<a id=__codelineno-307-5 name=__codelineno-307-5 href=#__codelineno-307-5></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apple</span>
<a id=__codelineno-307-6 name=__codelineno-307-6 href=#__codelineno-307-6></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">orange</span>
</code></pre></div> <p>转换后</p> <div class=highlight><pre><span></span><code><a id=__codelineno-308-1 name=__codelineno-308-1 href=#__codelineno-308-1></a><span class=nt>one</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apple</span>
<a id=__codelineno-308-2 name=__codelineno-308-2 href=#__codelineno-308-2></a><span class=nt>two</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">orange</span>
</code></pre></div> <h5 id=子元素过滤器>子元素过滤器<a class=headerlink href=#子元素过滤器 title="Permanent link">&para;</a></h5> <p>使用<code>subelements</code> 过滤对象的子元素</p> <div class=highlight><pre><span></span><code><a id=__codelineno-309-1 name=__codelineno-309-1 href=#__codelineno-309-1></a>{{ users | subelements(&#39;groups&#39;, skip_missing=True) }}
</code></pre></div> <p>变量</p> <div class=highlight><pre><span></span><code><a id=__codelineno-310-1 name=__codelineno-310-1 href=#__codelineno-310-1></a><span class=nt>users</span><span class=p>:</span>
<a id=__codelineno-310-2 name=__codelineno-310-2 href=#__codelineno-310-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">alice</span>
<a id=__codelineno-310-3 name=__codelineno-310-3 href=#__codelineno-310-3></a><span class=w>  </span><span class=nt>authorized</span><span class=p>:</span>
<a id=__codelineno-310-4 name=__codelineno-310-4 href=#__codelineno-310-4></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/alice/onekey.pub</span>
<a id=__codelineno-310-5 name=__codelineno-310-5 href=#__codelineno-310-5></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/alice/twokey.pub</span>
<a id=__codelineno-310-6 name=__codelineno-310-6 href=#__codelineno-310-6></a><span class=w>  </span><span class=nt>groups</span><span class=p>:</span>
<a id=__codelineno-310-7 name=__codelineno-310-7 href=#__codelineno-310-7></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">wheel</span>
<a id=__codelineno-310-8 name=__codelineno-310-8 href=#__codelineno-310-8></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker</span>
<a id=__codelineno-310-9 name=__codelineno-310-9 href=#__codelineno-310-9></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bob</span>
<a id=__codelineno-310-10 name=__codelineno-310-10 href=#__codelineno-310-10></a><span class=w>  </span><span class=nt>authorized</span><span class=p>:</span>
<a id=__codelineno-310-11 name=__codelineno-310-11 href=#__codelineno-310-11></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/bob/id_rsa.pub</span>
<a id=__codelineno-310-12 name=__codelineno-310-12 href=#__codelineno-310-12></a><span class=w>  </span><span class=nt>groups</span><span class=p>:</span>
<a id=__codelineno-310-13 name=__codelineno-310-13 href=#__codelineno-310-13></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker</span>
</code></pre></div> <p>转换后</p> <div class=highlight><pre><span></span><code><a id=__codelineno-311-1 name=__codelineno-311-1 href=#__codelineno-311-1></a><span class="p p-Indicator">-</span>
<a id=__codelineno-311-2 name=__codelineno-311-2 href=#__codelineno-311-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">alice</span>
<a id=__codelineno-311-3 name=__codelineno-311-3 href=#__codelineno-311-3></a><span class=w>    </span><span class=nt>groups</span><span class=p>:</span>
<a id=__codelineno-311-4 name=__codelineno-311-4 href=#__codelineno-311-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">wheel</span>
<a id=__codelineno-311-5 name=__codelineno-311-5 href=#__codelineno-311-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker</span>
<a id=__codelineno-311-6 name=__codelineno-311-6 href=#__codelineno-311-6></a><span class=w>    </span><span class=nt>authorized</span><span class=p>:</span>
<a id=__codelineno-311-7 name=__codelineno-311-7 href=#__codelineno-311-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/alice/onekey.pub</span>
<a id=__codelineno-311-8 name=__codelineno-311-8 href=#__codelineno-311-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/alice/twokey.pub</span>
<a id=__codelineno-311-9 name=__codelineno-311-9 href=#__codelineno-311-9></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">wheel</span>
<a id=__codelineno-311-10 name=__codelineno-311-10 href=#__codelineno-311-10></a><span class="p p-Indicator">-</span>
<a id=__codelineno-311-11 name=__codelineno-311-11 href=#__codelineno-311-11></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">alice</span>
<a id=__codelineno-311-12 name=__codelineno-311-12 href=#__codelineno-311-12></a><span class=w>    </span><span class=nt>groups</span><span class=p>:</span>
<a id=__codelineno-311-13 name=__codelineno-311-13 href=#__codelineno-311-13></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">wheel</span>
<a id=__codelineno-311-14 name=__codelineno-311-14 href=#__codelineno-311-14></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker</span>
<a id=__codelineno-311-15 name=__codelineno-311-15 href=#__codelineno-311-15></a><span class=w>    </span><span class=nt>authorized</span><span class=p>:</span>
<a id=__codelineno-311-16 name=__codelineno-311-16 href=#__codelineno-311-16></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/alice/onekey.pub</span>
<a id=__codelineno-311-17 name=__codelineno-311-17 href=#__codelineno-311-17></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/alice/twokey.pub</span>
<a id=__codelineno-311-18 name=__codelineno-311-18 href=#__codelineno-311-18></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker</span>
<a id=__codelineno-311-19 name=__codelineno-311-19 href=#__codelineno-311-19></a><span class="p p-Indicator">-</span>
<a id=__codelineno-311-20 name=__codelineno-311-20 href=#__codelineno-311-20></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bob</span>
<a id=__codelineno-311-21 name=__codelineno-311-21 href=#__codelineno-311-21></a><span class=w>    </span><span class=nt>authorized</span><span class=p>:</span>
<a id=__codelineno-311-22 name=__codelineno-311-22 href=#__codelineno-311-22></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/bob/id_rsa.pub</span>
<a id=__codelineno-311-23 name=__codelineno-311-23 href=#__codelineno-311-23></a><span class=w>    </span><span class=nt>groups</span><span class=p>:</span>
<a id=__codelineno-311-24 name=__codelineno-311-24 href=#__codelineno-311-24></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker</span>
<a id=__codelineno-311-25 name=__codelineno-311-25 href=#__codelineno-311-25></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker</span>
</code></pre></div> <p>一个在循环中使用的例子</p> <div class=highlight><pre><span></span><code><a id=__codelineno-312-1 name=__codelineno-312-1 href=#__codelineno-312-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Set authorized ssh key, extracting just that data from &#39;users&#39;</span>
<a id=__codelineno-312-2 name=__codelineno-312-2 href=#__codelineno-312-2></a><span class=w>  </span><span class=nt>authorized_key</span><span class=p>:</span>
<a id=__codelineno-312-3 name=__codelineno-312-3 href=#__codelineno-312-3></a><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.0.name</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-312-4 name=__codelineno-312-4 href=#__codelineno-312-4></a><span class=w>    </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>lookup(&#39;file&#39;,</span><span class=nv> </span><span class=s>item.1)</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-312-5 name=__codelineno-312-5 href=#__codelineno-312-5></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>users</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>subelements(&#39;authorized&#39;)</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <h5 id=随机mac地址过滤器>随机Mac地址过滤器<a class=headerlink href=#随机mac地址过滤器 title="Permanent link">&para;</a></h5> <p>从一个以<code>52:54:00</code>开头的字符串前缀中获取一个随机的MAC地址</p> <div class=highlight><pre><span></span><code><a id=__codelineno-313-1 name=__codelineno-313-1 href=#__codelineno-313-1></a>&quot;{{ &#39;52:54:00&#39; | random_mac }}&quot;
<a id=__codelineno-313-2 name=__codelineno-313-2 href=#__codelineno-313-2></a># =&gt; &#39;52:54:00:ef:1c:03&#39;
</code></pre></div> <p>使用因子，创建随机但幂等的MAC地址</p> <div class=highlight><pre><span></span><code><a id=__codelineno-314-1 name=__codelineno-314-1 href=#__codelineno-314-1></a>&quot;{{ &#39;52:54:00&#39; | random_mac(seed=inventory_hostname) }}&quot;
</code></pre></div> <h5 id=随机数过滤>随机数过滤<a class=headerlink href=#随机数过滤 title="Permanent link">&para;</a></h5> <p>从列表中随机获取元素 <div class=highlight><pre><span></span><code><a id=__codelineno-315-1 name=__codelineno-315-1 href=#__codelineno-315-1></a>{{ [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;,&#39;e&#39;,&#39;f&#39;]|random }}
</code></pre></div></p> <p>从0-59 的整数中随机获取一个数 <div class=highlight><pre><span></span><code><a id=__codelineno-316-1 name=__codelineno-316-1 href=#__codelineno-316-1></a>{{ 59 | random}}
</code></pre></div></p> <p>从0-100 中随机获取能被10 整除的数（可以理解为0 10 20 30 40 50 ...100 的随机数） <div class=highlight><pre><span></span><code><a id=__codelineno-317-1 name=__codelineno-317-1 href=#__codelineno-317-1></a>{{ 100 |random(step=10) }}
</code></pre></div></p> <p>从0-100 中随机获取1 开始步长为10 的数（可以理解为1 11 21 31 41...91 的随机数） <div class=highlight><pre><span></span><code><a id=__codelineno-318-1 name=__codelineno-318-1 href=#__codelineno-318-1></a>{{ 100 |random(1, 10) }}
<a id=__codelineno-318-2 name=__codelineno-318-2 href=#__codelineno-318-2></a>
<a id=__codelineno-318-3 name=__codelineno-318-3 href=#__codelineno-318-3></a>{{ 100 |random(start=1, step=10) }}
</code></pre></div></p> <p>使用因子创建随机数</p> <div class=highlight><pre><span></span><code><a id=__codelineno-319-1 name=__codelineno-319-1 href=#__codelineno-319-1></a>&quot;{{ 60 | random(seed=inventory_hostname) }} * * * * root /script/from/cron&quot;
</code></pre></div> <h5 id=随机列表过滤>随机列表过滤<a class=headerlink href=#随机列表过滤 title="Permanent link">&para;</a></h5> <p>给已存在的列表随机排序 <div class=highlight><pre><span></span><code><a id=__codelineno-320-1 name=__codelineno-320-1 href=#__codelineno-320-1></a>{{ [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;]|shuffle }} =&gt; [&#39;c&#39;,&#39;a&#39;,&#39;b&#39;]
<a id=__codelineno-320-2 name=__codelineno-320-2 href=#__codelineno-320-2></a>
<a id=__codelineno-320-3 name=__codelineno-320-3 href=#__codelineno-320-3></a>{{ [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;]|shuffle }} =&gt; [&#39;b&#39;,&#39;c&#39;,&#39;a&#39;]
</code></pre></div></p> <p>使用因子生成随机列表</p> <div class=highlight><pre><span></span><code><a id=__codelineno-321-1 name=__codelineno-321-1 href=#__codelineno-321-1></a>{{ [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;] | shuffle(seed=inventory_hostname) }}
<a id=__codelineno-321-2 name=__codelineno-321-2 href=#__codelineno-321-2></a># =&gt; [&#39;b&#39;,&#39;a&#39;,&#39;c&#39;]
</code></pre></div> <h5 id=数学>数学<a class=headerlink href=#数学 title="Permanent link">&para;</a></h5> <p>获取对数, 默认<code>e</code> <div class=highlight><pre><span></span><code><a id=__codelineno-322-1 name=__codelineno-322-1 href=#__codelineno-322-1></a>{{ myvar | log }}
<a id=__codelineno-322-2 name=__codelineno-322-2 href=#__codelineno-322-2></a>
<a id=__codelineno-322-3 name=__codelineno-322-3 href=#__codelineno-322-3></a>{{ myvar | log(10) }}
</code></pre></div></p> <p>获取n次幂 <div class=highlight><pre><span></span><code><a id=__codelineno-323-1 name=__codelineno-323-1 href=#__codelineno-323-1></a>{{ myvar | pow(2) }}
<a id=__codelineno-323-2 name=__codelineno-323-2 href=#__codelineno-323-2></a>
<a id=__codelineno-323-3 name=__codelineno-323-3 href=#__codelineno-323-3></a>{{ myvar | pow(5) }}
</code></pre></div></p> <p>获取平方根 <div class=highlight><pre><span></span><code><a id=__codelineno-324-1 name=__codelineno-324-1 href=#__codelineno-324-1></a>{{ myvar | root }}
<a id=__codelineno-324-2 name=__codelineno-324-2 href=#__codelineno-324-2></a>
<a id=__codelineno-324-3 name=__codelineno-324-3 href=#__codelineno-324-3></a>{{ myvar | root(5) }}
</code></pre></div></p> <h5 id=json查询过滤>JSON查询过滤<a class=headerlink href=#json查询过滤 title="Permanent link">&para;</a></h5> <blockquote> <p>该过滤器基于jmespath构建 更多的示例 <a href=http://jmespath.org/examples.html>jmespath examples</a>.</p> </blockquote> <p>json过滤器，可以对复杂的json数据体提取一部分数据。</p> <p>json结构体</p> <div class=highlight><pre><span></span><code><a id=__codelineno-325-1 name=__codelineno-325-1 href=#__codelineno-325-1></a><span class=p>{</span>
<a id=__codelineno-325-2 name=__codelineno-325-2 href=#__codelineno-325-2></a><span class=w>    </span><span class=nt>&quot;domain_definition&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-325-3 name=__codelineno-325-3 href=#__codelineno-325-3></a><span class=w>        </span><span class=nt>&quot;domain&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-325-4 name=__codelineno-325-4 href=#__codelineno-325-4></a><span class=w>            </span><span class=nt>&quot;cluster&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-325-5 name=__codelineno-325-5 href=#__codelineno-325-5></a><span class=w>                </span><span class=p>{</span>
<a id=__codelineno-325-6 name=__codelineno-325-6 href=#__codelineno-325-6></a><span class=w>                    </span><span class=nt>&quot;name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;cluster1&quot;</span>
<a id=__codelineno-325-7 name=__codelineno-325-7 href=#__codelineno-325-7></a><span class=w>                </span><span class=p>},</span>
<a id=__codelineno-325-8 name=__codelineno-325-8 href=#__codelineno-325-8></a><span class=w>                </span><span class=p>{</span>
<a id=__codelineno-325-9 name=__codelineno-325-9 href=#__codelineno-325-9></a><span class=w>                    </span><span class=nt>&quot;name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;cluster2&quot;</span>
<a id=__codelineno-325-10 name=__codelineno-325-10 href=#__codelineno-325-10></a><span class=w>                </span><span class=p>}</span>
<a id=__codelineno-325-11 name=__codelineno-325-11 href=#__codelineno-325-11></a><span class=w>            </span><span class=p>],</span>
<a id=__codelineno-325-12 name=__codelineno-325-12 href=#__codelineno-325-12></a><span class=w>            </span><span class=nt>&quot;server&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-325-13 name=__codelineno-325-13 href=#__codelineno-325-13></a><span class=w>                </span><span class=p>{</span>
<a id=__codelineno-325-14 name=__codelineno-325-14 href=#__codelineno-325-14></a><span class=w>                    </span><span class=nt>&quot;name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;server11&quot;</span><span class=p>,</span>
<a id=__codelineno-325-15 name=__codelineno-325-15 href=#__codelineno-325-15></a><span class=w>                    </span><span class=nt>&quot;cluster&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;cluster1&quot;</span><span class=p>,</span>
<a id=__codelineno-325-16 name=__codelineno-325-16 href=#__codelineno-325-16></a><span class=w>                    </span><span class=nt>&quot;port&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;8080&quot;</span>
<a id=__codelineno-325-17 name=__codelineno-325-17 href=#__codelineno-325-17></a><span class=w>                </span><span class=p>},</span>
<a id=__codelineno-325-18 name=__codelineno-325-18 href=#__codelineno-325-18></a><span class=w>                </span><span class=p>{</span>
<a id=__codelineno-325-19 name=__codelineno-325-19 href=#__codelineno-325-19></a><span class=w>                    </span><span class=nt>&quot;name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;server12&quot;</span><span class=p>,</span>
<a id=__codelineno-325-20 name=__codelineno-325-20 href=#__codelineno-325-20></a><span class=w>                    </span><span class=nt>&quot;cluster&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;cluster1&quot;</span><span class=p>,</span>
<a id=__codelineno-325-21 name=__codelineno-325-21 href=#__codelineno-325-21></a><span class=w>                    </span><span class=nt>&quot;port&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;8090&quot;</span>
<a id=__codelineno-325-22 name=__codelineno-325-22 href=#__codelineno-325-22></a><span class=w>                </span><span class=p>}</span>
<a id=__codelineno-325-23 name=__codelineno-325-23 href=#__codelineno-325-23></a><span class=w>            </span><span class=p>],</span>
<a id=__codelineno-325-24 name=__codelineno-325-24 href=#__codelineno-325-24></a><span class=w>            </span><span class=nt>&quot;library&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-325-25 name=__codelineno-325-25 href=#__codelineno-325-25></a><span class=w>                </span><span class=p>{</span>
<a id=__codelineno-325-26 name=__codelineno-325-26 href=#__codelineno-325-26></a><span class=w>                    </span><span class=nt>&quot;name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;lib1&quot;</span><span class=p>,</span>
<a id=__codelineno-325-27 name=__codelineno-325-27 href=#__codelineno-325-27></a><span class=w>                    </span><span class=nt>&quot;target&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;cluster1&quot;</span>
<a id=__codelineno-325-28 name=__codelineno-325-28 href=#__codelineno-325-28></a><span class=w>                </span><span class=p>},</span>
<a id=__codelineno-325-29 name=__codelineno-325-29 href=#__codelineno-325-29></a><span class=w>                </span><span class=p>{</span>
<a id=__codelineno-325-30 name=__codelineno-325-30 href=#__codelineno-325-30></a><span class=w>                    </span><span class=nt>&quot;name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;lib2&quot;</span><span class=p>,</span>
<a id=__codelineno-325-31 name=__codelineno-325-31 href=#__codelineno-325-31></a><span class=w>                    </span><span class=nt>&quot;target&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;cluster2&quot;</span>
<a id=__codelineno-325-32 name=__codelineno-325-32 href=#__codelineno-325-32></a><span class=w>                </span><span class=p>}</span>
<a id=__codelineno-325-33 name=__codelineno-325-33 href=#__codelineno-325-33></a><span class=w>            </span><span class=p>]</span>
<a id=__codelineno-325-34 name=__codelineno-325-34 href=#__codelineno-325-34></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-325-35 name=__codelineno-325-35 href=#__codelineno-325-35></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-325-36 name=__codelineno-325-36 href=#__codelineno-325-36></a><span class=p>}</span>
</code></pre></div> <p>要从这个结构中提取所有<code>cluster</code>，可以使用以下查询</p> <div class=highlight><pre><span></span><code><a id=__codelineno-326-1 name=__codelineno-326-1 href=#__codelineno-326-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Display</span><span class=nv> </span><span class=s>all</span><span class=nv> </span><span class=s>cluster</span><span class=nv> </span><span class=s>names&quot;</span>
<a id=__codelineno-326-2 name=__codelineno-326-2 href=#__codelineno-326-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-326-3 name=__codelineno-326-3 href=#__codelineno-326-3></a><span class=w>    </span><span class=nt>var</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">item</span>
<a id=__codelineno-326-4 name=__codelineno-326-4 href=#__codelineno-326-4></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>domain_definition</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>json_query(&#39;domain.cluster[*].name&#39;)</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <p>提取所有<code>server</code> 的 <code>name</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-327-1 name=__codelineno-327-1 href=#__codelineno-327-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Display</span><span class=nv> </span><span class=s>all</span><span class=nv> </span><span class=s>server</span><span class=nv> </span><span class=s>names&quot;</span>
<a id=__codelineno-327-2 name=__codelineno-327-2 href=#__codelineno-327-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-327-3 name=__codelineno-327-3 href=#__codelineno-327-3></a><span class=w>    </span><span class=nt>var</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">item</span>
<a id=__codelineno-327-4 name=__codelineno-327-4 href=#__codelineno-327-4></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>domain_definition</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>json_query(&#39;domain.server[*].name&#39;)</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <p>提取 <code>cluster1</code> 的 <code>port</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-328-1 name=__codelineno-328-1 href=#__codelineno-328-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Display</span><span class=nv> </span><span class=s>all</span><span class=nv> </span><span class=s>ports</span><span class=nv> </span><span class=s>from</span><span class=nv> </span><span class=s>cluster1&quot;</span>
<a id=__codelineno-328-2 name=__codelineno-328-2 href=#__codelineno-328-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-328-3 name=__codelineno-328-3 href=#__codelineno-328-3></a><span class=w>    </span><span class=nt>var</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">item</span>
<a id=__codelineno-328-4 name=__codelineno-328-4 href=#__codelineno-328-4></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>domain_definition</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>json_query(server_name_cluster1_query)</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-328-5 name=__codelineno-328-5 href=#__codelineno-328-5></a><span class=w>  </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-328-6 name=__codelineno-328-6 href=#__codelineno-328-6></a><span class=w>    </span><span class=nt>server_name_cluster1_query</span><span class=p>:</span><span class=w> </span><span class=s>&quot;domain.server[?cluster==&#39;cluster1&#39;].port&quot;</span>
</code></pre></div> <p>使用字符串来连接端口</p> <div class=highlight><pre><span></span><code><a id=__codelineno-329-1 name=__codelineno-329-1 href=#__codelineno-329-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Display</span><span class=nv> </span><span class=s>all</span><span class=nv> </span><span class=s>ports</span><span class=nv> </span><span class=s>from</span><span class=nv> </span><span class=s>cluster1</span><span class=nv> </span><span class=s>as</span><span class=nv> </span><span class=s>a</span><span class=nv> </span><span class=s>string&quot;</span>
<a id=__codelineno-329-2 name=__codelineno-329-2 href=#__codelineno-329-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-329-3 name=__codelineno-329-3 href=#__codelineno-329-3></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>domain_definition</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>json_query(&#39;domain.server[?cluster==`cluster1`].port&#39;)</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>join(&#39;,</span><span class=nv> </span><span class=s>&#39;)</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <blockquote> <p>这里使用反引号来避免转义</p> </blockquote> <p>可以使用单引号转义</p> <div class=highlight><pre><span></span><code><a id=__codelineno-330-1 name=__codelineno-330-1 href=#__codelineno-330-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Display</span><span class=nv> </span><span class=s>all</span><span class=nv> </span><span class=s>ports</span><span class=nv> </span><span class=s>from</span><span class=nv> </span><span class=s>cluster1&quot;</span>
<a id=__codelineno-330-2 name=__codelineno-330-2 href=#__codelineno-330-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-330-3 name=__codelineno-330-3 href=#__codelineno-330-3></a><span class=w>    </span><span class=nt>var</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">item</span>
<a id=__codelineno-330-4 name=__codelineno-330-4 href=#__codelineno-330-4></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>domain_definition</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>json_query(&#39;domain.server[?cluster==&#39;&#39;cluster1&#39;&#39;].port&#39;)</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <h5 id=ip地址过滤>ip地址过滤<a class=headerlink href=#ip地址过滤 title="Permanent link">&para;</a></h5> <p>测试字符串是有效的ip地址不</p> <div class=highlight><pre><span></span><code><a id=__codelineno-331-1 name=__codelineno-331-1 href=#__codelineno-331-1></a>{{ myvar | ipaddr }}
</code></pre></div> <p>字符串转ip协议地址</p> <div class=highlight><pre><span></span><code><a id=__codelineno-332-1 name=__codelineno-332-1 href=#__codelineno-332-1></a>{{ myvar | ipv4 }}
<a id=__codelineno-332-2 name=__codelineno-332-2 href=#__codelineno-332-2></a>
<a id=__codelineno-332-3 name=__codelineno-332-3 href=#__codelineno-332-3></a>{{ myvar | ipv6 }}
</code></pre></div> <p>从cidr中获取地址信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-333-1 name=__codelineno-333-1 href=#__codelineno-333-1></a>{{ &#39;192.0.2.1/24&#39; | ipaddr(&#39;address&#39;) }}
</code></pre></div> <h5 id=network-cli-过滤器>Network CLI 过滤器<a class=headerlink href=#network-cli-过滤器 title="Permanent link">&para;</a></h5> <p>使用<code>parse_cli</code>过滤器将网络设备CLI命令的输出转换为JSON输出</p> <div class=highlight><pre><span></span><code><a id=__codelineno-334-1 name=__codelineno-334-1 href=#__codelineno-334-1></a>{{ output | parse_cli(&#39;path/to/spec&#39;) }}
</code></pre></div> <p>还支持使用TextFSM库解析CLI命令的输出</p> <div class=highlight><pre><span></span><code><a id=__codelineno-335-1 name=__codelineno-335-1 href=#__codelineno-335-1></a>{{ output | parse_cli_textfsm(&#39;path/to/fsm&#39;) }}
</code></pre></div> <h5 id=network-xml-过滤器>Network XML 过滤器<a class=headerlink href=#network-xml-过滤器 title="Permanent link">&para;</a></h5> <p>使用<code>parse_xml</code>过滤器将网络设备CLI命令的输出转换为XML输出</p> <div class=highlight><pre><span></span><code><a id=__codelineno-336-1 name=__codelineno-336-1 href=#__codelineno-336-1></a>{{ output | parse_xml(&#39;path/to/spec&#39;) }}
</code></pre></div> <h5 id=network-vlan-过滤器>Network VLAN 过滤器<a class=headerlink href=#network-vlan-过滤器 title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-337-1 name=__codelineno-337-1 href=#__codelineno-337-1></a>{{ [3003, 3004, 3005, 100, 1688, 3002, 3999] | vlan_parser }}
</code></pre></div> <p>输出</p> <div class=highlight><pre><span></span><code><a id=__codelineno-338-1 name=__codelineno-338-1 href=#__codelineno-338-1></a>[&#39;100,1688,3002-3005,3999&#39;]
</code></pre></div> <p>另一个jinja2模板例子</p> <div class=highlight><pre><span></span><code><a id=__codelineno-339-1 name=__codelineno-339-1 href=#__codelineno-339-1></a>{% set parsed_vlans = vlans | vlan_parser %}
<a id=__codelineno-339-2 name=__codelineno-339-2 href=#__codelineno-339-2></a>switchport trunk allowed vlan {{ parsed_vlans[0] }}
<a id=__codelineno-339-3 name=__codelineno-339-3 href=#__codelineno-339-3></a>{% for i in range (1, parsed_vlans | count) %}
<a id=__codelineno-339-4 name=__codelineno-339-4 href=#__codelineno-339-4></a>switchport trunk allowed vlan add {{ parsed_vlans[i] }}
</code></pre></div> <h5 id=哈希过滤器>哈希过滤器<a class=headerlink href=#哈希过滤器 title="Permanent link">&para;</a></h5> <p>获取字符串得hash值 <div class=highlight><pre><span></span><code><a id=__codelineno-340-1 name=__codelineno-340-1 href=#__codelineno-340-1></a>{{ &#39;test1&#39;|hash(&#39;sha1&#39;) }}
<a id=__codelineno-340-2 name=__codelineno-340-2 href=#__codelineno-340-2></a>
<a id=__codelineno-340-3 name=__codelineno-340-3 href=#__codelineno-340-3></a>{{ &#39;test1&#39;|hash(&#39;md5&#39;) }}
</code></pre></div></p> <p>获取字符串校验和 <div class=highlight><pre><span></span><code><a id=__codelineno-341-1 name=__codelineno-341-1 href=#__codelineno-341-1></a>{{ &#39;test2&#39;|checksum }}
</code></pre></div></p> <p>获取sha512密码哈希 <div class=highlight><pre><span></span><code><a id=__codelineno-342-1 name=__codelineno-342-1 href=#__codelineno-342-1></a>{{ &#39;passwordsaresecret&#39;|password_hash(&#39;sha512&#39;) }}
<a id=__codelineno-342-2 name=__codelineno-342-2 href=#__codelineno-342-2></a>
<a id=__codelineno-342-3 name=__codelineno-342-3 href=#__codelineno-342-3></a>{{ &#39;secretpassword&#39;|password_hash(&#39;sha256&#39;, &#39;mysecretsalt&#39;) }}
</code></pre></div></p> <h5 id=合并散列>合并散列<a class=headerlink href=#合并散列 title="Permanent link">&para;</a></h5> <p><div class=highlight><pre><span></span><code><a id=__codelineno-343-1 name=__codelineno-343-1 href=#__codelineno-343-1></a>{{ {&#39;a&#39;:1, &#39;b&#39;:2}|combine({&#39;b&#39;:3}) }}
</code></pre></div> 结果 <div class=highlight><pre><span></span><code><a id=__codelineno-344-1 name=__codelineno-344-1 href=#__codelineno-344-1></a>{&#39;a&#39;:1, &#39;b&#39;:3}
</code></pre></div></p> <p>支持递归合并 <div class=highlight><pre><span></span><code><a id=__codelineno-345-1 name=__codelineno-345-1 href=#__codelineno-345-1></a>{{ {&#39;a&#39;:{&#39;foo&#39;:1, &#39;bar&#39;:2}, &#39;b&#39;:2}|combine({&#39;a&#39;:{&#39;bar&#39;:3, &#39;baz&#39;:4}}, recursive=True) }}
</code></pre></div></p> <p>结果 <div class=highlight><pre><span></span><code><a id=__codelineno-346-1 name=__codelineno-346-1 href=#__codelineno-346-1></a>{&#39;a&#39;:{&#39;foo&#39;:1, &#39;bar&#39;:3, &#39;baz&#39;:4}, &#39;b&#39;:2}
</code></pre></div></p> <h5 id=提取过滤器>提取过滤器<a class=headerlink href=#提取过滤器 title="Permanent link">&para;</a></h5> <p>使用 <code>map</code> <code>extract</code>筛选器将索引列表映射到容器中的值作为列表返回</p> <div class=highlight><pre><span></span><code><a id=__codelineno-347-1 name=__codelineno-347-1 href=#__codelineno-347-1></a>{{ [0,2]|map(&#39;extract&#39;, [&#39;x&#39;,&#39;y&#39;,&#39;z&#39;] )| list }}
<a id=__codelineno-347-2 name=__codelineno-347-2 href=#__codelineno-347-2></a>
<a id=__codelineno-347-3 name=__codelineno-347-3 href=#__codelineno-347-3></a># [&#39;x&#39;, &#39;z&#39;]
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-348-1 name=__codelineno-348-1 href=#__codelineno-348-1></a>{{ [&#39;x&#39;,&#39;y&#39;]|map(&#39;extract&#39;, {&#39;x&#39;: 42, &#39;y&#39;: 31})|list }}
<a id=__codelineno-348-2 name=__codelineno-348-2 href=#__codelineno-348-2></a>
<a id=__codelineno-348-3 name=__codelineno-348-3 href=#__codelineno-348-3></a># [42, 31]
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-349-1 name=__codelineno-349-1 href=#__codelineno-349-1></a>{{ groups[&#39;x&#39;]|map(&#39;extract&#39;, hostvars, &#39;ec2_ip_address&#39;)|list }}
</code></pre></div> <p>这需要组'x'中的主机列表，在主机中查找主机，然后查找结果的ec2_ip_address。 最后的结果是组'x'中的主机的IP地址列表。 <div class=highlight><pre><span></span><code><a id=__codelineno-350-1 name=__codelineno-350-1 href=#__codelineno-350-1></a>{{ groups[&#39;test&#39;] | map(&#39;extract&#39;, hostvars, &#39;ansible_default_ipv4.address&#39;)|list }}
</code></pre></div></p> <p>过滤器的第三个参数也可以是一个列表，用于容器内的递归查找：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-351-1 name=__codelineno-351-1 href=#__codelineno-351-1></a>{{ [&#39;a&#39;]|map(&#39;extract&#39;, b, [&#39;x&#39;,&#39;y&#39;])|list }}
<a id=__codelineno-351-2 name=__codelineno-351-2 href=#__codelineno-351-2></a>
<a id=__codelineno-351-3 name=__codelineno-351-3 href=#__codelineno-351-3></a>#  b[&#39;a&#39;][&#39;x&#39;][&#39;y&#39;]
</code></pre></div> <p>map中也可以使用其他过滤器</p> <div class=highlight><pre><span></span><code><a id=__codelineno-352-1 name=__codelineno-352-1 href=#__codelineno-352-1></a># 更改列表中的文件目录
<a id=__codelineno-352-2 name=__codelineno-352-2 href=#__codelineno-352-2></a>{{ [&#39;/test/t.gz&#39;] | map(&#39;basename&#39;)| map(&#39;regex_replace&#39;, &#39;(.*)&#39;, &#39;/tmp/\\1&#39;) | list )}}
</code></pre></div> <h5 id=注释过滤>注释过滤<a class=headerlink href=#注释过滤 title="Permanent link">&para;</a></h5> <p><code>comment</code> 过滤器允许用选择的注释样式装饰文本。</p> <p><div class=highlight><pre><span></span><code><a id=__codelineno-353-1 name=__codelineno-353-1 href=#__codelineno-353-1></a>{{ &quot;Plain style (default)&quot; | comment }}
</code></pre></div> 输出 <div class=highlight><pre><span></span><code><a id=__codelineno-354-1 name=__codelineno-354-1 href=#__codelineno-354-1></a>#
<a id=__codelineno-354-2 name=__codelineno-354-2 href=#__codelineno-354-2></a># Plain style (default)
<a id=__codelineno-354-3 name=__codelineno-354-3 href=#__codelineno-354-3></a>#
</code></pre></div></p> <p><strong>指定特定的注释字符</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-355-1 name=__codelineno-355-1 href=#__codelineno-355-1></a><span class="p p-Indicator">{{</span><span class=w> </span><span class=s>&quot;My</span><span class=nv> </span><span class=s>Special</span><span class=nv> </span><span class=s>Case&quot;</span><span class=w> </span><span class=err>|</span><span class=w> </span><span class=nv>comment(decoration=&quot;! &quot;)</span><span class=w> </span><span class="p p-Indicator">}}</span>
</code></pre></div> <p>输出</p> <div class=highlight><pre><span></span><code><a id=__codelineno-356-1 name=__codelineno-356-1 href=#__codelineno-356-1></a>!
<a id=__codelineno-356-2 name=__codelineno-356-2 href=#__codelineno-356-2></a>! My Special Case
<a id=__codelineno-356-3 name=__codelineno-356-3 href=#__codelineno-356-3></a>!
</code></pre></div> <p><strong>输出各种语言的注释风格</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-357-1 name=__codelineno-357-1 href=#__codelineno-357-1></a>{{ &quot;C style&quot; | comment(&#39;c&#39;) }}
<a id=__codelineno-357-2 name=__codelineno-357-2 href=#__codelineno-357-2></a>{{ &quot;C block style&quot; | comment(&#39;cblock&#39;) }}
<a id=__codelineno-357-3 name=__codelineno-357-3 href=#__codelineno-357-3></a>{{ &quot;Erlang style&quot; | comment(&#39;erlang&#39;) }}
<a id=__codelineno-357-4 name=__codelineno-357-4 href=#__codelineno-357-4></a>{{ &quot;XML style&quot; | comment(&#39;xml&#39;) }}
</code></pre></div> <p>还可以自定义 <div class=highlight><pre><span></span><code><a id=__codelineno-358-1 name=__codelineno-358-1 href=#__codelineno-358-1></a>{{ &quot;Custom style&quot; | comment(&#39;plain&#39;, prefix=&#39;#######\n#&#39;, postfix=&#39;#\n#######\n   ###\n    #&#39;) }}
</code></pre></div></p> <p>输出</p> <div class=highlight><pre><span></span><code><a id=__codelineno-359-1 name=__codelineno-359-1 href=#__codelineno-359-1></a>#######
<a id=__codelineno-359-2 name=__codelineno-359-2 href=#__codelineno-359-2></a>#
<a id=__codelineno-359-3 name=__codelineno-359-3 href=#__codelineno-359-3></a># Custom style
<a id=__codelineno-359-4 name=__codelineno-359-4 href=#__codelineno-359-4></a>#
<a id=__codelineno-359-5 name=__codelineno-359-5 href=#__codelineno-359-5></a>#######
<a id=__codelineno-359-6 name=__codelineno-359-6 href=#__codelineno-359-6></a>   ###
<a id=__codelineno-359-7 name=__codelineno-359-7 href=#__codelineno-359-7></a>    #
</code></pre></div> <h5 id=url-分割过滤器>url 分割过滤器<a class=headerlink href=#url-分割过滤器 title="Permanent link">&para;</a></h5> <p>使用 <code>urlsplit</code> 过滤器从url字符串中取其中的一个片段</p> <div class=highlight><pre><span></span><code><a id=__codelineno-360-1 name=__codelineno-360-1 href=#__codelineno-360-1></a>{{ &quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#fragment&quot; | urlsplit(&#39;hostname&#39;) }}
<a id=__codelineno-360-2 name=__codelineno-360-2 href=#__codelineno-360-2></a># =&gt; &#39;www.acme.com&#39;
<a id=__codelineno-360-3 name=__codelineno-360-3 href=#__codelineno-360-3></a>
<a id=__codelineno-360-4 name=__codelineno-360-4 href=#__codelineno-360-4></a>{{ &quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#fragment&quot; | urlsplit(&#39;netloc&#39;) }}
<a id=__codelineno-360-5 name=__codelineno-360-5 href=#__codelineno-360-5></a># =&gt; &#39;user:password@www.acme.com:9000&#39;
<a id=__codelineno-360-6 name=__codelineno-360-6 href=#__codelineno-360-6></a>
<a id=__codelineno-360-7 name=__codelineno-360-7 href=#__codelineno-360-7></a>{{ &quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#fragment&quot; | urlsplit(&#39;username&#39;) }}
<a id=__codelineno-360-8 name=__codelineno-360-8 href=#__codelineno-360-8></a># =&gt; &#39;user&#39;
<a id=__codelineno-360-9 name=__codelineno-360-9 href=#__codelineno-360-9></a>
<a id=__codelineno-360-10 name=__codelineno-360-10 href=#__codelineno-360-10></a>{{ &quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#fragment&quot; | urlsplit(&#39;password&#39;) }}
<a id=__codelineno-360-11 name=__codelineno-360-11 href=#__codelineno-360-11></a># =&gt; &#39;password&#39;
<a id=__codelineno-360-12 name=__codelineno-360-12 href=#__codelineno-360-12></a>
<a id=__codelineno-360-13 name=__codelineno-360-13 href=#__codelineno-360-13></a>{{ &quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#fragment&quot; | urlsplit(&#39;path&#39;) }}
<a id=__codelineno-360-14 name=__codelineno-360-14 href=#__codelineno-360-14></a># =&gt; &#39;/dir/index.html&#39;
<a id=__codelineno-360-15 name=__codelineno-360-15 href=#__codelineno-360-15></a>
<a id=__codelineno-360-16 name=__codelineno-360-16 href=#__codelineno-360-16></a>{{ &quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#fragment&quot; | urlsplit(&#39;port&#39;) }}
<a id=__codelineno-360-17 name=__codelineno-360-17 href=#__codelineno-360-17></a># =&gt; &#39;9000&#39;
<a id=__codelineno-360-18 name=__codelineno-360-18 href=#__codelineno-360-18></a>
<a id=__codelineno-360-19 name=__codelineno-360-19 href=#__codelineno-360-19></a>{{ &quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#fragment&quot; | urlsplit(&#39;scheme&#39;) }}
<a id=__codelineno-360-20 name=__codelineno-360-20 href=#__codelineno-360-20></a># =&gt; &#39;http&#39;
<a id=__codelineno-360-21 name=__codelineno-360-21 href=#__codelineno-360-21></a>
<a id=__codelineno-360-22 name=__codelineno-360-22 href=#__codelineno-360-22></a>{{ &quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#fragment&quot; | urlsplit(&#39;query&#39;) }}
<a id=__codelineno-360-23 name=__codelineno-360-23 href=#__codelineno-360-23></a># =&gt; &#39;query=term&#39;
<a id=__codelineno-360-24 name=__codelineno-360-24 href=#__codelineno-360-24></a>
<a id=__codelineno-360-25 name=__codelineno-360-25 href=#__codelineno-360-25></a>{{ &quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#fragment&quot; | urlsplit(&#39;fragment&#39;) }}
<a id=__codelineno-360-26 name=__codelineno-360-26 href=#__codelineno-360-26></a># =&gt; &#39;fragment&#39;
<a id=__codelineno-360-27 name=__codelineno-360-27 href=#__codelineno-360-27></a>
<a id=__codelineno-360-28 name=__codelineno-360-28 href=#__codelineno-360-28></a>{{ &quot;http://user:password@www.acme.com:9000/dir/index.html?query=term#fragment&quot; | urlsplit }}
<a id=__codelineno-360-29 name=__codelineno-360-29 href=#__codelineno-360-29></a># =&gt;
<a id=__codelineno-360-30 name=__codelineno-360-30 href=#__codelineno-360-30></a>#   {
<a id=__codelineno-360-31 name=__codelineno-360-31 href=#__codelineno-360-31></a>#       &quot;fragment&quot;: &quot;fragment&quot;,
<a id=__codelineno-360-32 name=__codelineno-360-32 href=#__codelineno-360-32></a>#       &quot;hostname&quot;: &quot;www.acme.com&quot;,
<a id=__codelineno-360-33 name=__codelineno-360-33 href=#__codelineno-360-33></a>#       &quot;netloc&quot;: &quot;user:password@www.acme.com:9000&quot;,
<a id=__codelineno-360-34 name=__codelineno-360-34 href=#__codelineno-360-34></a>#       &quot;password&quot;: &quot;password&quot;,
<a id=__codelineno-360-35 name=__codelineno-360-35 href=#__codelineno-360-35></a>#       &quot;path&quot;: &quot;/dir/index.html&quot;,
<a id=__codelineno-360-36 name=__codelineno-360-36 href=#__codelineno-360-36></a>#       &quot;port&quot;: 9000,
<a id=__codelineno-360-37 name=__codelineno-360-37 href=#__codelineno-360-37></a>#       &quot;query&quot;: &quot;query=term&quot;,
<a id=__codelineno-360-38 name=__codelineno-360-38 href=#__codelineno-360-38></a>#       &quot;scheme&quot;: &quot;http&quot;,
<a id=__codelineno-360-39 name=__codelineno-360-39 href=#__codelineno-360-39></a>#       &quot;username&quot;: &quot;user&quot;
<a id=__codelineno-360-40 name=__codelineno-360-40 href=#__codelineno-360-40></a>#   }
</code></pre></div> <h5 id=正则匹配>正则匹配<a class=headerlink href=#正则匹配 title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-361-1 name=__codelineno-361-1 href=#__codelineno-361-1></a># search for &quot;foo&quot; in &quot;foobar&quot;
<a id=__codelineno-361-2 name=__codelineno-361-2 href=#__codelineno-361-2></a>{{ &#39;foobar&#39; | regex_search(&#39;(foo)&#39;) }}
<a id=__codelineno-361-3 name=__codelineno-361-3 href=#__codelineno-361-3></a>
<a id=__codelineno-361-4 name=__codelineno-361-4 href=#__codelineno-361-4></a># will return empty if it cannot find a match
<a id=__codelineno-361-5 name=__codelineno-361-5 href=#__codelineno-361-5></a>{{ &#39;ansible&#39; | regex_search(&#39;(foobar)&#39;) }}
<a id=__codelineno-361-6 name=__codelineno-361-6 href=#__codelineno-361-6></a>
<a id=__codelineno-361-7 name=__codelineno-361-7 href=#__codelineno-361-7></a># case insensitive search in multiline mode
<a id=__codelineno-361-8 name=__codelineno-361-8 href=#__codelineno-361-8></a>{{ &#39;foo\nBAR&#39; | regex_search(&quot;^bar&quot;, multiline=True, ignorecase=True) }}
</code></pre></div> <p>搜索所有匹配的regex</p> <div class=highlight><pre><span></span><code><a id=__codelineno-362-1 name=__codelineno-362-1 href=#__codelineno-362-1></a># Return a list of all IPv4 addresses in the string
<a id=__codelineno-362-2 name=__codelineno-362-2 href=#__codelineno-362-2></a>{{ &#39;Some DNS servers are 8.8.8.8 and 8.8.4.4&#39; | regex_findall(&#39;\\b(?:[0-9]{1,3}\\.){3}[0-9]{1,3}\\b&#39;) }}
</code></pre></div> <p>正则替换</p> <div class=highlight><pre><span></span><code><a id=__codelineno-363-1 name=__codelineno-363-1 href=#__codelineno-363-1></a># convert &quot;ansible&quot; to &quot;able&quot;
<a id=__codelineno-363-2 name=__codelineno-363-2 href=#__codelineno-363-2></a>{{ &#39;ansible&#39; | regex_replace(&#39;^a.*i(.*)$&#39;, &#39;a\\1&#39;) }}
<a id=__codelineno-363-3 name=__codelineno-363-3 href=#__codelineno-363-3></a>
<a id=__codelineno-363-4 name=__codelineno-363-4 href=#__codelineno-363-4></a># convert &quot;foobar&quot; to &quot;bar&quot;
<a id=__codelineno-363-5 name=__codelineno-363-5 href=#__codelineno-363-5></a>{{ &#39;foobar&#39; | regex_replace(&#39;^f.*o(.*)$&#39;, &#39;\\1&#39;) }}
<a id=__codelineno-363-6 name=__codelineno-363-6 href=#__codelineno-363-6></a>
<a id=__codelineno-363-7 name=__codelineno-363-7 href=#__codelineno-363-7></a># convert &quot;localhost:80&quot; to &quot;localhost, 80&quot; using named groups
<a id=__codelineno-363-8 name=__codelineno-363-8 href=#__codelineno-363-8></a>{{ &#39;localhost:80&#39; | regex_replace(&#39;^(?P&lt;host&gt;.+):(?P&lt;port&gt;\\d+)$&#39;, &#39;\\g&lt;host&gt;, \\g&lt;port&gt;&#39;) }}
<a id=__codelineno-363-9 name=__codelineno-363-9 href=#__codelineno-363-9></a>
<a id=__codelineno-363-10 name=__codelineno-363-10 href=#__codelineno-363-10></a># convert &quot;localhost:80&quot; to &quot;localhost&quot;
<a id=__codelineno-363-11 name=__codelineno-363-11 href=#__codelineno-363-11></a>{{ &#39;localhost:80&#39; | regex_replace(&#39;:80&#39;) }}
</code></pre></div> <p>转义特殊字符</p> <div class=highlight><pre><span></span><code><a id=__codelineno-364-1 name=__codelineno-364-1 href=#__codelineno-364-1></a><span class=x># convert &#39;^f.*o(.*)$&#39; to &#39;\^f\.\*o\(\.\*\)\$&#39;</span>
<a id=__codelineno-364-2 name=__codelineno-364-2 href=#__codelineno-364-2></a><span class=cp>{{</span> <span class=s1>&#39;^f.*o(.*)$&#39;</span> <span class=o>|</span> <span class=nf>regex_escape</span><span class=o>()</span> <span class=cp>}}</span>
<a id=__codelineno-364-3 name=__codelineno-364-3 href=#__codelineno-364-3></a>
<a id=__codelineno-364-4 name=__codelineno-364-4 href=#__codelineno-364-4></a><span class=x># convert &#39;^f.*o(.*)$&#39; to &#39;\^f\.\*o(\.\*)\$&#39;</span>
<a id=__codelineno-364-5 name=__codelineno-364-5 href=#__codelineno-364-5></a><span class=cp>{{</span> <span class=s1>&#39;^f.*o(.*)$&#39;</span> <span class=o>|</span> <span class=nf>regex_escape</span><span class=o>(</span><span class=s1>&#39;posix_basic&#39;</span><span class=o>)</span> <span class=cp>}}</span>
</code></pre></div> <h5 id=kubernetes-过滤器>Kubernetes 过滤器<a class=headerlink href=#kubernetes-过滤器 title="Permanent link">&para;</a></h5> <p>使用<code>k8s_config_resource_name</code>过滤器来获取Kubernetes ConfigMap或Secret的名称</p> <div class=highlight><pre><span></span><code><a id=__codelineno-365-1 name=__codelineno-365-1 href=#__codelineno-365-1></a>{{ configmap_resource_definition | k8s_config_resource_name }}
</code></pre></div> <h5 id=其他的常用过滤>其他的常用过滤<a class=headerlink href=#其他的常用过滤 title="Permanent link">&para;</a></h5> <p>为shell增加双引号</p> <div class=highlight><pre><span></span><code><a id=__codelineno-366-1 name=__codelineno-366-1 href=#__codelineno-366-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo {{ string_value | quote }}</span>
</code></pre></div> <p>根据True，False来返回值</p> <div class=highlight><pre><span></span><code><a id=__codelineno-367-1 name=__codelineno-367-1 href=#__codelineno-367-1></a>{{ (&#39;name&#39; == &#39;John&#39;) | ternary(&#39;Mr&#39;,&#39;Ms&#39;) }}
<a id=__codelineno-367-2 name=__codelineno-367-2 href=#__codelineno-367-2></a>
<a id=__codelineno-367-3 name=__codelineno-367-3 href=#__codelineno-367-3></a>{{ enabled | ternary(&#39;no shutdown&#39;, &#39;shutdown&#39;, omit) }} # null 使用第三个值
</code></pre></div> <p>列表转换字符 <div class=highlight><pre><span></span><code><a id=__codelineno-368-1 name=__codelineno-368-1 href=#__codelineno-368-1></a>{{ list | join(&quot; &quot;) }}
</code></pre></div></p> <p>获取路径的文件名 <div class=highlight><pre><span></span><code><a id=__codelineno-369-1 name=__codelineno-369-1 href=#__codelineno-369-1></a>{{ path | basename }}
</code></pre></div></p> <p>获取文件的绝对路径 <div class=highlight><pre><span></span><code><a id=__codelineno-370-1 name=__codelineno-370-1 href=#__codelineno-370-1></a>{{ &#39;~/.ssh/id_rsa&#39; | expanduser }}
</code></pre></div></p> <p>windows平台下获取路径的文件名 <div class=highlight><pre><span></span><code><a id=__codelineno-371-1 name=__codelineno-371-1 href=#__codelineno-371-1></a>{{ path | win_basename }}
</code></pre></div></p> <p>获取路径中的目录 <div class=highlight><pre><span></span><code><a id=__codelineno-372-1 name=__codelineno-372-1 href=#__codelineno-372-1></a>{{ path | dirname }}
</code></pre></div></p> <p>展开包含环境变量的路径</p> <div class=highlight><pre><span></span><code><a id=__codelineno-373-1 name=__codelineno-373-1 href=#__codelineno-373-1></a>{{ path | expandvars }}
</code></pre></div> <p>获取软连接的真实路径</p> <div class=highlight><pre><span></span><code><a id=__codelineno-374-1 name=__codelineno-374-1 href=#__codelineno-374-1></a>{{ path | realpath }}
<a id=__codelineno-374-2 name=__codelineno-374-2 href=#__codelineno-374-2></a>
<a id=__codelineno-374-3 name=__codelineno-374-3 href=#__codelineno-374-3></a>{{ path | relpath(&#39;/etc&#39;) }}  # 指定启点
</code></pre></div> <p>获取文件名的名称和扩展名 <div class=highlight><pre><span></span><code><a id=__codelineno-375-1 name=__codelineno-375-1 href=#__codelineno-375-1></a>{{ path | splitext }}
</code></pre></div></p> <p>base64编码 <div class=highlight><pre><span></span><code><a id=__codelineno-376-1 name=__codelineno-376-1 href=#__codelineno-376-1></a>{{ encoded | b64decode }}
<a id=__codelineno-376-2 name=__codelineno-376-2 href=#__codelineno-376-2></a>{{ decoded | string | b64encode }}
<a id=__codelineno-376-3 name=__codelineno-376-3 href=#__codelineno-376-3></a>
<a id=__codelineno-376-4 name=__codelineno-376-4 href=#__codelineno-376-4></a>{{ encoded | b64decode(encoding=&#39;utf-16-le&#39;) }}
<a id=__codelineno-376-5 name=__codelineno-376-5 href=#__codelineno-376-5></a>{{ decoded | string | b64encode(encoding=&#39;utf-16-le&#39;) }}
</code></pre></div></p> <p>从字符串创建UUID（1.9版中的新功能） <div class=highlight><pre><span></span><code><a id=__codelineno-377-1 name=__codelineno-377-1 href=#__codelineno-377-1></a>{{ hostname | to_uuid }}
</code></pre></div></p> <p>将转换为布尔类型，如"True" 字符串转换为True <div class=highlight><pre><span></span><code><a id=__codelineno-378-1 name=__codelineno-378-1 href=#__codelineno-378-1></a>- debug: msg=test
<a id=__codelineno-378-2 name=__codelineno-378-2 href=#__codelineno-378-2></a> when: some_string_value | bool
</code></pre></div></p> <p>日期 <div class=highlight><pre><span></span><code><a id=__codelineno-379-1 name=__codelineno-379-1 href=#__codelineno-379-1></a># Get total amount of seconds between two dates. Default date format is %Y-%m-%d %H:%M:%S but you can pass your own format
<a id=__codelineno-379-2 name=__codelineno-379-2 href=#__codelineno-379-2></a>{{ ((&quot;2016-08-14 20:00:12&quot; | to_datetime) - (&quot;2015-12-25&quot; | to_datetime(&#39;%Y-%m-%d&#39;))).total_seconds() }}
<a id=__codelineno-379-3 name=__codelineno-379-3 href=#__codelineno-379-3></a>
<a id=__codelineno-379-4 name=__codelineno-379-4 href=#__codelineno-379-4></a># Get remaining seconds after delta has been calculated. NOTE: This does NOT convert years, days, hours, etc to seconds. For that, use total_seconds()
<a id=__codelineno-379-5 name=__codelineno-379-5 href=#__codelineno-379-5></a>{{ ((&quot;2016-08-14 20:00:12&quot; | to_datetime) - (&quot;2016-08-14 18:00:00&quot; | to_datetime)).seconds }}
<a id=__codelineno-379-6 name=__codelineno-379-6 href=#__codelineno-379-6></a># This expression evaluates to &quot;12&quot; and not &quot;132&quot;. Delta is 2 hours, 12 seconds
<a id=__codelineno-379-7 name=__codelineno-379-7 href=#__codelineno-379-7></a>
<a id=__codelineno-379-8 name=__codelineno-379-8 href=#__codelineno-379-8></a># get amount of days between two dates. This returns only number of days and discards remaining hours, minutes, and seconds
<a id=__codelineno-379-9 name=__codelineno-379-9 href=#__codelineno-379-9></a>{{ ((&quot;2016-08-14 20:00:12&quot; | to_datetime) - (&quot;2015-12-25&quot; | to_datetime(&#39;%Y-%m-%d&#39;))).days }}
</code></pre></div></p> <p>格式化日期</p> <div class=highlight><pre><span></span><code><a id=__codelineno-380-1 name=__codelineno-380-1 href=#__codelineno-380-1></a># Display year-month-day
<a id=__codelineno-380-2 name=__codelineno-380-2 href=#__codelineno-380-2></a>{{ &#39;%Y-%m-%d&#39; | strftime }}
<a id=__codelineno-380-3 name=__codelineno-380-3 href=#__codelineno-380-3></a>
<a id=__codelineno-380-4 name=__codelineno-380-4 href=#__codelineno-380-4></a># Display hour:min:sec
<a id=__codelineno-380-5 name=__codelineno-380-5 href=#__codelineno-380-5></a>{{ &#39;%H:%M:%S&#39; | strftime }}
<a id=__codelineno-380-6 name=__codelineno-380-6 href=#__codelineno-380-6></a>
<a id=__codelineno-380-7 name=__codelineno-380-7 href=#__codelineno-380-7></a># Use ansible_date_time.epoch fact
<a id=__codelineno-380-8 name=__codelineno-380-8 href=#__codelineno-380-8></a>{{ &#39;%Y-%m-%d %H:%M:%S&#39; | strftime(ansible_date_time.epoch) }}
<a id=__codelineno-380-9 name=__codelineno-380-9 href=#__codelineno-380-9></a>
<a id=__codelineno-380-10 name=__codelineno-380-10 href=#__codelineno-380-10></a># Use arbitrary epoch value
<a id=__codelineno-380-11 name=__codelineno-380-11 href=#__codelineno-380-11></a>{{ &#39;%Y-%m-%d&#39; | strftime(0) }}          # =&gt; 1970-01-01
<a id=__codelineno-380-12 name=__codelineno-380-12 href=#__codelineno-380-12></a>{{ &#39;%Y-%m-%d&#39; | strftime(1441357287) }} # =&gt; 2015-09-04
</code></pre></div> <p>查看变量的python类型</p> <div class=highlight><pre><span></span><code><a id=__codelineno-381-1 name=__codelineno-381-1 href=#__codelineno-381-1></a>{{ myvar | type }}
</code></pre></div> <h5 id=组合过滤器>组合过滤器<a class=headerlink href=#组合过滤器 title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-382-1 name=__codelineno-382-1 href=#__codelineno-382-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">give me largest permutations (order matters)</span>
<a id=__codelineno-382-2 name=__codelineno-382-2 href=#__codelineno-382-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-382-3 name=__codelineno-382-3 href=#__codelineno-382-3></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>[1,2,3,4,5]</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>permutations</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>list</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-382-4 name=__codelineno-382-4 href=#__codelineno-382-4></a>
<a id=__codelineno-382-5 name=__codelineno-382-5 href=#__codelineno-382-5></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">give me permutations of sets of three</span>
<a id=__codelineno-382-6 name=__codelineno-382-6 href=#__codelineno-382-6></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-382-7 name=__codelineno-382-7 href=#__codelineno-382-7></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>[1,2,3,4,5]</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>permutations(3)</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>list</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-382-8 name=__codelineno-382-8 href=#__codelineno-382-8></a>
<a id=__codelineno-382-9 name=__codelineno-382-9 href=#__codelineno-382-9></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">give me combinations for sets of two</span>
<a id=__codelineno-382-10 name=__codelineno-382-10 href=#__codelineno-382-10></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-382-11 name=__codelineno-382-11 href=#__codelineno-382-11></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>[1,2,3,4,5]</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>combinations(2)</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>list</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <h5 id=product--过滤器>Product 过滤器<a class=headerlink href=#product--过滤器 title="Permanent link">&para;</a></h5> <p><code>product</code>过滤器返回输入迭代的笛卡尔积。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-383-1 name=__codelineno-383-1 href=#__codelineno-383-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">generate multiple hostnames</span>
<a id=__codelineno-383-2 name=__codelineno-383-2 href=#__codelineno-383-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-383-3 name=__codelineno-383-3 href=#__codelineno-383-3></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>[&#39;foo&#39;,</span><span class=nv> </span><span class=s>&#39;bar&#39;]</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>product([&#39;com&#39;])</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>map(&#39;join&#39;,</span><span class=nv> </span><span class=s>&#39;.&#39;)</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>join(&#39;,&#39;)</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <p>输出</p> <div class=highlight><pre><span></span><code><a id=__codelineno-384-1 name=__codelineno-384-1 href=#__codelineno-384-1></a><span class=p>{</span><span class=w> </span><span class=nt>&quot;msg&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;foo.com,bar.com&quot;</span><span class=w> </span><span class=p>}</span>
</code></pre></div> <h5 id=debug-过滤器>debug 过滤器<a class=headerlink href=#debug-过滤器 title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-385-1 name=__codelineno-385-1 href=#__codelineno-385-1></a>{{ myvar | type_debug }}
</code></pre></div> <h5 id=字节转换>字节转换<a class=headerlink href=#字节转换 title="Permanent link">&para;</a></h5> <p>将数字转换为人类可读的字符串</p> <div class=highlight><pre><span></span><code><a id=__codelineno-386-1 name=__codelineno-386-1 href=#__codelineno-386-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Human</span><span class=nv> </span><span class=s>Readable&quot;</span>
<a id=__codelineno-386-2 name=__codelineno-386-2 href=#__codelineno-386-2></a><span class=w>  </span><span class=nt>assert</span><span class=p>:</span>
<a id=__codelineno-386-3 name=__codelineno-386-3 href=#__codelineno-386-3></a><span class=w>    </span><span class=nt>that</span><span class=p>:</span>
<a id=__codelineno-386-4 name=__codelineno-386-4 href=#__codelineno-386-4></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;&quot;1.00</span><span class=nv> </span><span class=s>Bytes&quot;</span><span class=nv> </span><span class=s>==</span><span class=nv> </span><span class=s>1|human_readable&#39;</span>
<a id=__codelineno-386-5 name=__codelineno-386-5 href=#__codelineno-386-5></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;&quot;1.00</span><span class=nv> </span><span class=s>bits&quot;</span><span class=nv> </span><span class=s>==</span><span class=nv> </span><span class=s>1|human_readable(isbits=True)&#39;</span>
<a id=__codelineno-386-6 name=__codelineno-386-6 href=#__codelineno-386-6></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;&quot;10.00</span><span class=nv> </span><span class=s>KB&quot;</span><span class=nv> </span><span class=s>==</span><span class=nv> </span><span class=s>10240|human_readable&#39;</span>
<a id=__codelineno-386-7 name=__codelineno-386-7 href=#__codelineno-386-7></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;&quot;97.66</span><span class=nv> </span><span class=s>MB&quot;</span><span class=nv> </span><span class=s>==</span><span class=nv> </span><span class=s>102400000|human_readable&#39;</span>
<a id=__codelineno-386-8 name=__codelineno-386-8 href=#__codelineno-386-8></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;&quot;0.10</span><span class=nv> </span><span class=s>GB&quot;</span><span class=nv> </span><span class=s>==</span><span class=nv> </span><span class=s>102400000|human_readable(unit=&quot;G&quot;)&#39;</span>
<a id=__codelineno-386-9 name=__codelineno-386-9 href=#__codelineno-386-9></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;&quot;0.10</span><span class=nv> </span><span class=s>Gb&quot;</span><span class=nv> </span><span class=s>==</span><span class=nv> </span><span class=s>102400000|human_readable(isbits=True,</span><span class=nv> </span><span class=s>unit=&quot;G&quot;)&#39;</span>
</code></pre></div> <p>返回</p> <div class=highlight><pre><span></span><code><a id=__codelineno-387-1 name=__codelineno-387-1 href=#__codelineno-387-1></a><span class=p>{</span><span class=w> </span><span class=nt>&quot;changed&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=nt>&quot;msg&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;All assertions passed&quot;</span><span class=w> </span><span class=p>}</span>
</code></pre></div> <p>以字节格式返回给定的字符串。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-388-1 name=__codelineno-388-1 href=#__codelineno-388-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Human</span><span class=nv> </span><span class=s>to</span><span class=nv> </span><span class=s>Bytes&quot;</span>
<a id=__codelineno-388-2 name=__codelineno-388-2 href=#__codelineno-388-2></a><span class=w>  </span><span class=nt>assert</span><span class=p>:</span>
<a id=__codelineno-388-3 name=__codelineno-388-3 href=#__codelineno-388-3></a><span class=w>    </span><span class=nt>that</span><span class=p>:</span>
<a id=__codelineno-388-4 name=__codelineno-388-4 href=#__codelineno-388-4></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{&#39;0&#39;|human_to_bytes}}</span><span class=nv>        </span><span class=s>==</span><span class=nv> </span><span class=s>0&quot;</span>
<a id=__codelineno-388-5 name=__codelineno-388-5 href=#__codelineno-388-5></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{&#39;0.1&#39;|human_to_bytes}}</span><span class=nv>      </span><span class=s>==</span><span class=nv> </span><span class=s>0&quot;</span>
<a id=__codelineno-388-6 name=__codelineno-388-6 href=#__codelineno-388-6></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{&#39;0.9&#39;|human_to_bytes}}</span><span class=nv>      </span><span class=s>==</span><span class=nv> </span><span class=s>1&quot;</span>
<a id=__codelineno-388-7 name=__codelineno-388-7 href=#__codelineno-388-7></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{&#39;1&#39;|human_to_bytes}}</span><span class=nv>        </span><span class=s>==</span><span class=nv> </span><span class=s>1&quot;</span>
<a id=__codelineno-388-8 name=__codelineno-388-8 href=#__codelineno-388-8></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{&#39;10.00</span><span class=nv> </span><span class=s>KB&#39;|human_to_bytes}}</span><span class=nv> </span><span class=s>==</span><span class=nv> </span><span class=s>10240&quot;</span>
<a id=__codelineno-388-9 name=__codelineno-388-9 href=#__codelineno-388-9></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv>  </span><span class=s>&#39;11</span><span class=nv> </span><span class=s>MB&#39;|human_to_bytes}}</span><span class=nv> </span><span class=s>==</span><span class=nv> </span><span class=s>11534336&quot;</span>
<a id=__codelineno-388-10 name=__codelineno-388-10 href=#__codelineno-388-10></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>&#39;1.1</span><span class=nv> </span><span class=s>GB&#39;|human_to_bytes}}</span><span class=nv> </span><span class=s>==</span><span class=nv> </span><span class=s>1181116006&quot;</span>
<a id=__codelineno-388-11 name=__codelineno-388-11 href=#__codelineno-388-11></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{&#39;10.00</span><span class=nv> </span><span class=s>Kb&#39;|human_to_bytes(isbits=True)}}</span><span class=nv> </span><span class=s>==</span><span class=nv> </span><span class=s>10240&quot;</span>
</code></pre></div> <p>返回 <div class=highlight><pre><span></span><code><a id=__codelineno-389-1 name=__codelineno-389-1 href=#__codelineno-389-1></a><span class=p>{</span><span class=w> </span><span class=nt>&quot;changed&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=nt>&quot;msg&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;All assertions passed&quot;</span><span class=w> </span><span class=p>}</span>
</code></pre></div></p> <h4 id=测试>测试<a class=headerlink href=#测试 title="Permanent link">&para;</a></h4> <p>除了过滤器，所谓的“测试”也是可用的。测试可以用于对照普通表达式测试一个变量。 要测试一个变量或表达式，你要在变量后加上一个 is 以及测试的名称。例如，要得出 一个值是否定义过，你可以用 name is defined ，这会根据 name 是否定义返回 true 或 false 。</p> <h5 id=测试语法>测试语法<a class=headerlink href=#测试语法 title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-390-1 name=__codelineno-390-1 href=#__codelineno-390-1></a>variable is test_name
</code></pre></div> <p>例如</p> <div class=highlight><pre><span></span><code><a id=__codelineno-391-1 name=__codelineno-391-1 href=#__codelineno-391-1></a>result is failed
</code></pre></div> <p>测试也可以接受参数。如果测试只接受一个参数，你可以省去括号来分组它们。例如， 下面的两个表达式做同样的事情:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-392-1 name=__codelineno-392-1 href=#__codelineno-392-1></a>{% if loop.index is divisibleby 3 %}
<a id=__codelineno-392-2 name=__codelineno-392-2 href=#__codelineno-392-2></a>{% if loop.index is divisibleby(3) %}
</code></pre></div> <h5 id=测试字符串>测试字符串<a class=headerlink href=#测试字符串 title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-393-1 name=__codelineno-393-1 href=#__codelineno-393-1></a>vars:
<a id=__codelineno-393-2 name=__codelineno-393-2 href=#__codelineno-393-2></a>  url: &quot;http://example.com/users/foo/resources/bar&quot;
<a id=__codelineno-393-3 name=__codelineno-393-3 href=#__codelineno-393-3></a>
<a id=__codelineno-393-4 name=__codelineno-393-4 href=#__codelineno-393-4></a>tasks:
<a id=__codelineno-393-5 name=__codelineno-393-5 href=#__codelineno-393-5></a>    - debug:
<a id=__codelineno-393-6 name=__codelineno-393-6 href=#__codelineno-393-6></a>        msg: &quot;matched pattern 1&quot;
<a id=__codelineno-393-7 name=__codelineno-393-7 href=#__codelineno-393-7></a>      when: url is match(&quot;http://example.com/users/.*/resources/.*&quot;)
<a id=__codelineno-393-8 name=__codelineno-393-8 href=#__codelineno-393-8></a>
<a id=__codelineno-393-9 name=__codelineno-393-9 href=#__codelineno-393-9></a>    - debug:
<a id=__codelineno-393-10 name=__codelineno-393-10 href=#__codelineno-393-10></a>        msg: &quot;matched pattern 2&quot;
<a id=__codelineno-393-11 name=__codelineno-393-11 href=#__codelineno-393-11></a>      when: url is search(&quot;/users/.*/resources/.*&quot;)
<a id=__codelineno-393-12 name=__codelineno-393-12 href=#__codelineno-393-12></a>
<a id=__codelineno-393-13 name=__codelineno-393-13 href=#__codelineno-393-13></a>    - debug:
<a id=__codelineno-393-14 name=__codelineno-393-14 href=#__codelineno-393-14></a>        msg: &quot;matched pattern 3&quot;
<a id=__codelineno-393-15 name=__codelineno-393-15 href=#__codelineno-393-15></a>      when: url is search(&quot;/users/&quot;)
<a id=__codelineno-393-16 name=__codelineno-393-16 href=#__codelineno-393-16></a>
<a id=__codelineno-393-17 name=__codelineno-393-17 href=#__codelineno-393-17></a>    - debug:
<a id=__codelineno-393-18 name=__codelineno-393-18 href=#__codelineno-393-18></a>        msg: &quot;matched pattern 4&quot;
<a id=__codelineno-393-19 name=__codelineno-393-19 href=#__codelineno-393-19></a>      when: url is regex(&quot;example.com/\w+/foo&quot;)
</code></pre></div> <p><code>match</code>需要在字符串中完全匹配，而<code>search</code>只需要匹配字符串的子集。匹配成功返回<code>True</code>，任务则执行。</p> <h5 id=版本比较>版本比较<a class=headerlink href=#版本比较 title="Permanent link">&para;</a></h5> <p>检查ansible_distribution_version版本是否大于或等于'12 .04'，条件成立返回True。 <div class=highlight><pre><span></span><code><a id=__codelineno-394-1 name=__codelineno-394-1 href=#__codelineno-394-1></a>{{ ansible_distribution_version is version_compare(&#39;12.04&#39;, &#39;&gt;=&#39;) }}
</code></pre></div></p> <p>进行严格的版本检查 <div class=highlight><pre><span></span><code><a id=__codelineno-395-1 name=__codelineno-395-1 href=#__codelineno-395-1></a>{{ sample_version_var is version_compare(&#39;1.0&#39;, operator=&#39;lt&#39;, strict=True) }}
</code></pre></div> 可接受的运算符 <div class=highlight><pre><span></span><code><a id=__codelineno-396-1 name=__codelineno-396-1 href=#__codelineno-396-1></a>&lt;, lt, &lt;=, le, &gt;, gt, &gt;=, ge, ==, =, eq, !=, &lt;&gt;, ne
</code></pre></div></p> <h5 id=包含测试>包含测试<a class=headerlink href=#包含测试 title="Permanent link">&para;</a></h5> <p>测试一个列表是否包含另一个列表。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-397-1 name=__codelineno-397-1 href=#__codelineno-397-1></a><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-397-2 name=__codelineno-397-2 href=#__codelineno-397-2></a><span class=w>    </span><span class=nt>a</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>1</span><span class="p p-Indicator">,</span><span class=nv>2</span><span class="p p-Indicator">,</span><span class=nv>3</span><span class="p p-Indicator">,</span><span class=nv>4</span><span class="p p-Indicator">,</span><span class=nv>5</span><span class="p p-Indicator">]</span>
<a id=__codelineno-397-3 name=__codelineno-397-3 href=#__codelineno-397-3></a><span class=w>    </span><span class=nt>b</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>2</span><span class="p p-Indicator">,</span><span class=nv>3</span><span class="p p-Indicator">]</span>
<a id=__codelineno-397-4 name=__codelineno-397-4 href=#__codelineno-397-4></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-397-5 name=__codelineno-397-5 href=#__codelineno-397-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-397-6 name=__codelineno-397-6 href=#__codelineno-397-6></a><span class=w>        </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;A</span><span class=nv> </span><span class=s>includes</span><span class=nv> </span><span class=s>B&quot;</span>
<a id=__codelineno-397-7 name=__codelineno-397-7 href=#__codelineno-397-7></a><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">a is superset(b)</span>
<a id=__codelineno-397-8 name=__codelineno-397-8 href=#__codelineno-397-8></a>
<a id=__codelineno-397-9 name=__codelineno-397-9 href=#__codelineno-397-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-397-10 name=__codelineno-397-10 href=#__codelineno-397-10></a><span class=w>        </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;B</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>included</span><span class=nv> </span><span class=s>in</span><span class=nv> </span><span class=s>A&quot;</span>
<a id=__codelineno-397-11 name=__codelineno-397-11 href=#__codelineno-397-11></a><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">b is subset(a)</span>
</code></pre></div> <p>测试列表是否包含值</p> <div class=highlight><pre><span></span><code><a id=__codelineno-398-1 name=__codelineno-398-1 href=#__codelineno-398-1></a><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-398-2 name=__codelineno-398-2 href=#__codelineno-398-2></a><span class=w>  </span><span class=nt>lacp_groups</span><span class=p>:</span>
<a id=__codelineno-398-3 name=__codelineno-398-3 href=#__codelineno-398-3></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>master</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">lacp0</span>
<a id=__codelineno-398-4 name=__codelineno-398-4 href=#__codelineno-398-4></a><span class=w>      </span><span class=nt>network</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10.65.100.0/24</span>
<a id=__codelineno-398-5 name=__codelineno-398-5 href=#__codelineno-398-5></a><span class=w>      </span><span class=nt>gateway</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10.65.100.1</span>
<a id=__codelineno-398-6 name=__codelineno-398-6 href=#__codelineno-398-6></a><span class=w>      </span><span class=nt>dns4</span><span class=p>:</span>
<a id=__codelineno-398-7 name=__codelineno-398-7 href=#__codelineno-398-7></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10.65.100.10</span>
<a id=__codelineno-398-8 name=__codelineno-398-8 href=#__codelineno-398-8></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10.65.100.11</span>
<a id=__codelineno-398-9 name=__codelineno-398-9 href=#__codelineno-398-9></a><span class=w>      </span><span class=nt>interfaces</span><span class=p>:</span>
<a id=__codelineno-398-10 name=__codelineno-398-10 href=#__codelineno-398-10></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">em1</span>
<a id=__codelineno-398-11 name=__codelineno-398-11 href=#__codelineno-398-11></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">em2</span>
<a id=__codelineno-398-12 name=__codelineno-398-12 href=#__codelineno-398-12></a>
<a id=__codelineno-398-13 name=__codelineno-398-13 href=#__codelineno-398-13></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>master</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">lacp1</span>
<a id=__codelineno-398-14 name=__codelineno-398-14 href=#__codelineno-398-14></a><span class=w>      </span><span class=nt>network</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10.65.120.0/24</span>
<a id=__codelineno-398-15 name=__codelineno-398-15 href=#__codelineno-398-15></a><span class=w>      </span><span class=nt>gateway</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10.65.120.1</span>
<a id=__codelineno-398-16 name=__codelineno-398-16 href=#__codelineno-398-16></a><span class=w>      </span><span class=nt>dns4</span><span class=p>:</span>
<a id=__codelineno-398-17 name=__codelineno-398-17 href=#__codelineno-398-17></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10.65.100.10</span>
<a id=__codelineno-398-18 name=__codelineno-398-18 href=#__codelineno-398-18></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10.65.100.11</span>
<a id=__codelineno-398-19 name=__codelineno-398-19 href=#__codelineno-398-19></a><span class=w>      </span><span class=nt>interfaces</span><span class=p>:</span>
<a id=__codelineno-398-20 name=__codelineno-398-20 href=#__codelineno-398-20></a><span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">em3</span>
<a id=__codelineno-398-21 name=__codelineno-398-21 href=#__codelineno-398-21></a><span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">em4</span>
<a id=__codelineno-398-22 name=__codelineno-398-22 href=#__codelineno-398-22></a>
<a id=__codelineno-398-23 name=__codelineno-398-23 href=#__codelineno-398-23></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-398-24 name=__codelineno-398-24 href=#__codelineno-398-24></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-398-25 name=__codelineno-398-25 href=#__codelineno-398-25></a><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>(lacp_groups|selectattr(&#39;interfaces&#39;,</span><span class=nv> </span><span class=s>&#39;contains&#39;,</span><span class=nv> </span><span class=s>&#39;em1&#39;)|first).master</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <p>您可以使用<code>any</code> 和 <code>all</code>来检查列表中的任何元素或所有元素是否为真</p> <div class=highlight><pre><span></span><code><a id=__codelineno-399-1 name=__codelineno-399-1 href=#__codelineno-399-1></a><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-399-2 name=__codelineno-399-2 href=#__codelineno-399-2></a><span class=w>  </span><span class=nt>mylist</span><span class=p>:</span>
<a id=__codelineno-399-3 name=__codelineno-399-3 href=#__codelineno-399-3></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-399-4 name=__codelineno-399-4 href=#__codelineno-399-4></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>3</span><span class=nv> </span><span class=s>==</span><span class=nv> </span><span class=s>3</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-399-5 name=__codelineno-399-5 href=#__codelineno-399-5></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<a id=__codelineno-399-6 name=__codelineno-399-6 href=#__codelineno-399-6></a><span class=w>  </span><span class=nt>myotherlist</span><span class=p>:</span>
<a id=__codelineno-399-7 name=__codelineno-399-7 href=#__codelineno-399-7></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<a id=__codelineno-399-8 name=__codelineno-399-8 href=#__codelineno-399-8></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<a id=__codelineno-399-9 name=__codelineno-399-9 href=#__codelineno-399-9></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-399-10 name=__codelineno-399-10 href=#__codelineno-399-10></a>
<a id=__codelineno-399-11 name=__codelineno-399-11 href=#__codelineno-399-11></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-399-12 name=__codelineno-399-12 href=#__codelineno-399-12></a><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;all</span><span class=nv> </span><span class=s>are</span><span class=nv> </span><span class=s>true!&quot;</span>
<a id=__codelineno-399-13 name=__codelineno-399-13 href=#__codelineno-399-13></a><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mylist is all</span>
<a id=__codelineno-399-14 name=__codelineno-399-14 href=#__codelineno-399-14></a>
<a id=__codelineno-399-15 name=__codelineno-399-15 href=#__codelineno-399-15></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-399-16 name=__codelineno-399-16 href=#__codelineno-399-16></a><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;at</span><span class=nv> </span><span class=s>least</span><span class=nv> </span><span class=s>one</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>true&quot;</span>
<a id=__codelineno-399-17 name=__codelineno-399-17 href=#__codelineno-399-17></a><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myotherlist is any</span>
</code></pre></div> <h5 id=路径测试>路径测试<a class=headerlink href=#路径测试 title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-400-1 name=__codelineno-400-1 href=#__codelineno-400-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-400-2 name=__codelineno-400-2 href=#__codelineno-400-2></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;path</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>a</span><span class=nv> </span><span class=s>directory&quot;</span>
<a id=__codelineno-400-3 name=__codelineno-400-3 href=#__codelineno-400-3></a><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mypath is directory</span>
<a id=__codelineno-400-4 name=__codelineno-400-4 href=#__codelineno-400-4></a>
<a id=__codelineno-400-5 name=__codelineno-400-5 href=#__codelineno-400-5></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-400-6 name=__codelineno-400-6 href=#__codelineno-400-6></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;path</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>a</span><span class=nv> </span><span class=s>file&quot;</span>
<a id=__codelineno-400-7 name=__codelineno-400-7 href=#__codelineno-400-7></a><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mypath is file</span>
<a id=__codelineno-400-8 name=__codelineno-400-8 href=#__codelineno-400-8></a>
<a id=__codelineno-400-9 name=__codelineno-400-9 href=#__codelineno-400-9></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-400-10 name=__codelineno-400-10 href=#__codelineno-400-10></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;path</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>a</span><span class=nv> </span><span class=s>symlink&quot;</span>
<a id=__codelineno-400-11 name=__codelineno-400-11 href=#__codelineno-400-11></a><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mypath is link</span>
<a id=__codelineno-400-12 name=__codelineno-400-12 href=#__codelineno-400-12></a>
<a id=__codelineno-400-13 name=__codelineno-400-13 href=#__codelineno-400-13></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-400-14 name=__codelineno-400-14 href=#__codelineno-400-14></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;path</span><span class=nv> </span><span class=s>already</span><span class=nv> </span><span class=s>exists&quot;</span>
<a id=__codelineno-400-15 name=__codelineno-400-15 href=#__codelineno-400-15></a><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mypath is exists</span>
<a id=__codelineno-400-16 name=__codelineno-400-16 href=#__codelineno-400-16></a>
<a id=__codelineno-400-17 name=__codelineno-400-17 href=#__codelineno-400-17></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-400-18 name=__codelineno-400-18 href=#__codelineno-400-18></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;path</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>(mypath</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>abs)|ternary(&#39;absolute&#39;,&#39;relative&#39;)}}&quot;</span>
<a id=__codelineno-400-19 name=__codelineno-400-19 href=#__codelineno-400-19></a>
<a id=__codelineno-400-20 name=__codelineno-400-20 href=#__codelineno-400-20></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-400-21 name=__codelineno-400-21 href=#__codelineno-400-21></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;path</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>the</span><span class=nv> </span><span class=s>same</span><span class=nv> </span><span class=s>file</span><span class=nv> </span><span class=s>as</span><span class=nv> </span><span class=s>path2&quot;</span>
<a id=__codelineno-400-22 name=__codelineno-400-22 href=#__codelineno-400-22></a><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mypath is same_file(path2)</span>
<a id=__codelineno-400-23 name=__codelineno-400-23 href=#__codelineno-400-23></a>
<a id=__codelineno-400-24 name=__codelineno-400-24 href=#__codelineno-400-24></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-400-25 name=__codelineno-400-25 href=#__codelineno-400-25></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;path</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>a</span><span class=nv> </span><span class=s>mount&quot;</span>
<a id=__codelineno-400-26 name=__codelineno-400-26 href=#__codelineno-400-26></a><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mypath is mount</span>
</code></pre></div> <h5 id=测试命令结果>测试命令结果<a class=headerlink href=#测试命令结果 title="Permanent link">&para;</a></h5> <p>以下playbook是检查任务状态的测试。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-401-1 name=__codelineno-401-1 href=#__codelineno-401-1></a>tasks:
<a id=__codelineno-401-2 name=__codelineno-401-2 href=#__codelineno-401-2></a>
<a id=__codelineno-401-3 name=__codelineno-401-3 href=#__codelineno-401-3></a>- shell: /usr/bin/foo
<a id=__codelineno-401-4 name=__codelineno-401-4 href=#__codelineno-401-4></a>  register: result
<a id=__codelineno-401-5 name=__codelineno-401-5 href=#__codelineno-401-5></a>  ignore_errors: True
<a id=__codelineno-401-6 name=__codelineno-401-6 href=#__codelineno-401-6></a>
<a id=__codelineno-401-7 name=__codelineno-401-7 href=#__codelineno-401-7></a>- debug: msg=&quot;it failed&quot;
<a id=__codelineno-401-8 name=__codelineno-401-8 href=#__codelineno-401-8></a>  when: result is failed
<a id=__codelineno-401-9 name=__codelineno-401-9 href=#__codelineno-401-9></a>
<a id=__codelineno-401-10 name=__codelineno-401-10 href=#__codelineno-401-10></a>- debug: msg=&quot;it changed&quot;
<a id=__codelineno-401-11 name=__codelineno-401-11 href=#__codelineno-401-11></a>  when: result is changed
<a id=__codelineno-401-12 name=__codelineno-401-12 href=#__codelineno-401-12></a>
<a id=__codelineno-401-13 name=__codelineno-401-13 href=#__codelineno-401-13></a>- debug: msg=&quot;it succeeded in Ansible &gt;= 2.1&quot;
<a id=__codelineno-401-14 name=__codelineno-401-14 href=#__codelineno-401-14></a>  when: result is succeeded
<a id=__codelineno-401-15 name=__codelineno-401-15 href=#__codelineno-401-15></a>
<a id=__codelineno-401-16 name=__codelineno-401-16 href=#__codelineno-401-16></a>- debug: msg=&quot;it succeeded&quot;
<a id=__codelineno-401-17 name=__codelineno-401-17 href=#__codelineno-401-17></a>  when: result is success
<a id=__codelineno-401-18 name=__codelineno-401-18 href=#__codelineno-401-18></a>
<a id=__codelineno-401-19 name=__codelineno-401-19 href=#__codelineno-401-19></a>- debug: msg=&quot;it was skipped&quot;
<a id=__codelineno-401-20 name=__codelineno-401-20 href=#__codelineno-401-20></a>  when: result is skipped
</code></pre></div> <h4 id=lookup-插件>lookup 插件<a class=headerlink href=#lookup-插件 title="Permanent link">&para;</a></h4> <p><code>lookup</code> 插件允许访问外部数据源。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-402-1 name=__codelineno-402-1 href=#__codelineno-402-1></a><span class=c1># 获取文件内容</span>
<a id=__codelineno-402-2 name=__codelineno-402-2 href=#__codelineno-402-2></a><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-402-3 name=__codelineno-402-3 href=#__codelineno-402-3></a><span class=w>  </span><span class=nt>motd_value</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>lookup(&#39;file&#39;,</span><span class=nv> </span><span class=s>&#39;/etc/motd&#39;)</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-402-4 name=__codelineno-402-4 href=#__codelineno-402-4></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-402-5 name=__codelineno-402-5 href=#__codelineno-402-5></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-402-6 name=__codelineno-402-6 href=#__codelineno-402-6></a><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;motd</span><span class=nv> </span><span class=s>value</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>motd_value</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <p>lookup 更多的插件使用请看 <a href=/basic/Playbook-features/#lookup>lookup 插件</a></p> <h4 id=if-语句_1>if 语句<a class=headerlink href=#if-语句_1 title="Permanent link">&para;</a></h4> <p>ad-hoc <div class=highlight><pre><span></span><code><a id=__codelineno-403-1 name=__codelineno-403-1 href=#__codelineno-403-1></a>ansible<span class=w> </span>localhost<span class=w> </span>-m<span class=w> </span>debug<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;msg={%- if ansible_play_hosts.index(inventory_hostname) &lt; 3 -%}master{%- else -%}slave{%- endif -%}&quot;</span><span class=w> </span>
</code></pre></div></p> <p>playbook</p> <div class=highlight><pre><span></span><code><a id=__codelineno-404-1 name=__codelineno-404-1 href=#__codelineno-404-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-404-2 name=__codelineno-404-2 href=#__codelineno-404-2></a><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">&gt;-</span>
<a id=__codelineno-404-3 name=__codelineno-404-3 href=#__codelineno-404-3></a><span class=w>        </span><span class=no>{%- if ansible_play_hosts.index(inventory_hostname) &lt; 3 -%}</span>
<a id=__codelineno-404-4 name=__codelineno-404-4 href=#__codelineno-404-4></a><span class=w>          </span><span class=no>master</span>
<a id=__codelineno-404-5 name=__codelineno-404-5 href=#__codelineno-404-5></a><span class=w>        </span><span class=no>{%- else -%}</span>
<a id=__codelineno-404-6 name=__codelineno-404-6 href=#__codelineno-404-6></a><span class=w>          </span><span class=no>slave</span>
<a id=__codelineno-404-7 name=__codelineno-404-7 href=#__codelineno-404-7></a><span class=w>        </span><span class=no>{%- endif -%}</span>
</code></pre></div> <h4 id=for-语句>for 语句<a class=headerlink href=#for-语句 title="Permanent link">&para;</a></h4> <p>ad-hoc</p> <div class=highlight><pre><span></span><code><a id=__codelineno-405-1 name=__codelineno-405-1 href=#__codelineno-405-1></a>ansible<span class=w> </span>localhost<span class=w> </span>-m<span class=w> </span>debug<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;msg={%- for t in [1,2,3] -%}{{ t }}{%- endfor -%}&quot;</span>
</code></pre></div> <p>playbook</p> <div class=highlight><pre><span></span><code><a id=__codelineno-406-1 name=__codelineno-406-1 href=#__codelineno-406-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-406-2 name=__codelineno-406-2 href=#__codelineno-406-2></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|-</span>
<a id=__codelineno-406-3 name=__codelineno-406-3 href=#__codelineno-406-3></a><span class=w>      </span><span class=no>{%- for t in [1,2,3] -%}</span>
<a id=__codelineno-406-4 name=__codelineno-406-4 href=#__codelineno-406-4></a><span class=w>        </span><span class=no>{{ t }}</span>
<a id=__codelineno-406-5 name=__codelineno-406-5 href=#__codelineno-406-5></a><span class=w>      </span><span class=no>{%- endfor -%}</span>
</code></pre></div> <h4 id=在-when-里使用-jinja2-表达式>在 when 里使用 jinja2 表达式<a class=headerlink href=#在-when-里使用-jinja2-表达式 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-407-1 name=__codelineno-407-1 href=#__codelineno-407-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">target_host</span>
<a id=__codelineno-407-2 name=__codelineno-407-2 href=#__codelineno-407-2></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-407-3 name=__codelineno-407-3 href=#__codelineno-407-3></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Show debug</span>
<a id=__codelineno-407-4 name=__codelineno-407-4 href=#__codelineno-407-4></a><span class=w>    </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&#39;条件满足你就会看到我。&#39;</span>
<a id=__codelineno-407-5 name=__codelineno-407-5 href=#__codelineno-407-5></a><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=s>&#39;{%</span><span class=nv> </span><span class=s>if</span><span class=nv> </span><span class=s>def_a_var|d(&quot;abc&quot;)</span><span class=nv> </span><span class=s>==</span><span class=nv> </span><span class=s>&quot;abc&quot;</span><span class=nv> </span><span class=s>%}{{</span><span class=nv> </span><span class=s>foo</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>d(&quot;true&quot;)</span><span class=nv> </span><span class=s>}}{%</span><span class=nv> </span><span class=s>endif</span><span class=nv> </span><span class=s>%}&#39;</span>
</code></pre></div> <h2 id=13条件判断与循环>13.条件判断与循环<a class=headerlink href=#13条件判断与循环 title="Permanent link">&para;</a></h2> <h3 id=条件判断>条件判断<a class=headerlink href=#条件判断 title="Permanent link">&para;</a></h3> <p>ansible 使用<code>when</code>语句后的表达式来判断该步骤是否执行。 </p> <h4 id=when-语句>When 语句<a class=headerlink href=#when-语句 title="Permanent link">&para;</a></h4> <p>在when 后面使用没有<code>{{ }}</code> 的 <code>Jinja2</code> 表达式，结果为True则执行任务。</p> <blockquote> <p>不需要使用 {{}} 来在条件语句中使用变量</p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-408-1 name=__codelineno-408-1 href=#__codelineno-408-1></a><span class=c1>#  若操作系统是 Debian 时就执行关机操作</span>
<a id=__codelineno-408-2 name=__codelineno-408-2 href=#__codelineno-408-2></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-408-3 name=__codelineno-408-3 href=#__codelineno-408-3></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;shut</span><span class=nv> </span><span class=s>down</span><span class=nv> </span><span class=s>Debian</span><span class=nv> </span><span class=s>flavored</span><span class=nv> </span><span class=s>systems&quot;</span>
<a id=__codelineno-408-4 name=__codelineno-408-4 href=#__codelineno-408-4></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/sbin/shutdown -t now</span>
<a id=__codelineno-408-5 name=__codelineno-408-5 href=#__codelineno-408-5></a><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ansible_os_family == &quot;Debian&quot;</span>
</code></pre></div> <blockquote> <p>ansible_os_family 是 facts 或 vars 的变量</p> </blockquote> <p>您还可以使用括号对条件进行分组</p> <div class=highlight><pre><span></span><code><a id=__codelineno-409-1 name=__codelineno-409-1 href=#__codelineno-409-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-409-2 name=__codelineno-409-2 href=#__codelineno-409-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;shut</span><span class=nv> </span><span class=s>down</span><span class=nv> </span><span class=s>CentOS</span><span class=nv> </span><span class=s>6</span><span class=nv> </span><span class=s>and</span><span class=nv> </span><span class=s>Debian</span><span class=nv> </span><span class=s>7</span><span class=nv> </span><span class=s>systems&quot;</span>
<a id=__codelineno-409-3 name=__codelineno-409-3 href=#__codelineno-409-3></a><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/sbin/shutdown -t now</span>
<a id=__codelineno-409-4 name=__codelineno-409-4 href=#__codelineno-409-4></a><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">(ansible_facts[&#39;distribution&#39;] == &quot;CentOS&quot; and ansible_facts[&#39;distribution_major_version&#39;] == &quot;6&quot;) or</span>
<a id=__codelineno-409-5 name=__codelineno-409-5 href=#__codelineno-409-5></a><span class=w>          </span><span class="l l-Scalar l-Scalar-Plain">(ansible_facts[&#39;distribution&#39;] == &quot;Debian&quot; and ansible_facts[&#39;distribution_major_version&#39;] == &quot;7&quot;)</span>
</code></pre></div> <p>可以使用列表形式来表示条件为 <strong>and</strong> 的关系</p> <div class=highlight><pre><span></span><code><a id=__codelineno-410-1 name=__codelineno-410-1 href=#__codelineno-410-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-410-2 name=__codelineno-410-2 href=#__codelineno-410-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;shut</span><span class=nv> </span><span class=s>down</span><span class=nv> </span><span class=s>CentOS</span><span class=nv> </span><span class=s>6</span><span class=nv> </span><span class=s>systems&quot;</span>
<a id=__codelineno-410-3 name=__codelineno-410-3 href=#__codelineno-410-3></a><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/sbin/shutdown -t now</span>
<a id=__codelineno-410-4 name=__codelineno-410-4 href=#__codelineno-410-4></a><span class=w>    </span><span class=nt>when</span><span class=p>:</span>
<a id=__codelineno-410-5 name=__codelineno-410-5 href=#__codelineno-410-5></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ansible_facts[&#39;distribution&#39;] == &quot;CentOS&quot;</span>
<a id=__codelineno-410-6 name=__codelineno-410-6 href=#__codelineno-410-6></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ansible_facts[&#39;distribution_major_version&#39;] == &quot;6&quot;</span>
</code></pre></div> <p>许多Jinja2测试和过滤器也可以用于when语句，其中一些是唯一的，由Ansible提供。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-411-1 name=__codelineno-411-1 href=#__codelineno-411-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-411-2 name=__codelineno-411-2 href=#__codelineno-411-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/bin/false</span>
<a id=__codelineno-411-3 name=__codelineno-411-3 href=#__codelineno-411-3></a><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">result</span>
<a id=__codelineno-411-4 name=__codelineno-411-4 href=#__codelineno-411-4></a><span class=w>    </span><span class=nt>ignore_errors</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<a id=__codelineno-411-5 name=__codelineno-411-5 href=#__codelineno-411-5></a>
<a id=__codelineno-411-6 name=__codelineno-411-6 href=#__codelineno-411-6></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/bin/something</span>
<a id=__codelineno-411-7 name=__codelineno-411-7 href=#__codelineno-411-7></a><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">result is failed</span>
<a id=__codelineno-411-8 name=__codelineno-411-8 href=#__codelineno-411-8></a>
<a id=__codelineno-411-9 name=__codelineno-411-9 href=#__codelineno-411-9></a><span class=w>  </span><span class=c1># 忽略一个语句的错误，然后决定基于成功或失败有条件地做一些事情。</span>
<a id=__codelineno-411-10 name=__codelineno-411-10 href=#__codelineno-411-10></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/bin/something_else</span>
<a id=__codelineno-411-11 name=__codelineno-411-11 href=#__codelineno-411-11></a><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">result is succeeded</span>
<a id=__codelineno-411-12 name=__codelineno-411-12 href=#__codelineno-411-12></a>
<a id=__codelineno-411-13 name=__codelineno-411-13 href=#__codelineno-411-13></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/bin/still/something_else</span>
<a id=__codelineno-411-14 name=__codelineno-411-14 href=#__codelineno-411-14></a><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">result is skipped</span>
</code></pre></div> <p>字符串转换为数字型再去比较</p> <div class=highlight><pre><span></span><code><a id=__codelineno-412-1 name=__codelineno-412-1 href=#__codelineno-412-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-412-2 name=__codelineno-412-2 href=#__codelineno-412-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;only on Red Hat 6, derivatives, and later&quot;</span>
<a id=__codelineno-412-3 name=__codelineno-412-3 href=#__codelineno-412-3></a><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ansible_facts[&#39;os_family&#39;] == &quot;RedHat&quot; and ansible_facts[&#39;lsb&#39;][&#39;major_release&#39;]|int &gt;= 6</span>
</code></pre></div> <p>也可以使用定义的变量，注意字符串(类似:"yes", "on", "1","true")需要用<code>|bool</code> 转成布尔值。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-413-1 name=__codelineno-413-1 href=#__codelineno-413-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">node</span>
<a id=__codelineno-413-2 name=__codelineno-413-2 href=#__codelineno-413-2></a><span class=w>  </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-413-3 name=__codelineno-413-3 href=#__codelineno-413-3></a><span class=w>    </span><span class=nt>epic</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-413-4 name=__codelineno-413-4 href=#__codelineno-413-4></a><span class=w>    </span><span class=nt>monumental</span><span class=p>:</span><span class=w> </span><span class=s>&quot;yes&quot;</span>
<a id=__codelineno-413-5 name=__codelineno-413-5 href=#__codelineno-413-5></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-413-6 name=__codelineno-413-6 href=#__codelineno-413-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;This certainly is epic!&quot;</span>
<a id=__codelineno-413-7 name=__codelineno-413-7 href=#__codelineno-413-7></a><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">epic or monumental | bool</span>
<a id=__codelineno-413-8 name=__codelineno-413-8 href=#__codelineno-413-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;This certainly isn&#39;t epic!&quot;</span>
<a id=__codelineno-413-9 name=__codelineno-413-9 href=#__codelineno-413-9></a><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">not epic</span>
</code></pre></div> <p>如果未设置所需的变量，则可以使用 Jinja2 定义的测试跳过或失败。例如:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-414-1 name=__codelineno-414-1 href=#__codelineno-414-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-414-2 name=__codelineno-414-2 href=#__codelineno-414-2></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;I&#39;ve got &#39;{{ foo }}&#39; and am not afraid to use it!&quot;</span>
<a id=__codelineno-414-3 name=__codelineno-414-3 href=#__codelineno-414-3></a><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo is defined</span>
<a id=__codelineno-414-4 name=__codelineno-414-4 href=#__codelineno-414-4></a>
<a id=__codelineno-414-5 name=__codelineno-414-5 href=#__codelineno-414-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>fail</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;Bailing out. this play requires &#39;bar&#39;&quot;</span>
<a id=__codelineno-414-6 name=__codelineno-414-6 href=#__codelineno-414-6></a><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bar is undefined</span>
</code></pre></div> <h4 id=与循环一起使用>与循环一起使用<a class=headerlink href=#与循环一起使用 title="Permanent link">&para;</a></h4> <p>依次遍历列表，当列表里得数字大于5时执行任务</p> <div class=highlight><pre><span></span><code><a id=__codelineno-415-1 name=__codelineno-415-1 href=#__codelineno-415-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-415-2 name=__codelineno-415-2 href=#__codelineno-415-2></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo {{ item }}</span>
<a id=__codelineno-415-3 name=__codelineno-415-3 href=#__codelineno-415-3></a><span class=w>      </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=nv>0</span><span class="p p-Indicator">,</span><span class=w> </span><span class=nv>2</span><span class="p p-Indicator">,</span><span class=w> </span><span class=nv>4</span><span class="p p-Indicator">,</span><span class=w> </span><span class=nv>6</span><span class="p p-Indicator">,</span><span class=w> </span><span class=nv>8</span><span class="p p-Indicator">,</span><span class=w> </span><span class=nv>10</span><span class=w> </span><span class="p p-Indicator">]</span>
<a id=__codelineno-415-4 name=__codelineno-415-4 href=#__codelineno-415-4></a><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">item &gt; 5</span>
</code></pre></div> <p>当变量不存在时，直接跳过</p> <div class=highlight><pre><span></span><code><a id=__codelineno-416-1 name=__codelineno-416-1 href=#__codelineno-416-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo {{ item }}</span>
<a id=__codelineno-416-2 name=__codelineno-416-2 href=#__codelineno-416-2></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>mylist</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>default([])</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-416-3 name=__codelineno-416-3 href=#__codelineno-416-3></a><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">item &gt; 5</span>
</code></pre></div> <p>如果变量是字典</p> <div class=highlight><pre><span></span><code><a id=__codelineno-417-1 name=__codelineno-417-1 href=#__codelineno-417-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo {{ item.key }}</span>
<a id=__codelineno-417-2 name=__codelineno-417-2 href=#__codelineno-417-2></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>query(&#39;dict&#39;,</span><span class=nv> </span><span class=s>mydict|default({}))</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-417-3 name=__codelineno-417-3 href=#__codelineno-417-3></a><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">item.value &gt; 5</span>
</code></pre></div> <h4 id=使用自定义的facts值做判断>使用自定义的facts值做判断<a class=headerlink href=#使用自定义的facts值做判断 title="Permanent link">&para;</a></h4> <p>你可以开发一个模块来设置facts数据，并将其作为变量结果返回，后续的任务就可以使用这个变量了。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-418-1 name=__codelineno-418-1 href=#__codelineno-418-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-418-2 name=__codelineno-418-2 href=#__codelineno-418-2></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gather site specific fact data</span>
<a id=__codelineno-418-3 name=__codelineno-418-3 href=#__codelineno-418-3></a><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">site_facts</span>
<a id=__codelineno-418-4 name=__codelineno-418-4 href=#__codelineno-418-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/thingy</span>
<a id=__codelineno-418-5 name=__codelineno-418-5 href=#__codelineno-418-5></a><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my_custom_fact_just_retrieved_from_the_remote_system == &#39;1234&#39;</span>
</code></pre></div> <h4 id=角色包含使使用when>角色包含使使用when<a class=headerlink href=#角色包含使使用when title="Permanent link">&para;</a></h4> <p>如果您有多个任务都共享同一个条件语句，则可以将该条件附加到task include语句上，如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-419-1 name=__codelineno-419-1 href=#__codelineno-419-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>import_tasks</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">tasks/sometasks.yml</span>
<a id=__codelineno-419-2 name=__codelineno-419-2 href=#__codelineno-419-2></a><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=s>&quot;&#39;reticulating</span><span class=nv> </span><span class=s>splines&#39;</span><span class=nv> </span><span class=s>in</span><span class=nv> </span><span class=s>output&quot;</span>
</code></pre></div> <p>使用在角色上</p> <div class=highlight><pre><span></span><code><a id=__codelineno-420-1 name=__codelineno-420-1 href=#__codelineno-420-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-420-2 name=__codelineno-420-2 href=#__codelineno-420-2></a><span class=w>  </span><span class=nt>roles</span><span class=p>:</span>
<a id=__codelineno-420-3 name=__codelineno-420-3 href=#__codelineno-420-3></a><span class=w>     </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">debian_stock_config</span>
<a id=__codelineno-420-4 name=__codelineno-420-4 href=#__codelineno-420-4></a><span class=w>       </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ansible_facts[&#39;os_family&#39;] == &#39;Debian&#39;</span>
</code></pre></div> <blockquote> <p>当条件句与<code>include*</code>任务一起使用时，它仅应用于包含任务本身，而不应用于包含文件中的任何其他任务。 </p> </blockquote> <h4 id=有条件的导入>有条件的导入<a class=headerlink href=#有条件的导入 title="Permanent link">&para;</a></h4> <p>有时你会想要根据特定的标准在剧本中做一些不同的事情 。拥有一个适用于多个平台和操作系统版本的剧本就是一个很好的例子。 </p> <p>例如，Apache包的名称在CentOS和Debian之间不同，但是在Ansible Playbook中， 你可以用最简洁的语法来处理这个</p> <div class=highlight><pre><span></span><code><a id=__codelineno-421-1 name=__codelineno-421-1 href=#__codelineno-421-1></a><span class=nn>---</span>
<a id=__codelineno-421-2 name=__codelineno-421-2 href=#__codelineno-421-2></a><span class=c1># for vars/RedHat.yml</span>
<a id=__codelineno-421-3 name=__codelineno-421-3 href=#__codelineno-421-3></a><span class=nt>apache</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id=__codelineno-421-4 name=__codelineno-421-4 href=#__codelineno-421-4></a><span class=nt>somethingelse</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">42</span>
<a id=__codelineno-421-5 name=__codelineno-421-5 href=#__codelineno-421-5></a><span class=nn>---</span>
<a id=__codelineno-421-6 name=__codelineno-421-6 href=#__codelineno-421-6></a><span class=c1># for vars/Debian.yml</span>
<a id=__codelineno-421-7 name=__codelineno-421-7 href=#__codelineno-421-7></a><span class=nt>apache</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apache2</span>
<a id=__codelineno-421-8 name=__codelineno-421-8 href=#__codelineno-421-8></a><span class=nt>somethingelse</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">42</span>
<a id=__codelineno-421-9 name=__codelineno-421-9 href=#__codelineno-421-9></a>
<a id=__codelineno-421-10 name=__codelineno-421-10 href=#__codelineno-421-10></a><span class=nn>---</span>
<a id=__codelineno-421-11 name=__codelineno-421-11 href=#__codelineno-421-11></a><span class=c1># for playbook.yml</span>
<a id=__codelineno-421-12 name=__codelineno-421-12 href=#__codelineno-421-12></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
<a id=__codelineno-421-13 name=__codelineno-421-13 href=#__codelineno-421-13></a><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<a id=__codelineno-421-14 name=__codelineno-421-14 href=#__codelineno-421-14></a><span class=w>  </span><span class=nt>vars_files</span><span class=p>:</span>
<a id=__codelineno-421-15 name=__codelineno-421-15 href=#__codelineno-421-15></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;vars/common.yml&quot;</span>
<a id=__codelineno-421-16 name=__codelineno-421-16 href=#__codelineno-421-16></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>&quot;vars/{{</span><span class=nv> </span><span class=s>ansible_facts[&#39;os_family&#39;]</span><span class=nv> </span><span class=s>}}.yml&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;vars/os_defaults.yml&quot;</span><span class=w> </span><span class="p p-Indicator">]</span>
<a id=__codelineno-421-17 name=__codelineno-421-17 href=#__codelineno-421-17></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-421-18 name=__codelineno-421-18 href=#__codelineno-421-18></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">make sure apache is started</span>
<a id=__codelineno-421-19 name=__codelineno-421-19 href=#__codelineno-421-19></a><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">name={{ apache }} state=started</span>
</code></pre></div> <blockquote> <p>ansible_facts['os_family'] 来确定执行的主机系统</p> </blockquote> <h4 id=基于变量选择文件和模板>基于变量选择文件和模板<a class=headerlink href=#基于变量选择文件和模板 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-422-1 name=__codelineno-422-1 href=#__codelineno-422-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">template a file</span>
<a id=__codelineno-422-2 name=__codelineno-422-2 href=#__codelineno-422-2></a><span class=w>  </span><span class=nt>template</span><span class=p>:</span>
<a id=__codelineno-422-3 name=__codelineno-422-3 href=#__codelineno-422-3></a><span class=w>      </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-422-4 name=__codelineno-422-4 href=#__codelineno-422-4></a><span class=w>      </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/etc/myapp/foo.conf</span>
<a id=__codelineno-422-5 name=__codelineno-422-5 href=#__codelineno-422-5></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>query(&#39;first_found&#39;,</span><span class=nv> </span><span class=s>{</span><span class=nv> </span><span class=s>&#39;files&#39;:</span><span class=nv> </span><span class=s>myfiles,</span><span class=nv> </span><span class=s>&#39;paths&#39;:</span><span class=nv> </span><span class=s>mypaths})</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-422-6 name=__codelineno-422-6 href=#__codelineno-422-6></a><span class=w>  </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-422-7 name=__codelineno-422-7 href=#__codelineno-422-7></a><span class=w>    </span><span class=nt>myfiles</span><span class=p>:</span>
<a id=__codelineno-422-8 name=__codelineno-422-8 href=#__codelineno-422-8></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{ansible_facts[&#39;distribution&#39;]}}.conf&quot;</span>
<a id=__codelineno-422-9 name=__codelineno-422-9 href=#__codelineno-422-9></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">default.conf</span>
<a id=__codelineno-422-10 name=__codelineno-422-10 href=#__codelineno-422-10></a><span class=w>    </span><span class=nt>mypaths</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&#39;search_location_one/somedir/&#39;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&#39;/opt/other_location/somedir/&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div> <h4 id=使用注册变量判断>使用注册变量判断<a class=headerlink href=#使用注册变量判断 title="Permanent link">&para;</a></h4> <p>将给定命令的结果存储在变量中， 并在后续的任务中使用。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-423-1 name=__codelineno-423-1 href=#__codelineno-423-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test play</span>
<a id=__codelineno-423-2 name=__codelineno-423-2 href=#__codelineno-423-2></a><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
<a id=__codelineno-423-3 name=__codelineno-423-3 href=#__codelineno-423-3></a>
<a id=__codelineno-423-4 name=__codelineno-423-4 href=#__codelineno-423-4></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-423-5 name=__codelineno-423-5 href=#__codelineno-423-5></a>
<a id=__codelineno-423-6 name=__codelineno-423-6 href=#__codelineno-423-6></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cat /etc/motd</span>
<a id=__codelineno-423-7 name=__codelineno-423-7 href=#__codelineno-423-7></a><span class=w>        </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">motd_contents</span>
<a id=__codelineno-423-8 name=__codelineno-423-8 href=#__codelineno-423-8></a>
<a id=__codelineno-423-9 name=__codelineno-423-9 href=#__codelineno-423-9></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;motd contains the word hi&quot;</span>
<a id=__codelineno-423-10 name=__codelineno-423-10 href=#__codelineno-423-10></a><span class=w>        </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">motd_contents.stdout.find(&#39;hi&#39;) != -1</span>
</code></pre></div> <p>如果注册的结果被转换为列表(或者已经是列表)，则可以在任务的循环中使用 。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-424-1 name=__codelineno-424-1 href=#__codelineno-424-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">registered variable usage as a loop list</span>
<a id=__codelineno-424-2 name=__codelineno-424-2 href=#__codelineno-424-2></a><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
<a id=__codelineno-424-3 name=__codelineno-424-3 href=#__codelineno-424-3></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-424-4 name=__codelineno-424-4 href=#__codelineno-424-4></a>
<a id=__codelineno-424-5 name=__codelineno-424-5 href=#__codelineno-424-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">retrieve the list of home directories</span>
<a id=__codelineno-424-6 name=__codelineno-424-6 href=#__codelineno-424-6></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ls /home</span>
<a id=__codelineno-424-7 name=__codelineno-424-7 href=#__codelineno-424-7></a><span class=w>      </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">home_dirs</span>
<a id=__codelineno-424-8 name=__codelineno-424-8 href=#__codelineno-424-8></a>
<a id=__codelineno-424-9 name=__codelineno-424-9 href=#__codelineno-424-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">add home dirs to the backup spooler</span>
<a id=__codelineno-424-10 name=__codelineno-424-10 href=#__codelineno-424-10></a><span class=w>      </span><span class=nt>file</span><span class=p>:</span>
<a id=__codelineno-424-11 name=__codelineno-424-11 href=#__codelineno-424-11></a><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/mnt/bkspool/{{ item }}</span>
<a id=__codelineno-424-12 name=__codelineno-424-12 href=#__codelineno-424-12></a><span class=w>        </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/home/{{ item }}</span>
<a id=__codelineno-424-13 name=__codelineno-424-13 href=#__codelineno-424-13></a><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">link</span>
<a id=__codelineno-424-14 name=__codelineno-424-14 href=#__codelineno-424-14></a><span class=w>      </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>home_dirs.stdout_lines</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-424-15 name=__codelineno-424-15 href=#__codelineno-424-15></a><span class=w>      </span><span class=c1># same as loop: &quot;{{ home_dirs.stdout.split() }}&quot;### </span>
</code></pre></div> <h4 id=failed_when>failed_when<a class=headerlink href=#failed_when title="Permanent link">&para;</a></h4> <p>满足给定的条件时，使任务失败</p> <div class=highlight><pre><span></span><code><a id=__codelineno-425-1 name=__codelineno-425-1 href=#__codelineno-425-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-425-2 name=__codelineno-425-2 href=#__codelineno-425-2></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo faild.</span>
<a id=__codelineno-425-3 name=__codelineno-425-3 href=#__codelineno-425-3></a><span class=w>      </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">command_result</span>
<a id=__codelineno-425-4 name=__codelineno-425-4 href=#__codelineno-425-4></a><span class=w>      </span><span class=nt>failed_when</span><span class=p>:</span><span class=w> </span><span class=s>&quot;&#39;faild&#39;</span><span class=nv> </span><span class=s>in</span><span class=nv> </span><span class=s>command_result.stdout&quot;</span>
<a id=__codelineno-425-5 name=__codelineno-425-5 href=#__codelineno-425-5></a>
<a id=__codelineno-425-6 name=__codelineno-425-6 href=#__codelineno-425-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;echo test&quot;</span>
</code></pre></div> <p>还可以写成这样</p> <div class=highlight><pre><span></span><code><a id=__codelineno-426-1 name=__codelineno-426-1 href=#__codelineno-426-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-426-2 name=__codelineno-426-2 href=#__codelineno-426-2></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo faild.</span>
<a id=__codelineno-426-3 name=__codelineno-426-3 href=#__codelineno-426-3></a><span class=w>      </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">command_result</span>
<a id=__codelineno-426-4 name=__codelineno-426-4 href=#__codelineno-426-4></a><span class=w>      </span><span class=nt>ignore_errors</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<a id=__codelineno-426-5 name=__codelineno-426-5 href=#__codelineno-426-5></a>
<a id=__codelineno-426-6 name=__codelineno-426-6 href=#__codelineno-426-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fail the echo</span>
<a id=__codelineno-426-7 name=__codelineno-426-7 href=#__codelineno-426-7></a><span class=w>      </span><span class=nt>fail</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;the command failed&quot;</span>
<a id=__codelineno-426-8 name=__codelineno-426-8 href=#__codelineno-426-8></a><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=s>&quot;&#39;faild&#39;</span><span class=nv> </span><span class=s>in</span><span class=nv> </span><span class=s>command_result.stdout&quot;</span>
<a id=__codelineno-426-9 name=__codelineno-426-9 href=#__codelineno-426-9></a>
<a id=__codelineno-426-10 name=__codelineno-426-10 href=#__codelineno-426-10></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;echo test&quot;</span>
</code></pre></div> <blockquote> <p>fail 模块是产生一个错误信息</p> </blockquote> <h4 id=changed_when>changed_when<a class=headerlink href=#changed_when title="Permanent link">&para;</a></h4> <p>如果说一个命令没有更改任何事物，就可以为其设置为没有更改状态</p> <div class=highlight><pre><span></span><code><a id=__codelineno-427-1 name=__codelineno-427-1 href=#__codelineno-427-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-427-2 name=__codelineno-427-2 href=#__codelineno-427-2></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies via Composer.</span>
<a id=__codelineno-427-3 name=__codelineno-427-3 href=#__codelineno-427-3></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=s>&quot;/usr/local/bin/composer</span><span class=nv> </span><span class=s>global</span><span class=nv> </span><span class=s>require</span><span class=nv> </span><span class=s>phpunit/phpunit</span><span class=nv> </span><span class=s>--prefer-dist&quot;</span>
<a id=__codelineno-427-4 name=__codelineno-427-4 href=#__codelineno-427-4></a><span class=w>      </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">composer</span>
<a id=__codelineno-427-5 name=__codelineno-427-5 href=#__codelineno-427-5></a><span class=w>      </span><span class=nt>changed_when</span><span class=p>:</span><span class=w> </span><span class=s>&quot;&#39;Nothing</span><span class=nv> </span><span class=s>to</span><span class=nv> </span><span class=s>install</span><span class=nv> </span><span class=s>or</span><span class=nv> </span><span class=s>update&#39;</span><span class=nv> </span><span class=s>not</span><span class=nv> </span><span class=s>in</span><span class=nv> </span><span class=s>composer.stdout&quot;</span>
</code></pre></div> <h3 id=循环>循环<a class=headerlink href=#循环 title="Permanent link">&para;</a></h3> <p>有时你想要重复一个任务多次。在计算机编程中，这叫做循环， Ansible提供了两个用于创建循环的关键字：<code>loop</code>和<code>with_&lt;lookup&gt;</code>。 </p> <ul> <li>我们在Ansible 2.5中添加了<code>loop</code>。它还不是<code>with_&lt;lookup&gt;</code>的完整替代品，但是我们建议在大多数用例中使用它。 </li> <li>我们并没有反对使用<code>with_&lt;lookup&gt;</code>—在可预见的将来，该语法仍然有效。</li> <li>我们一直在改进<code>loop</code>语法，请注意修改日志。</li> </ul> <h4 id=比较loop-和-with_>比较<code>loop</code> 和 <code>with_*</code><a class=headerlink href=#比较loop-和-with_ title="Permanent link">&para;</a></h4> <ul> <li><code>with_&lt;lookup&gt;</code>关键字依赖于<code>Lookup</code>插件</li> <li><code>loop</code>关键字相当于<code>with_list</code>，是简单循环的最佳选择。</li> <li><code>loop</code>关键字不会接受字符串作为输入 </li> <li>一般来说, 所有<code>with_*</code>的使用，都可以使用<code>loop</code>替代</li> <li>使用<code>with_items</code>时要注意， 因为<code>with_items</code>会执行隐式单级展平。 您可能需要使用带有循环的flatten(1)来匹配确切的结果。</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-428-1 name=__codelineno-428-1 href=#__codelineno-428-1></a>with_items:
<a id=__codelineno-428-2 name=__codelineno-428-2 href=#__codelineno-428-2></a>  - 1
<a id=__codelineno-428-3 name=__codelineno-428-3 href=#__codelineno-428-3></a>  - [2,3]
<a id=__codelineno-428-4 name=__codelineno-428-4 href=#__codelineno-428-4></a>  - 4
</code></pre></div> <p>使用loop表达</p> <div class=highlight><pre><span></span><code><a id=__codelineno-429-1 name=__codelineno-429-1 href=#__codelineno-429-1></a><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>[1,</span><span class=nv> </span><span class=s>[2,3]</span><span class=nv> </span><span class=s>,4]</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>flatten(1)</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <ul> <li>在使用查找的功能时, 都不应该将<code>with_*</code>转换成<code>loop</code></li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-430-1 name=__codelineno-430-1 href=#__codelineno-430-1></a><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>lookup(&#39;fileglob&#39;,</span><span class=nv> </span><span class=s>&#39;*.txt&#39;,</span><span class=nv> </span><span class=s>wantlist=True)</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <p>使用<code>with_*</code>可以很简洁的表达</p> <div class=highlight><pre><span></span><code><a id=__codelineno-431-1 name=__codelineno-431-1 href=#__codelineno-431-1></a><span class=nt>with_fileglob</span><span class=p>:</span><span class=w> </span><span class=s>&#39;*.txt&#39;</span>
</code></pre></div> <h4 id=标准循环>标准循环<a class=headerlink href=#标准循环 title="Permanent link">&para;</a></h4> <h5 id=遍历列表>遍历列表<a class=headerlink href=#遍历列表 title="Permanent link">&para;</a></h5> <p>添加多个用户</p> <div class=highlight><pre><span></span><code><a id=__codelineno-432-1 name=__codelineno-432-1 href=#__codelineno-432-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">add several users</span>
<a id=__codelineno-432-2 name=__codelineno-432-2 href=#__codelineno-432-2></a><span class=w>  </span><span class=nt>user</span><span class=p>:</span>
<a id=__codelineno-432-3 name=__codelineno-432-3 href=#__codelineno-432-3></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-432-4 name=__codelineno-432-4 href=#__codelineno-432-4></a><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id=__codelineno-432-5 name=__codelineno-432-5 href=#__codelineno-432-5></a><span class=w>    </span><span class=nt>groups</span><span class=p>:</span><span class=w> </span><span class=s>&quot;wheel&quot;</span>
<a id=__codelineno-432-6 name=__codelineno-432-6 href=#__codelineno-432-6></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span>
<a id=__codelineno-432-7 name=__codelineno-432-7 href=#__codelineno-432-7></a><span class=w>     </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">testuser1</span>
<a id=__codelineno-432-8 name=__codelineno-432-8 href=#__codelineno-432-8></a><span class=w>     </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">testuser2</span>
</code></pre></div> <p>也可以直接引用变量列表</p> <div class=highlight><pre><span></span><code><a id=__codelineno-433-1 name=__codelineno-433-1 href=#__codelineno-433-1></a><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>somelist</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <p>这两个例子等价于</p> <div class=highlight><pre><span></span><code><a id=__codelineno-434-1 name=__codelineno-434-1 href=#__codelineno-434-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">add user testuser1</span>
<a id=__codelineno-434-2 name=__codelineno-434-2 href=#__codelineno-434-2></a><span class=w>  </span><span class=nt>user</span><span class=p>:</span>
<a id=__codelineno-434-3 name=__codelineno-434-3 href=#__codelineno-434-3></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;testuser1&quot;</span>
<a id=__codelineno-434-4 name=__codelineno-434-4 href=#__codelineno-434-4></a><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id=__codelineno-434-5 name=__codelineno-434-5 href=#__codelineno-434-5></a><span class=w>    </span><span class=nt>groups</span><span class=p>:</span><span class=w> </span><span class=s>&quot;wheel&quot;</span>
<a id=__codelineno-434-6 name=__codelineno-434-6 href=#__codelineno-434-6></a>
<a id=__codelineno-434-7 name=__codelineno-434-7 href=#__codelineno-434-7></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">add user testuser2</span>
<a id=__codelineno-434-8 name=__codelineno-434-8 href=#__codelineno-434-8></a><span class=w>  </span><span class=nt>user</span><span class=p>:</span>
<a id=__codelineno-434-9 name=__codelineno-434-9 href=#__codelineno-434-9></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;testuser2&quot;</span>
<a id=__codelineno-434-10 name=__codelineno-434-10 href=#__codelineno-434-10></a><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id=__codelineno-434-11 name=__codelineno-434-11 href=#__codelineno-434-11></a><span class=w>    </span><span class=nt>groups</span><span class=p>:</span><span class=w> </span><span class=s>&quot;wheel&quot;</span>
</code></pre></div> <p>有时，如果模块可以接受列表的话，就不需要使用循环来传递。例如yum包管理的</p> <div class=highlight><pre><span></span><code><a id=__codelineno-435-1 name=__codelineno-435-1 href=#__codelineno-435-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">optimal yum</span>
<a id=__codelineno-435-2 name=__codelineno-435-2 href=#__codelineno-435-2></a><span class=w>  </span><span class=nt>yum</span><span class=p>:</span>
<a id=__codelineno-435-3 name=__codelineno-435-3 href=#__codelineno-435-3></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv>  </span><span class=s>list_of_packages</span><span class=nv>  </span><span class=s>}}&quot;</span>
<a id=__codelineno-435-4 name=__codelineno-435-4 href=#__codelineno-435-4></a><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id=__codelineno-435-5 name=__codelineno-435-5 href=#__codelineno-435-5></a>
<a id=__codelineno-435-6 name=__codelineno-435-6 href=#__codelineno-435-6></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">non-optimal yum, slower and may cause issues with interdependencies</span>
<a id=__codelineno-435-7 name=__codelineno-435-7 href=#__codelineno-435-7></a><span class=w>  </span><span class=nt>yum</span><span class=p>:</span>
<a id=__codelineno-435-8 name=__codelineno-435-8 href=#__codelineno-435-8></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv>  </span><span class=s>item</span><span class=nv>  </span><span class=s>}}&quot;</span>
<a id=__codelineno-435-9 name=__codelineno-435-9 href=#__codelineno-435-9></a><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id=__codelineno-435-10 name=__codelineno-435-10 href=#__codelineno-435-10></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv>  </span><span class=s>list_of_packages</span><span class=nv>  </span><span class=s>}}&quot;</span>
</code></pre></div> <h5 id=遍历散列列表>遍历散列列表<a class=headerlink href=#遍历散列列表 title="Permanent link">&para;</a></h5> <p>如果你有一个散列列表，可以在循环中引用子键。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-436-1 name=__codelineno-436-1 href=#__codelineno-436-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">add several users</span>
<a id=__codelineno-436-2 name=__codelineno-436-2 href=#__codelineno-436-2></a><span class=w>  </span><span class=nt>user</span><span class=p>:</span>
<a id=__codelineno-436-3 name=__codelineno-436-3 href=#__codelineno-436-3></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.name</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-436-4 name=__codelineno-436-4 href=#__codelineno-436-4></a><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id=__codelineno-436-5 name=__codelineno-436-5 href=#__codelineno-436-5></a><span class=w>    </span><span class=nt>groups</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.groups</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-436-6 name=__codelineno-436-6 href=#__codelineno-436-6></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span>
<a id=__codelineno-436-7 name=__codelineno-436-7 href=#__codelineno-436-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="p p-Indicator">{</span><span class=nt> name</span><span class=p>:</span><span class=w> </span><span class=s>&#39;testuser1&#39;</span><span class="p p-Indicator">,</span><span class=nt> groups</span><span class=p>:</span><span class=w> </span><span class=s>&#39;wheel&#39;</span><span class=w> </span><span class="p p-Indicator">}</span>
<a id=__codelineno-436-8 name=__codelineno-436-8 href=#__codelineno-436-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="p p-Indicator">{</span><span class=nt> name</span><span class=p>:</span><span class=w> </span><span class=s>&#39;testuser2&#39;</span><span class="p p-Indicator">,</span><span class=nt> groups</span><span class=p>:</span><span class=w> </span><span class=s>&#39;root&#39;</span><span class=w> </span><span class="p p-Indicator">}</span>
</code></pre></div> <blockquote> <p>添加多个用户，并将用户加入不同的组内。</p> </blockquote> <h5 id=遍历字典>遍历字典<a class=headerlink href=#遍历字典 title="Permanent link">&para;</a></h5> <p>要遍历字典，请使用<code>dict2items</code>过滤器将字典转换成散列：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-437-1 name=__codelineno-437-1 href=#__codelineno-437-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">create a tag dictionary of non-empty tags</span>
<a id=__codelineno-437-2 name=__codelineno-437-2 href=#__codelineno-437-2></a><span class=w>  </span><span class=nt>set_fact</span><span class=p>:</span>
<a id=__codelineno-437-3 name=__codelineno-437-3 href=#__codelineno-437-3></a><span class=w>    </span><span class=nt>tags_dict</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>(tags_dict|default({}))|combine({item.key:</span><span class=nv> </span><span class=s>item.value})</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-437-4 name=__codelineno-437-4 href=#__codelineno-437-4></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>tags|dict2items</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-437-5 name=__codelineno-437-5 href=#__codelineno-437-5></a><span class=w>  </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-437-6 name=__codelineno-437-6 href=#__codelineno-437-6></a><span class=w>    </span><span class=nt>tags</span><span class=p>:</span>
<a id=__codelineno-437-7 name=__codelineno-437-7 href=#__codelineno-437-7></a><span class=w>      </span><span class=nt>Environment</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dev</span>
<a id=__codelineno-437-8 name=__codelineno-437-8 href=#__codelineno-437-8></a><span class=w>      </span><span class=nt>Application</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">payment</span>
<a id=__codelineno-437-9 name=__codelineno-437-9 href=#__codelineno-437-9></a><span class=w>      </span><span class=nt>Another</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>doesnotexist</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>default()</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-437-10 name=__codelineno-437-10 href=#__codelineno-437-10></a><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">item.value != &quot;&quot;</span>
</code></pre></div> <blockquote> <p>default() 可以在变量未定义的时候为其设置一个默认值。</p> </blockquote> <h5 id=循环中注册变量>循环中注册变量<a class=headerlink href=#循环中注册变量 title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-438-1 name=__codelineno-438-1 href=#__codelineno-438-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s>&quot;echo</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-438-2 name=__codelineno-438-2 href=#__codelineno-438-2></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span>
<a id=__codelineno-438-3 name=__codelineno-438-3 href=#__codelineno-438-3></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;one&quot;</span>
<a id=__codelineno-438-4 name=__codelineno-438-4 href=#__codelineno-438-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;two&quot;</span>
<a id=__codelineno-438-5 name=__codelineno-438-5 href=#__codelineno-438-5></a><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo</span>
</code></pre></div> <p>当您在循环中使用register时，放在变量中的数据结构将包含一个results属性，该属性是来自模块的所有执行的列表。这与不使用循环使用register时返回的数据结构不同</p> <div class=highlight><pre><span></span><code><a id=__codelineno-439-1 name=__codelineno-439-1 href=#__codelineno-439-1></a><span class=p>{</span>
<a id=__codelineno-439-2 name=__codelineno-439-2 href=#__codelineno-439-2></a><span class=w>    </span><span class=nt>&quot;changed&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-3 name=__codelineno-439-3 href=#__codelineno-439-3></a><span class=w>    </span><span class=nt>&quot;msg&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;All items completed&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-4 name=__codelineno-439-4 href=#__codelineno-439-4></a><span class=w>    </span><span class=nt>&quot;results&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-439-5 name=__codelineno-439-5 href=#__codelineno-439-5></a><span class=w>        </span><span class=p>{</span>
<a id=__codelineno-439-6 name=__codelineno-439-6 href=#__codelineno-439-6></a><span class=w>            </span><span class=nt>&quot;ansible_loop_var&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;item&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-7 name=__codelineno-439-7 href=#__codelineno-439-7></a><span class=w>            </span><span class=nt>&quot;changed&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-8 name=__codelineno-439-8 href=#__codelineno-439-8></a><span class=w>            </span><span class=nt>&quot;cmd&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;echo one&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-9 name=__codelineno-439-9 href=#__codelineno-439-9></a><span class=w>            </span><span class=nt>&quot;delta&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;0:00:00.003978&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-10 name=__codelineno-439-10 href=#__codelineno-439-10></a><span class=w>            </span><span class=nt>&quot;end&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2020-03-30 21:13:24.329114&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-11 name=__codelineno-439-11 href=#__codelineno-439-11></a><span class=w>            </span><span class=nt>&quot;failed&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-12 name=__codelineno-439-12 href=#__codelineno-439-12></a><span class=w>            </span><span class=nt>&quot;invocation&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-439-13 name=__codelineno-439-13 href=#__codelineno-439-13></a><span class=w>                </span><span class=nt>&quot;module_args&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-439-14 name=__codelineno-439-14 href=#__codelineno-439-14></a><span class=w>                    </span><span class=nt>&quot;_raw_params&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;echo one&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-15 name=__codelineno-439-15 href=#__codelineno-439-15></a><span class=w>                    </span><span class=nt>&quot;_uses_shell&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-16 name=__codelineno-439-16 href=#__codelineno-439-16></a><span class=w>                    </span><span class=nt>&quot;argv&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-17 name=__codelineno-439-17 href=#__codelineno-439-17></a><span class=w>                    </span><span class=nt>&quot;chdir&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-18 name=__codelineno-439-18 href=#__codelineno-439-18></a><span class=w>                    </span><span class=nt>&quot;creates&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-19 name=__codelineno-439-19 href=#__codelineno-439-19></a><span class=w>                    </span><span class=nt>&quot;executable&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-20 name=__codelineno-439-20 href=#__codelineno-439-20></a><span class=w>                    </span><span class=nt>&quot;removes&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-21 name=__codelineno-439-21 href=#__codelineno-439-21></a><span class=w>                    </span><span class=nt>&quot;stdin&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-22 name=__codelineno-439-22 href=#__codelineno-439-22></a><span class=w>                    </span><span class=nt>&quot;stdin_add_newline&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-23 name=__codelineno-439-23 href=#__codelineno-439-23></a><span class=w>                    </span><span class=nt>&quot;strip_empty_ends&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-24 name=__codelineno-439-24 href=#__codelineno-439-24></a><span class=w>                    </span><span class=nt>&quot;warn&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span>
<a id=__codelineno-439-25 name=__codelineno-439-25 href=#__codelineno-439-25></a><span class=w>                </span><span class=p>}</span>
<a id=__codelineno-439-26 name=__codelineno-439-26 href=#__codelineno-439-26></a><span class=w>            </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-439-27 name=__codelineno-439-27 href=#__codelineno-439-27></a><span class=w>            </span><span class=nt>&quot;item&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;one&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-28 name=__codelineno-439-28 href=#__codelineno-439-28></a><span class=w>            </span><span class=nt>&quot;rc&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-29 name=__codelineno-439-29 href=#__codelineno-439-29></a><span class=w>            </span><span class=nt>&quot;start&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2020-03-30 21:13:24.325136&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-30 name=__codelineno-439-30 href=#__codelineno-439-30></a><span class=w>            </span><span class=nt>&quot;stderr&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-31 name=__codelineno-439-31 href=#__codelineno-439-31></a><span class=w>            </span><span class=nt>&quot;stderr_lines&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-439-32 name=__codelineno-439-32 href=#__codelineno-439-32></a><span class=w>            </span><span class=nt>&quot;stdout&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;one&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-33 name=__codelineno-439-33 href=#__codelineno-439-33></a><span class=w>            </span><span class=nt>&quot;stdout_lines&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-439-34 name=__codelineno-439-34 href=#__codelineno-439-34></a><span class=w>                </span><span class=s2>&quot;one&quot;</span>
<a id=__codelineno-439-35 name=__codelineno-439-35 href=#__codelineno-439-35></a><span class=w>            </span><span class=p>]</span>
<a id=__codelineno-439-36 name=__codelineno-439-36 href=#__codelineno-439-36></a><span class=w>        </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-439-37 name=__codelineno-439-37 href=#__codelineno-439-37></a><span class=w>        </span><span class=p>{</span>
<a id=__codelineno-439-38 name=__codelineno-439-38 href=#__codelineno-439-38></a><span class=w>            </span><span class=nt>&quot;ansible_loop_var&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;item&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-39 name=__codelineno-439-39 href=#__codelineno-439-39></a><span class=w>            </span><span class=nt>&quot;changed&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-40 name=__codelineno-439-40 href=#__codelineno-439-40></a><span class=w>            </span><span class=nt>&quot;cmd&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;echo two&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-41 name=__codelineno-439-41 href=#__codelineno-439-41></a><span class=w>            </span><span class=nt>&quot;delta&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;0:00:00.003879&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-42 name=__codelineno-439-42 href=#__codelineno-439-42></a><span class=w>            </span><span class=nt>&quot;end&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2020-03-30 21:13:24.621379&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-43 name=__codelineno-439-43 href=#__codelineno-439-43></a><span class=w>            </span><span class=nt>&quot;failed&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-44 name=__codelineno-439-44 href=#__codelineno-439-44></a><span class=w>            </span><span class=nt>&quot;invocation&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-439-45 name=__codelineno-439-45 href=#__codelineno-439-45></a><span class=w>                </span><span class=nt>&quot;module_args&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-439-46 name=__codelineno-439-46 href=#__codelineno-439-46></a><span class=w>                    </span><span class=nt>&quot;_raw_params&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;echo two&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-47 name=__codelineno-439-47 href=#__codelineno-439-47></a><span class=w>                    </span><span class=nt>&quot;_uses_shell&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-48 name=__codelineno-439-48 href=#__codelineno-439-48></a><span class=w>                    </span><span class=nt>&quot;argv&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-49 name=__codelineno-439-49 href=#__codelineno-439-49></a><span class=w>                    </span><span class=nt>&quot;chdir&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-50 name=__codelineno-439-50 href=#__codelineno-439-50></a><span class=w>                    </span><span class=nt>&quot;creates&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-51 name=__codelineno-439-51 href=#__codelineno-439-51></a><span class=w>                    </span><span class=nt>&quot;executable&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-52 name=__codelineno-439-52 href=#__codelineno-439-52></a><span class=w>                    </span><span class=nt>&quot;removes&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-53 name=__codelineno-439-53 href=#__codelineno-439-53></a><span class=w>                    </span><span class=nt>&quot;stdin&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-54 name=__codelineno-439-54 href=#__codelineno-439-54></a><span class=w>                    </span><span class=nt>&quot;stdin_add_newline&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-55 name=__codelineno-439-55 href=#__codelineno-439-55></a><span class=w>                    </span><span class=nt>&quot;strip_empty_ends&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-56 name=__codelineno-439-56 href=#__codelineno-439-56></a><span class=w>                    </span><span class=nt>&quot;warn&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span>
<a id=__codelineno-439-57 name=__codelineno-439-57 href=#__codelineno-439-57></a><span class=w>                </span><span class=p>}</span>
<a id=__codelineno-439-58 name=__codelineno-439-58 href=#__codelineno-439-58></a><span class=w>            </span><span class=p>},</span><span class=w> </span>
<a id=__codelineno-439-59 name=__codelineno-439-59 href=#__codelineno-439-59></a><span class=w>            </span><span class=nt>&quot;item&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;two&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-60 name=__codelineno-439-60 href=#__codelineno-439-60></a><span class=w>            </span><span class=nt>&quot;rc&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-61 name=__codelineno-439-61 href=#__codelineno-439-61></a><span class=w>            </span><span class=nt>&quot;start&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2020-03-30 21:13:24.613500&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-62 name=__codelineno-439-62 href=#__codelineno-439-62></a><span class=w>            </span><span class=nt>&quot;stderr&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-63 name=__codelineno-439-63 href=#__codelineno-439-63></a><span class=w>            </span><span class=nt>&quot;stderr_lines&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span><span class=w> </span>
<a id=__codelineno-439-64 name=__codelineno-439-64 href=#__codelineno-439-64></a><span class=w>            </span><span class=nt>&quot;stdout&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;two&quot;</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-439-65 name=__codelineno-439-65 href=#__codelineno-439-65></a><span class=w>            </span><span class=nt>&quot;stdout_lines&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<a id=__codelineno-439-66 name=__codelineno-439-66 href=#__codelineno-439-66></a><span class=w>                </span><span class=s2>&quot;two&quot;</span>
<a id=__codelineno-439-67 name=__codelineno-439-67 href=#__codelineno-439-67></a><span class=w>            </span><span class=p>]</span>
<a id=__codelineno-439-68 name=__codelineno-439-68 href=#__codelineno-439-68></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-439-69 name=__codelineno-439-69 href=#__codelineno-439-69></a><span class=w>    </span><span class=p>]</span>
<a id=__codelineno-439-70 name=__codelineno-439-70 href=#__codelineno-439-70></a><span class=p>}</span>
</code></pre></div> <p>后续使用注册变量来检查命令执行情况</p> <div class=highlight><pre><span></span><code><a id=__codelineno-440-1 name=__codelineno-440-1 href=#__codelineno-440-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Fail if return code is not 0</span>
<a id=__codelineno-440-2 name=__codelineno-440-2 href=#__codelineno-440-2></a><span class=w>  </span><span class=nt>fail</span><span class=p>:</span>
<a id=__codelineno-440-3 name=__codelineno-440-3 href=#__codelineno-440-3></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;The</span><span class=nv> </span><span class=s>command</span><span class=nv> </span><span class=s>({{</span><span class=nv> </span><span class=s>item.cmd</span><span class=nv> </span><span class=s>}})</span><span class=nv> </span><span class=s>did</span><span class=nv> </span><span class=s>not</span><span class=nv> </span><span class=s>have</span><span class=nv> </span><span class=s>a</span><span class=nv> </span><span class=s>0</span><span class=nv> </span><span class=s>return</span><span class=nv> </span><span class=s>code&quot;</span>
<a id=__codelineno-440-4 name=__codelineno-440-4 href=#__codelineno-440-4></a><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">item.rc != 0</span>
<a id=__codelineno-440-5 name=__codelineno-440-5 href=#__codelineno-440-5></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>echo.results</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <p>在循环过程中，也可以使用当前的模块结果</p> <div class=highlight><pre><span></span><code><a id=__codelineno-441-1 name=__codelineno-441-1 href=#__codelineno-441-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo &quot;{{ item }}&quot;</span>
<a id=__codelineno-441-2 name=__codelineno-441-2 href=#__codelineno-441-2></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span>
<a id=__codelineno-441-3 name=__codelineno-441-3 href=#__codelineno-441-3></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">one</span>
<a id=__codelineno-441-4 name=__codelineno-441-4 href=#__codelineno-441-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">two</span>
<a id=__codelineno-441-5 name=__codelineno-441-5 href=#__codelineno-441-5></a><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo</span>
<a id=__codelineno-441-6 name=__codelineno-441-6 href=#__codelineno-441-6></a><span class=w>  </span><span class=nt>changed_when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">echo.stdout != &quot;one&quot;</span>
</code></pre></div> <h4 id=复杂循环>复杂循环<a class=headerlink href=#复杂循环 title="Permanent link">&para;</a></h4> <h5 id=遍历嵌套列表>遍历嵌套列表<a class=headerlink href=#遍历嵌套列表 title="Permanent link">&para;</a></h5> <p>您可以使用Jinja2表达式迭代复杂的列表。例如， 分别给用户授予3个数据库的所有权限</p> <div class=highlight><pre><span></span><code><a id=__codelineno-442-1 name=__codelineno-442-1 href=#__codelineno-442-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">give users access to multiple databases</span>
<a id=__codelineno-442-2 name=__codelineno-442-2 href=#__codelineno-442-2></a><span class=w>  </span><span class=nt>mysql_user</span><span class=p>:</span>
<a id=__codelineno-442-3 name=__codelineno-442-3 href=#__codelineno-442-3></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item[0]</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-442-4 name=__codelineno-442-4 href=#__codelineno-442-4></a><span class=w>    </span><span class=nt>priv</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item[1]</span><span class=nv> </span><span class=s>}}.*:ALL&quot;</span>
<a id=__codelineno-442-5 name=__codelineno-442-5 href=#__codelineno-442-5></a><span class=w>    </span><span class=nt>append_privs</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-442-6 name=__codelineno-442-6 href=#__codelineno-442-6></a><span class=w>    </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=s>&quot;foo&quot;</span>
<a id=__codelineno-442-7 name=__codelineno-442-7 href=#__codelineno-442-7></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>[&#39;alice&#39;,</span><span class=nv> </span><span class=s>&#39;bob&#39;]</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>product([&#39;clientdb&#39;,</span><span class=nv> </span><span class=s>&#39;employeedb&#39;,</span><span class=nv> </span><span class=s>&#39;providerdb&#39;])|list</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <h5 id=在满足条件之前重试任务>在满足条件之前重试任务<a class=headerlink href=#在满足条件之前重试任务 title="Permanent link">&para;</a></h5> <p>可以使用<code>until</code>关键字重试任务，直到满足特定条件。 </p> <div class=highlight><pre><span></span><code><a id=__codelineno-443-1 name=__codelineno-443-1 href=#__codelineno-443-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/foo</span>
<a id=__codelineno-443-2 name=__codelineno-443-2 href=#__codelineno-443-2></a><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">result</span>
<a id=__codelineno-443-3 name=__codelineno-443-3 href=#__codelineno-443-3></a><span class=w>  </span><span class=nt>until</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">result.stdout.find(&quot;all systems go&quot;) != -1</span>
<a id=__codelineno-443-4 name=__codelineno-443-4 href=#__codelineno-443-4></a><span class=w>  </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<a id=__codelineno-443-5 name=__codelineno-443-5 href=#__codelineno-443-5></a><span class=w>  </span><span class=nt>delay</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</code></pre></div> <blockquote> <p>此任务最多运行5次，每次尝试之间的延迟为10秒。如果标准输出中有<code>all systems go</code>字符串，则任务成功。重试的默认值是3，延迟是5。 </p> </blockquote> <h5 id=循环主机清单>循环主机清单<a class=headerlink href=#循环主机清单 title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><a id=__codelineno-444-1 name=__codelineno-444-1 href=#__codelineno-444-1></a><span class=c1># 输出所有主机信息</span>
<a id=__codelineno-444-2 name=__codelineno-444-2 href=#__codelineno-444-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-444-3 name=__codelineno-444-3 href=#__codelineno-444-3></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-444-4 name=__codelineno-444-4 href=#__codelineno-444-4></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>groups[&#39;all&#39;]</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-444-5 name=__codelineno-444-5 href=#__codelineno-444-5></a>
<a id=__codelineno-444-6 name=__codelineno-444-6 href=#__codelineno-444-6></a><span class=c1># 输出当前play运行的主机信息</span>
<a id=__codelineno-444-7 name=__codelineno-444-7 href=#__codelineno-444-7></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-444-8 name=__codelineno-444-8 href=#__codelineno-444-8></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-444-9 name=__codelineno-444-9 href=#__codelineno-444-9></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>ansible_play_batch</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-444-10 name=__codelineno-444-10 href=#__codelineno-444-10></a>
<a id=__codelineno-444-11 name=__codelineno-444-11 href=#__codelineno-444-11></a><span class=c1># 显示清单中的所有主机</span>
<a id=__codelineno-444-12 name=__codelineno-444-12 href=#__codelineno-444-12></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-444-13 name=__codelineno-444-13 href=#__codelineno-444-13></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-444-14 name=__codelineno-444-14 href=#__codelineno-444-14></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>query(&#39;inventory_hostnames&#39;,</span><span class=nv> </span><span class=s>&#39;all&#39;)</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-444-15 name=__codelineno-444-15 href=#__codelineno-444-15></a>
<a id=__codelineno-444-16 name=__codelineno-444-16 href=#__codelineno-444-16></a><span class=c1># 除组www外的所有主机</span>
<a id=__codelineno-444-17 name=__codelineno-444-17 href=#__codelineno-444-17></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-444-18 name=__codelineno-444-18 href=#__codelineno-444-18></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-444-19 name=__codelineno-444-19 href=#__codelineno-444-19></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>query(&#39;inventory_hostnames&#39;,</span><span class=nv> </span><span class=s>&#39;all:!www&#39;)</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <h5 id=使用query还是lookup>使用<code>query</code>还是<code>lookup</code><a class=headerlink href=#使用query还是lookup title="Permanent link">&para;</a></h5> <p>loop关键字需要一个列表作为输入，默认情况下，<code>lookup</code>关键字返回一个逗号分隔的值字符串 ,而<code>query</code>返回的是一个列表。</p> <p>如果使用<code>lookup</code>返回列表，则可以添加<code>wantlist=True</code>强制返回列表。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-445-1 name=__codelineno-445-1 href=#__codelineno-445-1></a><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>query(&#39;inventory_hostnames&#39;,</span><span class=nv> </span><span class=s>&#39;all&#39;)</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-445-2 name=__codelineno-445-2 href=#__codelineno-445-2></a>
<a id=__codelineno-445-3 name=__codelineno-445-3 href=#__codelineno-445-3></a><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>lookup(&#39;inventory_hostnames&#39;,</span><span class=nv> </span><span class=s>&#39;all&#39;,</span><span class=nv> </span><span class=s>wantlist=True)</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <h5 id=循环控制>循环控制<a class=headerlink href=#循环控制 title="Permanent link">&para;</a></h5> <p>使用<code>loop_control</code>关键字来管理循环。</p> <h6 id=使用label限制loop的输出>使用<code>label</code>限制loop的输出<a class=headerlink href=#使用label限制loop的输出 title="Permanent link">&para;</a></h6> <div class=highlight><pre><span></span><code><a id=__codelineno-446-1 name=__codelineno-446-1 href=#__codelineno-446-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">create servers</span>
<a id=__codelineno-446-2 name=__codelineno-446-2 href=#__codelineno-446-2></a><span class=w>  </span><span class=nt>digital_ocean</span><span class=p>:</span>
<a id=__codelineno-446-3 name=__codelineno-446-3 href=#__codelineno-446-3></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.name</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-446-4 name=__codelineno-446-4 href=#__codelineno-446-4></a><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id=__codelineno-446-5 name=__codelineno-446-5 href=#__codelineno-446-5></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span>
<a id=__codelineno-446-6 name=__codelineno-446-6 href=#__codelineno-446-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">server1</span>
<a id=__codelineno-446-7 name=__codelineno-446-7 href=#__codelineno-446-7></a><span class=w>      </span><span class=nt>disks</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3gb</span>
<a id=__codelineno-446-8 name=__codelineno-446-8 href=#__codelineno-446-8></a><span class=w>      </span><span class=nt>ram</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">15Gb</span>
<a id=__codelineno-446-9 name=__codelineno-446-9 href=#__codelineno-446-9></a><span class=w>      </span><span class=nt>network</span><span class=p>:</span>
<a id=__codelineno-446-10 name=__codelineno-446-10 href=#__codelineno-446-10></a><span class=w>        </span><span class=nt>nic01</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">100Gb</span>
<a id=__codelineno-446-11 name=__codelineno-446-11 href=#__codelineno-446-11></a><span class=w>        </span><span class=nt>nic02</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10Gb</span>
<a id=__codelineno-446-12 name=__codelineno-446-12 href=#__codelineno-446-12></a><span class=w>        </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<a id=__codelineno-446-13 name=__codelineno-446-13 href=#__codelineno-446-13></a><span class=w>  </span><span class=nt>loop_control</span><span class=p>:</span>
<a id=__codelineno-446-14 name=__codelineno-446-14 href=#__codelineno-446-14></a><span class=w>    </span><span class=nt>label</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.name</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <p>这个任务的输出将只显示每个项目的名称字段，而不是多行<code>{{item}}</code>变量的整个内容。 </p> <blockquote> <p>这是为了使控制台输出更具可读性，而不是为了保护敏感数据。如果循环中有敏感数据，则设置<code>no_log: yes</code>，以防止泄漏。 </p> </blockquote> <h6 id=循环间隔时间>循环间隔时间<a class=headerlink href=#循环间隔时间 title="Permanent link">&para;</a></h6> <p>使用<code>pause</code>指令控制循环中每个项执行之间的时间(以秒为单位)</p> <div class=highlight><pre><span></span><code><a id=__codelineno-447-1 name=__codelineno-447-1 href=#__codelineno-447-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">create servers, pause 3s before creating next</span>
<a id=__codelineno-447-2 name=__codelineno-447-2 href=#__codelineno-447-2></a><span class=w>  </span><span class=nt>digital_ocean</span><span class=p>:</span>
<a id=__codelineno-447-3 name=__codelineno-447-3 href=#__codelineno-447-3></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-447-4 name=__codelineno-447-4 href=#__codelineno-447-4></a><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id=__codelineno-447-5 name=__codelineno-447-5 href=#__codelineno-447-5></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span>
<a id=__codelineno-447-6 name=__codelineno-447-6 href=#__codelineno-447-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">server1</span>
<a id=__codelineno-447-7 name=__codelineno-447-7 href=#__codelineno-447-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">server2</span>
<a id=__codelineno-447-8 name=__codelineno-447-8 href=#__codelineno-447-8></a><span class=w>  </span><span class=nt>loop_control</span><span class=p>:</span>
<a id=__codelineno-447-9 name=__codelineno-447-9 href=#__codelineno-447-9></a><span class=w>    </span><span class=nt>pause</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</code></pre></div> <h6 id=循环索引>循环索引<a class=headerlink href=#循环索引 title="Permanent link">&para;</a></h6> <p>使用<code>index_var</code> 指令来跟踪当前循环的索引</p> <div class=highlight><pre><span></span><code><a id=__codelineno-448-1 name=__codelineno-448-1 href=#__codelineno-448-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">count our fruit</span>
<a id=__codelineno-448-2 name=__codelineno-448-2 href=#__codelineno-448-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-448-3 name=__codelineno-448-3 href=#__codelineno-448-3></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>with</span><span class=nv> </span><span class=s>index</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>my_idx</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-448-4 name=__codelineno-448-4 href=#__codelineno-448-4></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span>
<a id=__codelineno-448-5 name=__codelineno-448-5 href=#__codelineno-448-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apple</span>
<a id=__codelineno-448-6 name=__codelineno-448-6 href=#__codelineno-448-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">banana</span>
<a id=__codelineno-448-7 name=__codelineno-448-7 href=#__codelineno-448-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">pear</span>
<a id=__codelineno-448-8 name=__codelineno-448-8 href=#__codelineno-448-8></a><span class=w>  </span><span class=nt>loop_control</span><span class=p>:</span>
<a id=__codelineno-448-9 name=__codelineno-448-9 href=#__codelineno-448-9></a><span class=w>    </span><span class=nt>index_var</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my_idx</span>
</code></pre></div> <h6 id=更改循环的变量名称>更改循环的变量名称<a class=headerlink href=#更改循环的变量名称 title="Permanent link">&para;</a></h6> <p>循环的默认变量名称为<code>item</code>,可以通过<code>loop_var</code>来修改此项,从而避免覆盖<code>include_tasks</code>任务里的循环变量</p> <div class=highlight><pre><span></span><code><a id=__codelineno-449-1 name=__codelineno-449-1 href=#__codelineno-449-1></a><span class=c1># main.yml</span>
<a id=__codelineno-449-2 name=__codelineno-449-2 href=#__codelineno-449-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">inner.yml</span>
<a id=__codelineno-449-3 name=__codelineno-449-3 href=#__codelineno-449-3></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span>
<a id=__codelineno-449-4 name=__codelineno-449-4 href=#__codelineno-449-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-449-5 name=__codelineno-449-5 href=#__codelineno-449-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a id=__codelineno-449-6 name=__codelineno-449-6 href=#__codelineno-449-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id=__codelineno-449-7 name=__codelineno-449-7 href=#__codelineno-449-7></a><span class=w>  </span><span class=nt>loop_control</span><span class=p>:</span>
<a id=__codelineno-449-8 name=__codelineno-449-8 href=#__codelineno-449-8></a><span class=w>    </span><span class=nt>loop_var</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">outer_item</span>
<a id=__codelineno-449-9 name=__codelineno-449-9 href=#__codelineno-449-9></a>
<a id=__codelineno-449-10 name=__codelineno-449-10 href=#__codelineno-449-10></a><span class=c1># inner.yml</span>
<a id=__codelineno-449-11 name=__codelineno-449-11 href=#__codelineno-449-11></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-449-12 name=__codelineno-449-12 href=#__codelineno-449-12></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;outer</span><span class=nv> </span><span class=s>item={{</span><span class=nv> </span><span class=s>outer_item</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>inner</span><span class=nv> </span><span class=s>item={{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-449-13 name=__codelineno-449-13 href=#__codelineno-449-13></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span>
<a id=__codelineno-449-14 name=__codelineno-449-14 href=#__codelineno-449-14></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">a</span>
<a id=__codelineno-449-15 name=__codelineno-449-15 href=#__codelineno-449-15></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">b</span>
<a id=__codelineno-449-16 name=__codelineno-449-16 href=#__codelineno-449-16></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">c</span>
</code></pre></div> <h6 id=扩展变量>扩展变量<a class=headerlink href=#扩展变量 title="Permanent link">&para;</a></h6> <p>从Ansible 2.8开始，你可以使用扩展选项来获取扩展循环信息。此选项将公开以下信息。</p> <table> <thead> <tr> <th>变量</th> <th>描述</th> </tr> </thead> <tbody> <tr> <td><code>ansible_loop.allitems</code></td> <td>循环中所有项的列表</td> </tr> <tr> <td><code>ansible_loop.index</code></td> <td>循环的当前迭代次数。(从1开始)</td> </tr> <tr> <td><code>ansible_loop.index0</code></td> <td>循环的当前迭代次数。(从0开始)</td> </tr> <tr> <td><code>ansible_loop.revindex</code></td> <td>循环结束后的迭代次数。(从1开始)</td> </tr> <tr> <td><code>ansible_loop.revindex0</code></td> <td>循环结束后的迭代次数。(从0开始)</td> </tr> <tr> <td><code>ansible_loop.first</code></td> <td>如果是第一次迭代，返回<code>True</code></td> </tr> <tr> <td><code>ansible_loop.last</code></td> <td>如果是最后一次迭代，返回<code>True</code></td> </tr> <tr> <td><code>ansible_loop.length</code></td> <td>循环中的项数</td> </tr> <tr> <td><code>ansible_loop.previtem</code></td> <td>循环前一次迭代的项。在第一次迭代中未定义。</td> </tr> <tr> <td><code>ansible_loop.nextitem</code></td> <td>循环的后续迭代中的项。在最后一次迭代中未定义。</td> </tr> </tbody> </table> <div class=highlight><pre><span></span><code><a id=__codelineno-450-1 name=__codelineno-450-1 href=#__codelineno-450-1></a>loop_control:
<a id=__codelineno-450-2 name=__codelineno-450-2 href=#__codelineno-450-2></a>  extended: yes
</code></pre></div> <h5 id=获取loop_var的名称>获取<code>loop_var</code>的名称<a class=headerlink href=#获取loop_var的名称 title="Permanent link">&para;</a></h5> <p>从ansible2.8开始，你可以通过<code>ansible_loop_var</code> 来获取 <code>loop_control.loop_var</code>的值</p> <div class=highlight><pre><span></span><code><a id=__codelineno-451-1 name=__codelineno-451-1 href=#__codelineno-451-1></a><span class=s>&quot;{{</span><span class=nv> </span><span class=s>lookup(&#39;vars&#39;,</span><span class=nv> </span><span class=s>ansible_loop_var)</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <h4 id=从with_迁移到loop>从with_*迁移到loop<a class=headerlink href=#从with_迁移到loop title="Permanent link">&para;</a></h4> <p>随着Ansible 2.5的发布，执行循环的推荐方法是使用<code>loop</code>关键字，而不是<code>with_*</code>样式的循环。 </p> <p>在许多情况下，<code>loop</code>语法使用过滤器更好地表达，而不是使用更复杂的<code>query</code>或<code>lookup</code>。 </p> <p>下面的示例将展示如何将许多常见的<code>with_</code>样式循环转换为<code>loop</code>。</p> <h5 id=with_list>with_list<a class=headerlink href=#with_list title="Permanent link">&para;</a></h5> <p>遍历列表</p> <div class=highlight><pre><span></span><code><a id=__codelineno-452-1 name=__codelineno-452-1 href=#__codelineno-452-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_list</span>
<a id=__codelineno-452-2 name=__codelineno-452-2 href=#__codelineno-452-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-452-3 name=__codelineno-452-3 href=#__codelineno-452-3></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-452-4 name=__codelineno-452-4 href=#__codelineno-452-4></a><span class=w>  </span><span class=nt>with_list</span><span class=p>:</span>
<a id=__codelineno-452-5 name=__codelineno-452-5 href=#__codelineno-452-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">one</span>
<a id=__codelineno-452-6 name=__codelineno-452-6 href=#__codelineno-452-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">two</span>
<a id=__codelineno-452-7 name=__codelineno-452-7 href=#__codelineno-452-7></a>
<a id=__codelineno-452-8 name=__codelineno-452-8 href=#__codelineno-452-8></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_list -&gt; loop</span>
<a id=__codelineno-452-9 name=__codelineno-452-9 href=#__codelineno-452-9></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-452-10 name=__codelineno-452-10 href=#__codelineno-452-10></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-452-11 name=__codelineno-452-11 href=#__codelineno-452-11></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span>
<a id=__codelineno-452-12 name=__codelineno-452-12 href=#__codelineno-452-12></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">one</span>
<a id=__codelineno-452-13 name=__codelineno-452-13 href=#__codelineno-452-13></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">two</span>
</code></pre></div> <h5 id=with_items>with_items<a class=headerlink href=#with_items title="Permanent link">&para;</a></h5> <p>遍历列表</p> <div class=highlight><pre><span></span><code><a id=__codelineno-453-1 name=__codelineno-453-1 href=#__codelineno-453-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_items</span>
<a id=__codelineno-453-2 name=__codelineno-453-2 href=#__codelineno-453-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-453-3 name=__codelineno-453-3 href=#__codelineno-453-3></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-453-4 name=__codelineno-453-4 href=#__codelineno-453-4></a><span class=w>  </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>items</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-453-5 name=__codelineno-453-5 href=#__codelineno-453-5></a>
<a id=__codelineno-453-6 name=__codelineno-453-6 href=#__codelineno-453-6></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_items -&gt; loop</span>
<a id=__codelineno-453-7 name=__codelineno-453-7 href=#__codelineno-453-7></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-453-8 name=__codelineno-453-8 href=#__codelineno-453-8></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-453-9 name=__codelineno-453-9 href=#__codelineno-453-9></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>items</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>flatten(levels=1)</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-453-10 name=__codelineno-453-10 href=#__codelineno-453-10></a>
<a id=__codelineno-453-11 name=__codelineno-453-11 href=#__codelineno-453-11></a>
<a id=__codelineno-453-12 name=__codelineno-453-12 href=#__codelineno-453-12></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_items with muliti lists within a list</span>
<a id=__codelineno-453-13 name=__codelineno-453-13 href=#__codelineno-453-13></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg={{ item }}</span>
<a id=__codelineno-453-14 name=__codelineno-453-14 href=#__codelineno-453-14></a><span class=w>  </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span>
<a id=__codelineno-453-15 name=__codelineno-453-15 href=#__codelineno-453-15></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>foo</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-453-16 name=__codelineno-453-16 href=#__codelineno-453-16></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>bar</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-453-17 name=__codelineno-453-17 href=#__codelineno-453-17></a>
<a id=__codelineno-453-18 name=__codelineno-453-18 href=#__codelineno-453-18></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">loop with a list within lists of list  ( {{ list | union(list) }} )</span>
<a id=__codelineno-453-19 name=__codelineno-453-19 href=#__codelineno-453-19></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg={{ item }}</span>
<a id=__codelineno-453-20 name=__codelineno-453-20 href=#__codelineno-453-20></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>foo</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>union(bar)</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-453-21 name=__codelineno-453-21 href=#__codelineno-453-21></a>
<a id=__codelineno-453-22 name=__codelineno-453-22 href=#__codelineno-453-22></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">loop with a list within lists of list  ( {{ list + list }} )</span>
<a id=__codelineno-453-23 name=__codelineno-453-23 href=#__codelineno-453-23></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg={{ item }}</span>
<a id=__codelineno-453-24 name=__codelineno-453-24 href=#__codelineno-453-24></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>foo</span><span class=nv> </span><span class=s>+</span><span class=nv> </span><span class=s>bar</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <h5 id=with_indexed_items>with_indexed_items<a class=headerlink href=#with_indexed_items title="Permanent link">&para;</a></h5> <p>遍历列表和索引</p> <div class=highlight><pre><span></span><code><a id=__codelineno-454-1 name=__codelineno-454-1 href=#__codelineno-454-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_indexed_items</span>
<a id=__codelineno-454-2 name=__codelineno-454-2 href=#__codelineno-454-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-454-3 name=__codelineno-454-3 href=#__codelineno-454-3></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.0</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>-</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>item.1</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-454-4 name=__codelineno-454-4 href=#__codelineno-454-4></a><span class=w>  </span><span class=nt>with_indexed_items</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>items</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-454-5 name=__codelineno-454-5 href=#__codelineno-454-5></a>
<a id=__codelineno-454-6 name=__codelineno-454-6 href=#__codelineno-454-6></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_indexed_items -&gt; loop</span>
<a id=__codelineno-454-7 name=__codelineno-454-7 href=#__codelineno-454-7></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-454-8 name=__codelineno-454-8 href=#__codelineno-454-8></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>index</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>-</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-454-9 name=__codelineno-454-9 href=#__codelineno-454-9></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>items</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>flatten(levels=1)</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-454-10 name=__codelineno-454-10 href=#__codelineno-454-10></a><span class=w>  </span><span class=nt>loop_control</span><span class=p>:</span>
<a id=__codelineno-454-11 name=__codelineno-454-11 href=#__codelineno-454-11></a><span class=w>    </span><span class=nt>index_var</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">index</span>
</code></pre></div> <h5 id=with_flattened>with_flattened<a class=headerlink href=#with_flattened title="Permanent link">&para;</a></h5> <p>合并列表</p> <div class=highlight><pre><span></span><code><a id=__codelineno-455-1 name=__codelineno-455-1 href=#__codelineno-455-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_flattened</span>
<a id=__codelineno-455-2 name=__codelineno-455-2 href=#__codelineno-455-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-455-3 name=__codelineno-455-3 href=#__codelineno-455-3></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-455-4 name=__codelineno-455-4 href=#__codelineno-455-4></a><span class=w>  </span><span class=nt>with_flattened</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>items</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-455-5 name=__codelineno-455-5 href=#__codelineno-455-5></a>
<a id=__codelineno-455-6 name=__codelineno-455-6 href=#__codelineno-455-6></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_flattened -&gt; loop</span>
<a id=__codelineno-455-7 name=__codelineno-455-7 href=#__codelineno-455-7></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-455-8 name=__codelineno-455-8 href=#__codelineno-455-8></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-455-9 name=__codelineno-455-9 href=#__codelineno-455-9></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>items</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>flatten</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <h5 id=with_together>with_together<a class=headerlink href=#with_together title="Permanent link">&para;</a></h5> <p>并行遍历列表</p> <div class=highlight><pre><span></span><code><a id=__codelineno-456-1 name=__codelineno-456-1 href=#__codelineno-456-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_together</span>
<a id=__codelineno-456-2 name=__codelineno-456-2 href=#__codelineno-456-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-456-3 name=__codelineno-456-3 href=#__codelineno-456-3></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.0</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>-</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>item.1</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-456-4 name=__codelineno-456-4 href=#__codelineno-456-4></a><span class=w>  </span><span class=nt>with_together</span><span class=p>:</span>
<a id=__codelineno-456-5 name=__codelineno-456-5 href=#__codelineno-456-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>list_one</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-456-6 name=__codelineno-456-6 href=#__codelineno-456-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>list_two</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-456-7 name=__codelineno-456-7 href=#__codelineno-456-7></a>
<a id=__codelineno-456-8 name=__codelineno-456-8 href=#__codelineno-456-8></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_together -&gt; loop</span>
<a id=__codelineno-456-9 name=__codelineno-456-9 href=#__codelineno-456-9></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-456-10 name=__codelineno-456-10 href=#__codelineno-456-10></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.0</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>-</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>item.1</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-456-11 name=__codelineno-456-11 href=#__codelineno-456-11></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>list_one|zip(list_two)|list</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <h5 id=with_dict>with_dict<a class=headerlink href=#with_dict title="Permanent link">&para;</a></h5> <p>遍历字典</p> <div class=highlight><pre><span></span><code><a id=__codelineno-457-1 name=__codelineno-457-1 href=#__codelineno-457-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_dict</span>
<a id=__codelineno-457-2 name=__codelineno-457-2 href=#__codelineno-457-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-457-3 name=__codelineno-457-3 href=#__codelineno-457-3></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.key</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>-</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>item.value</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-457-4 name=__codelineno-457-4 href=#__codelineno-457-4></a><span class=w>  </span><span class=nt>with_dict</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>dictionary</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-457-5 name=__codelineno-457-5 href=#__codelineno-457-5></a>
<a id=__codelineno-457-6 name=__codelineno-457-6 href=#__codelineno-457-6></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_dict -&gt; loop (option 1)</span>
<a id=__codelineno-457-7 name=__codelineno-457-7 href=#__codelineno-457-7></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-457-8 name=__codelineno-457-8 href=#__codelineno-457-8></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.key</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>-</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>item.value</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-457-9 name=__codelineno-457-9 href=#__codelineno-457-9></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>dictionary|dict2items</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-457-10 name=__codelineno-457-10 href=#__codelineno-457-10></a>
<a id=__codelineno-457-11 name=__codelineno-457-11 href=#__codelineno-457-11></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_dict -&gt; loop (option 2)</span>
<a id=__codelineno-457-12 name=__codelineno-457-12 href=#__codelineno-457-12></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-457-13 name=__codelineno-457-13 href=#__codelineno-457-13></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.0</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>-</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>item.1</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-457-14 name=__codelineno-457-14 href=#__codelineno-457-14></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>dictionary|dictsort</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-457-15 name=__codelineno-457-15 href=#__codelineno-457-15></a>
<a id=__codelineno-457-16 name=__codelineno-457-16 href=#__codelineno-457-16></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_dict lookup</span>
<a id=__codelineno-457-17 name=__codelineno-457-17 href=#__codelineno-457-17></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-457-18 name=__codelineno-457-18 href=#__codelineno-457-18></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;with_dict_lookup:</span><span class=nv> </span><span class=s>item.key</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>&#39;{{</span><span class=nv> </span><span class=s>item.key</span><span class=nv> </span><span class=s>}}&#39;</span><span class=nv> </span><span class=s>and</span><span class=nv> </span><span class=s>item.value</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>&#39;{{</span><span class=nv> </span><span class=s>item.value</span><span class=nv> </span><span class=s>}}&#39;&quot;</span>
<a id=__codelineno-457-19 name=__codelineno-457-19 href=#__codelineno-457-19></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>lookup(&#39;dict&#39;,</span><span class=nv> </span><span class=s>dictionary)</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-457-20 name=__codelineno-457-20 href=#__codelineno-457-20></a>
<a id=__codelineno-457-21 name=__codelineno-457-21 href=#__codelineno-457-21></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_dict query</span>
<a id=__codelineno-457-22 name=__codelineno-457-22 href=#__codelineno-457-22></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-457-23 name=__codelineno-457-23 href=#__codelineno-457-23></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;with_dict_query:</span><span class=nv> </span><span class=s>item.key</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>&#39;{{</span><span class=nv> </span><span class=s>item.key</span><span class=nv> </span><span class=s>}}&#39;</span><span class=nv> </span><span class=s>and</span><span class=nv> </span><span class=s>item.value</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>&#39;{{</span><span class=nv> </span><span class=s>item.value</span><span class=nv> </span><span class=s>}}&#39;&quot;</span>
<a id=__codelineno-457-24 name=__codelineno-457-24 href=#__codelineno-457-24></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>query(&#39;dict&#39;,</span><span class=nv> </span><span class=s>dictionary)</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <h5 id=with_sequence>with_sequence<a class=headerlink href=#with_sequence title="Permanent link">&para;</a></h5> <p>以递增的数字顺序生成项序列</p> <div class=highlight><pre><span></span><code><a id=__codelineno-458-1 name=__codelineno-458-1 href=#__codelineno-458-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_sequence</span>
<a id=__codelineno-458-2 name=__codelineno-458-2 href=#__codelineno-458-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-458-3 name=__codelineno-458-3 href=#__codelineno-458-3></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-458-4 name=__codelineno-458-4 href=#__codelineno-458-4></a><span class=w>  </span><span class=nt>with_sequence</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">start=0 end=4 stride=2 format=testuser%02x</span>
<a id=__codelineno-458-5 name=__codelineno-458-5 href=#__codelineno-458-5></a>
<a id=__codelineno-458-6 name=__codelineno-458-6 href=#__codelineno-458-6></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_sequence -&gt; loop</span>
<a id=__codelineno-458-7 name=__codelineno-458-7 href=#__codelineno-458-7></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-458-8 name=__codelineno-458-8 href=#__codelineno-458-8></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>&#39;testuser%02x&#39;</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>format(item)</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-458-9 name=__codelineno-458-9 href=#__codelineno-458-9></a><span class=w>  </span><span class=c1># range is exclusive of the end point</span>
<a id=__codelineno-458-10 name=__codelineno-458-10 href=#__codelineno-458-10></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>range(0,</span><span class=nv> </span><span class=s>4</span><span class=nv> </span><span class=s>+</span><span class=nv> </span><span class=s>1,</span><span class=nv> </span><span class=s>2)|list</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-458-11 name=__codelineno-458-11 href=#__codelineno-458-11></a>
<a id=__codelineno-458-12 name=__codelineno-458-12 href=#__codelineno-458-12></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with sequence loop and lookup</span>
<a id=__codelineno-458-13 name=__codelineno-458-13 href=#__codelineno-458-13></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-458-14 name=__codelineno-458-14 href=#__codelineno-458-14></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;sequence_lookup:</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>&#39;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&#39;&quot;</span>
<a id=__codelineno-458-15 name=__codelineno-458-15 href=#__codelineno-458-15></a><span class=w>  </span><span class=c1># end is inclusive of the end point</span>
<a id=__codelineno-458-16 name=__codelineno-458-16 href=#__codelineno-458-16></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>lookup(&#39;sequence&#39;,</span><span class=nv> </span><span class=s>&#39;start=0</span><span class=nv> </span><span class=s>end=4</span><span class=nv> </span><span class=s>stride=2</span><span class=nv> </span><span class=s>format=testuser%02x&#39;,</span><span class=nv> </span><span class=s>wantlist=True)</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-458-17 name=__codelineno-458-17 href=#__codelineno-458-17></a>
<a id=__codelineno-458-18 name=__codelineno-458-18 href=#__codelineno-458-18></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with sequence loop and query</span>
<a id=__codelineno-458-19 name=__codelineno-458-19 href=#__codelineno-458-19></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-458-20 name=__codelineno-458-20 href=#__codelineno-458-20></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;sequence_query:</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>&#39;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&#39;&quot;</span>
<a id=__codelineno-458-21 name=__codelineno-458-21 href=#__codelineno-458-21></a><span class=w>  </span><span class=c1># end is inclusive of the end point</span>
<a id=__codelineno-458-22 name=__codelineno-458-22 href=#__codelineno-458-22></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>query(&#39;sequence&#39;,</span><span class=nv> </span><span class=s>&#39;start=0</span><span class=nv> </span><span class=s>end=4</span><span class=nv> </span><span class=s>stride=2</span><span class=nv> </span><span class=s>format=testuser%02x&#39;)</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <h5 id=with_subelements>with_subelements<a class=headerlink href=#with_subelements title="Permanent link">&para;</a></h5> <p>遍历子元素</p> <div class=highlight><pre><span></span><code><a id=__codelineno-459-1 name=__codelineno-459-1 href=#__codelineno-459-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_nested</span>
<a id=__codelineno-459-2 name=__codelineno-459-2 href=#__codelineno-459-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-459-3 name=__codelineno-459-3 href=#__codelineno-459-3></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.0</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>-</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>item.1</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-459-4 name=__codelineno-459-4 href=#__codelineno-459-4></a><span class=w>  </span><span class=nt>with_nested</span><span class=p>:</span>
<a id=__codelineno-459-5 name=__codelineno-459-5 href=#__codelineno-459-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>list_one</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-459-6 name=__codelineno-459-6 href=#__codelineno-459-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>list_two</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-459-7 name=__codelineno-459-7 href=#__codelineno-459-7></a>
<a id=__codelineno-459-8 name=__codelineno-459-8 href=#__codelineno-459-8></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_nested -&gt; loop</span>
<a id=__codelineno-459-9 name=__codelineno-459-9 href=#__codelineno-459-9></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-459-10 name=__codelineno-459-10 href=#__codelineno-459-10></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item.0</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>-</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>item.1</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-459-11 name=__codelineno-459-11 href=#__codelineno-459-11></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>list_one|product(list_two)|list</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <h5 id=with_random_choice>with_random_choice<a class=headerlink href=#with_random_choice title="Permanent link">&para;</a></h5> <p>随机选择列表中得一个值</p> <div class=highlight><pre><span></span><code><a id=__codelineno-460-1 name=__codelineno-460-1 href=#__codelineno-460-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_random_choice</span>
<a id=__codelineno-460-2 name=__codelineno-460-2 href=#__codelineno-460-2></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-460-3 name=__codelineno-460-3 href=#__codelineno-460-3></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-460-4 name=__codelineno-460-4 href=#__codelineno-460-4></a><span class=w>  </span><span class=nt>with_random_choice</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>my_list</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-460-5 name=__codelineno-460-5 href=#__codelineno-460-5></a>
<a id=__codelineno-460-6 name=__codelineno-460-6 href=#__codelineno-460-6></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with_random_choice -&gt; loop (No loop is needed here)</span>
<a id=__codelineno-460-7 name=__codelineno-460-7 href=#__codelineno-460-7></a><span class=w>  </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-460-8 name=__codelineno-460-8 href=#__codelineno-460-8></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>my_list|random</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-460-9 name=__codelineno-460-9 href=#__codelineno-460-9></a><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">random</span>
</code></pre></div> <h2 id=14blocks>14.Blocks<a class=headerlink href=#14blocks title="Permanent link">&para;</a></h2> <p><code>Blocks</code>允许任务的逻辑分组和<code>play</code>中的错误处理。您可以应用于单个任务的大部分内容(循环除外)都可以应用于块级别，这也使得设置任务通用的数据或指令变得更加容易。这并不意味着指令影响块本身，而是由块所包含的任务继承。例如，一个<code>when</code>将应用于任务，而不是块本身。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-461-1 name=__codelineno-461-1 href=#__codelineno-461-1></a><span class=w> </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-461-2 name=__codelineno-461-2 href=#__codelineno-461-2></a><span class=w>   </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Install, configure, and start Apache</span>
<a id=__codelineno-461-3 name=__codelineno-461-3 href=#__codelineno-461-3></a><span class=w>     </span><span class=nt>block</span><span class=p>:</span>
<a id=__codelineno-461-4 name=__codelineno-461-4 href=#__codelineno-461-4></a><span class=w>       </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">install httpd and memcached</span>
<a id=__codelineno-461-5 name=__codelineno-461-5 href=#__codelineno-461-5></a><span class=w>         </span><span class=nt>yum</span><span class=p>:</span>
<a id=__codelineno-461-6 name=__codelineno-461-6 href=#__codelineno-461-6></a><span class=w>           </span><span class=nt>name</span><span class=p>:</span>
<a id=__codelineno-461-7 name=__codelineno-461-7 href=#__codelineno-461-7></a><span class=w>           </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id=__codelineno-461-8 name=__codelineno-461-8 href=#__codelineno-461-8></a><span class=w>           </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">memcached</span>
<a id=__codelineno-461-9 name=__codelineno-461-9 href=#__codelineno-461-9></a><span class=w>           </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id=__codelineno-461-10 name=__codelineno-461-10 href=#__codelineno-461-10></a>
<a id=__codelineno-461-11 name=__codelineno-461-11 href=#__codelineno-461-11></a><span class=w>       </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apply the foo config template</span>
<a id=__codelineno-461-12 name=__codelineno-461-12 href=#__codelineno-461-12></a><span class=w>         </span><span class=nt>template</span><span class=p>:</span>
<a id=__codelineno-461-13 name=__codelineno-461-13 href=#__codelineno-461-13></a><span class=w>           </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">templates/src.j2</span>
<a id=__codelineno-461-14 name=__codelineno-461-14 href=#__codelineno-461-14></a><span class=w>           </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/etc/foo.conf</span>
<a id=__codelineno-461-15 name=__codelineno-461-15 href=#__codelineno-461-15></a><span class=w>       </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">start service bar and enable it</span>
<a id=__codelineno-461-16 name=__codelineno-461-16 href=#__codelineno-461-16></a><span class=w>         </span><span class=nt>service</span><span class=p>:</span>
<a id=__codelineno-461-17 name=__codelineno-461-17 href=#__codelineno-461-17></a><span class=w>           </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bar</span>
<a id=__codelineno-461-18 name=__codelineno-461-18 href=#__codelineno-461-18></a><span class=w>           </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">started</span>
<a id=__codelineno-461-19 name=__codelineno-461-19 href=#__codelineno-461-19></a><span class=w>           </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<a id=__codelineno-461-20 name=__codelineno-461-20 href=#__codelineno-461-20></a><span class=w>     </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ansible_facts[&#39;distribution&#39;] == &#39;CentOS&#39;</span>
<a id=__codelineno-461-21 name=__codelineno-461-21 href=#__codelineno-461-21></a><span class=w>     </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-461-22 name=__codelineno-461-22 href=#__codelineno-461-22></a><span class=w>     </span><span class=nt>become_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<a id=__codelineno-461-23 name=__codelineno-461-23 href=#__codelineno-461-23></a><span class=w>     </span><span class=nt>ignore_errors</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div> <p>在上面的例子中，这3个任务都是在从块中继承<code>when</code>条件并在任务上判断之后执行的。它们还继承了特权升级指令，使<code>become</code>能够应用到block所包含的所有任务。最后，<code>ignore_errors: yes</code>即使有任务失败了，也将继续执行剧本。</p> <h3 id=块的错误处理>块的错误处理<a class=headerlink href=#块的错误处理 title="Permanent link">&para;</a></h3> <p>块还引入了以类似于大多数编程语言中的异常的方式处理错误的能力。块只处理任务的失败状态。错误的任务定义或无法访问的主机是不能触发块的错误处理。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-462-1 name=__codelineno-462-1 href=#__codelineno-462-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Attempt and graceful roll back demo</span>
<a id=__codelineno-462-2 name=__codelineno-462-2 href=#__codelineno-462-2></a><span class=w>  </span><span class=nt>block</span><span class=p>:</span>
<a id=__codelineno-462-3 name=__codelineno-462-3 href=#__codelineno-462-3></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-462-4 name=__codelineno-462-4 href=#__codelineno-462-4></a><span class=w>        </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&#39;I</span><span class=nv> </span><span class=s>execute</span><span class=nv> </span><span class=s>normally&#39;</span>
<a id=__codelineno-462-5 name=__codelineno-462-5 href=#__codelineno-462-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">i force a failure</span>
<a id=__codelineno-462-6 name=__codelineno-462-6 href=#__codelineno-462-6></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/bin/false</span>
<a id=__codelineno-462-7 name=__codelineno-462-7 href=#__codelineno-462-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-462-8 name=__codelineno-462-8 href=#__codelineno-462-8></a><span class=w>        </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&#39;I</span><span class=nv> </span><span class=s>never</span><span class=nv> </span><span class=s>execute,</span><span class=nv> </span><span class=s>due</span><span class=nv> </span><span class=s>to</span><span class=nv> </span><span class=s>the</span><span class=nv> </span><span class=s>above</span><span class=nv> </span><span class=s>task</span><span class=nv> </span><span class=s>failing,</span><span class=nv> </span><span class=s>:-(&#39;</span>
<a id=__codelineno-462-9 name=__codelineno-462-9 href=#__codelineno-462-9></a><span class=w>  </span><span class=nt>rescue</span><span class=p>:</span>
<a id=__codelineno-462-10 name=__codelineno-462-10 href=#__codelineno-462-10></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-462-11 name=__codelineno-462-11 href=#__codelineno-462-11></a><span class=w>        </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&#39;I</span><span class=nv> </span><span class=s>caught</span><span class=nv> </span><span class=s>an</span><span class=nv> </span><span class=s>error&#39;</span>
<a id=__codelineno-462-12 name=__codelineno-462-12 href=#__codelineno-462-12></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">i force a failure in middle of recovery! &gt;:-)</span>
<a id=__codelineno-462-13 name=__codelineno-462-13 href=#__codelineno-462-13></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/bin/false</span>
<a id=__codelineno-462-14 name=__codelineno-462-14 href=#__codelineno-462-14></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-462-15 name=__codelineno-462-15 href=#__codelineno-462-15></a><span class=w>        </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&#39;I</span><span class=nv> </span><span class=s>also</span><span class=nv> </span><span class=s>never</span><span class=nv> </span><span class=s>execute</span><span class=nv> </span><span class=s>:-(&#39;</span>
<a id=__codelineno-462-16 name=__codelineno-462-16 href=#__codelineno-462-16></a><span class=w>  </span><span class=nt>always</span><span class=p>:</span>
<a id=__codelineno-462-17 name=__codelineno-462-17 href=#__codelineno-462-17></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-462-18 name=__codelineno-462-18 href=#__codelineno-462-18></a><span class=w>        </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;This</span><span class=nv> </span><span class=s>always</span><span class=nv> </span><span class=s>executes&quot;</span>
</code></pre></div> <p>block中的任务在执行中，如果有任何错误，将执行**rescue**中的任务。 无论在block和rescue中发生或没有发生错误，**always**部分都运行。</p> <p>需要注意的是，如果**rescue**部分成功完成，那么<code>play</code>将继续进行，因为它将擦除错误状态(但不包括报告),这意味着它不会触发<code>max_fail_percentage</code>或<code>any_errors_fatal</code>的配置，但将出现在playbook统计。</p> <p>发生错误后，依然运行handlers</p> <div class=highlight><pre><span></span><code><a id=__codelineno-463-1 name=__codelineno-463-1 href=#__codelineno-463-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-463-2 name=__codelineno-463-2 href=#__codelineno-463-2></a><span class=w>   </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Attempt and graceful roll back demo</span>
<a id=__codelineno-463-3 name=__codelineno-463-3 href=#__codelineno-463-3></a><span class=w>     </span><span class=nt>block</span><span class=p>:</span>
<a id=__codelineno-463-4 name=__codelineno-463-4 href=#__codelineno-463-4></a><span class=w>       </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-463-5 name=__codelineno-463-5 href=#__codelineno-463-5></a><span class=w>           </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&#39;I</span><span class=nv> </span><span class=s>execute</span><span class=nv> </span><span class=s>normally&#39;</span>
<a id=__codelineno-463-6 name=__codelineno-463-6 href=#__codelineno-463-6></a><span class=w>         </span><span class=nt>changed_when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-463-7 name=__codelineno-463-7 href=#__codelineno-463-7></a><span class=w>         </span><span class=nt>notify</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">run me even after an error</span>
<a id=__codelineno-463-8 name=__codelineno-463-8 href=#__codelineno-463-8></a><span class=w>       </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/bin/false</span>
<a id=__codelineno-463-9 name=__codelineno-463-9 href=#__codelineno-463-9></a><span class=w>     </span><span class=nt>rescue</span><span class=p>:</span>
<a id=__codelineno-463-10 name=__codelineno-463-10 href=#__codelineno-463-10></a><span class=w>       </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">make sure all handlers run</span>
<a id=__codelineno-463-11 name=__codelineno-463-11 href=#__codelineno-463-11></a><span class=w>         </span><span class=nt>meta</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flush_handlers</span>
<a id=__codelineno-463-12 name=__codelineno-463-12 href=#__codelineno-463-12></a><span class="w w-Error"> </span><span class=nt>handlers</span><span class=p>:</span>
<a id=__codelineno-463-13 name=__codelineno-463-13 href=#__codelineno-463-13></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">run me even after an error</span>
<a id=__codelineno-463-14 name=__codelineno-463-14 href=#__codelineno-463-14></a><span class=w>      </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-463-15 name=__codelineno-463-15 href=#__codelineno-463-15></a><span class=w>        </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&#39;This</span><span class=nv> </span><span class=s>handler</span><span class=nv> </span><span class=s>runs</span><span class=nv> </span><span class=s>even</span><span class=nv> </span><span class=s>on</span><span class=nv> </span><span class=s>error&#39;</span>
</code></pre></div> <p>Ansible还为block的rescue部分的任务提供了两个变量</p> <ul> <li>ansible_failed_task 返回触发<code>rescue</code> 的失败任务。例如，要获取名称，请使用<code>ansible_failed_task.name</code>。</li> <li>ansible_failed_result 返回触发<code>rescue</code> 的失败任务的返回结果。这相当于在失败任务中添加 <code>register: ansible_failed_result</code></li> </ul> <h2 id=15playbook高级特性>15.Playbook高级特性<a class=headerlink href=#15playbook高级特性 title="Permanent link">&para;</a></h2> <h3 id=权限提升>权限提升<a class=headerlink href=#权限提升 title="Permanent link">&para;</a></h3> <p>Ansible使用现有的权限升级系统来执行具有<code>root</code>权限或其他用户权限的任务。因为这个特性允许您成为另一个用户，与登录到机器的用户(远程用户)不同，所以我们将其称为<code>become</code>。<code>become</code>关键字利用现有的权限升级工具，如<code>sudo</code>、<code>su</code>、<code>pfexec</code>、<code>doas</code>、<code>pbrun</code>、<code>dzdo</code>、<code>ksu</code>、<code>runas</code>、<code>machinectl</code>等。 </p> <h4 id=使用become>使用become<a class=headerlink href=#使用become title="Permanent link">&para;</a></h4> <p>你可以在 <code>play</code>或 <code>task</code> 上使用<code>become</code>，同时使用时，优先级规则会决定哪个生效。</p> <h5 id=become-指令>become 指令<a class=headerlink href=#become-指令 title="Permanent link">&para;</a></h5> <ul> <li>become 设置<code>yes</code>即开启提升权限</li> <li>become_user 指定提升权限的用户</li> <li>become_method 指定提升权限的方式，有sudo，su，runas等。</li> <li>become_flags 传给可执行文件的参数</li> </ul> <p>例如，启动服务需要<code>root</code>权限</p> <div class=highlight><pre><span></span><code><a id=__codelineno-464-1 name=__codelineno-464-1 href=#__codelineno-464-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Ensure the httpd service is running</span>
<a id=__codelineno-464-2 name=__codelineno-464-2 href=#__codelineno-464-2></a><span class=w>  </span><span class=nt>service</span><span class=p>:</span>
<a id=__codelineno-464-3 name=__codelineno-464-3 href=#__codelineno-464-3></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id=__codelineno-464-4 name=__codelineno-464-4 href=#__codelineno-464-4></a><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">started</span>
<a id=__codelineno-464-5 name=__codelineno-464-5 href=#__codelineno-464-5></a><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div> <p>以apache用户身份运行命令</p> <div class=highlight><pre><span></span><code><a id=__codelineno-465-1 name=__codelineno-465-1 href=#__codelineno-465-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Run a command as the apache user</span>
<a id=__codelineno-465-2 name=__codelineno-465-2 href=#__codelineno-465-2></a><span class=w>  </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">somecommand</span>
<a id=__codelineno-465-3 name=__codelineno-465-3 href=#__codelineno-465-3></a><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-465-4 name=__codelineno-465-4 href=#__codelineno-465-4></a><span class=w>  </span><span class=nt>become_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apache</span>
</code></pre></div> <p>当shell为nologin时，作为nobody用户执行某些操作</p> <div class=highlight><pre><span></span><code><a id=__codelineno-466-1 name=__codelineno-466-1 href=#__codelineno-466-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Run a command as nobody</span>
<a id=__codelineno-466-2 name=__codelineno-466-2 href=#__codelineno-466-2></a><span class=w>  </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">somecommand</span>
<a id=__codelineno-466-3 name=__codelineno-466-3 href=#__codelineno-466-3></a><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-466-4 name=__codelineno-466-4 href=#__codelineno-466-4></a><span class=w>  </span><span class=nt>become_method</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">su</span>
<a id=__codelineno-466-5 name=__codelineno-466-5 href=#__codelineno-466-5></a><span class=w>  </span><span class=nt>become_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nobody</span>
<a id=__codelineno-466-6 name=__codelineno-466-6 href=#__codelineno-466-6></a><span class=w>  </span><span class=nt>become_flags</span><span class=p>:</span><span class=w> </span><span class=s>&#39;-s</span><span class=nv> </span><span class=s>/bin/sh&#39;</span>
</code></pre></div> <h5 id=become-变量>become 变量<a class=headerlink href=#become-变量 title="Permanent link">&para;</a></h5> <p>在主机清单中可以为节点定义不同的<code>become</code>选项，使用下列变量</p> <ul> <li>ansible_become 开启提升权限</li> <li>ansible_become_method 提升权限的方式，有sudo，su，runas等。</li> <li>ansible_become_user 提升权限的用户</li> <li>ansible_become_pass 提升权限的用户密码</li> </ul> <p>例如，如果您希望在一个名为webserver的服务器上以root身份运行所有任务，但是您只能作为manager用户连接，那么您可以使用类似这样的库存条目 </p> <div class=highlight><pre><span></span><code><a id=__codelineno-467-1 name=__codelineno-467-1 href=#__codelineno-467-1></a><span class=na>webserver ansible_user</span><span class=o>=</span><span class=s>manager ansible_become=yes</span>
</code></pre></div> <h5 id=become-命令行选项>become 命令行选项<a class=headerlink href=#become-命令行选项 title="Permanent link">&para;</a></h5> <ul> <li>--become，-b</li> <li>--ask-become-pass, -K 告诉程序提升权限的用户密码</li> <li>--become-method 提升权限的方式，有sudo，su，runas等。</li> <li>--become-user 提升权限的用户</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-468-1 name=__codelineno-468-1 href=#__codelineno-468-1></a>ansible<span class=w> </span>-i<span class=w> </span>hosts<span class=w> </span>node1<span class=w> </span>-m<span class=w> </span>shell<span class=w> </span>-a<span class=w> </span><span class=s2>&quot;whoami&quot;</span><span class=w> </span>--become<span class=w>  </span>--become-method<span class=o>=</span>su<span class=w> </span>--become-user<span class=o>=</span>root<span class=w> </span>--ask-become-pass
<a id=__codelineno-468-2 name=__codelineno-468-2 href=#__codelineno-468-2></a>
<a id=__codelineno-468-3 name=__codelineno-468-3 href=#__codelineno-468-3></a>ansible-playbook<span class=w> </span>-i<span class=w> </span>hosts<span class=w> </span>test.yml<span class=w> </span>--become<span class=w>  </span>--become-method<span class=o>=</span>su<span class=w> </span>--become-user<span class=o>=</span>root<span class=w> </span>--ask-become-pass
</code></pre></div> <h5 id=become的一些限制和风险>become的一些限制和风险<a class=headerlink href=#become的一些限制和风险 title="Permanent link">&para;</a></h5> <ul> <li>成为无特权用户的风险</li> <li>不是所有的连接插件都支持特权升级</li> <li>每个主机只能启用一个特权升级模式(su,sudo...)</li> <li>特权升级不能限制某些命令能升级，这样会导致ansible执行时出现错误。</li> <li>不能访问由<code>pam_systemd</code>填充的环境变量</li> </ul> <h4 id=网络模块使用become>网络模块使用become<a class=headerlink href=#网络模块使用become title="Permanent link">&para;</a></h4> <p>从2.6版开始，Ansible在所有支持enable模式的网络设备上进行特权升级(进入enable模式或特权EXEC模式) </p> <p>你必须将连接类型设置为<code>connection: network_cli</code>或<code>connection: httpapi</code>，才能在网络设备上使用<code>become</code>进行权限升级。 </p> <p>若要设置特定任务的<code>enable</code>模式，请在任务级别上添加<code>become</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-469-1 name=__codelineno-469-1 href=#__codelineno-469-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Gather facts (eos)</span>
<a id=__codelineno-469-2 name=__codelineno-469-2 href=#__codelineno-469-2></a><span class=w>  </span><span class=nt>eos_facts</span><span class=p>:</span>
<a id=__codelineno-469-3 name=__codelineno-469-3 href=#__codelineno-469-3></a><span class=w>    </span><span class=nt>gather_subset</span><span class=p>:</span>
<a id=__codelineno-469-4 name=__codelineno-469-4 href=#__codelineno-469-4></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;!hardware&quot;</span>
<a id=__codelineno-469-5 name=__codelineno-469-5 href=#__codelineno-469-5></a><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-469-6 name=__codelineno-469-6 href=#__codelineno-469-6></a><span class=w>  </span><span class=nt>become_method</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">enable</span>
</code></pre></div> <p>若要为单个play中的所有任务设置<code>enable</code>模式，请在play级别上添加<code>become</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-470-1 name=__codelineno-470-1 href=#__codelineno-470-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">eos-switches</span>
<a id=__codelineno-470-2 name=__codelineno-470-2 href=#__codelineno-470-2></a><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-470-3 name=__codelineno-470-3 href=#__codelineno-470-3></a><span class=w>  </span><span class=nt>become_method</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">enable</span>
<a id=__codelineno-470-4 name=__codelineno-470-4 href=#__codelineno-470-4></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-470-5 name=__codelineno-470-5 href=#__codelineno-470-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Gather facts (eos)</span>
<a id=__codelineno-470-6 name=__codelineno-470-6 href=#__codelineno-470-6></a><span class=w>      </span><span class=nt>eos_facts</span><span class=p>:</span>
<a id=__codelineno-470-7 name=__codelineno-470-7 href=#__codelineno-470-7></a><span class=w>        </span><span class=nt>gather_subset</span><span class=p>:</span>
<a id=__codelineno-470-8 name=__codelineno-470-8 href=#__codelineno-470-8></a><span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;!hardware&quot;</span>
</code></pre></div> <h5 id=设置所有任务的enable模式>设置所有任务的<code>enable</code>模式<a class=headerlink href=#设置所有任务的enable模式 title="Permanent link">&para;</a></h5> <p>通常，您希望所有play中的所有任务都使用特权模式运行，这最好通过使用组变量来实现</p> <div class=highlight><pre><span></span><code><a id=__codelineno-471-1 name=__codelineno-471-1 href=#__codelineno-471-1></a><span class=nt>ansible_connection</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">network_cli</span>
<a id=__codelineno-471-2 name=__codelineno-471-2 href=#__codelineno-471-2></a><span class=nt>ansible_network_os</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">eos</span>
<a id=__codelineno-471-3 name=__codelineno-471-3 href=#__codelineno-471-3></a><span class=nt>ansible_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myuser</span>
<a id=__codelineno-471-4 name=__codelineno-471-4 href=#__codelineno-471-4></a><span class=nt>ansible_become</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-471-5 name=__codelineno-471-5 href=#__codelineno-471-5></a><span class=nt>ansible_become_method</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">enable</span>
</code></pre></div> <h5 id=enable模式的密码>enable模式的密码<a class=headerlink href=#enable模式的密码 title="Permanent link">&para;</a></h5> <p>如果需要密码才能进入<code>enable</code>模式，可以通过以下两种方式之一进行指定</p> <ul> <li>提供 <code>--ask-become-pass</code>命令行选项 </li> <li>设置<code>ansible_become_password</code> 连接变量 </li> </ul> <h5 id=authorize-和-auth_pass>authorize 和 auth_pass<a class=headerlink href=#authorize-和-auth_pass title="Permanent link">&para;</a></h5> <p>ansible 依然支持 <code>connection: local</code> 连接下的<code>enable</code>模式</p> <div class=highlight><pre><span></span><code><a id=__codelineno-472-1 name=__codelineno-472-1 href=#__codelineno-472-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">eos-switches</span>
<a id=__codelineno-472-2 name=__codelineno-472-2 href=#__codelineno-472-2></a><span class=w>  </span><span class=nt>ansible_connection</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<a id=__codelineno-472-3 name=__codelineno-472-3 href=#__codelineno-472-3></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-472-4 name=__codelineno-472-4 href=#__codelineno-472-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Gather facts (eos)</span>
<a id=__codelineno-472-5 name=__codelineno-472-5 href=#__codelineno-472-5></a><span class=w>      </span><span class=nt>eos_facts</span><span class=p>:</span>
<a id=__codelineno-472-6 name=__codelineno-472-6 href=#__codelineno-472-6></a><span class=w>        </span><span class=nt>gather_subset</span><span class=p>:</span>
<a id=__codelineno-472-7 name=__codelineno-472-7 href=#__codelineno-472-7></a><span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;!hardware&quot;</span>
<a id=__codelineno-472-8 name=__codelineno-472-8 href=#__codelineno-472-8></a><span class=w>      </span><span class=nt>provider</span><span class=p>:</span>
<a id=__codelineno-472-9 name=__codelineno-472-9 href=#__codelineno-472-9></a><span class=w>        </span><span class=nt>authorize</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-472-10 name=__codelineno-472-10 href=#__codelineno-472-10></a><span class=w>        </span><span class=nt>auth_pass</span><span class=p>:</span><span class=w> </span><span class=s>&quot;</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>secret_auth_pass</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <h4 id=windows-使用become>windows 使用become<a class=headerlink href=#windows-使用become title="Permanent link">&para;</a></h4> <p>从Ansible 2.3开始，可以通过<code>runas</code>方法在Windows主机上使用<code>become</code>。在Windows上的Become使用与在非Windows主机上相同的库存设置和调用参数，因此设置和变量名与本文档中定义的相同。 </p> <p>Windows中的许多任务需要管理权限才能完成。当使用runas become方法时，Ansible将尝试使用远程用户可用的全部特权运行模块。如果未能提升用户令牌，则在执行期间将继续使用有限的令牌。 </p> <p>用户必须具有<code>SeDebugPrivilege</code>才能运行具有提升特权的成为进程。这个特权默认分配给管理员。如果调试特权不可用，则become进程将使用一组有限的特权和组运行。 </p> <div class=highlight><pre><span></span><code><a id=__codelineno-473-1 name=__codelineno-473-1 href=#__codelineno-473-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>win_whoami</span><span class=p>:</span>
<a id=__codelineno-473-2 name=__codelineno-473-2 href=#__codelineno-473-2></a><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div> <p>在返回的<code>label.account_name</code>中体现了是否获取特权</p> <ul> <li> <p><code>Medium</code>: Ansible未能得到提升的令牌，并运行在一个有限的令牌。 </p> </li> <li> <p><code>High</code>: 获得了提升的令牌，并在任务中使用</p> </li> <li> <p><code>System</code>: <code>NT AUTHORITY\System</code>帐户被使用，并且具有最高级别的可用特权。</p> </li> </ul> <p>如果在大于2.5的Ansible版本上运行或正常的runas升级过程失败，可以通过 </p> <ul> <li> <p>将<code>become_user</code>设置为<code>System</code> 以便拥有最高权限</p> </li> <li> <p>为WinRM连接用户授予<code>SeTcbPrivilege</code>权限， <code>SeTcbPrivilege</code>是一种高级特权，它授予对操作系统的完全控制。您可以使用下面的任务在Windows主机上设置此特权</p> </li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-474-1 name=__codelineno-474-1 href=#__codelineno-474-1></a><span class=w> </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">grant the ansible user the SeTcbPrivilege right</span>
<a id=__codelineno-474-2 name=__codelineno-474-2 href=#__codelineno-474-2></a><span class=w>   </span><span class=nt>win_user_right</span><span class=p>:</span>
<a id=__codelineno-474-3 name=__codelineno-474-3 href=#__codelineno-474-3></a><span class=w>     </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">SeTcbPrivilege</span>
<a id=__codelineno-474-4 name=__codelineno-474-4 href=#__codelineno-474-4></a><span class=w>     </span><span class=nt>users</span><span class=p>:</span><span class=w> </span><span class=s>&#39;{{ansible_user}}&#39;</span>
<a id=__codelineno-474-5 name=__codelineno-474-5 href=#__codelineno-474-5></a><span class=w>     </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">add</span>
</code></pre></div> <ul> <li>关闭主机上的UAC并重启主机, UAC是一种安全协议，它被设计为使用最少特权原则运行帐户。您可以通过运行以下任务来关闭UAC </li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-475-1 name=__codelineno-475-1 href=#__codelineno-475-1></a><span class=w> </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">turn UAC off</span>
<a id=__codelineno-475-2 name=__codelineno-475-2 href=#__codelineno-475-2></a><span class=w>   </span><span class=nt>win_regedit</span><span class=p>:</span>
<a id=__codelineno-475-3 name=__codelineno-475-3 href=#__codelineno-475-3></a><span class=w>     </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\policies\system</span>
<a id=__codelineno-475-4 name=__codelineno-475-4 href=#__codelineno-475-4></a><span class=w>     </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">EnableLUA</span>
<a id=__codelineno-475-5 name=__codelineno-475-5 href=#__codelineno-475-5></a><span class=w>     </span><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<a id=__codelineno-475-6 name=__codelineno-475-6 href=#__codelineno-475-6></a><span class=w>     </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dword</span>
<a id=__codelineno-475-7 name=__codelineno-475-7 href=#__codelineno-475-7></a><span class=w>     </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id=__codelineno-475-8 name=__codelineno-475-8 href=#__codelineno-475-8></a><span class=w>   </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">uac_result</span>
<a id=__codelineno-475-9 name=__codelineno-475-9 href=#__codelineno-475-9></a>
<a id=__codelineno-475-10 name=__codelineno-475-10 href=#__codelineno-475-10></a><span class=w> </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">reboot after disabling UAC</span>
<a id=__codelineno-475-11 name=__codelineno-475-11 href=#__codelineno-475-11></a><span class=w>   </span><span class=nt>win_reboot</span><span class=p>:</span>
<a id=__codelineno-475-12 name=__codelineno-475-12 href=#__codelineno-475-12></a><span class=w>   </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">uac_result is changed</span>
</code></pre></div> <blockquote> <p>授予<code>SeTcbPrivilege</code>或关闭UAC可能会导致Windows安全漏洞，如果采取了这些步骤，应该谨慎对待。 </p> </blockquote> <h5 id=localservice账号>LocalService账号<a class=headerlink href=#localservice账号 title="Permanent link">&para;</a></h5> <p>在Ansible 2.5版本之前，become只能在本地或域用户帐户的Windows上工作。在这些旧版本中，像<code>System</code>或<code>NetworkService</code>这样的本地服务帐户不能用作用户。自Ansible 2.5发布以来，这一限制已经解除。可以在成为用户下面设置的三个服务帐户是 </p> <ul> <li>System</li> <li>NetworkService</li> <li>LocalService</li> </ul> <p>由于本地服务帐户没有密码，所以<code>ansible_become_password</code>参数不是必需的，如果指定了该参数也会被被忽略。</p> <h5 id=无需为become设置密码>无需为become设置密码<a class=headerlink href=#无需为become设置密码 title="Permanent link">&para;</a></h5> <p>从Ansible 2.8开始，become可以被用来成为一个Windows本地或域帐户，而不需要该帐户的密码。要使此方法工作，必须满足以下要求</p> <ul> <li> <p>该连接用户拥有<code>SeDebugPrivilege</code>权限</p> </li> <li> <p>该连接用户属于<code>BUILTIN\Administrators</code>组</p> </li> <li> <p>该连接用户拥有<code>SeBatchLogonRight</code>或<code>SeNetworkLogonRight</code>用户权限</p> </li> </ul> <p>通过两种不同的方法之一可以使用使用无密码方式：</p> <ul> <li> <p>复制现有的登录会话令牌(如果帐户已经登录)</p> </li> <li> <p>使用S4U生成仅在远程主机上有效的登录令牌</p> </li> </ul> <h5 id=没有密码的帐户>没有密码的帐户<a class=headerlink href=#没有密码的帐户 title="Permanent link">&para;</a></h5> <p>Ansible可以使用一个没有密码的Windows帐户(像Guest帐户)。要成为一个没有密码的帐户，必须设置<code>ansible_become_password: ''</code>。</p> <p>要想实现无密码登录，还需要将本地策略帐户:将本地帐户使用空白密码限制为仅用于控制台登录禁用。这可以通过组策略对象(GPO)完成，也可以通过这个可能的任务完成 </p> <div class=highlight><pre><span></span><code><a id=__codelineno-476-1 name=__codelineno-476-1 href=#__codelineno-476-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">allow blank password on become</span>
<a id=__codelineno-476-2 name=__codelineno-476-2 href=#__codelineno-476-2></a><span class=w>  </span><span class=nt>win_regedit</span><span class=p>:</span>
<a id=__codelineno-476-3 name=__codelineno-476-3 href=#__codelineno-476-3></a><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HKLM:\SYSTEM\CurrentControlSet\Control\Lsa</span>
<a id=__codelineno-476-4 name=__codelineno-476-4 href=#__codelineno-476-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">LimitBlankPasswordUse</span>
<a id=__codelineno-476-5 name=__codelineno-476-5 href=#__codelineno-476-5></a><span class=w>    </span><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<a id=__codelineno-476-6 name=__codelineno-476-6 href=#__codelineno-476-6></a><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dword</span>
<a id=__codelineno-476-7 name=__codelineno-476-7 href=#__codelineno-476-7></a><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</code></pre></div> <h5 id=become的参数>become的参数<a class=headerlink href=#become的参数 title="Permanent link">&para;</a></h5> <p>windows支持的<code>ansible_become_flags</code>有两个<code>logon_type</code> , <code>logon_flags</code></p> <p><code>logon_type</code> 是指定登录操作类型，有以下可选项:</p> <ul> <li> <p>interactive: 默认登录类型。该流程将在与本地运行流程相同的上下文中运行。这绕过了所有的WinRM限制，是推荐使用的方法。 </p> </li> <li> <p>batch: 在类似于设置了密码的调度任务的批处理上下文中运行该进程。</p> </li> <li> <p>new_credentials: 在与调用用户相同的凭据下运行</p> </li> <li> <p>network: 在没有任何缓存凭据的网络上下文中运行进程。</p> </li> <li> <p>network_cleartext: 与网络登录类型类似，但缓存凭据以便它可以访问网络资源。</p> </li> </ul> <p><code>logon_flags</code>指定在创建新进程时，Windows将如何记录用户的登录。 有以下可选项:</p> <ul> <li>with_profile： 默认值。 该过程会将HKEY_USERS注册表项中的用户个人资料加载到HKEY_CURRENT_USER。 </li> <li>netcredentials_only： 该过程将使用与调用方相同的令牌，但是在访问远程资源时将使用begin_user和begin_password。 </li> </ul> <p>一些例子</p> <div class=highlight><pre><span></span><code><a id=__codelineno-477-1 name=__codelineno-477-1 href=#__codelineno-477-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">copy a file from a fileshare with custom credentials</span>
<a id=__codelineno-477-2 name=__codelineno-477-2 href=#__codelineno-477-2></a><span class=w>  </span><span class=nt>win_copy</span><span class=p>:</span>
<a id=__codelineno-477-3 name=__codelineno-477-3 href=#__codelineno-477-3></a><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">\\server\share\data\file.txt</span>
<a id=__codelineno-477-4 name=__codelineno-477-4 href=#__codelineno-477-4></a><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">C:\temp\file.txt</span>
<a id=__codelineno-477-5 name=__codelineno-477-5 href=#__codelineno-477-5></a><span class=w>    </span><span class=nt>remote_src</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-477-6 name=__codelineno-477-6 href=#__codelineno-477-6></a><span class=w>  </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-477-7 name=__codelineno-477-7 href=#__codelineno-477-7></a><span class=w>    </span><span class=nt>ansible_become</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-477-8 name=__codelineno-477-8 href=#__codelineno-477-8></a><span class=w>    </span><span class=nt>ansible_become_method</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">runas</span>
<a id=__codelineno-477-9 name=__codelineno-477-9 href=#__codelineno-477-9></a><span class=w>    </span><span class=nt>ansible_become_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">DOMAIN\user</span>
<a id=__codelineno-477-10 name=__codelineno-477-10 href=#__codelineno-477-10></a><span class=w>    </span><span class=nt>ansible_become_password</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Password01</span>
<a id=__codelineno-477-11 name=__codelineno-477-11 href=#__codelineno-477-11></a><span class=w>    </span><span class=nt>ansible_become_flags</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">logon_type=new_credentials logon_flags=netcredentials_only</span>
<a id=__codelineno-477-12 name=__codelineno-477-12 href=#__codelineno-477-12></a>
<a id=__codelineno-477-13 name=__codelineno-477-13 href=#__codelineno-477-13></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">run a command under a batch logon</span>
<a id=__codelineno-477-14 name=__codelineno-477-14 href=#__codelineno-477-14></a><span class=w>  </span><span class=nt>win_whoami</span><span class=p>:</span>
<a id=__codelineno-477-15 name=__codelineno-477-15 href=#__codelineno-477-15></a><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-477-16 name=__codelineno-477-16 href=#__codelineno-477-16></a><span class=w>  </span><span class=nt>become_flags</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">logon_type=batch</span>
<a id=__codelineno-477-17 name=__codelineno-477-17 href=#__codelineno-477-17></a>
<a id=__codelineno-477-18 name=__codelineno-477-18 href=#__codelineno-477-18></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">run a command and not load the user profile</span>
<a id=__codelineno-477-19 name=__codelineno-477-19 href=#__codelineno-477-19></a><span class=w>  </span><span class=nt>win_whomai</span><span class=p>:</span>
<a id=__codelineno-477-20 name=__codelineno-477-20 href=#__codelineno-477-20></a><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-477-21 name=__codelineno-477-21 href=#__codelineno-477-21></a><span class=w>  </span><span class=nt>become_flags</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">logon_flags=</span>
</code></pre></div> <h5 id=限制>限制<a class=headerlink href=#限制 title="Permanent link">&para;</a></h5> <ul> <li> <p>仅当使用Ansible 2.7或更高版本时，<code>async</code>和<code>become</code>任务才能在Windows Server 2008、2008 R2和Windows 7上运行。</p> </li> <li> <p>默认情况下，<code>become</code>用户使用交互式会话登录，因此它必须有权在Windows主机上进行登录。 如果它不继承SeAllowLogOnLocally特权或继承SeDenyLogOnLocally特权，则提权过程将失败。 添加特权或设置logon_type标志以更改使用的登录类型。 </p> </li> <li> <p>在Ansible version 2.3之前，只有当 <code>ansible_winrm_transport</code>是basic或credssp时，become才能工作。这个限制已经被解除，自从2.4版的Ansible为所有主机除了Windows Server 2008(非R2版本)。</p> </li> <li> <p>二级登录服务<code>seclogon</code>必须运行才能使用<code>ansible_become_method: runas</code></p> </li> </ul> <h3 id=异步操作和轮询>异步操作和轮询<a class=headerlink href=#异步操作和轮询 title="Permanent link">&para;</a></h3> <p>默认情况下playbook中的任务执行时会一直保持连接,直到该任务在每个节点都执行完毕.有时这是不必要的,比如有些操作运行时间比SSH超时时间还要长.解决该问题最简单的方式是异步执行它们,然后轮询直到任务执行完毕.</p> <p>你也可以对执行时间非常长（有可能遭遇超时）的操作使用异步模式.</p> <p>为了异步启动一个任务,可以指定其最大超时时间以及轮询其状态的频率.如果你没有为 poll 指定值,那么默认的轮询频率是15秒钟。</p> <p>例如下面的palybook</p> <div class=highlight><pre><span></span><code><a id=__codelineno-478-1 name=__codelineno-478-1 href=#__codelineno-478-1></a><span class=nn>---</span>
<a id=__codelineno-478-2 name=__codelineno-478-2 href=#__codelineno-478-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">192.168.77.131</span>
<a id=__codelineno-478-3 name=__codelineno-478-3 href=#__codelineno-478-3></a>
<a id=__codelineno-478-4 name=__codelineno-478-4 href=#__codelineno-478-4></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-478-5 name=__codelineno-478-5 href=#__codelineno-478-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">sleep 100 &amp;&amp; hostname</span>
<a id=__codelineno-478-6 name=__codelineno-478-6 href=#__codelineno-478-6></a><span class=w>      </span><span class=nt>async</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<a id=__codelineno-478-7 name=__codelineno-478-7 href=#__codelineno-478-7></a><span class=w>      </span><span class=nt>poll</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<a id=__codelineno-478-8 name=__codelineno-478-8 href=#__codelineno-478-8></a><span class=w>      </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">result</span>
<a id=__codelineno-478-9 name=__codelineno-478-9 href=#__codelineno-478-9></a>
<a id=__codelineno-478-10 name=__codelineno-478-10 href=#__codelineno-478-10></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">var=result</span>
<a id=__codelineno-478-11 name=__codelineno-478-11 href=#__codelineno-478-11></a>
<a id=__codelineno-478-12 name=__codelineno-478-12 href=#__codelineno-478-12></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>async_status</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jid={{  result.ansible_job_id }}</span>
<a id=__codelineno-478-13 name=__codelineno-478-13 href=#__codelineno-478-13></a><span class=w>      </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">job_result</span>
<a id=__codelineno-478-14 name=__codelineno-478-14 href=#__codelineno-478-14></a><span class=w>      </span><span class=nt>until</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">job_result.finished</span>
<a id=__codelineno-478-15 name=__codelineno-478-15 href=#__codelineno-478-15></a><span class=w>      </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
</code></pre></div> <blockquote> <p>poll指定任务的轮训值，poll=0时，任务执行后，会立即执行下一条任务。poll&gt;0时，会阻塞任务，直到任务执行完毕或超时。没有设置的时候，取默认值<code>DEFAULT_POLL_INTERVAL</code></p> </blockquote> <ul> <li>第一个任务，指定shell任务为异步执行，100秒后任务失败。</li> <li>第二个任务，获取异步任务的返回值，其目的是获取jid。</li> <li>第三个任务，检查jid异步任务的状态，当异步任务的finished不为0时，异步任务执行成功。检查次数为30次，间隔5秒。</li> </ul> <p>运行playbook的结果信息 <div class=highlight><pre><span></span><code><a id=__codelineno-479-1 name=__codelineno-479-1 href=#__codelineno-479-1></a><span class=c1># ansible-playbook  asynctest.yml -vv</span>
<a id=__codelineno-479-2 name=__codelineno-479-2 href=#__codelineno-479-2></a>ansible-playbook<span class=w> </span><span class=m>2</span>.9.6
<a id=__codelineno-479-3 name=__codelineno-479-3 href=#__codelineno-479-3></a><span class=w>  </span>config<span class=w> </span><span class=nv>file</span><span class=w> </span><span class=o>=</span><span class=w> </span>/etc/ansible/ansible.cfg
<a id=__codelineno-479-4 name=__codelineno-479-4 href=#__codelineno-479-4></a><span class=w>  </span>configured<span class=w> </span>module<span class=w> </span>search<span class=w> </span><span class=nv>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>[</span>u<span class=s1>&#39;/root/.ansible/plugins/modules&#39;</span>,<span class=w> </span>u<span class=s1>&#39;/usr/share/ansible/plugins/modules&#39;</span><span class=o>]</span>
<a id=__codelineno-479-5 name=__codelineno-479-5 href=#__codelineno-479-5></a><span class=w>  </span>ansible<span class=w> </span>python<span class=w> </span>module<span class=w> </span><span class=nv>location</span><span class=w> </span><span class=o>=</span><span class=w> </span>/usr/lib/python2.7/site-packages/ansible
<a id=__codelineno-479-6 name=__codelineno-479-6 href=#__codelineno-479-6></a><span class=w>  </span>executable<span class=w> </span><span class=nv>location</span><span class=w> </span><span class=o>=</span><span class=w> </span>/usr/bin/ansible-playbook
<a id=__codelineno-479-7 name=__codelineno-479-7 href=#__codelineno-479-7></a><span class=w>  </span>python<span class=w> </span><span class=nv>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>2</span>.7.5<span class=w> </span><span class=o>(</span>default,<span class=w> </span>Aug<span class=w>  </span><span class=m>4</span><span class=w> </span><span class=m>2017</span>,<span class=w> </span><span class=m>00</span>:39:18<span class=o>)</span><span class=w> </span><span class=o>[</span>GCC<span class=w> </span><span class=m>4</span>.8.5<span class=w> </span><span class=m>20150623</span><span class=w> </span><span class=o>(</span>Red<span class=w> </span>Hat<span class=w> </span><span class=m>4</span>.8.5-16<span class=o>)]</span>
<a id=__codelineno-479-8 name=__codelineno-479-8 href=#__codelineno-479-8></a>Using<span class=w> </span>/etc/ansible/ansible.cfg<span class=w> </span>as<span class=w> </span>config<span class=w> </span>file
<a id=__codelineno-479-9 name=__codelineno-479-9 href=#__codelineno-479-9></a>
<a id=__codelineno-479-10 name=__codelineno-479-10 href=#__codelineno-479-10></a>PLAYBOOK:<span class=w> </span>asynctest.yaml<span class=w> </span>******************************************************************************************************************
<a id=__codelineno-479-11 name=__codelineno-479-11 href=#__codelineno-479-11></a><span class=m>1</span><span class=w> </span>plays<span class=w> </span><span class=k>in</span><span class=w> </span>asynctest.yaml
<a id=__codelineno-479-12 name=__codelineno-479-12 href=#__codelineno-479-12></a>
<a id=__codelineno-479-13 name=__codelineno-479-13 href=#__codelineno-479-13></a>PLAY<span class=w> </span><span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span><span class=w> </span>*********************************************************************************************************************
<a id=__codelineno-479-14 name=__codelineno-479-14 href=#__codelineno-479-14></a>
<a id=__codelineno-479-15 name=__codelineno-479-15 href=#__codelineno-479-15></a>TASK<span class=w> </span><span class=o>[</span>Gathering<span class=w> </span>Facts<span class=o>]</span><span class=w> </span>********************************************************************************************************************
<a id=__codelineno-479-16 name=__codelineno-479-16 href=#__codelineno-479-16></a>task<span class=w> </span>path:<span class=w> </span>/etc/ansible/asynctest.yaml:2
<a id=__codelineno-479-17 name=__codelineno-479-17 href=#__codelineno-479-17></a>ok:<span class=w> </span><span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span>
<a id=__codelineno-479-18 name=__codelineno-479-18 href=#__codelineno-479-18></a>META:<span class=w> </span>ran<span class=w> </span>handlers
<a id=__codelineno-479-19 name=__codelineno-479-19 href=#__codelineno-479-19></a>
<a id=__codelineno-479-20 name=__codelineno-479-20 href=#__codelineno-479-20></a>TASK<span class=w> </span><span class=o>[</span>shell<span class=o>]</span><span class=w> </span>******************************************************************************************************************************
<a id=__codelineno-479-21 name=__codelineno-479-21 href=#__codelineno-479-21></a>task<span class=w> </span>path:<span class=w> </span>/etc/ansible/asynctest.yaml:5
<a id=__codelineno-479-22 name=__codelineno-479-22 href=#__codelineno-479-22></a>changed:<span class=w> </span><span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span><span class=s2>&quot;ansible_job_id&quot;</span>:<span class=w> </span><span class=s2>&quot;965275577324.14846&quot;</span>,<span class=w> </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>true,<span class=w> </span><span class=s2>&quot;finished&quot;</span>:<span class=w> </span><span class=m>0</span>,<span class=w> </span><span class=s2>&quot;results_file&quot;</span>:<span class=w> </span><span class=s2>&quot;/root/.ansible_async/965275577324.14846&quot;</span>,<span class=w> </span><span class=s2>&quot;started&quot;</span>:<span class=w> </span><span class=m>1</span><span class=o>}</span>
<a id=__codelineno-479-23 name=__codelineno-479-23 href=#__codelineno-479-23></a>
<a id=__codelineno-479-24 name=__codelineno-479-24 href=#__codelineno-479-24></a>TASK<span class=w> </span><span class=o>[</span>debug<span class=o>]</span><span class=w> </span>******************************************************************************************************************************
<a id=__codelineno-479-25 name=__codelineno-479-25 href=#__codelineno-479-25></a>task<span class=w> </span>path:<span class=w> </span>/etc/ansible/asynctest.yaml:9
<a id=__codelineno-479-26 name=__codelineno-479-26 href=#__codelineno-479-26></a>ok:<span class=w> </span><span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span>
<a id=__codelineno-479-27 name=__codelineno-479-27 href=#__codelineno-479-27></a><span class=w>    </span><span class=s2>&quot;result&quot;</span>:<span class=w> </span><span class=o>{</span>
<a id=__codelineno-479-28 name=__codelineno-479-28 href=#__codelineno-479-28></a><span class=w>        </span><span class=s2>&quot;ansible_job_id&quot;</span>:<span class=w> </span><span class=s2>&quot;965275577324.14846&quot;</span>,<span class=w> </span>
<a id=__codelineno-479-29 name=__codelineno-479-29 href=#__codelineno-479-29></a><span class=w>        </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>true,<span class=w> </span>
<a id=__codelineno-479-30 name=__codelineno-479-30 href=#__codelineno-479-30></a><span class=w>        </span><span class=s2>&quot;failed&quot;</span>:<span class=w> </span>false,<span class=w> </span>
<a id=__codelineno-479-31 name=__codelineno-479-31 href=#__codelineno-479-31></a><span class=w>        </span><span class=s2>&quot;finished&quot;</span>:<span class=w> </span><span class=m>0</span>,<span class=w> </span>
<a id=__codelineno-479-32 name=__codelineno-479-32 href=#__codelineno-479-32></a><span class=w>        </span><span class=s2>&quot;results_file&quot;</span>:<span class=w> </span><span class=s2>&quot;/root/.ansible_async/965275577324.14846&quot;</span>,<span class=w> </span>
<a id=__codelineno-479-33 name=__codelineno-479-33 href=#__codelineno-479-33></a><span class=w>        </span><span class=s2>&quot;started&quot;</span>:<span class=w> </span><span class=m>1</span>
<a id=__codelineno-479-34 name=__codelineno-479-34 href=#__codelineno-479-34></a><span class=w>    </span><span class=o>}</span>
<a id=__codelineno-479-35 name=__codelineno-479-35 href=#__codelineno-479-35></a><span class=o>}</span>
<a id=__codelineno-479-36 name=__codelineno-479-36 href=#__codelineno-479-36></a>
<a id=__codelineno-479-37 name=__codelineno-479-37 href=#__codelineno-479-37></a>TASK<span class=w> </span><span class=o>[</span>async_status<span class=o>]</span><span class=w> </span>***********************************************************************************************************************
<a id=__codelineno-479-38 name=__codelineno-479-38 href=#__codelineno-479-38></a>task<span class=w> </span>path:<span class=w> </span>/etc/ansible/asynctest.yaml:11
<a id=__codelineno-479-39 name=__codelineno-479-39 href=#__codelineno-479-39></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>30</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-40 name=__codelineno-479-40 href=#__codelineno-479-40></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>29</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-41 name=__codelineno-479-41 href=#__codelineno-479-41></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>28</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-42 name=__codelineno-479-42 href=#__codelineno-479-42></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>27</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-43 name=__codelineno-479-43 href=#__codelineno-479-43></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>26</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-44 name=__codelineno-479-44 href=#__codelineno-479-44></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>25</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-45 name=__codelineno-479-45 href=#__codelineno-479-45></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>24</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-46 name=__codelineno-479-46 href=#__codelineno-479-46></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>23</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-47 name=__codelineno-479-47 href=#__codelineno-479-47></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>22</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-48 name=__codelineno-479-48 href=#__codelineno-479-48></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>21</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-49 name=__codelineno-479-49 href=#__codelineno-479-49></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>20</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-50 name=__codelineno-479-50 href=#__codelineno-479-50></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>19</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-51 name=__codelineno-479-51 href=#__codelineno-479-51></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>18</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-52 name=__codelineno-479-52 href=#__codelineno-479-52></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>17</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-53 name=__codelineno-479-53 href=#__codelineno-479-53></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>16</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-54 name=__codelineno-479-54 href=#__codelineno-479-54></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>15</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-55 name=__codelineno-479-55 href=#__codelineno-479-55></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>14</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-56 name=__codelineno-479-56 href=#__codelineno-479-56></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>13</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-57 name=__codelineno-479-57 href=#__codelineno-479-57></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>12</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-58 name=__codelineno-479-58 href=#__codelineno-479-58></a>FAILED<span class=w> </span>-<span class=w> </span>RETRYING:<span class=w> </span>async_status<span class=w> </span><span class=o>(</span><span class=m>11</span><span class=w> </span>retries<span class=w> </span>left<span class=o>)</span>.
<a id=__codelineno-479-59 name=__codelineno-479-59 href=#__codelineno-479-59></a>changed:<span class=w> </span><span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span><span class=s2>&quot;ansible_job_id&quot;</span>:<span class=w> </span><span class=s2>&quot;965275577324.14846&quot;</span>,<span class=w> </span><span class=s2>&quot;attempts&quot;</span>:<span class=w> </span><span class=m>21</span>,<span class=w> </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>true,<span class=w> </span><span class=s2>&quot;cmd&quot;</span>:<span class=w> </span><span class=s2>&quot;sleep 100 &amp;&amp; hostname&quot;</span>,<span class=w> </span><span class=s2>&quot;delta&quot;</span>:<span class=w> </span><span class=s2>&quot;0:01:40.069235&quot;</span>,<span class=w> </span><span class=s2>&quot;end&quot;</span>:<span class=w> </span><span class=s2>&quot;2020-04-03 21:59:52.442879&quot;</span>,<span class=w> </span><span class=s2>&quot;finished&quot;</span>:<span class=w> </span><span class=m>1</span>,<span class=w> </span><span class=s2>&quot;rc&quot;</span>:<span class=w> </span><span class=m>0</span>,<span class=w> </span><span class=s2>&quot;start&quot;</span>:<span class=w> </span><span class=s2>&quot;2020-04-03 21:58:12.373644&quot;</span>,<span class=w> </span><span class=s2>&quot;stderr&quot;</span>:<span class=w> </span><span class=s2>&quot;&quot;</span>,<span class=w> </span><span class=s2>&quot;stderr_lines&quot;</span>:<span class=w> </span><span class=o>[]</span>,<span class=w> </span><span class=s2>&quot;stdout&quot;</span>:<span class=w> </span><span class=s2>&quot;node131&quot;</span>,<span class=w> </span><span class=s2>&quot;stdout_lines&quot;</span>:<span class=w> </span><span class=o>[</span><span class=s2>&quot;node131&quot;</span><span class=o>]}</span>
<a id=__codelineno-479-60 name=__codelineno-479-60 href=#__codelineno-479-60></a>META:<span class=w> </span>ran<span class=w> </span>handlers
<a id=__codelineno-479-61 name=__codelineno-479-61 href=#__codelineno-479-61></a>META:<span class=w> </span>ran<span class=w> </span>handlers
<a id=__codelineno-479-62 name=__codelineno-479-62 href=#__codelineno-479-62></a>
<a id=__codelineno-479-63 name=__codelineno-479-63 href=#__codelineno-479-63></a>PLAY<span class=w> </span>RECAP<span class=w> </span>********************************************************************************************************************************
<a id=__codelineno-479-64 name=__codelineno-479-64 href=#__codelineno-479-64></a><span class=m>192</span>.168.77.131<span class=w>             </span>:<span class=w> </span><span class=nv>ok</span><span class=o>=</span><span class=m>4</span><span class=w>    </span><span class=nv>changed</span><span class=o>=</span><span class=m>2</span><span class=w>    </span><span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span><span class=w>    </span><span class=nv>failed</span><span class=o>=</span><span class=m>0</span><span class=w>    </span><span class=nv>skipped</span><span class=o>=</span><span class=m>0</span><span class=w>    </span><span class=nv>rescued</span><span class=o>=</span><span class=m>0</span><span class=w>    </span><span class=nv>ignored</span><span class=o>=</span><span class=m>0</span><span class=w>   </span>
</code></pre></div></p> <p>使用ansible来执行异步</p> <p><div class=highlight><pre><span></span><code><a id=__codelineno-480-1 name=__codelineno-480-1 href=#__codelineno-480-1></a><span class=c1># ansible 192.168.77.131 -B 3600 -P 0 -o -m shell -a &quot;sleep 30&quot; -vv</span>
<a id=__codelineno-480-2 name=__codelineno-480-2 href=#__codelineno-480-2></a>ansible<span class=w> </span><span class=m>2</span>.9.6
<a id=__codelineno-480-3 name=__codelineno-480-3 href=#__codelineno-480-3></a><span class=w>  </span>config<span class=w> </span><span class=nv>file</span><span class=w> </span><span class=o>=</span><span class=w> </span>/etc/ansible/ansible.cfg
<a id=__codelineno-480-4 name=__codelineno-480-4 href=#__codelineno-480-4></a><span class=w>  </span>configured<span class=w> </span>module<span class=w> </span>search<span class=w> </span><span class=nv>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>[</span>u<span class=s1>&#39;/root/.ansible/plugins/modules&#39;</span>,<span class=w> </span>u<span class=s1>&#39;/usr/share/ansible/plugins/modules&#39;</span><span class=o>]</span>
<a id=__codelineno-480-5 name=__codelineno-480-5 href=#__codelineno-480-5></a><span class=w>  </span>ansible<span class=w> </span>python<span class=w> </span>module<span class=w> </span><span class=nv>location</span><span class=w> </span><span class=o>=</span><span class=w> </span>/usr/lib/python2.7/site-packages/ansible
<a id=__codelineno-480-6 name=__codelineno-480-6 href=#__codelineno-480-6></a><span class=w>  </span>executable<span class=w> </span><span class=nv>location</span><span class=w> </span><span class=o>=</span><span class=w> </span>/usr/bin/ansible
<a id=__codelineno-480-7 name=__codelineno-480-7 href=#__codelineno-480-7></a><span class=w>  </span>python<span class=w> </span><span class=nv>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>2</span>.7.5<span class=w> </span><span class=o>(</span>default,<span class=w> </span>Aug<span class=w>  </span><span class=m>4</span><span class=w> </span><span class=m>2017</span>,<span class=w> </span><span class=m>00</span>:39:18<span class=o>)</span><span class=w> </span><span class=o>[</span>GCC<span class=w> </span><span class=m>4</span>.8.5<span class=w> </span><span class=m>20150623</span><span class=w> </span><span class=o>(</span>Red<span class=w> </span>Hat<span class=w> </span><span class=m>4</span>.8.5-16<span class=o>)]</span>
<a id=__codelineno-480-8 name=__codelineno-480-8 href=#__codelineno-480-8></a>Using<span class=w> </span>/etc/ansible/ansible.cfg<span class=w> </span>as<span class=w> </span>config<span class=w> </span>file
<a id=__codelineno-480-9 name=__codelineno-480-9 href=#__codelineno-480-9></a>META:<span class=w> </span>ran<span class=w> </span>handlers
<a id=__codelineno-480-10 name=__codelineno-480-10 href=#__codelineno-480-10></a><span class=m>192</span>.168.77.131<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>CHANGED</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span><span class=s2>&quot;ansible_facts&quot;</span>:<span class=w> </span><span class=o>{</span><span class=s2>&quot;discovered_interpreter_python&quot;</span>:<span class=w> </span><span class=s2>&quot;/usr/bin/python&quot;</span><span class=o>}</span>,<span class=w> </span><span class=s2>&quot;ansible_job_id&quot;</span>:<span class=w> </span><span class=s2>&quot;71761724165.16525&quot;</span>,<span class=w> </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>true,<span class=w> </span><span class=s2>&quot;finished&quot;</span>:<span class=w> </span><span class=m>0</span>,<span class=w> </span><span class=s2>&quot;results_file&quot;</span>:<span class=w> </span><span class=s2>&quot;/root/.ansible_async/71761724165.16525&quot;</span>,<span class=w> </span><span class=s2>&quot;started&quot;</span>:<span class=w> </span><span class=m>1</span><span class=o>}</span>
<a id=__codelineno-480-11 name=__codelineno-480-11 href=#__codelineno-480-11></a>META:<span class=w> </span>ran<span class=w> </span>handlers
<a id=__codelineno-480-12 name=__codelineno-480-12 href=#__codelineno-480-12></a>META:<span class=w> </span>ran<span class=w> </span>handlers
</code></pre></div> 使用<code>async_status</code>来获取异步状态信息 <div class=highlight><pre><span></span><code><a id=__codelineno-481-1 name=__codelineno-481-1 href=#__codelineno-481-1></a><span class=c1># ansible 192.168.77.131 -m  async_status -a &quot;jid=71761724165.16525&quot;</span>
<a id=__codelineno-481-2 name=__codelineno-481-2 href=#__codelineno-481-2></a><span class=m>192</span>.168.77.131<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>SUCCESS</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span>
<a id=__codelineno-481-3 name=__codelineno-481-3 href=#__codelineno-481-3></a><span class=w>    </span><span class=s2>&quot;ansible_facts&quot;</span>:<span class=w> </span><span class=o>{</span>
<a id=__codelineno-481-4 name=__codelineno-481-4 href=#__codelineno-481-4></a><span class=w>        </span><span class=s2>&quot;discovered_interpreter_python&quot;</span>:<span class=w> </span><span class=s2>&quot;/usr/bin/python&quot;</span>
<a id=__codelineno-481-5 name=__codelineno-481-5 href=#__codelineno-481-5></a><span class=w>    </span><span class=o>}</span>,<span class=w> </span>
<a id=__codelineno-481-6 name=__codelineno-481-6 href=#__codelineno-481-6></a><span class=w>    </span><span class=s2>&quot;ansible_job_id&quot;</span>:<span class=w> </span><span class=s2>&quot;71761724165.16525&quot;</span>,<span class=w> </span>
<a id=__codelineno-481-7 name=__codelineno-481-7 href=#__codelineno-481-7></a><span class=w>    </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>false,<span class=w> </span>
<a id=__codelineno-481-8 name=__codelineno-481-8 href=#__codelineno-481-8></a><span class=w>    </span><span class=s2>&quot;finished&quot;</span>:<span class=w> </span><span class=m>0</span>,<span class=w> </span>
<a id=__codelineno-481-9 name=__codelineno-481-9 href=#__codelineno-481-9></a><span class=w>    </span><span class=s2>&quot;started&quot;</span>:<span class=w> </span><span class=m>1</span>
<a id=__codelineno-481-10 name=__codelineno-481-10 href=#__codelineno-481-10></a><span class=o>}</span>
<a id=__codelineno-481-11 name=__codelineno-481-11 href=#__codelineno-481-11></a>
<a id=__codelineno-481-12 name=__codelineno-481-12 href=#__codelineno-481-12></a><span class=c1># .... 等待任务执行完成</span>
<a id=__codelineno-481-13 name=__codelineno-481-13 href=#__codelineno-481-13></a>
<a id=__codelineno-481-14 name=__codelineno-481-14 href=#__codelineno-481-14></a><span class=c1># ansible 192.168.77.131 -m  async_status -a &quot;jid=71761724165.16525&quot;</span>
<a id=__codelineno-481-15 name=__codelineno-481-15 href=#__codelineno-481-15></a><span class=m>192</span>.168.77.131<span class=w> </span><span class=p>|</span><span class=w> </span><span class=nv>CHANGED</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span>
<a id=__codelineno-481-16 name=__codelineno-481-16 href=#__codelineno-481-16></a><span class=w>    </span><span class=s2>&quot;ansible_facts&quot;</span>:<span class=w> </span><span class=o>{</span>
<a id=__codelineno-481-17 name=__codelineno-481-17 href=#__codelineno-481-17></a><span class=w>        </span><span class=s2>&quot;discovered_interpreter_python&quot;</span>:<span class=w> </span><span class=s2>&quot;/usr/bin/python&quot;</span>
<a id=__codelineno-481-18 name=__codelineno-481-18 href=#__codelineno-481-18></a><span class=w>    </span><span class=o>}</span>,<span class=w> </span>
<a id=__codelineno-481-19 name=__codelineno-481-19 href=#__codelineno-481-19></a><span class=w>    </span><span class=s2>&quot;ansible_job_id&quot;</span>:<span class=w> </span><span class=s2>&quot;71761724165.16525&quot;</span>,<span class=w> </span>
<a id=__codelineno-481-20 name=__codelineno-481-20 href=#__codelineno-481-20></a><span class=w>    </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>true,<span class=w> </span>
<a id=__codelineno-481-21 name=__codelineno-481-21 href=#__codelineno-481-21></a><span class=w>    </span><span class=s2>&quot;cmd&quot;</span>:<span class=w> </span><span class=s2>&quot;sleep 30&quot;</span>,<span class=w> </span>
<a id=__codelineno-481-22 name=__codelineno-481-22 href=#__codelineno-481-22></a><span class=w>    </span><span class=s2>&quot;delta&quot;</span>:<span class=w> </span><span class=s2>&quot;0:00:30.059717&quot;</span>,<span class=w> </span>
<a id=__codelineno-481-23 name=__codelineno-481-23 href=#__codelineno-481-23></a><span class=w>    </span><span class=s2>&quot;end&quot;</span>:<span class=w> </span><span class=s2>&quot;2020-04-03 22:09:37.777453&quot;</span>,<span class=w> </span>
<a id=__codelineno-481-24 name=__codelineno-481-24 href=#__codelineno-481-24></a><span class=w>    </span><span class=s2>&quot;finished&quot;</span>:<span class=w> </span><span class=m>1</span>,<span class=w> </span>
<a id=__codelineno-481-25 name=__codelineno-481-25 href=#__codelineno-481-25></a><span class=w>    </span><span class=s2>&quot;rc&quot;</span>:<span class=w> </span><span class=m>0</span>,<span class=w> </span>
<a id=__codelineno-481-26 name=__codelineno-481-26 href=#__codelineno-481-26></a><span class=w>    </span><span class=s2>&quot;start&quot;</span>:<span class=w> </span><span class=s2>&quot;2020-04-03 22:09:07.717736&quot;</span>,<span class=w> </span>
<a id=__codelineno-481-27 name=__codelineno-481-27 href=#__codelineno-481-27></a><span class=w>    </span><span class=s2>&quot;stderr&quot;</span>:<span class=w> </span><span class=s2>&quot;&quot;</span>,<span class=w> </span>
<a id=__codelineno-481-28 name=__codelineno-481-28 href=#__codelineno-481-28></a><span class=w>    </span><span class=s2>&quot;stderr_lines&quot;</span>:<span class=w> </span><span class=o>[]</span>,<span class=w> </span>
<a id=__codelineno-481-29 name=__codelineno-481-29 href=#__codelineno-481-29></a><span class=w>    </span><span class=s2>&quot;stdout&quot;</span>:<span class=w> </span><span class=s2>&quot;&quot;</span>,<span class=w> </span>
<a id=__codelineno-481-30 name=__codelineno-481-30 href=#__codelineno-481-30></a><span class=w>    </span><span class=s2>&quot;stdout_lines&quot;</span>:<span class=w> </span><span class=o>[]</span>
<a id=__codelineno-481-31 name=__codelineno-481-31 href=#__codelineno-481-31></a><span class=o>}</span>
</code></pre></div></p> <ul> <li>注意：在使用'command', 'win_command', 'shell', 'win_shell', 'raw'模块时，是不会返回信息的。</li> </ul> <p>限制并发运行的任务数量的同时运行多个异步任务</p> <div class=highlight><pre><span></span><code><a id=__codelineno-482-1 name=__codelineno-482-1 href=#__codelineno-482-1></a><span class=c1>#####################</span>
<a id=__codelineno-482-2 name=__codelineno-482-2 href=#__codelineno-482-2></a><span class=c1># main.yml</span>
<a id=__codelineno-482-3 name=__codelineno-482-3 href=#__codelineno-482-3></a><span class=c1>#####################</span>
<a id=__codelineno-482-4 name=__codelineno-482-4 href=#__codelineno-482-4></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Run items asynchronously in batch of two items</span>
<a id=__codelineno-482-5 name=__codelineno-482-5 href=#__codelineno-482-5></a><span class=w>  </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-482-6 name=__codelineno-482-6 href=#__codelineno-482-6></a><span class=w>    </span><span class=nt>sleep_durations</span><span class=p>:</span>
<a id=__codelineno-482-7 name=__codelineno-482-7 href=#__codelineno-482-7></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-482-8 name=__codelineno-482-8 href=#__codelineno-482-8></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a id=__codelineno-482-9 name=__codelineno-482-9 href=#__codelineno-482-9></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id=__codelineno-482-10 name=__codelineno-482-10 href=#__codelineno-482-10></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<a id=__codelineno-482-11 name=__codelineno-482-11 href=#__codelineno-482-11></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<a id=__codelineno-482-12 name=__codelineno-482-12 href=#__codelineno-482-12></a><span class=w>    </span><span class=nt>durations</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-482-13 name=__codelineno-482-13 href=#__codelineno-482-13></a><span class=w>  </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">execute_batch.yml</span>
<a id=__codelineno-482-14 name=__codelineno-482-14 href=#__codelineno-482-14></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>sleep_durations</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>batch(2)</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>list</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-482-15 name=__codelineno-482-15 href=#__codelineno-482-15></a>
<a id=__codelineno-482-16 name=__codelineno-482-16 href=#__codelineno-482-16></a><span class=c1>#####################</span>
<a id=__codelineno-482-17 name=__codelineno-482-17 href=#__codelineno-482-17></a><span class=c1># execute_batch.yml</span>
<a id=__codelineno-482-18 name=__codelineno-482-18 href=#__codelineno-482-18></a><span class=c1>#####################</span>
<a id=__codelineno-482-19 name=__codelineno-482-19 href=#__codelineno-482-19></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Async sleeping for batched_items</span>
<a id=__codelineno-482-20 name=__codelineno-482-20 href=#__codelineno-482-20></a><span class=w>  </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">sleep {{ async_item }}</span>
<a id=__codelineno-482-21 name=__codelineno-482-21 href=#__codelineno-482-21></a><span class=w>  </span><span class=nt>async</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">45</span>
<a id=__codelineno-482-22 name=__codelineno-482-22 href=#__codelineno-482-22></a><span class=w>  </span><span class=nt>poll</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<a id=__codelineno-482-23 name=__codelineno-482-23 href=#__codelineno-482-23></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>durations</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-482-24 name=__codelineno-482-24 href=#__codelineno-482-24></a><span class=w>  </span><span class=nt>loop_control</span><span class=p>:</span>
<a id=__codelineno-482-25 name=__codelineno-482-25 href=#__codelineno-482-25></a><span class=w>    </span><span class=nt>loop_var</span><span class=p>:</span><span class=w> </span><span class=s>&quot;async_item&quot;</span>
<a id=__codelineno-482-26 name=__codelineno-482-26 href=#__codelineno-482-26></a><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">async_results</span>
<a id=__codelineno-482-27 name=__codelineno-482-27 href=#__codelineno-482-27></a>
<a id=__codelineno-482-28 name=__codelineno-482-28 href=#__codelineno-482-28></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Check sync status</span>
<a id=__codelineno-482-29 name=__codelineno-482-29 href=#__codelineno-482-29></a><span class=w>  </span><span class=nt>async_status</span><span class=p>:</span>
<a id=__codelineno-482-30 name=__codelineno-482-30 href=#__codelineno-482-30></a><span class=w>    </span><span class=nt>jid</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>async_result_item.ansible_job_id</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-482-31 name=__codelineno-482-31 href=#__codelineno-482-31></a><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>async_results.results</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-482-32 name=__codelineno-482-32 href=#__codelineno-482-32></a><span class=w>  </span><span class=nt>loop_control</span><span class=p>:</span>
<a id=__codelineno-482-33 name=__codelineno-482-33 href=#__codelineno-482-33></a><span class=w>    </span><span class=nt>loop_var</span><span class=p>:</span><span class=w> </span><span class=s>&quot;async_result_item&quot;</span>
<a id=__codelineno-482-34 name=__codelineno-482-34 href=#__codelineno-482-34></a><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">async_poll_results</span>
<a id=__codelineno-482-35 name=__codelineno-482-35 href=#__codelineno-482-35></a><span class=w>  </span><span class=nt>until</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">async_poll_results.finished</span>
<a id=__codelineno-482-36 name=__codelineno-482-36 href=#__codelineno-482-36></a><span class=w>  </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
</code></pre></div> <p>一个重启服务器的playbook <div class=highlight><pre><span></span><code><a id=__codelineno-483-1 name=__codelineno-483-1 href=#__codelineno-483-1></a><span class=nn>---</span>
<a id=__codelineno-483-2 name=__codelineno-483-2 href=#__codelineno-483-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">192.168.77.131</span>
<a id=__codelineno-483-3 name=__codelineno-483-3 href=#__codelineno-483-3></a><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
<a id=__codelineno-483-4 name=__codelineno-483-4 href=#__codelineno-483-4></a><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-483-5 name=__codelineno-483-5 href=#__codelineno-483-5></a>
<a id=__codelineno-483-6 name=__codelineno-483-6 href=#__codelineno-483-6></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-483-7 name=__codelineno-483-7 href=#__codelineno-483-7></a><span class=w>   </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Check the uptime prior reboot</span>
<a id=__codelineno-483-8 name=__codelineno-483-8 href=#__codelineno-483-8></a><span class=w>     </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">uptime</span>
<a id=__codelineno-483-9 name=__codelineno-483-9 href=#__codelineno-483-9></a><span class=w>     </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">UPTIME_PRE_REBOOT</span>
<a id=__codelineno-483-10 name=__codelineno-483-10 href=#__codelineno-483-10></a>
<a id=__codelineno-483-11 name=__codelineno-483-11 href=#__codelineno-483-11></a><span class=w>   </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg={{UPTIME_PRE_REBOOT.stdout}}</span>
<a id=__codelineno-483-12 name=__codelineno-483-12 href=#__codelineno-483-12></a>
<a id=__codelineno-483-13 name=__codelineno-483-13 href=#__codelineno-483-13></a><span class=w>   </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Reboot node and stop polling.</span>
<a id=__codelineno-483-14 name=__codelineno-483-14 href=#__codelineno-483-14></a><span class=w>     </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">reboot</span>
<a id=__codelineno-483-15 name=__codelineno-483-15 href=#__codelineno-483-15></a><span class=w>     </span><span class=nt>async</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class=w> </span><span class=c1># Do not care for 10 sec</span>
<a id=__codelineno-483-16 name=__codelineno-483-16 href=#__codelineno-483-16></a><span class=w>     </span><span class=nt>poll</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">0</span><span class=w> </span><span class=c1># Fire &amp; Forget</span>
<a id=__codelineno-483-17 name=__codelineno-483-17 href=#__codelineno-483-17></a>
<a id=__codelineno-483-18 name=__codelineno-483-18 href=#__codelineno-483-18></a><span class=w>   </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">wait for host to finish reboot</span>
<a id=__codelineno-483-19 name=__codelineno-483-19 href=#__codelineno-483-19></a><span class=w>     </span><span class=nt>wait_for</span><span class=p>:</span>
<a id=__codelineno-483-20 name=__codelineno-483-20 href=#__codelineno-483-20></a><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>(ansible_port|default(ansible_ssh_port))|default(22)</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-483-21 name=__codelineno-483-21 href=#__codelineno-483-21></a><span class=w>      </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=s>&#39;{{</span><span class=nv> </span><span class=s>(ansible_ssh_host|default(ansible_host))|default(inventory_hostname)</span><span class=nv> </span><span class=s>}}&#39;</span>
<a id=__codelineno-483-22 name=__codelineno-483-22 href=#__codelineno-483-22></a><span class=w>      </span><span class=nt>search_regex</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">OpenSSH</span>
<a id=__codelineno-483-23 name=__codelineno-483-23 href=#__codelineno-483-23></a><span class=w>      </span><span class=nt>delay</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class=w>  </span><span class=c1># Do not check for at least 10 sec</span>
<a id=__codelineno-483-24 name=__codelineno-483-24 href=#__codelineno-483-24></a><span class=w>     </span><span class=nt>connection</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<a id=__codelineno-483-25 name=__codelineno-483-25 href=#__codelineno-483-25></a>
<a id=__codelineno-483-26 name=__codelineno-483-26 href=#__codelineno-483-26></a><span class=w>   </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Check the uptime post reboot</span>
<a id=__codelineno-483-27 name=__codelineno-483-27 href=#__codelineno-483-27></a><span class=w>     </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">uptime</span>
<a id=__codelineno-483-28 name=__codelineno-483-28 href=#__codelineno-483-28></a><span class=w>     </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">UPTIME_POST_REBOOT</span>
<a id=__codelineno-483-29 name=__codelineno-483-29 href=#__codelineno-483-29></a>
<a id=__codelineno-483-30 name=__codelineno-483-30 href=#__codelineno-483-30></a><span class=w>   </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg={{UPTIME_POST_REBOOT.stdout}}</span>
</code></pre></div></p> <h4 id=异步任务的状态文件>异步任务的状态文件<a class=headerlink href=#异步任务的状态文件 title="Permanent link">&para;</a></h4> <p>异步任务的状态文件以jid命名的方式存放在远端主机的用户目录下的.ansible_async目录，本次使用的是root连接远端，所以目录是/root/.ansible_async。</p> <p>查看状态文件</p> <div class=highlight><pre><span></span><code><a id=__codelineno-484-1 name=__codelineno-484-1 href=#__codelineno-484-1></a><span class=c1># cat /root/.ansible_async/71761724165.16525</span>
<a id=__codelineno-484-2 name=__codelineno-484-2 href=#__codelineno-484-2></a><span class=o>{</span><span class=s2>&quot;started&quot;</span>:<span class=w> </span><span class=m>1</span>,<span class=w> </span><span class=s2>&quot;finished&quot;</span>:<span class=w> </span><span class=m>0</span>,<span class=w> </span><span class=s2>&quot;ansible_job_id&quot;</span>:<span class=w> </span><span class=s2>&quot;71761724165.16525&quot;</span><span class=o>}</span>
<a id=__codelineno-484-3 name=__codelineno-484-3 href=#__codelineno-484-3></a>
<a id=__codelineno-484-4 name=__codelineno-484-4 href=#__codelineno-484-4></a><span class=c1># 任务结束后</span>
<a id=__codelineno-484-5 name=__codelineno-484-5 href=#__codelineno-484-5></a>
<a id=__codelineno-484-6 name=__codelineno-484-6 href=#__codelineno-484-6></a><span class=c1># cat /root/.ansible_async/71761724165.16525</span>
<a id=__codelineno-484-7 name=__codelineno-484-7 href=#__codelineno-484-7></a><span class=o>{</span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>true,<span class=w> </span><span class=s2>&quot;end&quot;</span>:<span class=w> </span><span class=s2>&quot;2020-04-03 22:09:37.777453&quot;</span>,<span class=w> </span><span class=s2>&quot;stdout&quot;</span>:<span class=w> </span><span class=s2>&quot;&quot;</span>,<span class=w> </span><span class=s2>&quot;cmd&quot;</span>:<span class=w> </span><span class=s2>&quot;sleep 30&quot;</span>,<span class=w> </span><span class=s2>&quot;start&quot;</span>:<span class=w> </span><span class=s2>&quot;2020-04-03 22:09:07.717736&quot;</span>,<span class=w> </span><span class=s2>&quot;delta&quot;</span>:<span class=w> </span><span class=s2>&quot;0:00:30.059717&quot;</span>,<span class=w> </span><span class=s2>&quot;stderr&quot;</span>:<span class=w> </span><span class=s2>&quot;&quot;</span>,<span class=w> </span><span class=s2>&quot;rc&quot;</span>:<span class=w> </span><span class=m>0</span>,<span class=w> </span><span class=s2>&quot;invocation&quot;</span>:<span class=w> </span><span class=o>{</span><span class=s2>&quot;module_args&quot;</span>:<span class=w> </span><span class=o>{</span><span class=s2>&quot;warn&quot;</span>:<span class=w> </span>true,<span class=w> </span><span class=s2>&quot;executable&quot;</span>:<span class=w> </span>null,<span class=w> </span><span class=s2>&quot;_uses_shell&quot;</span>:<span class=w> </span>true,<span class=w> </span><span class=s2>&quot;strip_empty_ends&quot;</span>:<span class=w> </span>true,<span class=w> </span><span class=s2>&quot;_raw_params&quot;</span>:<span class=w> </span><span class=s2>&quot;sleep 30&quot;</span>,<span class=w> </span><span class=s2>&quot;removes&quot;</span>:<span class=w> </span>null,<span class=w> </span><span class=s2>&quot;argv&quot;</span>:<span class=w> </span>null,<span class=w> </span><span class=s2>&quot;creates&quot;</span>:<span class=w> </span>null,<span class=w> </span><span class=s2>&quot;chdir&quot;</span>:<span class=w> </span>null,<span class=w> </span><span class=s2>&quot;stdin_add_newline&quot;</span>:<span class=w> </span>true,<span class=w> </span><span class=s2>&quot;stdin&quot;</span>:<span class=w> </span>null<span class=o>}}}</span>
</code></pre></div> <h4 id=异步任务的返回值>异步任务的返回值<a class=headerlink href=#异步任务的返回值 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-485-1 name=__codelineno-485-1 href=#__codelineno-485-1></a><span class=p>{</span>
<a id=__codelineno-485-2 name=__codelineno-485-2 href=#__codelineno-485-2></a><span class=w>    </span><span class=nt>&quot;ansible_facts&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-485-3 name=__codelineno-485-3 href=#__codelineno-485-3></a><span class=w>        </span><span class=nt>&quot;discovered_interpreter_python&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/usr/bin/python&quot;</span>
<a id=__codelineno-485-4 name=__codelineno-485-4 href=#__codelineno-485-4></a><span class=w>    </span><span class=p>},</span>
<a id=__codelineno-485-5 name=__codelineno-485-5 href=#__codelineno-485-5></a><span class=w>    </span><span class=nt>&quot;ansible_job_id&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;662217446295.16055&quot;</span><span class=p>,</span>
<a id=__codelineno-485-6 name=__codelineno-485-6 href=#__codelineno-485-6></a><span class=w>    </span><span class=nt>&quot;changed&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span>
<a id=__codelineno-485-7 name=__codelineno-485-7 href=#__codelineno-485-7></a><span class=w>    </span><span class=nt>&quot;finished&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<a id=__codelineno-485-8 name=__codelineno-485-8 href=#__codelineno-485-8></a><span class=w>    </span><span class=nt>&quot;results_file&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;/root/.ansible_async/662217446295.16055&quot;</span><span class=p>,</span>
<a id=__codelineno-485-9 name=__codelineno-485-9 href=#__codelineno-485-9></a><span class=w>    </span><span class=nt>&quot;started&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span>
<a id=__codelineno-485-10 name=__codelineno-485-10 href=#__codelineno-485-10></a><span class=p>}</span>
</code></pre></div> <blockquote> <p>ansible_job_id 异步任务id， results_file异步任务的状态文件</p> </blockquote> <h4 id=异步任务状态的返回值>异步任务状态的返回值<a class=headerlink href=#异步任务状态的返回值 title="Permanent link">&para;</a></h4> <p>可通过 async_status 获取，async_status 是读取远端的异步任务状态文件来获得任务状态，如果async设置的时间太短，可能会导致获取不到状态文件，因为还没生成这个文件。</p> <p>执行中的返回值</p> <div class=highlight><pre><span></span><code><a id=__codelineno-486-1 name=__codelineno-486-1 href=#__codelineno-486-1></a><span class=o>{</span>
<a id=__codelineno-486-2 name=__codelineno-486-2 href=#__codelineno-486-2></a><span class=w>    </span><span class=s2>&quot;ansible_facts&quot;</span>:<span class=w> </span><span class=o>{</span>
<a id=__codelineno-486-3 name=__codelineno-486-3 href=#__codelineno-486-3></a><span class=w>        </span><span class=s2>&quot;discovered_interpreter_python&quot;</span>:<span class=w> </span><span class=s2>&quot;/usr/bin/python&quot;</span>
<a id=__codelineno-486-4 name=__codelineno-486-4 href=#__codelineno-486-4></a><span class=w>    </span><span class=o>}</span>,<span class=w> </span>
<a id=__codelineno-486-5 name=__codelineno-486-5 href=#__codelineno-486-5></a><span class=w>    </span><span class=s2>&quot;ansible_job_id&quot;</span>:<span class=w> </span><span class=s2>&quot;71761724165.16525&quot;</span>,<span class=w> </span>
<a id=__codelineno-486-6 name=__codelineno-486-6 href=#__codelineno-486-6></a><span class=w>    </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>false,<span class=w> </span>
<a id=__codelineno-486-7 name=__codelineno-486-7 href=#__codelineno-486-7></a><span class=w>    </span><span class=s2>&quot;finished&quot;</span>:<span class=w> </span><span class=m>0</span>,<span class=w> </span>
<a id=__codelineno-486-8 name=__codelineno-486-8 href=#__codelineno-486-8></a><span class=w>    </span><span class=s2>&quot;started&quot;</span>:<span class=w> </span><span class=m>1</span>
<a id=__codelineno-486-9 name=__codelineno-486-9 href=#__codelineno-486-9></a><span class=o>}</span>
</code></pre></div> <p>执行完成后的返回值</p> <div class=highlight><pre><span></span><code><a id=__codelineno-487-1 name=__codelineno-487-1 href=#__codelineno-487-1></a><span class=o>{</span>
<a id=__codelineno-487-2 name=__codelineno-487-2 href=#__codelineno-487-2></a><span class=w>    </span><span class=s2>&quot;ansible_facts&quot;</span>:<span class=w> </span><span class=o>{</span>
<a id=__codelineno-487-3 name=__codelineno-487-3 href=#__codelineno-487-3></a><span class=w>        </span><span class=s2>&quot;discovered_interpreter_python&quot;</span>:<span class=w> </span><span class=s2>&quot;/usr/bin/python&quot;</span>
<a id=__codelineno-487-4 name=__codelineno-487-4 href=#__codelineno-487-4></a><span class=w>    </span><span class=o>}</span>,<span class=w> </span>
<a id=__codelineno-487-5 name=__codelineno-487-5 href=#__codelineno-487-5></a><span class=w>    </span><span class=s2>&quot;ansible_job_id&quot;</span>:<span class=w> </span><span class=s2>&quot;71761724165.16525&quot;</span>,<span class=w> </span>
<a id=__codelineno-487-6 name=__codelineno-487-6 href=#__codelineno-487-6></a><span class=w>    </span><span class=s2>&quot;changed&quot;</span>:<span class=w> </span>true,<span class=w> </span>
<a id=__codelineno-487-7 name=__codelineno-487-7 href=#__codelineno-487-7></a><span class=w>    </span><span class=s2>&quot;cmd&quot;</span>:<span class=w> </span><span class=s2>&quot;sleep 30&quot;</span>,<span class=w> </span>
<a id=__codelineno-487-8 name=__codelineno-487-8 href=#__codelineno-487-8></a><span class=w>    </span><span class=s2>&quot;delta&quot;</span>:<span class=w> </span><span class=s2>&quot;0:00:30.059717&quot;</span>,<span class=w> </span>
<a id=__codelineno-487-9 name=__codelineno-487-9 href=#__codelineno-487-9></a><span class=w>    </span><span class=s2>&quot;end&quot;</span>:<span class=w> </span><span class=s2>&quot;2020-04-03 22:09:37.777453&quot;</span>,<span class=w> </span>
<a id=__codelineno-487-10 name=__codelineno-487-10 href=#__codelineno-487-10></a><span class=w>    </span><span class=s2>&quot;finished&quot;</span>:<span class=w> </span><span class=m>1</span>,<span class=w> </span>
<a id=__codelineno-487-11 name=__codelineno-487-11 href=#__codelineno-487-11></a><span class=w>    </span><span class=s2>&quot;rc&quot;</span>:<span class=w> </span><span class=m>0</span>,<span class=w> </span>
<a id=__codelineno-487-12 name=__codelineno-487-12 href=#__codelineno-487-12></a><span class=w>    </span><span class=s2>&quot;start&quot;</span>:<span class=w> </span><span class=s2>&quot;2020-04-03 22:09:07.717736&quot;</span>,<span class=w> </span>
<a id=__codelineno-487-13 name=__codelineno-487-13 href=#__codelineno-487-13></a><span class=w>    </span><span class=s2>&quot;stderr&quot;</span>:<span class=w> </span><span class=s2>&quot;&quot;</span>,<span class=w> </span>
<a id=__codelineno-487-14 name=__codelineno-487-14 href=#__codelineno-487-14></a><span class=w>    </span><span class=s2>&quot;stderr_lines&quot;</span>:<span class=w> </span><span class=o>[]</span>,<span class=w> </span>
<a id=__codelineno-487-15 name=__codelineno-487-15 href=#__codelineno-487-15></a><span class=w>    </span><span class=s2>&quot;stdout&quot;</span>:<span class=w> </span><span class=s2>&quot;&quot;</span>,<span class=w> </span>
<a id=__codelineno-487-16 name=__codelineno-487-16 href=#__codelineno-487-16></a><span class=w>    </span><span class=s2>&quot;stdout_lines&quot;</span>:<span class=w> </span><span class=o>[]</span>
<a id=__codelineno-487-17 name=__codelineno-487-17 href=#__codelineno-487-17></a><span class=o>}</span>
</code></pre></div> <h3 id=检查模式>检查模式<a class=headerlink href=#检查模式 title="Permanent link">&para;</a></h3> <p>当ansible-playbook执行时加上<code>--check</code>选项时，它不会对远程系统做任何更改。支持检查模式的模块将报告它们将进行的更改，而不是进行更改。不支持检查模式的其他模块也将不采取任何操作，只是不报告它们可能做了哪些更改。</p> <p>执行例子</p> <div class=highlight><pre><span></span><code><a id=__codelineno-488-1 name=__codelineno-488-1 href=#__codelineno-488-1></a>ansible-playbook<span class=w> </span>foo.yml<span class=w> </span>--check<span class=w> </span>
</code></pre></div> <p>也可以在任务中使用检查模式</p> <div class=highlight><pre><span></span><code><a id=__codelineno-489-1 name=__codelineno-489-1 href=#__codelineno-489-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-489-2 name=__codelineno-489-2 href=#__codelineno-489-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">this task will make changes to the system even in check mode</span>
<a id=__codelineno-489-3 name=__codelineno-489-3 href=#__codelineno-489-3></a><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/something/to/run --even-in-check-mode</span>
<a id=__codelineno-489-4 name=__codelineno-489-4 href=#__codelineno-489-4></a><span class=w>    </span><span class=nt>check_mode</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
<a id=__codelineno-489-5 name=__codelineno-489-5 href=#__codelineno-489-5></a>
<a id=__codelineno-489-6 name=__codelineno-489-6 href=#__codelineno-489-6></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">this task will always run under checkmode and not change the system</span>
<a id=__codelineno-489-7 name=__codelineno-489-7 href=#__codelineno-489-7></a><span class=w>    </span><span class=nt>lineinfile</span><span class=p>:</span>
<a id=__codelineno-489-8 name=__codelineno-489-8 href=#__codelineno-489-8></a><span class=w>        </span><span class=nt>line</span><span class=p>:</span><span class=w> </span><span class=s>&quot;important</span><span class=nv> </span><span class=s>config&quot;</span>
<a id=__codelineno-489-9 name=__codelineno-489-9 href=#__codelineno-489-9></a><span class=w>        </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/myconfig.conf</span>
<a id=__codelineno-489-10 name=__codelineno-489-10 href=#__codelineno-489-10></a><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id=__codelineno-489-11 name=__codelineno-489-11 href=#__codelineno-489-11></a><span class=w>    </span><span class=nt>check_mode</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div> <p><code>ansible_check_mode</code>变量是用来存储当前是否是检查模式的布尔类型</p> <div class=highlight><pre><span></span><code><a id=__codelineno-490-1 name=__codelineno-490-1 href=#__codelineno-490-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-490-2 name=__codelineno-490-2 href=#__codelineno-490-2></a>
<a id=__codelineno-490-3 name=__codelineno-490-3 href=#__codelineno-490-3></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">this task will be skipped in check mode</span>
<a id=__codelineno-490-4 name=__codelineno-490-4 href=#__codelineno-490-4></a><span class=w>    </span><span class=nt>git</span><span class=p>:</span>
<a id=__codelineno-490-5 name=__codelineno-490-5 href=#__codelineno-490-5></a><span class=w>      </span><span class=nt>repo</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ssh://git@github.com/mylogin/hello.git</span>
<a id=__codelineno-490-6 name=__codelineno-490-6 href=#__codelineno-490-6></a><span class=w>      </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/home/mylogin/hello</span>
<a id=__codelineno-490-7 name=__codelineno-490-7 href=#__codelineno-490-7></a><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">not ansible_check_mode</span>
<a id=__codelineno-490-8 name=__codelineno-490-8 href=#__codelineno-490-8></a>
<a id=__codelineno-490-9 name=__codelineno-490-9 href=#__codelineno-490-9></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">this task will ignore errors in check mode</span>
<a id=__codelineno-490-10 name=__codelineno-490-10 href=#__codelineno-490-10></a><span class=w>    </span><span class=nt>git</span><span class=p>:</span>
<a id=__codelineno-490-11 name=__codelineno-490-11 href=#__codelineno-490-11></a><span class=w>      </span><span class=nt>repo</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ssh://git@github.com/mylogin/hello.git</span>
<a id=__codelineno-490-12 name=__codelineno-490-12 href=#__codelineno-490-12></a><span class=w>      </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/home/mylogin/hello</span>
<a id=__codelineno-490-13 name=__codelineno-490-13 href=#__codelineno-490-13></a><span class=w>    </span><span class=nt>ignore_errors</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>ansible_check_mode</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <p>diff模块</p> <p>ansible-playbook的<code>--diff</code>选项可与<code>--check</code>配合使用（如上详述），但也可以单独使用。 提供此标志且模块支持此标志时，Ansible将报告所做的更改，或者如果与<code>--check</code>一起使用，则将报告所做的更改。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-491-1 name=__codelineno-491-1 href=#__codelineno-491-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<a id=__codelineno-491-2 name=__codelineno-491-2 href=#__codelineno-491-2></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-491-3 name=__codelineno-491-3 href=#__codelineno-491-3></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">debug.</span>
<a id=__codelineno-491-4 name=__codelineno-491-4 href=#__codelineno-491-4></a><span class=w>    </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=123</span>
<a id=__codelineno-491-5 name=__codelineno-491-5 href=#__codelineno-491-5></a><span class=w>    </span><span class=nt>check_mode</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
<a id=__codelineno-491-6 name=__codelineno-491-6 href=#__codelineno-491-6></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">add hosts.</span>
<a id=__codelineno-491-7 name=__codelineno-491-7 href=#__codelineno-491-7></a><span class=w>    </span><span class=nt>lineinfile</span><span class=p>:</span>
<a id=__codelineno-491-8 name=__codelineno-491-8 href=#__codelineno-491-8></a><span class=w>      </span><span class=nt>line</span><span class=p>:</span><span class=w> </span><span class=s>&quot;127.0.0.2</span><span class=nv> </span><span class=s>localhost&quot;</span>
<a id=__codelineno-491-9 name=__codelineno-491-9 href=#__codelineno-491-9></a><span class=w>      </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/etc/hosts</span>
<a id=__codelineno-491-10 name=__codelineno-491-10 href=#__codelineno-491-10></a><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id=__codelineno-491-11 name=__codelineno-491-11 href=#__codelineno-491-11></a><span class=w>      </span><span class=nt>check_mode</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-491-12 name=__codelineno-491-12 href=#__codelineno-491-12></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">add hosts.</span>
<a id=__codelineno-491-13 name=__codelineno-491-13 href=#__codelineno-491-13></a><span class=w>    </span><span class=nt>lineinfile</span><span class=p>:</span>
<a id=__codelineno-491-14 name=__codelineno-491-14 href=#__codelineno-491-14></a><span class=w>      </span><span class=nt>line</span><span class=p>:</span><span class=w> </span><span class=s>&quot;127.0.0.2</span><span class=nv> </span><span class=s>localhost&quot;</span>
<a id=__codelineno-491-15 name=__codelineno-491-15 href=#__codelineno-491-15></a><span class=w>      </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/etc/hosts</span>
<a id=__codelineno-491-16 name=__codelineno-491-16 href=#__codelineno-491-16></a><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id=__codelineno-491-17 name=__codelineno-491-17 href=#__codelineno-491-17></a><span class=w>      </span><span class=nt>diff</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
</code></pre></div> <blockquote> <p>diff: no 禁止对比</p> </blockquote> <p>检查并对比更改</p> <div class=highlight><pre><span></span><code><a id=__codelineno-492-1 name=__codelineno-492-1 href=#__codelineno-492-1></a>ansible-playbook<span class=w>  </span>foo.yml<span class=w> </span>--check<span class=w> </span>--diff
</code></pre></div> <h3 id=debug-功能>debug 功能<a class=headerlink href=#debug-功能 title="Permanent link">&para;</a></h3> <p>Ansible把一个<code>debugger</code>作为<code>strategy</code>插件的一部分。此调试器使您能够作为任务进行调试，这个过程是阻塞运行的。但使用<code>debug</code>模块也可以调试变量或表达式，而不必阻塞playbook。</p> <p>有多种使用调试器的方法。</p> <h4 id=使用-debugger-关键字>使用 debugger 关键字<a class=headerlink href=#使用-debugger-关键字 title="Permanent link">&para;</a></h4> <p>debugger提供几个值</p> <table> <thead> <tr> <th>可选值</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>always</td> <td>总是调用调试器，而不管结果如何</td> </tr> <tr> <td>never</td> <td>不管结果如何，都不要调用调试器</td> </tr> <tr> <td>on_failed</td> <td>只有在任务失败时才调用调试器</td> </tr> <tr> <td>on_unreachable</td> <td>只有在主机无法访问时才调用调试器</td> </tr> <tr> <td>on_skipped</td> <td>只有在任务被跳过时才调用调试器</td> </tr> </tbody> </table> <p>在play中使用</p> <div class=highlight><pre><span></span><code><a id=__codelineno-493-1 name=__codelineno-493-1 href=#__codelineno-493-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Play</span>
<a id=__codelineno-493-2 name=__codelineno-493-2 href=#__codelineno-493-2></a><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
<a id=__codelineno-493-3 name=__codelineno-493-3 href=#__codelineno-493-3></a><span class=w>  </span><span class=nt>debugger</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">on_skipped</span>
<a id=__codelineno-493-4 name=__codelineno-493-4 href=#__codelineno-493-4></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-493-5 name=__codelineno-493-5 href=#__codelineno-493-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Execute a command</span>
<a id=__codelineno-493-6 name=__codelineno-493-6 href=#__codelineno-493-6></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-493-7 name=__codelineno-493-7 href=#__codelineno-493-7></a><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
</code></pre></div> <p>在task中使用</p> <div class=highlight><pre><span></span><code><a id=__codelineno-494-1 name=__codelineno-494-1 href=#__codelineno-494-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Execute a command</span>
<a id=__codelineno-494-2 name=__codelineno-494-2 href=#__codelineno-494-2></a><span class=w>  </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id=__codelineno-494-3 name=__codelineno-494-3 href=#__codelineno-494-3></a><span class=w>  </span><span class=nt>debugger</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">on_failed</span>
</code></pre></div> <p>当play和task同时使用<code>debugger</code>时，task的生效</p> <div class=highlight><pre><span></span><code><a id=__codelineno-495-1 name=__codelineno-495-1 href=#__codelineno-495-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Play</span>
<a id=__codelineno-495-2 name=__codelineno-495-2 href=#__codelineno-495-2></a><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
<a id=__codelineno-495-3 name=__codelineno-495-3 href=#__codelineno-495-3></a><span class=w>  </span><span class=nt>debugger</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">never</span>
<a id=__codelineno-495-4 name=__codelineno-495-4 href=#__codelineno-495-4></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-495-5 name=__codelineno-495-5 href=#__codelineno-495-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Execute a command</span>
<a id=__codelineno-495-6 name=__codelineno-495-6 href=#__codelineno-495-6></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id=__codelineno-495-7 name=__codelineno-495-7 href=#__codelineno-495-7></a><span class=w>      </span><span class=nt>debugger</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">on_failed</span>
</code></pre></div> <h4 id=配置或环境变量>配置或环境变量<a class=headerlink href=#配置或环境变量 title="Permanent link">&para;</a></h4> <p>在<code>ansible.cfg</code>上配置</p> <div class=highlight><pre><span></span><code><a id=__codelineno-496-1 name=__codelineno-496-1 href=#__codelineno-496-1></a><span class=k>[defaults]</span>
<a id=__codelineno-496-2 name=__codelineno-496-2 href=#__codelineno-496-2></a><span class=na>enable_task_debugger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>True</span>
</code></pre></div> <p>或者设置环境变量</p> <div class=highlight><pre><span></span><code><a id=__codelineno-497-1 name=__codelineno-497-1 href=#__codelineno-497-1></a><span class=nv>ANSIBLE_ENABLE_TASK_DEBUGGER</span><span class=o>=</span>True<span class=w> </span>ansible-playbook<span class=w> </span>-i<span class=w> </span>hosts<span class=w> </span>site.yml
</code></pre></div> <h4 id=使用-strategy-插件>使用 strategy 插件<a class=headerlink href=#使用-strategy-插件 title="Permanent link">&para;</a></h4> <p>使用 <code>strategy</code> 插件<code>debug</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-498-1 name=__codelineno-498-1 href=#__codelineno-498-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<a id=__codelineno-498-2 name=__codelineno-498-2 href=#__codelineno-498-2></a><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">debug</span>
<a id=__codelineno-498-3 name=__codelineno-498-3 href=#__codelineno-498-3></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-498-4 name=__codelineno-498-4 href=#__codelineno-498-4></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div> <p>或者修改配置和环境变量</p> <div class=highlight><pre><span></span><code><a id=__codelineno-499-1 name=__codelineno-499-1 href=#__codelineno-499-1></a><span class=k>[defaults]</span>
<a id=__codelineno-499-2 name=__codelineno-499-2 href=#__codelineno-499-2></a><span class=na>strategy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>debug</span>
</code></pre></div> <p>环境变量</p> <div class=highlight><pre><span></span><code><a id=__codelineno-500-1 name=__codelineno-500-1 href=#__codelineno-500-1></a><span class=nv>ANSIBLE_STRATEGY</span><span class=o>=</span>debug
</code></pre></div> <h4 id=调试-debugger>调试 debugger<a class=headerlink href=#调试-debugger title="Permanent link">&para;</a></h4> <p>使用以下例子</p> <div class=highlight><pre><span></span><code><a id=__codelineno-501-1 name=__codelineno-501-1 href=#__codelineno-501-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">192.168.77.131</span>
<a id=__codelineno-501-2 name=__codelineno-501-2 href=#__codelineno-501-2></a><span class=w>  </span><span class=nt>debugger</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">on_failed</span>
<a id=__codelineno-501-3 name=__codelineno-501-3 href=#__codelineno-501-3></a><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
<a id=__codelineno-501-4 name=__codelineno-501-4 href=#__codelineno-501-4></a><span class=w>  </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-501-5 name=__codelineno-501-5 href=#__codelineno-501-5></a><span class=w>    </span><span class=nt>var1</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">value1</span>
<a id=__codelineno-501-6 name=__codelineno-501-6 href=#__codelineno-501-6></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-501-7 name=__codelineno-501-7 href=#__codelineno-501-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">wrong variable</span>
<a id=__codelineno-501-8 name=__codelineno-501-8 href=#__codelineno-501-8></a><span class=w>      </span><span class=nt>ping</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">data={{ wrong_var }}</span>
</code></pre></div> <p>以上playbook，在执行到错误的任务时，会进入debug模式下</p> <div class=highlight><pre><span></span><code><a id=__codelineno-502-1 name=__codelineno-502-1 href=#__codelineno-502-1></a><span class=c1># ansible-playbook debuger.yaml</span>
<a id=__codelineno-502-2 name=__codelineno-502-2 href=#__codelineno-502-2></a>
<a id=__codelineno-502-3 name=__codelineno-502-3 href=#__codelineno-502-3></a>PLAY<span class=w> </span><span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span><span class=w> </span>*****************************************************************************************
<a id=__codelineno-502-4 name=__codelineno-502-4 href=#__codelineno-502-4></a>
<a id=__codelineno-502-5 name=__codelineno-502-5 href=#__codelineno-502-5></a>TASK<span class=w> </span><span class=o>[</span>wrong<span class=w> </span>variable<span class=o>]</span><span class=w> </span>*****************************************************************************************
<a id=__codelineno-502-6 name=__codelineno-502-6 href=#__codelineno-502-6></a>fatal:<span class=w> </span><span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span>:<span class=w> </span>FAILED!<span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span><span class=s2>&quot;msg&quot;</span>:<span class=w> </span><span class=s2>&quot;The task includes an option with an undefined variable. The error was: &#39;wrong_var&#39; is undefined\n\nThe error appears to be in &#39;/etc/ansible/debuger.yaml&#39;: line 7, column 7, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n  tasks:\n    - name: wrong variable\n      ^ here\n&quot;</span><span class=o>}</span>
<a id=__codelineno-502-7 name=__codelineno-502-7 href=#__codelineno-502-7></a><span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span><span class=w> </span>TASK:<span class=w> </span>wrong<span class=w> </span>variable<span class=w> </span><span class=o>(</span>debug<span class=o>)</span>&gt;<span class=w> </span>p<span class=w> </span>result._result
<a id=__codelineno-502-8 name=__codelineno-502-8 href=#__codelineno-502-8></a><span class=o>{</span><span class=s1>&#39;_ansible_no_log&#39;</span>:<span class=w> </span>False,
<a id=__codelineno-502-9 name=__codelineno-502-9 href=#__codelineno-502-9></a><span class=w> </span><span class=s1>&#39;failed&#39;</span>:<span class=w> </span>True,
<a id=__codelineno-502-10 name=__codelineno-502-10 href=#__codelineno-502-10></a><span class=w> </span><span class=s1>&#39;msg&#39;</span>:<span class=w> </span>u<span class=s2>&quot;The task includes an option with an undefined variable. The error was: &#39;wrong_var&#39; is undefined\n\nThe error appears to be in &#39;/etc/ansible/debuger.yaml&#39;: line 7, column 7, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n  tasks:\n    - name: wrong variable\n      ^ here\n&quot;</span><span class=o>}</span>
<a id=__codelineno-502-11 name=__codelineno-502-11 href=#__codelineno-502-11></a><span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span><span class=w> </span>TASK:<span class=w> </span>wrong<span class=w> </span>variable<span class=w> </span><span class=o>(</span>debug<span class=o>)</span>&gt;<span class=w> </span>p<span class=w> </span>task.args
<a id=__codelineno-502-12 name=__codelineno-502-12 href=#__codelineno-502-12></a><span class=o>{</span>u<span class=s1>&#39;data&#39;</span>:<span class=w> </span>u<span class=s1>&#39;{{ wrong_var }}&#39;</span><span class=o>}</span>
<a id=__codelineno-502-13 name=__codelineno-502-13 href=#__codelineno-502-13></a><span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span><span class=w> </span>TASK:<span class=w> </span>wrong<span class=w> </span>variable<span class=w> </span><span class=o>(</span>debug<span class=o>)</span>&gt;<span class=w> </span>task.args<span class=o>[</span><span class=s1>&#39;data&#39;</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;{{ var1 }}&#39;</span>
<a id=__codelineno-502-14 name=__codelineno-502-14 href=#__codelineno-502-14></a><span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span><span class=w> </span>TASK:<span class=w> </span>wrong<span class=w> </span>variable<span class=w> </span><span class=o>(</span>debug<span class=o>)</span>&gt;<span class=w> </span>p<span class=w> </span>task.args
<a id=__codelineno-502-15 name=__codelineno-502-15 href=#__codelineno-502-15></a><span class=o>{</span>u<span class=s1>&#39;data&#39;</span>:<span class=w> </span><span class=s1>&#39;{{ var1 }}&#39;</span><span class=o>}</span>
<a id=__codelineno-502-16 name=__codelineno-502-16 href=#__codelineno-502-16></a><span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span><span class=w> </span>TASK:<span class=w> </span>wrong<span class=w> </span>variable<span class=w> </span><span class=o>(</span>debug<span class=o>)</span>&gt;<span class=w> </span>redo
<a id=__codelineno-502-17 name=__codelineno-502-17 href=#__codelineno-502-17></a>ok:<span class=w> </span><span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span>
<a id=__codelineno-502-18 name=__codelineno-502-18 href=#__codelineno-502-18></a>
<a id=__codelineno-502-19 name=__codelineno-502-19 href=#__codelineno-502-19></a>PLAY<span class=w> </span>RECAP<span class=w> </span>*****************************************************************************************
<a id=__codelineno-502-20 name=__codelineno-502-20 href=#__codelineno-502-20></a><span class=m>192</span>.168.77.131<span class=w>             </span>:<span class=w> </span><span class=nv>ok</span><span class=o>=</span><span class=m>1</span><span class=w>    </span><span class=nv>changed</span><span class=o>=</span><span class=m>0</span><span class=w>    </span><span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span><span class=w>    </span><span class=nv>failed</span><span class=o>=</span><span class=m>0</span><span class=w>    </span><span class=nv>skipped</span><span class=o>=</span><span class=m>0</span><span class=w>    </span><span class=nv>rescued</span><span class=o>=</span><span class=m>0</span><span class=w>    </span><span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</code></pre></div> <p>通过调试，我们使playbook以成功运行完毕。</p> <p><code>debugger</code>模式下的可用指令</p> <table> <thead> <tr> <th>指令</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>p</td> <td>显示此次失败的原因</td> </tr> <tr> <td>p task</td> <td>显示此次任务的名称</td> </tr> <tr> <td>p task.args</td> <td>显示模块的参数</td> </tr> <tr> <td>p task_vars</td> <td>显示任务的可用变量</td> </tr> <tr> <td>p host</td> <td>显示执行此次任务的主机</td> </tr> <tr> <td>p result</td> <td>显示此次任务的结果</td> </tr> <tr> <td>p vars</td> <td>显示当前的变量</td> </tr> <tr> <td>vars[key] = value</td> <td>更新vars中的值</td> </tr> <tr> <td>task.args[key] = value</td> <td>更新模块的参数。</td> </tr> <tr> <td>u(pdate_task)</td> <td>从原始任务数据结构和带有更新的task_vars的模板中重新创建任务</td> </tr> <tr> <td>r(edo)</td> <td>再次执行此任务</td> </tr> <tr> <td>c(ontinue)</td> <td>继续执行</td> </tr> <tr> <td>q(uit)</td> <td>退出debug模式</td> </tr> </tbody> </table> <h4 id=与free策略一起使用>与<code>free</code>策略一起使用<a class=headerlink href=#与free策略一起使用 title="Permanent link">&para;</a></h4> <p>当<code>debugger</code>与<code>free</code>策略一起使用时，在调试器处于活动状态时，不会导致其他任务排队或执行。但使用<code>redo</code>时，可能回导致当前任务在其他任务之后执行</p> <h4 id=使用-debug-模块>使用 debug 模块<a class=headerlink href=#使用-debug-模块 title="Permanent link">&para;</a></h4> <p>在执行期间打印语句，使用<code>debug</code>模块可以调试变量或表达式，而不必阻塞playbook。</p> <p>打印自定义的信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-503-1 name=__codelineno-503-1 href=#__codelineno-503-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-503-2 name=__codelineno-503-2 href=#__codelineno-503-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;System {{ inventory_hostname }} has uuid {{ ansible_product_uuid  }}&quot;</span>
</code></pre></div> <p>调试变量</p> <div class=highlight><pre><span></span><code><a id=__codelineno-504-1 name=__codelineno-504-1 href=#__codelineno-504-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-504-2 name=__codelineno-504-2 href=#__codelineno-504-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">var=result  verbosity=2</span>
</code></pre></div> <h3 id=滚动执行>滚动执行<a class=headerlink href=#滚动执行 title="Permanent link">&para;</a></h3> <p>默认情况下，Ansible会并行地管理一个剧本中引用的所有机器。对于滚动更新用例，可以使用<code>serial</code>关键字定义Ansible并行执行多少台主机</p> <div class=highlight><pre><span></span><code><a id=__codelineno-505-1 name=__codelineno-505-1 href=#__codelineno-505-1></a><span class=nn>---</span>
<a id=__codelineno-505-2 name=__codelineno-505-2 href=#__codelineno-505-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test play</span>
<a id=__codelineno-505-3 name=__codelineno-505-3 href=#__codelineno-505-3></a><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-505-4 name=__codelineno-505-4 href=#__codelineno-505-4></a><span class=w>  </span><span class=nt>serial</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id=__codelineno-505-5 name=__codelineno-505-5 href=#__codelineno-505-5></a><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<a id=__codelineno-505-6 name=__codelineno-505-6 href=#__codelineno-505-6></a>
<a id=__codelineno-505-7 name=__codelineno-505-7 href=#__codelineno-505-7></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-505-8 name=__codelineno-505-8 href=#__codelineno-505-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">task one</span>
<a id=__codelineno-505-9 name=__codelineno-505-9 href=#__codelineno-505-9></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">hostname</span>
<a id=__codelineno-505-10 name=__codelineno-505-10 href=#__codelineno-505-10></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">task two</span>
<a id=__codelineno-505-11 name=__codelineno-505-11 href=#__codelineno-505-11></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">hostname</span>
</code></pre></div> <p>在上面的例子中，如果我们有100个主机，组“webservers”中的3个主机将完成playbook，然后再移动到接下来的3个主机。</p> <p>还可以使用百分比</p> <div class=highlight><pre><span></span><code><a id=__codelineno-506-1 name=__codelineno-506-1 href=#__codelineno-506-1></a><span class=nt>serial</span><span class=p>:</span><span class=w> </span><span class=s>&quot;30%&quot;</span>
</code></pre></div> <p>从Ansible 2.2开始，可以指定一个列表作为批量执行的依据</p> <div class=highlight><pre><span></span><code><a id=__codelineno-507-1 name=__codelineno-507-1 href=#__codelineno-507-1></a><span class=nn>---</span>
<a id=__codelineno-507-2 name=__codelineno-507-2 href=#__codelineno-507-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test play</span>
<a id=__codelineno-507-3 name=__codelineno-507-3 href=#__codelineno-507-3></a><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-507-4 name=__codelineno-507-4 href=#__codelineno-507-4></a><span class=w>  </span><span class=nt>serial</span><span class=p>:</span>
<a id=__codelineno-507-5 name=__codelineno-507-5 href=#__codelineno-507-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-507-6 name=__codelineno-507-6 href=#__codelineno-507-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<a id=__codelineno-507-7 name=__codelineno-507-7 href=#__codelineno-507-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</code></pre></div> <p>在上面的例子中，第一批执行将包含一个主机，下一批将包含5个主机，并且(如果还剩下任何主机)，接下来的每一批将包含10个主机，直到所有可用的主机都被使用。</p> <p>可以在列表中使用百分比</p> <div class=highlight><pre><span></span><code><a id=__codelineno-508-1 name=__codelineno-508-1 href=#__codelineno-508-1></a><span class=nn>---</span>
<a id=__codelineno-508-2 name=__codelineno-508-2 href=#__codelineno-508-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test play</span>
<a id=__codelineno-508-3 name=__codelineno-508-3 href=#__codelineno-508-3></a><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-508-4 name=__codelineno-508-4 href=#__codelineno-508-4></a><span class=w>  </span><span class=nt>serial</span><span class=p>:</span>
<a id=__codelineno-508-5 name=__codelineno-508-5 href=#__codelineno-508-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;10%&quot;</span>
<a id=__codelineno-508-6 name=__codelineno-508-6 href=#__codelineno-508-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;20%&quot;</span>
<a id=__codelineno-508-7 name=__codelineno-508-7 href=#__codelineno-508-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;100%&quot;</span>
</code></pre></div> <p>也可以混合使用</p> <div class=highlight><pre><span></span><code><a id=__codelineno-509-1 name=__codelineno-509-1 href=#__codelineno-509-1></a><span class=nn>---</span>
<a id=__codelineno-509-2 name=__codelineno-509-2 href=#__codelineno-509-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test play</span>
<a id=__codelineno-509-3 name=__codelineno-509-3 href=#__codelineno-509-3></a><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-509-4 name=__codelineno-509-4 href=#__codelineno-509-4></a><span class=w>  </span><span class=nt>serial</span><span class=p>:</span>
<a id=__codelineno-509-5 name=__codelineno-509-5 href=#__codelineno-509-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-509-6 name=__codelineno-509-6 href=#__codelineno-509-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<a id=__codelineno-509-7 name=__codelineno-509-7 href=#__codelineno-509-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;20%&quot;</span>
</code></pre></div> <h3 id=指定最大失败数目>指定最大失败数目<a class=headerlink href=#指定最大失败数目 title="Permanent link">&para;</a></h3> <p>默认情况下，只要组中有尚未失败的主机，Ansible将继续执行操作。 在一些情况下，例如利用上述滚动更新，可能希望在达到失败的特定阈值时中止任务。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-510-1 name=__codelineno-510-1 href=#__codelineno-510-1></a><span class=nn>---</span>
<a id=__codelineno-510-2 name=__codelineno-510-2 href=#__codelineno-510-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-510-3 name=__codelineno-510-3 href=#__codelineno-510-3></a><span class=w>  </span><span class=nt>max_fail_percentage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<a id=__codelineno-510-4 name=__codelineno-510-4 href=#__codelineno-510-4></a><span class=w>  </span><span class=nt>serial</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</code></pre></div> <p>在上面的示例中，如果组中的10台服务器中有3台以上发生故障，则将终止其余的操作。</p> <h3 id=委托>委托<a class=headerlink href=#委托 title="Permanent link">&para;</a></h3> <p>在任务上使用<code>delegate_to</code>关键字,可以将任务委托给指定主机去执行。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-511-1 name=__codelineno-511-1 href=#__codelineno-511-1></a><span class=nn>---</span>
<a id=__codelineno-511-2 name=__codelineno-511-2 href=#__codelineno-511-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">webservers</span>
<a id=__codelineno-511-3 name=__codelineno-511-3 href=#__codelineno-511-3></a><span class=w>  </span><span class=nt>serial</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<a id=__codelineno-511-4 name=__codelineno-511-4 href=#__codelineno-511-4></a>
<a id=__codelineno-511-5 name=__codelineno-511-5 href=#__codelineno-511-5></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-511-6 name=__codelineno-511-6 href=#__codelineno-511-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">take out of load balancer pool</span>
<a id=__codelineno-511-7 name=__codelineno-511-7 href=#__codelineno-511-7></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/take_out_of_pool {{ inventory_hostname }}</span>
<a id=__codelineno-511-8 name=__codelineno-511-8 href=#__codelineno-511-8></a><span class=w>      </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>
<a id=__codelineno-511-9 name=__codelineno-511-9 href=#__codelineno-511-9></a>
<a id=__codelineno-511-10 name=__codelineno-511-10 href=#__codelineno-511-10></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">actual steps would go here</span>
<a id=__codelineno-511-11 name=__codelineno-511-11 href=#__codelineno-511-11></a><span class=w>      </span><span class=nt>yum</span><span class=p>:</span>
<a id=__codelineno-511-12 name=__codelineno-511-12 href=#__codelineno-511-12></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">acme-web-stack</span>
<a id=__codelineno-511-13 name=__codelineno-511-13 href=#__codelineno-511-13></a><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">latest</span>
<a id=__codelineno-511-14 name=__codelineno-511-14 href=#__codelineno-511-14></a>
<a id=__codelineno-511-15 name=__codelineno-511-15 href=#__codelineno-511-15></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">add back to load balancer pool</span>
<a id=__codelineno-511-16 name=__codelineno-511-16 href=#__codelineno-511-16></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/add_back_to_pool {{ inventory_hostname }}</span>
<a id=__codelineno-511-17 name=__codelineno-511-17 href=#__codelineno-511-17></a><span class=w>      </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>
</code></pre></div> <p><code>delegate_to: 127.0.0.1</code> 是将任务委派到ansible本地去执行，你可以使用简写的<code>local_action</code> 去执行</p> <div class=highlight><pre><span></span><code><a id=__codelineno-512-1 name=__codelineno-512-1 href=#__codelineno-512-1></a><span class=nn>---</span>
<a id=__codelineno-512-2 name=__codelineno-512-2 href=#__codelineno-512-2></a><span class=c1># ...</span>
<a id=__codelineno-512-3 name=__codelineno-512-3 href=#__codelineno-512-3></a>
<a id=__codelineno-512-4 name=__codelineno-512-4 href=#__codelineno-512-4></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-512-5 name=__codelineno-512-5 href=#__codelineno-512-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">take out of load balancer pool</span>
<a id=__codelineno-512-6 name=__codelineno-512-6 href=#__codelineno-512-6></a><span class=w>      </span><span class=nt>local_action</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">command /usr/bin/take_out_of_pool {{ inventory_hostname }}</span>
<a id=__codelineno-512-7 name=__codelineno-512-7 href=#__codelineno-512-7></a>
<a id=__codelineno-512-8 name=__codelineno-512-8 href=#__codelineno-512-8></a><span class=c1># ...</span>
<a id=__codelineno-512-9 name=__codelineno-512-9 href=#__codelineno-512-9></a>
<a id=__codelineno-512-10 name=__codelineno-512-10 href=#__codelineno-512-10></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">add back to load balancer pool</span>
<a id=__codelineno-512-11 name=__codelineno-512-11 href=#__codelineno-512-11></a><span class=w>      </span><span class=nt>local_action</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">command /usr/bin/add_back_to_pool {{ inventory_hostname }}</span>
</code></pre></div> <p>一个例子</p> <div class=highlight><pre><span></span><code><a id=__codelineno-513-1 name=__codelineno-513-1 href=#__codelineno-513-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">db_servers</span>
<a id=__codelineno-513-2 name=__codelineno-513-2 href=#__codelineno-513-2></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-513-3 name=__codelineno-513-3 href=#__codelineno-513-3></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ifconfig</span>
<a id=__codelineno-513-4 name=__codelineno-513-4 href=#__codelineno-513-4></a><span class=w>     </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fconfig</span>
<a id=__codelineno-513-5 name=__codelineno-513-5 href=#__codelineno-513-5></a><span class=w>     </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>
<a id=__codelineno-513-6 name=__codelineno-513-6 href=#__codelineno-513-6></a>
<a id=__codelineno-513-7 name=__codelineno-513-7 href=#__codelineno-513-7></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ifconfig</span>
<a id=__codelineno-513-8 name=__codelineno-513-8 href=#__codelineno-513-8></a><span class=w>     </span><span class=nt>local_action</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">command ifconfig</span>
<a id=__codelineno-513-9 name=__codelineno-513-9 href=#__codelineno-513-9></a>
<a id=__codelineno-513-10 name=__codelineno-513-10 href=#__codelineno-513-10></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">app_servers</span>
<a id=__codelineno-513-11 name=__codelineno-513-11 href=#__codelineno-513-11></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-513-12 name=__codelineno-513-12 href=#__codelineno-513-12></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gather facts from db servers</span>
<a id=__codelineno-513-13 name=__codelineno-513-13 href=#__codelineno-513-13></a><span class=w>    </span><span class=nt>setup</span><span class=p>:</span>
<a id=__codelineno-513-14 name=__codelineno-513-14 href=#__codelineno-513-14></a><span class=w>    </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{item}}&quot;</span>
<a id=__codelineno-513-15 name=__codelineno-513-15 href=#__codelineno-513-15></a><span class=w>    </span><span class=nt>delegate_facts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<a id=__codelineno-513-16 name=__codelineno-513-16 href=#__codelineno-513-16></a><span class=w>    </span><span class=nt>with_items</span><span class=p>:</span><span class=w>  </span><span class=s>&quot;{{groups[&#39;dbservers&#39;]}}&quot;</span>
</code></pre></div> <blockquote> <p>delegate_facts 指定收集委托主机的facts数据</p> </blockquote> <p>以上将为<code>dbservers</code>组中的机器收集<code>facts</code>，并将<code>facts</code>分配给这些机器，而不是<code>app_servers</code>。</p> <h3 id=任务只运行一次>任务只运行一次<a class=headerlink href=#任务只运行一次 title="Permanent link">&para;</a></h3> <p>通过在任务上配置<code>run_once</code>来实现当前任务在<code>play</code>中只执行一次</p> <div class=highlight><pre><span></span><code><a id=__codelineno-514-1 name=__codelineno-514-1 href=#__codelineno-514-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-514-2 name=__codelineno-514-2 href=#__codelineno-514-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ifconfig</span>
<a id=__codelineno-514-3 name=__codelineno-514-3 href=#__codelineno-514-3></a><span class=w>    </span><span class=nt>run_once</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div> <p>上面的例子，将只会在第一个执行主机上执行，其余的主机则不执行。</p> <p>有点类似于使用when条件判断</p> <div class=highlight><pre><span></span><code><a id=__codelineno-515-1 name=__codelineno-515-1 href=#__codelineno-515-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/opt/application/upgrade_db.py</span>
<a id=__codelineno-515-2 name=__codelineno-515-2 href=#__codelineno-515-2></a><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">inventory_hostname == webservers[0]</span>
</code></pre></div> <h3 id=本地执行>本地执行<a class=headerlink href=#本地执行 title="Permanent link">&para;</a></h3> <p>为playbook指定<code>connection=local</code>将会使任务在本地执行，而不是使用ssh连接远端。</p> <p>执行playbook</p> <div class=highlight><pre><span></span><code><a id=__codelineno-516-1 name=__codelineno-516-1 href=#__codelineno-516-1></a>ansible-playbook<span class=w>  </span>playbook.yml<span class=w> </span>--connection<span class=o>=</span><span class=nb>local</span>
</code></pre></div> <p>在play中指定</p> <div class=highlight><pre><span></span><code><a id=__codelineno-517-1 name=__codelineno-517-1 href=#__codelineno-517-1></a><span class=nn>---</span>
<a id=__codelineno-517-2 name=__codelineno-517-2 href=#__codelineno-517-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>
<a id=__codelineno-517-3 name=__codelineno-517-3 href=#__codelineno-517-3></a><span class=w>  </span><span class=nt>connection</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
</code></pre></div> <h3 id=设置环境变量>设置环境变量<a class=headerlink href=#设置环境变量 title="Permanent link">&para;</a></h3> <p>为运行程序指定环境变量，需指定<code>environment</code>关键字</p> <div class=highlight><pre><span></span><code><a id=__codelineno-518-1 name=__codelineno-518-1 href=#__codelineno-518-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-518-2 name=__codelineno-518-2 href=#__codelineno-518-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apt</span><span class=p>:</span><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">name=cobbler state=installed</span>
<a id=__codelineno-518-3 name=__codelineno-518-3 href=#__codelineno-518-3></a><span class=w>    </span><span class=nt>environment</span><span class=p>:</span>
<a id=__codelineno-518-4 name=__codelineno-518-4 href=#__codelineno-518-4></a><span class=w>      </span><span class=nt>http_proxy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http://proxy.example.com:8080</span>
<a id=__codelineno-518-5 name=__codelineno-518-5 href=#__codelineno-518-5></a><span class=w>      </span><span class=nt>PATH</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/local/nvm/versions/node/v4.2.1/bin:{{  ansible_env.PATH }}</span>
</code></pre></div> <p>也可以在play级别使用</p> <div class=highlight><pre><span></span><code><a id=__codelineno-519-1 name=__codelineno-519-1 href=#__codelineno-519-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">testhost</span>
<a id=__codelineno-519-2 name=__codelineno-519-2 href=#__codelineno-519-2></a><span class=w>  </span><span class=nt>roles</span><span class=p>:</span>
<a id=__codelineno-519-3 name=__codelineno-519-3 href=#__codelineno-519-3></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">php</span>
<a id=__codelineno-519-4 name=__codelineno-519-4 href=#__codelineno-519-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id=__codelineno-519-5 name=__codelineno-519-5 href=#__codelineno-519-5></a><span class=w>  </span><span class=nt>environment</span><span class=p>:</span>
<a id=__codelineno-519-6 name=__codelineno-519-6 href=#__codelineno-519-6></a><span class=w>    </span><span class=nt>http_proxy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http://proxy.example.com:8080</span>
</code></pre></div> <h3 id=错误处理>错误处理<a class=headerlink href=#错误处理 title="Permanent link">&para;</a></h3> <h4 id=忽略错误>忽略错误<a class=headerlink href=#忽略错误 title="Permanent link">&para;</a></h4> <p><code>ignore_errors</code> 模块可以在任务执行错误时，忽略错误并继续执行任务。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-520-1 name=__codelineno-520-1 href=#__codelineno-520-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-520-2 name=__codelineno-520-2 href=#__codelineno-520-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/bin/false</span>
<a id=__codelineno-520-3 name=__codelineno-520-3 href=#__codelineno-520-3></a><span class=w>    </span><span class=nt>ignore_errors</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-520-4 name=__codelineno-520-4 href=#__codelineno-520-4></a>
<a id=__codelineno-520-5 name=__codelineno-520-5 href=#__codelineno-520-5></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;false&quot;</span>
</code></pre></div> <h4 id=重置无法访问的主机>重置无法访问的主机<a class=headerlink href=#重置无法访问的主机 title="Permanent link">&para;</a></h4> <p>连接远端主机失败时，ansible会将主机设置为不可到达，这将从运行的活动主机列表中删除它们。要从这些问题中恢复，需执行下列动作恢复主机。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-521-1 name=__codelineno-521-1 href=#__codelineno-521-1></a><span class="p p-Indicator">-</span><span class=w>  </span><span class=nt>meta</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">clear_host_errors</span>
</code></pre></div> <h4 id=即使任务失败handlers也执行>即使任务失败，handlers也执行<a class=headerlink href=#即使任务失败handlers也执行 title="Permanent link">&para;</a></h4> <p>以下3中方法均可使用</p> <ul> <li>命令行加上<code>--force-handlers</code> 参数</li> <li>配置文件加上 <code>force_handlers = True</code></li> <li>playbook里设置 <code>force_handlers: True</code></li> </ul> <h4 id=控制任务失败>控制任务失败<a class=headerlink href=#控制任务失败 title="Permanent link">&para;</a></h4> <p>使用<code>failed_when</code>选项时，当条件为真时，可使当前任务以失败返回</p> <p>您可以通过在命令的输出中搜索一个单词或短语来检查是否命令执行是否失败</p> <div class=highlight><pre><span></span><code><a id=__codelineno-522-1 name=__codelineno-522-1 href=#__codelineno-522-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Fail task when the command error output prints FAILED</span>
<a id=__codelineno-522-2 name=__codelineno-522-2 href=#__codelineno-522-2></a><span class=w>  </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/example-command -x -y -z</span>
<a id=__codelineno-522-3 name=__codelineno-522-3 href=#__codelineno-522-3></a><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">command_result</span>
<a id=__codelineno-522-4 name=__codelineno-522-4 href=#__codelineno-522-4></a><span class=w>  </span><span class=nt>failed_when</span><span class=p>:</span><span class=w> </span><span class=s>&quot;&#39;FAILED&#39;</span><span class=nv> </span><span class=s>in</span><span class=nv> </span><span class=s>command_result.stderr&quot;</span>
</code></pre></div> <p>或者根据返回值</p> <div class=highlight><pre><span></span><code><a id=__codelineno-523-1 name=__codelineno-523-1 href=#__codelineno-523-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Fail task when both files are identical</span>
<a id=__codelineno-523-2 name=__codelineno-523-2 href=#__codelineno-523-2></a><span class=w>  </span><span class=nt>raw</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">diff foo/file1 bar/file2</span>
<a id=__codelineno-523-3 name=__codelineno-523-3 href=#__codelineno-523-3></a><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">diff_cmd</span>
<a id=__codelineno-523-4 name=__codelineno-523-4 href=#__codelineno-523-4></a><span class=w>  </span><span class=nt>failed_when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">diff_cmd.rc == 0 or diff_cmd.rc &gt;= 2</span>
</code></pre></div> <p>在以前的版本中，可以使用以下完成上述操作</p> <div class=highlight><pre><span></span><code><a id=__codelineno-524-1 name=__codelineno-524-1 href=#__codelineno-524-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">this command prints FAILED when it fails</span>
<a id=__codelineno-524-2 name=__codelineno-524-2 href=#__codelineno-524-2></a><span class=w>  </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/example-command -x -y -z</span>
<a id=__codelineno-524-3 name=__codelineno-524-3 href=#__codelineno-524-3></a><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">command_result</span>
<a id=__codelineno-524-4 name=__codelineno-524-4 href=#__codelineno-524-4></a><span class=w>  </span><span class=nt>ignore_errors</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<a id=__codelineno-524-5 name=__codelineno-524-5 href=#__codelineno-524-5></a>
<a id=__codelineno-524-6 name=__codelineno-524-6 href=#__codelineno-524-6></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fail the play if the previous command did not succeed</span>
<a id=__codelineno-524-7 name=__codelineno-524-7 href=#__codelineno-524-7></a><span class=w>  </span><span class=nt>fail</span><span class=p>:</span>
<a id=__codelineno-524-8 name=__codelineno-524-8 href=#__codelineno-524-8></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;the</span><span class=nv> </span><span class=s>command</span><span class=nv> </span><span class=s>failed&quot;</span>
<a id=__codelineno-524-9 name=__codelineno-524-9 href=#__codelineno-524-9></a><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=s>&quot;&#39;FAILED&#39;</span><span class=nv> </span><span class=s>in</span><span class=nv> </span><span class=s>command_result.stderr&quot;</span>
</code></pre></div> <p>可以使用多个并行条件，这些条件之间是<code>and</code>关系</p> <div class=highlight><pre><span></span><code><a id=__codelineno-525-1 name=__codelineno-525-1 href=#__codelineno-525-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Check if a file exists in temp and fail task if it does</span>
<a id=__codelineno-525-2 name=__codelineno-525-2 href=#__codelineno-525-2></a><span class=w>  </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ls /tmp/this_should_not_be_here</span>
<a id=__codelineno-525-3 name=__codelineno-525-3 href=#__codelineno-525-3></a><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">result</span>
<a id=__codelineno-525-4 name=__codelineno-525-4 href=#__codelineno-525-4></a><span class=w>  </span><span class=nt>failed_when</span><span class=p>:</span>
<a id=__codelineno-525-5 name=__codelineno-525-5 href=#__codelineno-525-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">result.rc == 0</span>
<a id=__codelineno-525-6 name=__codelineno-525-6 href=#__codelineno-525-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;&quot;No</span><span class=nv> </span><span class=s>such&quot;</span><span class=nv> </span><span class=s>not</span><span class=nv> </span><span class=s>in</span><span class=nv> </span><span class=s>result.stdout&#39;</span>
</code></pre></div> <p>使用<code>or</code>条件</p> <div class=highlight><pre><span></span><code><a id=__codelineno-526-1 name=__codelineno-526-1 href=#__codelineno-526-1></a><span class=nt>failed_when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">result.rc == 0 or &quot;No such&quot; not in result.stdout</span>
</code></pre></div> <p>如果一行写不下，可以使用多行表示</p> <div class=highlight><pre><span></span><code><a id=__codelineno-527-1 name=__codelineno-527-1 href=#__codelineno-527-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">example of many failed_when conditions with OR</span>
<a id=__codelineno-527-2 name=__codelineno-527-2 href=#__codelineno-527-2></a><span class=w>  </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s>&quot;./myBinary&quot;</span>
<a id=__codelineno-527-3 name=__codelineno-527-3 href=#__codelineno-527-3></a><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ret</span>
<a id=__codelineno-527-4 name=__codelineno-527-4 href=#__codelineno-527-4></a><span class=w>  </span><span class=nt>failed_when</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">&gt;</span>
<a id=__codelineno-527-5 name=__codelineno-527-5 href=#__codelineno-527-5></a><span class=w>    </span><span class=no>(&quot;No such file or directory&quot; in ret.stdout) or</span>
<a id=__codelineno-527-6 name=__codelineno-527-6 href=#__codelineno-527-6></a><span class=w>    </span><span class=no>(ret.stderr != &#39;&#39;) or</span>
<a id=__codelineno-527-7 name=__codelineno-527-7 href=#__codelineno-527-7></a><span class=w>    </span><span class=no>(ret.rc == 10)</span>
</code></pre></div> <h4 id=更改任务changed状态>更改任务changed状态<a class=headerlink href=#更改任务changed状态 title="Permanent link">&para;</a></h4> <p>指定<code>changed_when</code> 条件时，当条件为真，任务的<code>changed</code>为真，即表示当前任务做了更改。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-528-1 name=__codelineno-528-1 href=#__codelineno-528-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-528-2 name=__codelineno-528-2 href=#__codelineno-528-2></a>
<a id=__codelineno-528-3 name=__codelineno-528-3 href=#__codelineno-528-3></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/billybass --mode=&quot;take me to the river&quot;</span>
<a id=__codelineno-528-4 name=__codelineno-528-4 href=#__codelineno-528-4></a><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bass_result</span>
<a id=__codelineno-528-5 name=__codelineno-528-5 href=#__codelineno-528-5></a><span class=w>    </span><span class=nt>changed_when</span><span class=p>:</span><span class=w> </span><span class=s>&quot;bass_result.rc</span><span class=nv> </span><span class=s>!=</span><span class=nv> </span><span class=s>2&quot;</span>
<a id=__codelineno-528-6 name=__codelineno-528-6 href=#__codelineno-528-6></a>
<a id=__codelineno-528-7 name=__codelineno-528-7 href=#__codelineno-528-7></a><span class=w>  </span><span class=c1># this will never report &#39;changed&#39; status</span>
<a id=__codelineno-528-8 name=__codelineno-528-8 href=#__codelineno-528-8></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">wall &#39;beep&#39;</span>
<a id=__codelineno-528-9 name=__codelineno-528-9 href=#__codelineno-528-9></a><span class=w>    </span><span class=nt>changed_when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
</code></pre></div> <p>使用多个条件</p> <div class=highlight><pre><span></span><code><a id=__codelineno-529-1 name=__codelineno-529-1 href=#__codelineno-529-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/bin/fake_command</span>
<a id=__codelineno-529-2 name=__codelineno-529-2 href=#__codelineno-529-2></a><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">result</span>
<a id=__codelineno-529-3 name=__codelineno-529-3 href=#__codelineno-529-3></a><span class=w>  </span><span class=nt>ignore_errors</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<a id=__codelineno-529-4 name=__codelineno-529-4 href=#__codelineno-529-4></a><span class=w>  </span><span class=nt>changed_when</span><span class=p>:</span>
<a id=__codelineno-529-5 name=__codelineno-529-5 href=#__codelineno-529-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;&quot;ERROR&quot;</span><span class=nv> </span><span class=s>in</span><span class=nv> </span><span class=s>result.stderr&#39;</span>
<a id=__codelineno-529-6 name=__codelineno-529-6 href=#__codelineno-529-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">result.rc == 2</span>
</code></pre></div> <h4 id=出现错误时立即中断执行>出现错误时立即中断执行<a class=headerlink href=#出现错误时立即中断执行 title="Permanent link">&para;</a></h4> <p>使用<code>any_errors_fatal</code>选项时，只要playbook中出现一个错误任务,ansible立即停止运行。已保证所有任务的正确运行。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-530-1 name=__codelineno-530-1 href=#__codelineno-530-1></a><span class=nn>---</span>
<a id=__codelineno-530-2 name=__codelineno-530-2 href=#__codelineno-530-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">load_balancers_dc_a</span>
<a id=__codelineno-530-3 name=__codelineno-530-3 href=#__codelineno-530-3></a><span class=w>  </span><span class=nt>any_errors_fatal</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<a id=__codelineno-530-4 name=__codelineno-530-4 href=#__codelineno-530-4></a>
<a id=__codelineno-530-5 name=__codelineno-530-5 href=#__codelineno-530-5></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-530-6 name=__codelineno-530-6 href=#__codelineno-530-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&#39;shutting</span><span class=nv> </span><span class=s>down</span><span class=nv> </span><span class=s>datacenter</span><span class=nv> </span><span class=s>[</span><span class=nv> </span><span class=s>A</span><span class=nv> </span><span class=s>]&#39;</span>
<a id=__codelineno-530-7 name=__codelineno-530-7 href=#__codelineno-530-7></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/disable-dc</span>
<a id=__codelineno-530-8 name=__codelineno-530-8 href=#__codelineno-530-8></a>
<a id=__codelineno-530-9 name=__codelineno-530-9 href=#__codelineno-530-9></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">frontends_dc_a</span>
<a id=__codelineno-530-10 name=__codelineno-530-10 href=#__codelineno-530-10></a>
<a id=__codelineno-530-11 name=__codelineno-530-11 href=#__codelineno-530-11></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-530-12 name=__codelineno-530-12 href=#__codelineno-530-12></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&#39;stopping</span><span class=nv> </span><span class=s>service&#39;</span>
<a id=__codelineno-530-13 name=__codelineno-530-13 href=#__codelineno-530-13></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/stop-software</span>
<a id=__codelineno-530-14 name=__codelineno-530-14 href=#__codelineno-530-14></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&#39;updating</span><span class=nv> </span><span class=s>software&#39;</span>
<a id=__codelineno-530-15 name=__codelineno-530-15 href=#__codelineno-530-15></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/upgrade-software</span>
<a id=__codelineno-530-16 name=__codelineno-530-16 href=#__codelineno-530-16></a>
<a id=__codelineno-530-17 name=__codelineno-530-17 href=#__codelineno-530-17></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">load_balancers_dc_a</span>
<a id=__codelineno-530-18 name=__codelineno-530-18 href=#__codelineno-530-18></a>
<a id=__codelineno-530-19 name=__codelineno-530-19 href=#__codelineno-530-19></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-530-20 name=__codelineno-530-20 href=#__codelineno-530-20></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&#39;Starting</span><span class=nv> </span><span class=s>datacenter</span><span class=nv> </span><span class=s>[</span><span class=nv> </span><span class=s>A</span><span class=nv> </span><span class=s>]&#39;</span>
<a id=__codelineno-530-21 name=__codelineno-530-21 href=#__codelineno-530-21></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/enable-dc</span>
</code></pre></div> <h4 id=使用blocks>使用blocks<a class=headerlink href=#使用blocks title="Permanent link">&para;</a></h4> <p>使用<code>blocks</code>的<code>rescue</code>来实现对错误任务的处理</p> <div class=highlight><pre><span></span><code><a id=__codelineno-531-1 name=__codelineno-531-1 href=#__codelineno-531-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-531-2 name=__codelineno-531-2 href=#__codelineno-531-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Handle the error</span>
<a id=__codelineno-531-3 name=__codelineno-531-3 href=#__codelineno-531-3></a><span class=w>  </span><span class=nt>block</span><span class=p>:</span>
<a id=__codelineno-531-4 name=__codelineno-531-4 href=#__codelineno-531-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-531-5 name=__codelineno-531-5 href=#__codelineno-531-5></a><span class=w>        </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&#39;I</span><span class=nv> </span><span class=s>execute</span><span class=nv> </span><span class=s>normally&#39;</span>
<a id=__codelineno-531-6 name=__codelineno-531-6 href=#__codelineno-531-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">i force a failure</span>
<a id=__codelineno-531-7 name=__codelineno-531-7 href=#__codelineno-531-7></a><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/bin/false</span>
<a id=__codelineno-531-8 name=__codelineno-531-8 href=#__codelineno-531-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-531-9 name=__codelineno-531-9 href=#__codelineno-531-9></a><span class=w>        </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&#39;I</span><span class=nv> </span><span class=s>never</span><span class=nv> </span><span class=s>execute,</span><span class=nv> </span><span class=s>due</span><span class=nv> </span><span class=s>to</span><span class=nv> </span><span class=s>the</span><span class=nv> </span><span class=s>above</span><span class=nv> </span><span class=s>task</span><span class=nv> </span><span class=s>failing,</span><span class=nv> </span><span class=s>:-(&#39;</span>
<a id=__codelineno-531-10 name=__codelineno-531-10 href=#__codelineno-531-10></a><span class=w>  </span><span class=nt>rescue</span><span class=p>:</span>
<a id=__codelineno-531-11 name=__codelineno-531-11 href=#__codelineno-531-11></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-531-12 name=__codelineno-531-12 href=#__codelineno-531-12></a><span class=w>        </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&#39;I</span><span class=nv> </span><span class=s>caught</span><span class=nv> </span><span class=s>an</span><span class=nv> </span><span class=s>error,</span><span class=nv> </span><span class=s>can</span><span class=nv> </span><span class=s>do</span><span class=nv> </span><span class=s>stuff</span><span class=nv> </span><span class=s>here</span><span class=nv> </span><span class=s>to</span><span class=nv> </span><span class=s>fix</span><span class=nv> </span><span class=s>it,</span><span class=nv> </span><span class=s>:-)&#39;</span>
</code></pre></div> <h3 id=yaml-语法>YAML 语法<a class=headerlink href=#yaml-语法 title="Permanent link">&para;</a></h3> <p>YAML 语法见<a href=/basic/Reference/Yaml/ >详细介绍</a></p> <h3 id=prompts-运行时提示输入内容>Prompts: 运行时，提示输入内容<a class=headerlink href=#prompts-运行时提示输入内容 title="Permanent link">&para;</a></h3> <p>在运行playbook时，您可能希望提示用户输入某些内容，可以通过<code>vars_prompt</code>实现这一点。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-532-1 name=__codelineno-532-1 href=#__codelineno-532-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<a id=__codelineno-532-2 name=__codelineno-532-2 href=#__codelineno-532-2></a><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
<a id=__codelineno-532-3 name=__codelineno-532-3 href=#__codelineno-532-3></a><span class=w>  </span><span class=nt>vars_prompt</span><span class=p>:</span>
<a id=__codelineno-532-4 name=__codelineno-532-4 href=#__codelineno-532-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;name&quot;</span>
<a id=__codelineno-532-5 name=__codelineno-532-5 href=#__codelineno-532-5></a><span class=w>      </span><span class=nt>prompt</span><span class=p>:</span><span class=w> </span><span class=s>&quot;what</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>your</span><span class=nv> </span><span class=s>name?&quot;</span>
<a id=__codelineno-532-6 name=__codelineno-532-6 href=#__codelineno-532-6></a><span class=w>      </span><span class=nt>default</span><span class=p>:</span><span class=w> </span><span class=s>&quot;user&quot;</span>
<a id=__codelineno-532-7 name=__codelineno-532-7 href=#__codelineno-532-7></a><span class=w>      </span><span class=nt>private</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-532-8 name=__codelineno-532-8 href=#__codelineno-532-8></a><span class=w>      </span><span class=nt>confirm</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-532-9 name=__codelineno-532-9 href=#__codelineno-532-9></a>
<a id=__codelineno-532-10 name=__codelineno-532-10 href=#__codelineno-532-10></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-532-11 name=__codelineno-532-11 href=#__codelineno-532-11></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg={{ name }}</span>
</code></pre></div> <p><code>vars_prompt</code>的参数</p> <ul> <li>name: 定义变量名称，即输入的内容赋值给此变量</li> <li>prompt：输入得提示信息</li> <li>default： 输入的默认值，没有输入任何内容的时候，把此值赋值给变量</li> <li>private：是否隐藏输入得内容</li> <li>confirm：是否要再次确认输入</li> <li>unsafe: 不校验输入的字符串，如果输入特殊字符，可开启此选项</li> </ul> <p>如果安装了<code>Passlib</code>, <code>vars_prompt</code>还可以对输入的值进行加密</p> <div class=highlight><pre><span></span><code><a id=__codelineno-533-1 name=__codelineno-533-1 href=#__codelineno-533-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<a id=__codelineno-533-2 name=__codelineno-533-2 href=#__codelineno-533-2></a><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
<a id=__codelineno-533-3 name=__codelineno-533-3 href=#__codelineno-533-3></a><span class=w>  </span><span class=nt>vars_prompt</span><span class=p>:</span>
<a id=__codelineno-533-4 name=__codelineno-533-4 href=#__codelineno-533-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;pass&quot;</span>
<a id=__codelineno-533-5 name=__codelineno-533-5 href=#__codelineno-533-5></a><span class=w>      </span><span class=nt>prompt</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Enter</span><span class=nv> </span><span class=s>password2&quot;</span>
<a id=__codelineno-533-6 name=__codelineno-533-6 href=#__codelineno-533-6></a><span class=w>      </span><span class=nt>private</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-533-7 name=__codelineno-533-7 href=#__codelineno-533-7></a><span class=w>      </span><span class=nt>encrypt</span><span class=p>:</span><span class=w> </span><span class=s>&quot;sha512_crypt&quot;</span>
<a id=__codelineno-533-8 name=__codelineno-533-8 href=#__codelineno-533-8></a><span class=w>      </span><span class=nt>confirm</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id=__codelineno-533-9 name=__codelineno-533-9 href=#__codelineno-533-9></a><span class=w>      </span><span class=nt>salt_size</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">7</span>
<a id=__codelineno-533-10 name=__codelineno-533-10 href=#__codelineno-533-10></a>
<a id=__codelineno-533-11 name=__codelineno-533-11 href=#__codelineno-533-11></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-533-12 name=__codelineno-533-12 href=#__codelineno-533-12></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg={{ pass }}</span>
</code></pre></div> <p>可以使用的加密方案</p> <ul> <li><em>des_crypt</em> - DES Crypt</li> <li><em>bsdi_crypt</em> - BSDi Crypt</li> <li><em>bigcrypt</em> - BigCrypt</li> <li><em>crypt16</em> - Crypt16</li> <li><em>md5_crypt</em> - MD5 Crypt</li> <li><em>bcrypt</em> - BCrypt</li> <li><em>sha1_crypt</em> - SHA-1 Crypt</li> <li><em>sun_md5_crypt</em> - Sun MD5 Crypt</li> <li><em>sha256_crypt</em> - SHA-256 Crypt</li> <li><em>sha512_crypt</em> - SHA-512 Crypt</li> <li><em>apr_md5_crypt</em> - Apache’s MD5-Crypt variant</li> <li><em>phpass</em> - PHPass’ Portable Hash</li> <li><em>pbkdf2_digest</em> - Generic PBKDF2 Hashes</li> <li><em>cta_pbkdf2_sha1</em> - Cryptacular’s PBKDF2 hash</li> <li><em>dlitz_pbkdf2_sha1</em> - Dwayne Litzenberger’s PBKDF2 hash</li> <li><em>scram</em> - SCRAM Hash</li> <li><em>bsd_nthash</em> - FreeBSD’s MCF-compatible nthash encoding</li> </ul> <h3 id=标记>标记<a class=headerlink href=#标记 title="Permanent link">&para;</a></h3> <p>如果你有一个大型剧本，但你只希望运行它的一个特定的部分，而不是运行剧本中的所有任务。这时候，你可以为运行的任务指定一个共同的<code>tags</code></p> <h4 id=标记任务>标记任务<a class=headerlink href=#标记任务 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-534-1 name=__codelineno-534-1 href=#__codelineno-534-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-534-2 name=__codelineno-534-2 href=#__codelineno-534-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>yum</span><span class=p>:</span>
<a id=__codelineno-534-3 name=__codelineno-534-3 href=#__codelineno-534-3></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span>
<a id=__codelineno-534-4 name=__codelineno-534-4 href=#__codelineno-534-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id=__codelineno-534-5 name=__codelineno-534-5 href=#__codelineno-534-5></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">memcached</span>
<a id=__codelineno-534-6 name=__codelineno-534-6 href=#__codelineno-534-6></a><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id=__codelineno-534-7 name=__codelineno-534-7 href=#__codelineno-534-7></a><span class=w>  </span><span class=nt>tags</span><span class=p>:</span>
<a id=__codelineno-534-8 name=__codelineno-534-8 href=#__codelineno-534-8></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">packages</span>
<a id=__codelineno-534-9 name=__codelineno-534-9 href=#__codelineno-534-9></a>
<a id=__codelineno-534-10 name=__codelineno-534-10 href=#__codelineno-534-10></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>template</span><span class=p>:</span>
<a id=__codelineno-534-11 name=__codelineno-534-11 href=#__codelineno-534-11></a><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">templates/src.j2</span>
<a id=__codelineno-534-12 name=__codelineno-534-12 href=#__codelineno-534-12></a><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/etc/foo.conf</span>
<a id=__codelineno-534-13 name=__codelineno-534-13 href=#__codelineno-534-13></a><span class=w>  </span><span class=nt>tags</span><span class=p>:</span>
<a id=__codelineno-534-14 name=__codelineno-534-14 href=#__codelineno-534-14></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">configuration</span>
</code></pre></div> <blockquote> <p>标签名称可以重名</p> </blockquote> <p>显示playbook中的所有标记任务</p> <div class=highlight><pre><span></span><code><a id=__codelineno-535-1 name=__codelineno-535-1 href=#__codelineno-535-1></a>ansible-playbook<span class=w>  </span>example.yml<span class=w> </span>--list-tags
</code></pre></div> <p>执行所有标记名称为packages和configuration的任务</p> <div class=highlight><pre><span></span><code><a id=__codelineno-536-1 name=__codelineno-536-1 href=#__codelineno-536-1></a>ansible-playbook<span class=w>  </span>example.yml<span class=w> </span>--tags<span class=w> </span><span class=s2>&quot;configuration,packages&quot;</span>
</code></pre></div> <p>跳过所有标记名称为configuration的任务</p> <div class=highlight><pre><span></span><code><a id=__codelineno-537-1 name=__codelineno-537-1 href=#__codelineno-537-1></a>ansible-playbook<span class=w>  </span>example.yml<span class=w> </span>--skip-tags<span class=w> </span><span class=s2>&quot;configuration&quot;</span>
</code></pre></div> <h4 id=标记playbook>标记playbook<a class=headerlink href=#标记playbook title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-538-1 name=__codelineno-538-1 href=#__codelineno-538-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
<a id=__codelineno-538-2 name=__codelineno-538-2 href=#__codelineno-538-2></a><span class=w>  </span><span class=nt>tags</span><span class=p>:</span>
<a id=__codelineno-538-3 name=__codelineno-538-3 href=#__codelineno-538-3></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bar</span>
<a id=__codelineno-538-4 name=__codelineno-538-4 href=#__codelineno-538-4></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-538-5 name=__codelineno-538-5 href=#__codelineno-538-5></a><span class=w>   </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<a id=__codelineno-538-6 name=__codelineno-538-6 href=#__codelineno-538-6></a>
<a id=__codelineno-538-7 name=__codelineno-538-7 href=#__codelineno-538-7></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
<a id=__codelineno-538-8 name=__codelineno-538-8 href=#__codelineno-538-8></a><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&#39;foo&#39;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-538-9 name=__codelineno-538-9 href=#__codelineno-538-9></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-538-10 name=__codelineno-538-10 href=#__codelineno-538-10></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div> <blockquote> <p>play里的所有tasks将会继承play的tags</p> </blockquote> <h4 id=标记role>标记role<a class=headerlink href=#标记role title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-539-1 name=__codelineno-539-1 href=#__codelineno-539-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>roles</span><span class=p>:</span>
<a id=__codelineno-539-2 name=__codelineno-539-2 href=#__codelineno-539-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="p p-Indicator">{</span><span class=nt> role</span><span class=p>:</span><span class=w> </span><span class=nv>webserver</span><span class="p p-Indicator">,</span><span class=nt> port</span><span class=p>:</span><span class=w> </span><span class=nv>5000</span><span class="p p-Indicator">,</span><span class=nt> tags</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w>  </span><span class=s>&#39;web&#39;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&#39;foo&#39;</span><span class=w> </span><span class="p p-Indicator">]</span><span class=w> </span><span class="p p-Indicator">}</span>
</code></pre></div> <blockquote> <p>role里的tasks将会继承role的tags</p> </blockquote> <h4 id=标记包含>标记包含<a class=headerlink href=#标记包含 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-540-1 name=__codelineno-540-1 href=#__codelineno-540-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>import_role</span><span class=p>:</span>
<a id=__codelineno-540-2 name=__codelineno-540-2 href=#__codelineno-540-2></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myrole</span>
<a id=__codelineno-540-3 name=__codelineno-540-3 href=#__codelineno-540-3></a><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=nv>web</span><span class="p p-Indicator">,</span><span class=w> </span><span class=nv>foo</span><span class=w> </span><span class="p p-Indicator">]</span>
<a id=__codelineno-540-4 name=__codelineno-540-4 href=#__codelineno-540-4></a>
<a id=__codelineno-540-5 name=__codelineno-540-5 href=#__codelineno-540-5></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>import_tasks</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo.yml</span>
<a id=__codelineno-540-6 name=__codelineno-540-6 href=#__codelineno-540-6></a><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=nv>web</span><span class="p p-Indicator">,</span><span class=w> </span><span class=nv>foo</span><span class=w> </span><span class="p p-Indicator">]</span>
</code></pre></div> <blockquote> <p>包含的role和tasks中的任务将会继承tags，动态包含则不继承tag</p> </blockquote> <h4 id=特殊标记>特殊标记<a class=headerlink href=#特殊标记 title="Permanent link">&para;</a></h4> <p>使用<code>always</code>标签可以始终运行标记的任务</p> <div class=highlight><pre><span></span><code><a id=__codelineno-541-1 name=__codelineno-541-1 href=#__codelineno-541-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-541-2 name=__codelineno-541-2 href=#__codelineno-541-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-541-3 name=__codelineno-541-3 href=#__codelineno-541-3></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Always</span><span class=nv> </span><span class=s>runs&quot;</span>
<a id=__codelineno-541-4 name=__codelineno-541-4 href=#__codelineno-541-4></a><span class=w>  </span><span class=nt>tags</span><span class=p>:</span>
<a id=__codelineno-541-5 name=__codelineno-541-5 href=#__codelineno-541-5></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
<a id=__codelineno-541-6 name=__codelineno-541-6 href=#__codelineno-541-6></a>
<a id=__codelineno-541-7 name=__codelineno-541-7 href=#__codelineno-541-7></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-541-8 name=__codelineno-541-8 href=#__codelineno-541-8></a><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;runs</span><span class=nv> </span><span class=s>when</span><span class=nv> </span><span class=s>you</span><span class=nv> </span><span class=s>use</span><span class=nv> </span><span class=s>tag1&quot;</span>
<a id=__codelineno-541-9 name=__codelineno-541-9 href=#__codelineno-541-9></a><span class=w>  </span><span class=nt>tags</span><span class=p>:</span>
<a id=__codelineno-541-10 name=__codelineno-541-10 href=#__codelineno-541-10></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">tag1</span>
</code></pre></div> <p>还有另外4个特殊关键字用于标签，</p> <ul> <li><code>never</code> 阻止任务运行</li> <li><code>tagged</code> 仅运行已标记</li> <li><code>untagged</code> 运行只有未标记</li> <li><code>all</code>运行所有任务</li> </ul> <p>默认情况下ansible运行就像指定了<code>-tags all</code></p> <h3 id=vault-加密>Vault 加密<a class=headerlink href=#vault-加密 title="Permanent link">&para;</a></h3> <p>Vault 加密使用方法见<a href=/basic/Reference/Vaults/ >详细介绍</a></p> <h3 id=从某个任务开始执行>从某个任务开始执行<a class=headerlink href=#从某个任务开始执行 title="Permanent link">&para;</a></h3> <p>为ansible-playbook指定<code>--start-at-task</code>，就可以从这个任务开始执行</p> <div class=highlight><pre><span></span><code><a id=__codelineno-542-1 name=__codelineno-542-1 href=#__codelineno-542-1></a>ansible-playbook<span class=w>  </span>playbook.yml<span class=w> </span>--start-at-task<span class=o>=</span><span class=s2>&quot;install packages&quot;</span>
</code></pre></div> <h3 id=一步一步的执行>一步一步的执行<a class=headerlink href=#一步一步的执行 title="Permanent link">&para;</a></h3> <p>ansible也可以一步一步交互的执行，执行每一步都需要确认是否继续</p> <div class=highlight><pre><span></span><code><a id=__codelineno-543-1 name=__codelineno-543-1 href=#__codelineno-543-1></a>ansible-playbook<span class=w>  </span>playbook.yml<span class=w> </span>--step
</code></pre></div> <h3 id=模块默认值>模块默认值<a class=headerlink href=#模块默认值 title="Permanent link">&para;</a></h3> <p>你可以为多个相同的模块指定默认值,而不必重复填写。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-544-1 name=__codelineno-544-1 href=#__codelineno-544-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<a id=__codelineno-544-2 name=__codelineno-544-2 href=#__codelineno-544-2></a><span class=w>  </span><span class=nt>module_defaults</span><span class=p>:</span>
<a id=__codelineno-544-3 name=__codelineno-544-3 href=#__codelineno-544-3></a><span class=w>    </span><span class=nt>file</span><span class=p>:</span>
<a id=__codelineno-544-4 name=__codelineno-544-4 href=#__codelineno-544-4></a><span class=w>      </span><span class=nt>owner</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<a id=__codelineno-544-5 name=__codelineno-544-5 href=#__codelineno-544-5></a><span class=w>      </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<a id=__codelineno-544-6 name=__codelineno-544-6 href=#__codelineno-544-6></a><span class=w>      </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">0755</span>
<a id=__codelineno-544-7 name=__codelineno-544-7 href=#__codelineno-544-7></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-544-8 name=__codelineno-544-8 href=#__codelineno-544-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>file</span><span class=p>:</span>
<a id=__codelineno-544-9 name=__codelineno-544-9 href=#__codelineno-544-9></a><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">touch</span>
<a id=__codelineno-544-10 name=__codelineno-544-10 href=#__codelineno-544-10></a><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/file1</span>
<a id=__codelineno-544-11 name=__codelineno-544-11 href=#__codelineno-544-11></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>file</span><span class=p>:</span>
<a id=__codelineno-544-12 name=__codelineno-544-12 href=#__codelineno-544-12></a><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">touch</span>
<a id=__codelineno-544-13 name=__codelineno-544-13 href=#__codelineno-544-13></a><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/file2</span>
<a id=__codelineno-544-14 name=__codelineno-544-14 href=#__codelineno-544-14></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>file</span><span class=p>:</span>
<a id=__codelineno-544-15 name=__codelineno-544-15 href=#__codelineno-544-15></a><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">touch</span>
<a id=__codelineno-544-16 name=__codelineno-544-16 href=#__codelineno-544-16></a><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/file3</span>
</code></pre></div> <p>可以在play、block和task级别使用module_defaults属性。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-545-1 name=__codelineno-545-1 href=#__codelineno-545-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>block</span><span class=p>:</span>
<a id=__codelineno-545-2 name=__codelineno-545-2 href=#__codelineno-545-2></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-545-3 name=__codelineno-545-3 href=#__codelineno-545-3></a><span class=w>        </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;a</span><span class=nv> </span><span class=s>different</span><span class=nv> </span><span class=s>message&quot;</span>
<a id=__codelineno-545-4 name=__codelineno-545-4 href=#__codelineno-545-4></a><span class=w>  </span><span class=nt>module_defaults</span><span class=p>:</span>
<a id=__codelineno-545-5 name=__codelineno-545-5 href=#__codelineno-545-5></a><span class=w>    </span><span class=nt>debug</span><span class=p>:</span>
<a id=__codelineno-545-6 name=__codelineno-545-6 href=#__codelineno-545-6></a><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s>&quot;a</span><span class=nv> </span><span class=s>default</span><span class=nv> </span><span class=s>message&quot;</span>
<a id=__codelineno-545-7 name=__codelineno-545-7 href=#__codelineno-545-7></a>
<a id=__codelineno-545-8 name=__codelineno-545-8 href=#__codelineno-545-8></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>file</span><span class=p>:</span>
<a id=__codelineno-545-9 name=__codelineno-545-9 href=#__codelineno-545-9></a><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">touch</span>
<a id=__codelineno-545-10 name=__codelineno-545-10 href=#__codelineno-545-10></a><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/file1</span>
<a id=__codelineno-545-11 name=__codelineno-545-11 href=#__codelineno-545-11></a><span class=w>  </span><span class=nt>module_defaults</span><span class=p>:</span>
<a id=__codelineno-545-12 name=__codelineno-545-12 href=#__codelineno-545-12></a><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span>
</code></pre></div> <p>在playbook中，您可以为整个模块组设置模块默认值，例如设置一个公共AWS区域。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-546-1 name=__codelineno-546-1 href=#__codelineno-546-1></a><span class=c1># example_play.yml</span>
<a id=__codelineno-546-2 name=__codelineno-546-2 href=#__codelineno-546-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<a id=__codelineno-546-3 name=__codelineno-546-3 href=#__codelineno-546-3></a><span class=w>  </span><span class=nt>module_defaults</span><span class=p>:</span>
<a id=__codelineno-546-4 name=__codelineno-546-4 href=#__codelineno-546-4></a><span class=w>    </span><span class=nt>group/aws</span><span class=p>:</span>
<a id=__codelineno-546-5 name=__codelineno-546-5 href=#__codelineno-546-5></a><span class=w>      </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">us-west-2</span>
<a id=__codelineno-546-6 name=__codelineno-546-6 href=#__codelineno-546-6></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-546-7 name=__codelineno-546-7 href=#__codelineno-546-7></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>aws_s3_bucket_info</span><span class=p>:</span>
<a id=__codelineno-546-8 name=__codelineno-546-8 href=#__codelineno-546-8></a><span class=w>  </span><span class=c1># now the region is shared between both info modules</span>
<a id=__codelineno-546-9 name=__codelineno-546-9 href=#__codelineno-546-9></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>ec2_ami_info</span><span class=p>:</span>
<a id=__codelineno-546-10 name=__codelineno-546-10 href=#__codelineno-546-10></a><span class=w>      </span><span class=nt>filters</span><span class=p>:</span>
<a id=__codelineno-546-11 name=__codelineno-546-11 href=#__codelineno-546-11></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&#39;RHEL*7.5*&#39;</span>
</code></pre></div> <p>可用于group的模块</p> <table> <thead> <tr> <th>Group</th> <th>Purpose</th> <th>Ansible Version</th> </tr> </thead> <tbody> <tr> <td>aws</td> <td>Amazon Web Services</td> <td>2.7</td> </tr> <tr> <td>azure</td> <td>Azure</td> <td>2.7</td> </tr> <tr> <td>gcp</td> <td>Google Cloud Platform</td> <td>2.7</td> </tr> <tr> <td>k8s</td> <td>Kubernetes</td> <td>2.8</td> </tr> <tr> <td>os</td> <td>OpenStack</td> <td>2.8</td> </tr> </tbody> </table> <h3 id=等待>等待<a class=headerlink href=#等待 title="Permanent link">&para;</a></h3> <p>使用<code>wait_for</code>模块，可以等待任务执行完毕后，才可继续执行后续的任务。</p> <p>等待端口可用,才能继续执行任务</p> <div class=highlight><pre><span></span><code><a id=__codelineno-547-1 name=__codelineno-547-1 href=#__codelineno-547-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>wait_for</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">port=8000 delay=10</span>
</code></pre></div> <p>等待直到锁定文件被删除</p> <div class=highlight><pre><span></span><code><a id=__codelineno-548-1 name=__codelineno-548-1 href=#__codelineno-548-1></a><span class=nt>wait_for</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">path=/var/lock/file.lock state=absent</span>
</code></pre></div> <h3 id=playbook-关键字>Playbook 关键字<a class=headerlink href=#playbook-关键字 title="Permanent link">&para;</a></h3> <p>Playbook 可用的关键字见<a href=basic/Reference/Keywords/ >详细列表</a></p> <h3 id=lookup-插件_1>lookup 插件<a class=headerlink href=#lookup-插件_1 title="Permanent link">&para;</a></h3> <p><code>lookup</code>插件允许访问外部数据源。与所有模板一样，这些插件是在Ansible control节点上执行的。</p> <h4 id=使用-file-获取文件内容>使用 <code>file</code> 获取文件内容<a class=headerlink href=#使用-file-获取文件内容 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-549-1 name=__codelineno-549-1 href=#__codelineno-549-1></a><span class=nn>---</span>
<a id=__codelineno-549-2 name=__codelineno-549-2 href=#__codelineno-549-2></a>
<a id=__codelineno-549-3 name=__codelineno-549-3 href=#__codelineno-549-3></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
<a id=__codelineno-549-4 name=__codelineno-549-4 href=#__codelineno-549-4></a><span class=w>  </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-549-5 name=__codelineno-549-5 href=#__codelineno-549-5></a><span class=w>     </span><span class=nt>contents</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>lookup(&#39;file&#39;,</span><span class=nv>  </span><span class=s>&#39;/etc/foo.txt&#39;)</span><span class=nv> </span><span class=s>}}&quot;</span>
<a id=__codelineno-549-6 name=__codelineno-549-6 href=#__codelineno-549-6></a>
<a id=__codelineno-549-7 name=__codelineno-549-7 href=#__codelineno-549-7></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-549-8 name=__codelineno-549-8 href=#__codelineno-549-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;the value of foo.txt is {{  contents }}&quot;</span>
</code></pre></div> <h4 id=使用-env-获取变量>使用 <code>env</code> 获取变量<a class=headerlink href=#使用-env-获取变量 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-550-1 name=__codelineno-550-1 href=#__codelineno-550-1></a><span class=nn>---</span>
<a id=__codelineno-550-2 name=__codelineno-550-2 href=#__codelineno-550-2></a>
<a id=__codelineno-550-3 name=__codelineno-550-3 href=#__codelineno-550-3></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
<a id=__codelineno-550-4 name=__codelineno-550-4 href=#__codelineno-550-4></a><span class=w>  </span><span class=nt>vars</span><span class=p>:</span>
<a id=__codelineno-550-5 name=__codelineno-550-5 href=#__codelineno-550-5></a><span class=w>    </span><span class=nt>local_home</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{</span><span class=nv> </span><span class=s>lookup(&#39;env&#39;,&#39;HOME&#39;)</span><span class=nv>  </span><span class=s>}}&quot;</span>
<a id=__codelineno-550-6 name=__codelineno-550-6 href=#__codelineno-550-6></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-550-7 name=__codelineno-550-7 href=#__codelineno-550-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">var=local_home</span>
</code></pre></div> <h4 id=使用-password-生成密码字符串>使用 <code>password</code> 生成密码字符串<a class=headerlink href=#使用-password-生成密码字符串 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-551-1 name=__codelineno-551-1 href=#__codelineno-551-1></a><span class=nn>---</span>
<a id=__codelineno-551-2 name=__codelineno-551-2 href=#__codelineno-551-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
<a id=__codelineno-551-3 name=__codelineno-551-3 href=#__codelineno-551-3></a>
<a id=__codelineno-551-4 name=__codelineno-551-4 href=#__codelineno-551-4></a><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-551-5 name=__codelineno-551-5 href=#__codelineno-551-5></a><span class=w>    </span><span class=c1>#  使用只有ascii字母且长度为8的随机密码创建一个mysql用户:</span>
<a id=__codelineno-551-6 name=__codelineno-551-6 href=#__codelineno-551-6></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mysql_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">name={{ client  }}</span>
<a id=__codelineno-551-7 name=__codelineno-551-7 href=#__codelineno-551-7></a><span class=w>                  </span><span class="l l-Scalar l-Scalar-Plain">password=&quot;{{  lookup(&#39;password&#39;, &#39;/tmp/passwordfile chars=ascii_letters length=8&#39;) }}&quot;</span>
<a id=__codelineno-551-8 name=__codelineno-551-8 href=#__codelineno-551-8></a><span class=w>                  </span><span class="l l-Scalar l-Scalar-Plain">priv={{ client }}_{{  tier }}_{{ role }}.*:ALL</span>
<a id=__codelineno-551-9 name=__codelineno-551-9 href=#__codelineno-551-9></a>
<a id=__codelineno-551-10 name=__codelineno-551-10 href=#__codelineno-551-10></a><span class=w>    </span><span class=c1># 使用只有数字的随机密码创建一个mysql用户:</span>
<a id=__codelineno-551-11 name=__codelineno-551-11 href=#__codelineno-551-11></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mysql_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">name={{ client  }}</span>
<a id=__codelineno-551-12 name=__codelineno-551-12 href=#__codelineno-551-12></a><span class=w>                  </span><span class="l l-Scalar l-Scalar-Plain">password=&quot;{{  lookup(&#39;password&#39;, &#39;/tmp/passwordfile chars=digits&#39;) }}&quot;</span>
<a id=__codelineno-551-13 name=__codelineno-551-13 href=#__codelineno-551-13></a><span class=w>                  </span><span class="l l-Scalar l-Scalar-Plain">priv={{ client }}_{{  tier }}_{{ role }}.*:ALL</span>
<a id=__codelineno-551-14 name=__codelineno-551-14 href=#__codelineno-551-14></a>
<a id=__codelineno-551-15 name=__codelineno-551-15 href=#__codelineno-551-15></a><span class=w>    </span><span class=c1># 使用许多不同的字符集使用随机密码创建一个mysql用户：</span>
<a id=__codelineno-551-16 name=__codelineno-551-16 href=#__codelineno-551-16></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mysql_user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">name={{ client  }}</span>
<a id=__codelineno-551-17 name=__codelineno-551-17 href=#__codelineno-551-17></a><span class=w>                  </span><span class="l l-Scalar l-Scalar-Plain">password=&quot;{{  lookup(&#39;password&#39;, &#39;/tmp/passwordfile  chars=ascii_letters,digits,hexdigits,punctuation&#39;) }}&quot;</span>
<a id=__codelineno-551-18 name=__codelineno-551-18 href=#__codelineno-551-18></a><span class=w>                  </span><span class="l l-Scalar l-Scalar-Plain">priv={{ client }}_{{  tier }}_{{ role }}.*:ALL</span>
</code></pre></div> <p>如果文件已存在，则不会向其写入任何数据。 如果文件有内容，那些内容将作为密码读入。 空文件导致密码以空字符串返回。</p> <h4 id=使用-csvfile-读取csv文件>使用 <code>csvfile</code> 读取csv文件<a class=headerlink href=#使用-csvfile-读取csv文件 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-552-1 name=__codelineno-552-1 href=#__codelineno-552-1></a># f.csv 
<a id=__codelineno-552-2 name=__codelineno-552-2 href=#__codelineno-552-2></a>
<a id=__codelineno-552-3 name=__codelineno-552-3 href=#__codelineno-552-3></a>Symbol,Atomic  Number,Atomic Mass
<a id=__codelineno-552-4 name=__codelineno-552-4 href=#__codelineno-552-4></a>H,1,1.008
<a id=__codelineno-552-5 name=__codelineno-552-5 href=#__codelineno-552-5></a>He,2,4.0026
<a id=__codelineno-552-6 name=__codelineno-552-6 href=#__codelineno-552-6></a>Li,3,6.94
<a id=__codelineno-552-7 name=__codelineno-552-7 href=#__codelineno-552-7></a>Be,4,9.012
<a id=__codelineno-552-8 name=__codelineno-552-8 href=#__codelineno-552-8></a>B,5,10.81
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-553-1 name=__codelineno-553-1 href=#__codelineno-553-1></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;The atomic number of Lithium is {{ lookup(&#39;csvfile&#39;, &#39;Li  file=elements.csv delimiter=,&#39;) }}&quot;</span>
<a id=__codelineno-553-2 name=__codelineno-553-2 href=#__codelineno-553-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;The atomic mass of Lithium is {{ lookup(&#39;csvfile&#39;, &#39;Li  file=elements.csv delimiter=, col=2&#39;) }}&quot;</span>
</code></pre></div> <p>参数描述</p> <table> <thead> <tr> <th>参数</th> <th>默认值</th> <th>描述</th> </tr> </thead> <tbody> <tr> <td>file</td> <td>ansible.csv</td> <td>要加载的文件名称</td> </tr> <tr> <td>col</td> <td>1</td> <td>要输出的列，索引从0开始</td> </tr> <tr> <td>delimiter</td> <td>TAB</td> <td>文件的分隔符</td> </tr> <tr> <td>default</td> <td>empty string</td> <td>如果key不在csv文件中，则为默认返回值</td> </tr> <tr> <td>encoding</td> <td>utf-8</td> <td>使用的CSV文件的编码（字符集）(added in version 2.1)</td> </tr> </tbody> </table> <h4 id=使用-ini--读取ini文件>使用 <code>ini</code> 读取ini文件<a class=headerlink href=#使用-ini--读取ini文件 title="Permanent link">&para;</a></h4> <p>在section下查找以key1 = value1的格式来读取文件的内容。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-554-1 name=__codelineno-554-1 href=#__codelineno-554-1></a><span class=c1># users.ini</span>
<a id=__codelineno-554-2 name=__codelineno-554-2 href=#__codelineno-554-2></a>
<a id=__codelineno-554-3 name=__codelineno-554-3 href=#__codelineno-554-3></a><span class=k>[production]</span>
<a id=__codelineno-554-4 name=__codelineno-554-4 href=#__codelineno-554-4></a><span class=c1># My production information</span>
<a id=__codelineno-554-5 name=__codelineno-554-5 href=#__codelineno-554-5></a><span class=na>user</span><span class=o>=</span><span class=s>robert</span>
<a id=__codelineno-554-6 name=__codelineno-554-6 href=#__codelineno-554-6></a><span class=na>pass</span><span class=o>=</span><span class=s>somerandompassword</span>
<a id=__codelineno-554-7 name=__codelineno-554-7 href=#__codelineno-554-7></a>
<a id=__codelineno-554-8 name=__codelineno-554-8 href=#__codelineno-554-8></a><span class=k>[integration]</span>
<a id=__codelineno-554-9 name=__codelineno-554-9 href=#__codelineno-554-9></a><span class=c1># My  integration information</span>
<a id=__codelineno-554-10 name=__codelineno-554-10 href=#__codelineno-554-10></a><span class=na>user</span><span class=o>=</span><span class=s>gertrude</span>
<a id=__codelineno-554-11 name=__codelineno-554-11 href=#__codelineno-554-11></a><span class=na>pass</span><span class=o>=</span><span class=s>anotherpassword</span>
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-555-1 name=__codelineno-555-1 href=#__codelineno-555-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-555-2 name=__codelineno-555-2 href=#__codelineno-555-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;User in integration is {{  lookup(&#39;ini&#39;, &#39;user section=integration file=users.ini&#39;) }}&quot;</span>
<a id=__codelineno-555-3 name=__codelineno-555-3 href=#__codelineno-555-3></a>
<a id=__codelineno-555-4 name=__codelineno-555-4 href=#__codelineno-555-4></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;User in production  is {{ lookup(&#39;ini&#39;, &#39;pass section=production  file=users.ini&#39;)  }}&quot;</span>
</code></pre></div> <p>ini 参数格式 <div class=highlight><pre><span></span><code><a id=__codelineno-556-1 name=__codelineno-556-1 href=#__codelineno-556-1></a><span class="l l-Scalar l-Scalar-Plain">lookup(&#39;ini&#39;,  &#39;key [type=&lt;properties|ini&gt;] [section=section] [file=file.ini] [re=true]  [default=&lt;defaultvalue&gt;]&#39;)</span>
</code></pre></div></p> <p>第一个值必须是ini文件里的key</p> <p>参数描述</p> <table> <thead> <tr> <th>字段</th> <th>默认值</th> <th>描述</th> </tr> </thead> <tbody> <tr> <td>type</td> <td>ini</td> <td>文件类型。 可以是ini或properties （对于javaproperties ）。</td> </tr> <tr> <td>file</td> <td>ansible.ini</td> <td>要加载的文件名称</td> </tr> <tr> <td>section</td> <td>global</td> <td>在哪里查找key</td> </tr> <tr> <td>re</td> <td>False</td> <td>开启正则匹配</td> </tr> <tr> <td>default</td> <td>empty string</td> <td>如果key不在文件中，则为默认返回值</td> </tr> </tbody> </table> <h4 id=使用-dig-dns查询>使用 <code>dig</code> dns查询<a class=headerlink href=#使用-dig-dns查询 title="Permanent link">&para;</a></h4> <p>此模块依赖 <code>dnspython</code> 库</p> <div class=highlight><pre><span></span><code><a id=__codelineno-557-1 name=__codelineno-557-1 href=#__codelineno-557-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-557-2 name=__codelineno-557-2 href=#__codelineno-557-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;The IPv4 address for example.com. is {{ lookup(&#39;dig&#39;,  &#39;example.com.&#39;)}}&quot;</span>
<a id=__codelineno-557-3 name=__codelineno-557-3 href=#__codelineno-557-3></a>
<a id=__codelineno-557-4 name=__codelineno-557-4 href=#__codelineno-557-4></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;The TXT record for example.org. is {{ lookup(&#39;dig&#39;, &#39;example.org.&#39;,  &#39;qtype=TXT&#39;) }}&quot;</span>
<a id=__codelineno-557-5 name=__codelineno-557-5 href=#__codelineno-557-5></a>
<a id=__codelineno-557-6 name=__codelineno-557-6 href=#__codelineno-557-6></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;The TXT record for example.org. is {{ lookup(&#39;dig&#39;,  &#39;example.org./TXT&#39;) }}&quot;</span>
</code></pre></div> <p>其他插件 <div class=highlight><pre><span></span><code><a id=__codelineno-558-1 name=__codelineno-558-1 href=#__codelineno-558-1></a><span class=nt>tasks</span><span class=p>:</span>
<a id=__codelineno-558-2 name=__codelineno-558-2 href=#__codelineno-558-2></a>
<a id=__codelineno-558-3 name=__codelineno-558-3 href=#__codelineno-558-3></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{ lookup(&#39;env&#39;,&#39;HOME&#39;) }} is an  environment variable&quot;</span>
<a id=__codelineno-558-4 name=__codelineno-558-4 href=#__codelineno-558-4></a>
<a id=__codelineno-558-5 name=__codelineno-558-5 href=#__codelineno-558-5></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{ lookup(&#39;pipe&#39;,&#39;date&#39;) }} is the  raw result of running this command&quot;</span>
<a id=__codelineno-558-6 name=__codelineno-558-6 href=#__codelineno-558-6></a>
<a id=__codelineno-558-7 name=__codelineno-558-7 href=#__codelineno-558-7></a><span class=c1># redis_kv lookup requires the  Python redis package</span>
<a id=__codelineno-558-8 name=__codelineno-558-8 href=#__codelineno-558-8></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{  lookup(&#39;redis_kv&#39;, &#39;redis://localhost:6379,somekey&#39;) }} is value in Redis for  somekey&quot;</span>
<a id=__codelineno-558-9 name=__codelineno-558-9 href=#__codelineno-558-9></a>
<a id=__codelineno-558-10 name=__codelineno-558-10 href=#__codelineno-558-10></a><span class=c1># dnstxt lookup requires the Python  dnspython package</span>
<a id=__codelineno-558-11 name=__codelineno-558-11 href=#__codelineno-558-11></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{  lookup(&#39;dnstxt&#39;, &#39;example.com&#39;) }} is a DNS TXT record for example.com&quot;</span>
<a id=__codelineno-558-12 name=__codelineno-558-12 href=#__codelineno-558-12></a>
<a id=__codelineno-558-13 name=__codelineno-558-13 href=#__codelineno-558-13></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{ lookup(&#39;template&#39;,  &#39;./some_template.j2&#39;) }} is a value from evaluation of this template&quot;</span>
<a id=__codelineno-558-14 name=__codelineno-558-14 href=#__codelineno-558-14></a>
<a id=__codelineno-558-15 name=__codelineno-558-15 href=#__codelineno-558-15></a><span class=c1># loading a json file from a  template as a string</span>
<a id=__codelineno-558-16 name=__codelineno-558-16 href=#__codelineno-558-16></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{  lookup(&#39;template&#39;, &#39;./some_json.json.j2&#39;, convert_data=False) }} is a value  from evaluation of this template&quot;</span>
<a id=__codelineno-558-17 name=__codelineno-558-17 href=#__codelineno-558-17></a>
<a id=__codelineno-558-18 name=__codelineno-558-18 href=#__codelineno-558-18></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{ lookup(&#39;etcd&#39;, &#39;foo&#39;) }} is a  value from a locally running etcd&quot;</span>
<a id=__codelineno-558-19 name=__codelineno-558-19 href=#__codelineno-558-19></a>
<a id=__codelineno-558-20 name=__codelineno-558-20 href=#__codelineno-558-20></a><span class=c1># shelvefile lookup retrieves a  string value corresponding to a key inside a Python shelve file</span>
<a id=__codelineno-558-21 name=__codelineno-558-21 href=#__codelineno-558-21></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{  lookup(&#39;shelvefile&#39;, &#39;file=path_to_some_shelve_file.db key=key_to_retrieve&#39;)  }}</span>
</code></pre></div></p> <hr> <div class=md-source-file> <small> 最后更新: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">April 10, 2023 10:21:42</span> <br> 创建日期: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">April 7, 2023 16:55:02</span> </small> </div> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> Was this page helpful? </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title="This page was helpful" data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title="This page could be improved" data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> Thanks for your feedback! </div> <div data-md-value=0 hidden> Thanks for your feedback! Help us improve this page by using our <a href="https://github.com/hujianli94/hujianli94.github.io/issues/new/?title=[Feedback]+Ansible%E5%85%A5%E9%97%A8+-+/Linux/Ansible/0.Ansible%E5%85%A5%E9%97%A8/" target=_blank>feedback form</a>. </div> </div> </div> </fieldset> </form> </article> </div> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=页脚> <a href=../../serveices/0.ubuntu-desktop-vmware/ class="md-footer__link md-footer__link--prev" aria-label="上一页: ubuntu-desktop-vmware" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> 上一页 </span> <div class=md-ellipsis> ubuntu-desktop-vmware </div> </div> </a> <a href=../1.Ansible%E6%89%A9%E5%B1%95%E9%98%85%E8%AF%BB/ class="md-footer__link md-footer__link--next" aria-label="下一页: Ansible扩展阅读" rel=next> <div class=md-footer__title> <span class=md-footer__direction> 下一页 </span> <div class=md-ellipsis> Ansible扩展阅读 </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2023 - 2024 hujainli94 </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/hujianli94 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://kaliarch-bucket-1251990360.cos.ap-beijing.myqcloud.com/blog_img/20220125122524.png target=_blank rel=noopener title=kaliarch-bucket-1251990360.cos.ap-beijing.myqcloud.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M385.2 167.6c6.4 0 12.6.3 18.8 1.1C387.4 90.3 303.3 32 207.7 32 100.5 32 13 104.8 13 197.4c0 53.4 29.3 97.5 77.9 131.6l-19.3 58.6 68-34.1c24.4 4.8 43.8 9.7 68.2 9.7 6.2 0 12.1-.3 18.3-.8-4-12.9-6.2-26.6-6.2-40.8-.1-84.9 72.9-154 165.3-154zm-104.5-52.9c14.5 0 24.2 9.7 24.2 24.4 0 14.5-9.7 24.2-24.2 24.2-14.8 0-29.3-9.7-29.3-24.2.1-14.7 14.6-24.4 29.3-24.4zm-136.4 48.6c-14.5 0-29.3-9.7-29.3-24.2 0-14.8 14.8-24.4 29.3-24.4 14.8 0 24.4 9.7 24.4 24.4 0 14.6-9.6 24.2-24.4 24.2zM563 319.4c0-77.9-77.9-141.3-165.4-141.3-92.7 0-165.4 63.4-165.4 141.3S305 460.7 397.6 460.7c19.3 0 38.9-5.1 58.6-9.9l53.4 29.3-14.8-48.6C534 402.1 563 363.2 563 319.4zm-219.1-24.5c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.8 0 24.4 9.7 24.4 19.3 0 10-9.7 19.6-24.4 19.6zm107.1 0c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.5 0 24.4 9.7 24.4 19.3.1 10-9.9 19.6-24.4 19.6z"/></svg> </a> <a href="mailto:<1879324764@qq.com>" target=_blank rel=noopener title=发送邮件 class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.7l167.6-182.9c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">同意</button> <label class=md-button for=__settings>管理设定</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script> <script id=__config type=application/json>{"base": "../../..", "features": ["content.action.edit", "content.action.view", "content.code.copy", "content.code.annotate", "navigation.indexes", "navigation.footer", "navigation.indexes", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest"], "search": "../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../../assets/javascripts/bundle.51198bba.min.js></script> <script src=../../../javascripts/extra.js></script> <script src=https://file.cdn.shafish.cn/blog/js/video.min.js></script> </body> </html>