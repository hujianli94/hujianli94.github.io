{"config":{"lang":["ja"],"separator":"[\\s\\u200b\\-]","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u9996\u9875","text":""},{"location":"#\u80e1\u5c0f\u5065-devops\u8fd0\u7ef4\u5f00\u53d1\u624b\u8bb0","title":"\u80e1\u5c0f\u5065 DevOps\u8fd0\u7ef4\u5f00\u53d1\u624b\u8bb0","text":"<p>\u5305\u542b\u77e5\u8bc6\u4e14\u4e0d\u4ec5\u9650\u4e8e </p> <ul> <li>\u4e91\u539f\u751f</li> <li>Devops</li> <li>Golang</li> <li>Python</li> <li>Shell</li> <li>\u4e91\u67b6\u6784</li> <li>kubernetes</li> </ul>"},{"location":"#\u4e2a\u4eba\u4fe1\u606f","title":"\u4e2a\u4eba\u4fe1\u606f\uff1a","text":"<p>Info<ul> <li> <p>GitHub</p> </li> <li> <p>\u6398\u91d1</p> </li> <li> <p>\u6155\u8bfe\u7f51</p> </li> <li> <p>51CTO</p> </li> <li> <p>InfoQ</p> </li> </ul> </p>"},{"location":"#\u5176\u4ed6\u53c2\u8003\u7b14\u8bb0","title":"\u5176\u4ed6\u53c2\u8003\u7b14\u8bb0","text":"<p>Info<ul> <li> <p>Linux 101 Docs</p> </li> <li> <p>awesome-kubernetes-notes</p> </li> <li> <p>kubectl-img</p> </li> <li> <p>shell-scripts</p> </li> </ul> </p>"},{"location":"#\u4e00\u4e9b\u63d0\u793a\u7b26","title":"\u4e00\u4e9b\u63d0\u793a\u7b26","text":"<p>\u672c\u6587\u5df2\u5b8c\u7a3f\u5e76\u901a\u8fc7\u5ba1\u9605\uff0c\u662f\u6b63\u5f0f\u7248\u672c\u3002</p> <p>\u672c\u6587\u5df2\u57fa\u672c\u5b8c\u7a3f\uff0c\u6b63\u5728\u5ba1\u9605\u548c\u4fee\u8ba2\u4e2d\uff0c\u4e0d\u662f\u6b63\u5f0f\u7248\u672c\u3002</p> <p>\u5bfc\u8a00</p> <p>\u672c\u7ae0\u8282\u5c06\u4ecb\u7ecd\u4e00\u4e9b\u5e38\u7528\u7684 shell \u6587\u672c\u5904\u7406\u5de5\u5177\uff0c\u5b83\u4eec\u53ef\u4ee5\u5e2e\u52a9\u4f60\u66f4\u52a0\u5f97\u5fc3\u5e94\u624b\u5730\u5904\u7406\u5927\u91cf\u6709\u89c4\u5f8b\u7684\u6587\u672c\u3002</p> <p>\u4e3a\u4fdd\u6301\u7b80\u6d01\uff0c\u5404\u5de5\u5177\u7684\u4ecb\u7ecd\u7686\u70b9\u5230\u5373\u6b62\uff0c\u8fdb\u4e00\u6b65\u7684\u7528\u6cd5\u8bf7\u81ea\u884c\u67e5\u627e\u3002</p> <p>\u5e2e\u52a9\u7406\u89e3\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u5de5\u5177</p> <p>Regex101 \u7f51\u7ad9\u96c6\u6210\u4e86\u5e38\u89c1\u7f16\u7a0b\u8bed\u8a00\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u89e3\u6790\u5de5\u5177\uff0c\u5728\u7f16\u5199\u6b63\u5219\u65f6\u53ef\u4ee5\u4f5c\u4e3a\u4e00\u4e2a\u4e0d\u9519\u7684\u53c2\u8003\u3002</p> <p>Shell \u6587\u672c\u5904\u7406\u5de5\u5177\u7ec3\u4e60 1\uff1a\u6587\u4ef6\u5185\u5bb9\u66ff\u6362</p> <p>\u67d0 shell \u811a\u672c\u4f1a\u968f\u7740\u56fe\u5f62\u754c\u9762\u542f\u52a8\u800c\u542f\u52a8\uff0c\u542f\u52a8\u540e\u4f1a\u6839\u636e\u73af\u5883\u53d8\u91cf\u66ff\u6362\u67d0\u7a0b\u5e8f\u914d\u7f6e\u6587\u4ef6\u7684\u5185\u5bb9\u3002\u8be5\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>[settings]\nhomepage=http://example.com/\nlocation-entry-search=http://cn.bing.com/search?q=%s\n</code></pre> <p>\u6211\u4eec\u5e0c\u671b\u7f16\u5199\u4e00\u6761\u6216\u591a\u6761 sed \u547d\u4ee4\uff0c\u4f7f\u5f97\u811a\u672c\u8fd0\u884c\u540e\u914d\u7f6e\u6587\u4ef6\u88ab\u4fee\u6539\u4e3a\uff1a</p> <pre><code>[settings]\nhomepage=http://example.com/index_new.html\nlocation-entry-search=http://www.wolframalpha.com/input/?i=%s\n</code></pre> <p>\u4e0d\u6b62\u5982\u6b64\uff01</p> <p>grep \u4e8b\u5b9e\u4e0a\u662f\u975e\u5e38\u5f3a\u5927\u7684\u67e5\u627e\u5de5\u5177\uff0c\u7b2c\u4e5d\u7ae0\u5c06\u5728\u4ecb\u7ecd\u6b63\u5219\u8868\u8fbe\u5f0f\u8bed\u6cd5\u4e4b\u540e\u8fdb\u4e00\u6b65\u4ecb\u7ecd grep\u3002</p> <p>\u5c0f\u77e5\u8bc6</p> <p>\u9664\u4e86 stdin \u548c stdout \u8fd8\u6709\u6807\u51c6\u9519\u8bef\uff08stderr\uff09\uff0c\u4ed6\u4eec\u7684\u7f16\u53f7\u5206\u522b\u662f 0\u30011\u30012\u3002stderr \u53ef\u4ee5\u7528 <code>2&gt;</code> \u91cd\u5b9a\u5411\uff08\u6ce8\u610f\u6570\u5b57 2 \u548c &gt; \u4e4b\u95f4\u6ca1\u6709\u7a7a\u683c\uff09\u3002</p> <p>\u4f7f\u7528 <code>2&gt;&amp;1</code> \u53ef\u4ee5\u5c06 stderr \u5408\u5e76\u5230 stdout\u3002</p> \u8303\u4f8b <p>\u8f93\u51fa\u5fc5\u5e94\u4e3b\u9875\u7684\u4ee3\u7801\uff1a</p> <pre><code>$ curl \"http://cn.bing.com\"\n</code></pre> <p>\u4f7f\u7528\u91cd\u5b9a\u5411\u628a\u5fc5\u5e94\u9875\u9762\u4fdd\u5b58\u81f3 <code>bing.html</code> \u672c\u5730\uff1a</p> <pre><code>$ curl \"http://cn.bing.com\" &gt; bing.html\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>-o</code> \u9009\u9879\u6307\u5b9a\u8f93\u51fa\u6587\u4ef6\uff1a</p> <pre><code>$ curl -o bing.html \"http://cn.bing.com\"\n</code></pre> <p>\u4e0b\u8f7d USTCLUG \u7684 logo\uff1a</p> <pre><code>$ curl -O \"https://ftp.lug.ustc.edu.cn/misc/logo-whiteback-circle.png\"\n</code></pre> <p>\u53ea\u5c55\u793a HTTP \u54cd\u5e94\u5934\u5185\u5bb9\uff1a</p> <p>```shell $ curl -I \"http://cn.bing.com\"</p> <p>\u53d8\u91cf\u4f7f\u7528\u793a\u4f8b</p> <p>\u53d8\u91cf\u5b9a\u4e49\uff1a</p> <pre><code>for skill in Ada Coffee Action Java; do\necho \"I am good at ${skill}Script\"\ndone\n</code></pre> <p>\u8868\u683c</p> <p>\u5e38\u7528\u7684\u9009\u9879</p> \u9009\u9879 \u542b\u4e49 <code>-i</code>, <code>--input-file=\u6587\u4ef6</code> \u4e0b\u8f7d\u672c\u5730\u6216\u5916\u90e8\u6587\u4ef6\u4e2d\u7684 URL <code>-O</code>, <code>--output-document=\u6587\u4ef6</code> \u5c06\u8f93\u51fa\u5199\u5165\u6587\u4ef6 <code>-b</code>, <code>--background</code> \u5728\u540e\u53f0\u8fd0\u884c wget <code>-d</code>, <code>--debug</code> \u8c03\u8bd5\u6a21\u5f0f\uff0c\u6253\u5370\u51fa wget \u8fd0\u884c\u65f6\u7684\u8c03\u8bd5\u4fe1\u606f"},{"location":"#\u7ae0\u8282\u7f16\u5199\u6307\u5bfc\u6807\u9898\u8bf7\u7528-h1-\u7b49\u7ea7\u7f16\u5199","title":"\u7ae0\u8282\u7f16\u5199\u6307\u5bfc\uff08\u6807\u9898\u8bf7\u7528 h1 \u7b49\u7ea7\u7f16\u5199\u3002\uff09","text":"<p>\u672c\u6587\u9762\u5411\u7f16\u5199\u7ec4\u63d0\u4f9b\u6307\u5bfc\u548c\u89c4\u8303\uff0c\u4e0d\u9762\u5411\u8bfb\u8005\u9605\u8bfb\uff0c\u4e0d\u5c5e\u4e8e\u672c\u4e66\u6b63\u6587\u3002</p> <p>\u5bfc\u8a00</p> <p>\u5728\u6bcf\u4e00\u7ae0\u7684\u5f00\u59cb\u90fd\u9700\u8981\u7f16\u5199\u7ae0\u8282\u5bfc\u8a00\u3002\u5bfc\u8a00\u7684\u76ee\u7684\u6709\u4e24\u4e2a\uff1a\u4e00\u662f\u4e3a\u4e86\u94fa\u57ab\u4e00\u4e9b\u524d\u7f6e\u77e5\u8bc6\u4ee5\u65b9\u4fbf\u540e\u7eed\u5c55\u5f00\u6b63\u6587\uff1b\u4e8c\u662f\u5199\u51fa\u4e00\u4e2a\u5185\u5bb9\u6458\u8981\u6765\u8f85\u52a9\u8bfb\u8005\u548c\u7f16\u8005\u81ea\u5df1\u5feb\u901f\u4e86\u89e3\u8be5\u7ae0\u8282\u7684\u6838\u5fc3\u5185\u5bb9\u548c\u8109\u7edc\u3002\u7f16\u5199\u5bfc\u8a00\u65f6\u53ef\u4ee5\u81ea\u5df1\u7ec4\u7ec7\u8bed\u8a00\uff0c\u4ee5\u7b80\u7ec3\u4e3a\u4e3b\uff0c\u4e0d\u9700\u8981\u9762\u9762\u4ff1\u5230\u3002</p> <p>\u201c\u7ae0\u8282\u7f16\u5199\u6307\u5bfc\u201d\u662f\u4e00\u4efd\u5199\u7ed9\u8be5\u8bb2\u4e49\u7684\u521b\u4f5c\u8005\u6240\u7528\u7684\u53c2\u8003\u6559\u7a0b\u3002\u5728\u63a5\u4e0b\u6765\u7684\u7f16\u5199\u4e2d\uff0c\u63a8\u8350\u5728\u672c\u5730\u4e5f\u5b89\u88c5\u4e00\u4e2a MkDocs \u6765\u5b9e\u65f6\u9884\u89c8\u9879\u76ee\u3002MkDocs \u57fa\u4e8e Python\uff0c\u6545\u53ef\u4ee5\u4f7f\u7528\u8bf8\u5982 <code>pip install mkdocs</code> \u7b49\u547d\u4ee4\u5b8c\u6210\u5b89\u88c5\u3002\u66f4\u5168\u9762\u7684\u5b89\u88c5\u6d41\u7a0b\u8bf7\u53c2\u8003 MkDocs \u5b98\u7f51\u5b89\u88c5\u8bf4\u660e \u5b9e\u73b0\u3002</p> <p>\u4f7f\u7528\u5f62\u5982 <code>!!! abstract \"\u5bfc\u8a00\"</code> \u7684\u65b9\u5f0f\u6dfb\u52a0\u4e00\u4e2a\u5bfc\u8a00\u6846\uff0c\u5e76\u5728\u4e0b\u9762\u82e5\u5e72\u884c\u901a\u8fc7\u7f29\u8fdb 1 \u4e2a\u5236\u8868\u7b26\u6216 4 \u4e2a\u7a7a\u683c\u7684\u65b9\u5f0f\u586b\u5199\u5bfc\u8a00\u91cc\u7684\u5185\u5bb9\uff0c\u884c\u4e0e\u884c\u4e4b\u95f4\u8bf7\u7a7a 1 \u884c\u3002</p> <p>Markdown \u683c\u5f0f\u6ce8\u610f\u4e8b\u9879</p> <p>\u76ee\u524d CI (GitHub Actions) \u5728\u90e8\u7f72\u6587\u6863\u65f6\uff0c\u989d\u5916\u6dfb\u52a0\u4e86\u4f7f\u7528 Prettier \u68c0\u67e5 Markdown \u98ce\u683c\u7684\u6b65\u9aa4\uff0c\u5982\u679c\u4e0d\u7b26\u5408\u8981\u6c42\uff0c\u4f60\u7684\u4fee\u6539\u4f1a\u88ab\u62d2\u7edd\u3002\u8bf7\u5728\u7f16\u8f91\u5b8c\u6210\u540e\u4f7f\u7528 Prettier \u68c0\u67e5\u5e76\u4fee\u590d Markdown \u683c\u5f0f\u3002</p> <p>\u53ef\u4ee5\u5728\u4ed3\u5e93\u6839\u76ee\u5f55\u4f7f\u7528 <code>npm install</code> \u5b89\u88c5 Prettier\uff0c\u4f7f\u7528 <code>npm run check</code> \u68c0\u67e5\u6587\u4ef6\u683c\u5f0f\uff0c\u4f7f\u7528 <code>npm run fix</code> \u4fee\u590d\u3002</p>"},{"location":"#main-content","title":"\u7ae0\u8282\u4e3b\u4f53\uff08\u4e3b\u4f53\u5185\u5bb9\u8bf7\u4ece h2 \u7b49\u7ea7\u4ee5\u4e0b\u6309\u5c42\u6b21\u7f16\u5199\u3002\uff09","text":"<p>\u7ae0\u8282\u91cc\u7684\u4e3b\u8981\u5185\u5bb9\u90fd\u5e94\u8be5\u5199\u5728\u4e3b\u4f53\u91cc\u3002\u4e3b\u4f53\u5305\u62ec\u6807\u9898\u548c\u6b63\u6587\uff1a\u6807\u9898\u90fd\u4ece h2 \u7b49\u7ea7\u4ee5\u4e0b\u6309\u5c42\u6b21\u7f16\u5199\uff0c\u800c\u6b63\u6587\u5219\u76f4\u63a5\u4f7f\u7528\u666e\u901a\u6587\u672c\u5373\u53ef\u3002</p> <p>\u4e3b\u4f53\u91cc\u5e94\u5f53\u5305\u62ec\u4e0e\u8be5\u7ae0\u8282\u4e3b\u9898\u76f8\u5173\u7684\u8be6\u7ec6\u5185\u5bb9\uff0c\u5177\u4f53\u5185\u5bb9\u4f9d\u8d56\u4e8e\u8bfe\u7eb2\u3002\u5efa\u8bae\u6bcf\u4e2a h2 \u7b49\u7ea7\u7684\u6807\u9898\u90fd\u5305\u542b\u4e00\u4e2a\u5b8c\u6574\u7684\u5b50\u6a21\u5757\uff0c\u4e0d\u540c\u7684 h2 \u5b50\u6a21\u5757\u7684\u5185\u5bb9\u5c3d\u53ef\u80fd\u6ca1\u6709\u5f3a\u70c8\u7684\u4f9d\u8d56\u3002\u8fd9\u4e2a\u6807\u51c6\u540c\u6837\u9002\u7528\u4e8e h3 \u53ca\u4ee5\u4e0b\u7684\u5b50\u6bb5\u843d\u3002</p> <p>\u6bcf\u4e00\u6bb5\u4e3b\u4f53\u5e94\u5f53\u6709\u5b8c\u6574\u7684\u5185\u5bb9\u3001\u6b63\u786e\u7684\u903b\u8f91\u548c\u901a\u987a\u7684\u6587\u5b57\u3002\u8bf7\u5c3d\u529b\u907f\u514d\u8bf8\u5982\u77e5\u8bc6\u70b9\u4f9d\u8d56\u94fe\u7f3a\u5931\u3001\u903b\u8f91\u9519\u8bef\u548c\u6587\u7b14\u96f6\u788e\u7b49\u5f71\u54cd\u8bfb\u8005\u9605\u8bfb\u4f53\u9a8c\u7684\u95ee\u9898\u3002\u5efa\u8bae\u6bcf\u6b21\u5199\u5b8c\u4ee5\u540e\u901a\u8fc7\u60f3\u8c61\u81ea\u5df1\u6b63\u662f\u8bfb\u8005\u8fdb\u884c\u9605\u8bfb\u7684\u65b9\u5f0f\u6765\u67e5\u6f0f\u8865\u7f3a\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u540c\u884c\u4ea4\u53c9\u5ba1\u9605\u7684\u65b9\u5f0f\u83b7\u53d6\u5b9d\u8d35\u7684\u5efa\u8bae\u3002</p>"},{"location":"#local-preview","title":"\u5728\u672c\u5730\u968f\u65f6\u9884\u89c8\u5f53\u524d\u4e3b\u9898\u4e0b\u7684\u683c\u5f0f","text":"<p>\u76ee\u524d\u5f53\u524d\u7684\u4e3b\u9898\u5df2\u7ecf\u786e\u5b9a\u4e3a Material\uff0c\u53ef\u4ee5\u4f7f\u7528\u8bf8\u5982 <code>pip install mkdocs-material</code> \u7b49\u547d\u4ee4\u5b8c\u6210\u4e3b\u9898\u7684\u5b89\u88c5\uff0c\u5e76\u5728\u5de5\u4f5c\u6839\u76ee\u5f55\u4e0b\u4f7f\u7528 <code>mkdocs serve</code> \u547d\u4ee4\u5e76\u8bbf\u95ee http://127.0.0.1:8000 \u6765\u5b9e\u65f6\u9884\u89c8\uff0c\u8fd9\u5bf9\u8bb2\u4e49\u7684\u7f16\u5199\u5341\u5206\u6709\u5e2e\u52a9\u3002</p> <p>\u66f4\u5168\u9762\u7684\u5b89\u88c5\u548c\u914d\u7f6e\u4fe1\u606f\u8bf7\u53c2\u8003 MkDocs \u5b98\u7f51 \u548c Material for MkDocs \u5b98\u7f51\u3002</p>"},{"location":"#use-admonitions","title":"\u5584\u7528\u63d0\u793a\u6846\u8ba9\u6b63\u6587\u4e3b\u6b21\u5206\u660e","text":"<p>\u901a\u5e38\u6765\u8bf4\uff0c\u4e3b\u4f53\u8981\u5305\u542b\u7684\u5185\u5bb9\u5982\u679c\u9700\u8981\u5199\u5f97\u5f88\u8be6\u5c3d\uff0c\u4e0d\u514d\u4f1a\u5e26\u6765\u4e3b\u6b21\u4e0d\u5206\u7684\u95ee\u9898\u3002\u56e0\u4e3a\u5f88\u591a\u77e5\u8bc6\u70b9\u7684\u7ed3\u6784\u5f88\u63a5\u8fd1\u6709\u5411\u65e0\u73af\u56fe\uff0c\u800c\u6587\u5b57\u6bd5\u7adf\u90fd\u662f\u7ebf\u6027\u7684\u3002\u975e\u8981\u8bf4\u4f7f\u7528\u62d3\u6251\u6392\u5e8f\u867d\u7136\u53ef\u4ee5\u4fdd\u8bc1\u4e0d\u4f1a\u51fa\u73b0\u77e5\u8bc6\u70b9\u4f9d\u8d56\u7f16\u5199\u98a0\u5012\u7684\u95ee\u9898\uff0c\u4f46\u4e5f\u96be\u4ee5\u8ba9\u8bfb\u8005\u5feb\u901f\u5206\u6790\u51fa\u4e3b\u5e72\u548c\u679d\u8282\u3002</p> <p>\u8bf7\u5584\u7528\u63d0\u793a\u6846\uff0c\u8ba9\u8bfb\u8005\u5bf9\u5185\u5bb9\u7684\u4e3b\u6b21\u3001\u6210\u5206\u4e00\u76ee\u4e86\u7136\uff0c\u4e5f\u80fd\u8ba9\u4f60\u7684\u4f5c\u54c1\u5c42\u6b21\u66f4\u52a0\u4e30\u5bcc\u3002</p> <p>\u91cd\u70b9</p> <p>\u5efa\u8bae\u7528\u8fd9\u79cd\u63d0\u793a\u6846\u6765\u5212\u51fa\u91cd\u8981\u7684\u77e5\u8bc6\u70b9\uff0c\u53ef\u4ee5\u662f\u4e00\u6bb5\u5185\u5bb9\u7684\u6838\u5fc3\u603b\u7ed3\u3002</p> <p>\u4f7f\u7528\u5f62\u5982 <code>!!! info \"\u91cd\u70b9\"</code> \u7684\u65b9\u5f0f\u6dfb\u52a0\u4e00\u4e2a\u91cd\u70b9\u6846\u3002</p> <p>\u8303\u4f8b</p> <p>\u5efa\u8bae\u7528\u8fd9\u79cd\u63d0\u793a\u6846\u6765\u5217\u51fa\u4e00\u4e2a\u8303\u4f8b\u3002</p> <p>\u4f7f\u7528\u5f62\u5982 <code>!!! example \"\u8303\u4f8b\"</code> \u7684\u65b9\u5f0f\u6dfb\u52a0\u4e00\u4e2a\u8303\u4f8b\u6846\u3002</p> <p>\u5c0f\u77e5\u8bc6</p> <p>\u5efa\u8bae\u7528\u8fd9\u79cd\u63d0\u793a\u6846\u6765\u5728\u4fdd\u7559\u6b63\u6587\u8fde\u8d2f\u6027\u7684\u540c\u65f6\u6dfb\u52a0\u7ec6\u679d\u672b\u8282\u7684\u77e5\u8bc6\u3002</p> <p>\u4f7f\u7528\u5f62\u5982 <code>!!! tip \"\u5c0f\u77e5\u8bc6\"</code> \u7684\u65b9\u5f0f\u6dfb\u52a0\u4e00\u4e2a\u5c0f\u77e5\u8bc6\u6846\u3002</p> <p>\u6ce8\u610f\uff1a\u8bf7\u52ff\u62fc\u5199\u4e3a tips\uff0c\u5426\u5219\u683c\u5f0f\u4f1a\u88ab\u8bc6\u522b\u4e3a\u63d0\u793a\uff08note\uff09\u6846\u3002</p> <p>\u8bf7\u5728\u63d0\u793a\u6846\u7684\u6807\u9898\u884c\u540e\u9762\u7559\u4e00\u4e2a\u7a7a\u884c</p> <p>\u7531\u4e8e Prettier \u7684\u89e3\u6790\u65b9\u5f0f\u95ee\u9898\uff0c\u8bf7\u5728\u6240\u6709\u63d0\u793a\u6846\u7684\u8d77\u59cb\u884c\u540e\u9762\u6dfb\u52a0\u4e00\u4e2a\u7a7a\u884c\uff0c\u4e0d\u8981\u50cf Material \u4e3b\u9898\u5b98\u7f51\u90a3\u6837\u6ca1\u6709\u7a7a\u884c\u76f4\u63a5\u5f00\u59cb\u63d0\u793a\u6846\u5185\u5bb9\u3002</p> <p> **\u9519\u8bef**\u683c\u5f0f\uff1a</p> <pre><code>!!! note\n    \u63d0\u793a\u6846\u5185\u5bb9\n</code></pre> <p> **\u6b63\u786e**\u683c\u5f0f\uff1a</p> <pre><code>!!! note\n\n    \u63d0\u793a\u6846\u5185\u5bb9\n</code></pre> <p>\u66f4\u591a\u79cd\u7c7b\u7684\u63d0\u793a\u6846\u8bf7\u53c2\u8003 \u63d0\u793a\u6846\u4e00\u89c8\u3002</p>"},{"location":"#heading-ids","title":"\u4e3a\u6807\u9898\u548c\u5c0f\u6807\u9898\u6dfb\u52a0 ID","text":"<p>\u7531\u4e8e\u6587\u7ae0\u7bc7\u76ee\u8f83\u957f\uff0c\u4f7f\u7528\u65f6\u4f1a\u7ecf\u5e38\u9047\u5230\u9700\u8981\u94fe\u63a5\u5230\u6587\u7ae0\u67d0\u4e00\u6bb5\u7684\u60c5\u51b5\u3002\u53d7\u9650\u4e8e MkDocs \u81ea\u52a8\u751f\u6210 Anchor ID \u7684\u529f\u80fd\uff08\u53ea\u652f\u6301\u82f1\u6587\u5b57\u7b26\uff09\uff0c\u7eaf\u4e2d\u6587\u7684\u6807\u9898\u4f1a\u5bfc\u81f4\u751f\u6210 <code>_1</code>, <code>_2</code> \u8fd9\u6837\u7684 ID\u3002\u4e00\u65b9\u9762\u8fd9\u6837\u7684 ID \u770b\u8d77\u6765\u4e0d\u76f4\u89c2\uff0c\u53e6\u4e00\u65b9\u9762\u6bcf\u5f53\u6807\u9898\u53d1\u751f\u589e\u51cf\u65f6\u8fd9\u4e9b ID \u90fd\u4f1a\u53d8\uff0c\u56e0\u6b64\u8bf7\u4e3a\u6bcf\u4e2a\u6807\u9898\u624b\u52a8\u6dfb\u52a0\u4e00\u4e2a\u6709\u610f\u4e49\u7684 ID\uff08\u6700\u5f00\u59cb\u7684\u6807\u9898 H1 \u9664\u5916\uff09\uff0c\u65b9\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>### \u4e3a\u6807\u9898\u548c\u5c0f\u6807\u9898\u6dfb\u52a0 ID {#heading-ids}\n</code></pre> <p>\u5efa\u8bae ID \u53ea\u5305\u542b\u5c0f\u5199\u5b57\u6bcd\u3001\u6570\u5b57\u548c\u6a2a\u7ebf <code>-</code>\uff0c\u5fc5\u8981\u65f6\u4f7f\u7528\u53e5\u70b9\uff08\u4e0d\u4f7f\u7528\u5927\u5199\u5b57\u6bcd\u548c\u5176\u4ed6\u6807\u70b9\u7b26\u53f7\uff09\u3002</p> <p>\u6ce8\u610f</p> <p><code>{#</code> **\u524d\u9762**\u9700\u8981\u6709\u4e00\u4e2a\u7a7a\u683c\uff0c\u5426\u5219\u4f60\u4f1a\u50cf\u4e0b\u9762\u8fd9\u4f4d\u540c\u5b66\u4e00\u6837\u7ffb\u8f66\uff1a</p> <p></p> <p>\u51fa\u4e8e\u98ce\u683c\u4e00\u81f4\u6027\u8003\u8651\uff0c\u8bf7\u4e0d\u8981\u5728 <code>{#</code> **\u540e\u9762**\u52a0\u7a7a\u683c\uff1a</p> <pre><code>\u2714 ### \u4e3a\u6807\u9898\u548c\u5c0f\u6807\u9898\u6dfb\u52a0 ID {#heading-ids}\n\u274c ### \u4e3a\u6807\u9898\u548c\u5c0f\u6807\u9898\u6dfb\u52a0 ID {# heading-ids}\n</code></pre> <p>\u6ce8\u610f 2</p> <p>\u8bf7\u4e0d\u8981\u5728\u6bcf\u9875\u6700\u5f00\u59cb\u7684\u6807\u9898\uff08\u552f\u4e00\u4e00\u4e2a H1\uff09\u540e\u6dfb\u52a0 <code>{#id-tag}</code>\uff0c\u5426\u5219\u53ef\u80fd\u4f1a\u51fa\u73b0\u4e00\u4e9b\u610f\u6599\u4e4b\u5916\u7684\u663e\u793a\u9519\u8bef\u3002</p>"},{"location":"#image-caption","title":"\u4e3a\u56fe\u7247\u6dfb\u52a0\u914d\u5b57","text":"<p>\u5728\u56fe\u7247\u4e0b\u65b9\u5199\u4e00\u884c\u6587\u5b57\u4f5c\u4e3a\u914d\u5b57\uff0c\u5e76\u5728\u8fd9\u884c\u5b57**\u7d27\u63a5\u7740\u7684\u4e0b\u4e00\u884c**\uff08\u4e0d\u80fd\u6709\u7a7a\u884c\uff09\u5199\u4e0a <code>{: .caption }</code>\uff0c\u8fd9\u6837\u914d\u7684\u8fd9\u884c\u5b57\u6e32\u67d3\u6210 HTML \u65f6\u5c31\u52a0\u4e0a\u4e86 <code>class=\"caption\"</code>\uff0c\u663e\u793a\u4e3a 0.94 \u500d\u7684\u5b57\u4f53\u3001\u7070\u8272\u3001\u8d34\u8fd1\u56fe\u7247\u3002</p> <pre><code>![image](url)\n\n\u56fe 1. \u8fd9\u5f20\u56fe\u7247\u7684\u4e00\u884c\u914d\u5b57\n{: .caption }\n</code></pre>"},{"location":"#extra-reading","title":"\u81ea\u4e3b\u9605\u8bfb\u8282 *","text":"<p>\u53ef\u4ee5\u5728\u7ae0\u8282\u4e3b\u4f53\u4e2d\u5305\u62ec\u82e5\u5e72\u81ea\u4e3b\u9605\u8bfb\u8282\uff0c\u539f\u5219\u4e0a\u8fd9\u4e00\u90e8\u5206\u7684\u7ed3\u6784\u4e0e\u5176\u5b83\u7ae0\u8282\u4e3b\u4f53\u5e76\u65e0\u4e0d\u540c\uff0c\u53ea\u662f\u4e0d\u4f1a\u5728\u8bfe\u5802\u4e0a\u8bb2\u6388\u3002</p> <p>\u5728\u6240\u6709\u81ea\u4e3b\u9605\u8bfb\u8282\u7684\u6807\u9898\u540e\u9762\u6253\u4e0a\u661f\u53f7 * \uff0c\u5e76\u5efa\u8bae\u5c3d\u53ef\u80fd\u653e\u5728\u540e\u9762\u3002</p>"},{"location":"#thinking-question","title":"\u601d\u8003\u9898","text":"<p>\u5efa\u8bae\u5728\u6bcf\u4e00\u7ae0\u540e\u8bbe\u8ba1\u82e5\u5e72\u601d\u8003\u9898\uff0c\u6765\u5e2e\u52a9\u8bfb\u8005\u6295\u5165\u5230\u4e00\u4e9b\u5b9e\u9645\u95ee\u9898\u7684\u601d\u8003\u4e2d\u3002\u597d\u7684\u601d\u8003\u9898\u63a8\u8350\u4ece\u5b9e\u9645\u9700\u6c42\u4e2d\u91c7\u96c6\u7075\u611f\uff0c\u5e76\u4e14\u62e5\u6709\u7b80\u5355\u7684\u9898\u5e72\u548c\u5178\u578b\u7684\u89e3\u51b3\u601d\u8def\u3002</p> <p>\u5982\u4f55\u5f97\u5230\u4ee3\u8868\u601d\u8003\u9898\u7684\u63d0\u793a\u6846\uff1f</p> <p>\u5efa\u8bae\u4f7f\u7528\u8fd9\u6837\u7684\u63d0\u793a\u6846\u53ef\u4ee5\u7528\u6765\u8868\u8fbe\u4e00\u4e2a\u601d\u8003\u9898\u3002</p> <p>\u56e0\u6b64\u4f7f\u7528\u4ec0\u4e48\u6837\u7684\u547d\u4ee4\u80fd\u751f\u6210\u8fd9\u6837\u7684\u63d0\u793a\u6846\u5462\uff1f\uff08\u8bf7\u53c2\u8003\u6e90\u7801\uff0c\u6216\u8005\u4e0a\u6587\u7ed9\u51fa\u7684\u63d0\u793a\u6846\u4e00\u89c8\u94fe\u63a5\u3002\uff09</p> <p>\u5efa\u8bae\u4e0d\u8981\u76f4\u63a5\u628a\u7b54\u6848\u653e\u5728\u6bcf\u4e2a\u95ee\u9898\u4e0b\u65b9\uff0c\u53ef\u4ee5\u4e13\u95e8\u7f16\u5199\u4e00\u4efd\u601d\u8003\u9898\u89e3\u7b54\u9875\u9762\u96c6\u4e2d\u653e\u7f6e\u3002</p>"},{"location":"#further-reading","title":"\u62d3\u5c55\u9605\u8bfb","text":"<p>Linux \u7684\u77e5\u8bc6\u7ed3\u6784\u5448\u975e\u7ebf\u6027\uff0c\u4ec5\u6709\u5355\u7ebf\u7684\u6b63\u6587\u662f\u4e0d\u8db3\u7684\u3002\u8bf7\u5e7f\u6cdb\u67e5\u9605\u4e0e\u672c\u7ae0\u76f8\u5173\u7684\u8d44\u6599\uff0c\u6839\u636e\u5b9e\u9645\u9700\u8981\u4e3a\u8bfb\u8005\u9002\u5f53\u89c4\u5212\u4e00\u4e9b\u4e0e\u672c\u7ae0\u76f8\u5173\u7684\u989d\u5916\u77e5\u8bc6\uff0c\u5e76\u968f\u9644\u4f18\u8d28\u7684\u6559\u7a0b\u3001\u767e\u79d1\u7b49\u8d44\u6e90\uff08\u5982\u6709\uff09\uff0c\u4f9b\u611f\u5174\u8da3\u7684\u8bfb\u8005\u8fdb\u4e00\u6b65\u9605\u8bfb\u3002\u62d3\u5c55\u9605\u8bfb\u653e\u7f6e\u5728\u4e0e\u6b63\u6587\u5e73\u7ea7\u7684 <code>supplement.md</code> \u4e2d\uff0c\u6bcf\u4e2a\u72ec\u7acb\u7684\u989d\u5916\u77e5\u8bc6\u70b9\u90fd\u662f\u4e00\u4e2a h2 \u7b49\u7ea7\u8282\u3002</p> <p>\u989d\u5916\u524d\u7f6e\u77e5\u8bc6\u8b66\u544a</p> <p>\u4e3a\u4e86\u4fdd\u8bc1\u7f16\u5199\u601d\u8def\u4e0d\u53d7\u9650\uff0c\u4ee5\u53ca\u9f13\u52b1\u8bfb\u8005\u591a\u591a\u81ea\u884c\u5b66\u4e60\uff0c\u62d3\u5c55\u9605\u8bfb\u53ef\u4ee5\u4f9d\u8d56\u540e\u7eed\u7ae0\u8282\u548c\u672c\u4e66\u89c4\u5212\u5185\u5bb9\u4ee5\u5916\u7684\u77e5\u8bc6\u3002\u5982\u679c\u5b58\u5728\u8fd9\u79cd\u60c5\u51b5\uff0c\u8bf7\u5728\u5bf9\u5e94\u7684\u8282\u6807\u9898\u4e0b\u9762\u7d27\u8ddf\u4e00\u4e2a\u8b66\u544a\u63d0\u793a\u6846\uff0c\u6307\u51fa\u6240\u4f9d\u8d56\u7684\u77e5\u8bc6\uff08\u4e66\u5185\u6216\u4e66\u5916\uff09\u3002\u8b66\u544a\u5f62\u5f0f\u5982\u4e0b\uff1a</p> <p>\u672c\u8282\u62d3\u5c55\u5185\u5bb9\u4f9d\u8d56\u5982\u4e0b\u989d\u5916\u7684\u524d\u7f6e\u77e5\u8bc6\uff0c\u5efa\u8bae\u5148\u9605\u8bfb\u5e76\u638c\u63e1\u5bf9\u5e94\u5185\u5bb9\u540e\u518d\u7814\u8bfb\u672c\u8282\uff1a</p> <ul> <li>\u7b2c\u4e00\u7ae0 \u4e2d\u79d1\u5927\u5f00\u6e90\u793e\u7fa4\uff1aLUG@USTC</li> <li>LUG@USTC \u5b98\u65b9\u7f51\u7ad9</li> </ul>"},{"location":"#reference-footnote","title":"\u5f15\u7528\u4e0e\u811a\u6ce8","text":"<p>\u811a\u6ce8\u7528\u4e8e\u5728\u6b63\u6587\u5c3e\u90e8\u6ce8\u660e\u4e00\u5c0f\u6bb5\u5185\u5bb9\u7684\u7684\u6765\u6e90\u5f15\u7528\u94fe\u63a5\u6216\u8005\u662f\u8fdb\u884c**\u4e0d\u91cd\u8981**\u7684\u8bf4\u660e\u30021\u56e0\u4e3a\u91cd\u8981\u7684\u8bf4\u660e\u6700\u597d\u76f4\u63a5\u8ddf\u5728\u540e\u9762\u89e3\u91ca\u6216\u8005\u5728\u6bb5\u843d\u540e\u9762\u7528\u63d0\u793a\u6846\uff0c\u4ee5\u514d\u7834\u574f\u8bfb\u8005\u9605\u8bfb\u7684\u8fde\u8d2f\u6027\u3002</p> <p>\u5f15\u7528\u6846\u5219\u7528\u4e8e\u5728\u6b63\u6587\u548c\u62d3\u5c55\u5185\u5bb9\u4e2d\u5f15\u7528\u4ed6\u4eba\u7684\u8a00\u8bba\u6216\u6307\u51fa\u5916\u94fe\u3002</p> <p>\u4e2d\u6587\u6587\u6848\u6392\u7248\u89c4\u8303</p> <p>\u8bf7\u53c2\u8003 \u8be5\u89c4\u8303 \u6765\u7edf\u4e00\u6700\u57fa\u672c\u7684\u4e2d\u82f1\u6587\u6392\u7248\u683c\u5f0f\u3002</p> <p>\u4f7f\u7528\u5f62\u5982 <code>!!! quote \"\u5c0f\u77e5\u8bc6\"</code> \u7684\u65b9\u5f0f\u6dfb\u52a0\u4e00\u4e2a\u5f15\u7528\u6846\u3002</p>"},{"location":"#blog","title":"Blog","text":"<ol> <li> <p>\u4e0d\u91cd\u8981\u7684\u8bf4\u660e\u5982\uff1a\u67d0\u4e9b\u540d\u8bcd\u7684\u6765\u5386\u3001\u89e3\u91ca\uff08\u7f29\u5199\u7684\uff09\u672f\u8bed\u3001\u4e00\u4e9b\u9898\u5916\u8f76\u4e8b\u548c\u63d2\u66f2\u7b49\u3002\u00a0\u21a9</p> </li> </ol>"},{"location":"Kubernetes/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Kubernetes%E5%85%A8%E6%A0%88%E6%9E%B6%E6%9E%84%E5%B8%88%E5%AE%9E%E6%88%98/","title":"Kubernetes\u5168\u6808\u67b6\u6784\u5e08\u5b9e\u6218","text":"<p>\u4e66\u7c4d\u5c01\u9762</p> <p></p>"},{"location":"Kubernetes/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Kubernetes%E5%85%A8%E6%A0%88%E6%9E%B6%E6%9E%84%E5%B8%88%E5%AE%9E%E6%88%98/#\u5185\u5bb9\u76ee\u5f55","title":"\u5185\u5bb9\u76ee\u5f55","text":""},{"location":"Kubernetes/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Kubernetes%E5%85%A8%E6%A0%88%E6%9E%B6%E6%9E%84%E5%B8%88%E5%AE%9E%E6%88%98/#1\u5b89\u88c5\u7bc7","title":"1.\u5b89\u88c5\u7bc7","text":"<p>1.Kubeadm\u5b89\u88c5\u9ad8\u53ef\u7528K8s\u96c6\u7fa4 </p> <p>2.\u4e8c\u8fdb\u5236\u5b89\u88c5\u9ad8\u53ef\u7528K8s\u96c6\u7fa4 </p>"},{"location":"Kubernetes/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Kubernetes%E5%85%A8%E6%A0%88%E6%9E%B6%E6%9E%84%E5%B8%88%E5%AE%9E%E6%88%98/#2\u57fa\u7840\u7bc7","title":"2.\u57fa\u7840\u7bc7","text":"<p>3.Docker\u57fa\u7840</p> <p>4.Kubernetes\u7684\u57fa\u7840\u6982\u5ff5</p> <p>5.Kubernetes\u8c03\u5ea6\u57fa\u7840</p> <p>6.Kubernetes\u670d\u52a1\u53d1\u5e03\u57fa\u7840</p> <p>7.Kubernetes\u914d\u7f6e\u7ba1\u7406</p>"},{"location":"Kubernetes/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Kubernetes%E5%85%A8%E6%A0%88%E6%9E%B6%E6%9E%84%E5%B8%88%E5%AE%9E%E6%88%98/#3-\u8fdb\u9636\u7bc7","title":"3. \u8fdb\u9636\u7bc7","text":"<p>8.Kubernetes\u5b58\u50a8\u5165\u95e8</p> <p>9.Kubernetes\u9ad8\u7ea7\u8c03\u5ea6</p>"},{"location":"Kubernetes/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Kubernetes%E5%85%A8%E6%A0%88%E6%9E%B6%E6%9E%84%E5%B8%88%E5%AE%9E%E6%88%98/#4\u9ad8\u7ea7\u7bc7","title":"4.\u9ad8\u7ea7\u7bc7","text":"<p>12.\u4e91\u539f\u751f\u5b58\u50a8Rook</p> <p>13.\u4e2d\u95f4\u4ef6\u5bb9\u5668\u5316</p>"},{"location":"Kubernetes/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Kubernetes%E5%85%A8%E6%A0%88%E6%9E%B6%E6%9E%84%E5%B8%88%E5%AE%9E%E6%88%98/#5-\u8fd0\u7ef4\u7bc7","title":"5. \u8fd0\u7ef4\u7bc7","text":""},{"location":"Kubernetes/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Kubernetes%E5%85%A8%E6%A0%88%E6%9E%B6%E6%9E%84%E5%B8%88%E5%AE%9E%E6%88%98/#6devops\u7bc7","title":"6.DevOps\u7bc7","text":"<p>\u672c\u6559\u7a0b\u4ece\u6982\u5ff5\u5230\u5b9e\u8df5\uff0c\u4ece\u624b\u5de5\u5230\u81ea\u52a8\u5316\uff0c\u5185\u5bb9\u7fd4\u5b9e\u4e14\u4e30\u5bcc\uff0c\u5176\u4e2d\u7684\u8303\u4f8b\u4e0e\u9879\u76ee\u5747\u5728\u5b9e\u8df5\u4e2d\u591a\u6b21\u9a8c\u8bc1\uff0c\u53ef\u76f4\u63a5\u7528\u4e8e\u751f\u4ea7\u73af\u5883\u3002</p> <p>\u672c\u4e66\u6559\u7a0b\u9002\u5408Kubernetes\u521d\u5b66\u8005\u3001\u5f00\u53d1\u4eba\u5458\u3001\u8fd0\u7ef4\u4eba\u5458\u3001\u67b6\u6784\u5e08\u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u57f9\u8bad\u673a\u6784\u548c\u5927\u4e13\u9662\u6821\u7684\u6559\u5b66\u7528\u4e66\u3002</p> <p>\u4ee3\u7801\u4ed3\u5e93\u5730\u5740</p> <p>https://github.com/dotbalo/kubernetes-guide</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/","title":"Kubeadm\u5b89\u88c5\u9ad8\u53ef\u7528\u96c6\u7fa4","text":"<p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e24\u79cd\u65b9\u5f0f\u5b89\u88c5K8s\u96c6\u7fa4\uff1aKubeadm\u65b9\u5f0f\u548c\u4e8c\u8fdb\u5236\u65b9\u5f0f\u3002</p> <p>Kubeadm\u662f\u4e00\u4e2a\u7b80\u5355\u6613\u7528\u7684\u5b89\u88c5\u5de5\u5177\uff0c\u53ef\u7528\u4e8e\u5feb\u901f\u642d\u5efaKubernetes\u96c6\u7fa4\uff0c\u76ee\u524d\u662f\u6bd4\u8f83\u65b9\u4fbf\u548c\u63a8\u8350\u7684\u65b9\u5f0f\u3002</p> <p>\u4e8c\u8fdb\u5236\u5b89\u88c5\u65b9\u5f0f\u8c03\u8bd5Bug\u6bd4\u8f83\u65b9\u4fbf\uff0c\u6709\u52a9\u4e8e\u6e05\u695a\u4e86\u89e3K8s\u7ec4\u4ef6\u7684\u539f\u7406\uff0c\u5bf9\u4e8e\u5168\u9762\u7406\u89e3Kubernetes\u4f1a\u6709\u5e2e\u52a9\u3002</p> <p>\u672c\u7ae0\u9996\u5148\u4ecb\u7ecd\u4f7f\u7528Kubeadm\u5b89\u88c5K8s\u96c6\u7fa4\u7684\u5177\u4f53\u65b9\u5f0f\u548c\u6b65\u9aa4\u3002\u672c\u7ae0\u7684\u5b89\u88c5\u5185\u5bb9\u5728Kubernetes 1.14\u4ee5\u4e0a\u7248\u672c\u5747\u53ef\u4f7f\u7528\uff0c\u672c\u4e66\u5b89\u88c5\u7684\u7248\u672c\u662f1.22\uff08\u672c\u4e66\u622a\u7a3f\u524d\u7684\u6700\u65b0\u7248\u672c\uff09\u3002</p> <p>\u5c31Kubeadm\u5404\u4e2a\u7248\u672c\u7684\u5b89\u88c5\u6765\u770b\uff0c\u57fa\u672c\u4e0a\u5927\u540c\u5c0f\u5f02\uff0c\u5b89\u88c5\u6b65\u9aa4\u6539\u52a8\u4e5f\u4e0d\u5927\uff0c\u57fa\u672c\u73af\u5883\u914d\u7f6e\u548c\u57fa\u672c\u7ec4\u4ef6\u5b89\u88c5\u7c7b\u4f3c\uff0c\u6bcf\u4e2a\u7248\u672c\u7684\u533a\u522b\u53ef\u80fd\u53ea\u662f\u96c6\u7fa4\u521d\u59cb\u5316\u4e0d\u540c\u3002</p> <p>\u76f8\u4fe1\u968f\u7740\u7248\u672c\u7684\u8fed\u4ee3\uff0c\u5b89\u88c5\u6b65\u9aa4\u4f1a\u53d8\u5f97\u66f4\u52a0\u7b80\u5355\u3001\u5feb\u6377\u3002\u9488\u5bf9\u4e0d\u540c\u7684\u7248\u672c\uff0c\u8bfb\u8005\u4e5f\u53ef\u4ee5\u53c2\u8003\u5b98\u7f51\u7684\u5b89\u88c5\u6b65\u9aa4\uff1a</p> <p>\u5229\u7528 kubeadm \u521b\u5efa\u9ad8\u53ef\u7528\u96c6\u7fa4</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#1-haproxykeepalived\u642d\u5efa\u9ad8\u53ef\u7528-kubernetes-\u96c6\u7fa4centos7","title":"1. Haproxy+Keepalived\u642d\u5efa\u9ad8\u53ef\u7528 Kubernetes \u96c6\u7fa4\uff08centos7\uff09","text":""},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#11-\u57fa\u672c\u73af\u5883\u914d\u7f6e","title":"1.1 \u57fa\u672c\u73af\u5883\u914d\u7f6e","text":"<p>\u8bfb\u8005\u9700\u81ea\u884c\u51c6\u5907</p> <ul> <li>3\u53f0\u6700\u4f4e2\u6838CPU\u548c4GB\u4ee5\u4e0a\u5185\u5b58\u7684\u670d\u52a1\u5668\uff0c\u7cfb\u7edf\u4e3aCentOS 7.x,\u5b89\u88c5master\u8282\u70b9</li> <li>1\u53f0\u6700\u4f4e4\u6838CPU\u548c8GB\u4ee5\u4e0a\u5185\u5b58\u7684\u670d\u52a1\u5668\uff0c\u7cfb\u7edf\u4e3aCentOS 7.x,\u5b89\u88c5node\u8282\u70b9</li> </ul> <p>\u5982\u679c\u6ca1\u6709\u8fd9\u4e48\u591a\u7684\u673a\u5668\uff0c\u53ef\u4ee5\u53ea\u5b89\u88c53\u53f0Master\u6216\u8005\u4e00\u53f0Master\u30011\u53f0Node\u3002</p> <p>\u96c6\u7fa4\u91c7\u7528\u7684\u670d\u52a1\u5668IP\u89c4\u5212\u5982\u88681.1\u6240\u793a\u3002</p> <p>\u88681.1\u3000\u9ad8\u53ef\u7528Kubernetes\u96c6\u7fa4\u89c4\u5212</p> \u4e3b\u673a\u540d IP\u5730\u5740 \u8bf4\u660e \u670d\u52a1\u5668\u914d\u7f6e k8s-master-01~03 192.168.1.190~192 master\u8282\u70b9*3 2c4g \u7cfb\u7edf\u76d8\uff1a40G  \u6570\u636e\u76d8\uff1a100G VIP 192.168.1.193 keeplived\u865a\u62dfIP k8s-node01~n 192.168.1.200 node\u8282\u70b9*n 4c8g 100G <p>Kubernetes\u4e00\u5171\u6d89\u53ca\u4e09\u4e2a\u7f51\u6bb5\uff0c\u4e00\u4e2a\u662f\u5bbf\u4e3b\u673a\u7684\u7f51\u6bb5\uff0c\u4e5f\u5c31\u662f\u4e0a\u8ff0\u7684192.168.1.x\uff0c\u540c\u65f6\u9700\u8981Pod\u548cService\u7684\u7f51\u6bb5\uff0c\u4e09\u8005\u7684\u7f51\u6bb5\u4e0d\u53ef\u4ea4\u53c9\u3002</p> <p>\u5b89\u88c5\u914d\u7f6e\u4fe1\u606f\u5982\u88681.2\u6240\u793a\u3002</p> \u914d\u7f6e\u4fe1\u606f \u5907\u6ce8 \u7cfb\u7edf\u7248\u672c Centos7.9 Docker\u7248\u672c 20.10.x Pod\u7f51\u6bb5 172.16.0.0/12 Service\u7f51\u6bb5 192.168.0.0/16 <p>\u6ce8\u610f</p> <p>\u5bbf\u4e3b\u673a\u7f51\u6bb5\u3001K8s Service\u7f51\u6bb5\u3001Pod\u7f51\u6bb5\u4e0d\u80fd\u91cd\u590d\u3002</p> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6e\u4e3b\u673a\u540d\uff08\u5176\u4ed6\u8282\u70b9\u540d\u79f0\u53ef\u81ea\u884c\u66f4\u6539\uff09\uff1a</p> <pre><code># hostnamectl set-hostname k8s-master01 &amp;&amp; eval -- bash\n# hostnamectl set-hostname k8s-master02 &amp;&amp; eval -- bash\n# hostnamectl set-hostname k8s-master03 &amp;&amp; eval -- bash\n# hostnamectl set-hostname k8s-node01 &amp;&amp; eval -- bash\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6ehosts\uff0c\u4fee\u6539/etc/hosts\u5982\u4e0b\uff1a</p> <pre><code># cat &gt;&gt;/etc/hosts&lt;&lt;'EOF'\n192.168.1.190 k8s-master01\n192.168.1.191 k8s-master02\n192.168.1.192 k8s-master03\n192.168.1.200 k8s-node01\nEOF\n</code></pre> <p>\u914d\u7f6e\u9759\u6001IP\u53c2\u8003</p> <pre><code># cat /etc/sysconfig/network-scripts/ifcfg-eth0\nTYPE=\"Ethernet\"\nPROXY_METHOD=\"none\"\nBROWSER_ONLY=\"no\"\nBOOTPROTO=\"static\"\nIPADDR=\"192.168.1.200\"\nPREFIX=\"24\"\nGATEWAY=\"192.168.1.1\"\nDNS1=\"192.168.1.60\"\nDNS2=\"114.114.114.114\"\nDEFROUTE=\"yes\"\nIPV4_FAILURE_FATAL=\"no\"\nIPV6INIT=\"yes\"\nIPV6_AUTOCONF=\"yes\"\nIPV6_DEFROUTE=\"yes\"\nIPV6_FAILURE_FATAL=\"no\"\nIPV6_ADDR_GEN_MODE=\"stable-privacy\"\nNAME=\"eth0\"\nDEVICE=\"eth0\"\nONBOOT=\"yes\"\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6eDocker\u3001Kubernetes\u548c\u9ed8\u8ba4yum\u6e90\uff1a</p> <pre><code># curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo\n# yum install -y yum-utils \\\ndevice-mapper-persistent-data \\\nlvm2\n\n# yum-config-manager \\\n--add-repo \\\nhttps://download.docker.com/linux/centos/docker-ce.repo\n\n# cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=0\nrepo_gpgcheck=0\ngpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg\n        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n\n# sed -i -e '/mirrors.cloud.aliyuncs.com/d' -e '/mirrors.aliyuncs.com/d' /etc/yum.repos.d/CentOS-Base.repo\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u5b89\u88c5\u4e00\u4e9b\u5e38\u7528\u7684\u5de5\u5177\uff1a</p> <pre><code># yum install wget jq psmisc vim net-tools telnet git -y\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u5173\u95ed\u9632\u706b\u5899\u3001SELinux\u3001DNSmasq\uff1a</p> <pre><code># systemctl disable --now firewalld\n# systemctl disable --now dnsmasq\n# systemctl disable --now NetworkManager\n# setenforce 0\n# sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/sysconfig/selinux\n# sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u5173\u95edSwap\u5206\u533a\uff1a</p> <pre><code># swapoff -a &amp;&amp; sysctl -w vm.swappiness=0\n# sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u5b89\u88c5ntpdate\uff08\u5982\u679c\u516c\u53f8\u7684\u670d\u52a1\u5668\u5df2\u7ecf\u914d\u7f6e\u4e86\u81ea\u52a8\u540c\u6b65\u65f6\u95f4\uff0c\u5173\u4e8e\u65f6\u95f4\u7684\u914d\u7f6e\u53ef\u4ee5\u4e0d\u7528\u64cd\u4f5c\uff09\uff1a</p> <pre><code># rpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm\n# yum install ntpdate -y\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u540c\u6b65\u65f6\u95f4\uff1a</p> <pre><code># ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime\n# echo 'Asia/Shanghai' &gt;/etc/timezone\n# hwclock --systohc\n# ntpdate time2.aliyun.com\n# yum install chrony -y\n# systemctl enable --now chronyd\n# chronyc sources\n210 Number of sources = 4\nMS Name/IP address         Stratum Poll Reach LastRx Last sample\n===============================================================================\n^+ sv1.ggsrv.de                  2   6    17    32   -823us[-1128us] +/-   98ms\n^- montreal.ca.logiplex.net      2   6    17    32    -17ms[  -17ms] +/-  179ms\n^- ntp6.flashdance.cx            2   6    17    32    -32ms[  -32ms] +/-  161ms\n^* 119.28.183.184                2   6    33    32   +661us[ +357us] +/-   38ms\n# date\nTue Aug 31 14:36:14 CST 2021\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6elimit\uff1a</p> <pre><code># ulimit -SHn 65535\n# cat &gt;&gt;/etc/security/limits.conf&lt;&lt;-'EOF'\n# \u672b\u5c3e\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\n* soft nofile 65536\n* hard nofile 131072\n* soft nproc 65535\n* hard nproc 655350\n* soft memlock unlimited\n* hard memlock unlimited\nEOF\n</code></pre> <p>\u5b89\u88c5\u8fc7\u7a0b\u4e2d\uff0c\u751f\u6210\u914d\u7f6e\u6587\u4ef6\u548c\u8bc1\u4e66\u5747\u5728Master01\u4e0a\u64cd\u4f5c\uff0c\u6240\u4ee5Master01\u8282\u70b9\u9700\u8981\u514d\u5bc6\u94a5\u767b\u5f55\u5176\u4ed6\u8282\u70b9\uff0c\u4e4b\u540e\u5c06\u6587\u4ef6\u4f20\u9001\u5230\u5176\u4ed6\u8282\u70b9\u3002</p> <p>\u96c6\u7fa4\u7ba1\u7406\u4e5f\u5728Master01\u4e0a\u64cd\u4f5c\uff08\u4e5f\u53ef\u4ee5\u662f\u5176\u4ed6\u5355\u72ec\u7684\u8282\u70b9\uff09\u3002</p> <p>\u914d\u7f6e\u5bc6\u94a5\uff08\u53ea\u5728Master01\u6216\u7ba1\u7406\u8282\u70b9\u64cd\u4f5c\uff0c\u4ee5\u4e0b\u6b65\u9aa4\u5c06\u7ba1\u7406\u8282\u70b9\u548cMaster01\u7edf\u79f0\u4e3aMaster01\uff09\uff1a</p> <pre><code># ssh-keygen -t rsa\n# for i in k8s-master01 k8s-master02 k8s-master03 k8s-node01;do ssh-copy-id -i .ssh/id_rsa.pub $i;done\n</code></pre> <p>Master01\u4e0b\u8f7d\u5b89\u88c5\u6240\u6709\u7684\u6e90\u7801\u6587\u4ef6\uff1a</p> <pre><code># cd /root/ ; git clone https://github.com/dotbalo/k8s-ha-install.git\n## github \u62c9\u53d6\u53d7\u7f51\u7edc\u9650\u5236\uff0c\u53ef\u4ee5\u4f7f\u7528gitee\u4ed3\u5e93\n# cd /root/; git clone https://gitee.com/hujianli94net/k8s-ha-install\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u5347\u7ea7\u7cfb\u7edf\uff1a</p> <pre><code># yum update -y\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#12-\u5185\u6838\u914d\u7f6e","title":"1.2 \u5185\u6838\u914d\u7f6e","text":"<p>\u4e3a\u4e86\u96c6\u7fa4\u7684\u7a33\u5b9a\u6027\u548c\u517c\u5bb9\u6027\uff0c\u751f\u4ea7\u73af\u5883\u7684\u5185\u6838\u6700\u597d\u5347\u7ea7\u52304.18\u7248\u672c\u4ee5\u4e0a\uff0c\u672c\u793a\u4f8b\u5c06\u5347\u7ea7\u52304.19\u7248\u672c\u3002</p> <p>\u79bb\u7ebf\u5347\u7ea7\u5185\u6838</p> <p>Master01\u4e0b\u8f7d\u79bb\u7ebf\u5305\uff1a</p> <pre><code># cd /root\n# wget -c http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm\n# wget -c http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm\n</code></pre> <p>\u5c06\u5b89\u88c5\u5305\u4eceMaster01\u8282\u70b9\u4f20\u5230\u5176\u4ed6\u8282\u70b9\uff1a</p> <pre><code># for i in k8s-master02 k8s-master03 k8s-node01;do scp kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm $i:/root/ ; done\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u5b89\u88c5\u5185\u6838\uff1a</p> <pre><code># cd /root &amp;&amp; yum localinstall -y kernel-ml*\n## \u6240\u6709\u8282\u70b9\u66f4\u6539\u5185\u6838\u542f\u52a8\u987a\u5e8f\n# grub2-set-default  0 &amp;&amp; grub2-mkconfig -o /etc/grub2.cfg\n# grubby --args=\"user_namespace.enable=1\" --update-kernel=\"$(grubby --default-kernel)\"\n# \u68c0\u67e5\u9ed8\u8ba4\u5185\u6838\u662f\u4e0d\u662f4.19\n[root@k8s-master02 ~]# grubby --default-kernel\n/boot/vmlinuz-4.19.12-1.el7.elrepo.x86_64\n\n# \u6240\u6709\u8282\u70b9\u91cd\u542f\uff0c\u7136\u540e\u68c0\u67e5\u5185\u6838\u662f\u4e0d\u662f4.19\n# reboot\n# uname -a\nLinux k8s-master02 4.19.12-1.el7.elrepo.x86_64 #1 SMP Fri Dec 21 11:06:36 EST 2018 x86_64 x86_64 x86_64 GNU/Linux\n</code></pre> <p>\u5728\u7ebf\u5347\u7ea7\u5185\u6838</p> <pre><code># upgrade Linux kernel\n# rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org\n# yum install -y https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm\n## \u5347\u7ea7\u5185\u6838\u4e2d\u9014\u4e0d\u8981\u968f\u610f\u4e2d\u65ad\uff0c\u9632\u6b62\u5347\u7ea7\u5931\u8d25\n# yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml -y\n# grub2-set-default 0 &amp;&amp; grub2-mkconfig -o /etc/grub2.cfg\n# reboot\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u5b89\u88c5ipvsadm\u548cipset\uff1a</p> <pre><code># yum install ipvsadm ipset sysstat conntrack libseccomp -y\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6eipvs\u6a21\u5757\uff0c\u5728\u5185\u68384.19+\u7248\u672cnf_conntrack_ipv4\u5df2\u7ecf\u6539\u4e3anf_conntrack\uff0c4.18\u4ee5\u4e0b\u7248\u672c\u4f7f\u7528nf_conntrack_ipv4\u5373\u53ef\uff1a</p> <pre><code># cat &gt;&gt; /etc/modules-load.d/ipvs.conf&lt;&lt;'EOF'\nip_vs\nip_vs_lc\nip_vs_wlc\nip_vs_rr\nip_vs_wrr\nip_vs_lblc\nip_vs_lblcr\nip_vs_dh\nip_vs_sh\nip_vs_fo\nip_vs_nq\nip_vs_sed\nip_vs_ftp\nip_vs_sh\nnf_conntrack\nip_tables\nip_set\nxt_set\nipt_set\nipt_rpfilter\nipt_REJECT\nipip\nEOF\n</code></pre> <p>\u7136\u540e\u6267\u884c</p> <pre><code># systemctl enable --now systemd-modules-load.service\n</code></pre> <p>\u5373\u53ef\u3002</p> <p>\u5f00\u542f\u4e00\u4e9bK8s\u96c6\u7fa4\u4e2d\u5fc5\u9700\u7684\u5185\u6838\u53c2\u6570\uff0c\u6240\u6709\u8282\u70b9\u914d\u7f6eK8s\u5185\u6838\uff1a</p> <pre><code># cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf\nnet.ipv4.ip_forward = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nfs.may_detach_mounts = 1\nnet.ipv4.conf.all.route_localnet = 1\nvm.overcommit_memory=1\nvm.panic_on_oom=0\nfs.inotify.max_user_watches=89100\nfs.file-max=52706963\nfs.nr_open=52706963\nnet.netfilter.nf_conntrack_max=2310720\nnet.ipv4.tcp_keepalive_time = 600\nnet.ipv4.tcp_keepalive_probes = 3\nnet.ipv4.tcp_keepalive_intvl =15\nnet.ipv4.tcp_max_tw_buckets = 36000\nnet.ipv4.tcp_tw_reuse = 1\nnet.ipv4.tcp_max_orphans = 327680\nnet.ipv4.tcp_orphan_retries = 3\nnet.ipv4.tcp_syncookies = 1\nnet.ipv4.tcp_max_syn_backlog = 16384\nnet.ipv4.ip_conntrack_max = 65536\nnet.ipv4.tcp_max_syn_backlog = 16384\nnet.ipv4.tcp_timestamps = 0\nnet.core.somaxconn = 16384\nEOF\n\n# sysctl --system\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6e\u5b8c\u5185\u6838\u540e\uff0c\u91cd\u542f\u670d\u52a1\u5668\uff0c\u4fdd\u8bc1\u91cd\u542f\u540e\u5185\u6838\u4f9d\u65e7\u52a0\u8f7d\uff1a</p> <pre><code># reboot\n# lsmod | grep --color=auto -e ip_vs -e nf_conntrack\nip_vs_ftp              16384  0\nnf_nat                 32768  1 ip_vs_ftp\nip_vs_sed              16384  0\nip_vs_nq               16384  0\nip_vs_fo               16384  0\nip_vs_sh               16384  0\nip_vs_dh               16384  0\nip_vs_lblcr            16384  0\nip_vs_lblc             16384  0\nip_vs_wrr              16384  0\nip_vs_rr               16384  0\nip_vs_wlc              16384  0\nip_vs_lc               16384  0\nip_vs                 151552  24 ip_vs_wlc,ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_fo,ip_vs_nq,ip_vs_lblc,ip_vs_wrr,ip_vs_lc,ip_vs_sed,ip_vs_ftp\nnf_conntrack          143360  2 nf_nat,ip_vs\nnf_defrag_ipv6         20480  1 nf_conntrack\nnf_defrag_ipv4         16384  1 nf_conntrack\nlibcrc32c              16384  3 nf_conntrack,nf_nat,ip_vs\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#13-k8s\u7ec4\u4ef6\u548cruntime\u5b89\u88c5","title":"1.3 K8s\u7ec4\u4ef6\u548cRuntime\u5b89\u88c5","text":"<p>\u672c\u8282\u4e3b\u8981\u5b89\u88c5\u7684\u662f\u96c6\u7fa4\u4e2d\u7528\u5230\u7684\u5404\u79cd\u7ec4\u4ef6\uff0c\u6bd4\u5982docker-ce\u3001containerd\u3001Kubernetes\u7ec4\u4ef6\u7b49\u3002</p> <p>\u4e66\u4e2d\u4e3a\u8bfb\u8005\u51c6\u5907\u4e86\u4e24\u79cdRuntime\uff08\u8fd0\u884c\u65f6\uff09\u7684\u5b89\u88c5\uff1a</p> <ul> <li> <p>Docker</p> </li> <li> <p>Containerd</p> </li> </ul> <p>\u6ce8\u610f</p> <p>\u5982\u679c\u8bfb\u8005\u5b89\u88c5\u7684Kubernetes\u7248\u672c\u9ad8\u4e8e1.24\uff08\u542b1.24\uff09\uff0c\u9700\u8981\u9009\u62e9Containerd\u4f5c\u4e3aRuntime\uff1b\u5982\u679c\u7248\u672c\u4f4e\u4e8e1.24\uff0cRuntime\u9009\u62e9Docker\u548cContainerd\u5747\u53ef\u3002</p> <p>docker\u548ccontainerd\u7684\u533a\u522b</p> <p>https://docs.youdianzhishi.com/k8s/runtime/overview/</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#131-containerd\u4f5c\u4e3aruntime","title":"1.3.1 Containerd\u4f5c\u4e3aRuntime","text":"<p>\u7531\u4e8eKubernetes 1.24\u4ee5\u4e0a\u7248\u672c\u5c06\u4e0d\u518d\u76f4\u63a5\u652f\u6301Docker\uff0c\u56e0\u6b64\u9700\u8981\u5c06Kubernetes\u7684Runtime\u6539\u4e3aContainerd\u3002\u56e0\u4e3a\u5b89\u88c5Docker\u65f6\u4f1a\u81ea\u52a8\u5b89\u88c5Containerd\uff0c\u5e76\u4e14\u540e\u9762\u7684\u8bfe\u7a0b\u4e5f\u8981\u4f7f\u7528\u5230Docker\uff0c\u6240\u4ee5\u8fd8\u662f\u5728\u6bcf\u4e2a\u8282\u70b9\u5b89\u88c5Docker\u3002</p> <p>\u6240\u6709\u8282\u70b9\u5b89\u88c5docker-ce-20.10\uff1a</p> <pre><code># yum install docker-ce-20.10.* docker-ce-cli-20.10.* -y\n</code></pre> <p>\u7531\u4e8e\u5e76\u4e0d\u662f\u6bcf\u4e2a\u8282\u70b9\u90fd\u9700\u8981Docker\u5f15\u64ce\uff0c\u56e0\u6b64\u65e0\u987b\u542f\u52a8Docker\uff0c\u53ea\u9700\u8981\u914d\u7f6e\u548c\u542f\u52a8Containerd\u5373\u53ef\u3002</p> <p>\u9996\u5148\u914d\u7f6eContainerd\u6240\u9700\u7684\u6a21\u5757\uff08\u6240\u6709\u8282\u70b9\uff09\uff1a</p> <pre><code># cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf\noverlay\nbr_netfilter\nEOF\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u52a0\u8f7d\u6a21\u5757\uff1a</p> <pre><code># modprobe -- overlay\n# modprobe -- br_netfilter\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6eContainerd\u6240\u9700\u7684\u5185\u6838\uff1a</p> <pre><code># cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.ipv4.ip_forward               = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nEOF\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u52a0\u8f7d\u5185\u6838\uff1a</p> <pre><code># sysctl --system\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6eContainerd\u7684\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code># mkdir -p /etc/containerd\n# containerd config default | tee /etc/containerd/config.toml\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u5c06Containerd\u7684Cgroup\u6539\u4e3aSystemd\uff1a</p> <pre><code># vim /etc/containerd/config.toml\n\u627e\u5230containerd.runtimes.runc.options\uff0c\u6dfb\u52a0SystemdCgroup = true\n\u6240\u6709\u8282\u70b9\u5c06sandbox_image\u7684Pause\u955c\u50cf\u6539\u6210\u7b26\u5408\u81ea\u5df1\u7248\u672c\u7684\u5730\u5740:registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u542f\u52a8Containerd\uff0c\u5e76\u914d\u7f6e\u5f00\u673a\u81ea\u542f\u52a8\uff1a</p> <pre><code># systemctl daemon-reload\n# systemctl enable --now containerd\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6ecrictl\u5ba2\u6237\u7aef\u8fde\u63a5\u7684Runtime\u4f4d\u7f6e\uff1a</p> <pre><code># cat &gt; /etc/crictl.yaml &lt;&lt;EOF\nruntime-endpoint: unix:///run/containerd/containerd.sock\nimage-endpoint: unix:///run/containerd/containerd.sock\ntimeout: 10\ndebug: false\nEOF\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#132-docker\u4f5c\u4e3aruntime","title":"1.3.2 Docker\u4f5c\u4e3aRuntime","text":"<p>\u5982\u679c\u8bfb\u8005\u9009\u62e9Docker\u4f5c\u4e3aRuntime\uff0c\u5b89\u88c5\u6b65\u9aa4\u8f83Containerd\u66f4\u4e3a\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5b89\u88c5\u5e76\u542f\u52a8\u5373\u53ef\u3002</p> <p>\u6240\u6709\u8282\u70b9\u5b89\u88c5docker-ce 20.10\uff1a</p> <pre><code># yum install docker-ce-20.10.* docker-ce-cli-20.10.* -y\n</code></pre> <p>\u7531\u4e8e\u65b0\u7248Kubelet\u5efa\u8bae\u4f7f\u7528systemd\uff0c\u56e0\u6b64\u628aDocker\u7684CgroupDriver\u4e5f\u6539\u6210systemd\uff1a</p> <pre><code># mkdir -p /etc/docker  # \u5982\u679c\u6ca1\u6709\u8fd9\u4e2a\u76ee\u5f55\u5148\u521b\u5efa\uff0c\u7136\u540e\u6dfb\u52a0 daemon.json \u6587\u4ef6\n# vi /etc/docker/daemon.json\n{\n\"exec-opts\": [\"native.cgroupdriver=systemd\"],\n  \"registry-mirrors\" : [\n\"https://ot2k4d59.mirror.aliyuncs.com/\"\n]\n}\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f\u52a8Docker\uff1a</p> <pre><code># systemctl daemon-reload &amp;&amp; systemctl enable --now docker\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#133-\u5b89\u88c5kubernetes\u7ec4\u4ef6","title":"1.3.3 \u5b89\u88c5Kubernetes\u7ec4\u4ef6","text":"<p>\u63a5\u4e0b\u6765\u5b89\u88c5Kubernetes\u7684\u7cfb\u7edf\u7ec4\u4ef6\u3002</p> <p>\u6240\u6709\u8282\u70b9\u6267\u884c</p> <pre><code># cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=0\nrepo_gpgcheck=0\ngpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg\n        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n</code></pre> <p>\u9996\u5148\u5728Master01\u8282\u70b9\u67e5\u770b\u6700\u65b0\u7684Kubernetes\u7248\u672c\u662f\u591a\u5c11\uff1a</p> <pre><code># yum list kubeadm.x86_64 --showduplicates | sort -r\n</code></pre> <p>\u5047\u5982\u8bfb\u8005\u770b\u5230\u76841.23.*\uff0c\u76f4\u63a5\u5b89\u88c51.23\u7248\u5373\u53ef\uff0c\u5982\u679c\u662f\u5176\u4ed6\u7248\u672c\uff0c\u5219\u76f4\u63a5\u5b89\u88c5\u6700\u65b0\u7248\u3002</p> <p>\u5982\u679c\u662f\u751f\u4ea7\u73af\u5883\uff0c\u5efa\u8bae\u5b89\u88c5\u7b2c\u4e09\u4e2a\u7248\u672c\u53f7\u5927\u4e8e5\u7684\u7248\u672c\uff0c\u6bd4\u59821.23.5\u3002</p> <p>\u5982\u679c\u6ca1\u67091.23.5\uff0c\u53ea\u67091.23.3\u7b49\uff0c\u53ef\u4ee5\u8003\u8651\u4f7f\u75281.22.5+\u7b49\u3002\u5f53\u7136\uff0c\u5982\u679c\u60f3\u8981\u4f7f\u7528\u6700\u65b0\u7684\u529f\u80fd\uff0c\u5b89\u88c51.23.3\u4e5f\u53ef\u4ee5\u3002</p> <pre><code>## # --disableexcludes \u7981\u6389\u9664\u4e86kubernetes\u4e4b\u5916\u7684\u522b\u7684\u4ed3\u5e93\n# yum install kubeadm-1.23.5 kubelet-1.23.5 kubectl-1.23.5 -y --disableexcludes=kubernetes\n</code></pre> <p>\u5f53\u7136\uff0c\u5982\u679c\u60f3\u8981\u4f7f\u7528\u6700\u65b0\u7684\u529f\u80fd\uff0c\u5b89\u88c51.23.3\u4e5f\u53ef\u4ee5\u3002</p> <p>\u6240\u6709\u8282\u70b9\u5b89\u88c51.25\u6700\u65b0\u7248\u672ckubeadm\u3001kubelet\u548ckubectl\uff1a</p> <pre><code># yum install kubeadm-1.25* kubelet-1.25* kubectl-1.25* -y --disableexcludes=kubernetes\n</code></pre> <p>\u66f4\u6539Kubelet\u7684\u914d\u7f6e\u4f7f\u7528Containerd\u4f5c\u4e3aRuntime\uff1a</p> <pre><code># cat &gt;/etc/sysconfig/kubelet&lt;&lt;EOF\nKUBELET_KUBEADM_ARGS=\"--container-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///run/containerd/containerd.sock\"\nEOF\n</code></pre> <p>\u6ce8\u610f \u5982\u679c\u8bfb\u8005\u4e0d\u662f\u91c7\u7528Containerd\u4f5c\u4e3aRuntime\uff0c\u4e0d\u9700\u8981\u6267\u884c\u4e0a\u8ff0\u547d\u4ee4\u3002</p> <p>\u6240\u6709\u8282\u70b9\u8bbe\u7f6eKubelet\u5f00\u673a\u81ea\u542f\u52a8\uff08\u7531\u4e8e\u8fd8\u672a\u521d\u59cb\u5316\uff0c\u6ca1\u6709Kubelet\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u6b64\u65f6Kubelet\u65e0\u6cd5\u542f\u52a8\uff0c\u65e0\u987b\u7ba1\u7406\uff09\uff1a</p> <pre><code># systemctl daemon-reload\n# systemctl enable --now kubelet\n</code></pre> <p>\u67e5\u770b\u7248\u672c\u4fe1\u606f</p> <pre><code># kubelet --version\nKubernetes v1.25.6\n\n# kubectl version\nWARNING: This version information is deprecated and will be replaced with the output from kubectl version --short.  Use --output=yaml|json to get the full version.\nClient Version: version.Info{Major:\"1\", Minor:\"25\", GitVersion:\"v1.25.6\", GitCommit:\"ff2c119726cc1f8926fb0585c74b25921e866a28\", GitTreeState:\"clean\", BuildDate:\"2023-01-18T19:22:09Z\", GoVersion:\"go1.19.5\", Compiler:\"gc\", Platform:\"linux/amd64\"}\nKustomize Version: v4.5.7\nThe connection to the server localhost:8080 was refused - did you specify the right host or port?\n\n# kubeadm version\nkubeadm version: &amp;version.Info{Major:\"1\", Minor:\"25\", GitVersion:\"v1.25.6\", GitCommit:\"ff2c119726cc1f8926fb0585c74b25921e866a28\", GitTreeState:\"clean\", BuildDate:\"2023-01-18T19:20:37Z\", GoVersion:\"go1.19.5\", Compiler:\"gc\", Platform:\"linux/amd64\"}\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#14-\u9ad8\u53ef\u7528\u7ec4\u4ef6\u5b89\u88c5","title":"1.4 \u9ad8\u53ef\u7528\u7ec4\u4ef6\u5b89\u88c5","text":"<p>\u672c\u4e66\u91c7\u7528KeepAlived\u548cHAProxy\u5b9e\u73b0\u9ad8\u53ef\u7528\uff0c\u6240\u4ee5\u9700\u8981\u5b89\u88c5KeepAlived\u548cHAProxy\u3002</p> <p>KeepAlived\u548cHAProxy\u7684\u8282\u70b9\u53ef\u4ee5\u548cMaster\u5728\u540c\u4e00\u4e2a\u8282\u70b9\uff0c\u4e5f\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u8282\u70b9\u3002</p> <p>\u5982\u679c\u8bfb\u8005\u662f\u5728\u516c\u6709\u4e91\u642d\u5efa\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0c\u53ef\u4ee5\u91c7\u7528\u516c\u6709\u4e91\u7684\u8d1f\u8f7d\u5747\u8861\u66ff\u4ee3KeepAlived\u548cHAProxy\u3002</p> <p>\u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4eec\u521b\u5efa2\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u865a\u62df\u673a\uff0c\u7136\u540e\u5206\u914d\u4e00\u4e2a VIP\uff0c\u7136\u540e\u4f7f\u7528 VIP \u4e3a\u8d1f\u8f7d\u5747\u8861\u5668\u63d0\u4f9b\u670d\u52a1\uff0c\u901a\u8fc7 VIP \u5c06\u6d41\u91cf\u91cd\u5b9a\u5411\u5230\u540e\u7aef\u7684\u67d0\u4e2a Kubernetes \u63a7\u5236\u5668\u5e73\u9762\u8282\u70b9\u4e0a\u3002</p> <p>\u63d0\u793a</p> <p>\u5982\u679c\u8bfb\u8005\u60f3\u8981\u642d\u5efa\u53ea\u6709\u4e00\u4e2aMaster\u8282\u70b9\u7684\u96c6\u7fa4\uff0c\u53ef\u4ee5\u4e0d\u5b89\u88c5\u9ad8\u53ef\u7528\u7ec4\u4ef6\u3002</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#141-\u5b89\u88c5haproxy\u548ckeepalived","title":"1.4.1 \u5b89\u88c5Haproxy\u548cKeepalived","text":"<p>\u6240\u6709Master\u8282\u70b9\u901a\u8fc7yum\u5b89\u88c5HAProxy\u548cKeepAlived\uff1a</p> <pre><code># yum install keepalived haproxy -y\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#142-haproxy\u914d\u7f6e","title":"1.4.2 Haproxy\u914d\u7f6e","text":"<p>\u6240\u6709Master\u8282\u70b9\u914d\u7f6eHAProxy\uff08\u8be6\u7ec6\u914d\u7f6e\u53ef\u53c2\u8003HAProxy\u5b98\u65b9\u6587\u6863\uff0c\u6240\u6709Master\u8282\u70b9\u7684HAProxy\u914d\u7f6e\u76f8\u540c\uff09\uff1a</p> <pre><code># cat &gt; /etc/haproxy/haproxy.cfg &lt;&lt; EOF\n#---------------------------------------------------------------------\n# Global settings\n#---------------------------------------------------------------------\nglobal\n    log         127.0.0.1 local2    chroot      /var/lib/haproxy\n    pidfile     /var/run/haproxy.pid\n    maxconn     4000\nuser        haproxy\n    group       haproxy\n    daemon stats socket /var/lib/haproxy/stats\ndefaults\n    mode                    http\n    log                     global\n    option                  httplog\n    option                  dontlognull\n    option http-server-close\n    option forwardfor       except 127.0.0.0/8\n    option                  redispatch\n    retries                 3\ntimeout http-request    10s\n    timeout queue           1m\n    timeout connect         10s\n    timeout client          1m\n    timeout server          1m\n    timeout http-keep-alive 10s\n    timeout check           10s\n    maxconn                 3000\n#---------------------------------------------------------------------\n# kubernetes apiserver frontend which proxys to the backends\n#--------------------------------------------------------------------- \nfrontend kubernetes-apiserver\n    mode                 tcp\n    bind                 *:16443\n    option               tcplog\n    default_backend      kubernetes-apiserver    #---------------------------------------------------------------------\n# round robin balancing between the various backends\n#---------------------------------------------------------------------\nbackend kubernetes-apiserver\n    mode        tcp\n    balance     roundrobin\n    server      master01.k8s.io   192.168.1.190:6443 check\n    server      master02.k8s.io   192.168.1.191:6443 check\n    server      master03.k8s.io   192.168.1.192:6443 check\n#---------------------------------------------------------------------\n# collection haproxy statistics message\n#---------------------------------------------------------------------\nlisten stats\n    bind                 *:1080\n    stats auth           admin:awesomePassword\n    stats refresh        5s\n    stats realm          HAProxy\\ Statistics\n    stats uri            /admin?stats\nEOF\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#143-keepalived\u914d\u7f6e","title":"1.4.3 Keepalived\u914d\u7f6e","text":"<p>\u6240\u6709Master\u8282\u70b9\u914d\u7f6eKeepAlived\uff0c\u7531\u4e8eKeepAlived\u9700\u8981\u914d\u7f6e\u81ea\u8eab\u7684IP\u5730\u5740\u548c\u7f51\u5361\u540d\u79f0\uff0c\u56e0\u6b64\u6bcf\u4e2aKeepAlived\u8282\u70b9\u7684\u914d\u7f6e\u4e0d\u4e00\u6837\u3002</p> <p>Master01\u8282\u70b9\u7684\u914d\u7f6e\uff08\u6ce8\u610f\u6bcf\u4e2a\u8282\u70b9\u7684IP\u548c\u7f51\u5361interface\u53c2\u6570\uff09\uff1a</p> <pre><code>Master01\u8282\u70b9\u7684\u914d\u7f6e\uff1a\n# vim /etc/keepalived/keepalived.conf \n! Configuration File for keepalived\nglobal_defs {\nrouter_id k8s\n    script_user root\n    enable_script_security\n}\nvrrp_script chk_apiserver {\nscript \"/etc/keepalived/check_apiserver.sh\"\ninterval 5\nweight -5\n    fall 2  rise 1\n}\nvrrp_instance VI_1 {\nstate MASTER\n    interface eth0\n    mcast_src_ip 192.168.1.190\n    virtual_router_id 99\npriority 101\nadvert_int 2\nauthentication {\nauth_type PASS\n        auth_pass ceb1b3ec013d66163d6ab\n    }\nvirtual_ipaddress {\n192.168.1.193\n    }\ntrack_script {\nchk_apiserver\n    }\n}\n</code></pre> <p>Master02\u8282\u70b9\u7684\u914d\u7f6e\uff08\u6ce8\u610f\u66f4\u6539\u52a0\u7c97\u90e8\u5206\u7684\u914d\u7f6e\uff09\uff1a</p> <pre><code># vim /etc/keepalived/keepalived.conf \n! Configuration File for keepalived\nglobal_defs {\nrouter_id k8s\n    script_user root\n    enable_script_security\n}\nvrrp_script chk_apiserver {\nscript \"/etc/keepalived/check_apiserver.sh\"\ninterval 5\nweight -5\n    fall 2  rise 1\n}\nvrrp_instance VI_1 {\nstate BACKUP\n    interface eth0\n    mcast_src_ip 192.168.1.191\n    virtual_router_id 99\npriority 100\nadvert_int 2\nauthentication {\nauth_type PASS\n        auth_pass ceb1b3ec013d66163d6ab\n    }\nvirtual_ipaddress {\n192.168.1.193\n    }\ntrack_script {\nchk_apiserver\n    }\n}\n</code></pre> <p>Master03\u8282\u70b9\u7684\u914d\u7f6e\uff08\u6ce8\u610f\u66f4\u6539\u52a0\u7c97\u90e8\u5206\u7684\u914d\u7f6e\uff09\uff1a</p> <pre><code># vim /etc/keepalived/keepalived.conf\n! Configuration File for keepalived\nglobal_defs {\nrouter_id k8s\n    script_user root\n    enable_script_security\n}\nvrrp_script chk_apiserver {\nscript \"/etc/keepalived/check_apiserver.sh\"\ninterval 5\nweight -5\n    fall 2  rise 1\n}\nvrrp_instance VI_1 {\nstate BACKUP\n    interface eth0\n    mcast_src_ip 192.168.1.192\n    virtual_router_id 99\npriority 100\nadvert_int 2\nauthentication {\nauth_type PASS\n        auth_pass ceb1b3ec013d66163d6ab\n    }\nvirtual_ipaddress {\n192.168.1.193\n    }\ntrack_script {\nchk_apiserver\n    }\n}\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#144-\u5065\u5eb7\u68c0\u67e5\u811a\u672c","title":"1.4.4 \u5065\u5eb7\u68c0\u67e5\u811a\u672c","text":"<p>\u6240\u6709Master\u8282\u70b9\u914d\u7f6eKeepAlived\u5065\u5eb7\u68c0\u67e5\u6587\u4ef6\uff1a</p> <pre><code>cat &gt;/etc/keepalived/check_apiserver.sh&lt;&lt;EOF\n#!/bin/bash\nerr=0\nfor k in $(seq 1 3)\ndo\n    check_code=$(pgrep haproxy)\n    if [[ $check_code == \"\" ]]; then\n        err=$(expr $err + 1)\n        sleep 1\n        continue\n    else\n        err=0\n        break\n    fi\ndone\nif [[ $err != \"0\" ]]; then\n    echo \"systemctl stop keepalived\"\n    /usr/bin/systemctl stop keepalived\n    exit 1\nelse\n    exit 0\nfi\nEOF\n# chmod +x /etc/keepalived/check_apiserver.sh\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#145-\u542f\u52a8","title":"1.4.5 \u542f\u52a8","text":"<p>\u542f\u52a8haproxy\u548ckeepalived\uff1a</p> <pre><code># systemctl daemon-reload\n# systemctl enable --now haproxy\n# systemctl enable --now keepalived\n</code></pre> <p>\u5982\u679c\u662f\u7528HAProxy\u548cKeepAlived\u5b9e\u73b0\u7684\u9ad8\u53ef\u7528\uff0c\u5219\u9700\u8981\u6d4b\u8bd5VIP\u662f\u5426\u662f\u6b63\u5e38\u7684\uff1a</p> <pre><code>## \u6240\u6709\u8282\u70b9\u8fdb\u884cping\u6d4b\u8bd5\n# ping 192.168.1.193 -c 4\nPING 192.168.1.193 (192.168.1.193) 56(84) bytes of data.\n64 bytes from 192.168.1.193: icmp_seq=1 ttl=64 time=0.120 ms\n64 bytes from 192.168.1.193: icmp_seq=2 ttl=64 time=0.061 ms\n64 bytes from 192.168.1.193: icmp_seq=3 ttl=64 time=0.043 ms\n64 bytes from 192.168.1.193: icmp_seq=4 ttl=64 time=0.047 ms\n--- 10.0.0.236 ping statistics ---\n4 packets transmitted, 4 received, 0% packet loss, time 3106ms\nrtt min/avg/max/mdev = 0.062/0.163/0.464/0.173 ms\n\n## \u6240\u6709\u8282\u70b9\u8fdb\u884ctelnet\u6d4b\u8bd5\n# telnet 192.168.1.193 16443\nTrying 10.0.0.236...\nConnected to 10.0.0.236.\nEscape character is '^]'.\nConnection closed by foreign host.\n</code></pre> <p>\u5982\u679cping\u4e0d\u901a\u4e14telnet\u6ca1\u6709\u51fa\u73b0\uff0c\u5219\u8ba4\u4e3aVIP\u4e0d\u53ef\u7528\u3002</p> <p>\u5982\u679cVIP\u4e0d\u53ef\u7528\uff0c\u4e0d\u53ef\u518d\u7ee7\u7eed\u5f80\u4e0b\u6267\u884c\uff0c\u9700\u8981\u6392\u67e5VIP\u7684\u95ee\u9898\uff0c\u6bd4\u5982\u9632\u706b\u5899\u548cSELinux\u3001HAProxy\u548cKeepalived\u7684\u72b6\u6001\uff0c\u76d1\u542c\u7aef\u53e3\u662f\u5426\u6b63\u5e38\u7b49\u3002</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#15-\u96c6\u7fa4\u521d\u59cb\u5316","title":"1.5 \u96c6\u7fa4\u521d\u59cb\u5316","text":"<p>\u4f7f\u7528Kubeadm\u5b89\u88c5\u96c6\u7fa4\u65f6\uff0c\u9700\u8981\u4e00\u4e2aMaster\u8282\u70b9\u521d\u59cb\u5316\u96c6\u7fa4\uff0c\u7136\u540e\u52a0\u5165\u5176\u4ed6\u8282\u70b9\u5373\u53ef\u3002</p> <p>\u521d\u59cb\u5316\u96c6\u7fa4\u65f6\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528Kubeadm\u547d\u4ee4\u8fdb\u884c\u521d\u59cb\u5316\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u521d\u59cb\u5316\uff0c\u7531\u4e8e\u4f7f\u7528\u547d\u4ee4\u884c\u7684\u5f62\u5f0f\u53ef\u80fd\u9700\u8981\u914d\u7f6e\u7684\u5b57\u6bb5\u6bd4\u8f83\u591a\uff0c\u56e0\u6b64\u672c\u793a\u4f8b\u91c7\u7528\u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u521d\u59cb\u5316\u3002</p> <p>\u6ce8\u610f</p> <p>\u9996\u5148\u521b\u5efa\u7684\u662fkubeadm\u914d\u7f6e\u6587\u4ef6\uff0c\u5bbf\u4e3b\u673a\u7f51\u6bb5\u3001podSubnet\u7f51\u6bb5\u3001serviceSubnet\u7f51\u6bb5\u4e0d\u80fd\u91cd\u590d\uff1b</p> <p>\u5176\u6b21\uff0ckubernetesVersion\u7684\u503c\u6539\u4e3a\u548c\u8bfb\u8005\u73af\u5883Kubeadm\u7248\u672c\u4e00\u81f4\uff0c\u53ef\u4ee5\u901a\u8fc7kubeadm version\u547d\u4ee4\u67e5\u8be2\uff1b</p> <p>\u6700\u540e\uff0c\u5982\u679c\u4e0d\u662f\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0ccontrolPlaneEndpoint\u9700\u8981\u6539\u4e3aMaster\u8282\u70b9\u7684IP\u548c6443\u7aef\u53e3\uff0ccertSANs\u4e5f\u9700\u8981\u6539\u4e3aMaster\u8282\u70b9\u7684IP\u3002</p> <p>\u6ce8\u610fcriSocket\u66f4\u6539\u4e3a\u81ea\u5df1\u7684Runtime\u3002</p> <p>Master01\u8282\u70b9\u521b\u5efakubeadm-config.yaml\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\uff08\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u81ea\u52a8\u751f\u6210<code>kubeadm config print init-defaults &gt; kubeadm-config.yaml</code>\uff09\uff1a</p> <p><code>kubeadm-config.yaml</code></p> <pre><code>apiVersion: kubeadm.k8s.io/v1beta3\nbootstrapTokens:\n- groups:\n- system:bootstrappers:kubeadm:default-node-token\ntoken: abcdef.0123456789abcdef\nttl: 24h0m0s\nusages:\n- signing\n- authentication\nkind: InitConfiguration\nlocalAPIEndpoint:\nadvertiseAddress: 192.168.1.190\nbindPort: 6443\nnodeRegistration:\ncriSocket: unix:///var/run/containerd/containerd.sock\nimagePullPolicy: IfNotPresent\nname: k8s-master01\ntaints:\n- effect: NoSchedule\nkey: node-role.kubernetes.io/master\n---\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nkind: KubeProxyConfiguration\nmode: ipvs      # kube-proxy \u6a21\u5f0f\n---\napiServer:\ncertSANs:\n- 192.168.1.193\ntimeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta3\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrolPlaneEndpoint: 192.168.1.193:6443\ncontrollerManager: {}\ndns: {}\netcd:\nlocal:\ndataDir: /var/lib/etcd\nimageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers\nkind: ClusterConfiguration\nkubernetesVersion: v1.25.6  # \u66f4\u6539\u6b64\u5904\u7684\u7248\u672c\u53f7\u548ckubeadm version\u4e00\u81f4\nnetworking:\ndnsDomain: cluster.local\npodSubnet: 172.16.0.0/12\nserviceSubnet: 192.168.0.0/16\nscheduler: {}\n</code></pre> <p>\u7531\u4e8e\u8bfb\u8005\u7684\u7248\u672c\u548c\u6b64\u793a\u4f8b\u53ef\u80fd\u4e0d\u592a\u4e00\u81f4\uff0c\u56e0\u6b64\u9700\u8981\u66f4\u65b0\u4e00\u4e0bkubeadm\u914d\u7f6e\u6587\u4ef6\uff08Master01\u8282\u70b9\u64cd\u4f5c\uff09\uff1a</p> <pre><code># kubeadm config migrate --old-config kubeadm-config.yaml --new-config new.yaml\n</code></pre> <p>\u5c06new.yaml\u6587\u4ef6\u590d\u5236\u5230\u5176\u4ed6Master\u8282\u70b9\uff1a</p> <pre><code># for i in k8s-master02 k8s-master03; do scp new.yaml $i:/root/; done\n</code></pre> <p>\u4e4b\u540e\u6240\u6709Master\u8282\u70b9\u63d0\u524d\u4e0b\u8f7d\u955c\u50cf\uff0c\u53ef\u4ee5\u8282\u7701\u521d\u59cb\u5316\u65f6\u95f4\uff08\u5176\u4ed6\u8282\u70b9\u4e0d\u9700\u8981\u66f4\u6539\u4efb\u4f55\u914d\u7f6e\uff0c\u5305\u62ecIP\u5730\u5740\u4e5f\u4e0d\u9700\u8981\u66f4\u6539\uff09\uff1a</p> <pre><code># kubeadm config images pull --config /root/new.yaml \n[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.25.0\n[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.25.0\n[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.25.0\n[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.25.0\n[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.8\n[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.6-0\n[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.9.3\n</code></pre> <p>\u521d\u59cb\u5316Master01\u8282\u70b9\uff0c\u521d\u59cb\u5316\u4ee5\u540e\u4f1a\u5728/etc/kubernetes\u76ee\u5f55\u4e0b\u751f\u6210\u5bf9\u5e94\u7684\u8bc1\u4e66\u548c\u914d\u7f6e\u6587\u4ef6\uff0c\u4e4b\u540e\u5176\u4ed6Master\u8282\u70b9\u52a0\u5165Master01\u5373\u53ef\uff1a</p> <pre><code># kubeadm init --upload-certs --config /root/new.yaml\n</code></pre> <p>\u521d\u59cb\u5316\u6210\u529f\u4ee5\u540e\uff0c\u4f1a\u4ea7\u751fToken\u503c\uff0c\u7528\u4e8e\u5176\u4ed6\u8282\u70b9\u52a0\u5165\u65f6\u4f7f\u7528\uff0c\u56e0\u6b64\u8981\u8bb0\u5f55\u4e00\u4e0b\u521d\u59cb\u5316\u6210\u529f\u751f\u6210\u7684token\u503c\uff08\u4ee4\u724c\u503c\uff09\uff1a</p> <pre><code>Your Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\nmkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nAlternatively, if you are the root user, you can run:\n\nexport KUBECONFIG=/etc/kubernetes/admin.conf\n\nYou should now deploy a pod network to the cluster.\nRun \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nYou can now join any number of the control-plane node running the following command on each as root:\n\nkubeadm join 192.168.1.193:16443 --token abcdef.0123456789abcdef \\\n--discovery-token-ca-cert-hash sha256:4967912ebd27dc2541b108fcf80f8c0310e83cf24a79361f56c89aefdb0c2043 \\\n--control-plane --certificate-key 00523d224310fbab1f4feb18e8a9376087ed4cec14634b733c5ff037fdacc4e0\n\nPlease note that the certificate-key gives access to cluster sensitive data, keep it secret!\nAs a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use\n\"kubeadm init phase upload-certs --upload-certs\" to reload certs afterward.\n\nThen you can join any number of worker nodes by running the following on each as root:\nkubeadm join 192.168.1.193:16443 --token abcdef.0123456789abcdef \\\n--discovery-token-ca-cert-hash sha256:4967912ebd27dc2541b108fcf80f8c0310e83cf24a79361f56c89aefdb0c2043\n\n# \u68c0\u67e5\u7f51\u7edc\u662f\u5426\u751f\u6548\n# kubectl cluster-info dump | grep -m 1 cluster-cidr\n\"--cluster-cidr=172.16.0.0/12\"\n# mkdir -p $HOME/.kube\n# sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n# sudo chown $(id -u):$(id -g) $HOME/.kube/config\n</code></pre> <p>\u5982\u679c\u521d\u59cb\u5316\u5931\u8d25\uff0c\u9700\u8981\u68c0\u67e5\u5404\u9879\u914d\u7f6e\u662f\u5426\u6b63\u786e\uff0c\u4e4b\u540e\u518d\u6b21\u521d\u59cb\u5316\uff0c\u6e05\u7406\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code># kubeadm reset -f ; ipvsadm --clear  ; rm -rf ~/.kube\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#151-\u914d\u7f6ekubectl","title":"1.5.1 \u914d\u7f6ekubectl","text":"<p>\u521d\u59cb\u5316\u6210\u529f\u540e\uff0cMaster01\u8282\u70b9\u914d\u7f6eKUBECONFIG\u73af\u5883\u53d8\u91cf\uff0c\u4e4b\u540eKubectl\u5373\u53ef\u8bbf\u95eeKubernetes\u96c6\u7fa4\uff1a</p> <pre><code># \u8bbe\u7f6eKubectl \u81ea\u52a8\u8865\u5168\nyum install bash-completion -y\nsource &lt;(kubectl completion bash) # \u5728 bash \u4e2d\u8bbe\u7f6e\u5f53\u524d shell \u7684\u81ea\u52a8\u8865\u5168\uff0c\u8981\u5148\u5b89\u88c5 bash-completion \u5305\u3002\necho \"source &lt;(kubectl completion bash)\" &gt;&gt; ~/.bashrc # \u5728\u4f60\u7684 bash shell \u4e2d\u6c38\u4e45\u5730\u6dfb\u52a0\u81ea\u52a8\u8865\u5168\nkubectl completion bash &gt;/etc/bash_completion.d/kubectl\n\n# cat &lt;&lt;EOF &gt;&gt; /root/.bashrc\nexport KUBECONFIG=/etc/kubernetes/admin.conf\necho 'alias k=kubectl'\necho 'complete -F __start_kubectl k'\nEOF\nsource /root/.bashrc\n</code></pre> <p>\u67e5\u770b\u8282\u70b9\u72b6\u6001</p> <pre><code># kubectl get node\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#152-\u914d\u7f6ehelm","title":"1.5.2 \u914d\u7f6ehelm","text":"<pre><code>$ wget https://mirrors.huaweicloud.com/helm/v3.7.2/helm-v3.7.2-linux-amd64.tar.gz\n$ tar -zxvf helm-v3.7.2-linux-amd64.tar.gz $ cp linux-amd64/helm /usr/local/bin/\n$ chmod a+x  /usr/local/bin/helm\n\n#\u67e5\u770b\u7248\u672c\n$ helm version\nversion.BuildInfo{Version:\"v3.7.2\", GitCommit:\"663a896f4a815053445eec4153677ddc24a0a361\", GitTreeState:\"clean\", GoVersion:\"go1.16.10\"}\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#16-master\u5b9e\u73b0\u9ad8\u53ef\u7528","title":"1.6 Master\u5b9e\u73b0\u9ad8\u53ef\u7528","text":"<p>\u5176\u4ed6Master\u8282\u70b9\u548cNode\u8282\u70b9\u52a0\u5165\u96c6\u7fa4\uff0c\u65b9\u6cd5\u662f\u4e00\u81f4\u7684\uff0c\u53ea\u4e0d\u8fc7Master\u8282\u70b9\u52a0\u5165\u96c6\u7fa4\u65f6\u9700\u8981\u6307\u5b9a--control-plane\u548c--certificate-key\u53c2\u6570\u3002</p> <p>\u5c06Master02\u548cMaster03\u52a0\u5165\u96c6\u7fa4\uff0c\u4e24\u4e2a\u8282\u70b9\u5206\u522b\u6267\u884c\uff1a</p> <pre><code>  kubeadm join 192.168.1.193:16443 --token abcdef.0123456789abcdef \\\n--discovery-token-ca-cert-hash sha256:4967912ebd27dc2541b108fcf80f8c0310e83cf24a79361f56c89aefdb0c2043 \\\n--control-plane --certificate-key 00523d224310fbab1f4feb18e8a9376087ed4cec14634b733c5ff037fdacc4e0\n</code></pre> <p>3\u4e2aMaster\u8282\u70b9\u52a0\u5165\u540e\uff0c\u53ef\u4ee5\u67e5\u770b\u6b64\u65f6\u7684\u8282\u70b9\u72b6\u6001</p> <pre><code># kubectl get node\nUnable to connect to the server: net/http: TLS handshake timeout\n[root@k8s-master01 ~]# kubectl  get nodes\nNAME           STATUS     ROLES           AGE     VERSION\nk8s-master01   NotReady   control-plane   5m21s   v1.25.6\nk8s-master02   NotReady   control-plane   20s     v1.25.6\nk8s-master03   NotReady   control-plane   88s     v1.25.6\nk8s-node01     NotReady   &lt;none&gt;          2m3s    v1.25.6\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#17-\u6dfb\u52a0worker\u8282\u70b9","title":"1.7 \u6dfb\u52a0Worker\u8282\u70b9","text":"<pre><code>kubeadm join 192.168.1.193:16443 --token abcdef.0123456789abcdef \\\n--discovery-token-ca-cert-hash sha256:4967912ebd27dc2541b108fcf80f8c0310e83cf24a79361f56c89aefdb0c2043\n</code></pre> <p>\u63d0\u793a</p> <p>\u6240\u6709\u8282\u70b9\u52a0\u5165\u540e\uff0c\u8282\u70b9\u7684STATUS\u5b57\u6bb5\u4e3aNotReady\uff0c\u7531\u4e8e\u7248\u672c\u4e0d\u540c\uff0c\u663e\u793a\u7684\u7ed3\u679c\u53ef\u80fd\u4e5f\u4e0d\u540c\uff0c\u5982\u679c\u662fNotReady\uff0c\u5b89\u88c5\u5b8cCNI\u5373\u53ef\u53d8\u6210Ready\u72b6\u6001\u3002</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#18-token\u8fc7\u671f\u5904\u7406","title":"1.8 Token\u8fc7\u671f\u5904\u7406","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u65b0\u5efa\u7684\u96c6\u7fa4Token\u6709\u6548\u671f\u662f24\u5c0f\u65f6\uff0c\u5982\u679c\u8fc7\u671f\u7684\u8bdd\uff0c\u9700\u8981\u91cd\u65b0\u751f\u6210Token\uff0c\u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u751f\u6210\uff1a</p> <pre><code># kubeadm token create --print-join-command\n</code></pre> <p>\u5982\u679c\u9700\u8981\u6dfb\u52a0Master\uff0ccertificate-key\u4e5f\u9700\u8981\u91cd\u65b0\u751f\u6210\uff1a</p> <pre><code># kubeadm init phase upload-certs  --upload-certs\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#19-calico\u7ec4\u4ef6\u7684\u5b89\u88c5","title":"1.9 Calico\u7ec4\u4ef6\u7684\u5b89\u88c5","text":"<p>\u63a5\u4e0b\u6765\u5b89\u88c5CNI\u63d2\u4ef6\uff0cCNI\u63d2\u4ef6\u53ef\u4ee5\u9009\u62e9Calico\u6216\u8005Flannel\u7b49\u3002</p> <p>\u7531\u4e8e\u672c\u4e66\u540e\u671f\u6d89\u53ca\u7f51\u7edc\u7b56\u7565\uff08NetworkPolicy\uff09\u7684\u5b66\u4e60\uff0c\u9700\u8981CNI\u63d2\u4ef6\u652f\u6301NetworkPolicy\uff0c\u56e0\u6b64\u672c\u6b21\u5b89\u88c5\u7684\u662fCalico\uff08Flannel\u6682\u4e0d\u652f\u6301\uff09\u3002</p> <p>\u5728Master01\u8282\u70b9\u5b89\u88c5Calico\uff08\u6ce8\u610f\u5176\u4e2d1.23\u7684\u7248\u672c\u53f7\u9700\u8981\u6539\u6210\u8bfb\u8005\u4f7f\u7528\u7684\u7248\u672c\u53f7\uff09\uff1a</p> <pre><code># cd /root/k8s-ha-install &amp;&amp; git checkout manual-installation-v1.25.x &amp;&amp; cd calico/\n</code></pre> <p>\u4fee\u6539Pod\u7f51\u6bb5\uff1a</p> <pre><code># POD_SUBNET=`cat /etc/kubernetes/manifests/kube-controller-manager.yaml | grep cluster-cidr= | awk -F= '{print $NF}'`\n# sed -i \"s#POD_CIDR#${POD_SUBNET}#g\" calico.yaml\n# kubectl apply -f calico.yaml\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u7b49\u5f85\u51e0\u5206\u949f\u540e\u67e5\u770b\u72b6\u6001\uff1a</p> <pre><code># kubectl get pod -n kube-system\nNAME                                       READY   STATUS    RESTARTS   AGE\ncalico-kube-controllers-86d8c4fb68-4wk7q   1/1     Running   0          3m50s\ncalico-node-8cqhj                          1/1     Running   0          3m50s\ncalico-node-9dq92                          1/1     Running   0          3m50s\ncalico-node-dw6tq                          1/1     Running   0          3m50s\ncalico-node-g94pp                          1/1     Running   0          3m50s\ncalico-typha-768795f74d-clpvm              1/1     Running   0          3m49s\ncoredns-7f8cbcb969-f7chc                   1/1     Running   0          10m\ncoredns-7f8cbcb969-fv9fv                   1/1     Running   0          10m\netcd-k8s-master01                          1/1     Running   0          11m\netcd-k8s-master02                          1/1     Running   0          6m\netcd-k8s-master03                          1/1     Running   0          7m7s\nkube-apiserver-k8s-master01                1/1     Running   0          11m\nkube-apiserver-k8s-master02                1/1     Running   0          5m48s\nkube-apiserver-k8s-master03                1/1     Running   0          7m\nkube-controller-manager-k8s-master01       1/1     Running   0          11m\nkube-controller-manager-k8s-master02       1/1     Running   0          6m2s\nkube-controller-manager-k8s-master03       1/1     Running   0          5m54s\nkube-proxy-jcm25                           1/1     Running   0          6m10s\nkube-proxy-q8msx                           1/1     Running   0          10m\nkube-proxy-rtwdz                           1/1     Running   0          7m53s\nkube-proxy-s2xvg                           1/1     Running   0          7m18s\nkube-scheduler-k8s-master01                1/1     Running   0          11m\nkube-scheduler-k8s-master02                1/1     Running   0          5m59s\nkube-scheduler-k8s-master03                1/1     Running   0          7m6s\n\n# kubectl  get nodes\nNAME           STATUS   ROLES           AGE     VERSION\nk8s-master01   Ready    control-plane   11m     v1.25.6\nk8s-master02   Ready    control-plane   6m25s   v1.25.6\nk8s-master03   Ready    control-plane   7m33s   v1.25.6\nk8s-node01     Ready    &lt;none&gt;          8m8s    v1.25.6\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#110-metrics\u90e8\u7f72","title":"1.10 Metrics\u90e8\u7f72","text":"<p>\u5728\u65b0\u7248\u7684Kubernetes\u4e2d\uff0c\u7cfb\u7edf\u8d44\u6e90\u7684\u91c7\u96c6\u4f7f\u7528Metrics-server\uff0c\u53ef\u4ee5\u901a\u8fc7Metrics\u91c7\u96c6\u8282\u70b9\u548cPod\u7684\u5185\u5b58\u3001\u78c1\u76d8\u3001CPU\u548c\u7f51\u7edc\u7684\u4f7f\u7528\u7387\u3002</p> <p>\u5c06Master01\u8282\u70b9\u7684front-proxy-ca.crt\u590d\u5236\u5230\u6240\u6709Node\u8282\u70b9\uff1a</p> <pre><code># scp /etc/kubernetes/pki/front-proxy-ca.crt k8s-node01:/etc/kubernetes/pki/front-proxy-ca.crt\n# scp /etc/kubernetes/pki/front-proxy-ca.crt k8s-node(\u5176\u4ed6\u8282\u70b9\u81ea\u884c\u62f7\u8d1d):/etc/kubernetes/pki/front-proxy-ca.crt\n</code></pre> <p>\u5b89\u88c5metrics server\uff1a</p> <pre><code># cd /root/k8s-ha-install/kubeadm-metrics-server\n# kubectl create -f comp.yaml \nserviceaccount/metrics-server created\nclusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created\nclusterrole.rbac.authorization.k8s.io/system:metrics-server created\nrolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created\nclusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created\nclusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created\nservice/metrics-server created\ndeployment.apps/metrics-server created\napiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created\n</code></pre> <p>\u67e5\u770bMetrics Server\u72b6\u6001\uff1a</p> <pre><code># kubectl get pod -n kube-system -l k8s-app=metrics-server\nNAME                              READY   STATUS    RESTARTS   AGE\nmetrics-server-74db45c9df-xstzf   1/1     Running   0          3m3s\n</code></pre> <p>\u72b6\u6001\u6b63\u5e38\u540e\uff0c\u67e5\u770b\u5ea6\u91cf\u6307\u6807\uff1a</p> <pre><code># kubectl top node\nNAME           CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   k8s-master01   153m         3%     1701Mi          44%       k8s-master02   125m         3%     1693Mi          44%       k8s-master03   129m         3%     1590Mi          41%       k8s-node01     73m          1%     989Mi           25%       # kubectl top po -A\nNAMESPACE     NAME                                       CPU(cores)   MEMORY(bytes)\nkube-system   calico-kube-controllers-86d8c4fb68-4wk7q   3m           16Mi\nkube-system   calico-node-8cqhj                          37m          126Mi\nkube-system   calico-node-9dq92                          78m          97Mi\nkube-system   calico-node-dw6tq                          52m          111Mi\nkube-system   calico-node-g94pp                          74m          99Mi\nkube-system   calico-typha-768795f74d-clpvm              8m           23Mi\nkube-system   coredns-7f8cbcb969-f7chc                   2m           13Mi\nkube-system   coredns-7f8cbcb969-fv9fv                   3m           12Mi\nkube-system   etcd-k8s-master01                          79m          72Mi\nkube-system   etcd-k8s-master02                          77m          68Mi\nkube-system   etcd-k8s-master03                          53m          68Mi\nkube-system   kube-apiserver-k8s-master01                63m          311Mi\nkube-system   kube-apiserver-k8s-master02                64m          314Mi\nkube-system   kube-apiserver-k8s-master03                44m          389Mi\nkube-system   kube-controller-manager-k8s-master01       24m          59Mi\nkube-system   kube-controller-manager-k8s-master02       4m           29Mi\nkube-system   kube-controller-manager-k8s-master03       2m           28Mi\nkube-system   kube-proxy-jcm25                           1m           18Mi\nkube-system   kube-proxy-q8msx                           1m           19Mi\nkube-system   kube-proxy-rtwdz                           1m           21Mi\nkube-system   kube-proxy-s2xvg                           1m           18Mi\nkube-system   kube-scheduler-k8s-master01                5m           27Mi\nkube-system   kube-scheduler-k8s-master02                4m           24Mi\nkube-system   kube-scheduler-k8s-master03                4m           23Mi\nkube-system   metrics-server-74db45c9df-xstzf            11m          26Mi\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#111-dashboard\u90e8\u7f72","title":"1.11 Dashboard\u90e8\u7f72","text":"<p>Kubernetes\u5b98\u65b9\u63d0\u4f9b\u4e86\u7b80\u5355\u7684\u56fe\u5f62\u5316\u5c55\u793a\uff0c\u53ef\u7528\u4e8e\u5c55\u793a\u96c6\u7fa4\u4e2d\u7684\u5404\u7c7b\u8d44\u6e90\uff0c\u540c\u65f6\u4e5f\u53ef\u4ee5\u901a\u8fc7Dashboard\u5b9e\u65f6\u67e5\u770bPod\u7684\u65e5\u5fd7\u548c\u5728\u5bb9\u5668\u4e2d\u6267\u884c\u4e00\u4e9b\u547d\u4ee4\u7b49\u3002</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#1111-\u901a\u8fc7yaml\u90e8\u7f72","title":"1.11.1 \u901a\u8fc7YAML\u90e8\u7f72","text":""},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#1-\u5b89\u88c5dashboard","title":"1 \u5b89\u88c5Dashboard","text":"<p>\u5728Master01\u8282\u70b9\u521b\u5efaDashboard,v1.25.6 \u7248\u672c\u7684\u96c6\u7fa4\u9700\u8981\u5b89\u88c5\u6700\u65b0\u7684 2.0+ \u7248\u672c\u7684 Dashboard,\uff08\u8be5\u547d\u4ee4\u5305\u542b\u7ba1\u7406\u5458\u7528\u6237\u7684\u521b\u5efa\uff09\uff1a</p> <pre><code># wget https://raw.githubusercontent.com/cby-chen/Kubernetes/main/yaml/dashboard.yaml\n##\u76ee\u524d\u6700\u65b0\u7248\u672cv2.6.0 \n# vim dashboard.yaml\n----\nspec:\n  ports:\n    - port: 443\ntargetPort: 8443\nnodePort: 30443\ntype: NodePort\n  selector:\n    k8s-app: kubernetes-dashboard\n----\n\n# kubectl apply -f dashboard.yaml\nnamespace/kubernetes-dashboard created\nserviceaccount/kubernetes-dashboard created\nservice/kubernetes-dashboard created\nsecret/kubernetes-dashboard-certs created\nsecret/kubernetes-dashboard-csrf created\nsecret/kubernetes-dashboard-key-holder created\nconfigmap/kubernetes-dashboard-settings created\nrole.rbac.authorization.k8s.io/kubernetes-dashboard created\nclusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created\nrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created\nclusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created\ndeployment.apps/kubernetes-dashboard created\nservice/dashboard-metrics-scraper created\ndeployment.apps/dashboard-metrics-scraper created\n\n## \u521b\u5efa\u7528\u6237\uff1a\n# wget https://raw.githubusercontent.com/cby-chen/Kubernetes/main/yaml/dashboard-user.yaml\n# kubectl apply -f dashboard-user.yaml\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#2-\u767b\u5f55dashboard","title":"2 \u767b\u5f55Dashboard","text":"<p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u67e5\u770bDashboard Service\u7684\u7aef\u53e3\u53f7\uff08NodePort\uff09\uff1a</p> <pre><code># kubectl get svc kubernetes-dashboard -n kubernetes-dashboard\nNAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE\nkubernetes-dashboard   NodePort   192.168.250.65   &lt;none&gt;        443:30443/TCP   36s\n</code></pre> <p>\u67e5\u770b\u767b\u5f55\u7684Token\u503c\uff1a</p> <pre><code># kubectl -n kubernetes-dashboard create token admin-user\neyJhbGciOiJSUzI1NiIsImtpZCI6Ii1fbkh2Um5JS1VoSFRQSkEzZUJwRVNlUmFBaGwwZnVpUkVCeXk3Z2pGTkUifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNjc1OTE0MjY0LCJpYXQiOjE2NzU5MTA2NjQsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiNzczMDAyYmEtZmNmMS00YWI0LWE0NGItN2FlNDlmN2M5MDU4In19LCJuYmYiOjE2NzU5MTA2NjQsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDphZG1pbi11c2VyIn0.pA7B6BSvQzhCQl2t6BnUTOg6GoDRKVcKEynwTDGxHY8Zh88y2VWdXq60zs5FeaxyUFLNDrj2UWX74TM_Hw7H4hPKX_PXXvsO7Du3ykWzCeIhYV2TZCUnal5iQlsS_A83QkWgXqojL1c_s00K3PNyEqqfL8D61jJLOzb4YihTUnyOLnJ8SQq9EDTxZPsVp07hiZ76gnFijvAp8bsClS5WP0lj0riI2Oi1cL7IE0HD4aoW7oHDLEsvwqjlaon7xwA6OtQZfDOEMjptIgDLppKMdJyxeWZaw_4825ByU06_YY60OcwR8tEFv93fvSSCZadIxJhf1nmJDprEi414ATIKrg\n</code></pre> <p>\u8bbf\u95eehttps://node01IP:30443/\u5c31\u80fd\u770b\u5230\u767b\u5f55\u754c\u9762\u3002</p> <p>\u8f93\u5165token\uff1a</p> <pre><code>eyJhbGciOiJSUzI1NiIsImtpZCI6Ii1fbImh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY........\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#1112-\u901a\u8fc7helm\u90e8\u7f72","title":"1.11.2 \u901a\u8fc7helm\u90e8\u7f72","text":"<p>Chart \u4ed3\u5e93\u5730\u5740\uff1ahttps://artifacthub.io/packages/helm/k8s-dashboard/kubernetes-dashboard</p> <pre><code># helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/\n# helm repo update\n## \u4e0b\u8f7d\u5230\u672c\u5730\u5b89\u88c5\n# helm search repo kubernetes-dashboard/kubernetes-dashboard\nNAME                                            CHART VERSION   APP VERSION     DESCRIPTION\nkubernetes-dashboard/kubernetes-dashboard       6.0.0           2.7.0           General-purpose web UI for Kubernetes clusters\n\n# helm pull kubernetes-dashboard/kubernetes-dashboard --version 6.0.0 --untar\n# cat values-pro.yaml\nextraArgs:\n  - --token-ttl=0\n- --system-banner=\"Welcome to Kubernetes Cluster. \u64cd\u4f5c\u9700\u8c28\u614e\uff01\uff01\uff01\"\nservice:\n  type: NodePort\n  nodePort: 30443\nrbac:\n  clusterReadOnlyRole: true\nmetricsScraper:\n  enabled: true\n# helm install kubernetes-dashboard kubernetes-dashboard -f values-pro.yaml --namespace kubernetes-dashboard --create-namespace\nNAME: kubernetes-dashboard\nLAST DEPLOYED: Thu Feb  9 10:52:32 2023\nNAMESPACE: kubernetes-dashboard\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\n*********************************************************************************\n*** PLEASE BE PATIENT: kubernetes-dashboard may take a few minutes to install ***\n*********************************************************************************\n\nGet the Kubernetes Dashboard URL by running:\n  export NODE_PORT=$(kubectl get -n kubernetes-dashboard -o jsonpath=\"{.spec.ports[0].nodePort}\" services kubernetes-dashboard)\nexport NODE_IP=$(kubectl get nodes -o jsonpath=\"{.items[0].status.addresses[0].address}\")\necho https://$NODE_IP:$NODE_PORT/\n</code></pre> <p>\u68c0\u67e5kubernetes-dashboard\u90e8\u7f72\u72b6\u6001</p> <pre><code># kubectl get pods,svc -n kubernetes-dashboard | grep kubernetes-dashboard\npod/kubernetes-dashboard-5486c8f5bf-xff6r   1/1     Running   0          45s\nservice/kubernetes-dashboard   NodePort   192.168.48.88   &lt;none&gt;        443:30443/TCP   45s\n</code></pre> <p>\u8bbe\u7f6e\u767b\u5f55\u7684token\u4fe1\u606f</p> <pre><code># cat &gt;kubernetes-dashboard-admin-user.yaml&lt;&lt;EOF\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: admin-user\n  namespace: kubernetes-dashboard\n\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: admin-user\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: cluster-admin\nsubjects:\n- kind: ServiceAccount\n  name: admin-user\n  namespace: kubernetes-dashboard\nEOF\n\n# kubectl apply -f kubernetes-dashboard-admin-user.yaml\nserviceaccount/admin-user unchanged\nclusterrolebinding.rbac.authorization.k8s.io/admin-user unchanged\n\n# kubectl -n kubernetes-dashboard create token admin-user\neyJhbGciOiJSUzI1NiIsImtpZCI6Ii1fbkh2Um5JS1VoSFRQSkEzZUJwRVNlUmFBaGwwZnVpUkVCeXk3Z2pGTkUifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNjc1OTE2NTAwLCJpYXQiOjE2NzU5MTI5MDAsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiN2VkNGQxNjItMzlkOC00ODc2LTk0ZjgtZTliYzUxNThmYmNhIn19LCJuYmYiOjE2NzU5MTI5MDAsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDphZG1pbi11c2VyIn0.CX98KwrW01fNSN0SJruN31bmflhdlueTXSfTfYh0IdvYFxuJbWGY1Zuslcb8JxowS4TW5ovqB71-3Sad9346oVwpel1fJwy2kGFopOQnK6AiY67XhuxIduDqYHqPLzETFp5n7ij4_Miv9bvt5-TG4u4arLpPEOFibUKOc4Z3k_wcRujO_re6JP8ElZzUrGh9EZ0BpdUaPrMiYFAyqXn6Uu5kC9_c5nV_ORYFXda3uX1mHxAN07_osNoYsTJsHXM46UX_5SwrQGfL3Xtgh7GiC-o9ZEawVtk9Vqkm335b8hxJEJp-bwsQrMUBUTelNYcf0KmCXHAQ8R1XilgDNZOlIg\n</code></pre> <p>\u8bbf\u95eehttps://node01IP:30443/\u5c31\u80fd\u770b\u5230\u767b\u5f55\u754c\u9762\u3002</p> <p></p> <p>\u8f93\u5165token\uff1a <pre><code>eyJhbGciOiJSUzI1........\n</code></pre></p> <p>Clean up and next steps</p> <p>Remove the admin <code>ServiceAccount</code> and <code>ClusterRoleBinding</code>.</p> <pre><code>kubectl -n kubernetes-dashboard delete serviceaccount admin-user\nkubectl -n kubernetes-dashboard delete clusterrolebinding admin-user\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#112-\u6ce8\u610f\u4e8b\u9879","title":"1.12 \u6ce8\u610f\u4e8b\u9879","text":""},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#1121-\u914d\u7f6e\u65b9\u9762","title":"1.12.1 \u914d\u7f6e\u65b9\u9762","text":"<p>\u548c\u4e8c\u8fdb\u5236\u5b89\u88c5\u65b9\u5f0f\u4e0d\u540c\u7684\u662f\uff0c\u4f7f\u7528Kubeadm\u5b89\u88c5\u7684Kubernetes\u96c6\u7fa4\uff0c</p> <p>\u5927\u90e8\u5206\u7ec4\u4ef6\u90fd\u662f\u4ee5\u5bb9\u5668\u7684\u65b9\u5f0f\u8fd0\u884c\u7684\uff0c\u6bd4\u5982kube-apiserver\u3001kube-proxy\u7b49\uff0c\u53ef\u4ee5\u901a\u8fc7kubectl get po -n kube-system\u67e5\u770b\u7cfb\u7edf\u7684Pod\u3002</p> <p>Master\u8282\u70b9\u7684\u7ec4\u4ef6kube-apiserver\u3001kube-scheduler\u3001kube-controller-manager\u3001etcd\u7684\u914d\u7f6e\u548c\u542f\u52a8\u6587\u4ef6\u9ed8\u8ba4\u90fd\u653e\u7f6e\u5728/etc/kubernetes/manifests\uff0c\u4ee5\u9759\u6001Pod\u7684\u65b9\u5f0f\u542f\u52a8\u3002</p> <p>\u6bd4\u5982apiserver\u7684kube-apiserver.yaml\uff0c\u8be5YAML\u6587\u4ef6\u66f4\u6539\u540e\uff0ckubelet\u4f1a\u81ea\u52a8\u5237\u65b0\u914d\u7f6e\uff0c\u4e5f\u5c31\u662f\u4f1a\u91cd\u542fPod\uff0c\u65e0\u987b\u5176\u4ed6\u7684\u64cd\u4f5c\u3002</p> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0ckube-proxy\u662f\u4ee5DaemonSet\uff08\u5b88\u62a4\u8fdb\u7a0b\u96c6\uff0c\u4f1a\u5728\u6240\u6709\u7b26\u5408\u6761\u4ef6\u7684\u8282\u70b9\u4e0a\u90e8\u7f72\u4e00\u4e2aPod\uff09\u7684\u65b9\u5f0f\u5b89\u88c5\u7684\uff0c\u5176\u914d\u7f6e\u6587\u4ef6\u4f7f\u7528Kubernetes\u7684ConfigMap\u8fdb\u884c\u7ba1\u7406\uff0c\u5e76\u975e\u5bbf\u4e3b\u673a\u4e0a\u7684\u67d0\u4e2a\u6587\u4ef6\uff0c\u5982\u679c\u9700\u8981\u4fee\u6539kube-proxy\u7684\u914d\u7f6e\uff0c\u9700\u8981\u66f4\u6539\u8be5ConfigMap\u4e4b\u540e\uff0c\u518d\u5bf9kube-proxy\u8fdb\u884c\u6eda\u52a8\u66f4\u65b0\u624d\u4f1a\u751f\u6548\u3002</p> <p>\u6bd4\u5982\u5c06kube-proxy\u4ee3\u7406\u6a21\u5f0f\u6539\u4e3aipvs\u6a21\u5f0f\uff0c\u53ef\u4ee5\u901a\u8fc7kubectl\u547d\u4ee4\u7f16\u8f91kube-proxy\u914d\u7f6e\u6587\u4ef6\u7684ConfigMap\u3002\u4ee5\u4e0b\u64cd\u4f5c\u5728Master01\u4e0a\u6267\u884c\u3002</p> <pre><code># kubectl edit cm kube-proxy -n kube-system\nmode: \"ipvs\" # mode\u66f4\u6539\u4e3aipvs\n</code></pre> <p>\u66f4\u65b0Kube-Proxy\u7684Pod\uff1a</p> <pre><code># kubectl patch daemonset kube-proxy -p \"{\\\"spec\\\":{\\\"template\\\":{\\\"metadata\\\":{\\\"annotations\\\":{\\\"date\\\":\\\"`date +%s`\\\"}}}}}\" -n kube-system\ndaemonset.apps/kube-proxy patched\n\n## \u6216\u8005\u91cd\u542fkube-proxy\n# kubectl get pod -n kube-system | grep kube-proxy |awk '{system(\"kubectl delete pod \"$1\" -n kube-system\")}'\n</code></pre> <p>\u9a8c\u8bc1Kube-Proxy\u6a21\u5f0f\uff1a</p> <pre><code># curl 127.0.0.1:10249/proxyMode\nipvs\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#1122-\u6c61\u70b9\u65b9\u9762","title":"1.12.2 \u6c61\u70b9\u65b9\u9762","text":"<p>Kubeadm\u5b89\u88c5\u540e\uff0c\u4f1a\u81ea\u52a8\u6dfb\u52a0NoSchedule\u7684\u6c61\u70b9\uff0c\u6240\u4ee5Master\u8282\u70b9\u9ed8\u8ba4\u4e0d\u5141\u8bb8\u90e8\u7f72\u975e\u7cfb\u7edfPod\uff0c\u53ef\u4ee5\u901a\u8fc7\u5220\u9664\u6c61\u70b9\u7684\u65b9\u5f0f\u5141\u8bb8\u90e8\u7f72\u3002</p> <p>\u9996\u5148\u67e5\u770b\u6c61\u70b9\uff1a</p> <pre><code>## \u67e5\u770b\u6c61\u70b9\n# kubectl describe node -l node-role.kubernetes.io/master= | grep -B 3 Taints\n</code></pre> <p>\u7136\u540e\u5220\u9664\u6c61\u70b9\uff08\u751f\u4ea7\u73af\u5883\u6700\u597d\u4e0d\u8981\u5728Master\u8282\u70b9\u90e8\u7f72\u5176\u4ed6Pod\uff09\uff1a</p> <pre><code>## \u5220\u9664\u6c61\u70b9\n# kubectl taint node -l node-role.kubernetes.io/master node-role.kubernetes.io/master:NoSchedule-\n## \u67e5\u770b\u6c61\u70b9\n# kubectl describe node -l node-role.kubernetes.io/master= | grep Taints\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#1123-\u8bbe\u7f6e\u6807\u7b7e","title":"1.12.3 \u8bbe\u7f6e\u6807\u7b7e","text":"<pre><code>## \u8bbe\u7f6e\u6807\u7b7e\n# kubectl label node gitee-k8s-w02 monitor=prometheus\nnode/gitee-k8s-w02 labeled\n\n## \u5e26\u6709prometheus\u6807\u8bc6\u7b26\u7684\u6807\u7b7e\n# kubectl label nodes gitee-k8s-w02 node-role.kubernetes.io/prometheus=\"true\"\n## \u5220\u9664\u6807\u7b7e\n# kubectl label nodes gitee-k8s-w02 monitor-\nnode/gitee-k8s-w02 labeled\n\n## \u5e26\u6709prometheus\u6807\u8bc6\u7b26\u7684\u6807\u7b7e\n# kubectl label nodes gitee-k8s-w02 node-role.kubernetes.io/prometheus-\n## \u4fee\u6539\u4e00\u4e2alabel\u7684\u503c\uff0c\u9700\u8981\u52a0\u4e0a\u2013overwrite\u53c2\u6570\uff1a\n# kubectl label nodes k8s-test01 gpu=false --overwrite\n## \u67e5\u770b\u6240\u6709\u7684lables\u4fe1\u606f\n# kubectl get nodes --show-labels\n## \u6216\u8005\n# kubectl describe nodes k8s-test01\n</code></pre> <p>\u9664\u4e86\u81ea\u5df1\u5b9a\u4e49\u7684\u6807\u7b7e\u4e4b\u5916\uff0cKubernetes\u8fd8\u4f1a\u4e3a\u6bcf\u4e2a\u8282\u70b9\u81ea\u52a8\u751f\u6210\u7cfb\u7edf\u7ea7\u6807\u7b7e\u3002</p> <ul> <li>Kubernetes.io/hostname\uff1a\u673a\u5668\u540d\u79f0\uff0c\u4f8b\u5982\uff0cgitee-k8s-w29\u3002</li> <li>Kubernetes.io/os\uff1a\u7cfb\u7edf\u540d\u79f0\uff0c\u4f8b\u5982\uff0cLinux/Windows\u3002</li> <li>Kubernetes.io/arch\uff1a\u67b6\u6784\u540d\u79f0\uff0c\u4f8b\u5982\uff0camd64\u3002</li> </ul> <p>\u53ea\u6709\u4f7f\u7528\u516c\u6709\u4e91\u5382\u5546\u81ea\u5bb6\u7684Kubernetes\u65f6\u624d\u4f1a\u6709\u4ee5\u4e0b\u6807\u7b7e\uff0c\u79c1\u6709Kubernetes\u96c6\u7fa4\u6ca1\u6709\u8fd9\u4e9b\u6807\u7b7e\u3002</p> <ul> <li>failure-domain.beta.Kubernetes.io/region\uff1a\u5730\u57df\u540d\u79f0\u3002</li> <li>failure-domain.beta.Kubernetes.io/zone\uff1a\u5730\u57df\u4e0b\u7684\u533a\u57df\u540d\u79f0\u3002</li> <li>beta.Kubernetes.io/instance-type\uff1a\u4f7f\u7528\u7684cloudprovider\u540d\u79f0\u3002</li> </ul>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#113\u5c0f\u7ed3","title":"1.13\u5c0f\u7ed3","text":"<p>\u672c\u7ae0\u5b8c\u6210\u4e86\u4f7f\u7528Kubeadm\u65b9\u5f0f\u5b89\u88c5\u9ad8\u53ef\u7528\u7684Kubernetes\u96c6\u7fa4\uff0c\u81f3\u6b64\u8bfb\u8005\u5df2\u7ecf\u6253\u5f00\u4e86Kubernetes\u7684\u7b2c\u4e00\u6247\u5927\u95e8\u3002</p> <p>\u5728\u5b89\u88c5\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u6709\u4efb\u4f55\u7591\u95ee\uff0c\u53ef\u4ee5\u76f4\u63a5\u5728GitHub\u4e0a\u63d0\u95ee\uff0c\u5982\u679c\u5bf9\u6982\u5ff5\u4e0d\u7406\u89e3\uff0c\u76f4\u63a5\u7ffb\u5230\u5bf9\u5e94\u7684\u57fa\u7840\u6982\u5ff5\u90e8\u5206\u5b66\u4e60\u5373\u53ef\u3002</p> <p>\u867d\u7136Kubeadm\u7684\u5b89\u88c5\u65b9\u5f0f\u6bd4\u8f83\u7b80\u5355\uff0c\u5e76\u4e14\u662f\u5b98\u65b9\u63a8\u8350\u7684\u5b89\u88c5\u65b9\u5f0f\uff0c\u4f46\u662fKubeadm\u5b89\u88c5\u7684Kubernetes\u96c6\u7fa4\u8bc1\u4e66\u6709\u6548\u671f\u9ed8\u8ba4\u53ea\u6709\u4e00\u5e74\uff0c\u5230\u671f\u540e\u9700\u8981\u8fdb\u884c\u5347\u7ea7\u6216\u8005\u66f4\u65b0\u8bc1\u4e66\uff0c\u5f53\u7136\u6709\u5174\u8da3\u7684\u8bfb\u8005\u4e5f\u53ef\u4ee5\u66f4\u6539Kubeadm\u7684\u6e90\u7801\uff0c\u5c06\u8bc1\u4e66\u66f4\u6539\u4e3a100\u5e74\uff0c\u4f46\u662f\u8fd9\u4e0d\u662f\u63a8\u8350\u7684\u65b9\u5f0f\u3002</p> <p>\u76ee\u524dKubernetes\u4fdd\u6301\u4e00\u5e743\u4e2a\u5927\u7248\u672c\u7684\u66f4\u65b0\uff0c\u63a8\u8350\u8bfb\u8005\u91c7\u7528\u5347\u7ea7\u7684\u65b9\u5f0f\u66f4\u65b0\u8bc1\u4e66\u3002</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#2-nginxkeepalived-\u642d\u5efa\u9ad8\u53ef\u7528kubernetes\u96c6\u7fa4centos7","title":"2. Nginx+Keepalived \u642d\u5efa\u9ad8\u53ef\u7528kubernetes\u96c6\u7fa4\uff08centos7\uff09","text":"<p>\u57fa\u672c\u73af\u5883\u914d\u7f6e\u4e0e\u4e0a\u9762\u4e00\u81f4</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#21-\u9ad8\u53ef\u7528\u7ec4\u4ef6\u5b89\u88c5","title":"2.1 \u9ad8\u53ef\u7528\u7ec4\u4ef6\u5b89\u88c5","text":""},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#211-\u5b89\u88c5nginx\u548ckeepalived","title":"2.1.1 \u5b89\u88c5Nginx\u548cKeepalived","text":"<pre><code>## \u57283\u4e2amaster\u8282\u70b9\u4e0a\u6267\u884c\n# rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm\n# yum install nginx keepalived -y\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#212-nginx\u914d\u7f6e","title":"2.1.2 Nginx\u914d\u7f6e","text":"<p>\u6240\u6709master \u8282\u70b9\u914d\u7f6e</p> <pre><code># cat &gt; /etc/nginx/nginx.conf &lt;&lt; \"EOF\"\nuser nginx;\nworker_processes auto;\nerror_log /var/log/nginx/error.log;\npid /run/nginx.pid;\ninclude /usr/share/nginx/modules/*.conf;\nevents {\nworker_connections 1024;\n}\n# \u56db\u5c42\u8d1f\u8f7d\u5747\u8861\uff0c\u4e3a\u4e24\u53f0Master apiserver\u7ec4\u4ef6\u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\nstream {\nlog_format  main  '$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent';\naccess_log  /var/log/nginx/k8s-access.log  main;\nupstream k8s-apiserver {\n# Master1 APISERVER IP:PORT\nserver 192.168.1.190:6443;\n# Master2 APISERVER IP:PORT\nserver 192.168.1.191:6443;\n# Master3 APISERVER IP:PORT\nserver 192.168.1.192:6443;\n}\nserver {\nlisten 16443;\nproxy_pass k8s-apiserver;\n}\n}\nhttp {\nlog_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n'$status $body_bytes_sent \"$http_referer\" '\n'\"$http_user_agent\" \"$http_x_forwarded_for\"';\naccess_log  /var/log/nginx/access.log  main;\nsendfile            on;\ntcp_nopush          on;\ntcp_nodelay         on;\nkeepalive_timeout   65;\ntypes_hash_max_size 2048;\ninclude             /etc/nginx/mime.types;\ndefault_type        application/octet-stream;\nserver {\nlisten       80 default_server;\nserver_name  _;\nlocation / {\n}\n}\n}\nEOF\n</code></pre> <p>\u6e29\u99a8\u63d0\u793a</p> <p>\u5982\u679c\u53ea\u4fdd\u8bc1\u9ad8\u53ef\u7528\uff0c\u4e0d\u914d\u7f6e k8s-apiserver \u8d1f\u8f7d\u5747\u8861\u7684\u8bdd\uff0c\u53ef\u4ee5\u4e0d\u88c5 nginx\uff0c\u4f46\u662f\u6700\u597d\u8fd8\u662f\u914d\u7f6e\u4e00\u4e0b k8s-apiserver \u8d1f\u8f7d\u5747\u8861\u3002</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#213-keepalived\u914d\u7f6e","title":"2.1.3 Keepalived\u914d\u7f6e","text":"<p>\u6240\u6709master\u8282\u70b9\u914d\u7f6e</p> <pre><code># cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF\nglobal_defs {\nnotification_email {\nacassen@firewall.loc\n    failover@firewall.loc\n    sysadmin@firewall.loc\n  }\nnotification_email_from fage@qq.com\n  smtp_server 127.0.0.1\n  smtp_connect_timeout 30\nrouter_id NGINX_MASTER\n}\nvrrp_script check_nginx {\nscript \"/etc/keepalived/check_apiserver.sh\"\ninterval 5\nweight -5\n   fall 2  rise 1\n}\nvrrp_instance VI_1 {\nstate MASTER     # \u5907\u673a BACKUP\ninterface eth0\n   virtual_router_id 51          # VRRP \u8def\u7531 ID\u5b9e\u4f8b\uff0c\u6bcf\u4e2a\u5b9e\u4f8b\u662f\u552f\u4e00\u7684\npriority 100                  # \u4f18\u5148\u7ea7\uff0c\u5907\u670d\u52a1\u5668\u8bbe\u7f6e 99        master1:100  master2\u3001master3:99\nadvert_int 1                  # \u6307\u5b9aVRRP \u5fc3\u8df3\u5305\u901a\u544a\u95f4\u9694\u65f6\u95f4\uff0c\u9ed8\u8ba41\u79d2\nauthentication {\nauth_type PASS\n       auth_pass 1111\n}\n# \u865a\u62dfIP\nvirtual_ipaddress {\n192.168.1.193\n   }\ntrack_script {\ncheck_nginx\n   }\n}\nEOF\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#214-\u5065\u5eb7\u68c0\u67e5\u811a\u672c","title":"2.1.4 \u5065\u5eb7\u68c0\u67e5\u811a\u672c","text":"<pre><code>cat &gt; /etc/keepalived/check_apiserver.sh  &lt;&lt; \"EOF\"\n#!/bin/bash\ncount=$(ps -ef |grep nginx |egrep -cv \"grep|$$\")\nif [ \"$count\" -eq 0 ];then\nexit 1\nelse\nexit 0\nfi\nEOF\nchmod +x /etc/keepalived/check_apiserver.sh\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#215-\u542f\u52a8","title":"2.1.5 \u542f\u52a8","text":"<pre><code>systemctl daemon-reload\nsystemctl restart nginx &amp;&amp; systemctl enable --now nginx systemctl restart keepalived &amp;&amp; systemctl enable --now keepalived </code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#3-kube-vip-\u642d\u5efa\u9ad8\u53ef\u7528-kubernetes-\u96c6\u7fa4","title":"3. kube-vip \u642d\u5efa\u9ad8\u53ef\u7528 Kubernetes \u96c6\u7fa4","text":"\u53c2\u8003\u6587\u732e <p>https://www.qikqiak.com/k8strain2/maintain/ha/</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#4-\u5f00\u53d1\u73af\u5883\u90e8\u7f72","title":"4. \u5f00\u53d1\u73af\u5883\u90e8\u7f72","text":""},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#41-\u5355master\u7248\u672c","title":"4.1 \u5355master\u7248\u672c","text":"\u53c2\u8003\u6587\u732e <p>\u4e24\u4e2a\u547d\u4ee4\u4ece\u7a7a\u767d\u7cfb\u7edf\u5230\u5355master\u8282\u70b9K8s\u96c6\u7fa4</p> <p>Kubernetes \u96c6\u7fa4\u73af\u5883\u5b89\u88c5</p> <p>Kubernetes \u96c6\u7fa4\u73af\u5883\u5b89\u88c5</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#42-\u9ad8\u53ef\u7528ha\u65b9\u6848","title":"4.2 \u9ad8\u53ef\u7528Ha\u65b9\u6848","text":"<p>\u53ef\u7528\u4e8e\u751f\u4ea7\u73af\u5883\u7684 Kubernetes HA \u90e8\u7f72\u65b9\u6848\uff0c\u57fa\u4e8e kubeadm + Ansible + Keepalived + Haproxy</p> <p>\u53c2\u8003\u6587\u732e</p> <p>https://gitee.com/atompi/Prod-K8S-HA-Installer</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#5\u4e09\u65b9\u90e8\u7f72\u65b9\u6848","title":"5.\u4e09\u65b9\u90e8\u7f72\u65b9\u6848","text":""},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#51-kubeode","title":"5.1 kubeode","text":"<p>\u53c2\u8003\u6587\u732e</p> <p>https://gitee.com/q7104475/kubeode?_from=gitee_search</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#52-kainstall","title":"5.2 kainstall","text":"<p>\u53c2\u8003\u6587\u732e<p>https://github.com/lework/kainstall</p> <p>https://gitee.com/uxvim/kainstall</p> </p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#53-kubeasz","title":"5.3 kubeasz","text":"<p>\u53c2\u8003\u6587\u732e</p> <p>https://github.com/easzlab/kubeasz</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#54-\u57fa\u4e8esealos\u5b89\u88c5ha\u96c6\u7fa4-\u63a8\u8350","title":"5.4 \u57fa\u4e8eSealOS\u5b89\u88c5HA\u96c6\u7fa4 (\u63a8\u8350)","text":"<p>\u53c2\u8003\u6587\u732e</p> <p>https://www.kubegems.io/docs/installation/kubernetes-install/sealos</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#55--\u57fa\u4e8ekind\u5b89\u88c5-\u5b9e\u9a8c\u6027\u8d28","title":"5.5  \u57fa\u4e8eKind\u5b89\u88c5 (\u5b9e\u9a8c\u6027\u8d28)","text":"<p>\u53c2\u8003\u6587\u732e</p> <p>https://www.kubegems.io/docs/installation/kubernetes-install/kind</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#56-\u57fa\u4e8ekuboardspray-\u5b89\u88c5kubernetes","title":"5.6 \u57fa\u4e8eKuboardSpray \u5b89\u88c5kubernetes","text":"<p>\u53c2\u8003\u6587\u732e</p> <p>https://www.kuboard.cn/install/install-k8s.html</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#6\u6e05\u7406","title":"6.\u6e05\u7406","text":"<p>\u5982\u679c\u4f60\u7684\u96c6\u7fa4\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u9047\u5230\u4e86\u5176\u4ed6\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u8fdb\u884c\u91cd\u7f6e\uff1a</p> <pre><code>\u279c  ~ kubeadm reset\n\u279c  ~ ifconfig cni0 down &amp;&amp; ip link delete cni0\n\u279c  ~ ifconfig flannel.1 down &amp;&amp; ip link delete flannel.1\n\u279c  ~ rm -rf /var/lib/cni/\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/","title":"\u4e8c\u8fdb\u5236\u5b89\u88c5\u9ad8\u53ef\u7528K8s\u96c6\u7fa4","text":"<p>\u672c\u7ae0\u91c7\u7528\u4e8c\u8fdb\u5236\u7684\u65b9\u5f0f\u5b89\u88c5Kubernetes\u96c6\u7fa4\uff0c\u8be5\u65b9\u5f0f\u8f83Kubeadm\u5b89\u88c5\u65b9\u5f0f\u66f4\u4e3a\u590d\u6742\uff0c\u6bd4\u5982\u8bc1\u4e66\u90e8\u5206Kubeadm\u65b9\u5f0f\u4e3a\u81ea\u52a8\u751f\u6210\uff0c\u800c\u4e8c\u8fdb\u5236\u65b9\u5f0f\u4e3a\u624b\u52a8\u521b\u5efa\uff0c\u4f46\u662f\u4e8c\u8fdb\u5236\u65b9\u5f0f\u53ef\u4ee5\u5c06\u8bc1\u4e66\u76f4\u63a5\u6539\u4e3a100\u5e74\u3002</p> <p>\u53e6\u5916\uff0c\u4e8c\u8fdb\u5236\u65b9\u5f0f\u5728\u5347\u7ea7\u65f6\u4e5f\u6bd4\u8f83\u7b80\u5355\uff0c\u5728\u914d\u7f6e\u6ca1\u6709\u66f4\u65b0\u7684\u524d\u63d0\u4e0b\uff0c\u53ef\u4ee5\u76f4\u63a5\u66ff\u6362\u4e8c\u8fdb\u5236\u5305\u8fdb\u884c\u66f4\u65b0\u3002</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#1-\u57fa\u672c\u73af\u5883\u914d\u7f6e","title":"1. \u57fa\u672c\u73af\u5883\u914d\u7f6e","text":"<p>\u8bfb\u8005\u9700\u81ea\u884c\u51c6\u59075\u53f0\u5177\u67092\u6838CPU\u548c4GB\u4ee5\u4e0a\u5185\u5b58\u7684\u670d\u52a1\u5668\uff0c\u7cfb\u7edf\u4e3aCentOS 7.x\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u8fd9\u4e48\u591a\u7684\u673a\u5668\uff0c\u53ef\u4ee5\u53ea\u5b89\u88c53\u53f0Master\u6216\u8005\u4e00\u53f0Master\u3001\u4e24\u53f0Node\u3002\u96c6\u7fa4\u91c7\u7528\u7684\u670d\u52a1\u5668IP\u89c4\u5212\u5982\u88682.1\u6240\u793a\u3002</p> <p>\u88682.1\u3000\u9ad8\u53ef\u7528Kubernetes\u96c6\u7fa4\u89c4\u5212</p> \u4e3b\u673a\u540d IP\u5730\u5740 \u8bf4\u660e k8s-master-01~03 10.0.0.201~203 master\u8282\u70b9*3 VIP 10.0.0.236 keeplived\u865a\u62dfIP k8s-node01~02 10.0.0.204~10.0.0.205 worker\u8282\u70b9*2 <p>kubernetes\u4e00\u5171\u6d89\u53ca\u4e09\u4e2a\u7f51\u6bb5\uff0c\u4e00\u4e2a\u662f\u5bbf\u4e3b\u673a\u7684\u7f51\u6bb5\uff0c\u4e5f\u5c31\u662f\u4e0a\u8ff0\u768410.0.0.x\uff0c\u540c\u65f6\u9700\u8981Pod\u548cService\u7684\u7f51\u6bb5\uff0c\u4e09\u8005\u7684\u7f51\u6bb5\u4e0d\u53ef\u4ea4\u53c9\u3002</p> <p>\u5b89\u88c5\u914d\u7f6e\u4fe1\u606f\u5982\u88682.2\u6240\u793a\u3002</p> <p>\u88682.2\u3000\u5b89\u88c5\u914d\u7f6e\u4fe1\u606f</p> \u914d\u7f6e\u4fe1\u606f \u5907\u6ce8 \u7cfb\u7edf\u7248\u672c Centos7.9 Docker\u7248\u672c 20.10.x Pod\u7f51\u6bb5 172.16.0.0/12 Service\u7f51\u6bb5 192.168.0.0/16 <p>\u6ce8\u610f</p> <p>\u5bbf\u4e3b\u673a\u7f51\u6bb5\u3001K8s Service\u7f51\u6bb5\u3001Pod\u7f51\u6bb5\u4e0d\u80fd\u91cd\u590d\u3002</p> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6e\u4e3b\u673a\u540d\uff08\u5176\u4ed6\u8282\u70b9\u540d\u79f0\u81ea\u884c\u66f4\u6539\uff09\uff1a</p> <pre><code># hostnamectl set-hostname k8s-master01 &amp;&amp; eval -- bash\n# hostnamectl set-hostname k8s-master02 &amp;&amp; eval -- bash\n# hostnamectl set-hostname k8s-master03 &amp;&amp; eval -- bash\n# hostnamectl set-hostname k8s-node01 &amp;&amp; eval -- bash\n# hostnamectl set-hostname k8s-node02 &amp;&amp; eval -- bash\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6ehosts\uff0c\u4fee\u6539/etc/hosts\u5982\u4e0b\uff1a</p> <pre><code># cat /etc/hosts\n10.0.0.201 k8s-master01\n10.0.0.202 k8s-master02\n10.0.0.203 k8s-master03\n10.0.0.204 k8s-node01\n10.0.0.205 k8s-node02\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6eDocker\u548c\u9ed8\u8ba4yum\u6e90\uff1a</p> <pre><code># curl -o /etc/yum.repos.d/CentOS-Base.repo https;//mirrors.aliyun.com/repo/Centos-7.repo\n# yum install -y yum-utils \\\ndevice-mapper-persistent-data \\\nlvm2\n\n# yum-config-manager \\\n--add-repo \\\nhttps://download.docker.com/linux/centos/docker-ce.repo\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u5b89\u88c5\u4e00\u4e9b\u5e38\u7528\u7684\u5de5\u5177\uff1a</p> <pre><code># yum install wget jq psmisc vim net-tools telnet git -y\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u5173\u95ed\u9632\u706b\u5899\u3001SELinux\u3001DNSmasq\uff1a</p> <pre><code># systemctl disable --now firewalld\n# systemctl disable --now dnsmasq\n# systemctl disable --now NetworkManager\n# setenforce 0\n# sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/sysconfig/selinux\n# sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u5173\u95edSwap\u5206\u533a\uff1a</p> <pre><code># swapoff -a &amp;&amp; sysctl -w vm.swappiness=0\n# sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u5b89\u88c5ntpdate\uff08\u5982\u679c\u516c\u53f8\u7684\u670d\u52a1\u5668\u5df2\u7ecf\u914d\u7f6e\u4e86\u81ea\u52a8\u540c\u6b65\u65f6\u95f4\uff0c\u5173\u4e8e\u65f6\u95f4\u7684\u914d\u7f6e\u53ef\u4ee5\u4e0d\u7528\u64cd\u4f5c\uff09\uff1a</p> <pre><code># rpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm\n# yum install ntpdate -y\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u540c\u6b65\u65f6\u95f4\uff1a</p> <pre><code># ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime\n# echo 'Asia/Shanghai' &gt;/etc/timezone\n# ntpdate time2.aliyun.com\n## \u52a0\u5165\u5230crontab\n# */5 * * * * /usr/sbin/ntpdate time2.aliyun.com\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6elimit\uff1a</p> <pre><code># ulimit -SHn 65535\n# vim /etc/security/limits.conf\n## \u672b\u5c3e\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\n* soft nofile 65536\n* hard nofile 131072\n* soft nproc 65535\n* hard nproc 655350\n* soft memlock unlimited\n* hard memlock unlimited\n</code></pre> <p>\u5b89\u88c5\u8fc7\u7a0b\u4e2d\uff0c\u751f\u6210\u914d\u7f6e\u6587\u4ef6\u548c\u8bc1\u4e66\u5747\u5728Master01\u4e0a\u64cd\u4f5c\uff0c\u6240\u4ee5Master01\u8282\u70b9\u9700\u8981\u514d\u5bc6\u94a5\u767b\u5f55\u5176\u4ed6\u8282\u70b9\uff0c\u4e4b\u540e\u5c06\u6587\u4ef6\u4f20\u9001\u5230\u5176\u4ed6\u8282\u70b9\u3002</p> <p>\u96c6\u7fa4\u7ba1\u7406\u4e5f\u5728Master01\u4e0a\u64cd\u4f5c\uff08\u4e5f\u53ef\u4ee5\u662f\u5176\u4ed6\u5355\u72ec\u7684\u8282\u70b9\uff09\u3002</p> <p>\u914d\u7f6e\u5bc6\u94a5\uff08\u53ea\u5728Master01\u6216\u7ba1\u7406\u8282\u70b9\u64cd\u4f5c\uff0c\u4ee5\u4e0b\u6b65\u9aa4\u5c06\u7ba1\u7406\u8282\u70b9\u548cMaster01\u7edf\u79f0\u4e3aMaster01\uff09\uff1a</p> <pre><code># ssh-keygen -t rsa\n# for i in k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02;do ssh-copy-id -i .ssh/id_rsa.pub $i;done\n</code></pre> <p>Master01\u4e0b\u8f7d\u5b89\u88c5\u6240\u6709\u7684\u6e90\u7801\u6587\u4ef6\uff1a</p> <pre><code># cd /root/ ; git clone https://github.com/dotbalo/k8s-ha-install.git\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u5347\u7ea7\u7cfb\u7edf\u5e76\u91cd\u542f\uff1a</p> <pre><code># yum update -y  &amp;&amp; reboot\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#2-\u5185\u6838\u914d\u7f6e","title":"2. \u5185\u6838\u914d\u7f6e","text":"<p>\u4e3a\u4e86\u96c6\u7fa4\u7684\u7a33\u5b9a\u6027\u548c\u517c\u5bb9\u6027\uff0c\u751f\u4ea7\u73af\u5883\u7684\u5185\u6838\u6700\u597d\u5347\u7ea7\u52304.18\u7248\u672c\u4ee5\u4e0a\uff0c\u672c\u793a\u4f8b\u5c06\u5347\u7ea7\u52304.19\u7248\u672c\u3002</p> <p>Master01\u4e0b\u8f7d\u79bb\u7ebf\u5305\uff1a</p> <pre><code># cd /root\n# wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm\n# wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm\n</code></pre> <p>\u5c06\u5b89\u88c5\u5305\u4eceMaster01\u8282\u70b9\u4f20\u5230\u5176\u4ed6\u8282\u70b9\uff1a</p> <pre><code># for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;do scp kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm $i:/root/ ; done\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u5b89\u88c5\u5185\u6838\uff1a</p> <pre><code># cd /root &amp;&amp; yum localinstall -y kernel-ml*\n## \u6240\u6709\u8282\u70b9\u66f4\u6539\u5185\u6838\u542f\u52a8\u987a\u5e8f\n# grub2-set-default  0 &amp;&amp; grub2-mkconfig -o /etc/grub2.cfg\n# grubby --args=\"user_namespace.enable=1\" --update-kernel=\"$(grubby --default-kernel)\"\n# \u68c0\u67e5\u9ed8\u8ba4\u5185\u6838\u662f\u4e0d\u662f4.19\n[root@k8s-master02 ~]# grubby --default-kernel\n/boot/vmlinuz-4.19.12-1.el7.elrepo.x86_64\n\n# \u6240\u6709\u8282\u70b9\u91cd\u542f\uff0c\u7136\u540e\u68c0\u67e5\u5185\u6838\u662f\u4e0d\u662f4.19\n[root@k8s-master02 ~]# uname -a\nLinux k8s-master02 4.19.12-1.el7.elrepo.x86_64 #1 SMP Fri Dec 21 11:06:36 EST 2018 x86_64 x86_64 x86_64 GNU/Linux\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u5b89\u88c5ipvsadm\u548cipset\uff1a</p> <pre><code># yum install ipvsadm ipset sysstat conntrack libseccomp -y\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6eipvs\u6a21\u5757\uff0c\u5728\u5185\u68384.19+\u7248\u672cnf_conntrack_ipv4\u5df2\u7ecf\u6539\u4e3anf_conntrack\uff0c4.18\u4ee5\u4e0b\u7248\u672c\u4f7f\u7528nf_conntrack_ipv4\u5373\u53ef\uff1a</p> <pre><code># vim /etc/modules-load.d/ipvs.conf\n# \u52a0\u5165\u4ee5\u4e0b\u5185\u5bb9\nip_vs\nip_vs_lc\nip_vs_wlc\nip_vs_rr\nip_vs_wrr\nip_vs_lblc\nip_vs_lblcr\nip_vs_dh\nip_vs_sh\nip_vs_fo\nip_vs_nq\nip_vs_sed\nip_vs_ftp\nip_vs_sh\nnf_conntrack # 4.18\u6539\u4e3anf_conntrack_ipv4\nip_tables\nip_set\nxt_set\nipt_set\nipt_rpfilter\nipt_REJECT\nipip\n</code></pre> <p>\u7136\u540e\u6267\u884c<code>systemctl enable --now systemd-modules-load.service</code>\u5373\u53ef\u3002</p> <p>\u5f00\u542f\u4e00\u4e9bK8s\u96c6\u7fa4\u4e2d\u5fc5\u9700\u7684\u5185\u6838\u53c2\u6570\uff0c\u6240\u6709\u8282\u70b9\u914d\u7f6eK8s\u5185\u6838\uff1a</p> <pre><code># cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf\nnet.ipv4.ip_forward = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nfs.may_detach_mounts = 1\nnet.ipv4.conf.all.route_localnet = 1\nvm.overcommit_memory=1\nvm.panic_on_oom=0\nfs.inotify.max_user_watches=89100\nfs.file-max=52706963\nfs.nr_open=52706963\nnet.netfilter.nf_conntrack_max=2310720\nnet.ipv4.tcp_keepalive_time = 600\nnet.ipv4.tcp_keepalive_probes = 3\nnet.ipv4.tcp_keepalive_intvl =15\nnet.ipv4.tcp_max_tw_buckets = 36000\nnet.ipv4.tcp_tw_reuse = 1\nnet.ipv4.tcp_max_orphans = 327680\nnet.ipv4.tcp_orphan_retries = 3\nnet.ipv4.tcp_syncookies = 1\nnet.ipv4.tcp_max_syn_backlog = 16384\nnet.ipv4.ip_conntrack_max = 65536\nnet.ipv4.tcp_max_syn_backlog = 16384\nnet.ipv4.tcp_timestamps = 0\nnet.core.somaxconn = 16384\nEOF\n\n# sysctl --system\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6e\u5b8c\u5185\u6838\u540e\uff0c\u91cd\u542f\u670d\u52a1\u5668\uff0c\u4fdd\u8bc1\u91cd\u542f\u540e\u5185\u6838\u4f9d\u65e7\u52a0\u8f7d\uff1a</p> <pre><code># reboot\n# lsmod | grep --color=auto -e ip_vs -e nf_conntrack\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#3-\u57fa\u672c\u7ec4\u4ef6\u5b89\u88c5","title":"3. \u57fa\u672c\u7ec4\u4ef6\u5b89\u88c5","text":"<p>\u524d\u4e24\u8282\u7684\u5b89\u88c5\u6b65\u9aa4\u548cKubeadm\u65b9\u5f0f\u5e76\u65e0\u533a\u522b\uff0c\u63a5\u4e0b\u6765\u5bf9\u4e8eKubernetes\u3001Etcd\u7b49\u7ec4\u4ef6\u7684\u5b89\u88c5\u5c06\u91c7\u7528\u4e8c\u8fdb\u5236\u6587\u4ef6\u7684\u65b9\u5f0f\u8fdb\u884c\u5b89\u88c5\u3002</p> <p>\u672c\u8282\u4e3b\u8981\u5b89\u88c5\u7684\u662f\u96c6\u7fa4\u4e2d\u7528\u5230\u7684\u5404\u79cd\u7ec4\u4ef6\uff0c\u6bd4\u5982Docker-ce\u3001Containerd\u3001Kubernetes\u7ec4\u4ef6\u7b49\u3002\u540c\u6837\uff0c\u8bfb\u8005\u53ef\u4ee5\u81ea\u884c\u9009\u62e9Containerd\u6216Docker\u4f5c\u4e3aKubernetes\u7684Runtime\u3002</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#31-containerd\u4f5c\u4e3aruntime","title":"3.1 Containerd\u4f5c\u4e3aRuntime","text":"<p>\u6240\u6709\u8282\u70b9\u5b89\u88c5docker-ce-20.10\uff1a</p> <pre><code># yum install docker-ce-20.10.* docker-ce-cli-20.10.* -y\n</code></pre> <p>\u7531\u4e8e\u5e76\u4e0d\u662f\u6bcf\u4e2a\u8282\u70b9\u90fd\u9700\u8981Docker\u5f15\u64ce\uff0c\u56e0\u6b64\u65e0\u987b\u542f\u52a8Docker\uff0c\u53ea\u9700\u8981\u914d\u7f6e\u548c\u542f\u52a8Containerd\u5373\u53ef\u3002</p> <p>\u9996\u5148\u914d\u7f6eContainerd\u6240\u9700\u7684\u6a21\u5757\uff08\u6240\u6709\u8282\u70b9\uff09\uff1a</p> <pre><code># cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf\noverlay\nbr_netfilter\nEOF\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u52a0\u8f7d\u6a21\u5757\uff1a</p> <pre><code># modprobe -- overlay\n# modprobe -- br_netfilter\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6eContainerd\u6240\u9700\u7684\u5185\u6838\uff1a</p> <pre><code># cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.ipv4.ip_forward                 = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nEOF\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u52a0\u8f7d\u5185\u6838\uff1a</p> <pre><code># sysctl --system\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6eContainerd\u7684\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code># mkdir -p /etc/containerd\n# containerd config default | tee /etc/containerd/config.toml\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u5c06Containerd\u7684Cgroup\u6539\u4e3aSystemd\uff1a</p> <pre><code># vim /etc/containerd/config.toml\n\u627e\u5230containerd.runtimes.runc.options\uff0c\u6dfb\u52a0SystemdCgroup = true\n\u6240\u6709\u8282\u70b9\u5c06sandbox_image\u7684Pause\u955c\u50cf\u6539\u6210\u7b26\u5408\u81ea\u5df1\u7248\u672c\u7684\u5730\u5740registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u542f\u52a8Containerd\uff0c\u5e76\u914d\u7f6e\u5f00\u673a\u81ea\u542f\u52a8\uff1a</p> <pre><code># systemctl daemon-reload\n# systemctl enable --now containerd\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6ecrictl\u5ba2\u6237\u7aef\u8fde\u63a5\u7684Runtime\u4f4d\u7f6e\uff1a</p> <pre><code># cat &gt; /etc/crictl.yaml &lt;&lt;EOF\nruntime-endpoint: unix:///run/containerd/containerd.sock\nimage-endpoint: unix:///run/containerd/containerd.sock\ntimeout: 10\ndebug: false\nEOF\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#32-docker\u4f5c\u4e3aruntime","title":"3.2 Docker\u4f5c\u4e3aRuntime","text":"<p>\u6240\u6709\u8282\u70b9\u5b89\u88c5docker-ce 20.10\uff1a</p> <pre><code># yum install docker-ce-20.10.* docker-ce-cli-20.10.* -y\n</code></pre> <p>\u7531\u4e8e\u65b0\u7248Kubelet\u5efa\u8bae\u4f7f\u7528systemd\uff0c\u56e0\u6b64\u628aDocker\u7684CgroupDriver\u4e5f\u6539\u6210systemd\uff1a</p> <pre><code># mkdir -p /etc/docker  # \u5982\u679c\u6ca1\u6709\u8fd9\u4e2a\u76ee\u5f55\u5148\u521b\u5efa\uff0c\u7136\u540e\u6dfb\u52a0 daemon.json \u6587\u4ef6\n# vi /etc/docker/daemon.json\n{\n\"exec-opts\": [\"native.cgroupdriver=systemd\"],\n  \"registry-mirrors\" : [\n\"https://ot2k4d59.mirror.aliyuncs.com/\"\n]\n}\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f\u52a8Docker\uff1a</p> <pre><code># systemctl daemon-reload &amp;&amp; systemctl enable --now docker\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#33-k8s\u53caetcd\u7684\u5b89\u88c5","title":"3.3 K8s\u53caEtcd\u7684\u5b89\u88c5","text":"<p>Master01\u4e0b\u8f7dKubernetes\u5b89\u88c5\u5305\uff081.22.0\u9700\u8981\u66f4\u6539\u4e3a\u6700\u65b0\u6216\u8bfb\u8005\u60f3\u8981\u5b89\u88c5\u7684\u6307\u5b9a\u7248\u672c\uff09\uff1a</p> <pre><code># wget https://dl.k8s.io/v1.22.0/kubernetes-server-linux-amd64.tar.gz\n</code></pre> <p>Master01\u4e0b\u8f7dEtcd\u5b89\u88c5\u5305\uff1a</p> <pre><code># wget https://github.com/etcd-io/etcd/releases/download/v3.5.0/etcd-v3.5.0-linux-amd64.tar.gz\n</code></pre> <p>\u89e3\u538bKubernetes\u5b89\u88c5\u6587\u4ef6\u81f3bin\u76ee\u5f55\uff1a</p> <pre><code># tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy}\n</code></pre> <p>\u89e3\u538bEtcd\u5b89\u88c5\u6587\u4ef6\u81f3bin\u76ee\u5f55\uff1a</p> <pre><code># tar -zxvf etcd-v3.5.0-linux-amd64.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.5.0-linux-amd64/etcd{,ctl}\n</code></pre> <p>\u89e3\u538b\u540e\u5373\u4e3a\u5b89\u88c5\u6210\u529f\uff0c\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u7684\u7248\u672c\uff1a</p> <pre><code># kubelet --version\nKubernetes v1.22.0\n\n# etcdctl version\netcdctl version: 3.5.0\nAPI version: 3.5\n</code></pre> <p>\u5c06\u7ec4\u4ef6\u53d1\u9001\u5230\u5176\u4ed6\u8282\u70b9\uff1a</p> <pre><code># MasterNodes='k8s-master02 k8s-master03'\n# WorkNodes='k8s-node01 k8s-node02'\n# for NODE in $MasterNodes; do echo $NODE; scp /usr/local/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy} $NODE:/usr/local/bin/; scp /usr/local/bin/etcd* $NODE:/usr/local/bin/; done\n# for NODE in $WorkNodes; do     scp /usr/local/bin/kube{let,-proxy} $NODE:/usr/local/bin/ ; done\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u521b\u5efa/opt/cni/bin\u76ee\u5f55\uff1a</p> <pre><code># mkdir -p /opt/cni/bin\n</code></pre> <p>Master01\u8282\u70b9\u5207\u6362\u52301.22.x\u5206\u652f\uff08\u5176\u4ed6\u7248\u672c\u53ef\u4ee5\u5207\u6362\u5230\u5176\u4ed6\u5206\u652f\uff0c\u4e0d\u9700\u8981\u66f4\u6539\u4e3a\u5177\u4f53\u7684\u5c0f\u7248\u672c\uff09\uff1a</p> <pre><code># cd k8s-ha-install &amp;&amp; git checkout manual-installation-v1.22.x\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#34-\u751f\u6210\u8bc1\u4e66","title":"3.4 \u751f\u6210\u8bc1\u4e66","text":"<p>\u548cKubeadm\u5b89\u88c5\u65b9\u5f0f\u4e0d\u540c\u7684\u662f\uff0c\u4e8c\u8fdb\u5236\u5b89\u88c5\u65b9\u5f0f\u9700\u8981\u81ea\u5df1\u751f\u6210\u6240\u6709\u7684\u8bc1\u4e66\uff0c\u5305\u62ecEtcd\u3001Kubernetes\u7ec4\u4ef6\u8bc1\u4e66\u3002</p> <p>\u7531\u4e8e\u8bc1\u4e66\u662f\u548cIP\u5730\u5740\u548c\u57df\u540d\u8fdb\u884c\u7ed1\u5b9a\u7684\uff0c\u56e0\u6b64\u5728\u751f\u6210\u8bc1\u4e66\u65f6\uff0c\u9700\u8981\u6ce8\u610fIP\u5730\u5740\u7b49\u76f8\u5173\u914d\u7f6e\u7684\u4fee\u6539\u3002\u672c\u793a\u4f8b\u91c7\u7528CFSSL\u5de5\u5177\u751f\u6210\u8bc1\u4e66\uff0c\u8bfb\u8005\u4e5f\u53ef\u4ee5\u4f7f\u7528OpenSSL\u7b49\u5de5\u5177\u751f\u6210\u3002</p> <p>\u7531\u4e8e\u751f\u6210\u8bc1\u4e66\u53ea\u9700\u8981\u5728Master01\u8fdb\u884c\uff0c\u56e0\u6b64\u53ea\u9700\u8981\u5728Master01\u8282\u70b9\u751f\u6210\u4e0b\u8f7dCFSSL\u5de5\u5177\u5373\u53ef\u3002Master01\u4e0b\u8f7d\u751f\u6210\u8bc1\u4e66\u5de5\u5177\uff1a</p> <pre><code># wget \"https://pkg.cfssl.org/R1.2/cfssl_linux-amd64\" -O /usr/local/bin/cfssl\n# wget \"https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64\" -O /usr/local/bin/cfssljson\n# chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#341-etcd\u8bc1\u4e66","title":"3.4.1 Etcd\u8bc1\u4e66","text":"<p>\u9996\u5148\u751f\u6210Etcd\u7684\u8bc1\u4e66\uff0c\u7531\u4e8eEtcd\u662f3\u4e2a\u8282\u70b9\u7ec4\u6210\u7684\u96c6\u7fa4\uff0c\u56e0\u6b64\u8bc1\u4e66\u9700\u8981\u5305\u542b\u6bcf\u4e2a\u8282\u70b9\u7684IP\u5730\u5740\u3002</p> <p>\u6240\u6709Master\u8282\u70b9\u521b\u5efaEtcd\u8bc1\u4e66\u76ee\u5f55\uff1a</p> <pre><code># mkdir /etc/etcd/ssl -p\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u521b\u5efaKubernetes\u76f8\u5173\u76ee\u5f55\uff0cKubernetes\u6240\u7528\u7684\u914d\u7f6e\u6587\u4ef6\u4f1a\u653e\u7f6e\u5728/etc/kubernetes\u4e0b\uff0c\u8bc1\u4e66\u6587\u4ef6\u4f1a\u653e\u7f6e\u5728/etc/kubernetes/pki\u4e0b\uff1a</p> <pre><code># mkdir -p /etc/kubernetes/pki\n</code></pre> <p>\u63a5\u4e0b\u6765\u5728Master01\u8282\u70b9\u751f\u6210Etcd\u8bc1\u4e66\uff0c\u751f\u6210\u8bc1\u4e66\u7684CSR\uff08\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\u6587\u4ef6\uff0c\u914d\u7f6e\u4e86\u4e00\u4e9b\u57df\u540d\u3001\u516c\u53f8\u3001\u5355\u4f4d\uff09\u6587\u4ef6\u5df2\u653e\u7f6e\u5728\u524d\u6587clone\u7684k8s-ha-install\uff1a</p> <pre><code># \u8fd9\u4e2a\u76ee\u5f55\u6709\u6211\u4eec\u751f\u6210\u8bc1\u4e66\u9700\u8981\u7528\u5230\u7684csr\u6587\u4ef6\n# cd /root/k8s-ha-install/pki\n#\u67e5\u770b\n[root@k8s-master01 pki]# ls\nadmin-csr.json      ca-config.json  etcd-ca-csr.json  front-proxy-ca-csr.json      kubelet-csr.json     manager-csr.json\napiserver-csr.json  ca-csr.json     etcd-csr.json     front-proxy-client-csr.json  kube-proxy-csr.json  scheduler-csr.json\n\n# \u751f\u6210etcd CA\u8bc1\u4e66\u548cCA\u8bc1\u4e66\u7684key\n# cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca\n2021/07/23 13:58:44 [INFO] generating a new CA key and certificate from CSR\n2021/07/23 13:58:44 [INFO] generate received request\n2021/07/23 13:58:44 [INFO] received CSR\n2021/07/23 13:58:44 [INFO] generating key: rsa-2048\n2021/07/23 13:58:44 [INFO] encoded CSR\n2021/07/23 13:58:44 [INFO] signed certificate with serial number 65355458767171380149641516060181865353335743374\n# \u751f\u6210tcd\u7684\u8bc1\u4e66\uff0c\u9700\u8981\u6ce8\u610f\u4fee\u6539-hostname\u7684IP\u4e3a\u81ea\u5df1\u7684IP \n# \u9881\u53d1\u8bc1\u4e66\n# cfssl gencert \\\n-ca=/etc/etcd/ssl/etcd-ca.pem \\\n-ca-key=/etc/etcd/ssl/etcd-ca-key.pem \\\n-config=ca-config.json \\\n-hostname=127.0.0.1,k8s-master01,k8s-master02,k8s-master03,10.0.0.201,10.0.0.202,10.0.0.203 \\\n-profile=kubernetes \\\netcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd\n</code></pre> <p>\u5c06\u8bc1\u4e66\u590d\u5236\u5230\u5176\u4ed6Master\u8282\u70b9\uff1a</p> <pre><code># MasterNodes='k8s-master02 k8s-master03'\n# WorkNodes='k8s-node01 k8s-node02'\n# for NODE in $MasterNodes; do\nssh $NODE \"mkdir -p /etc/etcd/ssl\"\nfor FILE in etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem; do\nscp /etc/etcd/ssl/${FILE} $NODE:/etc/etcd/ssl/${FILE}\ndone\ndone\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#342-k8s\u7ec4\u4ef6\u8bc1\u4e66","title":"3.4.2 K8s\u7ec4\u4ef6\u8bc1\u4e66","text":"<p>\u76f8\u8f83\u4e8eEtcd\u7684\u8bc1\u4e66\uff0cKubernetes\u7684\u8bc1\u4e66\u66f4\u4e3a\u590d\u6742\uff0c\u56e0\u4e3aKubernetes\u8981\u6c42\u7ec4\u4ef6\u4e4b\u95f4\u53cc\u5411\u52a0\u5bc6\u901a\u4fe1\uff0c\u6240\u4ee5\u751f\u6210Kubernetes\u7684\u7ec4\u4ef6\u4f1a\u6d89\u53ca\u6bcf\u4e2a\u7ec4\u4ef6\u4e4b\u95f4\u901a\u4fe1\u7684\u8bc1\u4e66\uff0c\u540c\u65f6\u4e5f\u4f1a\u5305\u542b\u4e00\u4e9b\u805a\u5408\u8bc1\u4e66\u3002</p> <p>\u9996\u5148\u5728Master01\u8282\u70b9\u751f\u6210Kubernetes\u7684\u6839\u8bc1\u4e66\uff0c\u4e4b\u540e\u5176\u4ed6\u8bc1\u4e66\u90fd\u662f\u6839\u636e\u8be5\u8bc1\u4e66\u6765\u751f\u6210\u7684\uff1a</p> <pre><code># cd /root/k8s-ha-install/pki\n# cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca\n</code></pre> <p>\u63a5\u4e0b\u6765\u751f\u6210kube-apiserver\u7684\u8bc1\u4e66\uff0c\u9700\u8981\u6ce8\u610f\u66f4\u6539\u5982\u4e0b\u914d\u7f6e\uff1a</p> <ul> <li>192.168.0.\u662fKubernetes Service\u7684\u7f51\u6bb5\uff0c\u5982\u679c\u9700\u8981\u66f4\u6539Kubernetes Service\u7f51\u6bb5\uff0c\u90a3\u5c31\u9700\u8981\u628a192.168.0.1\u66f4\u6539\u4e3aService\u7f51\u6bb5\u7684\u7b2c\u4e00\u4e2aIP\u3002</li> <li>10.0.0.236\u4e3a\u9ad8\u53ef\u7528\u96c6\u7fa4\u7684VIP\u5730\u5740\uff0c\u9700\u8981\u6539\u6210\u8bfb\u8005\u81ea\u5df1\u7684VIP\u5730\u5740\u6216\u8005\u5176\u4ed6\u8d1f\u8f7d\u5747\u8861\u7684\u5730\u5740\uff0c\u5982\u679c\u662f\u5355Master\u7684\u96c6\u7fa4\uff0c\u76f4\u63a5\u6539\u4e3aMaster\u8282\u70b9IP\u5373\u53ef\u3002</li> <li>10.0.0.201-203\u4e3aKubernetes Master\u8282\u70b9\u7684IP\u5730\u5740\uff0c\u9700\u8981\u66f4\u6539\u4e3a\u8bfb\u8005\u7684\u8282\u70b9IP\u3002</li> </ul> <pre><code># cfssl gencert   -ca=/etc/kubernetes/pki/ca.pem   \\\n-ca-key=/etc/kubernetes/pki/ca-key.pem   \\\n-config=ca-config.json   \\\n-hostname=192.168.0.1,10.0.0.236,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc, \\\nkubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,10.0.0.201,10.0.0.202,10.0.0.203   \\\n-profile=kubernetes   apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver\n</code></pre> <p>\u751f\u6210\u805a\u5408\u8bc1\u4e66\uff0c\u7528\u4e8e\u6269\u5c55\u7684CRD\u8bf7\u6c42\u9a8c\u8bc1\uff0c\u6bd4\u5982metrics-server\u7684metrics.k8s.io\u548capiserver\u8fdb\u884c\u901a\u4fe1\u65f6\u5c31\u4f1a\u4f7f\u7528\u5230\u8be5\u8bc1\u4e66\uff1a</p> <pre><code># cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca \n# cfssl gencert   -ca=/etc/kubernetes/pki/front-proxy-ca.pem   -ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem   -config=ca-config.json   -profile=kubernetes   front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client\n</code></pre> <p>\u540c\u6837\u7684\u65b9\u5f0f\u751f\u6210controller-manage\u7684\u8bc1\u4e66\uff0c\u4f7f\u7528\u7684\u8fd8\u662f\u6700\u521d\u7684CA\u6587\u4ef6\uff1a</p> <pre><code># cfssl gencert \\\n-ca=/etc/kubernetes/pki/ca.pem \\\n-ca-key=/etc/kubernetes/pki/ca-key.pem \\\n-config=ca-config.json \\\n-profile=kubernetes \\\nmanager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager\n\n# \u6ce8\u610f\uff0c\u5982\u679c\u4e0d\u662f\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0c10.0.0.236:16443\u6539\u4e3amaster01\u7684\u5730\u5740\uff0c6443\u6539\u4e3aapiserver\u7684\u7aef\u53e3\uff0c\u9ed8\u8ba4\u662f6443\n# set-cluster\uff1a\u8bbe\u7f6e\u4e00\u4e2a\u96c6\u7fa4\u9879\n# kubectl config set-cluster kubernetes \\\n--certificate-authority=/etc/kubernetes/pki/ca.pem \\\n--embed-certs=true \\\n--server=https://10.0.0.236:16443\\\n--kubeconfig=/etc/kubernetes/controller-manager.kubeconfig\n\n# set-credentials \u8bbe\u7f6e\u4e00\u4e2a\u7528\u6237\u9879\n# kubectl config set-credentials system:kube-controller-manager \\\n--client-certificate=/etc/kubernetes/pki/controller-manager.pem \\\n--client-key=/etc/kubernetes/pki/controller-manager-key.pem \\\n--embed-certs=true \\\n--kubeconfig=/etc/kubernetes/controller-manager.kubeconfig\n\n# \u8bbe\u7f6e\u4e00\u4e2a\u73af\u5883\u9879\uff0c\u4e00\u4e2a\u4e0a\u4e0b\u6587\n# kubectl config set-context system:kube-controller-manager@kubernetes \\\n--cluster=kubernetes \\\n--user=system:kube-controller-manager \\\n--kubeconfig=/etc/kubernetes/controller-manager.kubeconfig\n\n# \u4f7f\u7528\u67d0\u4e2a\u73af\u5883\u5f53\u505a\u9ed8\u8ba4\u73af\u5883\n# kubectl config use-context system:kube-controller-manager@kubernetes \\\n--kubeconfig=/etc/kubernetes/controller-manager.kubeconfig\n</code></pre> <p>\u540c\u6837\u7684\u903b\u8f91\u751f\u6210scheduler\u7684\u8bc1\u4e66\uff0c\u53c2\u6570\u4e0d\u518d\u89e3\u91ca\uff1a</p> <pre><code># cfssl gencert \\\n-ca=/etc/kubernetes/pki/ca.pem \\\n-ca-key=/etc/kubernetes/pki/ca-key.pem \\\n-config=ca-config.json \\\n-profile=kubernetes \\\nscheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler\n\n# \u6ce8\u610f\uff0c\u5982\u679c\u4e0d\u662f\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0c10.0.0.236:16443\u6539\u4e3amaster01\u7684\u5730\u5740\uff0c6443\u6539\u4e3aapiserver\u7684\u7aef\u53e3\uff0c\u9ed8\u8ba4\u662f6443\n# kubectl config set-cluster kubernetes \\\n--certificate-authority=/etc/kubernetes/pki/ca.pem \\\n--embed-certs=true \\\n--server=https://10.0.0.236:16443 \\\n--kubeconfig=/etc/kubernetes/scheduler.kubeconfig\n\n# kubectl config set-credentials system:kube-scheduler \\\n--client-certificate=/etc/kubernetes/pki/scheduler.pem \\\n--client-key=/etc/kubernetes/pki/scheduler-key.pem \\\n--embed-certs=true \\\n--kubeconfig=/etc/kubernetes/scheduler.kubeconfig\n\n# kubectl config set-context system:kube-scheduler@kubernetes \\\n--cluster=kubernetes \\\n--user=system:kube-scheduler \\\n--kubeconfig=/etc/kubernetes/scheduler.kubeconfig\n\n# kubectl config use-context system:kube-scheduler@kubernetes \\\n--kubeconfig=/etc/kubernetes/scheduler.kubeconfig\n</code></pre> <p>\u81f3\u6b64\uff0cKubernetes Master\u8282\u70b9\u7684\u7ec4\u4ef6\u8bc1\u4e66\u5df2\u7ecf\u914d\u7f6e\u5b8c\u6210\u3002\u63a5\u4e0b\u6765\u9700\u8981\u751f\u6210\u4e00\u4e2aKubectl\u8fde\u63a5API Server\u7684kubeconfig\u3002</p> <p>\u4f7f\u7528Kubeadm\u5b89\u88c5\u7684Kubernetes\u96c6\u7fa4\uff0cKubectl\u8fde\u63a5API Server\u7528\u5230\u7684kubeconfig\u6587\u4ef6\u4e3a/etc/kubernetes/admin.conf\uff0c\u7531Kubeadm\u81ea\u52a8\u751f\u6210\u3002</p> <p>\u4f7f\u7528\u4e8c\u8fdb\u5236\u5b89\u88c5\u65b9\u5f0f\u9700\u8981\u624b\u52a8\u751f\u6210\uff0c\u751f\u6210\u6b65\u9aa4\u4e0e\u4e0a\u8ff0\u65b9\u5f0f\u7c7b\u4f3c\u3002\u9996\u5148\u751f\u6210\u7ba1\u7406\u5458\u7528\u6237\u7684\u8bc1\u4e66\u6587\u4ef6\uff1a</p> <pre><code># cfssl gencert \\\n-ca=/etc/kubernetes/pki/ca.pem \\\n-ca-key=/etc/kubernetes/pki/ca-key.pem \\\n-config=ca-config.json \\\n-profile=kubernetes \\\nadmin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin\n</code></pre> <p>\u63a5\u4e0b\u6765\u751f\u6210kubeconfig\u6587\u4ef6\u3002\u6ce8\u610f\uff0c\u5982\u679c\u4e0d\u662f\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0c\u628aMaster\u7684\u5730\u5740\u6539\u4e3a10.0.0.236:16443\uff0c\u628aAPI Server\u7684\u7aef\u53e3\u6539\u4e3a16443\uff0c\u9ed8\u8ba4\u662f6443\uff1a</p> <pre><code># kubectl config set-cluster kubernetes     \\ \n--certificate-authority=/etc/kubernetes/pki/ca.pem     \\ \n--embed-certs=true     \\ \n--server=https://10.0.0.236:16443    \\\n--kubeconfig=/etc/kubernetes/admin.kubeconfig\n\n# kubectl config set-credentials kubernetes-admin     \\\n--client-certificate=/etc/kubernetes/pki/admin.pem     \\\n--client-key=/etc/kubernetes/pki/admin-key.pem     \\\n--embed-certs=true     \\\n--kubeconfig=/etc/kubernetes/admin.kubeconfig\n\n# kubectl config set-context kubernetes-admin@kubernetes     \\\n--cluster=kubernetes     \\\n--user=kubernetes-admin     \\\n--kubeconfig=/etc/kubernetes/admin.kubeconfig\n\n# kubectl config use-context kubernetes-admin@kubernetes     \\\n--kubeconfig=/etc/kubernetes/admin.kubeconfig\n</code></pre> <p>\u751f\u6210\u7528\u4e8e\u521b\u5efaServiceAccount Secret Token\u548c\u9a8c\u8bc1Token\u7684\u5bc6\u94a5\u5bf9\uff1a</p> <pre><code># openssl genrsa -out /etc/kubernetes/pki/sa.key 2048\n# openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub\n</code></pre> <p>\u6240\u6709\u7684\u8bc1\u4e66\u7b7e\u53d1\u5b8c\u6210\u540e\uff0c\u9700\u8981\u5c06\u8bc1\u4e66\u53d1\u9001\u81f3\u5176\u4ed6\u8282\u70b9\uff1a</p> <pre><code># for NODE in k8s-master02 k8s-master03; do\nfor FILE in $(ls /etc/kubernetes/pki | grep -v etcd); do\nscp /etc/kubernetes/pki/${FILE} $NODE:/etc/kubernetes/pki/${FILE};\ndone;\nfor FILE in admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig; do\nscp /etc/kubernetes/${FILE} $NODE:/etc/kubernetes/${FILE};\ndone;\ndone\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#35-\u9ad8\u53ef\u7528\u914d\u7f6e","title":"3.5 \u9ad8\u53ef\u7528\u914d\u7f6e","text":"<p>\u548cKubeadm\u5b89\u88c5\u65b9\u5f0f\u4e00\u81f4\uff0c\u4e8c\u8fdb\u5236\u5b89\u88c5\u65b9\u5f0f\u4ecd\u7136\u91c7\u7528\u7684\u662fKeepAlived\u548cHAProxy\u5b9e\u73b0\u7684\u9ad8\u53ef\u7528\uff0c\u6240\u4ee5\u9700\u8981\u5b89\u88c5KeepAlived\u548cHAProxy\u3002</p> <p>KeepAlived\u548cHAProxy\u7684\u8282\u70b9\u53ef\u4ee5\u548cMaster\u5728\u540c\u4e00\u4e2a\u8282\u70b9\uff0c\u4e5f\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u8282\u70b9\u3002</p> <p>\u5982\u679c\u8bfb\u8005\u662f\u5728\u516c\u6709\u4e91\u4e0a\u642d\u5efa\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0c\u53ef\u4ee5\u91c7\u7528\u516c\u6709\u4e91\u7684\u8d1f\u8f7d\u5747\u8861\u66ff\u4ee3KeepAlived\u548cHAProxy\u3002</p> <p>\u63d0\u793a</p> <p>\u5982\u679c\u8bfb\u8005\u60f3\u8981\u642d\u5efa\u53ea\u6709\u4e00\u4e2aMaster\u8282\u70b9\u7684\u96c6\u7fa4\uff0c\u53ef\u4ee5\u4e0d\u5b89\u88c5\u9ad8\u53ef\u7528\u7ec4\u4ef6\u3002</p> <p>\u5b89\u88c5\u6b65\u9aa4\u8bf7\u53c2\u8003\u672c\u4e66\u7b2c1\u7ae0\u3002</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#36-etcd\u96c6\u7fa4\u914d\u7f6e","title":"3.6 Etcd\u96c6\u7fa4\u914d\u7f6e","text":"<p>Etcd\u662fKubernetes\u7684\u6570\u636e\u5e93\uff0c\u751f\u4ea7\u73af\u5883\u6700\u5c11\u91c7\u75283\u4e2a\u4ee5\u4e0a\u8282\u70b9\u5b9e\u73b0\u9ad8\u53ef\u7528\uff0c\u5e76\u4e14\u8282\u70b9\u6570\u5fc5\u987b\u4e3a\u5947\u6570\u4e2a\u3002</p> <p>Etcd\u7684\u914d\u7f6e\u5927\u81f4\u76f8\u540c\uff0c\u4e3b\u8981\u662f\u6bcf\u4e2aMaster\u8282\u70b9\u7684Etcd\u914d\u7f6e\u7684\u4e3b\u673a\u540d\u548cIP\u5730\u5740\u3002</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#361-\u521b\u5efaetcd\u7684\u914d\u7f6e\u6587\u4ef6","title":"3.6.1 \u521b\u5efaEtcd\u7684\u914d\u7f6e\u6587\u4ef6","text":"<p>\u8fd9\u91cc\u5c06Etcd\u548cKubernetes Master\u8282\u70b9\u90e8\u7f72\u5728\u540c\u4e00\u53f0\u673a\u5668\uff0c\u5982\u679c\u8bfb\u8005\u9700\u8981\u5c06Etcd\u548cMaster\u8282\u70b9\u62c6\u5206\u6210\u4e0d\u540c\u7684\u670d\u52a1\u5668\uff0c\u53ea\u9700\u8981\u66f4\u6539\u5bf9\u5e94\u7684IP\u5730\u5740\u5373\u53ef\u3002</p> <p>3\u4e2a\u8282\u70b9\u7684Etcd\u914d\u7f6e\u5927\u81f4\u76f8\u540c\uff0c\u4e3b\u8981\u6d89\u53ca\u5982\u4e0b\u53c2\u6570\u9700\u8981\u4fee\u6539\uff08\u5b8c\u6574\u6587\u4ef6\u89c1\u672c\u4e66\u4e0b\u8f7d\u8d44\u6e90\uff09\uff1a</p> <p>vim /etc/etcd/etcd.config.yml </p> <p>\u81ea\u884c\u66f4\u6539\u76f8\u5173\u914d\u7f6e</p> <pre><code>name: 'k8s-master01'\ndata-dir: /var/lib/etcd\nwal-dir: /var/lib/etcd/wal\nsnapshot-count: 5000\nheartbeat-interval: 100\nelection-timeout: 1000\nquota-backend-bytes: 0\nlisten-peer-urls: 'https://10.103.236.201:2380'\nlisten-client-urls: 'https://10.103.236.201:2379,http://127.0.0.1:2379'\nmax-snapshots: 3\nmax-wals: 5\ncors:\ninitial-advertise-peer-urls: 'https://10.103.236.201:2380'\nadvertise-client-urls: 'https://10.103.236.201:2379'\ndiscovery:\ndiscovery-fallback: 'proxy'\ndiscovery-proxy:\ndiscovery-srv:\ninitial-cluster: 'k8s-master01=https://10.103.236.201:2380,k8s-master02=https://10.103.236.202:2380,k8s-master03=https://10.103.236.203:2380'\ninitial-cluster-token: 'etcd-k8s-cluster'\ninitial-cluster-state: 'new'\nstrict-reconfig-check: false\nenable-v2: true\nenable-pprof: true\nproxy: 'off'\nproxy-failure-wait: 5000\nproxy-refresh-interval: 30000\nproxy-dial-timeout: 1000\nproxy-write-timeout: 5000\nproxy-read-timeout: 0\nclient-transport-security:\n  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'\n  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'\n  client-cert-auth: true\n  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'\n  auto-tls: true\npeer-transport-security:\n  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'\n  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'\n  peer-client-cert-auth: true\n  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'\n  auto-tls: true\ndebug: false\nlog-package-levels:\nlog-outputs: [default]\nforce-new-cluster: false\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#362-\u521b\u5efaservice","title":"3.6.2 \u521b\u5efaService","text":"<p>\u63a5\u4e0b\u6765\u5728\u6bcf\u4e2aMaster\u8282\u70b9\u521b\u5efaEtcd Service\u5e76\u542f\u52a8\uff1a</p> <pre><code># vim /usr/lib/systemd/system/etcd.service\n[Unit]\nDescription=Etcd Service\nDocumentation=https://coreos.com/etcd/docs/latest/\nAfter=network.target\n\n[Service]\nType=notify\nExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml\nRestart=on-failure\nRestartSec=10\nLimitNOFILE=65536\n[Install]\nWantedBy=multi-user.target\nAlias=etcd3.service\n</code></pre> <p>\u6240\u6709Master\u8282\u70b9\u521b\u5efaEtcd\u7684\u8bc1\u4e66\u76ee\u5f55\uff1a</p> <pre><code># mkdir /etc/kubernetes/pki/etcd\n# ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/\n# systemctl daemon-reload\n# systemctl enable --now etcd\n</code></pre> <p>\u67e5\u770bEtcd\u96c6\u7fa4\u72b6\u6001\uff1a</p> <pre><code># export ETCDCTL_API=3\n# etcdctl --endpoints=\"10.0.0.201:2379,10.0.0.202:2379,10.0.0.203:2379\" --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table\n+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n|      ENDPOINT      |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |\n+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n| 10.0.0.203:2379 | d47768538fbe6e4f |  3.4.13 |   20 kB |      true |      false |         3 |          9 |                  9 |        |\n| 10.0.0.202:2379 | 84a44ce3d2a87a83 |  3.4.13 |   20 kB |     false |      false |         3 |          9 |                  9 |        |\n| 10.0.0.201:2379 | 5a8e242cc814d239 |  3.4.13 |   20 kB |     false |      false |         3 |          9 |                  9 |        |\n+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#37-k8s-master\u8282\u70b9\u914d\u7f6e","title":"3.7 K8s Master\u8282\u70b9\u914d\u7f6e","text":"<p>\u63a5\u4e0b\u6765\u5728Master\u8282\u70b9\u5b89\u88c5APIServer\u3001Controller Manager\u3001Scheduler\u7ec4\u4ef6\u3002</p> <p>\u9996\u5148\u5728\u6240\u6709\u8282\u70b9\u521b\u5efa\u76f8\u5173\u76ee\u5f55\uff1a</p> <pre><code># mkdir -p /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#371-apiserver","title":"3.7.1 APIServer","text":"<p>\u9996\u5148\u914d\u7f6eAPIServer\uff0c\u6bcf\u4e2a\u8282\u70b9\u7684\u914d\u7f6e\u5927\u81f4\u76f8\u540c\uff0c\u6ce8\u610f\u4fee\u6539\u7684\u5730\u65b9\u5982\u4e0b\uff08\u5b8c\u6574\u6587\u4ef6\u89c1\u672c\u4e66\u4e0b\u8f7d\u8d44\u6e90\uff09\uff1a</p> <p>vim /usr/lib/systemd/system/kube-apiserver.service </p> <p>\u914d\u7f6e\u81ea\u884c\u66f4\u6539</p> <pre><code>[Unit]\nDescription=Kubernetes API Server\nDocumentation=https://github.com/kubernetes/kubernetes\nAfter=network.target\n\n[Service]\nExecStart=/usr/local/bin/kube-apiserver \\\n--v=2  \\\n--logtostderr=true  \\\n--allow-privileged=true  \\\n--bind-address=0.0.0.0  \\\n--secure-port=6443  \\\n--insecure-port=0  \\\n--advertise-address=10.103.236.201 \\\n--service-cluster-ip-range=192.168.0.0/16  \\\n--service-node-port-range=30000-32767  \\\n--etcd-servers=https://10.103.236.201:2379,https://10.103.236.202:2379,https://10.103.236.203:2379 \\\n--etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\\n--etcd-certfile=/etc/etcd/ssl/etcd.pem  \\\n--etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\\n--client-ca-file=/etc/kubernetes/pki/ca.pem  \\\n--tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\\n--tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\\n--kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\\n--kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\\n--service-account-key-file=/etc/kubernetes/pki/sa.pub  \\\n--service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\\n--service-account-issuer=https://kubernetes.default.svc.cluster.local \\\n--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\\n--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \\\n--authorization-mode=Node,RBAC  \\\n--enable-bootstrap-token-auth=true  \\\n--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\\n--proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\\n--proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\\n--requestheader-allowed-names=aggregator  \\\n--requestheader-group-headers=X-Remote-Group  \\\n--requestheader-extra-headers-prefix=X-Remote-Extra-  \\\n--requestheader-username-headers=X-Remote-User\n      # --token-auth-file=/etc/kubernetes/token.csv\nRestart=on-failure\nRestartSec=10s\nLimitNOFILE=65535\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>Service\u6587\u4ef6\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6240\u6709Master\u8282\u70b9\u542f\u52a8kube-apiserver\uff1a</p> <pre><code># systemctl daemon-reload &amp;&amp; systemctl enable --now kube-apiserver\n</code></pre> <p>\u68c0\u6d4bAPIServer\u72b6\u6001\uff1a</p> <pre><code># systemctl status kube-apiserver\n\u25cf kube-apiserver.service - Kubernetes API Server\n   Loaded: loaded (/usr/lib/systemd/system/kube-apiserver.service; enabled; vendor preset: disabled)\nActive: active (running) since Fri 2021-07-23 16:23:47 CST; 10s ago\n     Docs: https://github.com/kubernetes/kubernetes\n Main PID: 10956 (kube-apiserver)\nTasks: 13\nMemory: 302.4M\n   CGroup: /system.slice/kube-apiserver.service\n           \u2514\u250010956 /usr/local/bin/kube-apiserver --v=2 --logtostderr=true --allow-privileged=true --bind-address=0.0.0.0 --secure-port=64...\n\nJul 23 16:23:54 k8s-master01 kube-apiserver[10956]: I0723 16:23:54.176533   10956 storage_rbac.go:331] created rolebinding.rbac.aut...system\nJul 23 16:23:54 k8s-master01 kube-apiserver[10956]: I0723 16:23:54.185158   10956 storage_rbac.go:331] created rolebinding.rbac.aut...system\nJul 23 16:23:54 k8s-master01 kube-apiserver[10956]: I0723 16:23:54.190144   10956 healthz.go:257] poststarthook/rbac/bootstrap-role...readyz\nJul 23 16:23:54 k8s-master01 kube-apiserver[10956]: [-]poststarthook/rbac/bootstrap-roles failed: not finished\nJul 23 16:23:54 k8s-master01 kube-apiserver[10956]: I0723 16:23:54.192942   10956 storage_rbac.go:331] created rolebinding.rbac.aut...system\nJul 23 16:23:54 k8s-master01 kube-apiserver[10956]: I0723 16:23:54.201305   10956 storage_rbac.go:331] created rolebinding.rbac.aut...system\nJul 23 16:23:54 k8s-master01 kube-apiserver[10956]: I0723 16:23:54.209273   10956 storage_rbac.go:331] created rolebinding.rbac.aut...public\nJul 23 16:23:54 k8s-master01 kube-apiserver[10956]: W0723 16:23:54.322312   10956 lease.go:233] Resetting endpoints for master serv...2.212]\nJul 23 16:23:54 k8s-master01 kube-apiserver[10956]: I0723 16:23:54.323449   10956 controller.go:611] quota admission added evaluato...points\nJul 23 16:23:54 k8s-master01 kube-apiserver[10956]: I0723 16:23:54.334503   10956 controller.go:611] quota admission added evaluato...k8s.io\nHint: Some lines were ellipsized, use -l to show in full.\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#372-controller-manager","title":"3.7.2 Controller Manager","text":"<p>\u91c7\u7528\u540c\u6837\u7684\u6d41\u7a0b\u914d\u7f6eController Manager\uff0c\u4e0d\u540c\u7684\u662fController Manager\u7684Service\u90fd\u662f\u4e00\u6837\u7684\u3002</p> <p>\u6240\u6709Master\u8282\u70b9\u914d\u7f6ekube-controller-manager Service\uff08\u5b8c\u6574\u6587\u4ef6\u89c1\u672c\u4e66\u4e0b\u8f7d\u8d44\u6e90):</p> <p>vim /usr/lib/systemd/system/kube-controller-manager.service </p> <p>\u914d\u7f6e\u81ea\u884c\u66f4\u6539</p> <pre><code>[Unit]\nDescription=Kubernetes Controller Manager\nDocumentation=https://github.com/kubernetes/kubernetes\nAfter=network.target\n\n[Service]\nExecStart=/usr/local/bin/kube-controller-manager \\\n--v=2 \\\n--logtostderr=true \\\n--address=127.0.0.1 \\\n--root-ca-file=/etc/kubernetes/pki/ca.pem \\\n--cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \\\n--cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \\\n--service-account-private-key-file=/etc/kubernetes/pki/sa.key \\\n--kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \\\n--leader-elect=true \\\n--use-service-account-credentials=true \\\n--node-monitor-grace-period=40s \\\n--node-monitor-period=5s \\\n--pod-eviction-timeout=2m0s \\\n--controllers=*,bootstrapsigner,tokencleaner \\\n--allocate-node-cidrs=true \\\n--cluster-cidr=172.16.0.0/12 \\\n--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \\\n--node-cidr-mask-size=24\nRestart=always\nRestartSec=10s\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>\u6240\u6709Master\u8282\u70b9\u542f\u52a8kube-controller-manager</p> <pre><code># systemctl daemon-reload\n# systemctl enable --now kube-controller-manager\n</code></pre> <p>\u67e5\u770b\u542f\u52a8\u72b6\u6001</p> <pre><code># systemctl status kube-controller-manager\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#373-scheduler","title":"3.7.3 Scheduler","text":"<p>\u548cController Manager\u4e00\u81f4\uff0c\u6bcf\u4e2aMaster\u8282\u70b9\u7684Service\u90fd\u662f\u4e00\u6837\u7684\u3002</p> <p>\u6240\u6709Master\u8282\u70b9\u914d\u7f6ekube-scheduler service\uff08\u5b8c\u6574\u6587\u4ef6\u89c1\u672c\u4e66\u4e0b\u8f7d\u8d44\u6e90\uff09\uff1a</p> <p>vim /usr/lib/systemd/system/kube-scheduler.service </p> <pre><code>[Unit]\nDescription=Kubernetes Scheduler\nDocumentation=https://github.com/kubernetes/kubernetes\nAfter=network.target\n\n[Service]\nExecStart=/usr/local/bin/kube-scheduler \\\n--v=2 \\\n--logtostderr=true \\\n--address=127.0.0.1 \\\n--leader-elect=true \\\n--kubeconfig=/etc/kubernetes/scheduler.kubeconfig\n\nRestart=always\nRestartSec=10s\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>\u542f\u52a8Scheduler\uff1a</p> <pre><code># systemctl daemon-reload\n# systemctl enable --now kube-scheduler\n</code></pre> <p>\u67e5\u770b\u542f\u52a8\u72b6\u6001</p> <pre><code># systemctl  status kube-scheduler\n</code></pre> <p>\u81f3\u6b64\uff0cKubernetes Master\u8282\u70b9\u7ec4\u4ef6\u548cEtcd\u5747\u5df2\u7ecf\u914d\u7f6e\u5b8c\u6210\uff0c\u8bfb\u8005\u53ef\u4ee5\u67e5\u770b\u7cfb\u7edf\u65e5\u5fd7\uff08CentOS\u4e3a/var/log/messages\uff0cUbuntu\u4e3a/var/log/syslog\uff09\u6709\u65e0\u62a5\u9519\u65e5\u5fd7\u3002</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#38-tls-bootstrapping\u914d\u7f6e","title":"3.8 TLS Bootstrapping\u914d\u7f6e","text":"<p>\u76f8\u5bf9\u4e8eMaster\u8282\u70b9\uff0c\u5de5\u4f5c\u8282\u70b9\u7684\u52a8\u6001\u6027\u76f8\u5bf9\u6bd4\u8f83\u7075\u6d3b\u3002</p> <p>\u5728\u7ef4\u62a4\u96c6\u7fa4\u65f6\uff0c\u7ecf\u5e38\u4f1a\u589e\u5220\u5de5\u4f5c\u8282\u70b9\uff0c\u5982\u679c\u50cf\u63a7\u5236\u8282\u70b9\u7684\u7ec4\u4ef6\u4e00\u6837\u53bb\u7ba1\u7406\u5de5\u4f5c\u8282\u70b9\u7ec4\u4ef6Kubelet\u7684\u8bc1\u4e66\uff0c\u4f1a\u663e\u5f97\u6bd4\u8f83\u9ebb\u70e6\uff0c\u5e76\u4e14\u5bb9\u6613\u51fa\u9519\uff0c\u6240\u4ee5\u672c\u8282\u5c06\u5728\u96c6\u7fa4\u4e2d\u914d\u7f6eBootstrapping\uff0cBootstrapping\u4f1a\u81ea\u52a8\u4e3a\u5de5\u4f5c\u8282\u70b9\u7684Kubelet\u9881\u53d1\u8bc1\u4e66\uff0c\u5373\u751f\u6210kubelet.kubeconfig\u6587\u4ef6\u3002</p> <p>\u6ce8\u610f</p> <p>\u63a5\u4e0b\u6765\u7684\u547d\u4ee4\uff0c\u5982\u679c\u4e0d\u662f\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0c\u628aMaster\u7684\u5730\u5740\u6539\u4e3a10.0.0.236:16443\uff0c\u628aAPI Server\u7684\u7aef\u53e3\u6539\u4e3a16443\uff0c\u9ed8\u8ba4\u662f6443</p> <p>kubectl\u547d\u4ee4\u53ea\u5728Master01\u8282\u70b9\u6267\u884c\u4e00\u6b21\u3002\u63a5\u4e0b\u6765\u5728Master01\u8282\u70b9\u521b\u5efabootstrap\u6240\u7528\u7684\u6743\u9650\uff08\u914d\u7f6eBootstrap\u7684kubeconfig\u548c2.4\u8282\u7c7b\u4f3c\uff09\uff1a</p> <pre><code># cd /root/k8s-ha-install/bootstrap\n# kubectl config set-cluster kubernetes     \\\n--certificate-authority=/etc/kubernetes/pki/ca.pem     \\\n--embed-certs=true     \\\n--server=https://10.0.0.236:16443     \\\n--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig\n\n# kubectl config set-credentials tls-bootstrap-token-user     \\\n--token=c8ad9c.2e4d610cf3e7426e \\\n--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig\n\n# kubectl config set-context tls-bootstrap-token-user@kubernetes     \\\n--cluster=kubernetes     \\\n--user=tls-bootstrap-token-user     \\\n--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig\n\n# kubectl config use-context tls-bootstrap-token-user@kubernetes     \\\n--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig\n</code></pre> <p>bootstrap-kubelet.kubeconfig \u662f\u4e00\u4e2a keepalived \u7528\u6765\u5411 apiserver \u7533\u8bf7\u8bc1\u4e66\u7684\u6587\u4ef6</p> <p>\u6ce8\u610f\uff1a\u5982\u679c\u8981\u4fee\u6539bootstrap.secret.yaml\u7684token-id\u548ctoken-secret\uff0c\u9700\u8981\u4fdd\u8bc1 c8ad9c \u5b57\u7b26\u4e32\u4e00\u81f4\u7684\uff0c\u5e76\u4e14\u4f4d\u6570\u662f\u4e00\u6837\u7684\u3002</p> <p>\u8fd8\u8981\u4fdd\u8bc1\u4e0a\u4e2a\u547d\u4ee4\u7684\u9ec4\u8272\u5b57\u4f53\uff1ac8ad9c.2e4d610cf3e7426e\u4e0e\u4f60\u4fee\u6539\u7684\u5b57\u7b26\u4e32\u8981\u4e00\u81f4</p> <pre><code># cat bootstrap.secret.yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: bootstrap-token-c8ad9c\n  namespace: kube-system\ntype: bootstrap.kubernetes.io/token\nstringData:\n  description: \"The default bootstrap token generated by 'kubelet '.\"\ntoken-id: c8ad9c\n  token-secret: 2e4d610cf3e7426e\n  usage-bootstrap-authentication: \"true\"\nusage-bootstrap-signing: \"true\"\nauth-extra-groups:  system:bootstrappers:default-node-token,system:bootstrappers:worker,system:bootstrappers:ingress\n</code></pre> <p>\u524d\u6587\u63d0\u5230\uff0cadmin.kubeconfig\u662fKubectl\u64cd\u4f5c\u96c6\u7fa4\u6240\u7528\u7684\u8bc1\u4e66\uff0c\u5c06\u8be5\u6587\u4ef6\u590d\u5236\u5230/root/.kube/config\uff0cKubectl\u5373\u53ef\u9ed8\u8ba4\u4f7f\u7528\u8be5\u6587\u4ef6\u8fde\u63a5\u96c6\u7fa4\uff1a</p> <pre><code># mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config\n</code></pre> <p>\u63a5\u4e0b\u6765\u521b\u5efaBootstrapping\u6240\u7528\u7684\u6743\u9650\uff1a</p> <pre><code># kubectl create -f bootstrap.secret.yaml\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#39-node\u8282\u70b9\u914d\u7f6e","title":"3.9 Node\u8282\u70b9\u914d\u7f6e","text":"<p>\u524d\u9762\u5df2\u7ecf\u628a\u6240\u6709Master\u8282\u70b9\u7ec4\u4ef6\u5b89\u88c5\u5b8c\u6210\uff0c\u5e76\u4e14\u914d\u7f6e\u4e86Bootstrapping\u81ea\u52a8\u4e3aNode\u8282\u70b9\u7b7e\u53d1\u8bc1\u4e66\uff0c\u6240\u4ee5Node\u8282\u70b9\u7684Kubelet\u8bc1\u4e66\uff08kubelet.kubeconfig\uff09\u4e0d\u9700\u8981\u518d\u624b\u52a8\u914d\u7f6e\uff0c\u53ef\u4ee5\u91c7\u7528Bootstrap\u81ea\u52a8\u751f\u6210\u3002</p> <p>\u4f46\u662f\u6709\u4e00\u4e9b\u8bc1\u4e66\u8fd8\u662f\u9700\u8981\u624b\u52a8\u53d1\u9001\u5230Node\u8282\u70b9\uff0c\u6bd4\u5982\u8bf7\u6c42kubelet.kubeconfig\u8bc1\u4e66\u7684bootstrap.kubeconfig\u8bc1\u4e66\u7b49\u3002Master01\u8282\u70b9\u5c06Node\u8282\u70b9\u6240\u7528\u7684\u8bc1\u4e66\u590d\u5236\u5230\u5404\u4e2aNode\u8282\u70b9\uff08\u672c\u6b21\u793a\u4f8bMaster\u8282\u70b9\u4e5f\u4f1a\u90e8\u7f72kubelet\u548ckube-proxy\uff09\uff1a</p> <pre><code># cd /etc/kubernetes/\n# for NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do\nssh $NODE mkdir -p /etc/kubernetes/pki /etc/etcd/ssl /etc/etcd/ssl\n     for FILE in etcd-ca.pem etcd.pem etcd-key.pem; do\nscp /etc/etcd/ssl/$FILE $NODE:/etc/etcd/ssl/\n     done\nfor FILE in pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig; do\nscp /etc/kubernetes/$FILE $NODE:/etc/kubernetes/${FILE}\ndone\ndone\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#391-kubelet\u914d\u7f6e","title":"3.9.1 Kubelet\u914d\u7f6e","text":"<p>\u6240\u6709\u8282\u70b9\u521b\u5efa\u76f8\u5173\u76ee\u5f55\uff1a</p> <pre><code># mkdir -p /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6eKubelet Service\uff1a</p> <pre><code># vim  /usr/lib/systemd/system/kubelet.service\n# \u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\n[Unit]\nDescription=Kubernetes Kubelet\nDocumentation=https://github.com/kubernetes/kubernetes\nAfter=docker.service\nRequires=docker.service\n\n[Service]\nExecStart=/usr/local/bin/kubelet\n\nRestart=always\nStartLimitInterval=0\nRestartSec=10\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u914d\u7f6ekubelet service\u7684\u914d\u7f6e\u6587\u4ef6</p> <pre><code>[Service]\nEnvironment=\"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig\"\nEnvironment=\"KUBELET_SYSTEM_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin --container-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///run/containerd/containerd.sock --cgroup-driver=systemd\"\nEnvironment=\"KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml\"\nEnvironment=\"KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node='' \"\nExecStart=\nExecStart=/usr/local/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_SYSTEM_ARGS $KUBELET_EXTRA_ARGS\n</code></pre> <p>\u5982\u679c\u8bfb\u8005\u7684Runtime\u4e3aDocker\uff0c\u8bf7\u4f7f\u7528\u5982\u4e0bKubelet\u7684\u914d\u7f6e\uff1a</p> <p>vim /etc/systemd/system/kubelet.service.d/10-kubelet.conf</p> <pre><code>[Service]\nEnvironment=\"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig\"\nEnvironment=\"KUBELET_SYSTEM_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin\"\nEnvironment=\"KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6\"\nEnvironment=\"KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node='' \"\nExecStart=\nExecStart=/usr/local/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_SYSTEM_ARGS $KUBELET_EXTRA_ARGS\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u521b\u5efaKubelet\u7684\u914d\u7f6e\u6587\u4ef6\uff08\u6ce8\u610f\u4fee\u6539\u7684\u5730\u65b9\uff0c\u5b8c\u6574\u6587\u4ef6\u89c1\u672c\u4e66\u4e0b\u8f7d\u8d44\u6e90\uff09\uff1a</p> <p>vim /etc/kubernetes/kubelet-conf.yml </p> <pre><code>apiVersion: kubelet.config.k8s.io/v1beta1\nkind: KubeletConfiguration\naddress: 0.0.0.0\nport: 10250\nreadOnlyPort: 10255\nauthentication:\n  anonymous:\n    enabled: false\n  webhook:\n    cacheTTL: 2m0s\n    enabled: true\n  x509:\n    clientCAFile: /etc/kubernetes/pki/ca.pem\nauthorization:\n  mode: Webhook\n  webhook:\n    cacheAuthorizedTTL: 5m0s\n    cacheUnauthorizedTTL: 30s\ncgroupDriver: systemd\ncgroupsPerQOS: true\nclusterDNS:\n- 192.168.0.10\nclusterDomain: cluster.local\ncontainerLogMaxFiles: 5\ncontainerLogMaxSize: 10Mi\ncontentType: application/vnd.kubernetes.protobuf\ncpuCFSQuota: true\ncpuManagerPolicy: none\ncpuManagerReconcilePeriod: 10s\nenableControllerAttachDetach: true\nenableDebuggingHandlers: true\nenforceNodeAllocatable:\n- pods\neventBurst: 10\neventRecordQPS: 5\nevictionHard:\n  imagefs.available: 15%\n  memory.available: 100Mi\n  nodefs.available: 10%\n  nodefs.inodesFree: 5%\nevictionPressureTransitionPeriod: 5m0s\nfailSwapOn: true\nfileCheckFrequency: 20s\nhairpinMode: promiscuous-bridge\nhealthzBindAddress: 127.0.0.1\nhealthzPort: 10248\nhttpCheckFrequency: 20s\nimageGCHighThresholdPercent: 85\nimageGCLowThresholdPercent: 80\nimageMinimumGCAge: 2m0s\niptablesDropBit: 15\niptablesMasqueradeBit: 14\nkubeAPIBurst: 10\nkubeAPIQPS: 5\nmakeIPTablesUtilChains: true\nmaxOpenFiles: 1000000\nmaxPods: 110\nnodeStatusUpdateFrequency: 10s\noomScoreAdj: -999\npodPidsLimit: -1\nregistryBurst: 10\nregistryPullQPS: 5\nresolvConf: /etc/resolv.conf\nrotateCertificates: true\nruntimeRequestTimeout: 2m0s\nserializeImagePulls: true\nstaticPodPath: /etc/kubernetes/manifests\nstreamingConnectionIdleTimeout: 4h0m0s\nsyncFrequency: 1m0s\nvolumeStatsAggPeriod: 1m0s\n</code></pre> <p>\u542f\u52a8\u6240\u6709\u8282\u70b9Kubelet\uff1a</p> <pre><code># systemctl daemon-reload\n# systemctl enable --now kubelet\n</code></pre> <p>\u6b64\u65f6\u7cfb\u7edf\u65e5\u5fd7/var/log/messages\u663e\u793a\u53ea\u6709\u5982\u4e0b\u4fe1\u606f\u4e3a\u6b63\u5e38\uff0c\u56e0\u4e3a\u8fd8\u6ca1\u6709\u5b89\u88c5CNI\u63d2\u4ef6\uff1a</p> <pre><code>Unable to update cni config: no networks found in /etc/cni/net.d\n</code></pre> <p>\u6ce8\u610f</p> <p>\u5982\u679c\u6709\u5f88\u591a\u62a5\u9519\u65e5\u5fd7\uff0c\u4e0d\u53ea\u662fCNI\u7684\u62a5\u9519\uff0c\u6216\u8005\u6709\u5927\u91cf\u770b\u4e0d\u61c2\u7684\u62a5\u9519\uff0c\u8bf4\u660eKubelet\u7684\u914d\u7f6e\u6709\u8bef\uff0c\u9700\u8981\u68c0\u67e5Kubelet\u7684\u914d\u7f6e\u3002</p> <p>\u67e5\u770b\u96c6\u7fa4\u72b6\u6001\uff1a</p> <p>\u96c6\u7fa4\u72b6\u6001NotReady\uff0c\u56e0\u4e3aCalico\u8fd8\u6ca1\u5b89\u88c5</p> <pre><code># kubectl get node\nNAME           STATUS     ROLES    AGE     VERSION\nk8s-master01   NotReady   &lt;none&gt;   2m23s   v1.22.0-beta.1\nk8s-master02   NotReady   &lt;none&gt;   2m16s   v1.22.0-beta.1\nk8s-master03   NotReady   &lt;none&gt;   2m16s   v1.22.0-beta.1\nk8s-node01     NotReady   &lt;none&gt;   2m16s   v1.22.0-beta.1\nk8s-node02     NotReady   &lt;none&gt;   2m16s   v1.22.0-beta.1\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#392-kube-proxy\u914d\u7f6e","title":"3.9.2 kube-proxy\u914d\u7f6e","text":"<p>\u6ce8\u610f</p> <p>\u5982\u679c\u4e0d\u662f\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0c\u628aMaster\u7684\u5730\u5740\u6539\u4e3a10.0.0.236:16443\uff0c\u628aAPI Server\u7684\u7aef\u53e3\u6539\u4e3a16443\uff0c\u9ed8\u8ba4\u662f6443</p> <p>\u4ee5\u540c\u6837\u7684\u65b9\u5f0f\u751f\u6210kube-proxy\u7684\u8bc1\u4e66\u3002\u4ee5\u4e0b\u64cd\u4f5c\u53ea\u5728Master01\u6267\u884c\uff1a</p> <pre><code># cd /root/k8s-ha-install\n# kubectl -n kube-system create serviceaccount kube-proxy\n# kubectl create clusterrolebinding system:kube-proxy   \\\n--clusterrole system:node-proxier         \\\n--serviceaccount kube-system:kube-proxy\n\n# SECRET=$(kubectl -n kube-system get sa/kube-proxy \\\n--output=jsonpath='{.secrets[0].name}')\n# JWT_TOKEN=$(kubectl -n kube-system get secret/$SECRET \\\n--output=jsonpath='{.data.token}' | base64 -d)\n# PKI_DIR=/etc/kubernetes/pki\n# K8S_DIR=/etc/kubernetes\n# kubectl config set-cluster kubernetes     \\\n--certificate-authority=/etc/kubernetes/pki/ca.pem    \\\n--embed-certs=true     \\\n--server=https://10.0.0.236:16443    \\\n--kubeconfig=${K8S_DIR}/kube-proxy.kubeconfig\n\n# kubectl config set-credentials kubernetes     \\\n--token=${JWT_TOKEN}     \\\n--kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig\n\n# kubectl config set-context kubernetes     \\\n--cluster=kubernetes     \\\n--user=kubernetes     \\\n--kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig\n\n# kubectl config use-context kubernetes     --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig\n</code></pre> <p>\u6ce8\u610f</p> <p>\u4fee\u6539--server=https://10.0.0.236:16443\u4e3a\u8bfb\u8005\u81ea\u5df1\u7684VIP\u5730\u5740\u548c\u7aef\u53e3\uff0c\u5982\u679c\u4e0d\u662f\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0c\u6539\u4e3aMaster\u8282\u70b9IP:6443\u5373\u53ef\u3002</p> <p>\u5c06kubeconfig\u53d1\u9001\u81f3\u5176\u4ed6\u8282\u70b9\uff1a</p> <pre><code># for NODE in k8s-master02 k8s-master03; do\nscp ${K8S_DIR}/kube-proxy.kubeconfig $NODE:/etc/kubernetes/kube-proxy.kubeconfig\n     scp kube-proxy/kube-proxy.conf $NODE:/etc/kubernetes/kube-proxy.conf\n     scp kube-proxy/kube-proxy.service $NODE:/usr/lib/systemd/system/kube-proxy.service\n done\n# for NODE in k8s-node01 k8s-node02; do\nscp /etc/kubernetes/kube-proxy.kubeconfig $NODE:/etc/kubernetes/kube-proxy.kubeconfig\n     scp kube-proxy/kube-proxy.conf $NODE:/etc/kubernetes/kube-proxy.conf\n     scp kube-proxy/kube-proxy.service $NODE:/usr/lib/systemd/system/kube-proxy.service\n done\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u6dfb\u52a0kube-proxy\u7684\u914d\u7f6e\u548cService\u6587\u4ef6\uff1a</p> <p>vim /usr/lib/systemd/system/kube-proxy.service</p> <pre><code>[Unit]\nDescription=Kubernetes Kube Proxy\nDocumentation=https://github.com/kubernetes/kubernetes\nAfter=network.target\n\n[Service]\nExecStart=/usr/local/bin/kube-proxy \\\n--config=/etc/kubernetes/kube-proxy.yaml \\\n--v=2\nRestart=always\nRestartSec=10s\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u521b\u5efakube-proxy\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5982\u679c\u66f4\u6539\u4e86\u96c6\u7fa4Pod\u7684\u7f51\u6bb5\uff0c\u5c31\u9700\u8981\u66f4\u6539kube-proxy.yaml\u7684clusterCIDR\u4e3a\u81ea\u5df1\u7684Pod\u7f51\u6bb5\uff08\u5b8c\u6574\u6587\u4ef6\u89c1\u672c\u4e66\u4e0b\u8f7d\u8d44\u6e90\uff09\uff1a</p> <p>vim /etc/kubernetes/kube-proxy.yaml</p> <pre><code>apiVersion: kubeproxy.config.k8s.io/v1alpha1\nbindAddress: 0.0.0.0\nclientConnection:\n  acceptContentTypes: \"\"\n  burst: 10\n  contentType: application/vnd.kubernetes.protobuf\n  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig\n  qps: 5\nclusterCIDR: 172.16.0.0/12 \nconfigSyncPeriod: 15m0s\nconntrack:\n  max: null\n  maxPerCore: 32768\n  min: 131072\n  tcpCloseWaitTimeout: 1h0m0s\n  tcpEstablishedTimeout: 24h0m0s\nenableProfiling: false\nhealthzBindAddress: 0.0.0.0:10256\nhostnameOverride: \"\"\niptables:\n  masqueradeAll: false\n  masqueradeBit: 14\n  minSyncPeriod: 0s\n  syncPeriod: 30s\nipvs:\n  masqueradeAll: true\n  minSyncPeriod: 5s\n  scheduler: \"rr\"\n  syncPeriod: 30s\nkind: KubeProxyConfiguration\nmetricsBindAddress: 127.0.0.1:10249\nmode: \"ipvs\"\nnodePortAddresses: null\noomScoreAdj: -999\nportRange: \"\"\nudpIdleTimeout: 250ms\n</code></pre> <p>\u6240\u6709\u8282\u70b9\u542f\u52a8kube-proxy\uff1a</p> <pre><code># systemctl daemon-reload\n# systemctl enable --now kube-proxy\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#310-\u5b89\u88c5calico","title":"3.10 \u5b89\u88c5Calico","text":"<p>\u542f\u52a8Kubelet\u65f6\uff0c\u4f1a\u6709\u4e00\u4e2aCNI\u7684\u62a5\u9519\uff0c\u539f\u56e0\u662f\u6ca1\u6709\u5b89\u88c5CNI\u63d2\u4ef6\u3002\u76ee\u524d\u5e38\u7528\u7684CNI\u63d2\u4ef6\u6709Calico\u3001Flannel\u7b49\uff0c\u7531\u4e8e\u672c\u4e66\u5305\u542bNetworkPolicy\u7684\u77e5\u8bc6\uff0c\u9700\u8981CNI\u63d2\u4ef6\u652f\u6301\u7f51\u7edc\u7b56\u7565\uff0c\u56e0\u6b64\u548cKubeadm\u5b89\u88c5\u65b9\u5f0f\u4e00\u6837\uff0c\u540c\u6837\u9009\u62e9Calico\u4f5c\u4e3aCNI\u63d2\u4ef6\u3002</p> <p>\u8fdb\u5165Calico\u5b89\u88c5\u6587\u4ef6\u6240\u5728\u7684\u76ee\u5f55\u3002\u4ee5\u4e0b\u6b65\u9aa4\u53ea\u5728master01\u6267\u884c\uff1a</p> <pre><code># cd /root/k8s-ha-install/calico/\n</code></pre> <p>\u66f4\u6539Calico\u7684\u7f51\u6bb5\uff0c\u6ce8\u610f\u9700\u8981\u5c06172.16.0.0/12\u7f51\u6bb5\u6539\u4e3a\u81ea\u5df1\u7684Pod\u7f51\u6bb5\uff1a</p> <pre><code># sed -i \"s#POD_CIDR#172.16.0.0/12#g\" calico.yaml\n</code></pre> <p>\u5b89\u88c5Calico\uff1a</p> <pre><code># kubectl apply -f calico.yaml\n</code></pre> <p>\u67e5\u770b\u5bb9\u5668\u72b6\u6001\uff1a</p> <pre><code># kubectl  get pod -n kube-system\nNAME                                      READY   STATUS    RESTARTS      AGE\ncalico-kube-controllers-cdd5755b9-4fzg9   1/1     Running   0             113s\ncalico-node-8xg62                         1/1     Running   0             113s\ncalico-node-dczxz                         1/1     Running   0             113s\ncalico-node-gn8ws                         1/1     Running   0             113s\ncalico-node-qmwkd                         1/1     Running   0             113s\ncalico-node-zfw8n                         1/1     Running   2 (78s ago)   113s\n</code></pre> <p>\u5982\u679c\u5bb9\u5668\u72b6\u6001\u5f02\u5e38\u53ef\u4ee5\u4f7f\u7528kubectl describe \u6216\u8005logs\u67e5\u770b\u5bb9\u5668\u7684\u65e5\u5fd7</p>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#311-\u5b89\u88c5coredns","title":"3.11 \u5b89\u88c5CoreDNS","text":"<p>\u5728Master01\u8282\u70b9\u8fdb\u5165CoreDNS\u5b89\u88c5\u6587\u4ef6\u6240\u5728\u76ee\u5f55\uff1a</p> <pre><code># cd /root/k8s-ha-install/CoreDNS\n</code></pre> <p>\u5982\u679c\u66f4\u6539\u4e86Service\u7684\u7f51\u6bb5\uff0c\u5c31\u9700\u8981\u5c06CoreDNS\u7684Service IP\u6539\u6210Kubernetes Service\u7f51\u6bb5\u7684\u7b2c10\u4e2aIP\uff1a</p> <pre><code># COREDNS_SERVICE_IP=`kubectl get svc | grep kubernetes | awk '{print $3}'`0\n# sed -i \"s#192.168.0.10#${COREDNS_SERVICE_IP}#g\" coredns.yaml\n</code></pre> <p>\u5b89\u88c5CoreDNS\uff1a</p> <pre><code># kubectl  create -f coredns.yaml\nserviceaccount/coredns created\n...\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#312-\u5b89\u88c5metrics-server","title":"3.12 \u5b89\u88c5Metrics Server","text":"<p>\u5728\u65b0\u7248\u7684Kubernetes\u4e2d\uff0c\u7cfb\u7edf\u8d44\u6e90\u7684\u91c7\u96c6\u548cHPA\u529f\u80fd\u5747\u4f7f\u7528Metrics-server\uff0c\u53ef\u4ee5\u901a\u8fc7Metrics\u91c7\u96c6\u8282\u70b9\u548cPod\u7684\u5185\u5b58\u3001\u78c1\u76d8\u3001CPU\u548c\u7f51\u7edc\u7684\u4f7f\u7528\u7387\u3002</p> <p>\u5728Master01\u5b89\u88c5Metrics Server\uff1a</p> <pre><code># cd /root/k8s-ha-install/metrics-server\nkubectl  create -f .\nserviceaccount/metrics-server created\n...\n</code></pre> <p>\u7b49\u5f85Metrics Server\u542f\u52a8\uff0c\u7136\u540e\u67e5\u770b\u72b6\u6001\uff1a</p> <pre><code># kubectl  top node\nNAME           CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   k8s-master01   263m         13%    1239Mi          66%       k8s-master02   213m         10%    1065Mi          57%       k8s-master03   207m         10%    1050Mi          56%       k8s-node01     89m          4%     514Mi           27%       k8s-node02     158m         7%     493Mi           26% </code></pre> <p>\u67e5\u770bpod\u72b6\u6001</p> <pre><code># kubectl  top pod -A\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#313-\u5b89\u88c5dashboard","title":"3.13 \u5b89\u88c5dashboard","text":"<ul> <li>\u5b89\u88c5\u6307\u5b9a\u7248\u672cdashboard</li> <li>\u5b89\u88c5\u6700\u65b0\u7248dashboard</li> <li>\u767b\u5f55dashboard</li> </ul> <p>Dashboard\u7528\u4e8e\u5c55\u793a\u96c6\u7fa4\u4e2d\u7684\u5404\u7c7b\u8d44\u6e90\uff0c\u540c\u65f6\u4e5f\u53ef\u4ee5\u901a\u8fc7Dashboard\u5b9e\u65f6\u67e5\u770bPod\u7684\u65e5\u5fd7\u548c\u5728\u5bb9\u5668\u4e2d\u6267\u884c\u4e00\u4e9b\u547d\u4ee4\u7b49\u3002</p> <p>\uff081\uff09\u5b89\u88c5\u6307\u5b9a\u7248\u672cdashboard</p> <pre><code># cd /root/k8s-ha-install/dashboard/\n[root@k8s-master01 dashboard]# ls\ndashboard-user.yaml  dashboard.yaml\n\n# kubectl create -f .\nserviceaccount/admin-user created\nclusterrolebinding.rbac.authorization.k8s.io/admin-user created\nnamespace/kubernetes-dashboard created\nserviceaccount/kubernetes-dashboard created\nservice/kubernetes-dashboard created\nsecret/kubernetes-dashboard-certs created\nsecret/kubernetes-dashboard-csrf created\nsecret/kubernetes-dashboard-key-holder created\nconfigmap/kubernetes-dashboard-settings created\nrole.rbac.authorization.k8s.io/kubernetes-dashboard created\nclusterrole.rbac.authorization.k8s.io/kubernetes-dashboard\ncreated\nrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard\ncreated\nclusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard\ncreated\ndeployment.apps/kubernetes-dashboard created\nservice/dashboard-metrics-scraper created\ndeployment.apps/dashboard-metrics-scraper created\n</code></pre> <p>\uff082\uff09\u5b89\u88c5\u6700\u65b0\u7248dashboard</p> <p>\u5b98\u65b9GitHub\u5730\u5740\uff1ahttps://github.com/kubernetes/dashboard</p> <p>\u53ef\u4ee5\u5728\u5b98\u65b9dashboard\u67e5\u770b\u5230\u6700\u65b0\u7248dashboard</p> <pre><code># kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml\n</code></pre> <p>\u521b\u5efa\u7ba1\u7406\u5458\u7528\u6237\uff08\u5b89\u88c5\u6700\u65b0\u7248\u672c\u7684\u65f6\u5019\uff09</p> <pre><code># vim admin.yaml\n# \u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: admin-user\n  namespace: kube-system\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: admin-user\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: \"true\"\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: cluster-admin\nsubjects:\n- kind: ServiceAccount\n  name: admin-user\n  namespace: kube-system\n</code></pre> <p>\u6267\u884c</p> <pre><code># kubectl apply -f admin.yaml -n kube-system\n</code></pre> <p>\uff083\uff09\u767b\u5f55dashboard \u5728\u8c37\u6b4c\u6d4f\u89c8\u5668\uff08Chrome\uff09\u542f\u52a8\u6587\u4ef6\u4e2d\u52a0\u5165\u542f\u52a8\u53c2\u6570\uff0c\u7528\u4e8e\u89e3\u51b3\u65e0\u6cd5\u8bbf\u95eeDashboard\u7684\u95ee\u9898\uff0c\u56e0\u4e3a\u4f7f\u7528\u7684\u8bc1\u4e66\u662f\u81ea\u7b7e\u540d\uff08\u5c5e\u6027-&gt;\u5feb\u6377\u65b9\u5f0f-&gt;\u76ee\u6807\uff0c\u7c98\u8d34\u5230\u6700\u540e\uff09</p> <pre><code> --test-type --ignore-certificate-errors\n</code></pre> <p>\u66f4\u6539dashboard\u7684svc\u4e3aNodePort\uff1a</p> <pre><code># kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard\n</code></pre> <p>\u4fee\u6539 type: ClusterIP \u4e3a type:NodePort</p> <p>\u4fee\u6539\u5b8c\u6210\u4e4b\u540e\u4f1a\u66b4\u9732\u4e00\u4e2a\u7aef\u53e3\u53f7\uff0c\u67e5\u770b\u7aef\u53e3\u53f7\uff1a</p> <pre><code>[root@k8s-master01 dashboard]# kubectl get svc kubernetes-dashboard -n kubernetes-dashboard\nNAME                   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE\nkubernetes-dashboard   NodePort   10.98.129.195   &lt;none&gt;        443:30711/TCP   85s\n\n[root@k8s-master01 dashboard]# kubectl get pod -A -owide | grep dashboard\nkubernetes-dashboard   dashboard-metrics-scraper-7b4bbf8954-zvgm8   1/1     Running   0          13m     172.27.14.193    k8s-node02     &lt;none&gt;           &lt;none&gt;\nkubernetes-dashboard   kubernetes-dashboard-6c65b776bd-797lx        1/1     Running   0          13m     172.18.195.1     k8s-master03   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u6839\u636e\u81ea\u5df1\u7684\u5b9e\u4f8b\u7aef\u53e3\u53f7\uff0c\u901a\u8fc7\u4efb\u610f\u5b89\u88c5\u4e86kube-proxy\u7684\u5bbf\u4e3b\u673a\u6216\u8005VIP\u7684IP+\u7aef\u53e3\u5373\u53ef\u8bbf\u95ee\u5230dashboard\uff1a\u8bbf\u95eeDashboard\uff1ahttps://10.218.22.252:30711\uff08\u8bf7\u66f4\u6539\u4e3a\u81ea\u5df1\u7684\u7aef\u53e3\uff09\uff0c\u9009\u62e9\u767b\u5f55\u65b9\u5f0f\u4e3a\u4ee4\u724c\uff08\u5373token\u65b9\u5f0f\uff09</p> <p>\u67e5\u770btoken\u503c\uff1a</p> <pre><code># kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}')\ntoken\u503c\n\nName:         admin-user-token-9c4tz\nNamespace:    kube-system\nLabels:       &lt;none&gt;\nAnnotations:  kubernetes.io/service-account.name: admin-user\n              kubernetes.io/service-account.uid: d1f2e528-0ef8-4c6b-a384-a18fbca6bc54\n\nType:  kubernetes.io/service-account-token\n\nData\n====\nca.crt:     1411 bytes\nnamespace:  11 bytes\ntoken:      eyJhbGciOiJSUzI1NiIsImtpZCI6IlNCbEdFa1RQZElhbTBRb29aTTNCTUE1dTJ2enBCeGZxMWJwbmpfZHBXdkEifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLTljNHR6Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJkMWYyZTUyOC0wZWY4LTRjNmItYTM4NC1hMThmYmNhNmJjNTQiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.KFH5ed0kJEaU1HSpxkitJxqKJGnSNAWogNSGjGn1wEh7R9zKYkAfNLES6Vl3GU9jvxBCEZW415ZFILr96kpgl_88mD-K-AMgQxKLdpghYDx_CnsLtI6e8rLTNkaPS2Uo3sYAy9U280Niop14Yzuar5FQ3AfSbeXGcF_9Jrgyeh5XWPA0h69Au8pUEOkVdpADmuIaFSqfTnmkOSdGqCgFb_QsUqvjo4ifIxKnN6uW8wfR1s4esWkPq569xhCINaUY6g3rnT1jfVTU2XmrURrKOVok0OfSmtXTKCSs2jliEdmx7qEFTrw2KCPnTfORUtTnmdZ2ZnGGx9Fvf_hGaKk1FQ\n</code></pre>"},{"location":"Kubernetes/1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/#314-\u4f7f\u7528kuboard\u754c\u9762","title":"3.14 \u4f7f\u7528Kuboard\u754c\u9762","text":"<p>Kuboard\u662f\u56fd\u4eba\u5f00\u53d1\u7684\u53e6\u4e00\u4e2adashboard\u754c\u9762,</p> <p>\u5b98\u7f51\u5730\u5740\uff1ahttps://www.kuboard.cn/install/v3/install-in-k8s.html</p> <p>\u8be6\u7ec6\u5185\u5bb9\u53ef\u4ee5\u770b\u5b98\u7f51\uff0c\u6211\u8fd9\u91cc\u76f4\u63a5\u4f7f\u7528\u547d\u4ee4\u5b89\u88c5</p> <pre><code># kubectl apply -f https://addons.kuboard.cn/kuboard/kuboard-v3.yaml\n</code></pre> <p>\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00\u94fe\u63a5 http://your-node-ip-address:30080</p> <p>\u8f93\u5165\u521d\u59cb\u7528\u6237\u540d\u548c\u5bc6\u7801\uff0c\u5e76\u767b\u5f55</p> <pre><code>\u7528\u6237\u540d\uff1a admin\n\u5bc6\u7801\uff1a Kuboard123\n</code></pre> <p>\u53c2\u8003\u6587\u732e</p> <p>\u4e8c\u8fdb\u5236\u5b89\u88c5k8s\u96c6\u7fa4V1.23.0</p> <p>\u4e8c\u8fdb\u5236\u9ad8\u53ef\u7528\u5b89\u88c5k8s\u96c6\u7fa4\u90e8\u7f72</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/","title":"Docker\u57fa\u7840","text":"<p>\u5728\u516c\u53f8\u4f7f\u7528Kubernetes\u4ee5\u540e\uff0c\u5176\u5b9e\u5bf9\u4e8eDocker\u7684\u76f4\u63a5\u64cd\u4f5c\u5e76\u4e0d\u591a\uff0c\u56e0\u4e3a\u5927\u90e8\u5206\u547d\u4ee4\u5df2\u88abKubernetes\u7684\u5ba2\u6237\u7aef\u5de5\u5177Kubectl\u5c01\u88c5\uff0c\u6211\u4eec\u4f7f\u7528Kubectl\u5373 \u53ef\u5b8c\u6210Kubernetes\u7684\u65e5\u5e38\u7ba1\u7406\u548c\u8fd0\u7ef4\u5de5\u4f5c\uff0c \u5e76\u4e14Kubernetes 1.24\u4ee5\u4e0a\u7248\u672c\u4e0d\u518d\u76f4\u63a5\u652f\u6301Docker\u3002</p> <p>\u4f46\u662f\u4f5c\u4e3a\u4e00\u540dKubernetes\u7ba1\u7406\u4eba\u5458\u6216\u8005DevOps\u5de5\u7a0b\u5e08\uff0c \u5b66\u4e60Docker\u57fa\u7840\u77e5\u8bc6\u548cDocker\u955c\u50cf\u7684\u5236\u4f5c\u548c\u4f18\u5316\u662f\u975e\u5e38\u91cd\u8981\u7684\u4e00\u9879\u5de5\u4f5c\uff0c\u80fd\u591f\u8ba9\u6211\u4eec\u66f4\u597d\u5730\u7ba1\u7406\u548c\u8fd0\u7ef4Kubernetes\u4ee5\u53ca\u66f4\u597d\u5730\u5b9e\u73b0\u540e\u671f\u7684CICD\uff08\u6301\u7eed\u96c6\u6210/\u6301\u7eed\u90e8\u7f72\uff09\u5236\u4f5c\u4e00\u4e2a\u7b26\u5408\u751f\u4ea7\u73af\u5883\u7684\u955c\u50cf\u3002\u672c\u7ae0\u5c06\u5e26\u9886\u8bfb\u8005\u8ba4\u8bc6\u548c\u5b66\u4e60Docker\u7684\u57fa\u7840\u4ee5\u53ca\u540e\u671fDocker\u955c\u50cf\u7684\u5236\u4f5c\u548c\u4f18\u5316\u3002</p> <p>\u4f46\u662f\u4f5c\u4e3a\u4e00\u540dKubernetes\u7ba1\u7406\u4eba\u5458\u6216\u8005DevOps\u5de5\u7a0b\u5e08\uff0c\u5b66\u4e60Docker\u57fa\u7840\u77e5\u8bc6\u548cDocker\u955c\u50cf\u7684\u5236\u4f5c\u548c\u4f18\u5316\u662f\u975e\u5e38\u91cd\u8981\u7684\u4e00\u9879\u5de5\u4f5c\uff0c\u80fd\u591f\u8ba9\u6211\u4eec\u66f4\u597d\u5730\u7ba1\u7406\u548c\u8fd0\u7ef4Kubernetes\u4ee5\u53ca\u66f4\u597d\u5730\u5b9e\u73b0\u540e\u671f\u7684CICD\uff08\u6301\u7eed\u96c6\u6210/\u6301\u7eed\u90e8\u7f72\uff09\u5236\u4f5c\u4e00\u4e2a\u7b26\u5408\u751f\u4ea7\u73af\u5883\u7684\u955c\u50cf\u3002</p> <p>\u672c\u7ae0\u5c06\u5e26\u9886\u8bfb\u8005\u8ba4\u8bc6\u548c\u5b66\u4e60Docker\u7684\u57fa\u7840\u4ee5\u53ca\u540e\u671fDocker\u955c\u50cf\u7684\u5236\u4f5c\u548c\u4f18\u5316\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/#1-docker\u4ecb\u7ecd","title":"1. Docker\u4ecb\u7ecd","text":"<p>Docker\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u8f6f\u4ef6\u9879\u76ee\uff0c\u8ba9\u6280\u672f\u4eba\u5458\u53ef\u4ee5\u6253\u5305\u4ed6\u4eec\u7684\u5e94\u7528\u53ca\u5176\u4f9d\u8d56\u5305\u5230\u4e00\u4e2a\u53ef\u79fb\u690d\u7684\u5bb9\u5668\u4e2d\uff0c\u7136\u540e\u53d1\u5e03\u5230\u4efb\u4f55\u6d41\u884c\u7684Linux\u673a\u5668\u4e0a\u3002\u5728Linux\u64cd\u4f5c\u7cfb\u7edf\u4e0a\uff0cDocker\u63d0\u4f9b\u4e86\u4e00\u4e2a\u989d\u5916\u7684\u8f6f\u4ef6\u62bd\u8c61\u5c42\u53ca\u64cd\u4f5c\u7cfb\u7edf\u5c42\u865a\u62df\u5316\u7684\u81ea\u52a8\u7ba1\u7406\u673a\u5236\u3002</p> <p>Docker\u8fd0\u884c\u540d\u4e3a\"Container(\u5bb9\u5668)\"\u7684\u8f6f\u4ef6\u5305\uff0c\u5bb9\u5668\u4e4b\u95f4\u5f7c\u6b64\u9694\u79bb\uff0c\u5e76\u6346\u7ed1\u4e86\u81ea\u5df1\u7684\u5e94\u7528\u7a0b\u5e8f\u3001\u5de5\u5177\u3001\u5e93\u548c\u914d\u7f6e\u6587\u4ef6\u3002\u6240\u6709\u5bb9\u5668\u90fd\u7531\u5355\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u8fd0\u884c\uff0c\u56e0\u6b64\u6bd4\u865a\u62df\u673a\u66f4\u8f7b\u91cf\u7ea7\u3002</p> <p>Docker\u5229\u7528Linux\u8d44\u6e90\u5206\u79bb\u673a\u5236\uff08\u4f8b\u5982Cgroups\u53caLinux Namespace\uff09\u6765\u521b\u5efa\u76f8\u4e92\u72ec\u7acb\u7684\u5bb9\u5668\uff08Container\uff09\u3002\u53ef\u4ee5\u5728\u5355\u4e2aLinux\u5b9e\u4f53\u4e0b\u8fd0\u884c\uff0c\u907f\u514d\u4e86\u542f\u52a8\u4e00\u4e2a\u865a\u62df\u673a\u9020\u6210\u7684\u989d\u5916\u8d1f\u62c5\u3002Linux\u6838\u5fc3\u5bf9Namespace\uff08\u547d\u540d\u7a7a\u95f4\uff09\u7684\u652f\u6301\u5b8c\u5168\u9694\u79bb\u4e86\u4e0d\u540cNamespace\u4e0b\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u201c\u89c6\u91ce\u201d\uff08\u5373\u4f5c\u7528\u8303\u56f4\uff09\uff0c\u5305\u62ec\u8fdb\u7a0b\u6811\u3001\u7f51\u7edc\u3001\u7528\u6237ID\u4e0e\u6302\u8f7d\u7684\u6587\u4ef6\u7cfb\u7edf\u7b49\uff0c\u800c\u6838\u5fc3Cgroups\u5219\u63d0\u4f9b\u4e86\u8d44\u6e90\u9694\u79bb\uff0c\u5305\u62ecCPU\u3001\u5b58\u50a8\u5668\u3001Block I/O\u4e0e\u7f51\u7edc\u3002</p> <p>Docker\u5728\u903b\u8f91\u4e0a\u5206\u4e3a\u5982\u4e0b\u51e0\u4e2a\u90e8\u5206\uff1a</p> <ul> <li>Docker Client\uff1aDocker\u5ba2\u6237\u7aef\uff0c\u7528\u4e8e\u6267\u884cDocker\u7684\u76f8\u5173\u547d\u4ee4\uff0c\u6bd4\u5982\u955c\u50cf\u4e0b\u8f7d\u3002</li> <li>Docker Daemon\uff1aDocker\u5b88\u62a4\u8fdb\u7a0b\uff0c\u8fd0\u884c\u5728\u670d\u52a1\u5668\u6216\u8005\u5176\u4ed6\u5de5\u4f5c\u7ad9\u4e0a\u3002</li> <li>Docker Image\uff1aDocker\u955c\u50cf\uff0c\u76f8\u5f53\u4e8e\u4e00\u4e2a\u6a21\u677f\uff0c\u53ef\u4ee5\u7528\u6765\u542f\u52a8\u5bb9\u5668\u3002</li> <li>Docker Container\uff1aDocker\u5bb9\u5668\uff0c\u7531\u955c\u50cf\u542f\u52a8\uff0c\u5bb9\u5668\u5185\u8fd0\u884c\u7740\u76f8\u5173\u7684\u5e94\u7528\u7a0b\u5e8f\u3002</li> </ul> <p>\u901a\u4fd7\u6765\u8bb2\uff0cDocker\u7684\u8bbe\u8ba1\u7406\u5ff5\u6765\u81ea\u4e8e\u96c6\u88c5\u7bb1\uff0c\u53ef\u4ee5\u5c06\u4e0d\u540c\u7c7b\u578b\u7684\u8d27\u7269\u88c5\u5728\u4e0d\u540c\u7684\u73af\u5883\u4e2d\uff0c\u6bd4\u5982\u4e00\u4e9b\u9700\u8981\u4f4e\u6e29\u73af\u5883\u8fd0\u9001\u7684\u8d27\u7269\u9700\u8981\u88c5\u5728\u6709\u201c\u51b0\u5757\u201d\u7684\u96c6\u88c5\u7bb1\u4e2d\uff0c\u6bd4\u8f83\u5371\u9669\u7684\u5316\u5b66\u7269\u54c1\u9700\u8981\u88c5\u5728\u4e00\u4e9b\u7279\u5236\u7684\u96c6\u88c5\u7bb1\u4e2d\u8fd0\u9001\u3002</p> <p>\u76f8\u540c\u7684\u9053\u7406\uff0c\u5728\u4e00\u4e2a\u4f01\u4e1a\u5185\u90e8\uff0c\u4e00\u4e2a\u7cfb\u7edf\u53ef\u80fd\u4f1a\u6d89\u53ca\u4e0d\u540c\u7684\u73af\u5883\u548c\u4e0d\u540c\u7684\u4ee3\u7801\u8bed\u8a00\uff0c\u6bd4\u5982Java\u5e94\u7528\u7a0b\u5e8f\u9700\u8981JRE\u4f5c\u4e3a\u57fa\u7840\u73af\u5883\uff0cNodeJS\u5e94\u7528\u9700\u8981Node\u4f5c\u4e3a\u57fa\u7840\u73af\u5883\uff0c\u8fd8\u6709\u53ef\u80fd\u4e00\u4e9b\u5e94\u7528\u9700\u8981Ubuntu\u7cfb\u7edf\uff0c\u800c\u53e6\u4e00\u4e9b\u5e94\u7528\u9700\u8981CentOS\u7cfb\u7edf\uff0c\u90a3\u4e48\u6211\u4eec\u4f7f\u7528Docker\u65f6\u53ea\u8981\u5c06\u4f9d\u8d56\u7684\u7cfb\u7edf\u73af\u5883\u548c\u5f00\u53d1\u73af\u5883\u505a\u6210\u4e00\u4e2a\u201c\u96c6\u88c5\u7bb1\u201d\uff0c\u7136\u540e\u628a\u5e94\u7528\u653e\u8fdb\u8fd9\u4e2a\u201c\u96c6\u88c5\u7bb1\u201d\uff0c\u5373\u53ef\u628a\u6211\u4eec\u7684\u5e94\u7528\u201c\u8dd1\u201d\u8d77\u6765\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/#2-docker\u5b89\u88c5","title":"2. Docker\u5b89\u88c5","text":"<p>\u5728\u5b66\u4e60\u4f7f\u7528Docker\u547d\u4ee4\u4e4b\u524d\uff0c\u9700\u8981\u5148\u627e\u4e00\u53f0\u670d\u52a1\u5668\u5b89\u88c5Docker\u3002 \u5982\u679c\u8bfb\u8005\u5728\u5b89\u88c5Kubernetes\u65f6\u5df2\u7ecf\u5b89\u88c5\u4e86Docker\uff0c\u53ef\u4ee5\u76f4\u63a5\u7528\u6765\u5b66\u4e60\u4f7f\u7528\uff0c\u6216\u8005\u53c2\u8003\u5982\u4e0b\u547d\u4ee4\u8fdb\u884c\u5b89\u88c5\uff08\u4ee5CentOS 7\u4e3a\u4f8b\uff09\uff1a</p> <pre><code>$ sudo yum update\n$ sudo yum install -y yum-utils \\\ndevice-mapper-persistent-data \\\nlvm2\n\n# \u6dfb\u52a0Docker\u7a33\u5b9a\u7248\u672c\u7684yum\u8f6f\u4ef6\u6e90\uff1a\n$ sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n\n$ sed -i -e '/mirrors.cloud.aliyuncs.com/d' -e '/mirrors.aliyuncs.com/d' /etc/yum.repos.d/CentOS-Base.repo\n\n# \u4e4b\u540e\u66f4\u65b0yum\u8f6f\u4ef6\u6e90\u7f13\u5b58\uff0c\u5e76\u5b89\u88c5Docker\uff1a\n$ sudo yum update\n$ sudo yum install -y docker-ce-20.10.* docker-ce-cli-20.10.*\n\n#\u5b89\u88c5\u4e4b\u540e\u542f\u52a8 Docker \u670d\u52a1\uff0c\u5e76\u8ba9\u5b83\u968f\u7cfb\u7edf\u542f\u52a8\u81ea\u52a8\u52a0\u8f7d\u3002\n$ sudo systemctl daemon-reload &amp;&amp;  sudo systemctl start docker\n$ sudo systemctl enable docker.service --now docker\n</code></pre> <p>\u5176\u4ed6\u5b89\u88c5\u65b9\u5f0f\u53ef\u4ee5\u53c2\u8003Docker\u5b98\u65b9\u6587\u6863\uff1ahttps://docker.io/\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/#21-docker\u5b89\u88c5","title":"2.1 docker\u5b89\u88c5","text":"<p>docker\u5b89\u88c5</p> <pre><code>$ wget https://download.docker.com/linux/static/stable/aarch64/docker-20.10.9.tgz\n$ tar zxf docker-20.10.9.tgz\n$ cp docker/* /usr/bin\n$ cat &gt;/lib/systemd/system/docker.service &lt;&lt;EOF\n[Unit]\nDescription=Docker Application Container Engine\nDocumentation=https://docs.docker.com\nAfter=network-online.target firewalld.service\nWants=network-online.target\n[Service]\nType=notify\nExecStart=/usr/bin/dockerd\nExecReload=/bin/kill -s HUP $MAINPID\nLimitNOFILE=infinity\nLimitNPROC=infinity\nTimeoutStartSec=0\nDelegate=yes\nKillMode=process\nRestart=on-failure\nStartLimitBurst=3\nStartLimitInterval=60s\n[Install]\nWantedBy=multi-user.target\nEOF\n$ systemctl daemon-reload\n$ systemctl start docker $ docker version\n\n$ cat &gt; /etc/docker/daemon.json &lt;&lt;'EOF'\n{\n  \"graph\": \"/data/docker\",\n  \"storage-driver\": \"overlay2\",\n  \"insecure-registries\": [\"hub.gitee.com\"],\n  \"registry-mirrors\": [\"https://25bxwt20.mirror.aliyuncs.com\"],\n  \"live-restore\": true,\n  \"bip\": \"172.16.200.1/24\",\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n  \"hosts\": [\"tcp://0.0.0.0:2375\", \"unix:///var/run/docker.sock\"],\n  \"log-opts\": {\n    \"max-size\":\"100M\",\n    \"max-file\":\"3\"\n  }\n}\nEOF\n$ systemctl restart docker\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/#22-dockerfile\u4ed3\u5e93","title":"2.2 dockerfile\u4ed3\u5e93","text":"<ul> <li>https://github.com/dockerfile/</li> <li>https://gitee.com/gaork/dockerfiles</li> <li>https://gitee.com/single_yang/Dockerfile</li> <li>https://github.com/orgs/docker-library/repositories</li> <li>https://github.com.cnpmjs.org/HariSekhon/Dockerfiles.git</li> <li>https://github.com.cnpmjs.org/CentOS/CentOS-Dockerfiles.git</li> <li>https://github.com.cnpmjs.org/ericsysmin/docker-ansible-images.git</li> </ul>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/#23-docker-compose-v1\u5b89\u88c5","title":"2.3 docker-compose v1\u5b89\u88c5","text":"<pre><code>$ sudo curl -L https://get.daocloud.io/docker/compose/releases/download/v2.4.1/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose\n\n$ sudo chmod +x /usr/local/bin/docker-compose\n$ sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose\n\n$ docker-compose version\nDocker Compose version v2.4.1\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/#24-docker-compose-v2\u5b89\u88c5","title":"2.4 docker-compose v2\u5b89\u88c5","text":"<p>\u76ee\u524d Docker \u5b98\u65b9\u7528 GO \u8bed\u8a00 \u91cd\u5199 \u4e86 Docker Compose\uff0c\u5e76\u5c06\u5176\u4f5c\u4e3a\u4e86 docker cli \u7684\u5b50\u547d\u4ee4\uff0c\u79f0\u4e3a <code>Compose V2</code>\u3002\u4f60\u53ef\u4ee5\u53c2\u7167\u5b98\u65b9\u6587\u6863\u5b89\u88c5\uff0c\u7136\u540e\u5c06\u719f\u6089\u7684 <code>docker-compose</code> \u547d\u4ee4\u66ff\u6362\u4e3a <code>docker compose</code>\uff0c\u5373\u53ef\u4f7f\u7528 Docker Compose\u3002</p> <p>\u4ed3\u5e93\u5730\u5740\uff1a https://github.com/docker/compose/releases</p> <p>\u6587\u6863\u5730\u5740\uff1a https://docs.docker.com/compose/install/linux/</p> <ol> <li> <p>\u7b2c\u4e00\u6b65\u4e0b\u8f7d \u53ef\u4ee5\u4ece\u4e0b\u9762\u9875\u4e0b\u8f7d\u7a33\u5b9a\u7248 docker-compose-linux-x86_64</p> </li> <li> <p>\u4e0a\u4f20\u5230 /usr/local/lib/docker/cli-plugins/ \u76ee\u5f55\u4e0b \u5e76\u4e14\u4fee\u6539 docker-compose-linux-x86_64 \u6587\u4ef6\u540d\u4e3a docker-compose</p> </li> </ol> <pre><code># 1\u3001\u4ece\u9879\u76ee\u53d1\u5e03\u9875\u9762\u4e0b\u8f7d\u9002\u5408\u4f60\u7684\u7cfb\u7edf\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u5e76\u5c06\u5176\u590d\u5236\u5230$HOME/.docker/cli-plugins\uff0c\u4f5c\u4e3adocker-compose\u6765\u5b89\u88c5Compose V2\n#\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u4e0b\u8f7dDocker Compose\u7684\u5f53\u524d\u7a33\u5b9a\u7248\u672c\n$ mkdir -p ~/.docker/cli-plugins/\n$ curl -SL https://github.com/docker/compose/releases/download/v2.0.1/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose\n# \u8be5\u547d\u4ee4\u4e3a$HOME\u76ee\u5f55\u4e0b\u7684\u6d3b\u52a8\u7528\u6237\u5b89\u88c5Compose V2\u3002\u4e3a\u7cfb\u7edf\u4e2d\u7684\u6240\u6709\u7528\u6237\u5b89\u88c5Docker Compose\n$ mkdir -p /usr/local/lib/docker/cli-plugins\n$ curl -SL https://github.com/docker/compose/releases/download/v2.2.2/docker-compose-linux-x86_64 -o /usr/local/lib/docker/cli-plugins/docker-compose\n\n# 2\u3001\u5bf9\u4e8c\u8fdb\u5236\u6587\u4ef6\u5e94\u7528\u53ef\u6267\u884c\u6743\u9650\n$ chmod +x ~/.docker/cli-plugins/docker-compose\n\n# 3\u3001\u6d4b\u8bd5\u5b89\u88c5\n$ docker compose version\n   Docker Compose version v2.2.2\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/#25-docker-compose\u5feb\u901f\u5165\u95e8","title":"2.5 docker-compose\u5feb\u901f\u5165\u95e8","text":"<p>\u53c2\u8003\u6587\u732e</p> <p>https://www.runoob.com/docker/docker-compose.html</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/#26-awesome-compose","title":"2.6 awesome-compose","text":"<p>\u53c2\u8003\u4f8b\u5b50 https://github.com/docker/awesome-compose</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/#3-docker\u57fa\u672c\u547d\u4ee4","title":"3. Docker\u57fa\u672c\u547d\u4ee4","text":"<p>\u67e5\u770bDocker\u7248\u672c\uff0c\u5305\u62ecDocker\u7248\u672c\u53f7\u3001API\u7248\u672c\u53f7\u3001\u5bf9\u5e94\u7684Git Commit\u3001Containerd\u548crunC\u7684\u7248\u672c\u4fe1\u606f\u7b49\u3002</p> <pre><code># \u67e5\u770bDocker\u7248\u672c\ndocker version\n\n# \u67e5\u770bDocker\u8be6\u7ec6\u4fe1\u606f\ndocker info\n\n# \u955c\u50cf\u641c\u7d22\ndocker search nginx\n\n# \u62c9\u53d6/\u4e0b\u8f7d\u955c\u50cf\uff0c\u9ed8\u8ba4\u662fhub.docker.com\uff08docker.io\uff09\u4e0a\u9762\u7684\u955c\u50cf\uff0c\n# \u5982\u679c\u62c9\u53d6\u516c\u53f8\u5185\u90e8\u7684\u955c\u50cf\u6216\u8005\u5176\u4ed6\u4ed3\u5e93\u4e0a\u7684\u955c\u50cf\uff0c\u9700\u8981\u5728\u955c\u50cf\u524d\u9762\u52a0\u4e0a\u4ed3\u5e93\u7684URL\uff0c\u4f8b\u5982\uff1a\ndocker pull harbor.xxx.net/frontend:v1\n\n# \u62c9\u53d6\u516c\u7f51\u4e0a\u7684Nginx\u955c\u50cf\uff1a\n# \u628a\u516c\u7f51\u4e0a\u7684\u955c\u50cf\u62c9\u53d6\u5230\u672c\u5730\u670d\u52a1\u5668\uff0c\u4e0d\u6307\u5b9a\u7248\u672c\u53f7\u4e3alatest\ndocker pull nginx\n#Using default tag: latest\n#latest: Pulling from library/nginx\n#Digest: sha256:b543f6d0983fbc25b9874e22f4fe257a567111da96fd1d8f1b44315f1236398c\n#Status: Image is up to date for nginx:latest\n\n#\u62c9\u53d6\u6307\u5b9a\u7248\u672c\ndocker pull nginx:1.15\n#1.15: Pulling from library/nginx\n#Digest: sha256:b543f6d0983fbc25b9874e22f4fe257a567111da96fd1d8f1b44315f1236398c\n#Status: Downloaded newer image for nginx:1.15\n\n\u628a\u672c\u5730\u7684\u955c\u50cf\u63a8\u9001\u5230\u516c\u7f51\u4ed3\u5e93\u4e2d\uff0c\u6216\u8005\u516c\u53f8\u5185\u90e8\u7684\u4ed3\u5e93\u4e2d\u3002\u9ed8\u8ba4\u767b\u5f55\u548c\u63a8\u9001\u7684\u662f\u516c\u7f51\u7684\u955c\u50cf\uff0c\u5982\u679c\u9700\u8981\u63a8\u9001\u5230\u516c\u53f8\u4ed3\u5e93\u6216\u8005\u5176\u4ed6\u4ed3\u5e93\uff0c\u53ea\u9700\u8981\u5728\u955c\u50cf\u524d\u9762\u4f7f\u7528tag\u5e76\u52a0\u4e0aURL\u5373\u53ef\uff1a\n\n# \u6709\u65f6\u5019\u6211\u4eec\u9700\u8981\u7ed9\u4e00\u4e2a\u4e1a\u52a1\u5bb9\u5668\u8fdb\u884c\u6d4b\u8bd5\u6216\u8005\u8fdb\u884c\u67d0\u4e2a\u8c03\u8bd5\uff0c\u53ef\u4ee5\u4f7f\u7528run -ti\u5728\u524d\u53f0\u542f\u52a8\u4e00\u4e2a\u5bb9\u5668\uff1a\ndocker run -ti nginx bash\nroot@23bc7ccabb09:/#\n# \u4e5f\u53ef\u4ee5\u4f7f\u7528-ti --rm\u53c2\u6570\uff0c\u8868\u793a\u524d\u53f0\u542f\u52a8\u7684\u5bb9\u5668\u9000\u51fa\u540e\u5373\u5220\u9664\n\n# \u5982\u679c\u4e00\u4e2a\u955c\u50cf\u9700\u8981\u4e00\u76f4\u8fd0\u884c\uff0c\u53ef\u4ee5\u4f7f\u7528-d\u8fdb\u884c\u540e\u53f0\u542f\u52a8\uff1a\ndocker run -tid nginx bash\n1bcf5154d5c3a57d92a6796f526eac2cefd962aaca9cf4098689bfe830bb9e5e\n# \u4e5f\u53ef\u4ee5\u4f7f\u7528--restart=always\uff0c\u5982\u679c\u5bb9\u5668\u5f02\u5e38\u81ea\u52a8\u91cd\u542f\n\n# \u5982\u679c\u9700\u8981\u901a\u8fc7\u670d\u52a1\u5668\u7684IP+\u7aef\u53e3\u8bbf\u95ee\u5bb9\u5668\u7684\u5185\u90e8\u5e94\u7528\uff0c\u53ef\u4ee5\u4f7f\u7528-p\u8fdb\u884c\u7aef\u53e3\u6620\u5c04\uff0c\u5c06\u672c\u673a\u7684\u7aef\u53e3\u6620\u5c04\u5230\u5bb9\u5668\u7684\u7aef\u53e3\uff0c\n## \u6bd4\u5982\u5c06\u672c\u673a\u76841111\u7aef\u53e3\u6620\u5c04\u5230\u5bb9\u5668\u768480\u7aef\u53e3\uff1a\ndocker run -ti -p 1111:80 nginx bash\nroot@cd676d572188:/#\n\n# \u5982\u679c\u9700\u8981\u6302\u8f7d\u4e00\u4e2a\u672c\u5730\u7684\u76ee\u5f55\u5230\u5bb9\u5668\uff0c\u53ef\u4ee5\u4f7f\u7528-v\u53c2\u6570\u8fdb\u884c\u6302\u8f7d\uff0c\u6bd4\u5982\u5c06hosts\u6587\u4ef6\u6302\u8f7d\u5230\u5bb9\u5668\u7684hosts\uff1a\ndocker run -ti -p 1111:80 -v /etc/hosts:/etc/hosts  nginx bash\nroot@cd676d572188:/#\n\n# \u67e5\u770b\u5f53\u524d\u6b63\u5728\u8fd0\u884c\u7684\u5bb9\u5668\uff1a\ndocker ps\n\n# \u67e5\u770b\u6240\u6709\u5bb9\u5668\uff0c\u5305\u62ec\u5df2\u7ecf\u9000\u51fa\u7684\uff1a\ndocker ps -a\n\n# \u67e5\u770b\u6b63\u5728\u8fd0\u884c\u7684\u5bb9\u5668\uff08\u5373\u663e\u793a\u51fa\u5bb9\u5668\u7684ID\uff09\uff1a\ndocker ps -q\n\n# \u67e5\u770b\u6240\u6709\u5bb9\u5668\u7684ID\uff0c\u5305\u62ec\u5df2\u7ecf\u9000\u51fa\u7684\uff1a\ndocker ps -aq\n\n# \u8fdb\u5165\u4e00\u4e2a\u540e\u53f0\u8fd0\u884c\u7684\u5bb9\u5668\uff08\u5373\u4e4b\u524d\u7528-d\u547d\u4ee4\u53c2\u6570\u6307\u5b9a\u540e\u53f0\u8fd0\u884c\u65b9\u5f0f\u7684\u5bb9\u5668\uff09\uff1a\ndocker ps | tail -1\nb3525f505a9b   hub.gitee.cc/gitee_ci/gitaly:20201224              \"/bin/bash /home/git\u2026\"   20 months ago   Up 4 months             0.0.0.0:9236-&gt;9236/tcp, :::9236-&gt;9236/tcp, 0.0.0.0:9999-&gt;9999/tcp, :::9999-&gt;9999/tcp, 0.0.0.0:30022-&gt;22/tcp, :::30022-&gt;22/tcp   gitaly_gitaly_1\n\ndocker exec -it b3525f505a9b bash\nroot@b3525f505a9b:/home/git/gitaly#\n\n# \u5c06\u672c\u673a\u7684\u6587\u4ef6\u590d\u5236\u5230\u5bb9\u5668\uff0c\u590d\u5236\u652f\u6301\u53cc\u5411\u590d\u5236\uff0c\u4e5f\u652f\u6301\u5c06\u5bb9\u5668\u7684\u5185\u90e8\u6587\u4ef6\u590d\u5236\u5230\u5bbf\u4e3b\u673a\uff1a\ndocker cp README.md 92aceec0dcdd327a709bf0ec83:/tmp\n\n# exec\u4e5f\u53ef\u76f4\u63a5\u6267\u884c\u5bb9\u5668\u547d\u4ee4\ndocker exec 92aceec0dcdd327a709bf0ec83 ls /tmp/\nREADME.md\n\n# \u5220\u9664\u5df2\u7ecf\u9000\u51fa\u7684\u5bb9\u5668\uff1a\n# \u67e5\u770bExited\u5bb9\u5668\ndocker ps -a |grep Exited | tail -3\ncec7e3e9a4a3        0622fce024a9                       \"/bin/bash\"              2 weeks ago         Exited (0) 2 weeks ago                                                      practical_wright\n\ndocker rm cec7e3e9a4a3\n# \u518d\u6b21\u67e5\u770bExited\u5bb9\u5668\ndocker ps -a |grep Exited | tail -3\n\n# \u5220\u9664\u672c\u673a\u955c\u50cf\uff0c\u6bd4\u5982\u5220\u9664REPOSITORY\u6216TAG\u4e3anone\u7684\u955c\u50cf\uff1a\ndocker images |grep none\nregistry.baidubce.com/gitee-prod-new/helm-deploy-public                    &lt;none&gt;                      6320f1d0fb26        2 weeks ago         256MB\n\ndocker rmi 6320f1d0fb26\nUntagged: registry.baidubce.com/gitee-prod-new/helm-deploy-public@sha256:881cf8508e85f1efb1700bcc809ff702d8021020e5821cce5c53151ec20e800a\nDeleted: sha256:6320f1d0fb26f8fd59585d927f57a3aad8dd893787b6b0ef79f15c925f80677c\nDeleted: sha256:68f54a4d5fb2478062a46b26195971edc7d0dd2157ab799b01ba3401fb333468\nDeleted: sha256:dc5c8bc75bbb0e3dd768e5f96f4015de9511b4f3bc66c0d76c5afa7248e6882e\nDeleted: sha256:7d98184ca9d9d3c1a5b29792561e2f1e50a720a9171584b3ce10fd53a1ec55dc\nDeleted: sha256:74754500cc1438e2627238f6e6b838fe56e6d314fb0122c9480fde1f1e51de01\n\n# \u533a\u5206\u955c\u50cf\u7684\u7248\u672c\u53ef\u4ee5\u4f7f\u7528tag\u547d\u4ee4\u7ed9\u955c\u50cf\u6253\u6807\u7b7e\uff1a\n## \u5c06\u955c\u50cfubuntu:15.10\u6807\u8bb0\u4e3a runoob/ubuntu:v3 \u955c\u50cf\u3002\nroot@runoob:~# docker tag ubuntu:15.10 runoob/ubuntu:v3\nroot@runoob:~# docker images  runoob/ubuntu:v3\n\n# \u4f7f\u7528docker build\u901a\u8fc7Dockerfile\u5236\u4f5c\u955c\u50cf\u3002\u6ce8\u610f\u6700\u540e\u7684\u4e00\u4e2a\u70b9\uff08.\uff09\uff0c\u8868\u793a\u4f7f\u7528\u5f53\u524d\u76ee\u5f55\u6784\u5efa\u955c\u50cf\uff1a\n\n## \u4f7f\u7528\u5f53\u524d\u76ee\u5f55\u7684 Dockerfile \u521b\u5efa\u955c\u50cf\uff0c\u6807\u7b7e\u4e3a runoob/ubuntu:v1\u3002\ndocker build -t runoob/ubuntu:v1 .\n\n## \u4f7f\u7528URL github.com/creack/docker-firefox \u7684 Dockerfile \u521b\u5efa\u955c\u50cf\u3002\ndocker build github.com/creack/docker-firefox\n\n## \u4e5f\u53ef\u4ee5\u901a\u8fc7 -f Dockerfile \u6587\u4ef6\u7684\u4f4d\u7f6e\uff1a\n$ docker build -f /path/to/a/Dockerfile .\n\n##\u5728 Docker \u5b88\u62a4\u8fdb\u7a0b\u6267\u884c Dockerfile \u4e2d\u7684\u6307\u4ee4\u524d\uff0c\u9996\u5148\u4f1a\u5bf9 Dockerfile \u8fdb\u884c\u8bed\u6cd5\u68c0\u67e5\uff0c\u6709\u8bed\u6cd5\u9519\u8bef\u65f6\u4f1a\u8fd4\u56de\uff1a\n$ docker build -t test/myapp .\nSending build context to Docker daemon 2.048 kB\nError response from daemon: Unknown instruction: RUNCMD\n\n# \u53ef\u4ee5\u4f7f\u7528docker logs\u67e5\u770b\u5bb9\u5668\u8f93\u51fa\u5230\u63a7\u5236\u53f0\u7684\u65e5\u5fd7\uff08\u7a0b\u5e8f\u65e5\u5fd7\u8f93\u51fa\u5230\u63a7\u5236\u53f0\u662f\u5bb9\u5668\u5316\u7684\u6700\u4f73\u5b9e\u8df5\uff09\uff1a\n\n## \u8ddf\u8e2a\u67e5\u770b\u5bb9\u5668mynginx\u7684\u65e5\u5fd7\u8f93\u51fa\u3002\nrunoob@runoob:~$ docker logs -f mynginx\n192.168.239.1 - - [10/Jul/2016:16:53:33 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.93 Safari/537.36\" \"-\"\n...\n\n## \u67e5\u770b\u5bb9\u5668mynginx\u4ece2016\u5e747\u67081\u65e5\u540e\u7684\u6700\u65b010\u6761\u65e5\u5fd7\u3002\ndocker logs --since=\"2016-07-01\" --tail=10 mynginx\n\n# \u53ef\u4ee5\u4f7f\u7528docker inspect \u83b7\u53d6\u5bb9\u5668/\u955c\u50cf\u7684\u5143\u6570\u636e\u3002\n\n## \u6bd4\u5982\u67e5\u770b\u4e00\u4e2a\u6b63\u5728\u8fd0\u884c\u7684\u5bb9\u5668\u7684\u7aef\u53e3\u4fe1\u606f\uff1a\nrunoob@runoob:~$ docker inspect mysql:5.6 |  grep Port\n\n## \u83b7\u53d6\u6b63\u5728\u8fd0\u884c\u7684\u5bb9\u5668mymysql\u7684 IP\u3002\nrunoob@runoob:~$ docker inspect --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' mymysql\n172.17.0.3\n\n## \u5f53\u7136\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528docker history\u67e5\u770b\u4e00\u4e2a\u955c\u50cf\u7684\u6784\u5efa\u4fe1\u606f\uff1a\nrunoob@runoob:~$ docker history 6320f1d0fb26\n</code></pre> <p>\u4e0a\u8ff0\u6f14\u793a\u7684\u90fd\u662fDocker\u5e38\u7528\u7684\u57fa\u672c\u547d\u4ee4\uff0c\u5df2\u53ef\u4ee5\u6ee1\u8db3\u65e5\u5e38\u5de5\u4f5c\u9700\u6c42\uff0c\u5982\u679c\u8bfb\u8005\u60f3\u8981\u6df1\u5165\u4e86\u89e3\uff0c\u53ef\u4ee5\u53c2\u8003Docker\u7684\u76f8\u5173\u8d44\u6599\u6216\u4e66\u7c4d\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/#4-dockerfile\u7684\u7f16\u5199","title":"4. Dockerfile\u7684\u7f16\u5199","text":"<p>Dockerfile\u662f\u7528\u6765\u5feb\u901f\u521b\u5efa\u81ea\u5b9a\u4e49\u955c\u50cf\u7684\u4e00\u79cd\u6587\u672c\u683c\u5f0f\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5728\u6301\u7eed\u96c6\u6210\u548c\u6301\u7eed\u90e8\u7f72\u65f6\uff0c\u9700\u8981\u4f7f\u7528Dockerfile\u751f\u6210\u76f8\u5173\u5e94\u7528\u7a0b\u5e8f\u7684\u955c\u50cf\uff0c\u7136\u540e\u63a8\u9001\u5230\u516c\u53f8\u5185\u90e8\u4ed3\u5e93\u4e2d\uff0c\u518d\u901a\u8fc7\u90e8\u7f72\u7b56\u7565\u628a\u955c\u50cf\u90e8\u7f72\u5230Kubernetes\u4e2d\u3002</p> <p>\u672c\u8282\u5c06\u6f14\u793a\u5982\u4f55\u4f7f\u7528Dockerfile\u6784\u5efa\u81ea\u5df1\u7684\u4e1a\u52a1\u955c\u50cf\u3002</p> <p>\u901a\u8fc7Dockerfile\u63d0\u4f9b\u7684\u547d\u4ee4\u53ef\u4ee5\u7f16\u5199Dockerfile\u6587\u4ef6\uff0cDockerfile\u7684\u5e38\u7528\u547d\u4ee4\u5982\u4e0b\uff1a</p> <ul> <li>FROM\uff1a\u7ee7\u627f\u57fa\u7840\u955c\u50cf\u3002</li> <li>MAINTAINER\uff1a\u955c\u50cf\u5236\u4f5c\u4f5c\u8005\u7684\u4fe1\u606f\uff0c\u5df2\u5f03\u7528\uff0c\u4f7f\u7528LABEL\u66ff\u4ee3\u3002</li> <li>LABEL\uff1ak=v\u5f62\u5f0f\uff0c\u5c06\u4e00\u4e9b\u5143\u6570\u636e\u6dfb\u52a0\u81f3\u955c\u50cf\u3002</li> <li>RUN\uff1a\u7528\u6765\u6267\u884cshell\u547d\u4ee4\u3002</li> <li>EXPOSE\uff1a\u66b4\u9732\u7aef\u53e3\u53f7\u3002</li> <li>CMD\uff1a\u542f\u52a8\u5bb9\u5668\u9ed8\u8ba4\u6267\u884c\u7684\u547d\u4ee4\uff0c\u4f1a\u88ab\u8986\u76d6\u3002</li> <li>ENTRYPOINT\uff1a\u542f\u52a8\u5bb9\u5668\u771f\u6b63\u6267\u884c\u7684\u547d\u4ee4\uff0c\u4e0d\u4f1a\u88ab\u8986\u76d6\u3002</li> <li>VOLUME\uff1a\u521b\u5efa\u6302\u8f7d\u70b9\u3002</li> <li>ENV\uff1a\u914d\u7f6e\u73af\u5883\u53d8\u91cf\u3002</li> <li>ADD\uff1a\u590d\u5236\u6587\u4ef6\u5230\u5bb9\u5668\uff0c\u4e00\u822c\u590d\u5236\u6587\u4ef6\uff0c\u538b\u7f29\u5305\u81ea\u52a8\u89e3\u538b\u3002</li> <li>COPY\uff1a\u590d\u5236\u6587\u4ef6\u5230\u5bb9\u5668\uff0c\u4e00\u822c\u590d\u5236\u76ee\u5f55\u3002</li> <li>WORKDIR\uff1a\u8bbe\u7f6e\u5bb9\u5668\u7684\u5de5\u4f5c\u76ee\u5f55\u3002</li> <li>USER\uff1a\u5bb9\u5668\u4f7f\u7528\u7684\u7528\u6237\u3002</li> <li>ARG\uff1a\u8bbe\u7f6e\u7f16\u8bd1\u955c\u50cf\u65f6\u4f20\u5165\u7684\u53c2\u6570\u3002</li> </ul> <p>\u4ee5\u4e0b\u7b80\u5355\u6f14\u793a\u6bcf\u4e2a\u547d\u4ee4\u7684\u4f7f\u7528\u65b9\u6cd5\u3002\u4f7f\u7528RUN\u521b\u5efa\u4e00\u4e2a\u7528\u6237\uff1a</p> <p><code>Dockerfile</code></p> <pre><code># base image\nFROM centos:7\nMAINTAINER dot\nRUN useradd dot\n</code></pre> <pre><code># \u6267\u884c\u6784\u5efa\n$ docker build -t centos:user .\n</code></pre> <p>\u4f7f\u7528ENV\u5b9a\u4e49\u73af\u5883\u53d8\u91cf\u5e76\u7528CMD\u6267\u884c\u547d\u4ee4\uff1a</p> <p><code>Dockerfile</code></p> <pre><code># base image\nFROM centos:7\nMAINTAINER dot\nRUN useradd dot\nRUN mkdir dot\nENV envir=test version=1.0\nCMD echo \"envir:$envir version:$version\"\n</code></pre> <p>\u6267\u884c\u6784\u5efa\u5e76\u542f\u52a8\u6d4b\u8bd5\uff1a</p> <pre><code># \u6267\u884c\u6784\u5efa\n$ docker build -t centos:env-cmd .\n\n# \u542f\u52a8\u955c\u50cf\u9a8c\u8bc1ENV\u548cCMD\n$ docker run centos:env-cmd\nenvir:test version:1.0\n</code></pre> <p>\u5f53\u7136\uff0c\u4e0a\u8ff0CMD\u5b9e\u73b0\u7684\u529f\u80fd\uff0c\u4f7f\u7528ENTRYPOINT\u4e5f\u53ef\u4ee5\u5b9e\u73b0\u76f8\u540c\u7684\u6548\u679c\uff0c\u5bf9\u5e94\u7684Dockerfile\u5982\u4e0b\uff1a</p> <p><code>Dockerfile</code></p> <pre><code># base image\nFROM centos:7\nMAINTAINER dot\nRUN useradd dot\nRUN mkdir dot\nENV envir=test version=1.0\n#CMD echo \"envir:$envir version:$version\"\nENTRYPOINT echo \"envir:$envir version:$version\"\n</code></pre> <p>\u6267\u884c\u6784\u5efa\u5e76\u6d4b\u8bd5\uff1a</p> <pre><code>$ docker build -t centos:entrypoint .\n\n$ docker run --rm centos:entrypoint\nenvir:test version:1.0\n</code></pre> <p>\u53ef\u4ee5\u770b\u51fa\uff0c\u65e0\u8bba\u662f\u4f7f\u7528CMD\u8fd8\u662fENTRYPOINT\u5b9e\u73b0\u7684\u6548\u679c\u90fd\u662f\u4e00\u6837\u7684\uff0c\u90a3\u5b83\u4eec\u7684\u533a\u522b\u662f\u4ec0\u4e48\u5462\uff1f</p> <p>\u548c\u4e0a\u8ff0\u8bb2\u7684\u4e00\u6837\uff0cCMD\u5728\u4f7f\u7528docker run\u65f6\u53ef\u4ee5\u88ab\u76f4\u63a5\u8986\u76d6\uff0c\u6bd4\u5982\u6211\u4eec\u4f7f\u7528docker run\u542f\u52a8centos:env-cmd\u955c\u50cf\uff0c\u5e76\u5728\u540e\u9762\u6307\u5b9a\u542f\u52a8\u547d\u4ee4\uff0c\u6b64\u65f6CMD\u5c31\u4f1a\u88ab\u8986\u76d6\uff1a</p> <pre><code>$ docker run --rm centos:env-cmd echo \"cover...\"\ncover...\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u4f7f\u7528\u4e00\u4e2a\u65b0\u7684echo\u547d\u4ee4\u8986\u76d6\u4e86CMD\u7684echo\u547d\u4ee4\uff0c\u800c\u5728ENTRYPOINT\u6307\u5b9a\u7684\u4e0d\u80fd\u88ab\u76f4\u63a5\u8986\u76d6\uff0c\u540e\u7f6e\u7684\u547d\u4ee4\u4f1a\u88ab\u5f53\u4f5cENTRYPOINT\u7684\u53c2\u6570\uff0c\u6bd4\u5982\u76f8\u540c\u7684\u542f\u52a8\u53c2\u6570\uff1a</p> <pre><code>$ docker run --rm centos:entrypoint cannot cover...\nenvir:test version:1.0\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6253\u5370\u7684\u8fd8\u662fENTRYPOINT\u4e2d\u7684\u4fe1\u606f\uff0c\u5f53\u7136ENTRYPOINT\u4e5f\u662f\u53ef\u4ee5\u88ab\u8986\u76d6\u7684\uff0c</p> <p>\u9700\u8981\u6307\u5b9a--entrypoint\u53c2\u6570\uff0c\u6bd4\u5982\u6211\u4eec\u6307\u5b9aentrypoint\u4e3als\uff0c\u540e\u7f6e\u547d\u4ee4\u4e3a/tmp\uff0c\u5c31\u76f8\u5f53\u4e8eENTRYPOINT\u662fls\uff0cCMD\u662f/tmp\uff1a</p> <pre><code>$ docker run --rm --entrypoint=ls  centos:entrypoint /tmp\nanaconda-post.log\nyum.log\n</code></pre> <p>\u4f7f\u7528ADD\u6dfb\u52a0\u4e00\u4e2a\u538b\u7f29\u5305\uff0c\u4f7f\u7528WORKDIR\u6539\u53d8\u5de5\u4f5c\u76ee\u5f55\uff1a</p> <p><code>Dockerfile</code></p> <pre><code># base image\nFROM nginx\nMAINTAINER dot\nADD ./index.tar.gz /usr/share/nginx/html/\nWORKDIR /usr/share/nginx/html\n</code></pre> <p>\u6ce8\u610f</p> <p>\u4f7f\u7528COPY\u548cADD\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528<code>--chown=&lt;user&gt;:&lt;group&gt;</code>\u76f4\u63a5\u8fdb\u884c\u6587\u4ef6\u6743\u9650\u7684\u66f4\u6539\uff0c\u8fd9\u6837\u5c31\u4e0d\u7528\u4f7f\u7528RUN\u5728\u5bb9\u5668\u91cc\u9762\u6267\u884cchown\uff0c\u4e0d\u4ec5\u65b9\u4fbf\uff0c\u8fd8\u53ef\u4ee5\u7f29\u5c0f\u955c\u50cf\u7684\u4f53\u79ef\u3002</p> <p>\u4f7f\u7528USER\u8bbe\u7f6e\u542f\u52a8\u5bb9\u5668\u7684\u7528\u6237\uff0c\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4e00\u822c\u4e0d\u5efa\u8bae\u4f7f\u7528root\u542f\u52a8\u5bb9\u5668\uff0c\u6240\u4ee5\u53ef\u4ee5\u6839\u636e\u516c\u53f8\u4e1a\u52a1\u573a\u666f\u81ea\u5b9a\u4e49\u542f\u52a8\u5bb9\u5668\u7684\u7528\u6237\uff1a</p> <pre><code># base image\nFROM centos:7\nMAINTAINER dot\nADD ./index.tar.gz /usr/share/nginx/html/\nWORKDIR /usr/share/nginx/html\nCOPY webroot/ .\nRUN useradd -m tomcat -u 1001\nUSER 1001\n</code></pre> <p>\u4f7f\u7528Volume\u521b\u5efa\u5bb9\u5668\u53ef\u6302\u8f7d\u70b9\uff1a</p> <pre><code># base image\nFROM centos:7\nMAINTAINER dot\nVOLUME /data\n</code></pre> <p>\u6302\u8f7dWeb\u76ee\u5f55\u5230/data\uff0c\u6ce8\u610f\u5bf9\u4e8e\u5bbf\u4e3b\u673aWeb\u76ee\u5f55\u8981\u5199\u7edd\u5bf9\u8def\u5f84\uff1a</p> <pre><code>$ docker build -t centos:volume .\n$ docker run -ti --rm -v `pwd`/web:/data centos:volume bash\n</code></pre> <p>\u4e0a\u8ff0\u6f14\u793a\u7684Dockerfile\u4f7f\u7528MAINTAINER\u5b9a\u4e49\u4e86\u4f5c\u8005\u4fe1\u606f\uff0c\u4f46\u662f\u8fd9\u4e2a\u53c2\u6570\u5c06\u6765\u4f1a\u88ab\u5f03\u7528\uff0c\u53ef\u4ee5\u4f7f\u7528LABEL\u8fdb\u884c\u66ff\u6362\uff1a</p> <pre><code># base image\nFROM centos:7\n# MAINTAINER dot # \u5373\u5c06\u5e9f\u5f03\nLABEL maintainer=\"dot\" version=\"demo\"\nLABEL multiple=\"true\"\n</code></pre> <p>\u5236\u4f5c\u955c\u50cf\u5e76\u67e5\u770b\u955c\u50cf\u4fe1\u606f\uff1a</p> <pre><code>$ docker build -t test:label .\n$ docker inspect test:label|grep Labels -A 10\n\"Labels\": {\n\"maintainer\": \"dot\",\n                \"multiple\": \"true\",\n                \"org.label-schema.build-date\": \"20181006\",\n                \"org.label-schema.license\": \"GPLv2\",\n                \"org.label-schema.name\": \"CentOS Base Image\",\n                \"org.label-schema.schema-version\": \"1.0\",\n                \"org.label-schema.vendor\": \"CentOS\",\n                \"version\": \"demo\"\n}\n},\n--\n            \"Labels\": {\n\"maintainer\": \"dot\",\n                \"multiple\": \"true\",\n                \"org.label-schema.build-date\": \"20181006\",\n                \"org.label-schema.license\": \"GPLv2\",\n                \"org.label-schema.name\": \"CentOS Base Image\",\n                \"org.label-schema.schema-version\": \"1.0\",\n                \"org.label-schema.vendor\": \"CentOS\",\n                \"version\": \"demo\"\n}\n},\n</code></pre> <p>\u6709\u65f6\u5019\u53ef\u80fd\u9700\u8981\u52a8\u6001\u751f\u6210Dockerfile\uff0c\u53ef\u4ee5\u4f7f\u7528ARG\u548cbuild-arg\u4f20\u5165\u52a8\u6001\u53d8\u91cf\uff1a</p> <p><code>Dockerfile</code></p> <pre><code># base image\nFROM centos:7\n# MAINTAINER dot # \u5373\u5c06\u5e9f\u5f03\nLABEL maintainer=\"dot\" version=\"demo\"\nLABEL multiple=\"true\"\nARG USERNAME\nARG DIR=\"defaultValue\"\nRUN useradd -m $USERNAME -u 1001 &amp;&amp; mkdir $DIR\n</code></pre> <pre><code>$ docker build --build-arg USERNAME=\"hujianli\" -t test:arg .\n$ docker run -it --rm test:arg bash\n[root@e2ac1faeb945 /]# ls\nanaconda-post.log  bin  defaultValue  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var\n[root@e2ac1faeb945 /]# tail -1 /etc/passwd\nhujianli:x:1001:1001::/home/hujianli:/bin/bash\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/#5-\u955c\u50cf\u5927\u5c0f\u4f18\u5316","title":"5. \u955c\u50cf\u5927\u5c0f\u4f18\u5316","text":"<p>\u4e0a\u8ff0\u4f7f\u7528Dockerfile\u521b\u5efa\u7684\u955c\u50cf\u90fd\u662f\u4f7f\u7528CentOS\u4f5c\u4e3a\u57fa\u7840\u955c\u50cf\uff0c\u4f7f\u7528CentOS\u76f4\u63a5\u4f5c\u4e3a\u4e1a\u52a1\u5e94\u7528\u5bb9\u5668\u7684\u57fa\u7840\u955c\u50cf\u662f\u975e\u5e38\u4e0d\u5efa\u8bae\u7684\uff0c\u56e0\u4e3a\u8fd9\u6837\u505a\u51fa\u6765\u7684\u955c\u50cf\uff0c\u4e0d\u4ec5\u955c\u50cf\u7684\u4f53\u79ef\u6bd4\u8f83\u5927\uff0c\u800c\u4e14CentOS\u5b89\u88c5\u4e86\u5f88\u591a\u4e1a\u52a1\u5e94\u7528\u7a0b\u5e8f\u7528\u4e0d\u5230\u7684\u5305\uff0c\u53ef\u80fd\u4f1a\u6709\u66f4\u591a\u7684\u6f0f\u6d1e\u548c\u98ce\u9669\u3002</p> <p>\u6f0f\u6d1e\u548c\u98ce\u9669\u53ef\u4ee5\u4f7f\u7528\u955c\u50cf\u4ed3\u5e93\u81ea\u5e26\u7684\u6f0f\u6d1e\u626b\u63cf\u68c0\u6d4b\u51fa\u6765\uff0c\u7136\u540e\u201c\u5bf9\u75c7\u4e0b\u836f\u201d\u5373\u53ef\u89e3\u51b3\uff0c\u800c\u955c\u50cf\u7684\u5927\u5c0f\u9700\u8981\u4e00\u6b65\u6b65\u8fdb\u884c\u4f18\u5316\uff0c\u624d\u80fd\u66f4\u597d\u5730\u7528\u4e8e\u6211\u4eec\u7684\u751f\u4ea7\u73af\u5883\uff0c\u6240\u4ee5\u5148\u770b\u4e00\u4e0b\u955c\u50cf\u662f\u5982\u4f55\u751f\u6210\u7684\uff0c\u518d\u53bb\u51b3\u5b9a\u5982\u4f55\u4f18\u5316\u955c\u50cf\u4f53\u79ef\u3002</p> <p>\u9996\u5148\u6211\u4eec\u53ef\u4ee5\u770b\u4e00\u4e0b\u4e4b\u524d\u7531CentOS\u4f5c\u4e3a\u57fa\u7840\u955c\u50cf\u751f\u6210\u7684\u955c\u50cf\u4f53\u79ef\uff0c\u6bd4\u5982\u67e5\u770b\u4e00\u4e0b\u4e0a\u8ff0\u521b\u5efa\u7528\u6237\u7684\u57fa\u7840\u955c\u50cf\u4f53\u79ef\uff1a</p> <p>\u9996\u5148\u770b\u4e00\u4e0b\u521b\u5efa\u7528\u6237\u7684Dockerfile\uff1a</p> <p><code>Dockerfile</code></p> <pre><code># base image\nFROM centos:7\nMAINTAINER dot\nRUN useradd dot\n</code></pre> <p>\u518d\u6765\u770b\u4e00\u4e0b\u6267\u884cdocker build\u751f\u6210\u955c\u50cf\u65f6\u63a7\u5236\u53f0\u7684\u65e5\u5fd7\uff1a</p> <pre><code>$ docker build --no-cache -t centos:user .\nSending build context to Docker daemon  2.048kB\nStep 1/3 : FROM centos:7\n ---&gt; 5bf9684f4720\nStep 2/3 : MAINTAINER dot\n ---&gt; Running in 3e0c4943c5c0\nRemoving intermediate container 3e0c4943c5c0\n ---&gt; 5e490e30904c\nStep 3/3 : RUN useradd dot\n ---&gt; Running in c9210984990e\nRemoving intermediate container c9210984990e\n ---&gt; ee8c7f2dda93\nSuccessfully built ee8c7f2dda93\nSuccessfully tagged centos:user\n</code></pre> <p>\u6ce8\u610f</p> <p>docker\u6267\u884cbuild\u65f6\uff0c\u4f1a\u4e3a\u6bcf\u4e2a\u6307\u4ee4\u751f\u6210\u4e00\u4e2a\u7f13\u5b58\u5c42\uff0c\u5982\u679c\u6709\u76f8\u540c\u7684\u6307\u4ee4\uff0c\u4f1a\u9ed8\u8ba4\u4f7f\u7528\u4e4b\u524d\u5df2\u7ecf\u4ea7\u751f\u7684\u7f13\u5b58\uff0c--no-cache\u8868\u793a\u4e0d\u4f7f\u7528\u672c\u5730\u7f13\u5b58\u8fdb\u884c\u6784\u5efa\u3002 </p> <p>\u53ef\u4ee5\u770b\u5230\u6bcf\u4e00\u884cDockerfile\u7684\u6307\u4ee4\u90fd\u4f1a\u751f\u6210\u4e00\u4e2a\u5c42\uff0c\u8fd9\u4e9b\u5c42\u201c\u645e\u201d\u5728\u4e00\u8d77\u5c31\u7ec4\u6210\u4e86\u4e00\u4e2a\u65b0\u7684\u955c\u50cf.</p> <p>\u67e5\u770b\u4e00\u4e0b\u4e0a\u8ff0\u521b\u5efa\u7528\u6237\u7684\u57fa\u7840\u955c\u50cf\u4f53\u79ef\uff1a</p> <pre><code>$ docker images centos:user\nREPOSITORY   TAG       IMAGE ID       CREATED         SIZE\ncentos       user      ee8c7f2dda93   6 minutes ago   194MB\n</code></pre> <p>\u7531\u6b64\u53ef\u4ee5\u770b\u51fa\uff0c\u4e00\u4e2a\u955c\u50cf\u662f\u7531\u5f88\u591aDockerfile\u7684\u6307\u4ee4\u751f\u6210\u7684\u5c42\u7ec4\u6210\u7684\uff0c\u800c\u955c\u50cf\u7684\u4f53\u79ef\u5927\u5c0f\u5c31\u662f\u6bcf\u4e2a\u5c42\u7684\u5927\u5c0f\u51b3\u5b9a\u7684\uff0c\u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528docker history\u770b\u4e00\u4e0b\u6bcf\u4e2a\u5c42\u7684\u5927\u5c0f\uff1a</p> <pre><code>$ docker history centos:user\nIMAGE          CREATED         CREATED BY                                      SIZE      COMMENT\nee8c7f2dda93   7 minutes ago   /bin/sh -c useradd dot                          150kB\n5e490e30904c   7 minutes ago   /bin/sh -c #(nop)  MAINTAINER dot               0B\n5bf9684f4720   12 months ago   /bin/sh -c #(nop)  CMD [\"/bin/bash\"]            0B\n&lt;missing&gt;      12 months ago   /bin/sh -c #(nop)  LABEL org.label-schema.sc\u2026   0B\n&lt;missing&gt;      12 months ago   /bin/sh -c #(nop) ADD file:0065316a41144e95b\u2026   194MB\n&lt;missing&gt;      12 months ago   /bin/sh -c #(nop)  MAINTAINER https://github\u2026   0B\n</code></pre> <p>\u7531\u4e0a\u8ff0\u7ed3\u679c\u53ef\u4ee5\u770b\u51fa\uff0cFROM xxx\u4e4b\u540e\u7684MAINTAINER\u548cRUN useradd\u6307\u4ee4\u5206\u522b\u5360\u7528\u4e860B\u548c150KB\uff0c\u800c\u5236\u4f5c\u51fa\u6765\u7684centos:user\u955c\u50cf\u4f53\u79ef\u5374\u8fbe\u5230\u4e86194MB\uff0c\u8fd9\u4e2a\u5927\u5c0f\u5b9e\u9645\u662fFROM\u7684\u57fa\u7840CentOS\u5360\u7528\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\u57fa\u7840\u955c\u50cf\u6765\u4f18\u5316\u4e0a\u8ff0\u955c\u50cf\u7684\u5927\u5c0f\u3002</p> <p>\u5bf9\u4e8e\u57fa\u7840\u955c\u50cf\u7684\u9009\u62e9\uff0c\u6bd4\u8f83\u5e38\u7528\u7684\u6709Alpine\u3001Busybox\u3001Scratch\u3001Debian\u7b49\u3002</p> <p>\u6bcf\u79cd\u57fa\u7840\u955c\u50cf\u7684\u5305\u7ba1\u7406\u65b9\u5f0f\u53ef\u80fd\u6709\u6240\u5dee\u5f02\uff0c</p> <p>\u6bd4\u5982Alpine\u7684\u5305\u7ba1\u7406\u5de5\u5177\u662fAPK\uff08\u4f7f\u7528\u6587\u6863\uff1ahttps://wiki.alpinelinux.org/wiki/Alpine_Linux_package_management)\uff0c</p> <p>\u5bf9\u4e8e\u6ca1\u6709\u63a5\u89e6\u8fc7Alpine\u7cfb\u7edf\u7684\u8bfb\u8005\u4f1a\u6709\u6240\u964c\u751f\uff0c\u4f46\u662fAlpine\u662f\u76ee\u524d\u6700\u6d41\u884c\u7684\u57fa\u7840\u955c\u50cf\u4e4b\u4e00\uff0c\u56e0\u4e3aAlpine\u4e0d\u4ec5\u4f53\u79ef\u5c0f\u3001\u4f7f\u7528\u7b80\u5355\uff0c\u540c\u65f6\u4e5f\u5305\u542b\u6392\u67e5\u76f8\u5173\u95ee\u9898\u7684\u57fa\u672c\u5de5\u5177\uff0c \u6240\u4ee5\u4e0b\u9762\u4e3b\u8981\u6f14\u793a\u4f7f\u7528Alpine\u4f5c\u4e3a\u57fa\u7840\u955c\u50cf\u8fdb\u884c\u6784\u5efa\u3002</p> <p>\u9996\u5148\u5c06\u4e4b\u524d\u521b\u5efa\u7528\u6237\u7684Dockerfile\u6539\u4e3aAlpine\u955c\u50cf\uff1a</p> <p><code>Dockerfile-Alpine</code></p> <pre><code># base image\n# FROM centos:7\nFROM alpine:3.12\nMAINTAINER dot\nRUN adduser -D dot\n</code></pre> <p>\u6ce8\u610f</p> <p>Alpine\u955c\u50cf\u521b\u5efa\u7528\u6237\u7684\u547d\u4ee4\u4e3aadduser\uff0c-D\u8868\u793a\u4e0d\u8bbe\u7f6e\u5bc6\u7801\u3002</p> <p>\u6267\u884c\u6784\u5efa\u5e76\u67e5\u770b\u955c\u50cf\u5927\u5c0f\uff1a</p> <pre><code>$ docker build -t alpine:user -f Dockerfile-Alpine .\n\n$ docker images alpine:user\nREPOSITORY   TAG       IMAGE ID       CREATED          SIZE\nalpine       user      ec242dac3ba8   45 seconds ago   5.6MB\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u66f4\u6539\u4e3aAlpine\u955c\u50cf\u540e\uff0c\u6267\u884c\u76f8\u540c\u529f\u80fd\u7684\u6307\u4ee4\uff0c\u955c\u50cf\u4f53\u79ef\u51cf\u5c0f\u4e86\u5c06\u8fd1190MB\uff0c\u6240\u4ee5\u9009\u62e9\u5408\u9002\u7684\u57fa\u7840\u955c\u50cf\u51b3\u5b9a\u4e86\u540e\u671f\u4e1a\u52a1\u5e94\u7528\u955c\u50cf\u7684\u5927\u5c0f\uff0c\u8fd9\u79cd\u65b9\u5f0f\u662f\u4f18\u5316\u955c\u50cf\u5927\u5c0f\u6700\u7b80\u5355\u3001\u6700\u6709\u6210\u6548\u7684\u65b9\u6cd5\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/#6-\u591a\u9636\u6bb5\u6784\u5efa","title":"6. \u591a\u9636\u6bb5\u6784\u5efa","text":"<p>\u901a\u4fd7\u6765\u8bb2\uff0c\u591a\u9636\u6bb5\u6784\u5efa\u5c31\u662f\u5728Dockerfile\u4e2d\u5b9a\u4e49\u591a\u4e2aFROM\uff0c\u6bcf\u4e2aFROM\u4e0b\u6709\u591a\u4e2a\u4e0d\u540c\u7684\u6307\u4ee4\uff0c</p> <p>\u4e00\u822c\u53ef\u7b80\u5355\u5206\u4e3a\u6784\u5efa\u6b65\u9aa4\u548c\u751f\u6210\u4e1a\u52a1\u5e94\u7528\u955c\u50cf\u6b65\u9aa4\uff0c\u4e5f\u5c31\u662f\u8bf4\u524d\u9762\u4e00\u4e2a\u6216\u591a\u4e2a\u9636\u6bb5\u7528\u4e8e\u6784\u5efa\uff0c\u4ea7\u751f\u4e1a\u52a1\u5e94\u7528\u7684\u5305\u6216\u5176\u4ed6\u4ea7\u7269\uff0c\u4e4b\u540e\u7684\u9636\u6bb5\u5c06\u4e0a\u8ff0\u9636\u6bb5\u4ea7\u751f\u7684\u5305\u6216\u5176\u4ed6\u4ea7\u7269\u518d\u6b21\u6784\u5efa\u6210\u955c\u50cf\u3002</p> <p>\u8fd9\u6837\u4e00\u6765\uff0c\u6700\u540e\u4e00\u6b65\u5c31\u6ca1\u6709\u4e86\u6784\u5efa\u65f6\u4ea7\u751f\u7684\u7f13\u5b58\u6587\u4ef6\uff0c\u4e5f\u8d77\u5230\u4e86\u4f18\u5316\u955c\u50cf\u4f53\u79ef\u7684\u4f5c\u7528\u3002</p> <p>\u5047\u5982\u6709\u4e00\u4e2a\u7528Go\u8bed\u8a00\u5f00\u53d1\u7684\u5e94\u7528\uff0c\u6b64\u5904\u7528Hello World\u4ee3\u66ff\uff1a</p> <p><code>hw.go</code></p> <pre><code>package main\nimport (\n\"fmt\"\n)\nfunc main() {\nfmt.Println(\"Hello, Docker\")\n}\n</code></pre> <p>\u9996\u5148\u4f7f\u7528\u5355\u4e2a\u6b65\u9aa4\u6784\u5efa\uff0c\u770b\u4e00\u4e0b\u5236\u4f5c\u51fa\u6765\u7684\u955c\u50cf\u5927\u5c0f\uff0c\u6b64\u65f6\u7684Dockerfile\u5982\u4e0b\uff1a</p> <pre><code># build step\nFROM golang:1.14.4-alpine\nWORKDIR /opt\nCOPY main.go /opt\nRUN go build /opt/main.go\nCMD \"./main\"\n</code></pre> <p>\u6267\u884c\u6784\u5efa\u5e76\u8fd0\u884c\u6d4b\u8bd5\uff1a</p> <pre><code>$ docker build -t hw:one .\nSending build context to Docker daemon  3.072kB\nStep 1/5 : FROM golang:1.14.4-alpine\n1.14.4-alpine: Pulling from library/golang\ndf20fa9351a1: Already exists\ned8968b2872e: Pull complete\na92cc7c5fd73: Pull complete\n9e0cccf56431: Pull complete\ncbe0275821fc: Pull complete\nDigest: sha256:6042b9cfb4eb303f3bdcbfeaba79b45130d170939318de85ac5b9508cb6f0f7e\nStatus: Downloaded newer image for golang:1.14.4-alpine\n ---&gt; 3289bf11c284\nStep 2/5 : WORKDIR /opt\n ---&gt; Running in b3ad0380a523\nRemoving intermediate container b3ad0380a523\n ---&gt; c95cf0455ed8\nStep 3/5 : COPY main.go /opt\n ---&gt; 4ce646e91031\nStep 4/5 : RUN go build /opt/main.go\n ---&gt; Running in edae50f0d115\nRemoving intermediate container edae50f0d115\n ---&gt; d0461b015ac5\nStep 5/5 : CMD \"./main\"\n---&gt; Running in 50ec99c207ac\nRemoving intermediate container 50ec99c207ac\n ---&gt; f84fdae5b52e\nSuccessfully built f84fdae5b52e\nSuccessfully tagged hw:one\n\n$ docker run --rm app:one\nHello Docker!\n</code></pre> <p>\u67e5\u770b\u6b64\u65f6\u7531\u4e00\u4e2a\u9636\u6bb5\u6784\u5efa\u7684\u955c\u50cf\u5927\u5c0f\uff1a</p> <pre><code>$ docker images app:one\nREPOSITORY   TAG       IMAGE ID       CREATED          SIZE\napp           one       f84fdae5b52e   53 seconds ago   372MB\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6b64\u65f6\u955c\u50cf\u5927\u5c0f\u4e3a372MB\uff0c\u4f46\u662f\u4e0a\u8ff0\u4ee3\u7801\u6211\u4eec\u53ea\u9700\u8981\u6784\u5efa\u6b65\u9aa4\u4ea7\u751f\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6hw\u5373\u53ef\uff0c\u8fd9\u4e2a\u6587\u4ef6\u5927\u5c0f\u53ef\u4ee5\u8fdb\u5165\u5bb9\u5668\u5185\u90e8\u770b\u4e00\u4e0b\uff1a</p> <pre><code>$ docker run --rm app:one du -sh ./hw\n2.0M    ./main\n</code></pre> <p>\u771f\u6b63\u9700\u8981\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u53ea\u67092MB\uff0c\u5982\u679c\u4f7f\u7528\u4e0a\u8ff0\u65b9\u6cd5\u6267\u884c\u6784\u5efa\u5e76\u751f\u6210\u4e1a\u52a1\u955c\u50cf\uff0c\u90a3\u4e48\u751f\u6210\u7684\u955c\u50cf\u5c06\u4f1a\u591a\u7528370MB\u7a7a\u95f4\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4f7f\u7528\u591a\u9636\u6bb5\u6784\u5efa\uff0c\u5c06\u6784\u5efa\u6b65\u9aa4\u548c\u751f\u6210\u4e1a\u52a1\u955c\u50cf\u7684\u6b65\u9aa4\u62c6\u5206\uff0c\u4e4b\u540e\u5c06\u4e8c\u8fdb\u5236\u5305\u653e\u7f6e\u5728\u67d0\u4e2a\u53ef\u4ee5\u8fd0\u884c\u8be5\u4e8c\u8fdb\u5236\u5305\u7684\u57fa\u7840\u955c\u50cf\u4e2d\u5373\u53ef\u3002</p> <p>\u5047\u5982\u6211\u4eec\u4f7f\u7528alpine\u955c\u50cf\u5236\u4f5c\u4e1a\u52a1\u5e94\u7528\u955c\u50cf\uff0c\u6b64\u65f6\u7684\u591a\u9636\u6bb5Dockerfile\u5982\u4e0b\uff1a</p> <p><code>Dockerfile-multi</code></p> <pre><code># \u6784\u5efa\u8fc7\u7a0b\nFROM golang:1.14.4-alpine as builder\nRUN mkdir -p /go/src/test\nWORKDIR /go/src/test\nCOPY main.go .\nRUN CGO_ENABLED=0 GOOS=linux go build -o app .\n\n# \u751f\u6210\u5e94\u7528\u955c\u50cf\u8fc7\u7a0b\nFROM alpine:latest\nRUN apk --no-cache add ca-certificates\nWORKDIR /root/\nCOPY --from=builder /go/src/test/app . CMD [\"./app\"]\n</code></pre> <p>Info</p> <p>FROM xxx as xxx\u7528\u4e8e\u7ed9\u67d0\u4e2a\u9636\u6bb5\u8d77\u4e00\u4e2a\u522b\u540d\uff0c\u5728\u5176\u4ed6\u9636\u6bb5\u4f7f\u7528--from=\u522b\u540d\u8fdb\u884c\u5f15\u7528\uff0c\u5982\u679c\u4e0d\u7528\u522b\u540d\uff0c\u53ef\u4ee5\u4ece\u4e0a\u5f80\u4e0b\u75280/\u00bd/x\u4ee3\u66ff\u3002</p> <p>\u518d\u6b21\u6784\u5efa\u540e\uff0c\u67e5\u770b\u6b64\u65f6\u7684\u955c\u50cf\u5927\u5c0f\u548c\u8fd0\u884c\u955c\u50cf\u7684\u6548\u679c\uff1a</p> <pre><code>$ docker build -t app:multi -f Dockerfile-multi .\nSending build context to Docker daemon  4.096kB\nStep 1/10 : FROM golang:1.14.4-alpine as builder\n ---&gt; 3289bf11c284\nStep 2/10 : RUN mkdir -p /go/src/test\n ---&gt; Running in 24d124976f73\nRemoving intermediate container 24d124976f73\n ---&gt; c6538795744e\nStep 3/10 : WORKDIR /go/src/test\n ---&gt; Running in f867d3a9cd05\nRemoving intermediate container f867d3a9cd05\n ---&gt; cefb6e9a949e\nStep 4/10 : COPY main.go .\n ---&gt; c34840a6f11f\nStep 5/10 : RUN CGO_ENABLED=0 GOOS=linux go build -o app .\n ---&gt; Running in 0d9affe015fc\nRemoving intermediate container 0d9affe015fc\n ---&gt; c0585768e984\nStep 6/10 : FROM alpine:latest\n ---&gt; c059bfaa849c\nStep 7/10 : RUN apk --no-cache add ca-certificates\n ---&gt; Running in 5a4d77d1d91a\nfetch https://dl-cdn.alpinelinux.org/alpine/v3.15/main/x86_64/APKINDEX.tar.gz\nfetch https://dl-cdn.alpinelinux.org/alpine/v3.15/community/x86_64/APKINDEX.tar.gz\n(1/1) Installing ca-certificates (20220614-r0)\nExecuting busybox-1.34.1-r3.trigger\nExecuting ca-certificates-20220614-r0.trigger\nOK: 6 MiB in 15 packages\nRemoving intermediate container 5a4d77d1d91a\n ---&gt; 869318da1537\nStep 8/10 : WORKDIR /root/\n ---&gt; Running in d30a99306ee4\nRemoving intermediate container d30a99306ee4\n ---&gt; 2dd348c39395\nStep 9/10 : COPY --from=builder /go/src/test/app .\n ---&gt; 637d1aaa4553\nStep 10/10 : CMD [\"./app\"]\n---&gt; Running in bc3d7f86b549\nRemoving intermediate container bc3d7f86b549\n ---&gt; defd4f1b7ea5\nSuccessfully built defd4f1b7ea5\nSuccessfully tagged app:multi\n\n# \u67e5\u770b\u6b64\u65f6\u7684\u955c\u50cf\u5927\u5c0f\u548c\u8fd0\u884c\u955c\u50cf\u7684\u6548\u679c\n# \u67e5\u770b\u751f\u6210\u7684\u6700\u7ec8\u955c\u50cf\uff0c\u5927\u5c0f\u53ea\u67098.17MB\n$ docker images|grep multi\napp                                          multi                       defd4f1b7ea5   About a minute ago   8.17MB\n\n$ docker run --rm app:multi\nHello, Docker\n</code></pre> <p>\u4f7f\u7528\u591a\u9636\u6bb5\u6784\u5efa\u4e0d\u4ec5\u5b9e\u73b0\u4e86\u76f8\u540c\u7684\u6548\u679c\uff0c\u800c\u4e14\u8fd8\u8282\u7701\u4e86300\u591a\u5146\u5b57\u8282\uff08MB\uff09\u7684\u78c1\u76d8\u7a7a\u95f4\uff0c\u6240\u4ee5\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u6784\u5efa\u81ea\u5df1\u7684\u4e1a\u52a1\u955c\u50cf\u65f6\uff0c\u53ef\u4ee5\u6839\u636e\u4e0d\u540c\u7684\u8bed\u8a00\u5236\u5b9a\u4e0d\u540c\u7684\u6784\u5efa\u8fc7\u7a0b\uff0c\u62c6\u5206\u4ee3\u7801\u7f16\u8bd1\u8fc7\u7a0b\u548c\u751f\u6210\u4e1a\u52a1\u5e94\u7528\u955c\u50cf\u8fc7\u7a0b\u3002</p> <p>\u6211\u4eec\u5728\u672c\u4e66\u7b2c18\u7ae0\u6301\u7eed\u96c6\u6210\u6301\u7eed\u90e8\u7f72\u90e8\u5206\u4e5f\u4f1a\u6839\u636e\u8fd9\u4e2a\u539f\u7406\u5c06\u4ee3\u7801\u7f16\u8bd1\u548cdocker build\u6b65\u9aa4\u62c6\u5f00\uff0c\u6bcf\u4e2a\u6b65\u9aa4\u5404\u53f8\u5176\u804c\uff0c\u4e0d\u4ec5\u53ef\u4ee5\u4f18\u5316\u6211\u4eec\u7684\u6d41\u6c34\u7ebf\uff0c\u4e5f\u53ef\u4ee5\u964d\u4f4e\u56e0\u4e3a\u6784\u5efa\u6b65\u9aa4\u8bbe\u8ba1\u4e0d\u5408\u7406\u9020\u6210\u7684\u78c1\u76d8\u7a7a\u95f4\u7684\u6d6a\u8d39\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/#7-docker-compose","title":"7. docker-compose","text":"<p>\u53c2\u8003:</p> <p>https://www.bookstack.cn/read/docker_practice-1.3.0/compose-README.md</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/#8-\u5c0f\u7ed3","title":"8. \u5c0f\u7ed3","text":"<p>\u901a\u8fc7\u4e0a\u9762\u7684\u5b66\u4e60\uff0c\u5df2\u7ecf\u8db3\u4ee5\u6ee1\u8db3\u751f\u4ea7\u73af\u5883\u7684\u5404\u7c7b\u9700\u6c42\u3002\u5b9e\u9645\u4f7f\u7528\u65f6\uff0c\u53ef\u80fd\u5e76\u975e\u662f\u4f7f\u7528Docker\u8fdb\u884c\u955c\u50cf\u7684\u5236\u4f5c\uff0c\u4f46\u662f\u76ee\u524dDocker\u7684\u666e\u53ca\u7387\u4f9d\u65e7\u5f88\u9ad8\uff0c\u6240\u4ee5\u5bf9Docker\u7684\u5b66\u4e60\u4e5f\u662f\u975e\u5e38\u91cd\u8981\u7684\u3002\u65e0\u8bba\u4f7f\u7528\u54ea\u79cd\u65b9\u5f0f\u5236\u4f5c\u955c\u50cf\uff0c\u90fd\u9700\u8981\u57fa\u4e8e\"\u4e0d\u7528\u7684\u5de5\u5177\u4e0d\u88c5\u3001\u9009\u62e9\u5c0f\u955c\u50cf\"\u7684\u539f\u5219\uff0c\u8fd9\u6837\u505a\u51fa\u6765\u7684\u955c\u50cf\u624d\u4f1a\u66f4\u5b89\u5168\u3001\u4f53\u79ef\u66f4\u5c0f\uff0c\u624d\u80fd\u8fbe\u5230\u751f\u4ea7\u73af\u5883\u7684\u8981\u6c42\u3002</p> <p>Dockerfile \u5b9e\u8df5</p> <p>https://www.qikqiak.com/k8strain/docker/dockerfile-practice/</p> <p>https://www.qikqiak.com/k8strain2/docker/dockerfile-practice/</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/4.Kubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/","title":"Kubernetes\u7684\u57fa\u7840\u6982\u5ff5","text":""},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/4.Kubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/#1\u4e3a\u4ec0\u4e48\u8981\u7528kubernetes","title":"1.\u4e3a\u4ec0\u4e48\u8981\u7528Kubernetes","text":"<p>\u5f88\u591a\u4eba\u4f1a\u6709\u7591\u95ee\uff0c\u6709Docker\u4e86\u4e3a\u4ec0\u4e48\u8fd8\u7528Kubernetes\uff1f</p> <p>\u5728\u4e1a\u52a1\u5f00\u59cb\u8fdb\u884c\u5bb9\u5668\u5316\u65f6\uff0c\u524d\u671f\u9700\u8981\u5bb9\u5668\u5316\u7684\u9879\u76ee\u53ef\u80fd\u5e76\u4e0d\u591a\uff0c\u6d89\u53ca\u7684\u5bb9\u5668\u4e5f\u5e76\u4e0d\u591a\uff0c\u6b64\u65f6\u57fa\u4e8eDocker\u5bb9\u5668\u76f4\u63a5\u90e8\u7f72\u81f3\u5bbf\u4e3b\u673a\u4e5f\u80fd\u5b9e\u73b0\u81ea\u5df1\u7684\u9700\u6c42\u3002</p> <p>\u4f46\u662f\u968f\u7740\u9879\u76ee\u8d8a\u6765\u8d8a\u591a\uff0c\u7ba1\u7406\u7684\u5bb9\u5668\u4e5f\u8d8a\u6765\u8d8a\u591a\uff0c\u6b64\u65f6\u4f7f\u7528\u201c\u88f8\u5bb9\u5668\u201d\u90e8\u7f72\u7684\u65b9\u5f0f\u7ba1\u7406\u8d77\u6765\u5c31\u663e\u5f97\u5f88\u5403\u529b\uff0c\u5e76\u4e14\u968f\u7740\u4e1a\u52a1\u91cf\u7684\u589e\u52a0\uff0c\u4f1a\u660e\u663e\u4f53\u4f1a\u5230\u201c\u88f8\u5bb9\u5668\u201d\u7684\u4e0d\u8db3\uff0c\u6bd4\u5982\uff1a</p> <ul> <li>\u5bbf\u4e3b\u673a\u5b95\u673a\u9020\u6210\u8be5\u5bbf\u4e3b\u673a\u4e0a\u7684\u5bb9\u5668\u4e0d\u53ef\u7528\uff0c\u4e14\u65e0\u6cd5\u81ea\u52a8\u6062\u590d\u3002</li> <li>\u5bb9\u5668\u660e\u660e\u5728\u8fd0\u884c\uff0c\u63a5\u53e3\u5c31\u662f\u4e0d\u901a\uff08\u5065\u5eb7\u68c0\u67e5\u505a\u5f97\u4e0d\u5230\u4f4d\uff09\u3002</li> <li>\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u3001\u56de\u6eda\u3001\u6269\u7f29\u5bb9\u56f0\u96be\u3002</li> <li>\u6210\u767e\u4e0a\u5343\u7684\u5bb9\u5668\u548c\u6d89\u53ca\u7684\u7aef\u53e3\u96be\u4ee5\u7ef4\u62a4</li> </ul> <p>\u4e0a\u9762\u7684\u95ee\u9898\u53ea\u662f\u505a\u4e00\u4e2a\u7b80\u5355\u7684\u7f57\u5217\uff0c\u771f\u6b63\u4f7f\u7528\u65f6\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u7684\u95ee\u9898\u3002</p> <p>\u53ef\u80fd\u8bfb\u8005\u4e5f\u4f53\u9a8c\u8fc7\u50cfdocker-compose\u3001docker-swarm\u7b49\u7f16\u6392\u5de5\u5177\uff0c\u4f46\u8fd9\u4e9b\u5de5\u5177\u7684\u529f\u80fd\u548cKubernetes\u7684\u529f\u80fd\u8fd8\u662f\u76f8\u5dee\u751a\u8fdc\uff0c\u6240\u4ee5\u6ce8\u5b9aKubernetes\u7f16\u6392\u5de5\u5177\u5c06\u6210\u4e3a\u4e3b\u6d41\u7684\u5bb9\u5668\u7f16\u6392\u5de5\u5177\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/4.Kubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/#11-\u5bf9\u4e8e\u5f00\u53d1\u4eba\u5458","title":"1.1 \u5bf9\u4e8e\u5f00\u53d1\u4eba\u5458","text":"<p>\u5728\u6ca1\u6709\u7528Kubernetes\u7684\u65f6\u5019\uff0c\u67e5\u770b\u7ebf\u4e0b\u6d4b\u8bd5\u7684\u65e5\u5fd7\uff0c\u9700\u8981\u5f00\u53d1\u6216\u8005\u6d4b\u8bd5\u4eba\u5458\u627e\u5230\u5bf9\u5e94\u7684\u673a\u5668\uff0c\u518d\u627e\u5230\u5bf9\u5e94\u7684\u5bb9\u5668\uff0c\u624d\u80fd\u67e5\u770b\u65e5\u5fd7\u3002</p> <p>\u5728\u4f7f\u7528Kubernetes\u4e4b\u540e\uff0c\u5f00\u53d1\u548c\u6d4b\u8bd5\u4eba\u5458\u76f4\u63a5\u5728Kubernetes\u7684Dashboard\u4e0a\u627e\u5230\u5bf9\u5e94\u7684Namespace\uff0c\u5373\u53ef\u5b9a\u4f4d\u5230\u4e1a\u52a1\u7684\u5bb9\u5668\uff0c\u7136\u540e\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7\u63a7\u5236\u53f0\u67e5\u770b\u5230\u5bf9\u5e94\u7684\u65e5\u5fd7\uff0c\u5927\u5927\u964d\u4f4e\u4e86\u64cd\u4f5c\u65f6\u95f4\u3002</p> <p>\u628a\u5e94\u7528\u90e8\u7f72\u5230Kubernetes\u4e4b\u540e\uff0c\u4ee3\u7801\u7684\u53d1\u5e03\u3001\u56de\u6eda\u4ee5\u53ca\u84dd\u7eff\u53d1\u5e03\u3001\u91d1\u4e1d\u96c0\u53d1\u5e03\u7b49\u90fd\u53d8\u5f97\u7b80\u5355\u53ef\u63a7\uff0c\u4e0d\u4ec5\u52a0\u5feb\u4e86\u4e1a\u52a1\u4ee3\u7801\u7684\u8fed\u4ee3\u901f\u5ea6\uff0c\u800c\u4e14\u5168\u7a0b\u65e0\u987b\u4eba\u5de5\u5e72\u9884\u3002\u751f\u4ea7\u73af\u5883\u53ef\u4ee5\u4f7f\u7528Jenkins\u3001GitRunner\u7b49\u5de5\u5177\u8fdb\u884c\u53d1\u7248\u6216\u56de\u6eda\u7b49\u3002\u4ece\u5f00\u53d1\u73af\u5883\u5230\u6d4b\u8bd5\u73af\u5883\uff0c\u6700\u540e\u5230\u751f\u4ea7\u73af\u5883\uff0c\u5b8c\u5168\u9075\u5b88\u4e00\u6b21\u6784\u5efa\uff0c\u591a\u96c6\u7fa4\u3001\u591a\u73af\u5883\u90e8\u7f72\uff0c\u901a\u8fc7\u4e0d\u540c\u7684\u542f\u52a8\u53c2\u6570\u3001\u4e0d\u540c\u7684\u73af\u5883\u53d8\u91cf\u3001\u4e0d\u540c\u7684\u914d\u7f6e\u6587\u4ef6\u533a\u5206\u4e0d\u540c\u7684\u73af\u5883\u3002</p> <p>\u5728\u4f7f\u7528\u670d\u52a1\u7f51\u683c\u540e\uff0c\u5f00\u53d1\u4eba\u5458\u5728\u5f00\u53d1\u5e94\u7528\u7684\u8fc7\u7a0b\u4e2d\uff0c\u65e0\u987b\u518d\u53bb\u5173\u5fc3\u4ee3\u7801\u7684\u7f51\u7edc\u90e8\u5206\uff0c\u8fd9\u4e9b\u529f\u80fd\u90fd\u88ab\u670d\u52a1\u7f51\u683c\u5b9e\u73b0\uff0c\u8ba9\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u53ea\u5173\u5fc3\u4ee3\u7801\u903b\u8f91\u90e8\u5206\uff0c\u5373\u53ef\u8f7b\u677e\u5b9e\u73b0\u7f51\u7edc\u90e8\u5206\u7684\u529f\u80fd\uff0c\u6bd4\u5982\u65ad\u6d41\u3001\u5206\u6d41\u3001\u8def\u7531\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u9650\u901f\u548c\u89e6\u53d1\u6545\u969c\u7b49\u529f\u80fd\u3002</p> <p>\u5728\u6d4b\u8bd5\u8fc7\u7a0b\u4e2d\uff0c\u53ef\u80fd\u540c\u65f6\u5b58\u5728\u591a\u5957\u73af\u5883\uff0c\u5f53\u7136\u4e5f\u4f1a\u521b\u5efa\u5176\u4ed6\u73af\u5883\u6216\u4e34\u65f6\u73af\u5883\uff0c\u4e4b\u524d\u6d4b\u8bd5\u73af\u5883\u7684\u521b\u5efa\u9700\u8981\u627e\u8fd0\u7ef4\u4eba\u5458\u6216\u8005\u81ea\u884c\u624b\u5de5\u642d\u5efa\u3002</p> <p>\u5728\u8fc1\u79fb\u81f3Kubernetes\u96c6\u7fa4\u540e\uff0c\u5f00\u53d1\u4eba\u5458\u5982\u679c\u9700\u8981\u65b0\u7684\u73af\u5883\uff0c\u65e0\u987b\u518d\u627e\u8fd0\u7ef4\uff0c\u53ea\u9700\u8981\u5728Jenkins\u4e0a\u70b9\u70b9\u9f20\u6807\u5373\u53ef\u5728Kubernetes\u96c6\u7fa4\u4e0a\u521b\u5efa\u4e00\u5957\u65b0\u7684\u6d4b\u8bd5\u73af\u5883\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/4.Kubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/#12-\u5bf9\u4e8e\u8fd0\u7ef4\u4eba\u5458","title":"1.2 \u5bf9\u4e8e\u8fd0\u7ef4\u4eba\u5458","text":"<p>\u5bf9\u4e8e\u8fd0\u7ef4\u4eba\u5458\uff0c\u53ef\u80fd\u7ecf\u5e38\u56e0\u4e3a\u4e00\u4e9b\u91cd\u590d\u3001\u70e6\u7410\u7684\u5de5\u4f5c\u611f\u89c9\u538c\u5026\uff0c\u6bd4\u5982\u4e00\u4e2a\u9879\u76ee\u9700\u8981\u4e00\u5957\u65b0\u7684\u6d4b\u8bd5\u73af\u5883\uff0c\u53e6\u4e00\u4e2a\u9879\u76ee\u9700\u8981\u8fc1\u79fb\u6d4b\u8bd5\u73af\u5883\u81f3\u5176\u4ed6\u5e73\u53f0\u3002</p> <p>\u4f20\u7edf\u67b6\u6784\u53ef\u80fd\u9700\u8981\u88c5\u7cfb\u7edf\u3001\u88c5\u4f9d\u8d56\u73af\u5883\u3001\u90e8\u7f72\u57df\u540d\u3001\u5f00\u901a\u6743\u9650\u7b49\uff0c\u8fd9\u4e00\u6574\u5957\u4e0b\u6765\uff0c\u4e0d\u4ec5\u8017\u65f6\uff0c\u800c\u4e14\u53ef\u80fd\u4f1a\u56e0\u4e3a\u6709\u67d0\u4e9b\u9057\u6f0f\u800c\u9020\u6210\u8bf8\u591a\u95ee\u9898\u3002</p> <p>\u800c\u5982\u4eca\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528Kubernetes\u5305\u7ba1\u7406\u5de5\u5177\uff0c\u4e00\u952e\u5f0f\u90e8\u7f72\u4e00\u5957\u65b0\u7684\u6d4b\u8bd5\u73af\u5883\uff0c\u751a\u81f3\u5168\u7a0b\u65e0\u987b\u81ea\u5df1\u5e72\u9884\uff0c\u5f00\u53d1\u4eba\u5458\u901a\u8fc7Jenkins\u6216\u8005\u81ea\u52a8\u5316\u8fd0\u7ef4\u5e73\u53f0\u5373\u53ef\u4e00\u952e\u5f0f\u521b\u5efa\uff0c\u5927\u5927\u964d\u4f4e\u4e86\u8fd0\u7ef4\u6210\u672c\u3002</p> <p>\u5728\u6ca1\u6709\u4f7f\u7528Kubernetes\u65f6\uff0c\u4e1a\u52a1\u5e94\u7528\u7684\u6269\u5bb9\u548c\u7f29\u5bb9\u90fd\u9700\u8981\u4eba\u5de5\u53bb\u5904\u7406\uff0c\u4ece\u91c7\u8d2d\u670d\u52a1\u5668\u3001\u4e0a\u67b6\u5230\u90e8\u7f72\u4f9d\u8d56\u73af\u5883\uff0c\u4e0d\u4ec5\u9700\u8981\u5927\u91cf\u7684\u4eba\u529b\u7269\u529b\uff0c\u800c\u4e14\u975e\u5e38\u5bb9\u6613\u5728\u4e2d\u95f4\u8fc7\u7a0b\u51fa\u73b0\u95ee\u9898\uff0c\u53c8\u8981\u82b1\u8d39\u5927\u91cf\u7684\u65f6\u95f4\u53bb\u67e5\u627e\u95ee\u9898\u3002</p> <p>\u6210\u529f\u4e0a\u67b6\u540e\uff0c\u8fd8\u9700\u8981\u5728\u524d\u7aef\u8d1f\u8f7d\u5747\u8861\u6dfb\u52a0\u8be5\u670d\u52a1\u5668\u3002\u800c\u5982\u4eca\uff0c\u53ef\u4ee5\u5229\u7528Kubernetes\u7684\u5f39\u6027\u8ba1\u7b97\u4e00\u952e\u5f0f\u6269\u5bb9\u548c\u7f29\u5bb9\uff0c\u4e0d\u4ec5\u5927\u5927\u63d0\u9ad8\u4e86\u8fd0\u7ef4\u6548\u7387\uff0c\u800c\u4e14\u8fd8\u8282\u7701\u4e86\u4e0d\u5c11\u7684\u670d\u52a1\u5668\u8d44\u6e90\uff0c\u63d0\u9ad8\u4e86\u8d44\u6e90\u5229\u7528\u7387\u3002</p> <ul> <li> <p>\u5728\u53cd\u5411\u4ee3\u7406\u914d\u7f6e\u65b9\u9762\uff0c\u53ef\u80fd\u5bf9Nginx\u7684\u914d\u7f6e\u89c4\u5219\u5e76\u4e0d\u719f\u6089\uff0c\u4e00\u4e9b\u9ad8\u7ea7\u7684\u529f\u80fd\u4e5f\u5f88\u96be\u5b9e\u73b0\uff0c\u4f46\u662f\u5728Kubernetes\u4e0a\uff0c\u5229\u7528Kubernetes\u7684Ingress\u5373\u53ef\u7b80\u5355\u5730\u5b9e\u73b0\u90a3\u4e9b\u590d\u6742\u7684\u903b\u8f91\uff0c\u5e76\u4e14\u4e0d\u4f1a\u518d\u9047\u5230Nginx\u5c11\u52a0\u4e00\u4e2a\u659c\u6760\u548c\u591a\u52a0\u4e00\u4e2a\u659c\u6760\u7684\u95ee\u9898\u3002</p> </li> <li> <p>\u5728\u8d1f\u8f7d\u5747\u8861\u65b9\u9762\uff0c\u4e4b\u524d\u8d1f\u8f7d\u5747\u8861\u53ef\u80fd\u662fNginx\u3001LVS\u3001HAProxy\u3001F5\u7b49\uff0c\u4e91\u4e0a\u53ef\u80fd\u662f\u4e91\u670d\u52a1\u5546\u63d0\u4f9b\u7684\u8d1f\u8f7d\u5747\u8861\u673a\u5236\u3002\u6bcf\u6b21\u6dfb\u52a0\u5220\u9664\u8282\u70b9\u65f6\uff0c\u90fd\u9700\u8981\u624b\u52a8\u53bb\u914d\u7f6e\u524d\u7aef\u8d1f\u8f7d\u5747\u8861\uff0c\u624b\u52a8\u53bb\u5339\u914d\u540e\u7aef\u8282\u70b9\u3002\u5728\u4f7f\u7528Kubernetes\u8fdb\u884c\u7f16\u6392\u670d\u52a1\u65f6\uff0c\u4f7f\u7528Kubernetes\u5185\u90e8\u7684Service\u5373\u53ef\u5b9e\u73b0\u81ea\u52a8\u7ba1\u7406\u8282\u70b9\uff0c\u5e76\u4e14\u652f\u6301\u81ea\u52a8\u6269\u5bb9\u3001\u7f29\u5bb9\u3002</p> </li> <li> <p>\u5728\u9ad8\u53ef\u7528\u65b9\u9762\uff0cKubernetes\u5929\u751f\u7684\u9ad8\u53ef\u7528\u529f\u80fd\u8ba9\u8fd0\u7ef4\u4eba\u5458\u5f7b\u5e95\u91ca\u653e\u4e86\u53cc\u624b\uff0c\u65e0\u987b\u518d\u53bb\u521b\u5efa\u5404\u7c7b\u9ad8\u53ef\u7528\u5de5\u5177\uff0c\u4ee5\u53ca\u68c0\u6d4b\u811a\u672c\u3002</p> </li> </ul> <p>Kubernetes\u652f\u6301\u8fdb\u7a0b\u3001\u63a5\u53e3\u7ea7\u522b\u7684\u5065\u5eb7\u68c0\u67e5\uff0c\u5982\u53d1\u73b0\u63a5\u53e3\u8d85\u65f6\u6216\u8005\u8fd4\u56de\u503c\u4e0d\u6b63\u786e\uff0c\u4f1a\u81ea\u52a8\u5904\u7406\u8be5\u95ee\u9898\u3002</p> <ul> <li> <p>\u5728\u4e2d\u95f4\u4ef6\u642d\u5efa\u65b9\u9762\uff0c\u6839\u636e\u5b9a\u4e49\u597d\u7684\u8d44\u6e90\u6587\u4ef6\uff0c\u53ef\u4ee5\u5b9e\u73b0\u79d2\u7ea7\u642d\u5efa\u5404\u7c7b\u4e2d\u95f4\u4ef6\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0c\u5e76\u4e14\u652f\u6301\u4e00\u952e\u5f0f\u6269\u5bb9\u3001\u7f29\u5bb9\uff0c\u5982Redis\u3001RabbitMQ\u3001Zookeeper\u7b49\uff0c\u5e76\u4e14\u5927\u5927\u51cf\u5c11\u4e86\u51fa\u9519\u7684\u6982\u7387\u3002</p> </li> <li> <p>\u5728\u5e94\u7528\u7aef\u53e3\u65b9\u9762\uff0c\u4f20\u7edf\u67b6\u6784\u4e2d\uff0c\u4e00\u53f0\u670d\u52a1\u5668\u53ef\u80fd\u8dd1\u4e86\u5f88\u591a\u8fdb\u7a0b\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u6709\u4e00\u4e2a\u7aef\u53e3\uff0c\u9700\u8981\u4eba\u4e3a\u5730\u53bb\u914d\u7f6e\u7aef\u53e3\uff0c\u5e76\u4e14\u8fd8\u9700\u8981\u8003\u8651\u7aef\u53e3\u51b2\u7a81\u7684\u95ee\u9898\uff0c\u5982\u679c\u6709\u9632\u706b\u5899\u7684\u8bdd\uff0c\u8fd8\u9700\u8981\u914d\u7f6e\u9632\u706b\u5899\u3002\u5728Kubernetes\u4e2d\uff0c\u7aef\u53e3\u7edf\u4e00\u7ba1\u7406\u3001\u7edf\u4e00\u914d\u7f6e\uff0c\u6bcf\u4e2a\u5e94\u7528\u7684\u7aef\u53e3\u90fd\u53ef\u4ee5\u8bbe\u7f6e\u6210\u4e00\u6837\u7684\uff0c\u4e4b\u540e\u901a\u8fc7Service\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\uff0c\u5927\u5927\u964d\u4f4e\u4e86\u7aef\u53e3\u7ba1\u7406\u7684\u590d\u6742\u5ea6\u548c\u7aef\u53e3\u51b2\u7a81\u3002</p> </li> </ul> <p>\u65e0\u8bba\u662f\u5bf9\u4e8e\u5f00\u53d1\u4eba\u5458\u3001\u6d4b\u8bd5\u4eba\u5458\u8fd8\u662f\u8fd0\u7ef4\u4eba\u5458\uff0cKubernetes\u7684\u8bde\u751f\u4e0d\u4ec5\u51cf\u5c11\u4e86\u5de5\u4f5c\u7684\u590d\u6742\u5ea6\uff0c\u8fd8\u51cf\u5c11\u4e86\u5404\u79cd\u8fd0\u7ef4\u6210\u672c\u3002 \u4e0a\u8ff0\u5e26\u6765\u7684\u4fbf\u5229\u6027\u53ea\u662f\u6bd4\u8f83\u5c0f\u7684\u4e00\u90e8\u5206\uff0c\u66f4\u591a\u4f18\u70b9\u53ea\u6709\u7528\u4e86\u624d\u80fd\u771f\u6b63\u4f53\u4f1a\u5230\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/4.Kubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/#2kubernetes\u5e26\u6765\u7684\u6311\u6218","title":"2.Kubernetes\u5e26\u6765\u7684\u6311\u6218","text":"<p>Kubernetes\u4ece\u8bde\u751f\u81f3\u4eca\uff0c\u4e00\u8def\u7a81\u98de\u731b\u8fdb\uff0c\u5728\u5bb9\u5668\u7f16\u6392\u7684\u9886\u57df\u91cc\u8fc7\u4e09\u5173\u65a9\u516d\u5c06\uff0c\u6700\u7ec8\u62ff\u4e0b\u4e86\u5bb9\u5668\u7f16\u6392\u7684\u51a0\u519b\u5b9d\u5ea7\uff0c\u6210\u4e3a\u6700\u65e0\u53ef\u66ff\u4ee3\u3001\u4e0d\u53ef\u64bc\u52a8\u7684\u4f7c\u4f7c\u8005\uff0c\u4f46\u662f\u9488\u5bf9Kubernetes\u7684\u5b66\u4e60\u548c\u4f7f\u7528\u59cb\u7ec8\u662f\u4e00\u4e2a\u5f88\u5927\u7684\u96be\u9898\u3002</p> <p>\u9996\u5148Kubernetes\u672c\u8eab\u7684\u5b66\u4e60\u5c31\u5f88\u56f0\u96be\uff0c\u56e0\u4e3aKubernetes\u6982\u5ff5\u592a\u591a\uff0c\u6d89\u53ca\u7684\u77e5\u8bc6\u9762\u4e5f\u975e\u5e38\u5e7f\u6cdb\uff0c\u53ef\u80fd\u5b66\u4e60\u4e86\u4e00\u4e2a\u6708\u4e5f\u65e0\u6cd5\u5165\u95e8\uff0c\u751a\u81f3\u8fde\u96c6\u7fa4\u4e5f\u642d\u5efa\u4e0d\u51fa\u6765\uff0c\u4f7f\u4eba\u671b\u800c\u5374\u6b65\u3002 \u5e76\u4e14Kubernetes\u5bf9\u8fd0\u7ef4\u7684\u6280\u672f\u80fd\u529b\u8981\u6c42\u4e5f\u6bd4\u8f83\u9ad8\uff0c\u56e0\u4e3a\u8fd0\u7ef4\u4e0d\u4ec5\u4ec5\u5c40\u9650\u4e8e\u4f20\u7edf\u8fd0\u7ef4\uff0c\u6709\u65f6\u5019\u53ef\u80fd\u8981\u4fee\u6539\u4e1a\u52a1\u4ee3\u7801\u3001\u5236\u5b9a\u4e1a\u52a1\u4e0a\u7ebf\u4f53\u7cfb\u3001\u7ed9\u7814\u53d1\u4eba\u5458\u5728\u5f00\u53d1\u5e94\u7528\u4e2d\u7ed9\u51fa\u66f4\u597d\u7684\u5efa\u8bae\u7b49\u3002</p> <p>\u9700\u8981\u638c\u63e1\u7684\u77e5\u8bc6\u4e5f\u6709\u5f88\u591a\uff0c\u53ef\u80fd\u9700\u8981\u638c\u63e1\u516c\u53f8\u5185\u6240\u6709\u4f7f\u7528\u5230\u7684\u4ee3\u7801\uff0c\u6bd4\u5982\u4ee3\u7801\u5982\u4f55\u8fdb\u884c\u7f16\u8bd1\u3001\u5982\u4f55\u6b63\u786e\u53d1\u5e03\u3001\u5982\u4f55\u4fee\u6539\u4ee3\u7801\u914d\u7f6e\u6587\u4ef6\u7b49\uff0c\u8fd9\u5bf9\u4e8e\u8fd0\u7ef4\u4eba\u5458\u4e5f\u662f\u4e00\u79cd\u6311\u6218\u3002</p> <p>Kubernetes\u4e4b\u6240\u4ee5\u88ab\u53eb\u4f5cK8s\uff0c\u4e1a\u754c\u6709\u4e24\u79cd\u8bf4\u6cd5\uff0c\u901a\u4fd7\u7684\u8bf4\u6cd5\u662fk\u548cs\u4e4b\u95f4\u67098\u4e2a\u5b57\u6bcd\uff1b\u53e6\u4e00\u79cd\u8bf4\u6cd5\u662fK8s\u96c6\u7fa4\u81f3\u5c11\u9700\u8981\u642d\u5efa8\u904d\u624d\u80fd\u642d\u5efa\u6210\u529f\u3002</p> <p>\u5f53\u7136\uff0c\u5728\u5b9e\u9645\u4f7f\u7528\u65f6\uff0c\u53ef\u80fd\u4e0d\u6b628\u904d\u3002 </p> <p>Kubernetes\u7684\u8bde\u751f\u628a\u8fd0\u7ef4\u4ece\u4f20\u7edf\u8fd0\u7ef4\u8f6c\u53d8\u5230\u4e86DevOps\u65b9\u5411\uff0c\u9700\u8981\u9762\u4e34\u7684\u95ee\u9898\u66f4\u591a\uff0c\u9700\u8981\u9762\u4e34\u7684\u65b0\u6280\u672f\u4e5f\u5f88\u591a\uff0c\u4f46\u662f\u5f53\u771f\u6b63\u638c\u63e1\u4e86Kubernetes\u7684\u6838\u5fc3\u548c\u8bbe\u8ba1\u7406\u5ff5\uff0c\u5c31\u4f1a\u53d7\u76ca\u7ec8\u8eab\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/4.Kubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/#3kubernetes\u67b6\u6784\u89e3\u6790","title":"3.Kubernetes\u67b6\u6784\u89e3\u6790","text":"<p>\u9996\u5148\u6211\u4eec\u6765\u770b\u4e00\u4e0bKubernetes\u7684\u67b6\u6784\u56fe\uff0c\u5982\u56fe4.1\u6240\u793a\u3002</p> <p>)</p> <p>\u56fe4.1 Kubernetes\u9ad8\u53ef\u7528\u67b6\u6784</p> <p>\u7531\u56fe\u53ef\u77e5\uff0c Kubernetes\u67b6\u6784\u53ef\u7b80\u5355\u5206\u4e3a\u4e3b(Master)\u8282\u70b9 \u3001 \u4ece(\u5de5\u4f5c/Worker/Node)\u8282\u70b9\u548c\u6570\u636e\u5e93Etcd\u3002</p> <p>\u5176\u4e2d\u4e3b\u8282\u70b9\u4e3a\u96c6\u7fa4\u7684\u63a7\u5236\u5355\u5143\uff0c\u4e00\u822c\u4e0d\u4f1a\u8fd0\u884c\u4e1a\u52a1\u5e94\u7528\u7a0b\u5e8f \uff0c\u4e3b\u8981\u5305\u542b\u7684\u7a0b\u5e8f\u6709\u5982\u4e0b\uff1a</p> <ul> <li>Kube-APIServer</li> <li>Kube-ControllerManager</li> <li>Kube-Scheduler\u3002</li> </ul> <p>\u4ece\u8282\u70b9\u4e3a\u5de5\u4f5c\u8282\u70b9\uff0c\u4e5f\u5c31\u662f\u90e8\u7f72\u5e94\u7528 \u7a0b\u5e8f\u5bb9\u5668\u7684\u8282\u70b9\uff0c\u4e3b\u8981\u5305\u542b\u7684\u7ec4\u4ef6\u6709\uff1a - Kubelet - Kube-Proxy </p> <p>\u5f53\u7136\u5982\u679cMaster \u8282\u70b9\u4e5f\u8981\u90e8\u7f72\u5bb9\u5668\uff0c\u4e5f\u4f1a\u5305\u542b\u8fd9\u4e24\u4e2a\u7ec4\u4ef6\u3002</p> <p>\u540c\u65f6\uff0c\u53ef\u4ee5\u770b\u51fa\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u53ef\u4ee5\u6709\u5f88\u591aNode\u8282\u70b9\uff0c\u7528\u4ee5\u4fdd\u8bc1\u96c6\u7fa4\u5bb9\u5668\u7684 \u5206\u5e03\u5f0f\u90e8\u7f72\u7528\u4e8e\u5b9e\u73b0\u4e1a\u52a1\u7684\u9ad8\u53ef\u7528\u6027\uff0c\u4e5f\u53ef\u4ee5\u6709\u5f88\u591aMaster\u8282\u70b9\uff0c\u4e4b\u540e\u901a\u8fc7\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u4fdd\u8bc1\u96c6\u7fa4\u63a7\u5236\u8282\u70b9\u7684\u9ad8\u53ef\u7528\u3002</p> <p>\u8d1f\u8f7d\u5747\u8861\u53ef\u4ee5\u4f7f\u7528\u8f6f\u4ef6\u8d1f\u8f7d\u5747\u8861Nginx/LVS/HAProxy+KeepAlived \u6216\u8005\u786c\u4ef6\u8d1f\u8f7d\u5747\u8861F5\u7b49, \u901a\u8fc7\u8d1f\u8f7d\u5747\u8861\u5bf9 Kube-APIServer\u63d0\u4f9b\u7684VIP\u5373\u53ef\u5b9e\u73b0Master\u8282\u70b9\u7684\u9ad8\u53ef\u7528\uff0c\u5176\u4ed6\u7ec4\u4ef6\u901a\u8fc7\u8be5 VIP\u8fde\u63a5\u81f3Kube-APIServer\u3002</p> <p>Etcd\u96c6\u7fa4\u53ef\u4ee5\u548cMaster\u8282\u70b9\u90e8\u7f72\u5728\u540c\u4e00\u4e2a\u5bbf\u4e3b \u673a\uff0c\u4e5f\u53ef\u4ee5\u5355\u72ec\u90e8\u7f72\uff0c\u751f\u4ea7\u73af\u5883\u5efa\u8bae\u90e8\u7f72\u5927\u4e8e3\u7684\u5947\u6570\u53f0Etcd\u8282\u70b9\u5b9e\u73b0Etcd\u96c6\u7fa4\u7684\u9ad8\u53ef\u7528\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/4.Kubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/#4master\u8282\u70b9","title":"4.Master\u8282\u70b9","text":"<p>Master\u8282\u70b9\u662fKubernetes\u96c6\u7fa4\u7684\u63a7\u5236\u8282\u70b9\uff0c\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4e0d\u5efa\u8bae\u90e8\u7f72\u96c6\u7fa4\u6838\u5fc3\u7ec4\u4ef6\u5916\u7684\u4efb\u4f55\u5bb9\u5668\uff08\u5728Kubeadm\u5b89\u88c5\u65b9\u5f0f\u4e0b\uff0c\u7cfb\u7edf\u7ec4\u4ef6\u4ee5\u5bb9\u5668\u65b9\u5f0f\u8fd0\u884c\u5728Master\u8282\u70b9\u7684\u5bbf\u4e3b\u673a\u4e0a\uff1b\u4e8c\u8fdb\u5236\u5b89\u88c5\u65b9\u5f0f\u4e0b\uff0c\u7cfb\u7edf\u7ec4\u4ef6\u4ee5\u5b88\u62a4\u8fdb\u7a0b\u7684\u65b9\u5f0f\u8fd0\u884c\uff0cMaster\u8282\u70b9\u53ef\u4ee5\u4e0d\u8fd0\u884c\u4efb\u4f55\u5bb9\u5668\uff09\uff0c\u516c\u53f8\u4e1a\u52a1\u7a0b\u5e8f\u7684\u5bb9\u5668\u66f4\u662f\u4e0d\u5efa\u8bae\u90e8\u7f72\u5230Master\u8282\u70b9\u4e0a\uff0c\u4ee5\u514d\u5347\u7ea7\u6216\u8005\u7ef4\u62a4\u65f6\u5bf9\u4e1a\u52a1\u9020\u6210\u5f71\u54cd\u3002</p> <p>Master\u8282\u70b9\u7684\u7ec4\u4ef6\u5305\u62ec\uff1a</p> <ul> <li>APIServer\uff1a\u6574\u4e2a\u96c6\u7fa4\u7684\u63a7\u5236\u4e2d\u67a2\uff0c\u63d0\u4f9b\u96c6\u7fa4\u4e2d\u5404\u4e2a\u6a21\u5757\u4e4b\u95f4\u7684\u6570\u636e\u4ea4\u6362\uff0c\u5e76\u5c06\u96c6\u7fa4\u72b6\u6001\u548c\u4fe1\u606f\u5b58\u50a8\u5230\u5206\u5e03\u5f0f\u952e-\u503c\uff08key-value\uff09\u5b58\u50a8\u7cfb\u7edfEtcd\u96c6\u7fa4\u4e2d\u3002   \u540c\u65f6\uff0c\u5b83\u4e5f\u662f\u96c6\u7fa4\u7ba1\u7406\u3001\u8d44\u6e90\u914d\u989d\u3001\u63d0\u4f9b\u5b8c\u5907\u7684\u96c6\u7fa4\u5b89\u5168\u673a\u5236\u7684\u5165\u53e3\uff0c\u4e3a\u96c6\u7fa4\u5404\u7c7b\u8d44\u6e90\u5bf9\u8c61\u63d0\u4f9b\u589e\u5220\u6539\u67e5\u4ee5\u53cawatch\u7684REST API\u63a5\u53e3\u3002   APIServer\u4f5c\u4e3aKubernetes\u7684\u5173\u952e\u7ec4\u4ef6\uff0c\u4f7f\u7528Kubernetes API\u548cJSON over HTTP\u63d0\u4f9bKubernetes\u7684\u5185\u90e8\u548c\u5916\u90e8\u63a5\u53e3\u3002</li> </ul> <ul> <li>Scheduler\uff1a\u96c6\u7fa4Pod\u7684\u8c03\u5ea6\u4e2d\u5fc3\uff0c\u4e3b\u8981\u901a\u8fc7\u8c03\u5ea6\u7b97\u6cd5\u5c06Pod\u5206\u914d\u5230\u6700\u4f73\u7684Node\u8282\u70b9\uff0c\u5b83\u901a\u8fc7APIServer\u76d1\u542c\u6240\u6709Pod\u7684\u72b6\u6001\uff0c\u4e00\u65e6\u53d1\u73b0\u65b0\u7684\u672a\u88ab\u8c03\u5ea6\u5230\u4efb\u4f55Node\u8282\u70b9\u7684Pod\uff08PodSpec.NodeName\u4e3a\u7a7a\uff09\uff0c\u5c31\u4f1a\u6839\u636e\u4e00\u7cfb\u5217\u7b56\u7565\u9009\u62e9\u6700\u4f73\u8282\u70b9\u8fdb\u884c\u8c03\u5ea6\uff0c\u5bf9\u6bcf\u4e00\u4e2aPod\u521b\u5efa\u4e00\u4e2a\u7ed1\u5b9a\uff08Binding\uff09\uff0c\u7136\u540e\u88ab\u8c03\u5ea6\u7684\u8282\u70b9\u4e0a\u7684Kubelet\u8d1f\u8d23\u542f\u52a8\u8be5Pod\u3002Scheduler\u662f\u96c6\u7fa4\u53ef\u63d2\u62d4\u5f0f\u7ec4\u4ef6\uff0c\u5b83\u8ddf\u8e2a\u6bcf\u4e2a\u8282\u70b9\u4e0a\u7684\u8d44\u6e90\u5229\u7528\u7387\u4ee5\u786e\u4fdd\u5de5\u4f5c\u8d1f\u8f7d\u4e0d\u4f1a\u8d85\u8fc7\u53ef\u7528\u8d44\u6e90\u3002\u56e0\u6b64\uff0cScheduler\u5fc5\u987b\u77e5\u9053\u8d44\u6e90\u9700\u6c42\u3001\u8d44\u6e90\u53ef\u7528\u6027\u4ee5\u53ca\u5176\u4ed6\u7ea6\u675f\u548c\u7b56\u7565\uff0c\u4f8b\u5982\u670d\u52a1\u8d28\u91cf\u3001\u4eb2\u548c\u529b/\u53cd\u5173\u8054\u6027\u8981\u6c42\u3001\u6570\u636e\u4f4d\u7f6e\u7b49\u3002Scheduler\u5c06\u8d44\u6e90\u4f9b\u5e94\u4e0e\u5de5\u4f5c\u8d1f\u8f7d\u9700\u6c42\u76f8\u5339\u914d\u4ee5\u7ef4\u6301\u7cfb\u7edf\u7684\u7a33\u5b9a\u548c\u53ef\u9760\u6027\uff0c\u56e0\u6b64Scheduler\u5728\u8c03\u5ea6\u7684\u8fc7\u7a0b\u4e2d\u9700\u8981\u8003\u8651\u516c\u5e73\u3001\u8d44\u6e90\u9ad8\u6548\u5229\u7528\u3001\u6548\u7387\u7b49\u65b9\u9762\u7684\u95ee\u9898\u3002</li> </ul> <ul> <li>Controller Manager\uff1a\u96c6\u7fa4\u72b6\u6001\u7ba1\u7406\u5668\uff08\u5b83\u7684\u82f1\u6587\u76f4\u8bd1\u540d\u4e3a\u63a7\u5236\u5668\u7ba1\u7406\u5668\uff09\uff0c\u4ee5\u4fdd\u8bc1Pod\u6216\u5176\u4ed6\u8d44\u6e90\u8fbe\u5230\u671f\u671b\u503c\u3002   \u5f53\u96c6\u7fa4\u4e2d\u67d0\u4e2aPod\u7684\u526f\u672c\u6570\u6216\u5176\u4ed6\u8d44\u6e90\u56e0\u6545\u969c\u548c\u9519\u8bef\u5bfc\u81f4\u65e0\u6cd5\u6b63\u5e38\u8fd0\u884c\uff0c\u6ca1\u6709\u8fbe\u5230\u8bbe\u5b9a\u7684\u503c\u65f6\uff0cController Manager\u4f1a\u5c1d\u8bd5\u81ea\u52a8\u4fee\u590d\u5e76\u4f7f\u5176\u8fbe\u5230\u671f\u671b\u72b6\u6001\u3002   Controller Manager\u5305\u542bNodeController\u3001ReplicationController\u3001EndpointController\u3001NamespaceController\u3001ServiceAccountController\u3001ResourceQuotaController\u3001ServiceController\u548cTokenController\u7b49\uff0c\u8be5\u63a7\u5236\u5668\u7ba1\u7406\u5668\u53ef\u4e0eAPI\u670d\u52a1\u5668\u8fdb\u884c\u901a\u4fe1\uff0c\u4ee5\u5728\u9700\u8981\u65f6\u521b\u5efa\u3001\u66f4\u65b0\u6216\u5220\u9664\u5b83\u6240\u7ba1\u7406\u7684\u8d44\u6e90\uff0c\u5982Pod\u3001\u670d\u52a1\u65ad\u70b9\u7b49\u3002Scheduler\u548cController Manager\u867d\u7136\u90e8\u7f72\u4e86\u591a\u4e2a\u8282\u70b9\uff0c\u4f46\u540c\u65f6\u5de5\u4f5c\u7684\u8282\u70b9\u53ea\u6709\u4e00\u4e2a\uff0c\u56e0\u4e3aScheduler\u548cController Manager\u5c5e\u4e8e\u6709\u72b6\u6001\u670d\u52a1\uff0c\u4e3a\u4e86\u9632\u6b62\u91cd\u590d\u8c03\u5ea6\uff0c\u591a\u4e2a\u8282\u70b9\u7684Scheduler\u548cController Manager\u8fdb\u884c\u4e86\u9009\u4e3b\u5de5\u4f5c\uff0c\u5de5\u4f5c\u8282\u70b9\uff08\u4e3b\u8282\u70b9\uff09\u4fe1\u606f\u4fdd\u5b58\u5728Scheduler\u548cController Manager\u7684EndPoint\u4e2d\uff0c   \u53ef\u4ee5\u901a\u8fc7<code>kubectl describe ep kube-scheduler kube-controller-manager -n kube-system</code>\u67e5\u770b\uff08Kubernetes 1.20\u7248\u672c\u4ee5\u4e0a\u9700\u8981\u5728leases\u4e2d\u67e5\u770b\uff1a<code>kubectl get leases -n kube-system</code>\uff09\u3002</li> </ul> <ul> <li>Etcd\uff1aCoreOS\u5f00\u53d1\uff0c\u7528\u4e8e\u53ef\u9760\u5730\u5b58\u50a8\u96c6\u7fa4\u7684\u914d\u7f6e\u6570\u636e\uff0c\u662f\u4e00\u79cd\u6301\u4e45\u578b\u3001\u8f7b\u91cf\u578b\u3001\u5206\u5e03\u5f0f\u7684\u952e-\u503c\uff08key-value\uff09\u6570\u636e\u5b58\u50a8\u7ec4\u4ef6\u3002   Etcd\u4f5c\u4e3aKubernetes\u96c6\u7fa4\u7684\u6301\u4e45\u5316\u5b58\u50a8\u7cfb\u7edf\uff0c\u96c6\u7fa4\u7684\u707e\u96be\u6062\u590d\u3001\u72b6\u6001\u4fe1\u606f\u5b58\u50a8\u90fd\u4e0e\u5176\u5bc6\u4e0d\u53ef\u5206\uff0c\u6240\u4ee5\u5728Kubernetes\u9ad8\u53ef\u7528\u96c6\u7fa4\u4e2d\uff0cEtcd\u7684\u9ad8\u53ef\u7528\u662f\u81f3\u5173\u91cd\u8981\u7684\u4e00\u90e8\u5206\uff0c\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u5efa\u8bae\u90e8\u7f72\u5927\u4e8e3\u7684\u5947\u6570\u4e2a\u6570\u7684Etcd\uff0c\u4ee5\u4fdd\u8bc1\u6570\u636e\u7684\u5b89\u5168\u6027\u548c\u53ef\u6062\u590d\u6027\u3002Etcd\u53ef\u4e0eMaster\u7ec4\u4ef6\u90e8\u7f72\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\uff0c\u5927\u89c4\u6a21\u96c6\u7fa4\u73af\u5883\u4e0b\u5efa\u8bae\u90e8\u7f72\u5728\u96c6\u7fa4\u5916\uff0c\u5e76\u4e14\u4f7f\u7528\u9ad8\u6027\u80fd\u670d\u52a1\u5668\u6765\u63d0\u9ad8Etcd\u7684\u6027\u80fd\u548c\u964d\u4f4eEtcd\u540c\u6b65\u6570\u636e\u7684\u5ef6\u8fdf\u3002</li> </ul>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/4.Kubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/#5node\u8282\u70b9","title":"5.Node\u8282\u70b9","text":"<p>Node\u8282\u70b9\u4e5f\u88ab\u79f0\u4e3aWorker\u3001Node\u548cMinion\uff0c\u662f\u4e3b\u8981\u8d1f\u8d23\u90e8\u7f72\u5bb9\u5668\uff08\u5de5\u4f5c\u8d1f\u8f7d\uff09\u7684\u5355\u673a\uff08\u6216\u865a\u62df\u673a\uff09\uff0c\u96c6\u7fa4\u4e2d\u7684\u6bcf\u4e2a\u8282\u70b9\u90fd\u5fc5\u987b\u5177\u5907\u5bb9\u5668\u7684Runtime\uff08\u8fd0\u884c\u65f6\uff09\uff0c\u6bd4\u5982Docker\u6216\u5176\u4ed6\u9075\u5faaCRI\u6807\u51c6\u7684Runtime\u7b49\u3002</p> <p>Kubelet\u4f5c\u4e3a\u5b88\u62a4\u8fdb\u7a0b\u8fd0\u884c\u5728Node\u8282\u70b9\u4e0a\uff0c\u8d1f\u8d23\u76d1\u542c\u8be5\u8282\u70b9\u4e0a\u6240\u6709\u7684Pod\uff0c\u540c\u65f6\u8d1f\u8d23\u4e0a\u62a5\u8be5\u8282\u70b9\u4e0a\u6240\u6709Pod\u7684\u8fd0\u884c\u72b6\u6001\uff0c\u786e\u4fdd\u8282\u70b9\u4e0a\u7684\u6240\u6709\u5bb9\u5668\u90fd\u80fd\u6b63\u5e38\u8fd0\u884c\u3002\u5f53Node\u8282\u70b9\u5b95\u673a\u6216\u6545\u969c\uff08NotReady\u72b6\u6001\uff09\u65f6\uff0c\u8be5\u8282\u70b9\u4e0a\u8fd0\u884c\u7684Pod\u4f1a\u88ab\u81ea\u52a8\u8f6c\u79fb\u5230\u5176\u4ed6\u8282\u70b9\u4e0a\u3002</p> <p>Node\u8282\u70b9\u5305\u62ec\uff1a</p> <ul> <li>Kubelet\uff1a\u8d1f\u8d23\u4e0eMaster\u901a\u4fe1\u534f\u4f5c\uff0c\u7ba1\u7406\u8be5\u8282\u70b9\u4e0a\u7684Pod\uff0c\u5bf9\u5bb9\u5668\u8fdb\u884c\u5065\u5eb7\u68c0\u67e5\u53ca\u76d1\u63a7\uff0c\u540c\u65f6\u8d1f\u8d23\u4e0a\u62a5\u8282\u70b9\u548c\u8282\u70b9\u4e0a\u9762Pod\u7684\u72b6\u6001\u3002</li> <li>Kube-Proxy\uff1a\u8d1f\u8d23\u5404Pod\u4e4b\u95f4\u7684\u901a\u4fe1\u548c\u8d1f\u8f7d\u5747\u8861\uff0c\u5c06\u6307\u5b9a\u7684\u6d41\u91cf\u5206\u53d1\u5230\u540e\u7aef\u6b63\u786e\u7684\u673a\u5668\u4e0a\u3002</li> <li>Docker Engine\uff1aDocker\u5f15\u64ce\uff0c \u8d1f\u8d23\u5bf9\u5bb9\u5668\u7684\u7ba1\u7406\u3002</li> </ul> <p>\u5176\u4ed6\u7ec4\u4ef6\u53ca\u5de5\u5177\uff1a</p> <ul> <li>CoreDNS\uff1a\u7528\u4e8eKubernetes\u96c6\u7fa4\u5185\u90e8Service\u7684\u89e3\u6790\uff0c\u53ef\u4ee5\u8ba9Pod\u628aService\u540d\u79f0\u89e3\u6790\u6210Service\u7684IP\uff0c\u7136\u540e\u901a\u8fc7Service\u7684IP\u5730\u5740\u8fde\u63a5\u5230\u5bf9\u5e94\u7684\u5e94\u7528\u4e0a\u3002</li> <li>Calico\uff1a\u7b26\u5408CNI\u6807\u51c6\u7684\u4e00\u4e2a\u7f51\u7edc\u63d2\u4ef6\uff0c\u5b83\u8d1f\u8d23\u7ed9\u6bcf\u4e2aPod\u5206\u914d\u4e00\u4e2a\u4e0d\u4f1a\u91cd\u590d\u7684IP\uff0c\u5e76\u4e14\u628a\u6bcf\u4e2a\u8282\u70b9\u5f53\u4f5c\u4e00\u4e2a\u201c\u8def\u7531\u5668\u201d\uff0c\u8fd9\u6837\u4e00\u4e2a\u8282\u70b9\u7684Pod\u5c31\u53ef\u4ee5\u901a\u8fc7IP\u5730\u5740\u8bbf\u95ee\u5176\u4ed6\u8282\u70b9\u7684Pod\u3002</li> </ul>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/4.Kubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/#6pod\u7684\u6982\u5ff5","title":"6.Pod\u7684\u6982\u5ff5","text":"<p>Kubernetes\u6700\u5c0f\u7684\u5355\u5143-Pod\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/4.Kubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/#61-\u4ec0\u4e48\u662fpod","title":"6.1 \u4ec0\u4e48\u662fPod","text":"<p>1\uff0e\u5148\u4ece\u4f7f\u7528\u65b9\u6765\u770b</p> <p>\u5728\u5b9e\u9645\u4f7f\u7528\u65f6\uff0c\u5355\u4e2a\u5bb9\u5668\u662f\u65e0\u6cd5\u5355\u72ec\u6765\u652f\u6491\u6211\u4eec\u7684\u5e94\u7528\uff0c\u5f80\u5f80\u9700\u8981\u5f88\u591a\u5fae\u670d\u52a1\u624d\u80fd\u7ec4\u6210\u4e00\u4e2a\u7cfb\u7edf\uff0c\u5e76\u4e14\u8fd8\u4f1a\u5b58\u5728A\u670d\u52a1\u4f9d\u8d56B\u670d\u52a1\uff0cB\u670d\u52a1\u9700\u8981\u548cC\u670d\u52a1\u5171\u7528\u67d0\u4e2a\u76ee\u5f55\uff0c\u5b9e\u73b0\u6570\u636e\u5171\u4eab\u3002</p> <p>\u53e6\u5916\uff0c\u5728\u4f7f\u7528\u88f8\u5bb9\u5668\u65f6\uff0c\u5f88\u96be\u5b9e\u73b0\u5bf9\u5bb9\u5668\u5185\u8fdb\u7a0b\u7684\u5065\u5eb7\u68c0\u67e5\u53ca\u6a2a\u5411\u6269\u5bb9\u7b49\uff0c\u800cPod\u53ef\u4ee5\u8f7b\u8f7b\u677e\u677e\u89e3\u51b3\u4e0a\u8ff0\u95ee\u9898\u3002</p> <p>2\uff0e\u518d\u4eceKubernetes\u89d2\u5ea6\u770b</p> <p>Docker\u53ea\u662f\u5bb9\u5668Runtime\uff08\u8fd0\u884c\u65f6\uff09\u4e2d\u7684\u4e00\u79cd\uff0c\u5e02\u9762\u4e0a\u8fd8\u6709\u5f88\u591a\u5bb9\u5668\u7684Runtime\uff0c\u6bd4\u5982Rkt\u3001CRI-O\u7b49\uff0c\u800cKubernetes\u4f5c\u4e3a\u76ee\u524d\u6700\u6d41\u884c\u7684\u5bb9\u5668\u7f16\u6392\u5de5\u5177\uff0c \u9700\u8981\u652f\u6301\u5404\u4e2aRuntime\u5e76\u4e14\u4e0d\u4f9d\u8d56\u4e8e\u5e95\u5c42Runtime\u7684\u5b9e\u73b0\u6280\u672f\uff0c\u4e8e\u662f\u5c31\u62bd\u8c61\u4e86Pod\u8fd9\u4e2a\u6982\u5ff5\uff0c\u7528\u4e8e\u7ba1\u7406\u591a\u4e2a\u7d27\u5bc6\u76f8\u8fde\u7684\u7b26\u5408CRI\u6807\u51c6\u7684\u5bb9\u5668\uff0c\u53ef\u4ee5\u4ece\u56fe4.2\u6765\u7406\u89e3Pod\u3002</p> <p>)</p> <p>\u56fe4.2Pod\u56fe</p> <p>\u7531\u56fe\u53ef\u77e5\uff0cPod\u53ef\u7b80\u5355\u5730\u7406\u89e3\u4e3a\u4e00\u7ec4\u3001\u4e00\u4e2a\u6216\u591a\u4e2a\u5bb9\u5668\uff0c\u6bcf\u4e2aPod\u8fd8\u5305\u542b\u4e00\u4e2aPause\u5bb9\u5668\uff0cPause\u5bb9\u5668\u662fPod\u7684\u7236\u5bb9\u5668\uff0c\u5b83\u4e3b\u8981\u8d1f\u8d23\u50f5\u5c38\u8fdb\u7a0b\u7684\u56de\u6536\u7ba1\u7406\uff0c \u901a\u8fc7Pause\u5bb9\u5668\u53ef\u4ee5\u4f7f\u540c\u4e00\u4e2aPod\u91cc\u9762\u7684\u4e0d\u540c\u5bb9\u5668\u5171\u4eab\u5b58\u50a8\u3001\u7f51\u7edc\u3001PID\u3001IPC\u7b49\uff0c\u5bb9\u5668\u4e4b\u95f4\u53ef\u4ee5\u4f7f\u7528<code>localhost:port</code>\u76f8\u4e92\u8bbf\u95ee\uff0c\u53ef\u4ee5\u4f7f\u7528Volume\u7b49\u5b9e\u73b0\u6570\u636e\u5171\u4eab\u3002</p> <p>\u6839\u636eDocker\u7684\u6784\u9020\uff0cPod\u53ef\u88ab\u5efa\u6a21\u4e3a\u4e00\u7ec4\u5177\u6709\u5171\u4eab\u547d\u540d\u7a7a\u95f4\u3001\u5377\u3001IP\u5730\u5740\u548c\u7aef\u53e3\u7684\u5bb9\u5668\u3002</p> <p>\u4f7f\u7528\u88f8\u5bb9\u5668\u65f6\uff0c\u9700\u8981\u5c06\u5bb9\u5668\u5185\u5e94\u7528\u7a0b\u5e8f\u7684\u7aef\u53e3\u6620\u5c04\u5230\u5bbf\u4e3b\u673a\uff0c\u5982\u679c\u5bb9\u5668\u8fc7\u591a\uff0c\u7aef\u53e3\u7ba1\u7406\u5c31\u4f1a\u6bd4\u8f83\u56f0\u96be\uff0c\u800c\u4e14\u5bb9\u6613\u5f15\u8d77\u7aef\u53e3\u51b2\u7a81\u3002</p> <p>\u800cKubernetes\u4e3a\u6bcf\u4e2aPod\u90fd\u5206\u914d\u4e00\u4e2a\u552f\u4e00\u7684IP\u5730\u5740\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u4e0d\u540c\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u4f7f\u7528\u540c\u4e00\u4e2a\u7aef\u53e3\uff0c\u4e4b\u540e\u901a\u8fc7Kubernetes\u7684\u5185\u90e8Service\u8fdb\u884c\u8bbf\u95ee\uff0c\u8fd9\u6837\u5c31\u907f\u514d\u4e86\u53d1\u751f\u7aef\u53e3\u51b2\u7a81\u7684\u95ee\u9898\u3002</p> <p>\u548c\u88f8\u5bb9\u5668\u90e8\u7f72\u4e00\u6837\uff0cPod\u5728\u8fd0\u884c\u65f6\u4e5f\u4f1a\u6709\u4e0d\u540c\u7684\u72b6\u6001\uff0cPod\u7684\u72b6\u6001\u4fe1\u606f\u4fdd\u5b58\u5728PodStatus\u5bf9\u8c61\u4e2d\uff0c\u5728PodStatus\u4e2d\u6709\u4e00\u4e2aPhase\u5b57\u6bb5\uff0c\u7528\u4e8e\u63cf\u8ff0Pod\u5728\u5176\u751f\u547d\u5468\u671f\u4e2d\u7684\u4e0d\u540c\u72b6\u6001\u3002\u53ef\u4ee5\u4f7f\u7528Kubernetes\u7684\u5ba2\u6237\u7aef\u5de5\u5177Kubectl\u67e5\u770b\u67d0\u4e2aPod\u7684Phase\u5b57\u6bb5\uff0c\u6bd4\u5982\u67e5\u770bkube-system\u547d\u540d\u7a7a\u95f4\u4e0b\u7684metrics-server\u7684\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pod -n kube-system -l k8s-app=metrics-server\nNAME                             READY   STATUS    RESTARTS   AGE\nmetrics-server-9cb7dd7bc-88mvk   1/1     Running   0          130d\nmetrics-server-9cb7dd7bc-jfvwq   1/1     Running   0          142d\nmetrics-server-9cb7dd7bc-v9kfz   1/1     Running   0          142d\n\n$ kubectl get pod/metrics-server-9cb7dd7bc-v9kfz -n kube-system -o yaml|grep phase\nphase: Running\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6b64\u65f6Pod\u7684\u72b6\u6001\u662fRunning\uff0c\u5f53\u7136\u72b6\u6001\u4e0d\u4ec5\u4ec5\u53ea\u6709Running\uff0c\u5e38\u89c1\u7684\u72b6\u6001\u5982\u8868</p> \u72b6\u6001 \u8bf4\u660e Pending Pod \u5df2\u88ab Kubernetes \u7cfb\u7edf\u63a5\u53d7\uff0c\u4f46\u6709\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u5bb9\u5668\u5c1a\u672a\u521b\u5efa\u4ea6\u672a\u8fd0\u884c\u3002\u6b64\u9636\u6bb5\u5305\u62ec\u7b49\u5f85 Pod \u88ab\u8c03\u5ea6\u7684\u65f6\u95f4\u548c\u901a\u8fc7\u7f51\u7edc\u4e0b\u8f7d\u955c\u50cf\u7684\u65f6\u95f4\uff0c Running Pod \u5df2\u7ecf\u7ed1\u5b9a\u5230\u4e86\u67d0\u4e2a\u8282\u70b9\uff0cPod \u4e2d\u6240\u6709\u7684\u5bb9\u5668\u90fd\u5df2\u88ab\u521b\u5efa\u3002\u81f3\u5c11\u6709\u4e00\u4e2a\u5bb9\u5668\u4ecd\u5728\u8fd0\u884c\uff0c\u6216\u8005\u6b63\u5904\u4e8e\u542f\u52a8\u6216\u91cd\u542f\u72b6\u6001\u3002 Succeeded Pod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u90fd\u5df2\u6210\u529f\u7ec8\u6b62\uff0c\u5e76\u4e14\u4e0d\u4f1a\u518d\u91cd\u542f\u3002 Failed Pod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u90fd\u5df2\u7ec8\u6b62\uff0c\u5e76\u4e14\u81f3\u5c11\u6709\u4e00\u4e2a\u5bb9\u5668\u662f\u56e0\u4e3a\u5931\u8d25\u7ec8\u6b62\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5bb9\u5668\u4ee5\u975e 0 \u72b6\u6001\u9000\u51fa\u6216\u8005\u88ab\u7cfb\u7edf\u7ec8\u6b62\u3002 Unknown \u56e0\u4e3a\u67d0\u4e9b\u539f\u56e0\u65e0\u6cd5\u53d6\u5f97 Pod \u7684\u72b6\u6001\u3002\u8fd9\u79cd\u60c5\u51b5\u901a\u5e38\u662f\u56e0\u4e3a\u4e0e Pod \u6240\u5728\u4e3b\u673a\u901a\u4fe1\u5931\u8d25\u3002 ImagePullBackOff ErrImagePull \u955c\u50cf\u62c9\u53d6\u5931\u8d25\uff0c\u4e00\u822c\u662f\u7531\u4e8e\u7f51\u7edc\u4e0d\u901a\u3001\u955c\u50cf\u4e0d\u5b58\u5728\u3001\u9700\u8981\u8ba4\u8bc1\u5f15\u8d77\u7684\uff0c\u53ef\u4ee5\u4f7f\u7528describe\u547d\u4ee4\u67e5\u770b\u5177\u4f53\u539f\u56e0 CrashLoopBackOff \u5bb9\u5668\u542f\u52a8\u5931\u8d25\uff0c\u53ef\u4ee5\u901a\u8fc7logs\u547d\u4ee4\u67e5\u770b\u5177\u4f53\u539f\u56e0\uff0c\u4e00\u822c\u4e3a\u542f\u52a8\u547d\u4ee4\u4e0d\u6b63\u786e\u3001\u5065\u5eb7\u68c0\u67e5\u4e0d\u901a\u8fc7\u7b49 OOMkilled \u5bb9\u5668\u5185\u5b58\u6ea2\u51fa\uff0c\u4e00\u822c\u662f\u5bb9\u5668\u7684\u5185\u5b58Limit\u8bbe\u7f6e\u5f97\u8fc7\u5c0f\uff0c\u6216\u8005\u7a0b\u5e8f\u672c\u8eab\u5185\u5b58\u6ea2\u51fa\uff0c\u53ef\u4ee5\u901a\u8fc7logs\u67e5\u770b\u7a0b\u5e8f\u7684\u542f\u52a8\u65e5\u5fd7 Terminating Pod\u6b63\u5728\u88ab\u5220\u9664\uff0c\u53ef\u4ee5\u4f7f\u7528describe\u547d\u4ee4\u67e5\u770b\u72b6\u6001 SysctlForbidden Pod\u81ea\u5b9a\u4e49\u4e86\u5185\u6838\u914d\u7f6e\uff0c\u4f46kubelet\u6ca1\u6709\u6dfb\u52a0\u5185\u6838\u914d\u7f6e\u6216\u8005\u914d\u7f6e\u7684\u5185\u6838\u53c2\u6570\u4e0d\u652f\u6301\u53ef\u4ee5\u4f7f\u7528describe\u547d\u4ee4\u67e5\u770b\u5177\u4f53\u539f\u56e0 Completed \u5bb9\u5668\u5185\u90e8\u4e3b\u8fdb\u7a0b\u9000\u51fa\uff0c\u4e00\u822c\u8ba1\u5212\u4efb\u52a1\u7ed3\u675f\u4f1a\u663e\u793a\u8be5\u72b6\u6001\uff0c\u53ef\u4ee5\u901a\u8fc7logs\u67e5\u770b\u5bb9\u5668\u72b6\u6001 ContainerCreating Pod\u6b63\u5728\u521b\u5efa\uff0c\u4e00\u822c\u4e3a\u6b63\u5728\u4e0b\u8f7d\u955c\u50cf\uff0c\u6216\u8005\u6709\u914d\u7f6e\u4e0d\u5f53\u7684\u5730\u65b9\uff0c\u53ef\u4ee5\u4f7f\u7528describe\u547d\u4ee4\u67e5\u770b\u5177\u4f53\u539f\u56e0 <p>\u5c0f\u77e5\u8bc6</p> <p>Pod\u7684Phase\u5b57\u6bb5\u53ea\u6709Pending\u3001Running\u3001Succeeded\u3001Failed\u3001Unknown 5\u79cd\u72b6\u6001\uff0c\u5176\u4f59\u7684\u4e3a\u5904\u4e8e\u4e0a\u8ff0\u72b6\u6001\u7684\u539f\u56e0\uff0c\u53ef\u4ee5\u901a\u8fc7kubectl get po xxx -o yaml\u67e5\u770b</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/4.Kubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/#62-pod\u63a2\u9488","title":"6.2 Pod\u63a2\u9488","text":"<p>\u5728\u751f\u4ea7\u73af\u5883\u4e0b\uff0c\u8fdb\u7a0b\u6b63\u5e38\u542f\u52a8\u5e76\u4e0d\u4ee3\u8868\u5e94\u7528\u80fd\u6b63\u5e38\u5904\u7406\u8bf7\u6c42\uff0c\u6240\u4ee5\u5408\u7406\u5730\u8bbe\u8ba1\u5e94\u7528\u7684\u5065\u5eb7\u68c0\u67e5\u5c24\u4e3a\u91cd\u8981\u3002\u5728\u4f7f\u7528\u88f8\u673a\u6216\u8005\u88f8\u5bb9\u5668\u90e8\u7f72\u65f6\uff0c\u4e00\u822c\u5f88\u96be\u5bf9\u5e94\u7528\u505a\u5f88\u5b8c\u5584\u7684\u5065\u5eb7\u68c0\u67e5\uff0c\u800cPod\u63d0\u4f9b\u7684\u63a2\u9488\u53ef\u4ee5\u5f88\u65b9\u4fbf\u5730\u7528\u6765\u68c0\u6d4b\u5bb9\u5668\u5185\u7684\u5e94\u7528\u662f\u5426\u6b63\u5e38\u3002</p> <p>\u76ee\u524d\u63a2\u9488\u67093\u79cd\u68c0\u6d4b\u65b9\u5f0f\uff0c\u53ef\u4ee5\u6839\u636e\u4e0d\u540c\u7684\u573a\u666f\u9009\u62e9\u5408\u9002\u7684\u5065\u5eb7\u68c0\u67e5\u65b9\u5f0f\u3002\u68c0\u6d4b\u65b9\u5f0f\u5982\u8868\u6240\u793a\u3002</p> <p>Pod\u63a2\u9488\u7684\u5b9e\u73b0\u65b9\u5f0f</p> \u5b9e\u73b0\u65b9\u5f0f \u8bf4\u660e ExecAction \u5728\u5bb9\u5668\u5185\u6267\u884c\u6307\u5b9a\u547d\u4ee4\u3002\u5982\u679c\u547d\u4ee4\u9000\u51fa\u65f6\u8fd4\u56de\u7801\u4e3a 0 \u5219\u8ba4\u4e3a\u8bca\u65ad\u6210\u529f\u3002 TCPSocketAction \u5bf9\u5bb9\u5668\u7684 IP \u5730\u5740\u4e0a\u7684\u6307\u5b9a\u7aef\u53e3\u6267\u884c TCP \u68c0\u67e5\u3002\u5982\u679c\u7aef\u53e3\u6253\u5f00\uff0c\u5219\u8bca\u65ad\u88ab\u8ba4\u4e3a\u662f\u6210\u529f\u7684\u3002 HTTPGetAction \u5bf9\u5bb9\u5668\u7684 IP \u5730\u5740\u4e0a\u6307\u5b9a\u7aef\u53e3\u548c\u8def\u5f84\u6267\u884c HTTP Get \u8bf7\u6c42\u3002\u5982\u679c\u54cd\u5e94\u7684\u72b6\u6001\u7801\u5927\u4e8e\u7b49\u4e8e 200 \u4e14\u5c0f\u4e8e 400\uff0c\u5219\u8bca\u65ad\u88ab\u8ba4\u4e3a\u662f\u6210\u529f\u7684\u3002 <p>\u4e0a\u8ff0\u68c0\u67e5\u65b9\u5f0f\u53ef\u4ee5\u88ab\u5468\u671f\u6027\u6267\u884c\uff0c\u6bcf\u6b21\u68c0\u67e5\u5bb9\u5668\u540e\u53ef\u80fd\u5f97\u5230\u7684\u5bb9\u5668\u72b6\u6001\u5982\u8868</p> <p>Pod\u63a2\u9488\u68c0\u67e5\u5bb9\u5668\u540e\u53ef\u80fd\u5f97\u5230\u7684\u72b6\u6001</p> \u72b6\u6001 \u8bf4\u660e Success\uff08\u6210\u529f\uff09 \u5bb9\u5668\u901a\u8fc7\u4e86\u8bca\u65ad\u3002 Failure\uff08\u5931\u8d25\uff09 \u5bb9\u5668\u672a\u901a\u8fc7\u8bca\u65ad\u3002 Unknown\uff08\u672a\u77e5\uff09 \u8bca\u65ad\u5931\u8d25\uff0c\u56e0\u6b64\u4e0d\u4f1a\u91c7\u53d6\u4efb\u4f55\u884c\u52a8\u3002 <p>Kubelet\u5b9e\u73b0\u4e0a\u8ff0\u68c0\u67e5\u67093\u79cd\u68c0\u6d4b\u65b9\u5f0f\uff0c\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u591a\u52a0\u5229\u7528\u53ef\u4ee5\u63d0\u9ad8\u5e94\u7528\u7684\u53ef\u7528\u7387\u3002</p> <p>\u76ee\u524d\u652f\u6301\u7684\u63a2\u6d4b\u5668\u7c7b\u578b\u67093\u79cd\uff0c\u53ef\u4ee5\u9009\u62e9\u6027\u5730\u5bf9\u5bb9\u5668\u8fdb\u884c\u68c0\u6d4b\uff0c\u53c2\u8003\u8868</p> <p>\u63a2\u9488\u7684\u79cd\u7c7b</p> \u79cd\u7c7b \u8bf4\u660e livenessProbe \u6307\u793a\u5bb9\u5668\u662f\u5426\u6b63\u5728\u8fd0\u884c\u3002\u5982\u679c\u5b58\u6d3b\u6001\u63a2\u6d4b\u5931\u8d25\uff0c\u5219 kubelet \u4f1a\u6740\u6b7b\u5bb9\u5668\uff0c \u5e76\u4e14\u5bb9\u5668\u5c06\u6839\u636e\u5176\u91cd\u542f\u7b56\u7565\u51b3\u5b9a\u672a\u6765\u3002\u5982\u679c\u5bb9\u5668\u4e0d\u63d0\u4f9b\u5b58\u6d3b\u63a2\u9488\uff0c \u5219\u9ed8\u8ba4\u72b6\u6001\u4e3a Success\u3002 readinessProbe \u6307\u793a\u5bb9\u5668\u662f\u5426\u51c6\u5907\u597d\u4e3a\u8bf7\u6c42\u63d0\u4f9b\u670d\u52a1\u3002\u5982\u679c\u5c31\u7eea\u6001\u63a2\u6d4b\u5931\u8d25\uff0c \u7aef\u70b9\u63a7\u5236\u5668\u5c06\u4ece\u4e0e Pod \u5339\u914d\u7684\u6240\u6709\u670d\u52a1\u7684\u7aef\u70b9\u5217\u8868\u4e2d\u5220\u9664\u8be5 Pod \u7684 IP \u5730\u5740\u3002\u521d\u59cb\u5ef6\u8fdf\u4e4b\u524d\u7684\u5c31\u7eea\u6001\u7684\u72b6\u6001\u503c\u9ed8\u8ba4\u4e3a Failure\u3002 \u5982\u679c\u5bb9\u5668\u4e0d\u63d0\u4f9b\u5c31\u7eea\u6001\u63a2\u9488\uff0c\u5219\u9ed8\u8ba4\u72b6\u6001\u4e3a Success\u3002 startupProbe \u6307\u793a\u5bb9\u5668\u4e2d\u7684\u5e94\u7528\u662f\u5426\u5df2\u7ecf\u542f\u52a8\u3002\u5982\u679c\u63d0\u4f9b\u4e86\u542f\u52a8\u63a2\u9488\uff0c\u5219\u6240\u6709\u5176\u4ed6\u63a2\u9488\u90fd\u4f1a\u88ab \u7981\u7528\uff0c\u76f4\u5230\u6b64\u63a2\u9488\u6210\u529f\u4e3a\u6b62\u3002\u5982\u679c\u542f\u52a8\u63a2\u6d4b\u5931\u8d25\uff0ckubelet \u5c06\u6740\u6b7b\u5bb9\u5668\uff0c\u800c\u5bb9\u5668\u4f9d\u5176 \u91cd\u542f\u7b56\u7565\u8fdb\u884c\u91cd\u542f\u3002\u5982\u679c\u5bb9\u5668\u6ca1\u6709\u63d0\u4f9b\u542f\u52a8\u63a2\u6d4b\uff0c\u5219\u9ed8\u8ba4\u72b6\u6001\u4e3a Success\u3002"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/4.Kubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/#63-pod\u955c\u50cf\u62c9\u53d6\u7b56\u7565\u548c\u91cd\u542f\u7b56\u7565","title":"6.3 Pod\u955c\u50cf\u62c9\u53d6\u7b56\u7565\u548c\u91cd\u542f\u7b56\u7565","text":"<p>\u5728\u53d1\u5e03\u5e94\u7528\u6216\u66f4\u6539\u63a7\u5236\u5668\u914d\u7f6e\u65f6\uff0c\u4f1a\u89e6\u53d1Pod\u7684\u6eda\u52a8\u66f4\u65b0\uff0c\u6b64\u65f6\u9488\u5bf9\u5bb9\u5668\u7684\u955c\u50cf\u6709\u4e0d\u540c\u7684\u62c9\u53d6\u65b9\u5f0f</p> <p>\u955c\u50cf\u62c9\u53d6\u7b56\u7565</p> <pre><code>    spec:\ncontainers:\n- name:  copycat\nimage: hub.gitee.cc/gitee_ci/copycat:v2.0.0\nimagePullPolicy: Always\nresources:\n......\n</code></pre> \u64cd\u4f5c\u65b9\u5f0f \u8bf4\u660e Always \u4e0d\u7ba1\u955c\u50cf\u662f\u5426\u5b58\u5728\u90fd\u4f1a\u8fdb\u884c\u4e00\u6b21\u62c9\u53d6\u3002 Never \u4e0d\u7ba1\u955c\u50cf\u662f\u5426\u5b58\u5728\u90fd\u4e0d\u4f1a\u8fdb\u884c\u62c9\u53d6\u3002 IfNotPresent \u53ea\u6709\u955c\u50cf\u4e0d\u5b58\u5728\u65f6\uff0c\u624d\u4f1a\u8fdb\u884c\u62c9\u53d6 <p>Pod\u8fdb\u884c\u90e8\u7f72\u6216\u8fd0\u884c\u65f6\uff0c\u96be\u514d\u4f1a\u51fa\u73b0\u6545\u969c\uff0c\u5bf9\u4e8e\u6545\u969cPod\u4e5f\u6709\u4e0d\u540c\u7684\u5904\u7406\u65b9\u5f0f\uff0c\u5982\u8868</p> <p>Pod\u91cd\u542f\u7b56\u7565</p> \u64cd\u4f5c\u65b9\u5f0f \u8bf4\u660e Always \u4f46\u51e1Pod\u5bf9\u8c61\u7ec8\u6b62\u5c31\u5c06\u5176\u91cd\u542f\uff0c\u6b64\u4e3a\u9ed8\u8ba4\u8bbe\u5b9a\u3002 OnFailure \u4ec5\u5728Pod\u5bf9\u8c61\u51fa\u73b0\u9519\u8bef\u65f6\u65b9\u624d\u5c06\u5176\u91cd\u542f\u3002 Never \u4ece\u4e0d\u91cd\u542f\u3002 <p>Warning</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0crestartPolicy\u9002\u7528\u4e8ePod\u5bf9\u8c61\u4e2d\u7684\u6240\u6709\u5bb9\u5668\uff0c\u800c\u4e14\u5b83\u4ec5\u7528\u4e8e\u63a7\u5236\u5728\u540c\u4e00\u8282\u70b9\u4e0a\u91cd\u65b0\u542f\u52a8Pod\u5bf9\u8c61\u7684\u76f8\u5173\u5bb9\u5668\u3002</p> <p>\u9996\u6b21\u9700\u8981\u91cd\u542f\u7684\u5bb9\u5668\uff0c\u5c06\u5728\u5176\u9700\u8981\u65f6\u7acb\u5373\u8fdb\u884c\u91cd\u542f\uff0c\u968f\u540e\u518d\u6b21\u9700\u8981\u91cd\u542f\u7684\u64cd\u4f5c\u5c06\u7531kubelet\u5ef6\u8fdf\u4e00\u6bb5\u65f6\u95f4\u540e\u8fdb\u884c\uff0c \u4e14\u53cd\u590d\u7684\u91cd\u542f\u64cd\u4f5c\u7684\u5ef6\u8fdf\u65f6\u957f\u4f9d\u6b21\u4e3a10\u79d2\u300120\u79d2\u300140\u79d2\u300180\u79d2\u3001160\u79d2\u548c300\u79d2\uff0c300\u79d2\u662f\u6700\u5927\u5ef6\u8fdf\u65f6\u957f\u3002</p> <p>\u4e8b\u5b9e\u4e0a\uff0c\u4e00\u65e6\u7ed1\u5b9a\u5230\u4e00\u4e2a\u8282\u70b9\uff0cPod\u5bf9\u8c61\u5c06\u6c38\u8fdc\u4e0d\u4f1a\u88ab\u91cd\u65b0\u7ed1\u5b9a\u5230\u53e6\u4e00\u4e2a\u8282\u70b9\uff0c\u5b83\u8981\u4e48\u88ab\u91cd\u542f\uff0c\u8981\u4e48\u7ec8\u6b62\uff0c\u76f4\u5230\u8282\u70b9\u53d1\u751f\u6545\u969c\u6216\u88ab\u5220\u9664\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/4.Kubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/#64-\u521b\u5efa\u4e00\u4e2apod","title":"6.4 \u521b\u5efa\u4e00\u4e2aPod","text":"<p>\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5f88\u5c11\u5355\u72ec\u8fd0\u884c\u4e00\u4e2aPod\uff0c\u56e0\u4e3a\u5355\u72ec\u521b\u5efa\u7684Pod\u5e76\u4e0d\u80fd\u5b9e\u73b0\u4e00\u4e9b\u9ad8\u7ea7\u7684\u53d1\u5e03\u7b56\u7565\uff0c\u6240\u4ee5\u5728\u5b9e\u9645\u4f7f\u7528\u4e2d\u7ecf\u5e38\u4f1a\u7528Deployment\u3001DaemonSet\u3001StatefulSet\u7b49\u9ad8\u7ea7\u63a7\u5236\u5668\u8c03\u5ea6\u5e76\u7ba1\u7406Pod\u3002</p> <p>\u5f53\u7136\u6709\u65f6\u5019\u4e5f\u4f1a\u5355\u72ec\u542f\u52a8\u4e00\u4e2aPod\u7528\u4e8e\u6d4b\u8bd5\u4e1a\u52a1\u7b49\uff0c\u6b64\u65f6\u53ef\u4ee5\u5355\u72ec\u521b\u5efa\u4e00\u4e2a\u4e34\u65f6Pod\u3002\u521b\u5efa\u4e00\u4e2aPod\u7684\u6807\u51c6\u683c\u5f0f\u5982\u4e0b\uff08\u4e0b\u9762\u5b9a\u4e49\u7684\u5185\u5bb9\u53ef\u4ee5\u76f4\u63a5\u7528\u5728Deployment\u3001DaemonSet\u3001StatefulSet\u4e2d\uff09\uff1a</p> <pre><code>apiVersion: v1 # \u5fc5\u9009\uff0cAPI\u7684\u7248\u672c\u53f7\nkind: Pod       # \u5fc5\u9009\uff0c\u7c7b\u578bPod\nmetadata:       # \u5fc5\u9009\uff0c\u5143\u6570\u636e\nname: nginx   # \u5fc5\u9009\uff0c\u7b26\u5408RFC 1035\u89c4\u8303\u7684Pod\u540d\u79f0\nnamespace: default # \u53ef\u9009\uff0cPod\u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4\uff0c\u4e0d\u6307\u5b9a\u9ed8\u8ba4\u4e3adefault\uff0c\u53ef\u4ee5\u4f7f\u7528-n \u6307\u5b9anamespace\nlabels:       # \u53ef\u9009\uff0c\u6807\u7b7e\u9009\u62e9\u5668\uff0c\u4e00\u822c\u7528\u4e8e\u8fc7\u6ee4\u548c\u533a\u5206Pod\napp: nginx\nrole: frontend # \u53ef\u4ee5\u5199\u591a\u4e2a\nannotations:  # \u53ef\u9009\uff0c\u6ce8\u91ca\u5217\u8868\uff0c\u53ef\u4ee5\u5199\u591a\u4e2a\napp: nginx\nspec:   # \u5fc5\u9009\uff0c\u7528\u4e8e\u5b9a\u4e49\u5bb9\u5668\u7684\u8be6\u7ec6\u4fe1\u606f\ninitContainers: # \u521d\u59cb\u5316\u5bb9\u5668\uff0c\u5728\u5bb9\u5668\u542f\u52a8\u4e4b\u524d\u6267\u884c\u7684\u4e00\u4e9b\u521d\u59cb\u5316\u64cd\u4f5c\n- command:\n- sh\n- -c\n- echo \"I am InitContainer for init some configuration\"\nimage: busybox\nimagePullPolicy: IfNotPresent\nname: init-container\ncontainers:   # \u5fc5\u9009\uff0c\u5bb9\u5668\u5217\u8868\n- name: nginx # \u5fc5\u9009\uff0c\u7b26\u5408RFC 1035\u89c4\u8303\u7684\u5bb9\u5668\u540d\u79f0\nimage: nginx:latest    # \u5fc5\u9009\uff0c\u5bb9\u5668\u6240\u7528\u7684\u955c\u50cf\u7684\u5730\u5740\nimagePullPolicy: Always     # \u53ef\u9009\uff0c\u955c\u50cf\u62c9\u53d6\u7b56\u7565\ncommand: # \u53ef\u9009\uff0c\u5bb9\u5668\u542f\u52a8\u6267\u884c\u7684\u547d\u4ee4\n- nginx\n- -g\n- \"daemon off;\"\nworkingDir: /usr/share/nginx/html       # \u53ef\u9009\uff0c\u5bb9\u5668\u7684\u5de5\u4f5c\u76ee\u5f55\nvolumeMounts:   # \u53ef\u9009\uff0c\u5b58\u50a8\u5377\u914d\u7f6e\uff0c\u53ef\u4ee5\u914d\u7f6e\u591a\u4e2a\n- name: webroot # \u5b58\u50a8\u5377\u540d\u79f0\nmountPath: /usr/share/nginx/html # \u6302\u8f7d\u76ee\u5f55\nreadOnly: true        # \u53ea\u8bfb\nports:  # \u53ef\u9009\uff0c\u5bb9\u5668\u9700\u8981\u66b4\u9732\u7684\u7aef\u53e3\u53f7\u5217\u8868\n- name: http    # \u7aef\u53e3\u540d\u79f0\ncontainerPort: 80     # \u7aef\u53e3\u53f7\nprotocol: TCP # \u7aef\u53e3\u534f\u8bae\uff0c\u9ed8\u8ba4TCP\nenv:    # \u53ef\u9009\uff0c\u73af\u5883\u53d8\u91cf\u914d\u7f6e\u5217\u8868\n- name: TZ      # \u53d8\u91cf\u540d\nvalue: Asia/Shanghai # \u53d8\u91cf\u7684\u503c\n- name: LANG\nvalue: en_US.utf8\nresources:      # \u53ef\u9009\uff0c\u8d44\u6e90\u9650\u5236\u548c\u8d44\u6e90\u8bf7\u6c42\u9650\u5236\nlimits:       # \u6700\u5927\u9650\u5236\u8bbe\u7f6e\ncpu: 1000m\nmemory: 1024Mi\nrequests:     # \u542f\u52a8\u6240\u9700\u7684\u8d44\u6e90\ncpu: 100m\nmemory: 512Mi\n#    startupProbe: # \u53ef\u9009\uff0c\u68c0\u6d4b\u5bb9\u5668\u5185\u8fdb\u7a0b\u662f\u5426\u5b8c\u6210\u542f\u52a8\u3002\u6ce8\u610f\u4e09\u79cd\u68c0\u67e5\u65b9\u5f0f\u540c\u65f6\u53ea\u80fd\u4f7f\u7528\u4e00\u79cd\u3002\n#      httpGet:      # httpGet\u68c0\u6d4b\u65b9\u5f0f\uff0c\u751f\u4ea7\u73af\u5883\u5efa\u8bae\u4f7f\u7528httpGet\u5b9e\u73b0\u63a5\u53e3\u7ea7\u5065\u5eb7\u68c0\u67e5\uff0c\u5065\u5eb7\u68c0\u67e5\u7531\u5e94\u7528\u7a0b\u5e8f\u63d0\u4f9b\u3002\n#            path: /api/successStart # \u68c0\u67e5\u8def\u5f84\n#            port: 80\nreadinessProbe: # \u53ef\u9009\uff0c\u5065\u5eb7\u68c0\u67e5\u3002\u6ce8\u610f\u4e09\u79cd\u68c0\u67e5\u65b9\u5f0f\u540c\u65f6\u53ea\u80fd\u4f7f\u7528\u4e00\u79cd\u3002\nhttpGet:      # httpGet\u68c0\u6d4b\u65b9\u5f0f\uff0c\u751f\u4ea7\u73af\u5883\u5efa\u8bae\u4f7f\u7528httpGet\u5b9e\u73b0\u63a5\u53e3\u7ea7\u5065\u5eb7\u68c0\u67e5\uff0c\u5065\u5eb7\u68c0\u67e5\u7531\u5e94\u7528\u7a0b\u5e8f\u63d0\u4f9b\u3002\npath: / # \u68c0\u67e5\u8def\u5f84\nport: 80        # \u76d1\u63a7\u7aef\u53e3\nlivenessProbe:  # \u53ef\u9009\uff0c\u5065\u5eb7\u68c0\u67e5\n#exec:        # \u6267\u884c\u5bb9\u5668\u547d\u4ee4\u68c0\u6d4b\u65b9\u5f0f\n#command:\n#- cat\n#- /health\n#httpGet:       # httpGet\u68c0\u6d4b\u65b9\u5f0f\n#   path: /_health # \u68c0\u67e5\u8def\u5f84\n#   port: 8080\n#   httpHeaders: # \u68c0\u67e5\u7684\u8bf7\u6c42\u5934\n#   - name: end-user\n#     value: Jason\ntcpSocket:    # \u7aef\u53e3\u68c0\u6d4b\u65b9\u5f0f\nport: 80\ninitialDelaySeconds: 60       # \u521d\u59cb\u5316\u65f6\u95f4\ntimeoutSeconds: 2     # \u8d85\u65f6\u65f6\u95f4\nperiodSeconds: 5      # \u68c0\u6d4b\u95f4\u9694\nsuccessThreshold: 1   # \u68c0\u67e5\u6210\u529f\u4e3a1\u6b21\u8868\u793a\u5c31\u7eea\nfailureThreshold: 2   # \u68c0\u6d4b\u5931\u8d252\u6b21\u8868\u793a\u672a\u5c31\u7eea\nlifecycle:\npostStart: # \u5bb9\u5668\u521b\u5efa\u5b8c\u6210\u540e\u6267\u884c\u7684\u6307\u4ee4, \u53ef\u4ee5\u662fexec httpGet TCPSocket\nexec:\ncommand:\n- sh\n- -c\n- 'mkdir /data/ '\npreStop:\nhttpGet:\npath: /\nport: 80\n#  exec:\n#    command:\n#    - sh\n#    - -c\n#    - sleep 9\nrestartPolicy: Always   # \u53ef\u9009\uff0c\u9ed8\u8ba4\u4e3aAlways\n#nodeSelector: # \u53ef\u9009\uff0c\u6307\u5b9aNode\u8282\u70b9\n#      region: subnet7\nimagePullSecrets:     # \u53ef\u9009\uff0c\u62c9\u53d6\u955c\u50cf\u4f7f\u7528\u7684secret\uff0c\u53ef\u4ee5\u914d\u7f6e\u591a\u4e2a\n- name: default-dockercfg-86258\nhostNetwork: false    # \u53ef\u9009\uff0c\u662f\u5426\u4e3a\u4e3b\u673a\u6a21\u5f0f\uff0c\u5982\u662f\uff0c\u4f1a\u5360\u7528\u4e3b\u673a\u7aef\u53e3\nvolumes:      # \u5171\u4eab\u5b58\u50a8\u5377\u5217\u8868\n- name: webroot # \u540d\u79f0\uff0c\u4e0e\u4e0a\u8ff0\u5bf9\u5e94\nemptyDir: {}    # \u6302\u8f7d\u76ee\u5f55\n#hostPath:              # \u6302\u8f7d\u672c\u673a\u76ee\u5f55\n#  path: /etc/hosts\n</code></pre> <p>\u8303\u4f8b</p> <p>\u8be5YAML\u6587\u4ef6\u5b9a\u4e49\u7684\u662f\u4e00\u4e9b\u6bd4\u8f83\u5e38\u7528\u7684\u914d\u7f6e\uff0c\u540e\u7eed\u7684\u7ae0\u8282\u4f1a\u6269\u5c55\u66f4\u591a\u914d\u7f6e\u9879\u3002\u5bf9\u4e8eYAML\u7684\u8bed\u6cd5\u4e0d\u719f\u7684\u8bfb\u8005\u53ef\u4ee5\u7b80\u5355\u5b66\u4e60\u4e00\u4e0b\u3002</p> <p>\u53ef\u4ee5\u5728Kubernetes\u96c6\u7fa4\u4e2d\u4f7f\u7528kubectl\u521b\u5efa\u8be5Pod\uff1a</p> <pre><code>$ kubectl apply -f pod.yml\npod/nginx created\n</code></pre> <p>\u4e0a\u8ff0pod.yaml\u5b9a\u4e49\u4e86labels\u5b57\u6bb5\uff0c\u53ef\u4ee5\u6839\u636e\u8be5\u6807\u7b7e\u8fc7\u6ee4\u67e5\u770b\u8be5Pod\u7684\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pod -n default -l app=nginx\nNAME    READY   STATUS    RESTARTS   AGE\nnginx   0/1     Running   0          86s\n</code></pre> <p>\u5f53\u4e0d\u518d\u4f7f\u7528\u8be5Pod\u65f6\uff0c\u53ef\u4ee5\u5220\u9664\u8be5Pod\uff08\u7531\u4e8e\u662f\u5355\u72ec\u521b\u5efa\u7684Pod\uff0c\u5220\u9664\u540e\u4e0d\u4f1a\u91cd\u5efa\uff0c\u9ad8\u7ea7\u63a7\u5236\u5668\u5220\u9664\u540e\u4f1a\u81ea\u52a8\u91cd\u5efa\uff09\uff1a</p> <pre><code>$ kubectl delete pod/nginx\npod \"nginx\" deleted\n\n$ kubectl get pod -n default -l app=nginx\nNo resources found in default namespace.\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/4.Kubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/#6\u5c0f\u7ed3","title":"6.\u5c0f\u7ed3","text":"<p>\u672c\u7ae0\u4e3b\u8981\u662f\u5bf9Kubernetes\u7684\u57fa\u7840\u548cPod\u8fdb\u884c\u7b80\u5355\u7684\u4e86\u89e3\u3002 \u63a5\u4e0b\u6765\uff0c\u5bf9\u4e8e\u66f4\u9ad8\u7ea7\u8c03\u5ea6\u8d44\u6e90\u7684\u4f7f\u7528\u548c\u914d\u7f6e\u90fd\u662f\u57fa\u4e8ePod\u7684\u5b9a\u4e49\u5c55\u5f00\u7684\uff0c\u6240\u4ee5\u5bf9\u4e8ePod\u7684\u5b66\u4e60\u5c24\u4e3a\u91cd\u8981\uff0c\u540c\u65f6\u5bf9\u4e8ePod\u7684\u8d44\u6e90\u5b9a\u4e49\u5728\u540e\u9762\u7684\u8c03\u5ea6\u8d44\u6e90\u4e2d\u90fd\u662f\u901a\u7528\u7684\u3002</p> <p>\u53e6\u5916\uff0c\u4e00\u4e2aPod\u53ef\u4ee5\u914d\u7f6e\u591a\u4e2a\u5bb9\u5668\uff0c\u4f46\u662f\u4e00\u4e2a\u5bb9\u5668\u4e0d\u8981\u914d\u7f6e\u591a\u4e2a\u8fdb\u7a0b\uff0c\u8fd9\u662f\u975e\u5e38\u4e0d\u63a8\u8350\u7684\u7528\u6cd5\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/","title":"Kubernetes\u8c03\u5ea6\u57fa\u7840","text":"<p>\u5bf9\u4e8eKubernetes\u7684\u5e94\u7528\u90e8\u7f72\uff0c\u6211\u4eec\u4e4b\u524d\u63d0\u5230\u8fc7Pod\u5c31\u662f\u7528\u6765\u914d\u7f6e\u5bb9\u5668\u7684\uff0c\u5bb9\u5668\u5c31\u662f\u7528\u6765\u8fd0\u884c\u5e94\u7528\u7684\u3002</p> <p>\u4e5f\u63d0\u5230\u8fc7\uff0c\u5728\u5b9e\u9645\u4f7f\u7528\u65f6\uff0c\u4e0d\u4f1a\u521b\u5efa\u5355\u72ec\u7684Pod\u8fd0\u884c\u5e94\u7528\uff0c\u800c\u662f\u4f7f\u7528\u66f4\u9ad8\u7ea7\u7684\u8d44\u6e90\u8fdb\u884c\u8c03\u5ea6\uff0c\u6bd4\u5982Deployment\u7b49\u3002</p> <p>\u672c\u7ae0\u7684\u5185\u5bb9\u5c31\u662f\u8bb2\u89e3Kubernetes\u539f\u751f\u7684\u8c03\u5ea6\u8d44\u6e90\uff0c \u5728\u8bb2\u89e3\u9ad8\u7ea7\u8d44\u6e90Deployment\u3001StatefulSet\u4e4b\u524d\uff0c\u9996\u5148\u4f1a\u4ecb\u7ecd\u4ec0\u4e48\u662f Replication Controller\u548cReplicaSet\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#1replication-controller\u548creplicaset","title":"1.Replication Controller\u548cReplicaSet","text":"<p>Replication Controller\uff08\u590d\u5236\u63a7\u5236\u5668\uff0cRC\uff09\u548cReplicaSet\uff08\u590d\u5236\u96c6\uff0cRS\uff09\u662f\u4e24\u79cd\u7b80\u5355\u90e8\u7f72Pod\u7684\u65b9\u5f0f\u3002</p> <p>\u56e0\u4e3a\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4e3b\u8981\u4f7f\u7528\u66f4\u9ad8\u7ea7\u7684Deployment\u7b49\u65b9\u5f0f\u8fdb\u884cPod\u7684\u7ba1\u7406\u548c\u90e8\u7f72\uff0c\u6240\u4ee5\u672c\u8282\u53ea\u5bf9Replication Controller\u548cReplica Set\u7684\u90e8\u7f72\u65b9\u5f0f\u8fdb\u884c\u7b80\u5355\u4ecb\u7ecd\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#11-replication-controller","title":"1.1 Replication Controller","text":"<p>Replication Controller\u53ef\u4ee5\u786e\u4fddPod\u526f\u672c\u6570\u8fbe\u5230\u671f\u671b\u503c\uff0c\u4e5f\u5c31\u662fRC\u5b9a\u4e49\u7684\u6570\u91cf\u3002\u6362\u53e5\u8bdd\u8bf4\uff0cReplication Controller\u53ef\u4ee5\u786e\u4fdd\u4e00\u4e2aPod\u6216\u4e00\u7ec4\u540c\u7c7bPod\u603b\u662f\u53ef\u7528\u7684\u3002\u5982\u679c\u5b58\u5728\u7684Pod\u5927\u4e8e\u8bbe\u5b9a\u7684\u503c\uff0c\u5219Replication Controller\u5c06\u7ec8\u6b62\u989d\u5916\u7684Pod\u3002</p> <p>\u5982\u679c\u592a\u5c0f\uff0cReplication Controller\u5c06\u542f\u52a8\u66f4\u591a\u7684Pod\u7528\u4e8e\u4fdd\u8bc1\u8fbe\u5230\u671f\u671b\u503c\u3002\u4e0e\u624b\u52a8\u521b\u5efaPod\u4e0d\u540c\u7684\u662f\uff0c\u7528Replication Controller\u7ef4\u62a4\u7684Pod\u5728\u5931\u8d25\u3001\u5220\u9664\u6216\u7ec8\u6b62\u65f6\u4f1a\u81ea\u52a8\u66ff\u6362\u3002</p> <p>\u56e0\u6b64\uff0c\u5373\u4f7f\u5e94\u7528\u7a0b\u5e8f\u53ea\u9700\u8981\u4e00\u4e2aPod\uff0c\u4e5f\u5e94\u8be5\u4f7f\u7528Replication Controller\u6216\u5176\u4ed6\u65b9\u5f0f\u7ba1\u7406\u3002Replication Controller\u7c7b\u4f3c\u4e8e\u8fdb\u7a0b\u7ba1\u7406\u7a0b\u5e8f\uff0c\u4f46\u662fReplication Controller\u4e0d\u662f\u76d1\u89c6\u5355\u4e2a\u8282\u70b9\u4e0a\u7684\u5404\u4e2a\u8fdb\u7a0b\uff0c\u800c\u662f\u76d1\u89c6\u591a\u4e2a\u8282\u70b9\u4e0a\u7684\u591a\u4e2aPod\u3002</p> <p>\u5b9a\u4e49\u4e00\u4e2aReplication Controller\u7684\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: v1\nkind: ReplicationController\nmetadata:\nname: nginx\nspec:\nreplicas: 3\nselector:\napp: nginx\ntemplate:\nmetadata:\nname: nginx\nlabels:\napp: nginx\nspec:\ncontainers:\n- name: nginx\nimage: nginx\nports:\n- containerPort: 80\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#12-replicaset","title":"1.2 ReplicaSet","text":"<p>ReplicaSet\u662f\u652f\u6301\u57fa\u4e8e\u96c6\u5408\u7684\u6807\u7b7e\u9009\u62e9\u5668\u7684\u4e0b\u4e00\u4ee3Replication Controller\uff0c\u5b83\u4e3b\u8981\u7528\u4f5cDeployment\u534f\u8c03\u521b\u5efa\u3001\u5220\u9664\u548c\u66f4\u65b0Pod\uff0c\u548cReplication Controller\u552f\u4e00\u7684\u533a\u522b\u662f\uff0cReplicaSet\u652f\u6301\u6807\u7b7e\u9009\u62e9\u5668\u3002</p> <p>\u5728\u5b9e\u9645\u5e94\u7528\u4e2d\uff0c\u867d\u7136ReplicaSet\u53ef\u4ee5\u5355\u72ec\u4f7f\u7528\uff0c\u4f46\u662f\u4e00\u822c\u5efa\u8bae\u4f7f\u7528Deployment\u6765\u81ea\u52a8\u7ba1\u7406ReplicaSet\uff0c\u9664\u975e\u81ea\u5b9a\u4e49\u7684Pod\u4e0d\u9700\u8981\u66f4\u65b0\u6216\u6709\u5176\u4ed6\u7f16\u6392\u7b49\u3002</p> <p>\u5b9a\u4e49\u4e00\u4e2aReplicaSet\u7684\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: ReplicaSet\nmetadata:\nname: frontend\nlabels:\napp: guestbook\ntier: frontend\nspec:\n# modify replicas according to your case\nreplicas: 3\nselector:\nmatchLabels:\ntier: frontend\nmatchExpressions:\n- {key: tier, operator: In, values: [frontend]}\ntemplate:\nmetadata:\nlabels:\napp: guestbook\ntier: frontend\nspec:\ncontainers:\n- name: php-redis\nimage: gcr.io/google_samples/gb-frontend:v3\nresources:\nrequests:\ncpu: 100m\nmemory: 100Mi\nenv:\n- name: GET_HOSTS_FROM\nvalue: dns\n# If your cluster config does not include a dns service, then to\n# instead access environment variables to find service host\n# info, comment out the 'value: dns' line above, and uncomment the\n# line below.\n# value: env\nports:\n- containerPort: 80\n</code></pre> <p>Replication Controller\u548cReplicaSet\u7684\u521b\u5efa\u3001\u5220\u9664\u548cPod\u5e76\u65e0\u592a\u5927\u533a\u522b\uff0c</p> <p>Replication Controller\u76ee\u524d\u51e0\u4e4e\u5df2\u7ecf\u4e0d\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528\uff0cReplicaSet\u4e5f\u5f88\u5c11\u5355\u72ec\u88ab\u4f7f\u7528\uff0c\u90fd\u662f\u4f7f\u7528\u66f4\u9ad8\u7ea7\u7684\u8d44\u6e90Deployment\u3001DaemonSet\u3001StatefulSet\u7ba1\u7406Pod\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#2\u65e0\u72b6\u6001\u5e94\u7528\u7ba1\u7406deployment","title":"2.\u65e0\u72b6\u6001\u5e94\u7528\u7ba1\u7406Deployment","text":"<p>\u524d\u6587\u63d0\u5230\u7684ReplicaSet\u53ef\u4ee5\u786e\u4fdd\u5728\u4efb\u4f55\u7ed9\u5b9a\u65f6\u95f4\u8fd0\u884c\u7684Pod\u526f\u672c\u8fbe\u5230\u6307\u5b9a\u7684\u6570\u91cf\uff0c\u4f46\u662fDeployment\u662f\u4e00\u4e2a\u66f4\u9ad8\u7ea7\u7684\u6982\u5ff5\uff0c\u5b83\u7ba1\u7406ReplicaSet\u5e76\u4e3aPod\u548cReplicaSet\u63d0\u4f9b\u58f0\u660e\u6027\u66f4\u65b0\u4ee5\u53ca\u8bb8\u591a\u5176\u4ed6\u6709\u7528\u7684\u529f\u80fd\uff0c \u6240\u4ee5\u5efa\u8bae\u5728\u751f\u4ea7\u73af\u5883\u4e0b\u4f7f\u7528Deployment\u4ee3\u66ffReplicaSet\u3002</p> <p>Deployment\u4e00\u822c\u7528\u4e8e\u90e8\u7f72\u516c\u53f8\u7684\u65e0\u72b6\u6001\u670d\u52a1\uff0c\u8fd9\u4e2a\u4e5f\u662f\u6700\u5e38\u7528\u7684\u63a7\u5236\u5668\uff0c\u56e0\u4e3a\u4f01\u4e1a\u5185\u90e8\u73b0\u5728\u90fd\u662f\u4ee5\u5fae\u670d\u52a1\u4e3a\u4e3b\uff0c\u800c\u5fae\u670d\u52a1\u5b9e\u73b0\u65e0\u72b6\u6001\u5316\u4e5f\u662f\u6700\u4f73\u5b9e\u8df5\uff0c \u53ef\u4ee5\u5229\u7528Deployment\u7684\u9ad8\u7ea7\u529f\u80fd\u505a\u5230\u65e0\u7f1d\u8fc1\u79fb\u3001\u81ea\u52a8\u6269\u5bb9\u7f29\u5bb9\u3001\u81ea\u52a8\u707e\u96be\u6062\u590d\u3001\u4e00\u952e\u56de\u6eda\u7b49\u529f\u80fd\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#21-\u521b\u5efadeployment","title":"2.1 \u521b\u5efaDeployment","text":"<p>\u521b\u5efa\u4e00\u4e2aDeployment\u4e5f\u5f88\u7b80\u5355\uff0c\u5c06\u524d\u9762\u7ae0\u8282\u521b\u5efaPod\u7684YAML\u6587\u4ef6\u7a0d\u5fae\u66f4\u6539\u4e00\u4e0b\u5373\u53ef\u53d8\u6210Deployment\u7684\u8d44\u6e90\u6587\u4ef6\uff0c\u6bd4\u5982\u521b\u5efa\u4e00\u4e2a\u67093\u4e2aNginx\u526f\u672c(\u5b9e\u4f8b)\u7684Deployment\uff0c\u53ef\u4ee5\u770b\u5230\u53ea\u662fapiVersion\u548cKind\u6709\u6240\u53d8\u5316\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p>dp-nginx.yml</p> <pre><code># \u4eceKubernetes 1.16\u7248\u672c\u5f00\u59cb\uff0c\u5f7b\u5e95\u5e9f\u5f03\u4e86\u5176\u4ed6\u7684APIVersion\uff0c\u53ea\u80fd\u4f7f\u7528apps/v1\uff0c1.16\u4ee5\u4e0a\u7684\u7248\u672c\u53ef\u4ee5\u4f7f\u7528extension\u7b49\napiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: nginx-deployment\nlabels:\napp: nginx\nspec:\nreplicas: 3\nselector:\nmatchLabels:\napp: nginx\ntemplate:\nmetadata:\nlabels:\napp: nginx\nspec:\ncontainers:\n- name: nginx\nimage: nginx:1.7.9\nports:\n- containerPort: 80\n</code></pre> <p>\u793a\u4f8b\u89e3\u6790\uff1a</p> <ul> <li>nginx-deployment\uff1aDeployment\u7684\u540d\u79f0\u3002</li> <li>replicas\uff1a\u521b\u5efaPod\u7684\u526f\u672c\u6570\u3002</li> <li>selector\uff1a\u5b9a\u4e49Deployment\u5982\u4f55\u627e\u5230\u8981\u7ba1\u7406\u7684Pod\uff0c\u4e0etemplate\u7684</li> </ul> <p>label\uff08\u6807\u7b7e\uff09\u5bf9\u5e94\uff0capiVersion\u4e3aapps/v1\u5fc5\u987b\u6307\u5b9a\u8be5\u5b57\u6bb5\u3002 - template\u5b57\u6bb5\u5305\u542b\u4ee5\u4e0b\u5b57\u6bb5\uff1a</p> <p>\u25c6 app: nginx\u4f7f\u7528label\uff08\u6807\u7b7e\uff09\u6807\u8bb0Pod\u3002</p> <p>\u25c6 spec\uff1a\u8868\u793aPod\u8fd0\u884c\u4e00\u4e2a\u540d\u5b57\u4e3anginx\u7684\u5bb9\u5668\u3002</p> <p>\u25c6 image\uff1a\u8fd0\u884c\u6b64Pod\u4f7f\u7528\u7684\u955c\u50cf\u3002</p> <p>\u25c6 Port\uff1a\u5bb9\u5668\u7528\u4e8e\u53d1\u9001\u548c\u63a5\u6536\u6d41\u91cf\u7684\u7aef\u53e3\u3002</p> <p>\u4f7f\u7528kubectl create\u521b\u5efa\u6b64Deployment\uff1a</p> <pre><code>$ kubectl apply -f  dp-nginx.yml\ndeployment.apps/nginx-deployment created\n</code></pre> <p>\u4f7f\u7528kubectl get\u6216\u8005kubectl describe\u67e5\u770b\u6b64Deployment\u7684\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get deployment\nNAME               READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-deployment   3/3     3            3           2m45s\n</code></pre> <p>\u53ef\u4ee5\u4f7f\u7528rollout\u547d\u4ee4\u67e5\u770b\u6574\u4e2aDeployment\u521b\u5efa\u7684\u72b6\u6001\uff1a</p> <pre><code>$ kubectl rollout status deployment/nginx-deployment\ndeployment \"nginx-deployment\" successfully rolled out\n</code></pre> <p>\u5f53rollout\u7ed3\u675f\u65f6\uff0c\u518d\u6b21\u67e5\u770b\u6b64Deployment\uff0c\u53ef\u4ee5\u770b\u5230AVAILABLE\u7684\u6570\u91cf\u548cYAML\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684replicas\u76f8\u540c\uff1a</p> <pre><code>$ kubectl get deployment\nNAME               READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-deployment   3/3     3            3           2m45s\n</code></pre> <p>\u4e4b\u524d\u8bb2\u8fc7Deployment\u901a\u8fc7ReplicaSet\u7ba1\u7406Pod\uff0c\u53ef\u4ee5\u67e5\u770b\u6b64Deployment\u5f53\u524d\u5bf9\u5e94\u7684ReplicaSet\uff1a</p> <pre><code>$ kubectl get rs -l app=nginx\nNAME                          DESIRED   CURRENT   READY   AGE\nnginx-deployment-5d59d67564   3         3         3       4m44s\n\n$ kubectl get pod -l app=nginx\nNAME                                READY   STATUS    RESTARTS   AGE\nnginx-deployment-5d59d67564-qns4q   1/1     Running   0          6m2s\nnginx-deployment-5d59d67564-vqqb9   1/1     Running   0          6m2s\nnginx-deployment-5d59d67564-xsssg   1/1     Running   0          6m2s\n</code></pre> <p>Warning</p> <p>ReplicaSet\u7684\u547d\u540d\u683c\u5f0f\u4e3a[DEPLOYMENT-NAME]-[POD-TEMPLATE-HASH-VALUE]POD-TEMPLATE-HASH-VALUE\uff0c\u662f\u81ea\u52a8\u751f\u6210\u7684\uff0c\u4e0d\u7528\u624b\u52a8\u6307\u5b9a\u3002</p> <p>\u5982\u679cDeployment\u6709\u8fc7\u66f4\u65b0\uff0c\u5bf9\u5e94\u7684ReplicaSet\u53ef\u80fd\u4e0d\u6b62\u4e00\u4e2a\uff0c\u53ef\u4ee5\u901a\u8fc7<code>-o yaml</code>\u83b7\u53d6\u5f53\u524d\u5bf9\u5e94\u7684ReplicaSet\u662f\u54ea\u4e2a\uff0c\u5176\u4f59\u7684ReplicaSet\u4e3a\u4fdd\u7559\u7684\u5386\u53f2\u7248\u672c\uff0c\u7528\u4e8e\u56de\u6eda\u7b49\u64cd\u4f5c\u3002</p> <p>\u67e5\u770b\u6b64Deployment\u521b\u5efa\u7684Pod\uff0c\u53ef\u4ee5\u770b\u5230Pod\u7684hash\u503c5d59d67564\u548c\u4e0a\u8ff0Deployment\u5bf9\u5e94\u7684ReplicaSet\u7684hash\u503c\u4e00\u81f4\uff1a</p> <pre><code>$ kubectl get pods --show-labels\nNAME                                READY   STATUS    RESTARTS   AGE   LABELS\nnginx-deployment-5d59d67564-qns4q   1/1     Running   0          14m   app=nginx,pod-template-hash=5d59d67564\nnginx-deployment-5d59d67564-vqqb9   1/1     Running   0          14m   app=nginx,pod-template-hash=5d59d67564\nnginx-deployment-5d59d67564-xsssg   1/1     Running   0          14m   app=nginx,pod-template-hash=5d59d67564\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#22-\u66f4\u65b0deployment","title":"2.2 \u66f4\u65b0Deployment","text":"<p>\u901a\u8fc7Deployment\u90e8\u7f72\u5e94\u7528\u540e\uff0c\u7ecf\u5e38\u4f1a\u6709Deployment\u6587\u4ef6\u7684\u914d\u7f6e\u66f4\u6539\u6216\u8005\u955c\u50cf\u7248\u672c\u8fed\u4ee3\u7684\u9700\u6c42\uff0c\u66f4\u6539\u914d\u7f6e\u540e\u8be5Deployment\u4f1a\u521b\u5efa\u65b0\u7684ReplicaSet\uff0c\u4e4b\u540e\u4f1a\u5bf9\u7ba1\u7406\u7684Pod\u8fdb\u884c\u6eda\u52a8\u5347\u7ea7\u3002</p> <p>Warning</p> <p>\u5f53\u4e14\u4ec5\u5f53Deployment\u7684Pod\u6a21\u677f\uff08\u5373.spec.template\uff09\u66f4\u6539\u65f6\uff0c\u624d\u4f1a\u89e6\u53d1Deployment\u66f4\u65b0\uff0c\u4f8b\u5982\u66f4\u6539\u5185\u5b58\u3001CPU\u914d\u7f6e\u6216\u8005\u5bb9\u5668\u7684image\u3002</p> <p>\u5047\u5982\u66f4\u65b0Nginx Pod\u7684image\u4f7f\u7528nginx:1.9.1\uff0c\u5e76\u4f7f\u7528--record\u8bb0\u5f55\u5f53\u524d\u66f4\u6539\u7684\u53c2\u6570\uff0c\u540e\u671f\u56de\u6eda\u65f6\u53ef\u4ee5\u67e5\u770b\u5230\u5bf9\u5e94\u7684\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl set image deployment nginx-deployment nginx=nginx:1.9.1 --record\ndeployment.extensions/nginx-deployment image updated\n</code></pre> <p>\u5f53\u7136\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528edit\u547d\u4ee4\u76f4\u63a5\u7f16\u8f91Deployment\uff0c\u6548\u679c\u76f8\u540c\uff1a</p> <pre><code>$ kubectl edit deployment.v1.apps/nginx-deployment\ndeployment.apps/nginx-deployment edited\n</code></pre> <p>\u540c\u6837\uff0c\u53ef\u4ee5\u4f7f\u7528kubectl rollout status\u67e5\u770b\u66f4\u65b0\u8fc7\u7a0b\uff1a</p> <pre><code>$ kubectl rollout status deployment/nginx-deployment\nWaiting for deployment \"nginx-deployment\" rollout to finish: 1 out of 3 new replicas have been updated...\nWaiting for deployment \"nginx-deployment\" rollout to finish: 1 out of 3 new replicas have been updated...\nWaiting for deployment \"nginx-deployment\" rollout to finish: 1 out of 3 new replicas have been updated...\nWaiting for deployment \"nginx-deployment\" rollout to finish: 2 out of 3 new replicas have been updated...\nWaiting for deployment \"nginx-deployment\" rollout to finish: 2 out of 3 new replicas have been updated...\nWaiting for deployment \"nginx-deployment\" rollout to finish: 2 out of 3 new replicas have been updated...\nWaiting for deployment \"nginx-deployment\" rollout to finish: 1 old replicas are pending termination...\nWaiting for deployment \"nginx-deployment\" rollout to finish: 1 old replicas are pending termination...\ndeployment \"nginx-deployment\" successfully rolled out\n</code></pre> <p>\u53ef\u4ee5\u770b\u51fa\u66f4\u65b0\u8fc7\u7a0b\u4e3a\u65b0\u65e7\u4ea4\u66ff\u66f4\u65b0\uff0c\u9996\u5148\u65b0\u5efa\u4e00\u4e2aPod\uff0c\u5f53Pod\u72b6\u6001\u4e3aRunning\u65f6\uff0c\u5220\u9664\u4e00\u4e2a\u65e7\u7684Pod\uff0c\u540c\u65f6\u521b\u5efa\u4e00\u4e2a\u65b0\u7684Pod\u3002</p> <p>\u5f53\u89e6\u53d1\u4e00\u4e2a\u66f4\u65b0\u540e\uff0c\u4f1a\u6709\u65b0\u7684ReplicaSet\u4ea7\u751f\uff0c\u65e7\u7684ReplicaSet\u4f1a\u88ab\u4fdd\u5b58\uff0c\u67e5\u770b\u6b64\u65f6\u7684ReplicaSet\uff0c\u53ef\u4ee5\u4eceAGE\u6216READY\u770b\u51fa\u65b0\u65e7ReplicaSet\uff1a</p> <pre><code>$ kubectl get rs\nNAME                          DESIRED   CURRENT   READY   AGE\nnginx-deployment-5d59d67564   0         0         0       19m\nnginx-deployment-69c44dfb78   3         3         3       3m25s\n</code></pre> <p>\u901a\u8fc7describe\u67e5\u770bDeployment\u7684\u8be6\u7ec6\u4fe1\u606f</p> <pre><code>$ kubectl describe deployment nginx-deployment\nName:                   nginx-deployment\nNamespace:              default\nCreationTimestamp:      Wed, 14 Sep 2022 16:35:56 +0800\nLabels:                 app=nginx\nAnnotations:            deployment.kubernetes.io/revision: 2\nkubernetes.io/change-cause: kubectl set image deployment nginx-deployment nginx=nginx:1.9.1 --record=true\nSelector:               app=nginx\nReplicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable\n....\nEvents:\n  Type    Reason             Age    From                   Message\n  ----    ------             ----   ----                   -------\n  Normal  ScalingReplicaSet  24m    deployment-controller  Scaled up replica set nginx-deployment-5d59d67564 to 3\nNormal  ScalingReplicaSet  8m22s  deployment-controller  Scaled up replica set nginx-deployment-69c44dfb78 to 1\nNormal  ScalingReplicaSet  7m47s  deployment-controller  Scaled down replica set nginx-deployment-5d59d67564 to 2\nNormal  ScalingReplicaSet  7m46s  deployment-controller  Scaled up replica set nginx-deployment-69c44dfb78 to 2\nNormal  ScalingReplicaSet  7m14s  deployment-controller  Scaled down replica set nginx-deployment-5d59d67564 to 1\nNormal  ScalingReplicaSet  7m14s  deployment-controller  Scaled up replica set nginx-deployment-69c44dfb78 to 3\nNormal  ScalingReplicaSet  6m49s  deployment-controller  Scaled down replica set nginx-deployment-5d59d67564 to 0\n</code></pre> <p>\u5728describe\u4e2d\u53ef\u4ee5\u770b\u51fa\uff0c\u7b2c\u4e00\u6b21\u521b\u5efa\u65f6\uff0c\u5b83\u521b\u5efa\u4e86\u4e00\u4e2a\u540d\u4e3anginx-deployment-5d59d67564\uff0c\u5e76\u76f4\u63a5\u5c06\u5176\u6269\u5c55\u4e3a3\u4e2a\u526f\u672c\u3002 \u66f4\u65b0\u90e8\u7f72\u65f6 \uff0c\u5b83\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684ReplicaSet\uff0c\u547d\u540d\u4e3anginx-deployment-6987cdb55b\uff0c\u5e76\u5c06\u5176\u526f\u672c\u6570\u6269\u5c55\u4e3a1\uff0c\u7136\u540e\u5c06\u65e7\u7684ReplicaSet\u7f29\u5c0f\u4e3a2\uff0c\u8fd9\u6837\u81f3\u5c11\u53ef\u4ee5\u6709\u4e24\u4e2aPod\u53ef\u7528\uff0c\u6700\u591a\u521b\u5efa\u4e864\u4e2aPod\u3002</p> <p>\u4ee5\u6b64\u7c7b\u63a8\uff0c\u4f7f\u7528\u76f8\u540c\u7684\u6eda\u52a8\u66f4\u65b0\u7b56\u7565\u5411\u4e0a\u548c\u5411\u4e0b\u6269\u5c55\u65b0\u65e7ReplicaSet\uff0c\u6700\u7ec8\u65b0\u7684ReplicaSet\u53ef\u4ee5\u62e5\u67093\u4e2a\u526f\u672c\uff0c\u5e76\u5c06\u65e7\u7684ReplicaSet\u7f29\u5c0f\u4e3a0\u3002</p> <p>\u66f4\u65b0\u90e8\u7f72\u65f6\uff0c\u5b83\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684ReplicaSet\uff0c\u547d\u540d\u4e3anginx-deployment-69c44dfb78\uff0c\u5e76\u5c06\u5176\u526f\u672c\u6570\u6269\u5c55\u4e3a1\uff0c\u7136\u540e\u5c06\u65e7\u7684ReplicaSet\u7f29\u5c0f\u4e3a2\uff0c\u8fd9\u6837\u81f3\u5c11\u53ef\u4ee5\u6709\u4e24\u4e2aPod\u53ef\u7528\uff0c\u6700\u591a\u521b\u5efa\u4e864\u4e2aPod\u3002</p> <p>\u4ee5\u6b64\u7c7b\u63a8\uff0c\u4f7f\u7528\u76f8\u540c\u7684\u6eda\u52a8\u66f4\u65b0\u7b56\u7565\u5411\u4e0a\u548c\u5411\u4e0b\u6269\u5c55\u65b0\u65e7ReplicaSet\uff0c\u6700\u7ec8\u65b0\u7684ReplicaSet\u53ef\u4ee5\u62e5\u67093\u4e2a\u526f\u672c\uff0c\u5e76\u5c06\u65e7\u7684ReplicaSet\u7f29\u5c0f\u4e3a0\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#23-\u56de\u6edadeployment","title":"2.3 \u56de\u6edaDeployment","text":"<p>\u5f53\u66f4\u65b0\u7684\u7248\u672c\u4e0d\u7a33\u5b9a\u6216\u914d\u7f6e\u4e0d\u5408\u7406\u65f6\uff0c\u53ef\u4ee5\u5bf9\u5176\u8fdb\u884c\u56de\u6eda\u64cd\u4f5c\uff0c\u5047\u8bbe\u6211\u4eec\u53c8\u8fdb\u884c\u4e86\u51e0\u6b21\u66f4\u65b0(\u6b64\u5904\u4ee5\u66f4\u65b0\u955c\u50cf\u7248\u672c\u89e6\u53d1\u66f4\u65b0\uff0c\u66f4\u6539\u914d\u7f6e\u6548\u679c\u7c7b)\uff1a</p> <pre><code>$ kubectl set image deployment nginx-deployment nginx=dotbalo/canary:v1 --record\n$ kubectl set image deployment nginx-deployment nginx=dotbalo/canary:v2 --record\n</code></pre> <p>\u4f7f\u7528kubectl rollout history\u67e5\u770b\u66f4\u65b0\u5386\u53f2\uff1a</p> <pre><code>$ kubectl rollout history deployment/nginx-deployment\ndeployment.apps/nginx-deployment\nREVISION  CHANGE-CAUSE\n1         &lt;none&gt;\n2         kubectl set image deployment nginx-deployment nginx=nginx:1.9.1 --record=true\n3         kubectl set image deployment nginx-deployment nginx=dotbalo/canary:v1 --record=true\n4         kubectl set image deployment nginx-deployment nginx=dotbalo/canary:v2 --record=true\n</code></pre> <p>\u67e5\u770bDeployment\u67d0\u6b21\u66f4\u65b0\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u4f7f\u7528--revision\u6307\u5b9a\u67d0\u6b21\u66f4\u65b0\u7684\u7248\u672c\u53f7\uff1a</p> <pre><code>$ kubectl rollout history deployment/nginx-deployment --revision=3\ndeployment.apps/nginx-deployment with revision #3\nPod Template:\n  Labels:       app=nginx\n        pod-template-hash=666f99dd56\n  Annotations:  kubernetes.io/change-cause: kubectl set image deployment nginx-deployment nginx=dotbalo/canary:v1 --record=true\nContainers:\n   nginx:\n    Image:      dotbalo/canary:v1\n    Port:       80/TCP\n    Host Port:  0/TCP\n    Environment:        &lt;none&gt;\n    Mounts:     &lt;none&gt;\n  Volumes:      &lt;none&gt;\n</code></pre> <p>\u5982\u679c\u53ea\u9700\u8981\u56de\u6eda\u5230\u4e0a\u4e00\u4e2a\u7a33\u5b9a\u7248\u672c\uff0c\u4f7f\u7528kubectl rollout undo\u5373\u53ef\uff1a</p> <pre><code>$ kubectl rollout undo deployment/nginx-deployment\ndeployment.apps/nginx-deployment rolled back\n\n# \u518d\u6b21\u67e5\u770b\u66f4\u65b0\u5386\u53f2\uff0c\u53d1\u73b0REVISION5\u56de\u5230\u4e86canary:v1\uff1a\n$ kubectl rollout history deployment/nginx-deployment\ndeployment.apps/nginx-deployment\nREVISION  CHANGE-CAUSE\n1         &lt;none&gt;\n2         kubectl set image deployment nginx-deployment nginx=nginx:1.9.1 --record=true\n4         kubectl set image deployment nginx-deployment nginx=dotbalo/canary:v2 --record=true\n5         kubectl set image deployment nginx-deployment nginx=dotbalo/canary:v1 --record=true\n</code></pre> <p>\u5982\u679c\u8981\u56de\u6eda\u5230\u6307\u5b9a\u7248\u672c\uff0c\u4f7f\u7528--to-revision\u53c2\u6570\uff1a</p> <pre><code>$ kubectl rollout undo deployment/nginx-deployment --to-revision=2\ndeployment.extensions/nginx-deployment\n\n$ kubectl rollout history deployment/nginx-deployment\ndeployment.apps/nginx-deployment\nREVISION  CHANGE-CAUSE\n1         &lt;none&gt;\n4         kubectl set image deployment nginx-deployment nginx=dotbalo/canary:v2 --record=true\n5         kubectl set image deployment nginx-deployment nginx=dotbalo/canary:v1 --record=true\n6         kubectl set image deployment nginx-deployment nginx=nginx:1.9.1 --record=true\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#24-\u6269\u5bb9deployment","title":"2.4 \u6269\u5bb9Deployment","text":"<p>\u5f53\u516c\u53f8\u8bbf\u95ee\u91cf\u53d8\u5927\uff0c\u6216\u8005\u6709\u9884\u671f\u5185\u7684\u6d3b\u52a8\u65f6\uff0c3\u4e2aPod\u53ef\u80fd\u5df2\u65e0\u6cd5\u652f\u6491\u4e1a\u52a1\u65f6\uff0c\u53ef\u4ee5\u63d0\u524d\u5bf9\u5176\u8fdb\u884c\u6269\u5c55\u3002</p> <p>\u4f7f\u7528kubectl scale\u52a8\u6001\u8c03\u6574Pod\u7684\u526f\u672c\u6570\uff0c\u6bd4\u5982\u589e\u52a0Pod\u4e3a5\u4e2a\uff1a</p> <pre><code>$ kubectl scale deployment.v1.apps/nginx-deployment --replicas=5\ndeployment.apps/nginx-deployment scaled\n\n$ kubectl rollout status deployment/nginx-deployment\nWaiting for deployment \"nginx-deployment\" rollout to finish: 3 of 5 updated replicas are available...\nWaiting for deployment \"nginx-deployment\" rollout to finish: 4 of 5 updated replicas are available...\ndeployment \"nginx-deployment\" successfully rolled out\n</code></pre> <p>\u67e5\u770bPod\uff0c\u6b64\u65f6Pod\u5df2\u7ecf\u53d8\u6210\u4e865\u4e2a\uff1a</p> <pre><code>$ kubectl get pod\nNAME                                READY   STATUS    RESTARTS   AGE\nnginx-deployment-69c44dfb78-cqdd7   1/1     Running   0          50s\nnginx-deployment-69c44dfb78-lnx2s   1/1     Running   0          2m44s\nnginx-deployment-69c44dfb78-qz6gw   1/1     Running   0          2m40s\nnginx-deployment-69c44dfb78-tltjh   1/1     Running   0          2m42s\nnginx-deployment-69c44dfb78-xgwk6   1/1     Running   0          50s\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#25-\u6682\u505c\u548c\u6062\u590ddeployment\u66f4\u65b0","title":"2.5 \u6682\u505c\u548c\u6062\u590dDeployment\u66f4\u65b0","text":"<p>\u4e0a\u8ff0\u6f14\u793a\u7684\u5747\u4e3a\u66f4\u6539\u67d0\u4e00\u5904\u7684\u914d\u7f6e\uff0c\u66f4\u6539\u540e\u7acb\u5373\u89e6\u53d1\u66f4\u65b0\uff0c\u5927\u591a\u6570\u60c5\u51b5\u4e0b\u53ef\u80fd\u9700\u8981\u9488\u5bf9\u4e00\u4e2a\u8d44\u6e90\u6587\u4ef6\u66f4\u6539\u591a\u5904\u5730\u65b9\uff0c\u800c\u5e76\u4e0d\u9700\u8981\u591a\u6b21\u89e6\u53d1\u66f4\u65b0\uff0c \u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528Deployment\u6682\u505c\u529f\u80fd\uff0c\u4e34\u65f6\u7981\u7528\u66f4\u65b0\u64cd\u4f5c\uff0c\u5bf9Deployment\u8fdb\u884c\u591a\u6b21\u4fee\u6539\u540e\u518d\u8fdb\u884c\u66f4\u65b0\u3002</p> <p>\u4f7f\u7528kubectl rollout pause\u547d\u4ee4\u5373\u53ef\u6682\u505cDeployment\u66f4\u65b0\uff1a</p> <pre><code>$ kubectl rollout pause deployment/nginx-deployment\ndeployment.apps/nginx-deployment paused\n</code></pre> <p>\u7136\u540e\u5bf9Deployment\u8fdb\u884c\u76f8\u5173\u66f4\u65b0\u64cd\u4f5c\uff0c\u6bd4\u5982\u5148\u66f4\u65b0\u955c\u50cf\uff0c\u7136\u540e\u5bf9\u5176\u8d44\u6e90\u8fdb\u884c\u9650\u5236\uff08\u5982\u679c\u4f7f\u7528\u7684\u662fkubectl edit\u547d\u4ee4\uff0c\u53ef\u4ee5\u76f4\u63a5\u8fdb\u884c\u591a\u6b21\u4fee\u6539\uff0c\u65e0\u987b\u6682\u505c\u66f4\u65b0\uff0ckubectl set\u547d\u4ee4\u4e00\u822c\u4f1a\u96c6\u6210\u5728CICD\u6d41\u6c34\u7ebf\u4e2d\uff09\uff1a</p> <pre><code>$ kubectl set image deployment.v1.apps/nginx-deployment nginx=nginx:1.9.1\n\n$ kubectl set resources deployment.v1.apps/nginx-deployment -c=nginx --limits=cpu=200m,memory=512Mi\ndeployment.apps/nginx-deployment resource requirements updated\n</code></pre> <p>\u8fdb\u884c\u5b8c\u6700\u540e\u4e00\u5904\u914d\u7f6e\u66f4\u6539\u540e\uff0c\u4f7f\u7528kubectl rollout resume\u6062\u590dDeployment\u66f4\u65b0\uff1a</p> <pre><code>$ kubectl rollout resume deployment.v1.apps/nginx-deployment\ndeployment.apps/nginx-deployment resumed\n</code></pre> <p>\u53ef\u4ee5\u67e5\u770b\u5230\u6062\u590d\u66f4\u65b0\u7684Deployment\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684ReplicaSet\uff1a</p> <pre><code>$ kubectl get rs\nNAME                          DESIRED   CURRENT   READY   AGE\nnginx-deployment-5d59d67564   0         0         0       73m\nnginx-deployment-666f99dd56   0         0         0       36m\nnginx-deployment-69c44dfb78   0         0         0       58m\nnginx-deployment-79d4d8c7d5   0         0         0       35m\nnginx-deployment-f7fdb4ccd    5         5         4       113s\n</code></pre> <p>\u53ef\u4ee5\u67e5\u770b\u5230Deployment\u7684image\uff08\u955c\u50cf\uff09\u5df2\u7ecf\u53d8\u4e3anginx:1.9.1\uff1a</p> <pre><code>$ kubectl describe deploy nginx-deployment\nName:                   nginx-deployment\nNamespace:              default\n......\nRollingUpdateStrategy:  25% max unavailable, 25% max surge\nPod Template:\n  Labels:  app=nginx\n  Containers:\n   nginx:\n    Image:      nginx:1.9.1\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#26-\u66f4\u65b0deployment\u7684\u6ce8\u610f\u4e8b\u9879","title":"2.6 \u66f4\u65b0Deployment\u7684\u6ce8\u610f\u4e8b\u9879","text":"<p>\u5386\u53f2\u7248\u672c\u6e05\u7406\u7b56\u7565\uff1a</p> <p>\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0crevision\u4fdd\u755910\u4e2a\u65e7\u7684ReplicaSet\uff0c\u5176\u4f59\u7684\u5c06\u5728\u540e\u53f0\u8fdb\u884c\u5783\u573e\u56de\u6536\uff0c\u53ef\u4ee5\u5728.spec.revisionHistoryLimit\u8bbe\u7f6e\u4fdd\u7559ReplicaSet\u7684\u4e2a\u6570\u3002\u5f53\u8bbe\u7f6e\u4e3a0\u65f6\uff0c\u4e0d\u4fdd\u7559\u5386\u53f2\u8bb0\u5f55\u3002</p> <p>\u66f4\u65b0\u7b56\u7565\uff1a</p> <ul> <li>.spec.strategy.type==Recreate\uff1a\u8868\u793a\u91cd\u5efa\uff0c\u5148\u5220\u6389\u65e7\u7684Pod\uff0c\u518d\u521b\u5efa\u65b0\u7684Pod\u3002</li> <li> <p>.spec.strategy.type==RollingUpdate\uff1a\u8868\u793a\u6eda\u52a8\u66f4\u65b0\uff0c\u53ef\u4ee5\u6307\u5b9amaxUnavailable\u548cmaxSurge\u6765\u63a7\u5236\u6eda\u52a8\u66f4\u65b0\u8fc7\u7a0b\u3002</p> <ul> <li> <p>.spec.strategy.rollingUpdate.maxUnavailable\uff1a\u6307\u5b9a\u5728\u56de\u6eda\u66f4\u65b0\u65f6\u6700\u5927\u4e0d\u53ef\u7528\u7684Pod\u6570\u91cf\uff0c\u53ef\u9009\u5b57\u6bb5\uff0c\u9ed8\u8ba4\u4e3a25%\uff0c\u53ef\u4ee5\u8bbe\u7f6e\u4e3a\u6570\u5b57\u6216\u767e\u5206\u6bd4\uff0c\u5982\u679cmaxSurge\u4e3a0\uff0c\u5219\u8be5\u503c\u4e0d\u80fd\u4e3a0\u3002</p> </li> <li> <p>.spec.strategy.rollingUpdate.maxSurge\uff1a\u53ef\u4ee5\u8d85\u8fc7\u671f\u671b\u503c\u7684\u6700\u5927Pod\u6570\uff0c\u53ef\u9009\u5b57\u6bb5\uff0c\u9ed8\u8ba4\u4e3a25%\uff0c\u53ef\u4ee5\u8bbe\u7f6e\u6210\u6570\u5b57\u6216\u767e\u5206\u6bd4\uff0c\u5982\u679cmaxUnavailable\u4e3a0\uff0c\u5219\u8be5\u503c\u4e0d\u80fd\u4e3a0\u3002</p> </li> </ul> </li> </ul> <p>Ready\u7b56\u7565\uff1a</p> <ul> <li>.spec.minReadySeconds\u662f\u53ef\u9009\u53c2\u6570\uff0c\u6307\u5b9a\u65b0\u521b\u5efa\u7684Pod\u5e94\u8be5\u5728\u6ca1\u6709\u4efb\u4f55\u5bb9\u5668\u5d29\u6e83\u7684\u60c5\u51b5\u4e0b\u89c6\u4e3aReady\uff08\u5c31\u7eea\uff09\u72b6\u6001\u7684\u6700\u5c0f\u79d2\u6570\uff0c\u9ed8\u8ba4\u4e3a0\uff0c\u5373\u4e00\u65e6\u88ab\u521b\u5efa\u5c31\u89c6\u4e3a\u53ef\u7528\uff0c\u901a\u5e38\u548c\u5bb9\u5668\u63a2\u9488\u8fde\u7528\u3002</li> </ul>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#3\u6709\u72b6\u6001\u5e94\u7528\u7ba1\u7406statefulset","title":"3.\u6709\u72b6\u6001\u5e94\u7528\u7ba1\u7406StatefulSet","text":"<p>StatefulSet\uff08\u6709\u72b6\u6001\u96c6\uff0c\u7f29\u5199\u4e3asts\uff09\u5e38\u7528\u4e8e\u90e8\u7f72\u6709\u72b6\u6001\u7684\u4e14\u9700\u8981\u6709\u5e8f\u542f\u52a8\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u6bd4\u5982\u5728\u8fdb\u884cSpring Cloud\u9879\u76ee\u5bb9\u5668\u5316\u65f6\uff0c Eureka\u7684\u90e8\u7f72\u662f\u6bd4\u8f83\u9002\u5408\u7528StatefulSet\u90e8\u7f72\u65b9\u5f0f\u7684\uff0c\u53ef\u4ee5\u7ed9\u6bcf\u4e2aEureka\u5b9e\u4f8b\u521b\u5efa\u4e00\u4e2a\u552f\u4e00\u4e14\u56fa\u5b9a\u7684\u6807\u8bc6\u7b26\uff0c\u5e76\u4e14\u6bcf\u4e2aEureka\u5b9e\u4f8b\u65e0\u987b\u914d\u7f6e\u591a\u4f59\u7684Service\uff0c \u5176\u4f59Spring Boot\u5e94\u7528\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7Eureka\u7684Headless Service\u8fdb\u884c\u6ce8\u518c\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#31-statefulset\u7684\u57fa\u672c\u6982\u5ff5","title":"3.1 StatefulSet\u7684\u57fa\u672c\u6982\u5ff5","text":"<p>StatefulSet\u4e3b\u8981\u7528\u4e8e\u7ba1\u7406\u6709\u72b6\u6001\u5e94\u7528\u7a0b\u5e8f\u7684\u5de5\u4f5c\u8d1f\u8f7dAPI\u5bf9\u8c61\u3002</p> <p>\u6bd4\u5982\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u53ef\u4ee5\u90e8\u7f72ElasticSearch\u96c6\u7fa4\u3001MongoDB\u96c6\u7fa4\u6216\u8005\u9700\u8981\u6301\u4e45\u5316\u7684RabbitMQ\u96c6\u7fa4\u3001Redis\u96c6\u7fa4\u3001Kafka\u96c6\u7fa4\u548cZooKeeper\u96c6\u7fa4\u7b49\u3002</p> <p>\u548cDeployment\u7c7b\u4f3c\uff0c\u4e00\u4e2aStatefulSet\u4e5f\u540c\u6837\u7ba1\u7406\u7740\u57fa\u4e8e\u76f8\u540c\u5bb9\u5668\u89c4\u8303\u7684Pod\u3002\u4e0d\u540c\u7684\u662f\uff0cStatefulSet\u4e3a\u6bcf\u4e2aPod\u7ef4\u62a4\u4e86\u4e00\u4e2a\u9ecf\u6027\u6807\u8bc6\u3002</p> <p>\u8fd9\u4e9bPod\u662f\u6839\u636e\u76f8\u540c\u7684\u89c4\u8303\u521b\u5efa\u7684\uff0c\u4f46\u662f\u4e0d\u53ef\u4e92\u6362\uff0c\u6bcf\u4e2aPod\u90fd\u6709\u4e00\u4e2a\u6301\u4e45\u7684\u6807\u8bc6\u7b26\uff0c\u5728\u91cd\u65b0\u8c03\u5ea6\u65f6\u4e5f\u4f1a\u4fdd\u7559\uff0c\u4e00\u822c\u683c\u5f0f\u4e3aStatefulSetName-Number\u3002 \u6bd4\u5982\u5b9a\u4e49\u4e00\u4e2a\u540d\u5b57\u662fRedis-Sentinel\u7684StatefulSet\uff0c\u6307\u5b9a\u521b\u5efa3\u4e2aPod\uff0c\u90a3\u4e48\u521b\u5efa\u51fa\u6765\u7684Pod\u540d\u5b57\u5c31\u4e3aRedis-Sentinel-0\u3001Redis-Sentinel-1\u3001Redis-Sentinel-2\u3002 \u800cStatefulSet\u521b\u5efa\u7684Pod\u4e00\u822c\u4f7f\u7528Headless Service\uff08\u65e0\u5934\u670d\u52a1\uff09\u8fdb\u884c\u901a\u4fe1\uff0c\u548c\u666e\u901a\u7684Service\u7684\u533a\u522b\u5728\u4e8eHeadless Service\u6ca1\u6709ClusterIP\uff0c\u5b83\u4f7f\u7528Endpoint\u8fdb\u884c\u4e92\u76f8\u901a\u4fe1\uff0cHeadless\u4e00\u822c\u7684\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>statefulSetName-{0..N-1}.serviceName.namespace.svc.cluster.local\n</code></pre> <p>\u914d\u7f6e\u8bf4\u660e\uff1a</p> <ul> <li>serviceName\u4e3aHeadless Service\u7684\u540d\u5b57\uff0c\u521b\u5efaStatefulSet\u65f6\u5fc5\u987b\u6307\u5b9aHeadless Service\u540d\u79f0\u3002</li> <li>0..N\u20121\u4e3aPod\u6240\u5728\u7684\u5e8f\u53f7\uff0c\u4ece0\u5f00\u59cb\u5230N\u20121\u3002</li> <li>statefulSetName\u4e3aStatefulSet\u7684\u540d\u5b57\u3002</li> <li>namespace\u4e3a\u670d\u52a1\u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4\u3002</li> <li>.cluster.local\u4e3aCluster Domain\uff08\u96c6\u7fa4\u57df\uff09\u3002</li> </ul> <p>\u5047\u5982\u516c\u53f8\u67d0\u4e2a\u9879\u76ee\u9700\u8981\u5728Kubernetes\u4e2d\u90e8\u7f72\u4e00\u4e2a\u4e3b\u4ece\u6a21\u5f0f\u7684Redis\uff0c\u6b64\u65f6\u4f7f\u7528StatefulSet\u90e8\u7f72\u5c31\u6781\u4e3a\u5408\u9002\uff0c\u56e0\u4e3aStatefulSet\u542f\u52a8\u65f6\uff0c\u53ea\u6709\u5f53\u524d\u4e00\u4e2a\u5bb9\u5668\u5b8c\u5168\u542f\u52a8\u65f6\uff0c\u540e\u4e00\u4e2a\u5bb9\u5668\u624d\u4f1a\u88ab\u8c03\u5ea6\uff0c\u5e76\u4e14\u6bcf\u4e2a\u5bb9\u5668\u7684\u6807\u8bc6\u7b26\u662f\u56fa\u5b9a\u7684\uff0c \u90a3\u4e48\u5c31\u53ef\u4ee5\u901a\u8fc7\u6807\u8bc6\u7b26\u6765\u65ad\u5b9a\u5f53\u524dPod\u7684\u89d2\u8272\u3002</p> <p>\u6bd4\u5982\u7528\u4e00\u4e2a\u540d\u4e3aredis-ms\u7684StatefulSet\u90e8\u7f72\u4e3b\u4ece\u67b6\u6784\u7684Redis\uff0c\u7b2c\u4e00\u4e2a\u5bb9\u5668\u542f\u52a8\u65f6\uff0c\u5b83\u7684\u6807\u8bc6\u7b26\u4e3aredis-ms-0\uff0c\u5e76\u4e14Pod\u5185\u4e3b\u673a\u540d\u4e5f\u4e3aredis-ms-0\uff0c\u6b64\u65f6\u5c31\u53ef\u4ee5\u6839\u636e\u4e3b\u673a\u540d\u6765\u5224\u65ad\uff0c \u5f53\u4e3b\u673a\u540d\u4e3aredis-ms-0\u7684\u5bb9\u5668\u4f5c\u4e3aRedis\u7684\u4e3b\u8282\u70b9\uff0c\u5176\u4f59\u4e3a\u4ece\u8282\u70b9\uff0c\u90a3\u4e48Slave\u8fde\u63a5Master\u4e3b\u673a\u914d\u7f6e\u5c31\u53ef\u4ee5\u4f7f\u7528\u4e0d\u4f1a\u66f4\u6539\u7684Master\u7684Headless Service\uff0c\u6b64\u65f6Redis\u4ece\u8282\u70b9\uff08Slave\uff09\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\uff1a</p> <pre><code> port 6379\n slaveof redis-ms-0.redis-ms.public-service.svc.cluster.local 6379\n tcp-backlog 511\n timeout 0\n tcp-keepalive 0\n ...\n</code></pre> <p>\u5176\u4e2dredis-ms-0.redis-ms.public-service.svc.cluster.local\u662fRedis Master\u7684Headless Service\uff0c\u5728\u540c\u4e00\u547d\u540d\u7a7a\u95f4\u4e0b\u53ea\u9700\u8981\u5199redis-ms-0.redis-ms\u5373\u53ef\uff0c\u540e\u9762\u7684public-service.svc.cluster.local\u53ef\u4ee5\u7701\u7565\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#32-statefulset\u7684\u6ce8\u610f\u4e8b\u9879","title":"3.2 StatefulSet\u7684\u6ce8\u610f\u4e8b\u9879","text":"<p>\u4e00\u822cStatefulSet\u7528\u4e8e\u6709\u4ee5\u4e0b\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u9700\u6c42\u7684\u5e94\u7528\u7a0b\u5e8f\uff1a</p> <ul> <li>\u9700\u8981\u7a33\u5b9a\u7684\u72ec\u4e00\u65e0\u4e8c\u7684\u7f51\u7edc\u6807\u8bc6\u7b26\u3002</li> <li>\u9700\u8981\u6301\u4e45\u5316\u6570\u636e\u3002</li> <li>\u9700\u8981\u6709\u5e8f\u7684\u3001\u4f18\u96c5\u7684\u90e8\u7f72\u548c\u6269\u5c55\u3002</li> <li>\u9700\u8981\u6709\u5e8f\u7684\u81ea\u52a8\u6eda\u52a8\u66f4\u65b0\u3002</li> </ul> <p>\u5982\u679c\u5e94\u7528\u7a0b\u5e8f\u4e0d\u9700\u8981\u4efb\u4f55\u7a33\u5b9a\u7684\u6807\u8bc6\u7b26\u6216\u8005\u6709\u5e8f\u7684\u90e8\u7f72\u3001\u5220\u9664\u6216\u8005\u6269\u5c55\uff0c\u5e94\u8be5\u4f7f\u7528\u65e0\u72b6\u6001\u7684\u63a7\u5236\u5668\u90e8\u7f72\u5e94\u7528\u7a0b\u5e8f\uff0c\u6bd4\u5982Deployment\u6216\u8005ReplicaSet\u3002StatefulSet\u662fKubernetes 1.9\u7248\u672c\u4e4b\u524d\u7684beta\u8d44\u6e90\uff0c\u57281.5\u7248\u672c\u4e4b\u524d\u7684\u4efb\u4f55Kubernetes\u7248\u672c\u90fd\u6ca1\u6709\u3002</p> <p>Pod\u6240\u7528\u7684\u5b58\u50a8\u5fc5\u987b\u7531PersistentVolume Provisioner\uff08\u6301\u4e45\u5316\u5377\u914d\u7f6e\u5668\uff09\u6839\u636e\u8bf7\u6c42\u914d\u7f6eStorageClass\uff0c\u6216\u8005\u7531\u7ba1\u7406\u5458\u9884\u5148\u914d\u7f6e\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u4e0d\u914d\u7f6e\u5b58\u50a8\u3002</p> <p>\u4e3a\u4e86\u786e\u4fdd\u6570\u636e\u5b89\u5168\uff0c\u5220\u9664\u548c\u7f29\u653eStatefulSet\u4e0d\u4f1a\u5220\u9664\u4e0eStatefulSet\u5173\u8054\u7684\u5377\uff0c\u53ef\u4ee5\u624b\u52a8\u9009\u62e9\u6027\u5730\u5220\u9664PVC\u548cPV\u3002</p> <p>StatefulSet\u76ee\u524d\u4f7f\u7528Headless Service\uff08\u65e0\u5934\u670d\u52a1\uff09\u8d1f\u8d23Pod\u7684\u7f51\u7edc\u8eab\u4efd\u548c\u901a\u4fe1\uff0c\u9700\u8981\u63d0\u524d\u521b\u5efa\u6b64\u670d\u52a1\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#33-\u5b9a\u4e49\u4e00\u4e2astatefulset\u8d44\u6e90\u6587\u4ef6","title":"3.3 \u5b9a\u4e49\u4e00\u4e2aStatefulSet\u8d44\u6e90\u6587\u4ef6","text":"<p>\u5b9a\u4e49\u4e00\u4e2a\u7b80\u5355\u7684StatefulSet\u7684\u793a\u4f8b\u5982\u4e0b\uff1a</p> <p>sts-web.yml</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\nname: nginx\nlabels:\napp: nginx\nspec:\nports:\n- port: 80\nname: web\nclusterIP: None\nselector:\napp: nginx\n---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\nname: web\nspec:\nserviceName: \"nginx\"\nreplicas: 2\nselector:\nmatchLabels:\napp: nginx\ntemplate:\nmetadata:\nlabels:\napp: nginx\nspec:\ncontainers:\n- name: nginx\nimage: nginx\nports:\n- containerPort: 80\nname: web\n</code></pre> <p>Warning</p> <p>\u6b64\u793a\u4f8b\u6ca1\u6709\u6dfb\u52a0\u5b58\u50a8\u914d\u7f6e\uff0c\u540e\u9762\u7684\u7ae0\u8282\u4f1a\u5355\u72ec\u8bb2\u89e3\u5b58\u50a8\u76f8\u5173\u7684\u77e5\u8bc6\u70b9\u3002</p> <p>\u5176\u4e2d\uff1a</p> <ul> <li>kind: Service\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u5b57\u4e3aNginx\u7684Headless Service\uff0c\u521b\u5efa\u7684Service\u683c\u5f0f\u4e3anginx-0.nginx.default.svc.cluster.local\uff0c\u5176\u4ed6\u7684\u7c7b\u4f3c\uff0c\u56e0\u4e3a\u6ca1\u6709\u6307\u5b9aNamespace\uff08\u547d\u540d\u7a7a\u95f4\uff09\uff0c\u6240\u4ee5\u9ed8\u8ba4\u90e8\u7f72\u5728default\u3002</li> <li>kind: StatefulSet\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u5b57\u4e3aweb\u7684StatefulSet\uff0creplicas\u8868\u793a\u90e8\u7f72Pod\u7684\u526f\u672c\u6570\uff0c\u672c\u5b9e\u4f8b\u4e3a2\u3002</li> </ul> <p>\u5728StatefulSet\u4e2d\u5fc5\u987b\u8bbe\u7f6ePod\u9009\u62e9\u5668\uff08.spec.selector\uff09\u7528\u6765\u5339\u914d\u5176\u6807\u7b7e\uff08.spec.template.metadata.labels\uff09\u3002 \u57281.8\u7248\u672c\u4e4b\u524d\uff0c\u5982\u679c\u672a\u914d\u7f6e\u8be5\u5b57\u6bb5\uff08.spec.selector\uff09\uff0c\u5c06\u88ab\u8bbe\u7f6e\u4e3a\u9ed8\u8ba4\u503c\uff0c\u57281.8\u7248\u672c\u4e4b\u540e\uff0c\u5982\u679c\u672a\u6307\u5b9a\u5339\u914dPod Selector\uff0c\u5219\u4f1a\u5bfc\u81f4StatefulSet\u521b\u5efa\u9519\u8bef\u3002</p> <p>\u5f53StatefulSet\u63a7\u5236\u5668\u521b\u5efaPod\u65f6\uff0c\u5b83\u4f1a\u6dfb\u52a0\u4e00\u4e2a\u6807\u7b7estatefulset.kubernetes.io/pod-name\uff0c\u8be5\u6807\u7b7e\u7684\u503c\u4e3aPod\u7684\u540d\u79f0\uff0c\u7528\u4e8e\u5339\u914dService\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#34-\u521b\u5efastatefulset","title":"3.4 \u521b\u5efaStatefulSet","text":"<p>\u521b\u5efaStatefulSet\uff1a</p> <pre><code>$ kubectl create -f sts-web.yml\nservice/nginx created\nstatefulset.apps/web created\n\n$ kubectl get sts\nNAME   READY   AGE\nweb    2/2     41s\n\n$ kubectl get svc\nNAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\nkubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   142d\nnginx        ClusterIP   None         &lt;none&gt;        80/TCP    67s\n\n$ kubectl get pod -l app=nginx\nNAME    READY   STATUS    RESTARTS   AGE\nweb-0   1/1     Running   0          6m57s\nweb-1   1/1     Running   0          6m36s\n</code></pre> <p>\u6b64\u65f6\u4f7f\u7528StatefulSet\u90e8\u7f72\u4e86\u4e24\u4e2aPod\uff0c\u5206\u522b\u4e3aweb-0\u3001web-1\uff0c\u540c\u65f6\u4e5f\u521b\u5efa\u4e00\u4e2aCLUSTER-IP\u4e3aNone\u7684Headless Service\uff0c</p> <p>\u5728\u540c\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u5185\u4f7f\u7528web-0.nginx\u548cweb-1.nginx\u5373\u53ef\u8bbf\u95ee\u8fd9\u4e24\u4e2aPod\uff0c</p> <p>\u8de8\u547d\u540d\u7a7a\u95f4\u53ef\u4ee5\u4f7f\u7528web-0.nginx.default\u8bbf\u95ee\uff08\u8de8\u547d\u540d\u7a7a\u95f4\u8bbf\u95ee\u8d44\u6e90\u7684\u60c5\u51b5\u5f88\u5c11\uff0c\u5e94\u5f53\u5c3d\u91cf\u89c4\u907f\uff09\u3002</p> <p>\u5411Headless Service\u5bf9\u8c61\u8bf7\u6c42\u670d\u52a1</p> <pre><code>$ kubectl run cirros-$RANDOM --rm -it --image=cirros -- sh\nIf you don't see a command prompt, try pressing enter.\n/ # / # curl web-0.nginx\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n......\n&lt;/body&gt;\n&lt;/html&gt;\n\n/ # curl web-1.nginx\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n......\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#35-statefulset\u521b\u5efapod\u7684\u6d41\u7a0b","title":"3.5 StatefulSet\u521b\u5efaPod\u7684\u6d41\u7a0b","text":"<p>StatefulSet\u7ba1\u7406\u7684Pod\u90e8\u7f72\u548c\u6269\u5c55\u89c4\u5219\u5982\u4e0b\uff1a</p> <ul> <li>\u5bf9\u4e8e\u5177\u6709N\u4e2a\u526f\u672c\u7684StatefulSet\uff0c\u5c06\u6309\u987a\u5e8f\u4ece0\u5230N\u20121\u5f00\u59cb\u521b\u5efaPod\u3002</li> <li>\u5f53\u5220\u9664Pod\u65f6\uff0c\u5c06\u6309\u7167N\u20121\u52300\u7684\u53cd\u987a\u5e8f\u7ec8\u6b62\u3002</li> <li>\u5728\u7f29\u653ePod\u4e4b\u524d\uff0c\u5fc5\u987b\u4fdd\u8bc1\u5f53\u524d\u7684Pod\u662fRunning\uff08\u8fd0\u884c\u4e2d\uff09\u6216\u8005Ready\uff08\u5c31\u7eea\uff09\u3002</li> <li>\u5728\u7ec8\u6b62Pod\u4e4b\u524d\uff0c\u5b83\u6240\u6709\u7684\u7ee7\u4efb\u8005\u5fc5\u987b\u662f\u5b8c\u5168\u5173\u95ed\u72b6\u6001\u3002</li> </ul> <p>StatefulSet\u7684pod.Spec.TerminationGracePeriodSeconds\uff08\u7ec8\u6b62Pod\u7684\u7b49\u5f85\u65f6\u95f4\uff09\u4e0d\u5e94\u8be5\u6307\u5b9a\u4e3a0\uff0c \u8bbe\u7f6e\u4e3a0\u5bf9StatefulSet\u7684Pod\u662f\u6781\u5176\u4e0d\u5b89\u5168\u7684\u505a\u6cd5\uff0c\u4f18\u96c5\u5730\u5220\u9664StatefulSet\u7684Pod\u662f\u975e\u5e38\u6709\u5fc5\u8981\u7684\uff0c\u800c\u4e14\u662f\u5b89\u5168\u7684\uff0c\u56e0\u4e3a\u5b83\u53ef\u4ee5\u786e\u4fdd\u5728Kubelet\u4eceAPIServer\u5220\u9664\u4e4b\u524d\uff0c\u8ba9Pod\u6b63\u5e38\u5173\u95ed\u3002</p> <p>\u5f53\u521b\u5efa\u4e0a\u9762\u7684Nginx\u5b9e\u4f8b\u65f6\uff0cPod\u5c06\u6309web-0\u3001web-1\u3001web-2\u7684\u987a\u5e8f\u90e8\u7f723\u4e2aPod\u3002</p> <p>\u5728web-0\u5904\u4e8eRunning\u6216\u8005Ready\u4e4b\u524d\uff0cweb-1\u4e0d\u4f1a\u88ab\u90e8\u7f72\uff0c\u76f8\u540c\u7684\uff0cweb-2\u5728web-1\u672a\u5904\u4e8eRunning\u548cReady\u4e4b\u524d\u4e5f\u4e0d\u4f1a\u88ab\u90e8\u7f72\u3002</p> <p>\u5982\u679c\u5728web-1\u5904\u4e8eRunning\u548cReady\u72b6\u6001\u65f6\uff0cweb-0\u53d8\u6210Failed\uff08\u5931\u8d25\uff09\u72b6\u6001\uff0c\u90a3\u4e48web-2\u5c06\u4e0d\u4f1a\u88ab\u542f\u52a8\uff0c\u76f4\u5230web-0\u6062\u590d\u4e3aRunning\u548cReady\u72b6\u6001\u3002</p> <p>\u5982\u679c\u7528\u6237\u5c06StatefulSet\u7684replicas\u8bbe\u7f6e\u4e3a1\uff0c\u90a3\u4e48web-2\u5c06\u9996\u5148\u88ab\u7ec8\u6b62\uff0c\u5728\u5b8c\u5168\u5173\u95ed\u5e76\u5220\u9664web-2\u4e4b\u524d\uff0c\u4e0d\u4f1a\u5220\u9664web-1\u3002</p> <p>\u5982\u679cweb-2\u7ec8\u6b62\u5e76\u4e14\u5b8c\u5168\u5173\u95ed\u540e\uff0cweb-0\u7a81\u7136\u5931\u8d25\uff0c\u90a3\u4e48\u5728web-0\u672a\u6062\u590d\u6210Running\u6216\u8005Ready\u65f6\uff0cweb-1\u4e0d\u4f1a\u88ab\u5220\u9664\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#36-statefulset\u6269\u5bb9\u548c\u7f29\u5bb9","title":"3.6 StatefulSet\u6269\u5bb9\u548c\u7f29\u5bb9","text":"<p>\u548cDeployment\u7c7b\u4f3c\uff0c\u53ef\u4ee5\u901a\u8fc7\u66f4\u65b0replicas\u5b57\u6bb5\u6269\u5bb9/\u7f29\u5bb9StatefulSet\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528kubectl scale\u3001kubectl edit\u548ckubectl patch\u6765\u6269\u5bb9/\u7f29\u5bb9\u4e00\u4e2aStatefulSet\u3002</p> <p>\uff081\uff09\u6269\u5bb9</p> <p>\u5c06\u4e0a\u8ff0\u521b\u5efa\u7684StatefulSet\u526f\u672c\u589e\u52a0\u52305\u4e2a\uff08\u5982\u679cStatefulSet\u6302\u8f7d\u7684\u4e3a\u9759\u6001PV\uff0c\u9700\u8981\u5728\u6269\u5bb9\u4e4b\u524d\u5148\u521b\u5efaPV\uff09\uff1a</p> <pre><code>$ kubectl scale sts web --replicas=5\nstatefulset.apps/web scaled\n</code></pre> <p>\u67e5\u770b\u6269\u5bb9\u540ePod\u7684\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pod\nNAME              READY   STATUS    RESTARTS   AGE\nweb-0             1/1     Running   0          34m\nweb-1             1/1     Running   0          34m\nweb-2             1/1     Running   0          2m37s\nweb-3             1/1     Running   0          2m12s\nweb-4             1/1     Running   0          109s\n</code></pre> <p>\u4e5f\u53ef\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u52a8\u6001\u67e5\u770b\uff1a</p> <pre><code>$ kubectl get pod -l app=nginx -w\nNAME    READY   STATUS    RESTARTS   AGE\nweb-0   1/1     Running   0          34m\nweb-1   1/1     Running   0          33m\nweb-2   1/1     Running   0          2m12s\nweb-3   1/1     Running   0          107s\nweb-4   1/1     Running   0          84s\n</code></pre> <p>\uff082\uff09\u7f29\u5bb9</p> <p>\u9996\u5148\u6253\u5f00\u53e6\u4e00\u4e2a\u7ec8\u7aef\u52a8\u6001\u67e5\u770b\u7f29\u5bb9\u7684\u6d41\u7a0b\uff1a</p> <pre><code>$ kubectl get pod -l app=nginx -w\n</code></pre> <p>\u5728\u53e6\u4e00\u4e2a\u7ec8\u7aef\u5c06\u526f\u672c\u6570\u6539\u4e3a3\uff08\u6b64\u5904\u6f14\u793a\u7684\u4e3apatch\u547d\u4ee4\uff0cpatch\u6bd4edit\u548cscale\u7a0d\u590d\u6742\u4e00\u4e9b\uff09\uff1a</p> <pre><code>$ kubectl patch sts web -p '{\"spec\":{\"replicas\":3}}'\nstatefulset.apps/web patched\n</code></pre> <p>\u6b64\u65f6\u53ef\u4ee5\u770b\u5230\u7b2c\u4e00\u4e2a\u7ec8\u7aef\u663e\u793aweb-4\u548cweb-3\u7684Pod\u6b63\u5728\u88ab\u6709\u5e8f\u5730\u5220\u9664\uff08\u6216\u7ec8\u6b62\uff09\uff1a</p> <pre><code>$ kubectl get pod -l app=nginx -w\nNAME    READY   STATUS    RESTARTS   AGE\nweb-0   1/1     Running   0          34m\nweb-1   1/1     Running   0          33m\nweb-2   1/1     Running   0          2m12s\nweb-3   1/1     Running   0          107s\nweb-4   1/1     Running   0          84s\nweb-4   1/1     Terminating   0          3m17s\nweb-4   0/1     Terminating   0          3m18s\nweb-4   0/1     Terminating   0          3m19s\nweb-4   0/1     Terminating   0          3m19s\nweb-3   1/1     Terminating   0          3m42s\nweb-3   0/1     Terminating   0          3m43s\nweb-3   0/1     Terminating   0          3m47s\nweb-3   0/1     Terminating   0          3m47s\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#37-statefulset\u66f4\u65b0\u7b56\u7565","title":"3.7 StatefulSet\u66f4\u65b0\u7b56\u7565","text":"<p>StatefulSet\u548cDeployment\u4e00\u6837\uff0c\u4e5f\u63d0\u4f9b\u4e86\u591a\u79cd\u66f4\u65b0\u7b56\u7565\uff0c\u53ef\u4ee5\u5728.spec.updateStrategy\u5b57\u6bb5\u4e2d\u6307\u5b9aStatefulSet\u7684\u66f4\u65b0\u7b56\u7565\u3002</p> <p>\uff081\uff09OnDelete\u7b56\u7565</p> <p>OnDelete\u66f4\u65b0\u7b56\u7565\u5b9e\u73b0\u4e86\u4f20\u7edf\uff081.7\u7248\u672c\u4e4b\u524d\uff09\u7684\u884c\u4e3a\uff0c\u5b83\u4e5f\u662f\u9ed8\u8ba4\u7684\u66f4\u65b0\u7b56\u7565\u3002 \u5f53\u6211\u4eec\u9009\u62e9\u8fd9\u4e2a\u66f4\u65b0\u7b56\u7565\u5e76\u4fee\u6539StatefulSet\u7684.spec.template\u5b57\u6bb5\u65f6\uff0cStatefulSet\u63a7\u5236\u5668\u4e0d\u4f1a\u81ea\u52a8\u66f4\u65b0Pod\uff0c\u5fc5\u987b\u624b\u52a8\u5220\u9664Pod\u624d\u80fd\u4f7f\u63a7\u5236\u5668\u521b\u5efa\u65b0\u7684Pod\u3002</p> <p>\uff082\uff09RollingUpdate\u7b56\u7565</p> <p>RollingUpdate\uff08\u6eda\u52a8\u66f4\u65b0\uff09\u7b56\u7565\u4f1a\u81ea\u52a8\u66f4\u65b0\u4e00\u4e2aStatefulSet\u4e2d\u6240\u6709\u7684Pod\uff0c\u91c7\u7528\u4e0e\u5e8f\u53f7\u7d22\u5f15\u76f8\u53cd\u7684\u987a\u5e8f\u8fdb\u884c\u6eda\u52a8\u66f4\u65b0\u3002</p> <p>\u6bd4\u5982\u66f4\u6539\u4e00\u4e2a\u540d\u79f0\u4e3aweb\u7684StatefulSet\u4f7f\u7528RollingUpdate\u65b9\u5f0f\u66f4\u65b0\uff1a</p> <pre><code>$ kubectl patch sts web -p '{\"spec\":{\"updateStrategy\":{\"type\":\"RollingUpdate\"}}}'\nstatefulset.apps/web patched (no change)\n</code></pre> <p>\u67e5\u770b\u66f4\u6539\u540e\u7684StatefulSet\uff1a</p> <pre><code>$ kubectl get sts web -o yaml|grep -A 1 \"updateStrategy\"\nupdateStrategy:\n    rollingUpdate:\n</code></pre> <p>\u7136\u540e\u6539\u53d8\u5bb9\u5668\u7684\u955c\u50cf\u89e6\u53d1\u6eda\u52a8\u66f4\u65b0\uff08\u6b64\u5904\u4f7f\u7528jsonPath\u7684\u65b9\u5f0f\u66f4\u6539\u7684\u8d44\u6e90\u914d\u7f6e\uff0c\u53ef\u4ee5\u4f7f\u7528set\u6216edit\u51cf\u5c11\u590d\u6742\u5ea6\uff09\uff1a</p> <pre><code>$ kubectl patch statefulset web --type='json' -p='[{\"op\": \"replace\", \"path\": \"/spec/template/spec/containers/0/image\", \"value\":\"gcr.io/google_containers/nginx-slim:0.8\"}]'\n</code></pre> <p>\u5982\u4e0a\u6240\u8ff0\uff0cStatefulSet\u4e2d\u7684Pod\u91c7\u7528\u548c\u5e8f\u53f7\u76f8\u53cd\u7684\u987a\u5e8f\u66f4\u65b0\u3002</p> <p>\u5728\u66f4\u65b0\u4e0b\u4e00\u4e2aPod\u524d\uff0cStatefulSet\u63a7\u5236\u5668\u4f1a\u7ec8\u6b62\u6bcf\u4e00\u4e2aPod\u5e76\u7b49\u5f85\u5b83\u4eec\u53d8\u6210Running\u548cReady\u72b6\u6001\u3002 \u5728\u5f53\u524d\u987a\u5e8f\u53d8\u6210Running\u548cReady\u72b6\u6001\u4e4b\u524d\uff0cStatefulSet\u63a7\u5236\u5668\u4e0d\u4f1a\u66f4\u65b0\u4e0b\u4e00\u4e2aPod\uff0c\u4f46\u5b83\u4ecd\u7136\u4f1a\u91cd\u5efa\u4efb\u4f55\u5728\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u53d1\u751f\u6545\u969c\u7684Pod\uff0c\u4f7f\u7528\u5b83\u4eec\u5f53\u524d\u7684\u7248\u672c\u3002 \u5df2\u7ecf\u63a5\u6536\u5230\u8bf7\u6c42\u7684Pod\u5c06\u4f1a\u88ab\u6062\u590d\u4e3a\u66f4\u65b0\u7684\u7248\u672c\uff0c\u6ca1\u6709\u6536\u5230\u8bf7\u6c42\u7684Pod\u5219\u4f1a\u88ab\u6062\u590d\u4e3a\u4e4b\u524d\u7684\u7248\u672c\u3002</p> <p>\u5728\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u53ef\u4ee5\u4f7f\u7528<code>kubectl rollout status sts/&lt;name&gt;</code>\u6765\u67e5\u770b\u6eda\u52a8\u66f4\u65b0\u7684\u72b6\u6001\uff1a</p> <pre><code>$ kubectl rollout status sts/web\nWaiting for 1 pods to be ready...\nwaiting for statefulset rolling update to complete 1 pods at revision web-56b5798f76...\nWaiting for 1 pods to be ready...\nWaiting for 1 pods to be ready...\nwaiting for statefulset rolling update to complete 2 pods at revision web-56b5798f76...\nWaiting for 1 pods to be ready...\nWaiting for 1 pods to be ready...\nstatefulset rolling update complete 3 pods at revision web-56b5798f76...\n</code></pre> <p>\u67e5\u770b\u66f4\u65b0\u540e\u7684\u955c\u50cf\uff1a</p> <pre><code>$ for p in 0 1 2; do kubectl get pod \"web-$p\" --template '{{range $i, $c := .spec.containers}}{{$c.image}}{{end}}'; echo; done\n</code></pre> <p>\uff083\uff09\u5206\u6bb5\u66f4\u65b0</p> <p>StatefulSet\u53ef\u4ee5\u4f7f\u7528RollingUpdate\u66f4\u65b0\u7b56\u7565\u7684partition\u53c2\u6570\u6765\u5206\u6bb5\u66f4\u65b0\u4e00\u4e2aStatefulSet\u3002</p> <p>\u5206\u6bb5\u66f4\u65b0\u5c06\u4f1a\u4f7fStatefulSet\u4e2d\u5176\u4f59\u7684\u6240\u6709Pod\uff08\u5e8f\u53f7\u5c0f\u4e8e\u5206\u533a\uff09\u4fdd\u6301\u5f53\u524d\u7248\u672c\uff0c\u53ea\u66f4\u65b0\u5e8f\u53f7\u5927\u4e8e\u7b49\u4e8e\u5206\u533a\u7684Pod\uff0c\u5229\u7528\u6b64\u7279\u6027\u53ef\u4ee5\u7b80\u5355\u5b9e\u73b0\u91d1\u4e1d\u96c0\u53d1\u5e03\uff08\u7070\u5ea6\u53d1\u5e03\uff09\u6216\u8005\u5206\u9636\u6bb5\u63a8\u51fa\u65b0\u529f\u80fd\u7b49\u3002</p> <p>\u63d0\u793a</p> <p>\u91d1\u4e1d\u96c0\u53d1\u5e03\u662f\u6307\u5728\u9ed1\u4e0e\u767d\u4e4b\u95f4\u80fd\u591f\u5e73\u6ed1\u8fc7\u6e21\u7684\u4e00\u79cd\u53d1\u5e03\u65b9\u5f0f\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u5206\u533a\"partition\":3\uff0c\u53ef\u4ee5\u4f7f\u7528patch\u6216edit\u76f4\u63a5\u5bf9StatefulSet\u8fdb\u884c\u8bbe\u7f6e\uff1a</p> <pre><code>$ kubectl patch statefulset web -p '{\"spec\":{\"updateStrategy\":{\"type\":\"RollingUpdate\",\"rollingUpdate\":{\"partition\":3}}}}'\n</code></pre> <p>\u7136\u540e\u518d\u6b21\u4f7f\u7528patch\u6539\u53d8\u5bb9\u5668\u7684\u955c\u50cf\uff1a</p> <pre><code>$ kubectl patch statefulset web --type='json' -p='[{\"op\": \"replace\", \"path\": \"/spec/template/spec/containers/0/image\", \"value\":\"registry.k8s.io/nginx-slim:0.7\"}]'\nstatefulset.apps/web patched\n</code></pre> <p>\u5220\u9664 StatefulSet \u4e2d\u7684 Pod \u89e6\u53d1\u66f4\u65b0\uff1a</p> <pre><code>$ kubectl delete pod web-2\npod \"web-2\" deleted\n</code></pre> <p>\u6b64\u65f6\uff0c\u56e0\u4e3aPod web-2\u7684\u5e8f\u53f7\u5c0f\u4e8e\u5206\u533a3\uff0c\u6240\u4ee5Pod\u4e0d\u4f1a\u88ab\u66f4\u65b0\uff0c\u8fd8\u662f\u4f1a\u4f7f\u7528\u4ee5\u524d\u7684\u5bb9\u5668\u6062\u590dPod\u3002</p> <p>\u7b49\u5f85Pod\u53d8\u6210Running\u548cReady\u3002</p> <pre><code>$ kubectl get pod -l app=nginx -w\nNAME      READY     STATUS              RESTARTS   AGE\nweb-0     1/1       Running             0          4m\nweb-1     1/1       Running             0          4m\nweb-2     0/1       ContainerCreating   0          11s\nweb-2     1/1       Running   0         18s\n</code></pre> <p>\u5c06\u5206\u533a\u6539\u4e3a2\uff0c\u6b64\u65f6\u4f1a\u81ea\u52a8\u66f4\u65b0web-2\uff08\u56e0\u4e3a\u4e4b\u524d\u66f4\u6539\u4e86\u66f4\u65b0\u7b56\u7565\uff09\uff0c\u4f46\u662f\u4e0d\u4f1a\u66f4\u65b0web-0\u548cweb-1\uff1a</p> <pre><code>$ kubectl patch statefulset web -p '{\"spec\":{\"updateStrategy\":{\"type\":\"RollingUpdate\",\"rollingUpdate\":{\"partition\":2}}}}'\n</code></pre> <p>\u6309\u7167\u4e0a\u8ff0\u65b9\u5f0f\u53ef\u4ee5\u5b9e\u73b0\u5206\u9636\u6bb5\u66f4\u65b0\uff0c\u7c7b\u4f3c\u4e8e\u7070\u5ea6/\u91d1\u4e1d\u96c0\u53d1\u5e03\u3002\u67e5\u770b\u6700\u7ec8\u7684\u7ed3\u679c\u5982\u4e0b\uff1a</p> <pre><code>$ for p in 0 1 2; do kubectl get pod \"web-$p\" --template '{{range $i, $c := .spec.containers}}{{$c.image}}{{end}}'; echo; done\nregistry.k8s.io/nginx-slim:0.8\nregistry.k8s.io/nginx-slim:0.8\nregistry.k8s.io/nginx-slim:0.8\n</code></pre> <p>\u8bf7\u6ce8\u610f</p> <p>\u867d\u7136\u66f4\u65b0\u7b56\u7565\u662fRollingUpdate\uff0cStatefulSet \u8fd8\u662f\u4f1a\u4f7f\u7528\u539f\u59cb\u7684\u5bb9\u5668\u6062\u590dPod\u3002 \u8fd9\u662f\u56e0\u4e3aPod\u7684\u5e8f\u53f7\u6bd4updateStrategy\u6307\u5b9a\u7684partition\u66f4\u5c0f\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#38-\u5220\u9664statefulset","title":"3.8 \u5220\u9664StatefulSet","text":"<p>\u5220\u9664StatefulSet\u6709\u4e24\u79cd\u65b9\u5f0f\uff0c\u5373\u7ea7\u8054\u5220\u9664\u548c\u975e\u7ea7\u8054\u5220\u9664\u3002\u4f7f\u7528\u975e\u7ea7\u8054\u65b9\u5f0f\u5220\u9664StatefulSet\u65f6\uff0cStatefulSet\u7684Pod\u4e0d\u4f1a\u88ab\u5220\u9664\uff1b</p> <p>\u4f7f\u7528\u7ea7\u8054\u65b9\u5f0f\u5220\u9664StatefulSet\u65f6\uff0cStatefulSet\u548c\u5b83\u7684Pod\u90fd\u4f1a\u88ab\u5220\u9664\u3002</p> <p>\uff081\uff09\u975e\u7ea7\u8054\u5220\u9664</p> <p>\u4f7f\u7528kubectl delete sts xxx\u5220\u9664StatefulSet\u65f6\uff0c\u53ea\u9700\u63d0\u4f9b--cascade=false\u53c2\u6570\uff0c\u5c31\u4f1a\u91c7\u7528\u975e\u7ea7\u8054\u5220\u9664\uff0c\u6b64\u65f6\u5220\u9664StatefulSet\u4e0d\u4f1a\u5220\u9664\u5b83\u7684Pod\uff1a</p> <pre><code>$ kubectl delete statefulset web --cascade=false\nwarning: --cascade=false is deprecated (boolean value) and can be replaced with --cascade=orphan.\nstatefulset.apps \"web\" deleted\n\n$ kubectl get sts\nNo resources found in default namespace.\n\n$ kubectl get pod\nNAME              READY   STATUS    RESTARTS   AGE\nweb-0             1/1     Running   0          10m\nweb-1             1/1     Running   0          10m\nweb-2             1/1     Running   0          7m28s\n</code></pre> <p>\u7531\u4e8e\u6b64\u65f6\u5220\u9664\u4e86StatefulSet\uff0c\u5b83\u7ba1\u7406\u7684Pod\u53d8\u6210\u4e86\u201c\u5b64\u513f\u201dPod\uff0c\u56e0\u6b64\u5355\u72ec\u5220\u9664Pod\u65f6\uff0c\u8be5Pod\u4e0d\u4f1a\u88ab\u91cd\u5efa\uff1a</p> <pre><code>$ kubectl get pod\nNAME              READY   STATUS    RESTARTS   AGE\nweb-0             1/1     Running   0          3m11s\nweb-1             1/1     Running   0          2m51s\nweb-2             1/1     Running   0          2m34s\n\n$ kubectl delete po web-0\npod \"web-0\" deleted\n\n$ kubectl get pod\nNAME              READY   STATUS    RESTARTS   AGE\nweb-1             1/1     Running   0          3m53s\nweb-2             1/1     Running   0          3m36s\n</code></pre> <p>\u5f53\u518d\u6b21\u521b\u5efa\u6b64StatefulSet\u65f6\uff0cweb-0\u4f1a\u88ab\u91cd\u65b0\u521b\u5efa\uff0c\u7531\u4e8eweb-1\u5df2\u7ecf\u5b58\u5728\uff0c\u56e0\u6b64\u4e0d\u4f1a\u88ab\u518d\u6b21\u521b\u5efa\uff0c\u56e0\u4e3a\u6700\u521d\u6b64StatefulSet\u7684replicas\u662f2\uff0c\u6240\u4ee5web-2\u4f1a\u88ab\u5220\u9664\uff0c \u4ee3\u7801\u5982\u4e0b\uff08\u5ffd\u7565AlreadyExists\u9519\u8bef\uff0c\u56e0\u4e3a\u53ea\u5220\u9664\u4e86StatefulSet\u5e76\u6ca1\u5220\u9664Service\uff0c\u6240\u4ee5\u5728\u6b64\u521b\u5efaService\u65f6\u4f1a\u63d0\u793a\u5df2\u7ecf\u5b58\u5728\u8be5Service\uff09\uff1a</p> <pre><code>$ kubectl create -f sts-web.yml\nstatefulset.apps/web created\nError from server (AlreadyExists): error when creating \"sts-web.yml\": services \"nginx\" already exists\n\n$  kubectl get pod\nNAME              READY   STATUS    RESTARTS   AGE\nweb-0             1/1     Running   0          79s\nweb-1             1/1     Running   0          4m28s\n</code></pre> <p>\uff082\uff09\u7ea7\u8054\u5220\u9664</p> <p>\u7701\u7565--cascade=false\u53c2\u6570\u5373\u4e3a\u7ea7\u8054\u5220\u9664\uff1a</p> <pre><code>$ kubectl delete sts web\nstatefulset.apps \"web\" deleted\n\n$ kubectl get pod\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u4f7f\u7528-f\u6307\u5b9a\u521b\u5efaStatefulSet\u548cService\u7684YAML\u6587\u4ef6\uff0c\u76f4\u63a5\u5220\u9664StatefulSet\u548cService\uff08\u6b64\u6587\u4ef6\u5c06StatefulSet\u548cService\u5199\u5728\u4e86\u4e00\u8d77\uff09\uff1a</p> <pre><code>$ kubectl delete -f sts-web.yml\nservice \"nginx\" deleted\nError from server (NotFound): error when deleting \"sts-web.yml\": statefulsets.apps \"web\" not found\n</code></pre> <p>\u53c2\u8003\u6587\u732e</p> <p>https://kubernetes.io/zh-cn/docs/tutorials/stateful-application/basic-stateful-set/</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#4\u5b88\u62a4\u8fdb\u7a0b\u96c6daemonset","title":"4.\u5b88\u62a4\u8fdb\u7a0b\u96c6DaemonSet","text":"<p>DaemonSet\uff08\u5b88\u62a4\u8fdb\u7a0b\u96c6\uff0c\u7f29\u5199\u4e3ads\uff09\u548c\u5b88\u62a4\u8fdb\u7a0b\u7c7b\u4f3c\uff0c\u5b83\u5728\u7b26\u5408\u5339\u914d\u6761 \u4ef6\u7684\u8282\u70b9\u4e0a\u5747\u90e8\u7f72\u4e00\u4e2aPod\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#41-\u4ec0\u4e48\u662fdaemonset","title":"4.1 \u4ec0\u4e48\u662fDaemonSet","text":"<p>\u6709\u65f6\u5019\u6211\u4eec\u9700\u8981\u5728\u6bcf\u4e2aKubernetes\u8282\u70b9\u6216\u7b26\u5408\u6761\u4ef6\u7684\u8282\u70b9\u4e0a\u90fd\u90e8\u7f72\u67d0\u4e2a\u5e94\u7528\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u4f7f\u7528Kubernetes\u7684DaemonSet\u8c03\u5ea6Pod\u3002 DaemonSet\u786e\u4fdd\u5168\u90e8\uff08\u6216\u8005\u67d0\u4e9b\u7b26\u5408\u6761\u4ef6\uff09\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2aPod\u526f\u672c\u3002</p> <p>\u5f53\u6709\u65b0\u8282\u70b9\u52a0\u5165\u96c6\u7fa4\u65f6\uff0c\u4e5f\u4f1a\u4e3a\u5b83\u4eec\u65b0\u589e\u4e00\u4e2aPod\uff0c\u5f53\u8282\u70b9\u4ece\u96c6\u7fa4\u4e2d\u79fb\u9664\u65f6\uff0c\u8fd9\u4e9bPod\u4e5f\u4f1a\u88ab\u56de\u6536\uff0c\u5220\u9664DaemonSet\u5c06\u4f1a\u5220\u9664\u5b83\u521b\u5efa\u7684\u6240\u6709Pod\u3002</p> <p>\u4f7f\u7528DaemonSet\u7684\u4e00\u4e9b\u5178\u578b\u7528\u6cd5\uff1a</p> <ul> <li>\u8fd0\u884c\u96c6\u7fa4\u5b58\u50a8daemon\uff08\u5b88\u62a4\u8fdb\u7a0b\uff09\uff0c\u4f8b\u5982\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884cGlusterd\u3001Ceph\u7b49\u3002</li> <li>\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u65e5\u5fd7\u6536\u96c6daemon\uff0c\u4f8b\u5982Fluentd\u3001Logstash\u3002</li> <li>\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u76d1\u63a7daemon\uff0c\u6bd4\u5982Prometheus Node Exporter\u3001Collectd\u3001Datadog\u4ee3\u7406\u3001New Relic\u4ee3\u7406\u6216Ganglia gmond\u3002</li> </ul>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#42-\u5b9a\u4e49\u4e00\u4e2adaemonset","title":"4.2 \u5b9a\u4e49\u4e00\u4e2aDaemonSet","text":"<p>\u521b\u5efa\u4e00\u4e2aDaemonSet\u548cDeployment\u7c7b\u4f3c\uff0c\u6bd4\u5982\u521b\u5efa\u4e00\u4e2afluentd\u7684DaemonSet\uff1a</p> <p>fluentd-ds.yml</p> <pre><code>apiVersion: apps/v1\nkind: DaemonSet # kind\u4e3aDaemonSet\nmetadata:\nname: fluentd-es-v2.0.4\nnamespace: logging\nlabels:\nk8s-app: fluentd-es\nversion: v2.0.4\nkubernetes.io/cluster-service: \"true\"\naddonmanager.kubernetes.io/mode: Reconcile\nspec:\nselector:\nmatchLabels:\nk8s-app: fluentd-es\nversion: v2.0.4\ntemplate:\nmetadata:\nlabels:\nk8s-app: fluentd-es\nkubernetes.io/cluster-service: \"true\"\nversion: v2.0.4\n# This annotation ensures that fluentd does not get evicted if the node\n# supports critical pod annotation based priority scheme.\n# Note that this does not guarantee admission on the nodes (#40573).\nannotations:\nscheduler.alpha.kubernetes.io/critical-pod: ''\nseccomp.security.alpha.kubernetes.io/pod: 'docker/default'\nspec:\nserviceAccountName: fluentd-es\ncontainers:\n- name: fluentd-es\nimage: k8s.gcr.io/fluentd-elasticsearch:v2.0.4\nenv:\n- name: FLUENTD_ARGS\nvalue: --no-supervisor -q\nresources:\nlimits:\nmemory: 500Mi\nrequests:\ncpu: 100m\nmemory: 200Mi\nvolumeMounts:\n- name: varlog\nmountPath: /var/log\n- name: varlibdockercontainers\nmountPath: /var/lib/docker/containers\nreadOnly: true\n- name: config-volume\nmountPath: /etc/fluent/config.d\nnodeSelector:\nbeta.kubernetes.io/fluentd-ds-ready: \"true\"\nterminationGracePeriodSeconds: 30\nvolumes:\n- name: varlog\nhostPath:\npath: /var/log\n- name: varlibdockercontainers\nhostPath:\npath: /var/lib/docker/containers\n- name: config-volume\nconfigMap:\nname: fluentd-es-config-v0.1.4\n</code></pre> <p>\uff081\uff09\u5fc5\u9700\u5b57\u6bb5</p> <p>\u548c\u5176\u4ed6\u6240\u6709Kubernetes\u914d\u7f6e\u4e00\u6837\uff0cDaemonSet\u9700\u8981apiVersion\u3001kind\u548cmetadata\u5b57\u6bb5\uff0c\u540c\u65f6\u4e5f\u9700\u8981\u4e00\u4e2a.spec\u914d\u7f6e\u6bb5\u3002</p> <p>\uff082\uff09Pod\u6a21\u677f</p> <p>.spec\u552f\u4e00\u9700\u8981\u7684\u5b57\u6bb5\u662f.spec.template\u3002.spec.template\u662f\u4e00\u4e2aPod\u6a21\u677f\uff0c\u5b83\u4e0ePod\u5177\u6709\u76f8\u540c\u7684\u914d\u7f6e\u65b9\u5f0f\uff0c\u4f46\u5b83\u4e0d\u5177\u6709apiVersion\u548ckind\u5b57\u6bb5\u3002\u9664\u4e86Pod\u5fc5\u9700\u7684\u5b57\u6bb5\u5916\uff0c\u5728DaemonSet\u4e2d\u7684Pod\u6a21\u677f\u5fc5\u987b\u6307\u5b9a\u5408\u7406\u7684\u6807\u7b7e\u3002</p> <p>\u5728DaemonSet\u4e2d\u7684Pod\u6a21\u677f\u5fc5\u987b\u5177\u6709\u4e00\u4e2aRestartPolicy\uff0c\u9ed8\u8ba4\u4e3aAlways\u3002</p> <p>\uff083\uff09Pod Selector</p> <p>.spec.selector\u5b57\u6bb5\u8868\u793aPod Selector\uff0c\u5b83\u4e0e\u5176\u4ed6\u8d44\u6e90\u7684.spec.selector\u7684\u4f5c\u7528\u76f8\u540c\u3002</p> <p>.spec.selector\u8868\u793a\u4e00\u4e2a\u5bf9\u8c61\uff0c\u5b83\u7531\u5982\u4e0b\u4e24\u4e2a\u5b57\u6bb5\u7ec4\u6210\uff1a</p> <ul> <li>matchLabels\uff1a\u4e0eReplicationController\u7684.spec.selector\u7684\u4f5c\u7528\u76f8\u540c\uff0c\u7528\u4e8e\u5339\u914d\u7b26\u5408\u6761\u4ef6\u7684Pod\u3002</li> <li>matchExpressions\uff1a\u5141\u8bb8\u6784\u5efa\u66f4\u52a0\u590d\u6742\u7684Selector\uff0c\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9akey\u3001value\u5217\u8868\u4ee5\u53ca\u4e0ekey\u548cvalue\u5217\u8868\u76f8\u5173\u7684\u64cd\u4f5c\u7b26\u3002</li> </ul> <p>\u5982\u679c\u4e0a\u8ff0\u4e24\u4e2a\u5b57\u6bb5\u90fd\u6307\u5b9a\uff0c\u7ed3\u679c\u8868\u793a\u7684\u662fAND\u5173\u7cfb\uff08\u903b\u8f91\u4e0e\u7684\u5173\u7cfb\uff09\u3002</p> <p>.spec.selector\u5fc5\u987b\u4e0e.spec.template.metadata.labels\u76f8\u5339\u914d\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u6307\u5b9a\uff08APIVersion\u4e3aapps/v1\u5fc5\u987b\u6307\u5b9a\u8be5\u5b57\u6bb5\uff09\uff0c\u9ed8\u8ba4\u662f\u7b49\u4ef7\u7684\uff0c\u5982\u679c\u5b83\u4eec\u7684\u914d\u7f6e\u4e0d\u5339\u914d\uff0c\u5219\u4f1a\u88abAPI\u62d2\u7edd\u3002</p> <p>\uff084\uff09\u6307\u5b9a\u8282\u70b9\u90e8\u7f72Pod</p> <p>\u5982\u679c\u6307\u5b9a\u4e86.spec.template.spec.nodeSelector\uff0cDaemonSet Controller\u5c06\u5728\u4e0eNode Selector(\u8282\u70b9\u9009\u62e9\u5668)\u5339\u914d\u7684\u8282\u70b9\u4e0a\u521b\u5efaPod\uff0c\u6bd4\u5982\u90e8\u7f72\u5728\u78c1\u76d8\u7c7b\u578b\u4e3assd\u7684\u8282\u70b9\u4e0a(\u9700\u8981\u63d0\u524d\u7ed9\u8282\u70b9\u5b9a\u4e49\u6807\u7b7eLabel)\uff1a</p> <pre><code>      nodeSelector:\n        disktype: ssd\n</code></pre> <p>\u63d0\u793a</p> <p>Node Selector\u540c\u6837\u9002\u7528\u4e8e\u5176\u4ed6Controller\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#43-\u521b\u5efadaemonset","title":"4.3 \u521b\u5efaDaemonSet","text":"<p>\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u516c\u53f8\u4e1a\u52a1\u7684\u5e94\u7528\u7a0b\u5e8f\u4e00\u822c\u65e0\u987b\u4f7f\u7528DaemonSet\u90e8\u7f72\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u53ea\u6709\u50cfFluentd\uff08\u65e5\u5fd7\u6536\u96c6\uff09\u3001Ingress\uff08\u96c6\u7fa4\u670d\u52a1\u5165\u53e3\uff09\u3001Calico\uff08\u96c6\u7fa4\u7f51\u7edc\u7ec4\u4ef6\uff09\u3001 Node-Exporter\uff08\u76d1\u63a7\u6570\u636e\u91c7\u96c6\uff09\u7b49\u624d\u9700\u8981\u4f7f\u7528DaemonSet\u90e8\u7f72\u5230\u6bcf\u4e2a\u8282\u70b9\uff0c\u672c\u8282\u53ea\u6f14\u793aDaemonSet\u7684\u4f7f\u7528\u3002</p> <p>\u6bd4\u5982\u521b\u5efa\u4e00\u4e2aNginx Ingress\uff08\u53ef\u4ee5\u5728\u5bf9\u5e94\u7684\u7ae0\u8282\u627e\u5230\u8be5\u6587\u4ef6\uff09</p> <pre><code>apiVersion: v1\nkind: Namespace\nmetadata:\nname: ingress-nginx\nlabels:\napp.kubernetes.io/name: ingress-nginx\napp.kubernetes.io/part-of: ingress-nginx\n---\nkind: ConfigMap\napiVersion: v1\nmetadata:\nname: nginx-configuration\nnamespace: ingress-nginx\nlabels:\napp.kubernetes.io/name: ingress-nginx\napp.kubernetes.io/part-of: ingress-nginx\n---\nkind: ConfigMap\napiVersion: v1\nmetadata:\nname: tcp-services\nnamespace: ingress-nginx\nlabels:\napp.kubernetes.io/name: ingress-nginx\napp.kubernetes.io/part-of: ingress-nginx\n---\nkind: ConfigMap\napiVersion: v1\nmetadata:\nname: udp-services\nnamespace: ingress-nginx\nlabels:\napp.kubernetes.io/name: ingress-nginx\napp.kubernetes.io/part-of: ingress-nginx\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\nname: nginx-ingress-serviceaccount\nnamespace: ingress-nginx\nlabels:\napp.kubernetes.io/name: ingress-nginx\napp.kubernetes.io/part-of: ingress-nginx\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRole\nmetadata:\nname: nginx-ingress-clusterrole\nlabels:\napp.kubernetes.io/name: ingress-nginx\napp.kubernetes.io/part-of: ingress-nginx\nrules:\n- apiGroups:\n- \"\"\nresources:\n- configmaps\n- endpoints\n- nodes\n- pods\n- secrets\nverbs:\n- list\n- watch\n- apiGroups:\n- \"\"\nresources:\n- nodes\nverbs:\n- get\n- apiGroups:\n- \"\"\nresources:\n- services\nverbs:\n- get\n- list\n- watch\n- apiGroups:\n- \"extensions\"\nresources:\n- ingresses\nverbs:\n- get\n- list\n- watch\n- apiGroups:\n- \"\"\nresources:\n- events\nverbs:\n- create\n- patch\n- apiGroups:\n- \"extensions\"\nresources:\n- ingresses/status\nverbs:\n- update\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: Role\nmetadata:\nname: nginx-ingress-role\nnamespace: ingress-nginx\nlabels:\napp.kubernetes.io/name: ingress-nginx\napp.kubernetes.io/part-of: ingress-nginx\nrules:\n- apiGroups:\n- \"\"\nresources:\n- configmaps\n- pods\n- secrets\n- namespaces\nverbs:\n- get\n- apiGroups:\n- \"\"\nresources:\n- configmaps\nresourceNames:\n- \"ingress-controller-leader-nginx\"\nverbs:\n- get\n- update\n- apiGroups:\n- \"\"\nresources:\n- configmaps\nverbs:\n- create\n- apiGroups:\n- \"\"\nresources:\n- endpoints\nverbs:\n- get\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: RoleBinding\nmetadata:\nname: nginx-ingress-role-nisa-binding\nnamespace: ingress-nginx\nlabels:\napp.kubernetes.io/name: ingress-nginx\napp.kubernetes.io/part-of: ingress-nginx\nroleRef:\napiGroup: rbac.authorization.k8s.io\nkind: Role\nname: nginx-ingress-role\nsubjects:\n- kind: ServiceAccount\nname: nginx-ingress-serviceaccount\nnamespace: ingress-nginx\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\nname: nginx-ingress-clusterrole-nisa-binding\nlabels:\napp.kubernetes.io/name: ingress-nginx\napp.kubernetes.io/part-of: ingress-nginx\nroleRef:\napiGroup: rbac.authorization.k8s.io\nkind: ClusterRole\nname: nginx-ingress-clusterrole\nsubjects:\n- kind: ServiceAccount\nname: nginx-ingress-serviceaccount\nnamespace: ingress-nginx\n---\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\nname: nginx-ingress-controller\nnamespace: ingress-nginx\nlabels:\napp.kubernetes.io/name: ingress-nginx\napp.kubernetes.io/part-of: ingress-nginx\nspec:\nselector:\nmatchLabels:\napp.kubernetes.io/name: ingress-nginx\napp.kubernetes.io/part-of: ingress-nginx\nupdateStrategy:\nrollingUpdate:\nmaxUnavailable: 1\ntype: RollingUpdate\ntemplate:\nmetadata:\nlabels:\napp.kubernetes.io/name: ingress-nginx\napp.kubernetes.io/part-of: ingress-nginx\nannotations:\nprometheus.io/port: \"10254\"\nprometheus.io/scrape: \"true\"\nspec:\nserviceAccountName: nginx-ingress-serviceaccount\nhostNetwork: true\ncontainers:\n- name: nginx-ingress-controller\nimage: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.22.0\nargs:\n- /nginx-ingress-controller\n- --configmap=$(POD_NAMESPACE)/nginx-configuration\n- --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services\n- --udp-services-configmap=$(POD_NAMESPACE)/udp-services\n- --publish-service=$(POD_NAMESPACE)/ingress-nginx\n- --annotations-prefix=nginx.ingress.kubernetes.io\nsecurityContext:\nallowPrivilegeEscalation: true\ncapabilities:\ndrop:\n- ALL\nadd:\n- NET_BIND_SERVICE\nrunAsUser: 33\nenv:\n- name: POD_NAME\nvalueFrom:\nfieldRef:\nfieldPath: metadata.name\n- name: POD_NAMESPACE\nvalueFrom:\nfieldRef:\nfieldPath: metadata.namespace\nports:\n- name: http\ncontainerPort: 80\n- name: https\ncontainerPort: 443\nlivenessProbe:\nfailureThreshold: 3\nhttpGet:\npath: /healthz\nport: 10254\nscheme: HTTP\ninitialDelaySeconds: 10\nperiodSeconds: 10\nsuccessThreshold: 1\ntimeoutSeconds: 1\nreadinessProbe:\nfailureThreshold: 3\nhttpGet:\npath: /healthz\nport: 10254\nscheme: HTTP\nperiodSeconds: 10\nsuccessThreshold: 1\ntimeoutSeconds: 1\n---\n</code></pre> <p><pre><code>$ pwd\n$ kubectl create -f nginx-ds.yaml\nnamespace/ingress-nginx created\nconfigmap/nginx-configuration created\nconfigmap/tcp-services created\nconfigmap/udp-services created\nserviceaccount/nginx-ingress-serviceaccount created\nclusterrole.rbac.authorization.k8s.io/nginx-ingress-clusterrole\ncreated\nrole.rbac.authorization.k8s.io/nginx-ingress-role created\nrolebinding.rbac.authorization.k8s.io/nginx-ingress-role-nisa-\nbinding created\nclusterrolebinding.rbac.authorization.k8s.io/nginx-ingress-\nclusterrole-nisa-bindi\nng created\ndaemonset.extensions/nginx-ingress-controller created\n</code></pre> \u6b64\u65f6\u4f1a\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u521b\u5efa\u4e00\u4e2aPod\uff1a <pre><code>$ kubectl get pod -n ingress-nginx\nNAME                                           READY   STATUS    RESTARTS   AGE\ningress-nginx-controller-267hs                 1/1     Running   3          60d\ningress-nginx-controller-zlwmm                 1/1     Running   2          60d\n.......\ningress-nginx-defaultbackend-b578d6c5b-svwsw   1/1     Running   19         177d\n\n# \u4f7f\u7528-o wide\u67e5\u770bpod\u6240\u5728\u8282\u70b9\n$ kubectl get pod -n ingress-nginx -o wide\nNAME                                           READY   STATUS    RESTARTS   AGE    IP             NODE           NOMINATED NODE   READINESS GATES\ningress-nginx-controller-267hs                 1/1     Running   3          60d    192.168.1.79   gitee-k8s-n2   &lt;none&gt;           &lt;none&gt;\ningress-nginx-controller-zlwmm                 1/1     Running   2          60d    192.168.1.32   gitee-k8s-n1   &lt;none&gt;           &lt;none&gt;\n.......\ningress-nginx-defaultbackend-b578d6c5b-svwsw   1/1     Running   19         177d   10.0.35.131    gitee-k8s-n2   &lt;none&gt;           &lt;none&gt;\n</code></pre></p> <p>\u6ce8\u610f</p> <p>\u6ce8\u610f \u56e0\u4e3a\u7b14\u8005\u7684Master\u8282\u70b9\u5220\u9664\u4e86Taint\uff08Taint\u548cToleration\u5185\u5bb9\u89c1\u672c\u4e669.4 \u8282\uff09\uff0c\u6240\u4ee5\u4e5f\u80fd\u90e8\u7f72Ingress\u6216\u8005\u5176\u4ed6Pod\uff0c\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5728Master\u8282\u70b9\u9664\u4e86\u7cfb\u7edf\u7ec4\u4ef6\u5916\u6700\u597d\u4e0d\u8981\u90e8\u7f72\u5176\u4ed6Pod\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#44-\u66f4\u65b0\u548c\u56de\u6edadaemonset","title":"4.4 \u66f4\u65b0\u548c\u56de\u6edaDaemonSet","text":"<p>\u5982\u679c\u6dfb\u52a0\u4e86\u65b0\u8282\u70b9\u6216\u4fee\u6539\u4e86\u8282\u70b9\u6807\u7b7e\uff08Label\uff09\uff0cDaemonSet\u5c06\u7acb\u523b\u5411\u65b0\u5339\u914d\u4e0a\u7684\u8282\u70b9\u6dfb\u52a0Pod\uff0c\u540c\u65f6\u5220\u9664\u4e0d\u80fd\u5339\u914d\u7684\u8282\u70b9\u4e0a\u7684Pod\u3002</p> <p>\u5728Kubernetes 1.6\u4ee5\u540e\u7684\u7248\u672c\u4e2d\uff0c\u53ef\u4ee5\u5728DaemonSet\u4e0a\u6267\u884c\u6eda\u52a8\u66f4\u65b0\uff0c\u672a\u6765\u7684Kubernetes\u7248\u672c\u5c06\u652f\u6301\u8282\u70b9\u7684\u53ef\u63a7\u66f4\u65b0\u3002</p> <p>DaemonSet\u6eda\u52a8\u66f4\u65b0\u53ef\u53c2\u8003\uff1ahttps://kubernetes.io/docs/tasks/manage-daemon/update-daemon-set/\u3002</p> <p>DaemonSet\u66f4\u65b0\u7b56\u7565\u548cStatefulSet\u7c7b\u4f3c\uff0c\u4e5f\u6709OnDelete\u548cRollingUpdate\u4e24\u79cd\u65b9\u5f0f\u3002</p> <p>\u67e5\u770b\u4e0a\u4e00\u8282\u521b\u5efa\u7684DaemonSet\u66f4\u65b0\u65b9\u5f0f\uff1a <pre><code>$ kubectl get ds nginx-ds -o go-template='{{.spec.updateStrategy.type}}{{\"\\n\"}}'\nRollingUpdate\n</code></pre></p> <p>\u547d\u4ee4\u5f0f\u66f4\u65b0\uff0c\u548c\u4e4b\u524d\u7684Deployment\u3001StatefulSet\u65b9\u5f0f\u4e00\u81f4\uff1a <pre><code>$ kubectl edit ds/&lt;daemonset-name&gt;\n$ kubectl patch ds/&lt;daemonset-name&gt; -p=&lt;strategic-merge-patch&gt;\n</code></pre></p> <p>\u66f4\u65b0\u955c\u50cf\uff1a <pre><code>$ kubectl set image ds/&lt;daemonset-name&gt;&lt;container-name&gt;=&lt;container-new-image&gt; --record=true\n</code></pre></p> <p>\u67e5\u770b\u66f4\u65b0\u72b6\u6001 <pre><code>$ kubectl rollout status ds/&lt;daemonset-name&gt;\n</code></pre></p> <p>\u5217\u51fa\u6240\u6709\u4fee\u8ba2\u7248\u672c\uff1a <pre><code>$ kubectl rollout history daemonset &lt;daemonset-name&gt;\n</code></pre></p> <p>\u56de\u6eda\u5230\u6307\u5b9arevision\uff1a <pre><code>$ kubectl rollout undo daemonset &lt;daemonset-name&gt; --to-revision=&lt;revision&gt;\n</code></pre></p> <p>DaemonSet\u7684\u66f4\u65b0\u548c\u56de\u6eda\u4e0eDeployment\u7c7b\u4f3c\uff0c\u6b64\u5904\u4e0d\u518d\u6f14\u793a\u3002</p> \u53c2\u8003\u6587\u732e <p>https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/daemonset/</p> <p>https://kubernetes.io/docs/tasks/manage-daemon/update-daemon-set/</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#5cronjob","title":"5.CronJob","text":"<p>CronJob\uff08\u8ba1\u5212\u4efb\u52a1\uff0c\u7f29\u5199\u4e3acj\uff09\u7528\u4e8e\u4ee5\u65f6\u95f4\u4e3a\u57fa\u51c6\u5468\u671f\u6027\u5730\u6267\u884c\u4efb\u52a1\uff0c\u8fd9\u4e9b\u81ea\u52a8\u5316\u4efb\u52a1\u548c\u8fd0\u884c\u5728Linux\u6216UNIX\u7cfb\u7edf\u4e0a\u7684CronJob\u4e00\u6837\u3002</p> <p>CronJob\u5bf9\u4e8e\u521b\u5efa\u5b9a\u671f\u548c\u91cd\u590d\u4efb\u52a1\u975e\u5e38\u6709\u7528\uff0c\u4f8b\u5982\u6267\u884c\u5907\u4efd\u4efb\u52a1\u3001\u5468\u671f\u6027\u8c03\u5ea6\u7a0b\u5e8f\u63a5\u53e3\u3001\u53d1\u9001\u7535\u5b50\u90ae\u4ef6\u7b49\u3002</p> <p>\u5bf9\u4e8eKubernetes 1.8\u4ee5\u524d\u7684\u7248\u672c\uff0c\u9700\u8981\u6dfb\u52a0--runtime-config=batch/v2alpha1=true\u53c2\u6570\u81f3APIServer\u4e2d\uff0c\u7136\u540e\u91cd\u542fAPIServer\u548cController Manager\u624d\u53ef\u542f\u7528CronJob\u529f\u80fd\uff0c</p> <p>\u5bf9\u4e8e1.8\u4ee5\u540e\u7684\u7248\u672c\uff0c\u65e0\u987b\u4fee\u6539\u4efb\u4f55\u53c2\u6570\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\uff0c\u672c\u8282\u7684\u793a\u4f8b\u57fa\u4e8eKubernetes 1.8\u4ee5\u4e0a\u7684\u7248\u672c\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#51-\u521b\u5efacronjob","title":"5.1 \u521b\u5efaCronJob","text":"<p>\u521b\u5efaCronJob\u6709\u4e24\u79cd\u65b9\u5f0f\uff0c\u4e00\u79cd\u662f\u76f4\u63a5\u4f7f\u7528kubectl\u521b\u5efa\uff0c\u53e6\u4e00\u79cd\u662f\u4f7f\u7528YAML\u6587\u4ef6\u521b\u5efa\u3002</p> <p>\u4f7f\u7528kubectl\u521b\u5efaCronJob\u7684\u547d\u4ee4\u5982\u4e0b(\u65b0\u7248\u672c\u7684run\u547d\u4ee4\u65e0\u6cd5\u521b\u5efaCronJob\uff0c\u9700\u8981\u76f4\u63a5\u4f7f\u7528YAML\u6587\u4ef6\u521b\u5efa)\uff1a</p> <pre><code>$ kubectl create cronjob hello --image=busybox   --schedule=\"*/1 * * * *\" --restart=OnFailure -- /bin/sh -c \"date; echo Hello from the Kubernetes cluster\"\ncronjob.batch/hello created\n</code></pre> <ul> <li>hello\uff1a\u8ba1\u5212\u4efb\u52a1\u7684\u540d\u79f0\u3002</li> <li>schedule\uff1a\u8c03\u5ea6\u5468\u671f\uff0c\u5206\u522b\u4e3a\u5206\u3001\u65f6\u3001\u65e5\u3001\u6708\u3001\u5468\uff0c\u548cLinux\u914d\u7f6e\u65b9\u5f0f\u4e00\u81f4\u3002</li> <li>restart\uff1a\u91cd\u542f\u7b56\u7565\u3002\u00b7\u3000image\uff1a\u6267\u884c\u8ba1\u5212\u4efb\u52a1\u7684\u955c\u50cf\uff0c\u4e00\u822c\u662f\u5305\u542b\u4f9d\u8d56\u5de5\u5177\u7684\u955c\u50cf\uff0c\u6bd4\u5982curl\u3001Xtrabackup\u3002</li> <li>/bin/sh\uff1a\u8ba1\u5212\u4efb\u52a1\u7684\u64cd\u4f5c\u3002</li> </ul> <p>\u521b\u5efa\u5b8c\u6210\u4e4b\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528kubectl get cj hello -o yaml\u67e5\u770b\u521b\u5efa\u7684CronJob\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u5bf9\u5e94\u7684YAML\u6587\u4ef6\u5982\u4e0b\uff1a</p> <pre><code>$ kubectl get cj hello -o yaml\napiVersion: batch/v1\nkind: CronJob\nmetadata:\nname: hello\nnamespace: default\nspec:\nconcurrencyPolicy: Allow\nfailedJobsHistoryLimit: 1\njobTemplate:\nmetadata:\ncreationTimestamp: null\nname: hello\nspec:\ntemplate:\nmetadata:\ncreationTimestamp: null\nspec:\ncontainers:\n- command:\n- /bin/sh\n- -c\n- date; echo Hello from the Kubernetes cluster\nimage: busybox\nimagePullPolicy: Always\nname: hello\nresources: {}\nterminationMessagePath: /dev/termination-log\nterminationMessagePolicy: File\ndnsPolicy: ClusterFirst\nrestartPolicy: OnFailure\nschedulerName: default-scheduler\nsecurityContext: {}\nterminationGracePeriodSeconds: 30\nschedule: '*/1 * * * *'\nsuccessfulJobsHistoryLimit: 3\nsuspend: false\nstatus: {}\n</code></pre> <p>\u8bf4\u660e</p> <p>\u672c\u4f8b\u521b\u5efa\u4e00\u4e2a\u6bcf\u5206\u949f\u6267\u884c\u4e00\u6b21\u3001\u6253\u5370\u5f53\u524d\u65f6\u95f4\u548cHello from the Kubernetes cluster\u7684\u8ba1\u5212\u4efb\u52a1\u3002</p> <p>\u67e5\u770b\u521b\u5efa\u7684CronJob\uff1a</p> <pre><code>$ kubectl get cj\nNAME    SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE\nhello   */1 * * * *   False     0        74s             106s\n</code></pre> <p>\u8ba1\u5212\u4efb\u52a1\u5728\u6267\u884c\u65f6\u4f1a\u542f\u52a8\u4e00\u4e2a\u540d\u5b57\u4e3aCRONJOB_NAME-xxxxx\u7684Job\u53bb\u8c03\u5ea6\u4efb\u52a1\uff0c\u7b49\u5f851\u5206\u949f\u53ef\u4ee5\u67e5\u770b\u6267\u884c\u7684\u4efb\u52a1\uff08Jobs\uff09\uff1a</p> <pre><code>$ kubectl get jobs\nNAME             COMPLETIONS   DURATION   AGE\nhello-27720215   1/1           2s         98s\n</code></pre> <p>CronJob\u6bcf\u6b21\u8c03\u7528\u4efb\u52a1\u7684\u65f6\u5019\u4f1a\u521b\u5efa\u4e00\u4e2aJob\uff0cJob\u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3aJOB_NAME-xxx\u7684Pod\u6267\u884c\u547d\u4ee4\uff0c\u6210\u529f\u6267\u884c\u5b8c\u4efb\u52a1\u540e\uff0cPod\u72b6\u6001\u5c31\u4f1a\u53d8\u6210Completed\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ kubectl get pod\nNAME                   READY   STATUS      RESTARTS   AGE\nhello-27720215-zsk5n   0/1     Completed   0          2m22s\nhello-27720216-frh4w   0/1     Completed   0          82s\nk9s-shell-15624        1/1     Running     0          56d\n</code></pre> <p>\u6b64\u65f6\u53ef\u4ee5\u901a\u8fc7logs\u67e5\u770bPod\u7684\u6267\u884c\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs pod/hello-27720215-zsk5n\nThu Sep 15 03:36:13 UTC 2022\nHello from the Kubernetes cluster\n</code></pre> <p>\u5982\u679c\u8981\u5220\u9664CronJob\uff0c\u76f4\u63a5\u4f7f\u7528delete\u5373\u53ef\uff1a</p> <pre><code>$ kubectl delete cronjob hello\ncronjob.batch \"hello\" deleted\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#52-\u53ef\u7528\u53c2\u6570\u7684\u914d\u7f6e","title":"5.2 \u53ef\u7528\u53c2\u6570\u7684\u914d\u7f6e","text":"<p>\u5b9a\u4e49\u4e00\u4e2aCronJob\u7684YAML\u6587\u4ef6\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: batch/v1 # K8s\u5c0f\u4e8e1.21 batch/v1beta1\nkind: CronJob\nmetadata:\nlabels:\nrun: hello\nname: hello\nnamespace: default\nspec:\nconcurrencyPolicy: Allow\nfailedJobsHistoryLimit: 1\njobTemplate:\nmetadata:\ncreationTimestamp: null\nspec:\ntemplate:\nmetadata:\ncreationTimestamp: null\nlabels:\nrun: hello\nspec:\ncontainers:\n- args:\n- /bin/sh\n- -c\n- date; echo Hello from the Kubernetes cluster\nimage: busybox\nimagePullPolicy: Always\nname: hello\nresources: {}\nterminationMessagePath: /dev/termination-log\nterminationMessagePolicy: File\ndnsPolicy: ClusterFirst\nrestartPolicy: OnFailure\nschedulerName: default-scheduler\nsecurityContext: {}\nterminationGracePeriodSeconds: 30\nschedule: '*/1 * * * *'\nsuccessfulJobsHistoryLimit: 3\nsuspend: false\n</code></pre> <p>\u5176\u4e2d\u5404\u53c2\u6570\u7684\u8bf4\u660e\u5982\u4e0b\uff0c\u53ef\u4ee5\u6309\u9700\u4fee\u6539\uff1a</p> <ul> <li>schedule\uff1a\u8c03\u5ea6\u5468\u671f\uff0c\u548cLinux\u4e00\u81f4\uff0c\u5206\u522b\u662f\u5206\u3001\u65f6\u3001\u65e5\u3001\u6708\u3001\u5468\u3002</li> <li>restartPolicy\uff1a\u91cd\u542f\u7b56\u7565\uff0c\u548cPod\u4e00\u81f4\u3002</li> <li>concurrencyPolicy\uff1a\u5e76\u53d1\u8c03\u5ea6\u7b56\u7565\u3002\u53ef\u9009\u53c2\u6570\u5982\u4e0b\uff1a</li> <li>Allow\uff1a\u5141\u8bb8\u540c\u65f6\u8fd0\u884c\u591a\u4e2a\u4efb\u52a1\u3002</li> <li>Forbid\uff1a\u4e0d\u5141\u8bb8\u5e76\u53d1\u8fd0\u884c\uff0c\u5982\u679c\u4e4b\u524d\u7684\u4efb\u52a1\u5c1a\u672a\u5b8c\u6210\uff0c\u65b0\u7684\u4efb\u52a1\u4e0d\u4f1a\u88ab\u521b\u5efa\u3002</li> <li> <p>Replace\uff1a\u5982\u679c\u4e4b\u524d\u7684\u4efb\u52a1\u5c1a\u672a\u5b8c\u6210\uff0c\u65b0\u7684\u4efb\u52a1\u4f1a\u66ff\u6362\u4e4b\u524d\u7684\u4efb\u52a1\u3002</p> </li> <li> <p>suspend\uff1a\u5982\u679c\u8bbe\u7f6e\u4e3atrue\uff0c\u5219\u6682\u505c\u540e\u7eed\u7684\u4efb\u52a1\uff0c\u9ed8\u8ba4\u4e3afalse\u3002</p> </li> <li>successfulJobsHistoryLimit\uff1a\u4fdd\u7559\u591a\u5c11\u5df2\u5b8c\u6210\u7684\u4efb\u52a1\uff0c\u6309\u9700\u914d\u7f6e\u3002</li> <li>failedJobsHistoryLimit\uff1a\u4fdd\u7559\u591a\u5c11\u5931\u8d25\u7684\u4efb\u52a1\u3002</li> </ul> <p>\u76f8\u5bf9\u4e8eLinux\u4e0a\u7684\u8ba1\u5212\u4efb\u52a1\uff0cKubernetes\u7684CronJob\u66f4\u5177\u6709\u53ef\u914d\u7f6e\u6027\uff0c\u5e76\u4e14\u5bf9\u4e8e\u6267\u884c\u8ba1\u5212\u4efb\u52a1\u7684\u73af\u5883\u53ea\u9700\u542f\u52a8\u76f8\u5bf9\u5e94\u7684\u955c\u50cf\u5373\u53ef\u3002</p> <p>\u6bd4\u5982\uff0c\u5982\u679c\u9700\u8981Go\u6216\u8005PHP\u73af\u5883\u6267\u884c\u4efb\u52a1\uff0c\u5c31\u53ea\u9700\u8981\u66f4\u6539\u4efb\u52a1\u7684\u955c\u50cf\u4e3aGo\u6216\u8005PHP\u5373\u53ef\uff0c\u800c\u5bf9\u4e8eLinux\u4e0a\u7684\u8ba1\u5212\u4efb\u52a1\uff0c\u5219\u9700\u8981\u5b89\u88c5\u76f8\u5bf9\u5e94\u7684\u6267\u884c\u73af\u5883\u3002\u6b64\u5916\uff0cKubernetes\u7684CronJob\u662f\u521b\u5efaPod\u6765\u6267\u884c\u7684\uff0c\u66f4\u52a0\u6e05\u6670\u660e\u4e86\uff0c\u67e5\u770b\u65e5\u5fd7\u4e5f\u6bd4\u8f83\u65b9\u4fbf\u3002\u53ef\u89c1\uff0cKubernetes\u7684CronJob\u66f4\u52a0\u65b9\u4fbf\u548c\u7b80\u5355\u3002</p> <p>\u66f4\u591aCronJob\u7684\u5185\u5bb9\u53ef\u4ee5\u53c2\u8003Kubernetes\u7684\u5b98\u65b9\u6587\u6863\uff1a</p> <p>https://kubernetes.io/docs/home/</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/#6\u5c0f\u7ed3","title":"6.\u5c0f\u7ed3","text":"<p>\u672c\u7ae0\u5b66\u4e60\u4e86Kubernetes\u5f00\u7bb1\u5373\u7528\u7684\u8c03\u5ea6\u8d44\u6e90\uff0cDeployment\u662f\u5b9e\u9645\u4f7f\u7528\u65f6\u7528\u5f97\u6700\u591a\u7684\u4e00\u79cd\u7c7b\u578b\u3002</p> <p>Kubernetes\u539f\u751f\u7684\u8d44\u6e90\u8c03\u5ea6\u57fa\u672c\u4e0a\u53ef\u4ee5\u6ee1\u8db3\u5927\u90e8\u5206\u7684\u9700\u6c42\uff0c\u4f46\u662f\u5728\u5b9e\u9645\u4f7f\u7528\u65f6\uff0c\u53ef\u80fd\u8fd8\u4f1a\u6709\u4e00\u4e9b\u5b9a\u5236\u5316\u7684\u9700\u6c42\uff0c\u6bd4\u5982\u8ba1\u5212\u4efb\u52a1\u9700\u8981\u5728\u6bcf\u53f0\u670d\u52a1\u5668\u90fd\u8981\u6267\u884c\u7b49\u3002</p> <p>\u6b64\u7c7b\u9700\u6c42\u53ef\u4ee5\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u5f00\u53d1\u5b9a\u5236\u5316\u7684\u8d44\u6e90\u8c03\u5ea6\uff0c\u7c7b\u4f3c\u7684\u6709\u963f\u91cc\u4e91\u5f00\u6e90\u7684OpenKruise\u7b49\uff0c\u6709\u5174\u8da3\u7684\u8bfb\u8005\u53ef\u4ee5\u5173\u6ce8\u4e00\u4e0b\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/","title":"Kubernetes\u670d\u52a1\u53d1\u5e03\u57fa\u7840","text":"<p>\u5728\u4f20\u7edf\u67b6\u6784\u4e2d\uff0c\u7528\u6237\u8bbf\u95ee\u516c\u53f8\u5185\u7684\u670d\u52a1\u53ef\u80fd\u901a\u8fc7\u4e86\u591a\u5c42\u4ee3\u7406\u3001\u7f51\u5173\u3001\u9632\u706b\u5899\u7b49\u3002\u5728Kubernetes\u4e2d\uff0c\u8bbf\u95eeKubernetes\u4e2d\u7684\u5e94\u7528\u540c\u6837\u4e5f\u4f1a\u7ecf\u8fc7\u591a\u5c42\u4ee3\u7406\u3001\u7f51\u5173\u3001\u9632\u706b\u5899\u7b49\u3002</p> <p>\u4f46\u662f\u5728\u4f20\u7edf\u67b6\u6784\u4e2d\uff0c\u53ef\u80fd\u662f\u901a\u8fc7Nginx\u3001HAProxy\u3001LVS\u3001\u516c\u6709\u4e91\u7684SLB\u3001ELB\u7b49\u5b9e\u73b0\u7684\u8d1f\u8f7d\u5747\u8861\u548c\u57df\u540d\u8def\u7531\uff0c\u867d\u7136Kubernetes\u4e5f\u662f\u901a\u8fc7\u8bf8\u5982\u6b64\u7c7b\u7684\u6280\u672f\u5b9e\u73b0\u7684\u57df\u540d\u8def\u7531\u6216\u8005\u8d1f\u8f7d\u5747\u8861\uff0c\u53ea\u4e0d\u8fc7\u5bf9\u5e94\u7684\u540d\u5b57\u53eb\u6cd5\u53ef\u80fd\u6709\u6240\u53d8\u5316\uff0c\u8bfb\u8005\u4e0d\u8981\u628a\u8fd9\u4e9b\u5f53\u4f5c\u4e00\u4e2a\u6bd4\u8f83\u65b0\u9896\u7684\u4e1c\u897f\uff0c\u5176\u5b9e\u5185\u90e8\u7684\u5b9e\u73b0\u548c\u4e4b\u524d\u5e76\u65e0\u533a\u522b\u3002</p> <p>\u5728\u4f20\u7edf\u67b6\u6784\u914d\u7f6e\u591a\u4e2a\u76f8\u540c\u670d\u52a1\u7684\u8d1f\u8f7d\u5747\u8861\u53ef\u80fd\u4f7f\u7528\u7684\u662fNginx\u7684upstream\uff0c\u5728Kubernetes\u4e2d\u7528Service\u5b9e\u73b0\u3002</p> <p>\u5728\u4f20\u7edf\u67b6\u6784\u914d\u7f6e\u57df\u540d\u8bbf\u95ee\u5e94\u7528\u53ef\u80fd\u4f7f\u7528Nginx\u7684Server\u914d\u7f6e\uff0c\u5728Kubernetes\u4e2d\u7528Ingress\u5b9e\u73b0\u57df\u540d\u8def\u7531\u7684\u914d\u7f6e\uff08\u6700\u7ec8\u901a\u8fc7Ingress\u7684\u914d\u7f6e\u751f\u6210\u5bf9\u5e94\u63a7\u5236\u5668\u7684\u914d\u7f6e\uff0c\u6bd4\u5982\u4f7f\u7528Nginx\u4f5c\u4e3aIngress\u63a7\u5236\u5668\uff0cIngress\u8d44\u6e90\u6700\u7ec8\u751f\u6210\u7684\u5c31\u662fNginx\u7684\u914d\u7f6e\u6587\u4ef6\uff09\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#1\u6807\u7b7e\u548c\u9009\u62e9\u5668","title":"1.\u6807\u7b7e\u548c\u9009\u62e9\u5668","text":"<p>\u5f88\u591a\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u9700\u8981\u5bf9\u5404\u7c7b\u8d44\u6e90\u8fdb\u884c\u5206\u7ec4\u7ba1\u7406\uff0c\u6216\u8005\u540c\u4e00\u4e2a\u5e94\u7528\u7684Pod\u53ef\u80fd\u4f1a\u6839\u636e\u4e0d\u540c\u7684\u529f\u80fd\u8fdb\u884c\u5212\u5206\uff0c\u6bd4\u5982\u6709\u4e00\u4e2a\u540e\u7aef\u7684\u5e94\u7528\uff0c \u9700\u8981\u63d0\u4f9bAPI\u63a5\u53e3\u4f9b\u524d\u7aef\u8c03\u7528\uff0c\u4e5f\u9700\u8981\u8fdb\u884c\u4e00\u4e9b\u5468\u671f\u6027\u7684\u8ba1\u5212\u4efb\u52a1\uff0c\u76f8\u5f53\u4e8e\u540c\u4e00\u4e2a\u955c\u50cf\u5206\u4e24\u4e2a\u8eab\u4efd\u8fd0\u884c\uff0c\u6240\u4ee5\u5c31\u9700\u8981\u5bf9\u8fd9\u4e24\u4e2a\u8d44\u6e90\u6587\u4ef6\u7528\u6807\u7b7e\u8fdb\u884c\u533a\u5206\uff0c\u8fd9\u6837\u7684\u8bdd\u5c31\u53ef\u4ee5\u8ba9\u6d41\u91cf\u8fdb\u5165\u63d0\u4f9bAPI\u63a5\u53e3\u7684Pod\uff0c\u6267\u884c\u8ba1\u5212\u4efb\u52a1\u7684Pod\u4e0d\u63a5\u6536\u4efb\u4f55\u6d41\u91cf\uff0c</p> <p>\u5982\u56fe6.1\u6240\u793a\u3002</p> <p>)</p> <p>\u56fe6.1 \u540c\u4e00\u4e2a\u5e94\u7528\u4e0d\u540c\u7684\u8fd0\u884c\u65b9\u5f0f</p> <p>\u6b64\u65f6\u5176\u4ed6\u5e94\u7528\u8c03\u7528\u8be5\u5e94\u7528\u7684Service\uff08Service\u4e3a\u5bb9\u5668\u670d\u52a1\u7684\u5165\u53e3\uff0c\u53ef\u4ee5\u901a\u8fc7Service\u8bbf\u95ee\u7b26\u5408\u9009\u62e9\u5668\uff08Selector\uff09\u8fc7\u6ee4\u7684\u5bb9\u5668\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u7f29\u5199\u4e3asvc\uff0c\u5177\u4f53\u53ef\u4ee5\u53c2\u8003\u672c\u4e666.2\u8282\uff09\u65f6\uff0c \u6d41\u91cf\u53ea\u80fd\u5230\u8fbeapi\u7684Pod\uff0c\u4e0d\u4f1a\u5230\u8fbecron\u7684Pod\uff0c\u56e0\u4e3a\u9009\u62e9\u5668\u8fdb\u884c\u5339\u914d\u65f6\u662f\u201c\u4e0e\u201d\u7684\u5173\u7cfb\uff0c\u9700\u8981\u6240\u6709\u7684\u6807\u7b7e\uff08Label\uff09\u90fd\u8981\u5339\u914d\uff0c\u6240\u4ee5role=cronjob\u7684Pod\u4e0d\u4f1a\u88ab\u63a5\u5165\u6d41\u91cf\u3002</p> <p>\u4f7f\u7528\u6807\u7b7e\u540c\u6837\u53ef\u4ee5\u5bf9Kubernetes\u7684\u5176\u4ed6\u8d44\u6e90\u8fdb\u884c\u914d\u7f6e\uff0c\u5f53Kubernetes\u5bf9\u7cfb\u7edf\u7684\u4efb\u4f55API\u5bf9\u8c61\uff08\u5982Pod\u548c\u8282\u70b9\uff09\u8fdb\u884c\u201c\u5206\u7ec4\u201d\u65f6\uff0c\u4f1a\u5bf9\u5176\u6dfb\u52a0\u6807\u7b7e \uff08key=value\u5f62\u5f0f\u7684\u201c\u952e-\u503c\u5bf9\u201d\uff09\uff0c\u7528\u4ee5\u7cbe\u51c6\u5730\u9009\u62e9\u5bf9\u5e94\u7684API\u5bf9\u8c61\u3002</p> <p>\u800c\u9009\u62e9 \u5668\u5219\u662f\u9488\u5bf9\u5339\u914d\u5bf9\u8c61\u7684\u67e5\u8be2\u65b9\u6cd5\u3002</p> <p>\u5e38\u7528\u7684\u6807\u7b7etier\u53ef\u7528\u4e8e\u533a\u5206\u5bb9\u5668\u7684\u5c5e\u6027\uff0c\u5982frontend\u3001backend\uff1b\u6216\u8005\u4e00\u4e2arelease_track\u7528\u4e8e\u533a\u5206\u5bb9\u5668\u7684\u73af\u5883\uff0c\u5982canary\u3001production\u7b49\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#11-\u5b9a\u4e49\u6807\u7b7e","title":"1.1 \u5b9a\u4e49\u6807\u7b7e","text":"<p>\u5e94\u7528\u6848\u4f8b\uff1a\u516c\u53f8\u4e0exx\u94f6\u884c\u6709\u4e00\u6761\u4e13\u5c5e\u7684\u9ad8\u901f\u5149\u7ea4\u901a\u9053\uff0c\u6b64\u901a\u9053\u53ea\u80fd\u4e0e192.168.7.0\u7f51\u6bb5\u8fdb\u884c\u901a\u4fe1\uff0c\u56e0\u6b64\u53ea\u80fd\u5c06\u4e0exx\u94f6\u884c\u901a\u4fe1\u7684\u5e94\u7528\u90e8\u7f72\u5230192.168.7.0\u7f51\u6bb5\u6240\u5728\u7684\u8282\u70b9\u4e0a\uff0c\u6b64\u65f6\u53ef\u4ee5\u5bf9\u8282\u70b9\u6dfb\u52a0\u6807\u7b7e\uff1a</p> <pre><code>$ kubectl label node k8s-node02 region=subnet7\nnode/k8s-node02 labeled\n</code></pre> <p>\u7136\u540e\u53ef\u4ee5\u901a\u8fc7\u9009\u62e9\u5668\u5bf9\u5176\u7b5b\u9009\uff1a</p> <pre><code>$ kubectl get node -l region=subnet7\nNAME             STATUS   ROLES     AGE    VERSION\nk8s-node02   Ready    ingress   321d   v1.21.3\n</code></pre> <p>\u5220\u9664\u6807\u7b7e</p> <pre><code>$ kubectl label node giteego-k8s-n2 region-\nnode/giteego-k8s-n2 labeled\n\n$ kubectl get no -l region=subnet7\nNo resources found\n</code></pre> <p>\u6700\u540e\u5728Deployment\u6216\u5176\u4ed6\u63a7\u5236\u5668\u4e2d\u6307\u5b9a\u5c06Pod\u90e8\u7f72\u5230\u8be5\u8282\u70b9\uff1a</p> <pre><code> # \u53ef\u9009\uff0c\u6307\u5b9aNode\u8282\u70b9\nnodeSelector:\nregion: subnet7\nrestartPolicy: Always\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u7528\u540c\u6837\u7684\u65b9\u5f0f\u5bf9Service\u6dfb\u52a0\u6807\u7b7e\uff1a</p> <pre><code>$ kubectl label svc canary-v1 -n canary-production env=canary version=v1\nservice/canary-v1 labeled\n</code></pre> <p>\u67e5\u770b\u8be5Service\u7684\u6807\u7b7e\uff1a</p> <pre><code>$ kubectl get svc -n canary-production --show-labels\n</code></pre> <p>\u8fd8\u53ef\u4ee5\u67e5\u770b\u6240\u6709version\u4e3av1\u7684Service\uff1a</p> <pre><code>$ kubectl get svc --all-namespaces -l version=v1\n</code></pre> <p>\u4e0a\u8ff0\u6f14\u793a\u4e86\u5bf9\u8282\u70b9\u3001Service\u6dfb\u52a0\u81ea\u5b9a\u4e49\u6807\u7b7e\u7684\u65b9\u6cd5\uff0c\u5bf9\u5176\u4ed6\u8d44\u6e90\u6dfb\u52a0\u6807\u7b7e\u7684\u65b9\u5f0f\u76f8\u540c\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#12-\u9009\u62e9\u5668","title":"1.2 \u9009\u62e9\u5668","text":"<p>\u9009\u62e9\u5668\u4e3b\u8981\u7528\u4e8e\u8d44\u6e90\u7684\u5339\u914d\uff0c\u53ea\u6709\u7b26\u5408\u6761\u4ef6\u7684\u8d44\u6e90\u624d\u4f1a\u88ab\u8c03\u7528\u6216\u4f7f\u7528\uff0c\u53ef\u4ee5\u4f7f\u7528\u8be5\u65b9\u5f0f\u5bf9\u96c6\u7fa4\u4e2d\u7684\u5404\u7c7b\u8d44\u6e90\u8fdb\u884c\u5206\u914d\u3002</p> <p>\u7531\u4e8eKubernetes\u7684\u6838\u5fc3\u8d44\u6e90Deployment\u3001StatefulSet\u7ba1\u7406\u54ea\u4e9bPod\u662f\u901a\u8fc7\u9009\u62e9\u5668\u5b57\u6bb5\u51b3\u5b9a\u7684\uff0c\u901a\u8fc7Service\u8bbf\u95ee\u54ea\u4e9b\u540e\u7aefPod\u4e5f\u662f\u901a\u8fc7\u9009\u62e9\u5668\u5b57\u6bb5\u51b3\u5b9a\u7684\uff0c \u56e0\u6b64\u672c\u8282\u5c06\u4ecb\u7ecd\u5982\u4f55\u4f7f\u7528\u9009\u62e9\u5668\u8fc7\u6ee4\u51fa\u81ea\u5df1\u60f3\u8981\u7684\u8d44\u6e90\u3002</p> <p>\u9996\u5148\u4f7f\u7528--show-labels\u67e5\u770b\u76ee\u524d\u5df2\u6709\u7684\u6807\u7b7e\uff1a</p> <pre><code>$ kubectl get service --show-labels\nNAME                          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE    LABELS\nkubernetes                    ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   321d   component=apiserver,provider=kubernetes\nnginx-deployment-helm-nginx   ClusterIP   10.103.233.67   &lt;none&gt;        80/TCP    16d    app.kubernetes.io/instance=nginx-deployment,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/name=helm-nginx,app.kubernetes.io/version=1.16.0,helm.sh/chart=helm-nginx-0.1.0\n</code></pre> <p>\u9009\u62e9\u5339\u914dprovider\u4e3adetails\u6216\u8005kubernetes\u7684Service\uff1a</p> <pre><code>$ kubectl get svc -l \"provider in (details,kubernetes)\" --show-labels\nNAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE    LABELS\nkubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   321d   component=apiserver,provider=kubernetes\n</code></pre> <p>\u9009\u62e9provider\u4e3adetails\u6216kubernetes\u4f46\u4e0d\u5305\u62ecversion=v1\u7684Service\uff1a</p> <pre><code>$ kubectl get svc -l version!=v1,\"provider in (details,kubernetes)\" --show-labels\nNAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE    LABELS\nkubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   321d   component=apiserver,provider=kubernetes\n</code></pre> <p>\u9009\u62e9label\u7684key\u540d\u4e3aapp\u7684Service\uff1a <pre><code>$ kubectl get svc -l app --show-labels\n</code></pre></p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#13-\u4fee\u6539\u6807\u7b7e","title":"1.3 \u4fee\u6539\u6807\u7b7e","text":"<p>\u5728\u5b9e\u9645\u4f7f\u7528\u4e2d\uff0c\u8d44\u6e90\u6807\u7b7e\u7684\u66f4\u6539\u662f\u7ecf\u5e38\u53d1\u751f\u7684\u4e8b\u60c5\uff0c\u53ef\u4ee5\u4f7f\u7528overwrite \u53c2\u6570\u4fee\u6539\u6807\u7b7e\u3002</p> <p>\u6bd4\u5982\u5c06version=v1\u6539\u4e3aversion=v2\uff1a <pre><code>$ kubectl get svc -n canary-production --show-labels\n\n$ kubectl label svc canary-v1 -n canary-production version=v2 --overwrite\n\n$ kubectl get svc -n canary-production --show-labels\n</code></pre></p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#14-\u5220\u9664\u6807\u7b7e","title":"1.4 \u5220\u9664\u6807\u7b7e","text":"<p>\u6709\u65f6\u5019\u4e5f\u4f1a\u9700\u8981\u5220\u9664\u67d0\u8d44\u6e90\u7684\u6807\u7b7e\uff0c\u5728label\u7684key\u540d\u540e\u9762\u52a0\u4e00\u4e2a\u51cf\u53f7\u5373\u53ef\u5220\u9664\uff0c\u6bd4\u5982\u5220\u9664key\u540d\u4e3aversion\u7684\u6807\u7b7e\uff1a</p> <pre><code>$ kubectl label svc canary-v1 -n canary-product version-\n\n$ kubectl get svc -n canary-production --show-labels\n</code></pre> <pre><code># \u8bbe\u7f6e\u6807\u7b7e\n$ kubectl label node gitee-k8s-w02 monitor=prometheus\nnode/gitee-k8s-w02 labeled\n\n# \u5e26\u6709prometheus\u6807\u8bc6\u7b26\u7684\u6807\u7b7e\n$ kubectl label nodes gitee-k8s-w02 node-role.kubernetes.io/prometheus=\"true\"\n# \u5220\u9664\u6807\u7b7e\n$ kubectl label nodes gitee-k8s-w02 monitor-\nnode/gitee-k8s-w02 labeled\n\n# \u5e26\u6709prometheus\u6807\u8bc6\u7b26\u7684\u6807\u7b7e\n$ kubectl label nodes gitee-k8s-w02 node-role.kubernetes.io/prometheus-\n\n# label\u4e3anode-role.kubernetes.io/prometheus=\"true\"\nnodeSelector: {\"node-role.kubernetes.io/prometheus\":\"true\"}\n# \u4fee\u6539\u4e00\u4e2alabel\u7684\u503c\uff0c\u9700\u8981\u52a0\u4e0a\u2013overwrite\u53c2\u6570\uff1a\n$ kubectl label nodes k8s-test01 gpu=false --overwrite\n</code></pre> <p>\u53c2\u8003\u6587\u732e<p>https://www.qikqiak.com/k8strain2/scheduler/usage/#nodeSelector</p> </p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#2service","title":"2.Service","text":"<p>\u4f7f\u7528\u865a\u62df\u673a\u6216\u8005\u88f8\u5bb9\u5668\u90e8\u7f72\u5e94\u7528\u65f6\uff0c\u7a0b\u5e8f\u4e4b\u524d\u7684\u4e92\u76f8\u8bbf\u95ee\u4e00\u822c\u90fd\u662f\u4f7f\u7528\u5bbf\u4e3b\u673a\u7684IP\u5730\u5740\u548c\u7aef\u53e3\u53f7\u8fdb\u884c\u8bbf\u95ee\u7684\uff0c\u56e0\u4e3a\u5bbf\u4e3b\u673a\u7684IP\u5730\u5740\u4e00\u822c\u4e0d\u4f1a\u8f7b\u6613\u6539\u53d8\uff0c\u6240\u4ee5IP+\u7aef\u53e3\u7684\u65b9\u5f0f\u5e76\u6ca1\u6709\u4ec0\u4e48\u5927\u7684\u95ee\u9898\u3002</p> <p>\u800c\u4f7f\u7528Kubernetes\u7684Pod\u90e8\u7f72\u5e94\u7528\u65f6\uff0cPod\u5927\u90e8\u5206\u90fd\u662f\u968f\u673a\u5730\u90e8\u7f72\u81f3\u6700\u4f73\u7684\u8282\u70b9\u4e0a\uff0c\u5e76\u4e14\u7ecf\u5e38\u88ab\u5220\u9664\u91cd\u5efa\uff0c \u6240\u4ee5Pod\u7684IP\u5730\u5740\u5e76\u4e0d\u662f\u4e00\u6210\u4e0d\u53d8\u7684\uff0c\u8fd9\u6837\u7684\u8bdd\u670d\u52a1\u4e4b\u524d\u7684\u8bbf\u95ee\u5c31\u4e0d\u80fd\u4f7f\u7528IP+\u7aef\u53e3\u7684\u65b9\u5f0f\uff0c \u6240\u4ee5Service\u5e94\u8fd0\u800c\u751f\u3002</p> <p>Service\u4e3b\u8981\u7528\u4e8ePod\u4e4b\u95f4\u7684\u901a\u4fe1\uff0c\u5bf9\u4e8ePod\u7684IP\u5730\u5740\u800c\u8a00\uff0cService\u662f\u63d0\u524d\u5b9a\u4e49\u597d\u5e76\u4e14\u662f\u4e0d\u53d8\u7684\u8d44\u6e90\u7c7b\u578b\uff0c \u5728\u751f\u4ea7\u73af\u5883\u4e2d\u6700\u4f73\u7684\u5b9e\u8df5\u65b9\u5f0f\u5c31\u662f\u6bcf\u4e2a\u5e94\u7528\u4e92\u76f8\u8c03\u7528\u65f6\u4f7f\u7528Service\u7684\u540d\u5b57\u8fdb\u884c\u8fde\u63a5\uff0c \u800c\u975eIP\u5730\u5740\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#21-service\u7684\u57fa\u672c\u6982\u5ff5","title":"2.1 Service\u7684\u57fa\u672c\u6982\u5ff5","text":"<p>Kubernetes\u7684Pod\u5177\u6709\u751f\u547d\u5468\u671f\u7684\u6982\u5ff5\uff0c\u5b83\u53ef\u4ee5\u88ab\u521b\u5efa\u3001\u5220\u9664\u3001\u9500\u6bc1\uff0c\u4e00\u65e6\u88ab\u9500\u6bc1\u5c31\u610f\u5473\u7740\u751f\u547d\u5468\u671f\u7684\u7ed3\u675f\u3002</p> <p>\u901a\u8fc7ReplicaSet\u80fd\u591f\u52a8\u6001\u5730\u521b\u5efa\u548c\u9500\u6bc1Pod\uff0c\u4f8b\u5982\u8fdb\u884c\u6269\u7f29\u5bb9\u548c\u6267\u884c\u6eda\u52a8\u5347\u7ea7\u3002 \u6bcf\u4e2aPod\u90fd\u4f1a\u83b7\u53d6\u5230\u5b83\u81ea\u5df1\u7684IP\u5730\u5740\uff0c\u4f46\u662f\u8fd9\u4e9bIP\u5730\u5740\u4e0d\u603b\u662f\u7a33\u5b9a\u548c\u53ef\u4f9d\u8d56\u7684\uff0c\u8fd9\u6837\u5c31\u4f1a\u5bfc\u81f4\u4e00\u4e2a\u95ee\u9898\uff1a</p> <p>\u5728Kubernetes\u96c6\u7fa4\u4e2d\uff0c\u5982\u679c\u4e00\u7ec4Pod\uff08\u6bd4\u5982\u540e\u7aef\u7684Pod\uff09\u4e3a\u5176\u4ed6Pod\uff08\u6bd4\u5982\u524d\u7aef\u7684Pod\uff09\u63d0\u4f9b\u670d\u52a1\uff0c\u90a3\u4e48\u5982\u679c\u5b83\u4eec\u4e4b\u95f4\u4f7f\u7528Pod\u7684IP\u5730\u5740\u8fdb\u884c\u901a\u4fe1\uff0c\u5728Pod\u91cd\u5efa\u540e\uff0c\u5c06\u65e0\u6cd5\u518d\u8fdb\u884c\u8fde\u63a5\u3002</p> <p>\u4e3a\u4e86\u89e3\u51b3\u4e0a\u8ff0\u95ee\u9898\uff0cKubernetes\u5f15\u7528\u4e86Service\u8fd9\u6837\u4e00\u79cd\u62bd\u8c61\u6982\u5ff5\uff1a \u903b\u8f91\u4e0a\u7684\u4e00\u7ec4Pod\uff0c\u5373\u4e00\u79cd\u53ef\u4ee5\u8bbf\u95eePod\u7684\u7b56\u7565\uff0c\u901a\u5e38\u88ab\u79f0\u4e3a\u5fae\u670d\u52a1\u3002</p> <p>\u8fd9\u4e00\u7ec4Pod\u80fd\u591f\u88abService\u8bbf\u95ee\uff0c\u901a\u5e38\u662f\u901a\u8fc7Label Selector\uff08\u6807\u7b7e\u9009\u62e9\u5668\uff09\u5b9e\u73b0\u7684\uff0c\u5982\u56fe6.2\u6240\u793a\u3002</p> <p>)</p> <p>\u56fe6.2 Service\u4ee3\u7406\u6a21\u5f0f</p> <p>\u5047\u8bbe\u6709\u4e00\u4e2a\u7528\u4f5c\u56fe\u7247\u5904\u7406\u7684backend\uff08\u540e\u7aef\uff09\uff0c\u8fd0\u884c\u4e863\u4e2a\u526f\u672c\uff0c\u6bcf\u4e2a\u526f \u672c\u5177\u6709\u4e00\u4e2aapp=backend\u7684Label\uff0c\u8fd9\u4e9b\u526f\u672c\u662f\u53ef\u4e92\u6362\uff08\u65e0\u72b6\u6001\uff09\u7684\uff0c \u4e4b\u540e\u521b\u5efa\u4e00\u4e2aService\u6307\u5b9aSelector\u4e3aapp=backend\uff0c\u90a3\u4e48frontend\uff08\u524d\u7aef\uff09\u5373\u53ef\u901a\u8fc7\u8fd9\u4e2aService\u7684\u540d\u79f0\u76f4\u63a5\u8bbf\u95eebackend\uff0c\u6240\u4ee5frontend\u4e0d\u9700\u8981\u5173\u5fc3\u5b83\u8c03\u7528\u4e86\u54ea\u4e2abackend\u526f\u672c\u3002</p> <p>\u5373\u4f7f\u7ec4\u6210\u8fd9\u4e00\u7ec4backend\u7a0b\u5e8f\u7684Pod\u53d1\u751f\u4e86\u53d8\u5316\uff0cfrontend\u4e5f\u6ca1\u6709\u5fc5\u8981\u77e5\u9053\uff0c\u800c\u4e14\u4e5f\u4e0d\u9700\u8981\u8ddf\u8e2a\u8fd9\u4e00\u7ec4backend\u7684\u72b6\u6001\uff0c\u56e0\u4e3aService\u80fd\u591f\u89e3\u8026\u8fd9\u79cd\u5173\u8054\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#22-\u5b9a\u4e49service","title":"2.2 \u5b9a\u4e49Service","text":"<p>\u548c\u521b\u5efa\u5176\u4ed6\u7c7b\u578b\u7684\u8d44\u6e90\u4e00\u6837\uff0c\u5b9a\u4e49\u4e00\u4e2aYAML\u6587\u4ef6\uff0c\u5373\u53ef\u901a\u8fc7kubectl\u5ba2\u6237\u7aef\u521b\u5efa\u4e00\u4e2aService\u3002  \u4f8b\u5982\u6709\u4e00\u7ec4Pod\uff0c\u5b83\u4eec\u66b4\u9732\u4e869376\u7aef\u53e3\uff0c\u540c\u65f6\u5177\u6709<code>app=myapp</code>\u7684\u6807\u7b7e\uff0c\u6b64\u65f6\u53ef\u4ee5\u5b9a\u4e49Service\u7684YAML\u6587\u4ef6\u5982\u4e0b\uff1a</p> <pre><code>kind: Service\napiVersion: v1\nmetadata:\nname: my-service\nspec:\nselector:\napp: myapp\nports:\n- protocol: TCP\nport: 80\ntargetPort: 9376\n</code></pre> <p>\u4e0a\u8ff0\u6587\u4ef6\u914d\u7f6e\u521b\u5efa\u4e00\u4e2a\u540d\u4e3amy-service\u7684Service\u5bf9\u8c61\uff0c\u5b83\u4f1a\u5c06\u8bf7\u6c42\u4ee3\u7406 \u5230TCP\u7aef\u53e3\u4e3a9376\u5e76\u4e14\u5177\u6709\u6807\u7b7eapp=myapp\u7684Pod\u4e0a\u3002 \u8fd9\u4e2aService\u4f1a\u88ab\u5206\u914d\u4e00\u4e2aIP\u5730\u5740\uff0c\u901a\u5e38\u79f0\u4e3aClusterIP\uff0c\u5b83\u4f1a\u88ab\u670d\u52a1\u7684\u4ee3\u7406\u4f7f\u7528\uff0c \u5728\u96c6\u7fa4\u5185\u90e8\u53ef\u4ee5\u901a\u8fc7\u8be5ClusterIP\uff08\u4e0d\u5efa\u8bae\u4f7f\u7528ClusterIP\u8fdb\u884c\u8bbf\u95ee\uff09\u6216Service\u540d\u52a0\u4e0aport\u8fdb\u884c\u8bbf\u95ee\uff0c\u8be5\u793a\u4f8bmy-service:80\u5373\u53ef\u8bbf\u95ee\u5177\u6709app=myapp\u6807\u7b7e\u7684Pod\u76849376\u7aef\u53e3\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cService\u80fd\u591f\u5c06\u4e00\u4e2a\u63a5\u6536\u7aef\u53e3\u6620\u5c04\u5230\u4efb\u610f\u7684targetPort\uff0c \u5982\u679ctargetPort\u4e3a\u7a7a\uff0ctargetPort\u5c06\u88ab\u8bbe\u7f6e\u4e3a\u4e0ePort\u5b57\u6bb5\u76f8\u540c\u7684\u503c \u3002</p> <p>targetPort\u53ef\u4ee5\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u5f15\u7528backend Pod\u7684\u4e00\u4e2a\u7aef\u53e3\u7684\u540d\u79f0\uff0c\u8fd9\u6837\u7684\u8bdd\u5373\u4f7f\u66f4\u6539\u4e86Pod\u7684\u7aef\u53e3\uff0c\u4e5f\u4e0d\u4f1a\u5bf9Service\u7684\u8bbf\u95ee\u9020\u6210\u5f71\u54cd\u3002 Kubernetes Service\u80fd\u591f\u652f\u6301TCP\u3001UDP\u3001SCTP\u7b49\u534f\u8bae\uff0c\u9ed8\u8ba4\u4e3aTCP\u534f\u8bae\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#23-\u65e0\u9009\u62e9\u5668\u7684service\u548cendpoint","title":"2.3 \u65e0\u9009\u62e9\u5668\u7684Service\u548cEndpoint","text":"<p>\u4ee5\u4e0b\u60c5\u51b5\u5747\u53ef\u4f7f\u7528\u65e0\u9009\u62e9\u5668\u7684Service\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>\u5e0c\u671b\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528\u67d0\u4e2a\u56fa\u5b9a\u7684\u540d\u79f0\u800c\u975eIP\u5730\u5740\u8bbf\u95ee\u5916\u90e8\u7684\u4e2d\u95f4\u4ef6\u670d\u52a1\u3002</li> <li>\u5e0c\u671bService\u6307\u5411\u53e6\u4e00\u4e2aNamespace\u6216\u5176\u4ed6\u96c6\u7fa4\u4e2d\u7684\u670d\u52a1\u3002</li> <li>\u6b63\u5728\u5c06\u5de5\u4f5c\u8d1f\u8f7d\u8f6c\u79fb\u5230Kubernetes\u96c6\u7fa4\uff0c\u4f46\u662f\u4e00\u90e8\u5206\u670d\u52a1\u4ecd\u8fd0\u884c\u5728Kubernetes\u96c6\u7fa4\u4e4b\u5916\u7684backend\u3002</li> </ul> <p>\u5728\u8fd9\u4e9b\u573a\u666f\u4e2d\uff0c\u90fd\u80fd\u5b9a\u4e49\u6ca1\u6709\u9009\u62e9\u5668\u7684Service\uff0c\u53ea\u9700\u8981\u628a\u4e0a\u8ff0\u7684Service\u53bb\u9664Selector\u5b57\u6bb5\u5373\u53ef\u3002</p> <p>\u7531\u4e8e\u8fd9\u4e2aService\u6ca1\u6709\u9009\u62e9\u5668\uff0c\u5c31\u4e0d\u4f1a\u521b\u5efa\u76f8\u5173\u7684Endpoints\u5bf9\u8c61\uff0c\u53ef\u4ee5\u624b\u52a8\u521b\u5efa\u4e00\u4e2a\u540c\u540d\u7684Endpoints\uff08\u540c\u540d\u7684Service\u548cEndpoints\u4f1a\u81ea\u52a8\u5efa\u7acb\u94fe\u63a5\uff09\uff1a</p> <pre><code>kind: Service\napiVersion: v1\nmetadata:\nname: my-service\nspec:\nports:\n- protocol: TCP\nport: 80\ntargetPort: 9376\n---\nkind: Endpoints\napiVersion: v1\nmetadata:\nname: my-service\nsubsets:\n- addresses:\n- ip: 1.2.3.4\nports:\n- port: 9376\n</code></pre> <p>\u6ce8\u610f</p> <p>Endpoint IP \u5730 \u5740 \u4e0d \u80fd \u662f loopback(127.0.0.0/8)\u3001 link-loca(l169.254.0.0/16)\u6216\u8005link-local\u591a\u64ad\u5730\u5740(224.0.0.0/24)\u3002</p> <p>\u8bbf\u95ee\u6ca1\u6709\u9009\u62e9\u5668\u7684Service\u4e0e\u6709\u9009\u62e9\u5668\u7684Service\u7684\u539f\u7406\u76f8\u540c\uff0c\u901a\u8fc7Service\u540d\u79f0\u5373\u53ef\u8bbf\u95ee\uff0c\u8bf7\u6c42\u5c06\u88ab\u8def\u7531\u5230\u7528\u6237\u5b9a\u4e49\u7684Endpoint\uff0c\u8be5\u793a\u4f8b\u4e3a 1.2.3.4:9376\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#24-externalname-service","title":"2.4 ExternalName Service","text":"<p>ExternalName Service\u662fService\u7684\u7279\u4f8b\uff0c\u5b83\u6ca1\u6709\u9009\u62e9\u5668\uff0c\u4e5f\u6ca1\u6709\u5b9a\u4e49\u4efb\u4f55\u7aef\u53e3\u548cEndpoint\uff0c\u5b83\u901a\u8fc7\u8fd4\u56de\u8be5\u5916\u90e8\u670d\u52a1\u7684\u522b\u540d\u6765\u63d0\u4f9b\u670d\u52a1\u3002</p> <p>\u6bd4\u5982\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2aService\uff0c\u540e\u7aef\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u5916\u90e8\u57df\u540d\uff0c\u8fd9\u6837\u901a\u8fc7Service\u7684\u540d\u79f0\u5373\u53ef\u8bbf\u95ee\u8be5\u57df\u540d\u3002</p> <p>\u4f7f\u7528nslookup\u89e3\u6790\u4ee5\u4e0b\u6587\u4ef6\u5b9a\u4e49\u7684Service\uff0c\u96c6\u7fa4\u7684DNS\u670d\u52a1\u5c06\u8fd4\u56de\u4e00\u4e2a\u503c\u4e3amy.database.example.com\u7684CNAME\u8bb0\u5f55\uff1a</p> <pre><code>kind: Service\napiVersion: v1\nmetadata:\nname: my-service\nnamespace: prod\nspec:\ntype: ExternalName    externalName: my.database.example.com\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#25-service\u4ee3\u7406\u6a21\u5f0f","title":"2.5 Service\u4ee3\u7406\u6a21\u5f0f","text":"<p>\u5728Kubernetes\u96c6\u7fa4\u4e2d\uff0c\u6bcf\u4e2a\u8282\u70b9\u8fd0\u884c\u4e00\u4e2akube-proxy\u8fdb\u7a0b\u3002 kube-proxy \u8d1f\u8d23\u4e3aService\u5b9e\u73b0\u4e00\u79cdVIP\uff08\u865a\u62dfIP\uff09\u7684\u5f62\u5f0f\uff0c\u800c\u4e0d\u662fExternalName\u7684\u5f62\u5f0f\u3002 \u5728Kubernetesv 1.0\u7248\u672c\u4e2d\uff0c\u4ee3\u7406\u5b8c\u5168\u662fuserspace\u3002\u5728Kubernetesv 1.1\u7248\u4e2d\u65b0\u589e\u4e86iptables\u4ee3\u7406\uff0c\u4eceKubernetesv 1.2\u7248\u8d77\uff0c\u9ed8\u8ba4\u662fiptables\u4ee3\u7406\u3002</p> <p>\u4eceKubernetesv 1.8\u7248\u5f00\u59cb\u65b0\u589e\u4e86ipvs\u4ee3\u7406\uff0c\u751f\u4ea7\u73af\u5883\u5efa\u8bae\u4f7f\u7528ipvs\u6a21\u5f0f\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#251-iptables\u4ee3\u7406\u6a21\u5f0f","title":"2.5.1 iptables\u4ee3\u7406\u6a21\u5f0f","text":"<p>\u8fd9\u79cd\u6a21\u5f0f\u4e0b\uff0ckube-proxy\u4f1a\u76d1\u89c6Kubernetes master\u8282\u70b9\u5bf9Service\u5bf9\u8c61\u548cEndpoints\u5bf9\u8c61\u7684\u6dfb\u52a0\u548c\u79fb\u9664\u3002</p> <p>\u5bf9\u6bcf\u4e2aService\u5b83\u4f1a\u521b\u5efaiptables\u89c4\u5219\uff0c\u4ece\u800c\u6355\u83b7\u8be5Service\u7684ClusterIP\uff08\u865a\u62dfIP\uff09\u548c\u7aef\u53e3\u7684\u8bf7\u6c42\uff0c\u8fdb\u800c\u5c06\u8bf7\u6c42\u91cd\u5b9a\u5411 \u5230Service\u7684\u4e00\u7ec4backend\u4e2d\u7684\u67d0\u4e2aPod\u4e0a\u9762\u3002\u5bf9\u4e8e\u6bcf\u4e2aEndpoints\u5bf9\u8c61\uff0c\u5b83\u4e5f \u4f1a\u521b\u5efaiptables\u89c4\u5219\uff0c\u8fd9\u4e2a\u89c4\u5219\u4f1a\u9009\u62e9\u4e00\u4e2abackend Pod\u3002 \u9ed8\u8ba4\u7684\u7b56\u7565\u662f\u968f\u673a\u9009\u62e9\u4e00\u4e2abackend\uff0c\u5982\u679c\u8981\u5b9e\u73b0\u57fa\u4e8e\u5ba2\u6237\u7aefIP\u7684\u4f1a\u8bdd\u4eb2\u548c\u6027\uff0c\u53ef\u4ee5\u5c06service.spec.sessionAffinity\u7684\u503c\u8bbe\u7f6e\u4e3aClusterIP\uff08\u9ed8\u8ba4\u4e3a None\uff09\u3002</p> <p>\u548cuserspace\u4ee3\u7406\u7c7b\u4f3c\uff0c\u7f51\u7edc\u8fd4\u56de\u7684\u7ed3\u679c\u90fd\u662f\u5230\u8fbeService\u7684IP:Port\u8bf7\u6c42\uff0c\u8fd9\u4e9b\u8bf7\u6c42\u4f1a\u88ab\u4ee3\u7406\u5230\u4e00\u4e2a\u5408\u9002\u7684backend\uff0c\u4e0d\u9700\u8981\u5ba2\u6237\u7aef\u77e5\u9053\u5173\u4e8e Kubernetes\u3001Service\u6216Pod\u7684\u4efb\u4f55\u4fe1\u606f\u3002\u8fd9\u6bd4userspace\u4ee3\u7406\u66f4\u5feb\u3001\u66f4\u53ef\u9760\uff0c\u5e76\u4e14\u5f53\u521d\u59cb\u9009\u62e9\u7684Pod\u6ca1\u6709\u54cd\u5e94\u65f6\uff0ciptables\u4ee3\u7406\u80fd\u591f\u81ea\u52a8\u91cd\u8bd5\u53e6\u4e00\u4e2aPod\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#252-ipvs\u4ee3\u7406\u6a21\u5f0f","title":"2.5.2 ipvs\u4ee3\u7406\u6a21\u5f0f","text":"<p>\u5728\u6b64\u6a21\u5f0f\u4e0b\uff0ckube-proxy\u76d1\u89c6Kubernetes Service\u548cEndpoint\uff0c\u8c03\u7528 netlink\u63a5\u53e3\u4ee5\u76f8\u5e94\u5730\u521b\u5efaipvs\u89c4\u5219\uff0c \u5e76\u5b9a\u671f\u4e0eKubernetes Service\u548c Endpoint\u540c\u6b65ipvs\u89c4\u5219\uff0c\u4ee5\u786e\u4fddipvs\u72b6\u6001\u4e0e\u671f\u671b\u4fdd\u6301\u4e00\u81f4\u3002\u8bbf\u95ee\u670d\u52a1\u65f6\uff0c\u6d41\u91cf\u5c06\u88ab\u91cd\u5b9a\u5411\u5230\u5176\u4e2d\u4e00\u4e2a\u540e\u7aefPod\u3002</p> <p>\u4e0eiptables\u7c7b\u4f3c\uff0cipvs\u57fa\u4e8enetfilter\u94a9\u5b50\u51fd\u6570\uff0c\u4f46\u662fipvs\u4f7f\u7528\u54c8\u5e0c\u8868\u4f5c \u4e3a\u5e95\u5c42\u6570\u636e\u7ed3\u6784\u5e76\u5728\u5185\u6838\u7a7a\u95f4\u4e2d\u5de5\u4f5c\uff0c\u8fd9\u610f\u5473\u7740ipvs\u53ef\u4ee5\u66f4\u5feb\u5730\u91cd\u5b9a\u5411\u6d41\u91cf\uff0c \u5e76\u4e14\u5728\u540c\u6b65\u4ee3\u7406\u89c4\u5219\u65f6\u5177\u6709\u66f4\u597d\u7684\u6027\u80fd\uff0c\u6b64\u5916\uff0cipvs\u4e3a\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u63d0 \u4f9b\u4e86\u66f4\u591a\u7684\u9009\u9879\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>rr\uff1a\u8f6e\u8be2\u3002 </li> <li>lc\uff1a\u6700\u5c11\u8fde\u63a5\u3002</li> <li>dh\uff1a\u76ee\u6807\u54c8\u5e0c\u3002</li> <li>sh\uff1a\u6e90\u54c8\u5e0c\u3002</li> <li>sed\uff1a\u9884\u8ba1\u5ef6\u8fdf\u6700\u77ed\u3002</li> <li>nq\uff1a\u4ece\u4e0d\u6392\u961f\u3002</li> </ul> <p>\u6ce8\u610f</p> <p>Kube-proxy\u4f7f\u7528ipvs\u6a21\u5f0f\u5fc5\u987b\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u5b89\u88c5ipvs\u6a21\u5757\uff0c\u5982\u679c\u6ca1\u6709\u5b89\u88c5 ipvs\u6a21\u5757\uff0c\u5c06\u4f1a\u9ed8\u8ba4\u4f7f\u7528iptables\u6a21\u5f0f\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#26-\u591a\u7aef\u53e3service","title":"2.6 \u591a\u7aef\u53e3Service","text":"<p>\u5728\u8bb8\u591a\u60c5\u51b5\u4e0b\uff0cService\u53ef\u80fd\u9700\u8981\u66b4\u9732\u591a\u4e2a\u7aef\u53e3\uff0c\u5bf9\u4e8e\u8fd9\u79cd\u60c5\u51b5\uff0cKubernetes\u652f\u6301Service\u5b9a\u4e49\u591a\u4e2a\u7aef\u53e3\uff0c\u4f46\u4f7f\u7528\u591a\u4e2a\u7aef\u53e3\u65f6\uff0c\u5fc5\u987b\u63d0\u4f9b\u6240\u6709\u7aef\u53e3\u7684\u540d\u79f0\uff0c</p> <p>\u4f8b\u5982\u5c06Service\u768480\u7aef\u53e3\u4ee3\u7406\u5230\u540e\u7aef\u76849376\uff0c443\u7aef\u53e3\u4ee3\u7406\u5230\u540e\u7aef\u76849377\uff1a</p> <pre><code>kind: Service\napiVersion: v1\nmetadata:\nname: my-service\nspec:\nselector:\napp: myapp\nports:\n- name: http\nprotocol: TCP\nport: 80\ntargetPort: 9376\n- name: https\nprotocol: TCP\nport: 443\ntargetPort: 9377\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#27-service\u7684\u7c7b\u578b","title":"2.7 Service\u7684\u7c7b\u578b","text":"<p>Kubernetes Service Type\uff08\u670d\u52a1\u7c7b\u578b\uff09\u4e3b\u8981\u5305\u62ec\u4ee5\u4e0b\u51e0\u79cd\uff1a</p> <ul> <li>ClusterIP\uff1a\u5728\u96c6\u7fa4\u5185\u90e8\u4f7f\u7528\uff0c\u9ed8\u8ba4\u503c\uff0c\u53ea\u80fd\u4ece\u96c6\u7fa4\u4e2d\u8bbf\u95ee\u3002</li> <li>NodePort\uff1a\u5728\u6240\u6709\u5b89\u88c5\u4e86Kube-Proxy\u7684\u8282\u70b9\u4e0a\u6253\u5f00\u4e00\u4e2a\u7aef\u53e3\uff0c\u6b64\u7aef\u53e3\u53ef\u4ee5\u4ee3\u7406\u81f3\u540e\u7aefPod\uff0c\u53ef\u4ee5\u901a\u8fc7NodePort\u4ece\u96c6\u7fa4\u5916\u90e8\u8bbf\u95ee\u96c6\u7fa4\u5185\u7684 \u670d\u52a1\uff0c\u683c\u5f0f\u4e3aNodeIP:NodePort\u3002 </li> <li>LoadBalancer\uff1a\u4f7f\u7528\u4e91\u63d0\u4f9b\u5546\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u516c\u5f00\u670d\u52a1\uff0c\u6210\u672c\u8f83\u9ad8\u3002</li> <li>ExternalName\uff1a\u901a\u8fc7\u8fd4\u56de\u5b9a\u4e49\u7684CNAME\u522b\u540d\uff0c\u5c06Service\u6620\u5c04\u5230\u53ef\u88ab DNS\u89e3\u6790\u7684\u5176\u4ed6\u57df\u540d\uff0c\u9700\u89811.7\u6216\u66f4\u9ad8\u7248\u672ckube-dns\u7684\u652f\u6301\u3002</li> </ul> <p>\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230Kubernetes\u540e\uff0c\u9700\u8981\u5c06\u67d0\u4e9b\u670d\u52a1\u53d1\u5e03\u81f3Kubernetes\u96c6\u7fa4 \u5916\uff0c\u4e5f\u5c31\u662f\u53ef\u4ee5\u88ab\u5176\u4ed6\u4eba\u8bbf\u95ee\u6216\u8005\u8c03\u7528\uff0c\u6bd4\u8f83\u5e38\u7528\u7684\u53d1\u5e03\u65b9\u5f0f\u662fIP+\u7aef\u53e3\u6216\u4f7f \u7528\u57df\u540d\u7684\u65b9\u5f0f\u3002</p> <p>IP+\u7aef\u53e3\u7684\u65b9\u5f0f\u53ef\u4ee5\u7528NodePort\u7c7b\u578bService\u8fdb\u884c\u53d1\u5e03\uff0c\u57df\u540d\u7684\u65b9\u5f0f\u53ef\u4ee5\u4f7f\u7528Ingress\uff086.3\u8282\u4ecb\u7ecd\uff09\u8fdb\u884c\u53d1\u5e03\u3002</p> <p>\u4ee5NodePort\u4e3a\u4f8b\uff0c\u5982\u679c\u5c06Service\u7684type\u5b57\u6bb5\u8bbe\u7f6e\u4e3aNodePort\uff0c\u5219Kubernetes\u5c06\u4ece--service-nodeport-range\u53c2\u6570\u6307\u5b9a\u7684\u8303\u56f4\uff08\u9ed8\u8ba4\u4e3a30000\uff5e 32767\uff09\u4e2d\u81ea\u52a8\u5206\u914d\u7aef\u53e3\uff0c \u4e5f\u53ef\u4ee5\u624b\u52a8\u6307\u5b9aNodePort\uff0c\u521b\u5efa\u8be5Service\u540e\uff0c\u96c6\u7fa4\u6bcf\u4e2a\u8282\u70b9\u90fd\u5c06\u66b4\u9732\u4e00\u4e2a\u7aef\u53e3\uff0c\u901a\u8fc7\u67d0\u4e2a\u5bbf\u4e3b\u673a\u7684IP+\u7aef\u53e3\u5373\u53ef\u8bbf\u95ee\u540e\u7aef\u7684\u5e94\u7528\uff0c \u4e5f\u53ef\u4ee5\u524d\u7aef\u91c7\u7528\u4e00\u4e2a\u53cd\u4ee3\u670d\u52a1\u5668\u4ee3\u7406\u81f3\u591a\u4e2aNode\u8282\u70b9+\u7aef\u53e3\uff0c\u9632\u6b62\u5355\u4e2aNode\u8282\u70b9\u6545\u969c\u5f15\u8d77\u7684\u670d\u52a1\u4e0d\u53ef\u7528\u3002</p> <p>\u5b9a\u4e49\u4e00\u4e2aNodePort\u7c7b\u578b\u7684Service\u683c\u5f0f\u5982\u4e0b\uff08 Kubernetes\u96c6\u7fa4\u5b89\u88c5\u65f6Dashboard\u7684\u8bbf\u95ee\u5c31\u662f\u57fa\u4e8eNodePort\u7c7b\u578b\u7684Service\u8fdb\u884c\u8bbf\u95ee\u7684\uff0c6.3\u8282\u5c06\u4f1a\u8bb2 \u5230\u5982\u4f55\u4f7f\u7528\u57df\u540d\u8bbf\u95eeKubernetes\u96c6\u7fa4\u7684\u5e94\u7528\uff09\uff1a</p> <pre><code>kind: Service\napiVersion: v1\nmetadata:\nlabels:\nk8s-app: kubernetes-dashboard\nname: kubernetes-dashboard\nnamespace: kube-system\nspec:\ntype: NodePort\nports:\n- port: 443\ntargetPort: 8443\nnodePort: 30000\nselector:\nk8s-app: kubernetes-dashboard\n</code></pre> <p>\u53c2\u8003\u6587\u732e</p> <p>https://www.qikqiak.com/k8strain/network/service/</p> <p>\u5176\u4ed6\u670d\u52a1\u8bbf\u95ee\u65b9\u5f0f\u8be6\u60c5\u53c2\u89c1\u4ee5\u4e0b\u7f51\u5740\uff1a</p> <p>https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#28-kubernetes\u670d\u52a1\u53d1\u73b0","title":"2.8 Kubernetes\u670d\u52a1\u53d1\u73b0","text":"<p>Kubernetes\u652f\u6301\u4e24\u79cd\u7c7b\u578b\u7684\u670d\u52a1\u53d1\u73b0\uff1a\u73af\u5883\u53d8\u91cf\u548cDNS\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#281-\u57fa\u4e8e\u73af\u5883\u53d8\u91cf\u7684\u670d\u52a1\u53d1\u73b0","title":"2.8.1 \u57fa\u4e8e\u73af\u5883\u53d8\u91cf\u7684\u670d\u52a1\u53d1\u73b0","text":"<p>\u5f53Pod\u90e8\u7f72\u5230\u4e00\u4e2aNode\u8282\u70b9\u540e\uff0c\u8be5Node\u8282\u70b9\u4e0a\u7684Kubelet\u4f1a\u5728\u8be5Pod\u5185\u90e8\u8bbe\u7f6e\u4e00\u7ec4\u73af\u5883\u53d8\u91cf\uff0c  \u8fd9\u4e9b\u73af\u5883\u53d8\u91cf\u662f\u6839\u636e\u6d3b\u8dc3\u7684Service\u751f\u6210\u5e76\u4ee5{SERVICE_NAME}SERVICE_HOST\u548c{SERVICE_NAME}_SERVICE_PORT\u683c\u5f0f\u547d\u540d\u7684\u53d8\u91cf\uff0c\u5176\u4e2d\u670d\u52a1\u540d\u90fd\u8f6c\u6362\u4e3a\u5927\u5199\u5b57\u6bcd\uff0c\u201c.\u201d\u548c\u201c-\u201d\u8f6c\u6362\u4e3a\u201c\u201d\u3002 </p> <p>\u5f53\u4e00\u4e2aPod\u8fd0\u884c\u5230\u8282\u70b9\u65f6\uff0ckubelet\u4f1a\u4e3a\u6bcf\u4e2a\u5bb9\u5668\u6dfb\u52a0\u4e00\u7ec4\u73af\u5883\u53d8\u91cf\uff0cPod\u5bb9\u5668\u4e2d\u7684\u7a0b\u5e8f\u5c31\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u73af\u5883\u53d8\u91cf\u53d1\u73b0Service\u3002</p> <p><code>busybox.yaml</code></p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: busybox\nnamespace: default\nspec:\ncontainers:\n- image: busybox\ncommand:\n- sleep\n- \"3600\"\nimagePullPolicy: IfNotPresent\nname: busybox\nrestartPolicy: Always\n</code></pre> <pre><code>[root@ci-base pod]# kubectl create -f busybox.yaml\npod/busybox created\n\n[root@ci-base pod]# kubectl get pod\nNAME      READY   STATUS    RESTARTS   AGE\nbusybox   1/1     Running   0          2s\n\n[root@ci-base pod]# kubectl exec -it busybox sh\n/ # env\nKUBERNETES_PORT=tcp://10.96.0.1:443\nKUBERNETES_SERVICE_PORT=443\nHOSTNAME=busybox\nSHLVL=1\nHOME=/root\nHU_NGINX_PORT_80_TCP=tcp://10.102.125.25:80\nHU_NGINX_PORT_443_TCP_ADDR=10.102.125.25\nHU_NGINX_PORT_443_TCP_PORT=443\nHU_NGINX_PORT_443_TCP_PROTO=tcp\nHU_NGINX_SERVICE_PORT_HTTP=80\nTERM=xterm\nKUBERNETES_PORT_443_TCP_ADDR=10.96.0.1\nHU_NGINX_SERVICE_PORT_HTTPS=443\nHU_NGINX_PORT_443_TCP=tcp://10.102.125.25:443\nPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nHU_NGINX_SERVICE_HOST=10.102.125.25\nKUBERNETES_PORT_443_TCP_PORT=443\nKUBERNETES_PORT_443_TCP_PROTO=tcp\nHU_NGINX_SERVICE_PORT=80\nHU_NGINX_PORT=tcp://10.102.125.25:80\nKUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443\nKUBERNETES_SERVICE_PORT_HTTPS=443\nKUBERNETES_SERVICE_HOST=10.96.0.1\nPWD=/\nHU_NGINX_PORT_80_TCP_ADDR=10.102.125.25\nHU_NGINX_PORT_80_TCP_PORT=80\nHU_NGINX_PORT_80_TCP_PROTO=tcp\n\n/ # echo ${HU_NGINX_SERVICE_HOST}\n10.102.125.25\n/ # echo ${HU_NGINX_SERVICE_PORT}\n80\n</code></pre> <pre><code>[root@ci-base pod]# kubectl get svc\nNAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE\nhu-nginx     ClusterIP   10.102.125.25   &lt;none&gt;        80/TCP,443/TCP   7m52s\n</code></pre> <p>\u6ce8\u610f</p> <ul> <li> <p>Pod\u548cService\u7684\u521b\u5efa\u987a\u5e8f\u662f\u6709\u8981\u6c42\u7684\uff0cService\u5fc5\u987b\u5728Pod\u521b\u5efa\u4e4b\u524d\u521b\u5efa\uff0c\u65b0\u521b\u5efa\u7684Pod\u4f1a\u81ea\u52a8\u6ce8\u5165Service\u7684\u73af\u5883\u53d8\u91cf\u3002\u5fc5\u987b\u5148\u58f0\u660eService\u4e3aPod\u505a\u4ee3\u7406\uff0c\u518d\u521b\u5efaPod\uff0c\u8fd9\u6837Pod\u5c31\u6709\u4e86Service\u7684\u73af\u5883\u53d8\u91cf</p> </li> <li> <p>Pod\u53ea\u80fd\u83b7\u53d6\u540c\u4e00Namespace\u4e2d\u7684Service\u7684\u73af\u5883\u53d8\u91cf\uff0c\u5982\u679cService\u548cPod\u8de8\u547d\u540d\u7a7a\u95f4\uff0c\u5219\u65e0\u6cd5\u83b7\u53d6\u73af\u5883\u53d8\u91cf\u3002</p> </li> </ul>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#2\u57fa\u4e8edns\u7684\u670d\u52a1\u53d1\u73b0","title":"2\uff0e\u57fa\u4e8eDNS\u7684\u670d\u52a1\u53d1\u73b0","text":"<p>Kubernetes\u8fdb\u884c\u670d\u52a1\u53d1\u73b0\u7684\u53e6\u4e00\u79cd\u65b9\u5f0f\u662f\u57fa\u4e8eKubernetes\u5185\u90e8\u7684DNS\u8bb0 \u5f55\uff0c\u65b0\u7248Kubernetes\u9ed8\u8ba4\u4f7f\u7528CoreDNS\u4f5c\u4e3a\u96c6\u7fa4\u7684\u5185\u90e8DNS\uff0c \u4e00\u822cCoreDNS\u7684 Service\u5730\u5740\u4e3aService\u7f51\u6bb5\u7684\u7b2c10\u4e2aIP\uff0c\u6bd4\u598210.96.0.10\uff0c\u7aef\u53e353\uff0c \u96c6\u7fa4\u5185Pod\u53ef\u901a\u8fc7\u8be5\u5730\u5740\u548c\u7aef\u53e3\u8fdb\u884cKubernetes\u5185\u90e8\u7684\u670d\u52a1\u89e3\u6790\u3002</p> <p>DNS\u670d\u52a1\u5668\u76d1\u542c Kubernetes\u521b\u5efa\u7684Service\uff0c\u7136\u540e\u7ed9\u6bcf\u4e2aService\u6dfb\u52a0\u4e00\u7ec4DNS\u8bb0\u5f55\uff0c\u96c6\u7fa4\u4e2d\u7684 Pod\u5c31\u80fd\u901a\u8fc7Kubernetes\u5185\u90e8\u7684DNS\u89e3\u6790\u5230Service\u7684IP\uff0c\u4e5f\u5c31\u662fService\u7684ClusterIP\u3002</p> <p>\u4e3a\u670d\u52a1\u63d0\u4f9b\u540d\u79f0\u57df\u540d\u7684\u8bbf\u95ee\u3002</p> <ul> <li>DNS\u670d\u52a1\u76d1\u89c6Kubernetes API\uff0c\u4e3a\u6bcf\u4e00\u4e2aService\u521b\u5efaDNS\u8bb0\u5f55\u7528\u4e8e\u57df\u540d\u89e3\u6790\u3002</li> <li>ClusterIP A\u8bb0\u5f55\u683c\u5f0f\uff1a<code>&lt;service-name&gt;.&lt;namespace-name&gt;.svc.cluster.local</code> \u793a\u4f8b\uff1amy-svc.my-namespace.svc.cluster.local</li> </ul> <p>\u4f8b\u5982\u521b\u5efa\u4e00\u4e2a\u542b\u6709nslookup\u547d\u4ee4\u7684\u5bb9\u5668 \uff0c  \u6d4b\u8bd5\u89e3\u6790kube-dns\u7684Service\uff08\u6307\u5b9a\u7684Service\u540d\u4e3akube-dns.kube-system\uff0c\u540c\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u53ef\u4ee5\u7701\u7565.kube-system\uff09\uff1a <pre><code>$ kubectl run redis --image=redis:3.2.10-alpine\n$ kubectl get pod\nNAME    READY   STATUS    RESTARTS   AGE\nredis   1/1     Running   0          28s\n\n$ kubectl exec -ti redis -- nslookup kube-dns.kube-system\nnslookup: can't resolve '(null)': Name does not resolve\n\nName:      kube-dns.kube-system\nAddress 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local\n</code></pre></p> <p>Kubernetes\u8fd8\u652f\u6301\u547d\u540d\u7aef\u53e3\u7684DNS SRV\uff08\u670d\u52a1)\u8bb0\u5f55\uff0c\u5982\u679c\u4e00\u4e2a\u670d\u52a1\u6709\u4e00\u4e2aTCP\u7aef\u53e3\uff0c\u5e76\u4e14\u8be5\u7aef\u53e3\u7684\u540d\u79f0\u4e3ahttp\uff0c \u5219\u53ef\u4ee5\u4f7f\u7528\"_http._tcp.{SERVICE_NAME}.{SERVICE_NAMESPACE}\"\u6267\u884cDNS SRV\u67e5\u8be2\uff0c\u4ee5\u67e5\u8be2\u8be5Service\u7684IP\u548c\u7aef\u53e3\u3002</p> <p>Kubernetes\u76ee\u524d\u652f\u6301\u73af\u5883\u53d8\u91cf\u548cDNS\u4e24\u79cd\u7b80\u5355\u7684\u670d\u52a1\u53d1\u73b0\uff0c\u4e24\u79cd\u65b9\u5f0f\u5404\u6709 \u4f18\u7f3a\u70b9\uff0c\u5176\u4e2d\u73af\u5883\u53d8\u91cf\u5f62\u5f0f\u9700\u8981\u5f00\u53d1\u4eba\u5458\u81ea\u884c\u5b9e\u73b0\u53d8\u91cf\u7684\u89e3\u6790\uff0c \u800c\u57fa\u4e8eDNS\u7684 \u670d\u52a1\u53d1\u73b0\u4e0d\u9700\u8981\u591a\u4f59\u7684\u4ee3\u7801\uff0c\u76f4\u63a5\u901a\u8fc7http://SERVICE_NAME:SERVICE_PORT \u5373\u53ef\u8c03\u7528\u5176\u4ed6\u7ec4\u4ef6\uff0c\u4f46\u662f\u4f1a\u6709\u4e00\u4e9b\u7f51\u7edc\u4e0a\u7684\u6d88\u8017\u3002 \u76f8\u5bf9\u4e8eKubernetes\u7684\u670d\u52a1\u53d1\u73b0\uff0c\u4e1a\u754c\u66f4\u5e38\u7528\u7684\u53ef\u80fd\u662f\u57fa\u4e8eSpring Cloud\u7684Eureka\uff0c\u6216\u8005\u662fConsul\u7b49\u5de5\u5177\u5b9e\u73b0\u5fae\u670d\u52a1\u7684\u81ea\u52a8\u53d1\u73b0\uff0c \u4e0d\u8fc7\u5e76\u4e0d\u662f\u6240\u6709\u7684\u9879\u76ee\u90fd\u662f\u57fa\u4e8eSpring Cloud\u5168\u5bb6\u6876\u8fdb\u884c\u5f00\u53d1\u7684\uff0c\u800c\u4f7f\u7528\u5176\u4ed6\u5de5\u5177\u6216Kubernetes\u73af\u5883\u53d8\u91cf\u8fdb\u884c\u670d\u52a1\u53d1\u73b0\uff0c \u4e5f\u4f1a\u5e26\u6765\u5b9e\u73b0\u670d\u52a1\u53d1\u73b0\u903b\u8f91\u4ee3\u7801\u65f6\u95f4\u4e0a\u7684\u6d88\u8017\uff0c\u6240\u4ee5\u53ef\u80fd\u57fa\u4e8eKubernetes DNS\u7684\u670d\u52a1\u53d1\u73b0\u66f4\u4e3a\u7b80\u5355\u9ad8\u6548\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#3ingress","title":"3.Ingress","text":"<p>Ingress\u4e3aKubernetes\u96c6\u7fa4\u4e2d\u7684\u670d\u52a1\u63d0\u4f9b\u4e86\u5165\u53e3\uff0c\u53ef\u4ee5\u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\u3001 SSL\u7ec8\u6b62\u548c\u57fa\u4e8e\u540d\u79f0\uff08\u57df\u540d\uff09\u7684\u865a\u62df\u4e3b\u673a\u3001\u5e94\u7528\u7684\u7070\u5ea6\u53d1\u5e03\u7b49\u529f\u80fd\uff0c\u5728\u751f\u4ea7\u73af \u5883\u4e2d\u5e38\u7528\u7684Ingress\u6709Treafik\u3001Nginx\u3001HAProxy\u3001Istio\u7b49\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#31-\u57fa\u672c\u6982\u5ff5","title":"3.1 \u57fa\u672c\u6982\u5ff5","text":"<p>\u4e0a\u4e00\u8282\u8bb2\u89e3Service\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7NodePort\u7c7b\u578b\u7684Service\u5728\u96c6\u7fa4\u5916 \u90e8\u8bbf\u95eeKubernetes\u96c6\u7fa4\u5185\u7684\u5e94\u7528\uff0c\u7136\u800c\u901a\u8fc7IP\u5730\u5740+\u7aef\u53e3\u7684\u8bbf\u95ee\u6a21\u5f0f\u5e76\u4e0d\u662f\u5e94 \u7528\u53d1\u5e03\u7684\u6700\u4f73\u5b9e\u8df5\uff0c\u4e5f\u4e0d\u662f\u63a8\u8350\u7684\u53d1\u5e03\u65b9\u5f0f\uff0c\u76f8\u5bf9\u4e8eIP\u5730\u5740\uff0c\u6211\u4eec\u66f4\u559c\u6b22\u5728 \u6d4f\u89c8\u5668\u8f93\u5165\u57df\u540d\u8bbf\u95ee\u5e94\u7528\uff0c \u90a3\u4e48\u5728Kubernetes\u96c6\u7fa4\u4e2d\u5982\u4f55\u4f7f\u7528\u57df\u540d\u53d1\u5e03\u670d\u52a1\u5462\uff1f</p> <p>\u5728\u6ca1\u6709\u4f7f\u7528Kubernetes\u7684\u4f20\u7edf\u67b6\u6784\u4e2d\uff0c\u90e8\u7f72\u4e00\u4e2a\u5e94\u7528\u5e76\u4f7f\u7528\u57df\u540d\u8fdb\u884c\u53d1 \u5e03\u7684\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <p>1\uff09\u90e8\u7f72\u5e94\u7528\u81f3\u5bbf\u4e3b\u673a\uff0c\u542f\u52a8\u5e94\u7528\u5e76\u66b4\u9732\u4e00\u4e2a\u7aef\u53e3\u53f7\u3002</p> <p>2\uff09\u901a\u8fc7Nginx\u6216\u5176\u4ed6\u4ee3\u7406\u5de5\u5177\u914d\u7f6e\u57df\u540d\uff0c\u5e76\u4ee3\u7406\u81f3\u540e\u7aef\u5e94\u7528\u3002</p> <p>3\uff09\u5728\u57df\u540d\u5382\u5546\u8fdb\u884c\u57df\u540d\u89e3\u6790\uff0c\u8bbe\u7f6eDNS\u8bb0\u5f55\u81f3Nginx\u6216\u5176\u4ed6\u4ee3\u7406\u5de5\u5177</p> <p>(Nginx\u7684\u524d\u9762\u53ef\u80fd\u8fd8\u6709\u5176\u4ed6\u4ee3\u7406\u670d\u52a1\u5668\uff0c\u5728\u6b64\u4e0d\u8fdb\u884c\u8bf4\u660e)\u7684\u670d\u52a1\u5668\u4e0a\uff0c\u4e4b\u540e\u5c31\u80fd\u901a\u8fc7\u57df\u540d\u8bbf\u95ee\u6211\u4eec\u7684\u5e94\u7528\u3002</p> <p>\u5728\u4f7f\u7528Kubernetes\u65f6\uff0c\u90e8\u7f72\u4e00\u4e2a\u5e94\u7528\u5e76\u4f7f\u7528\u57df\u540d\u8fdb\u884c\u53d1\u5e03\u7684\u6d41\u7a0b\u5982\u4e0b\uff1a 1\uff09\u90e8\u7f72\u5e94\u7528\u81f3Kubernetes\u96c6\u7fa4\uff0c\u5bb9\u5668\u5185\u5b9a\u4e49\u4e86\u7a0b\u5e8f\u542f\u52a8\u7684\u65b9\u5f0f\u3002</p> <p>2\uff09\u914d\u7f6eClusterIP\u7c7b\u578b\u7684Service\uff0c\u901a\u8fc7Selector\u94fe\u63a5\u5230\u5bb9\u5668\u5185\u7684\u5e94\u7528\u3002</p> <p>3\uff09\u914d\u7f6eIngress\u94fe\u63a5\u5230\u8be5\u5e94\u7528\u7684Service\uff0c\u4e4b\u540e\u5c06\u57df\u540d\u89e3\u6790\u5230Ingress(Ingress\u524d\u9762\u53ef\u80fd\u8fd8\u6709\u5176\u4ed6\u4ee3\u7406\u670d\u52a1\u5668)\u5bf9\u5e94\u7684\u5bbf\u4e3b\u673a\u4e0a\u5373\u53ef\u3002</p> <p>\u6b64\u65f6\u5728Kubernetes\u4e2d\u5bf9\u5e94\u7684\u67b6\u6784\u56fe\u5982\u56fe6.3\u6240\u793a\u3002</p> <p>)</p> <p>\u56fe6.3 Ingress\u4ee3\u7406\u6a21\u5f0f</p> <p>\u90a3Ingress\u5230\u5e95\u662f\u4ec0\u4e48\u5462\uff1f</p> <p>\u901a\u4fd7\u6765\u8bb2\uff0cIngress\u548c\u4e4b\u524d\u63d0\u5230\u7684Service\u3001Deployment\u7b49\u7c7b\u4f3c\uff0c\u4e5f\u662f\u4e00\u4e2aKubernetes\u7684\u8d44\u6e90\u5bf9\u8c61\uff0cDeployment\u662f\u7528\u6765\u90e8\u7f72\u5e94\u7528\u7684\uff0cIngress\u5c31\u662f\u5b9e\u73b0\u7528\u57df\u540d\u7684\u65b9\u5f0f\u8bbf\u95ee\u5e94\u7528\u3002</p> <p>Ingress\u5b9e\u73b0\u7684\u65b9\u5f0f\u6709\u5f88\u591a\uff0c\u6bd4\u5982Nginx\u3001HAProxy\u3001 Treafik\u7b49\uff0c\u5c31Nginx\u800c\u8a00 \uff0c\u548c\u4e0a\u8ff0\u63d0\u5230\u7684\u4f20\u7edf\u670d\u52a1\u67b6\u6784\u7528Nginx\u7c7b\u4f3c \u3002</p> <p>Ingress\u63a7\u5236\u5668\u5728\u6bcf\u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u5bbf\u4e3b\u673a\u4e0a\u90e8\u7f72\u4e00\u4e2aPod\uff0c\u8fd9\u4e2aPod\u91cc\u9762\u8fd0\u884c\u7684 \u5c31\u662fNginx\u8fdb\u7a0b\uff0c\u91cc\u9762\u7684\u5b9e\u73b0\u903b\u8f91\u548c\u5bbf\u4e3b\u673a\u90e8\u7f72Nginx\u7684\u65b9\u5f0f\u5e76\u65e0\u592a\u5927\u533a\u522b\uff0c \u5173\u952e\u533a\u522b\u662f\u5bbf\u4e3b\u673a\u90e8\u7f72\u7684Nginx\u9700\u8981\u66f4\u6539Nginx\u7684\u914d\u7f6e\u6587\u4ef6\u914d\u7f6e\u57df\u540d\uff0c \u800cIngress\u5219\u548c\u5176\u4ed6Kubernetes\u8d44\u6e90\u6587\u4ef6\u4e00\u6837\uff0c\u4f7f\u7528YAML\u6587\u4ef6\u8fdb\u884c\u914d\u7f6e\uff0c\u4e4b\u540e Ingress\u63a7\u5236\u5668\u6839\u636eYAML\u6587\u4ef6\u5b9a\u4e49\u7684\u5185\u5bb9\u81ea\u52a8\u751f\u6210\u5bf9\u5e94\u7684\u914d\u7f6e\u6587\u4ef6\u3002</p> <p>\u5728Kubernetes v1.1\u7248\u4e2d\u6b63\u5f0f\u5f15\u7528Ingress\u7684\u6982\u5ff5\uff0c\u7528\u4e8e\u4ece\u96c6\u7fa4\u5916\u90e8\u5230\u96c6 \u7fa4\u5185\u90e8Service\u7684HTTP\u548cHTTPS\u8def\u7531\uff0c\u53ef\u4ee5\u914d\u7f6e\u63d0\u4f9b\u670d\u52a1\u5916\u90e8\u8bbf\u95ee\u7684URL\u3001\u8d1f\u8f7d \u5747\u8861\u548c\u7ec8\u6b62SSL\uff0c\u5e76\u63d0\u4f9b\u57fa\u4e8e\u57df\u540d\u7684\u865a\u62df\u4e3b\u673a\u3002\u6d41\u91cf\u4eceInternet\u5230Ingress\u518d \u5230Services\u6700\u540e\u5230Pod\u4e0a\uff0c\u901a\u5e38\u60c5\u51b5\u4e0b\uff0cIngress\u90e8\u7f72\u5728\u6240\u6709\u7684Node\u8282\u70b9\u4e0a\uff0c \u66b4\u9732443\u548c80\u7aef\u53e3\uff08\u4e00\u822c\u901a\u8fc7hostNetwork\u7684\u65b9\u5f0f\u90e8\u7f72Ingress),\u4e4b\u540e\u518d\u901a\u8fc7F5\u6216\u516c\u6709\u4e91LB\u4ee3\u7406\u5230\u5bf9\u5e94\u7684Ingress\u8282\u70b9\u4e0a\uff0c\u4e4b\u540e\u5c06\u57df\u540d\u89e3\u6790\u5230F5\u6216\u516c\u6709\u4e91LB\u5373\u53ef\u5b9e\u73b0\u57fa\u4e8e\u57df\u540d\u7684\u670d\u52a1\u53d1\u5e03\u3002</p> <p>Ingress\u9009\u578b</p> <p>\u53c2\u8003\u6587\u732e</p> <ul> <li>https://www.yuque.com/coolops/kubernetes/uung6g</li> <li>https://www.yuque.com/cuiliang0302/kubernets/qc173m</li> <li>https://www.qikqiak.com/k8strain/network/ingress/nginx/</li> </ul> <p>Nginx Ingress\u5947\u5de7\u6deb\u6280</p> <p>https://www.yuque.com/coolops/kubernetes/ke3qu2</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#32-\u521b\u5efa\u4e00\u4e2aingress","title":"3.2 \u521b\u5efa\u4e00\u4e2aIngress","text":"<p>\u521b\u5efaIngress\u548c\u521b\u5efa\u5176\u4ed6\u8d44\u6e90\u7c7b\u4f3c\uff0c\u4e5f\u662f\u4f7f\u7528YAML\u683c\u5f0f\u7684\u6587\u4ef6\u3002</p> <p>\u521b\u5efa\u4e00\u4e2a\u7b80\u5355\u7684Ingress\u4ee3\u7801\u5982\u4e0b (Kubernetes\u7248\u672c\u5c0f\u4e8e1.22\u65f6\uff0cAPIVersion\u4e3a networking.k8s.io/v1beta1,\u5927\u4e8e\u7b49\u4e8e1.22\u7248\u672c\u65f6\u5fc5\u987b\u4e3anetworking.k8s.io/v1,\u6700\u65e9\u671f\u7684\u7248\u672c\u8fd8\u6709extensions/v1beta1\uff0c\u5728\u6b64\u4e0d\u518d\u8bf4\u660e\uff09\uff1a</p> <pre><code>apiVersion: networking.k8s.io/v1beta1\nkind: Ingress\nmetadata:\nname: simple-fanout-example\nannotations:\nkubernetes.io/ingress.class: \"nginx\" # \u4e0d\u540c\u7684controller\uff0cingress.class\u53ef\u80fd\u4e0d\u4e00\u81f4\nspec:\nrules:\n- host: foo.bar.com\nhttp:\npaths:\n- path: /foo\npathType: Prefix\nbackend:\nserviceName: service1\nservicePort: 4200\n- path: /bar\npathType: ImplementationSpecific\nbackend:\nserviceName: service2\nservicePort: 8080\n</code></pre> <p>\u4e0a\u8ff0host\u5b9a\u4e49\u8be5Ingress\u7684\u57df\u540d\uff0c\u5c06\u5176\u89e3\u6790\u81f3\u4efb\u610f\u90e8\u7f72\u4e86Ingress\u63a7\u5236\u5668 \u7684Node\u4e0a\u5373\u53ef\u8bbf\u95ee\uff0c</p> <p>\u5982\u679c\u8bbf\u95ee\u7684\u662ffoo.bar.com/foo\uff0c\u5219\u88ab\u8f6c\u53d1\u5230service1\u76844200\u7aef\u53e3\uff0c \u5982\u679c\u8bbf\u95ee\u7684\u662ffoo.bar.com/bar\uff0c\u5219\u88ab\u8f6c\u53d1\u5230service2\u76848080\u7aef\u53e3\u3002</p> <p>\u5f53\u96c6\u7fa4\u7248\u672c\u5927\u4e8e\u7b49\u4e8e1.19\u65f6\uff0cIngress\u7684APIVersion\u53d8\u4e3a\u4e86v1\u7248\u672c\uff081.22\u540e\u5e9f\u5f03\u4e86v1beta1\uff09\uff0c\u5bf9\u5e94\u7684\u914d\u7f6e\u4e5f\u6709\u4e00\u4e9b\u53d8\u5316\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: networking.k8s.io/v1 # 1.19+\nkind: Ingress\nmetadata:\nname: simple-fanout-example\nspec:\ningressClassName: nginx\nrules:\n- host: foo.bar.com\nhttp:\npaths:\n- path: /foo\nbackend:\nservice\nname: service1\nport:\nnumber: 4200\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#33-ingress\u4f7f\u7528\u5165\u95e8","title":"3.3 Ingress\u4f7f\u7528\u5165\u95e8","text":""},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#1\u5355\u57df\u540d","title":"1.\u5355\u57df\u540d","text":"<p>\u4e00\u4e2a\u6bd4\u8f83\u5e38\u89c1\u7684\u914d\u7f6e\u662f\u5355\u4e2a\u57df\u540d\u5339\u914d\u591a\u4e2apath\u5230\u4e0d\u540c\u7684Service\uff08Kubernetes 1.19\u7248\u672c\u4ee5\u4e0a\u53ef\u4ee5\u53c2\u8003\u524d\u6587\uff09\uff1a</p> <pre><code>apiVersion: networking.k8s.io/v1beta1\nkind: Ingress\nmetadata:\nname: simple-fanout-example\nannotations:\nnginx.ingress.kubernetes.io/rewrite-target: /\nspec:\nrules:\n- host: foo.bar.com\nhttp:\npaths:\n- path: /foo\nbackend:\nserviceName: service1\nservicePort: 4200\n- path: /bar\nbackend:\nserviceName: service2\nservicePort: 8080\n</code></pre> <p>\u6b64\u65f6\uff0c\u8bbf\u95eefoo.bar.com/foo\u5230service1\u76844200\uff0c\u8bbf\u95eefoo.bar.com/bar\u5230service2\u76848080\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#2\u591a\u57df\u540d","title":"2.\u591a\u57df\u540d","text":"<p>\u4e5f\u652f\u6301\u548cNginx\u4e00\u6837\u7684\u591a\u57df\u540d\u914d\u7f6e\uff0c\u4e5f\u5c31\u662f\u57fa\u4e8e\u57df\u540d\u7684\u865a\u62df\u4e3b\u673a\uff0c\u652f\u6301\u5c06HTTP\u6d41\u91cf\u8def\u7531\u5230\u540c\u4e00IP\u5730\u5740\u7684\u591a\u4e2a\u4e3b\u673a\u540d\uff08Kubernetes 1.19\u4ee5\u4e0a\u7248\u672c\u53ef\u4ee5\u53c2\u8003\u524d\u6587\uff09\uff1a</p> <pre><code>apiVersion: networking.k8s.io/v1beta1\nkind: Ingress\nmetadata:\nname: name-virtual-host-ingress\nspec:\nrules:\n- host: foo.bar.com\nhttp:\npaths:\n- backend:\nserviceName: service1\nservicePort: 80\n- host: bar.foo.com\nhttp:\npaths:\n- backend:\nserviceName: service2\nservicePort: 80\n</code></pre> <p>\u6b64\u65f6\uff0c\u8bbf\u95eefoo.bar.com\u5230service1\uff0c\u8bbf\u95eebar.foo.com\u5230service2\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#3\u57fa\u4e8etls\u7684ingress","title":"3.\u57fa\u4e8eTLS\u7684Ingress","text":"<p>\u751f\u4ea7\u73af\u5883\u7684\u57df\u540d\u5927\u90e8\u5206\u90fd\u662fHTTPS\u7684\uff0cIngress\u4e5f\u652f\u6301HTTPS\u7c7b\u578b\u7684\u57df\u540d\u3002\u9996\u5148\u521b\u5efa\u8bc1\u4e66\uff0c\u751f\u4ea7\u73af\u5883\u7684\u8bc1\u4e66\u4e3a\u516c\u53f8\u8d2d\u4e70\u7684\u8bc1\u4e66\uff1a</p> <pre><code>$ kubectl -n default create secret tls nginx-test-tls --key=tls.key --cert=tls.crt\n</code></pre> <p>\u5b9a\u4e49Ingress\uff08Kubernetes 1.19\u4ee5\u4e0a\u7248\u672c\u53ef\u4ee5\u53c2\u8003\u524d\u6587\uff09\uff1a</p> <pre><code>apiVersion: networking.k8s.io/v1beta1\nkind: Ingress\nmetadata:\nname: nginx-https-test\nnamespace: default\nannotations:\nkubernetes.io/ingress.class: \"nginx\"\nspec:\nrules:\n- host: https-test.com\nhttp:\npaths:\n- backend:\nserviceName: nginx-svc\nservicePort: 80\ntls:\n- secretName: nginx-test-tls\n</code></pre> <p>\u63d0\u793a tls\u4e3a\u57df\u540d\u8bc1\u4e66\u914d\u7f6e\u9879\uff0c\u4e00\u4e2aIngress\u53ef\u4ee5\u5b9a\u4e49\u591a\u4e2atls\u7c7b\u578b\u7684Secret\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#34-\u66f4\u65b0ingress","title":"3.4 \u66f4\u65b0Ingress","text":"<p>\u66f4\u65b0Ingress\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528<code>kubectl edit ingress INGRESS-NAME</code>\u8fdb\u884c\u66f4\u6539\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7<code>kubectl apply/replace -f NEW-INGRESS-YAML.yaml</code>\u8fdb\u884c\u66f4\u6539\u3002</p> <p>\u672c\u7ae0\u53ea\u4ecb\u7ecd\u4e86Ingress\u7684\u57fa\u672c\u6982\u5ff5\uff0c\u66f4\u591aIngress\u7684\u914d\u7f6e\u8bf7\u53c2\u8003Ingress Nginx\u8fdb\u9636\u4e00\u7ae0\uff08\u672c\u4e66\u7b2c16\u7ae0\uff09\u7684\u5185\u5bb9\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/#4\u5c0f\u7ed3","title":"4.\u5c0f\u7ed3","text":"<p>\u672c\u7ae0\u8bb2\u89e3\u4e86\u670d\u52a1\u53d1\u5e03\u7684\u4e24\u79cd\u65b9\u5f0f\uff0c\u5373Service\u548cIngress\u3002 \u901a\u5e38\u60c5\u51b5\u4e0b\uff0c Service\u7528\u4e8e\u7a0b\u5e8f\u95f4\u7684\u5185\u90e8\u8bbf\u95ee\uff0c\u5373\u540e\u7aef\u670d\u52a1\u4e4b\u95f4\u7684\u76f8\u4e92\u8c03\u7528\u3002 \u800cIngress\u591a \u7528\u4e8e\u5bf9\u5916\u53d1\u5e03\u670d\u52a1\uff0c\u5373\u901a\u8fc7\u57df\u540d\u7684\u5f62\u5f0f\u8ba9\u7528\u6237\u80fd\u8bbf\u95ee\u5230\u5185\u90e8\u670d\u52a1\uff0c\u8fd9\u4e5f\u662f\u6700\u666e\u904d\u7684\u53d1\u5e03\u65b9\u5f0f\uff0c \u4f46\u662f\u5982\u679c\u4e00\u4e2a\u4e0d\u9700\u8981\u5bf9\u5916\u53d1\u5e03\u7684\u540e\u7aef\u670d\u52a1\uff0c\u901a\u8fc7Ingress\u88ab\u53e6\u4e00\u4e2a\u540e\u7aef\u670d\u52a1\u8c03\u7528\uff0c\u5219\u76f8\u5f53\u4e8e\u4ece\u5916\u90e8\u7ed5\u4e86\u4e00\u5708\uff0c\u8fd9\u4e0d\u662f\u63a8\u8350\u7684\u65b9\u5f0f\u3002</p> <p>\u5b9e\u9645\u4f7f\u7528\u65f6\uff0c\u4e5f\u4f1a\u6709\u67b6\u6784\u76f4\u63a5\u901a\u8fc7Service\u7684NodePort\u66b4\u9732\u670d\u52a1\uff0c\u7136\u540e\u7531 \u4e0a\u5c42\u7684\u7f51\u5173\u8fdb\u884c\u4ee3\u7406\uff0c\u57df\u540d\u90fd\u914d\u7f6e\u5728\u4e0a\u5c42\uff0c\u8fd9\u6837\u7684\u8bdd\uff0c\u670d\u52a1\u8fc7\u591a\u4f1a\u5f15\u8d77\u7aef\u53e3 \u7ef4\u62a4\u975e\u5e38\u590d\u6742\uff0c\u53ef\u80fd\u8fd8\u4f1a\u6709\u6027\u80fd\u635f\u8017\u3002</p> <p>\u6240\u4ee5\u4e00\u822c\u63a8\u8350\u5728\u4e0a\u5c42\u914d\u7f6e\u901a\u914d\u7b26\u57df\u540d\uff0c\u6bd4\u5982*.test.com\u5230Kubernetes\u7684Ingress Controller\uff0c\u4e4b\u540e\u7531Ingress\u518d\u505a\u8def\u7531\u3002\u6bd4\u5982a.test.com\u6307\u5411A\u9879\u76ee\uff0ca.test.com/xxx\u6307\u5411A\u9879\u76ee\u7684xxx\u670d\u52a1\u3002</p> <p>\u53e6\u5916\u5728\u7a0b\u5e8f\u8bbe\u8ba1\u65f6\uff0c\u6709\u4e86Service\u65e0\u987b\u518d\u8003\u8651\u8d1f\u8f7d\u5747\u8861\u7b49\u95ee\u9898\uff0c\u6240\u4ee5\u5982\u679c\u6709\u7a0b\u5e8f\u95f4\u7684\u8c03\u7528\uff0c\u9996\u9009Service\uff0c\u5e76\u4e14\u4ee5\u540e\u53ef\u4ee5\u65e0\u7f1d\u5730\u63a5\u5165\u670d\u52a1\u7f51\u683c\uff0c\u8fdb\u884c\u670d \u52a1\u6cbb\u7406\u3002</p> <p>\u5728\u4f7f\u7528Kubernetes\u65f6\uff0c\u5176\u5b9e\u5e76\u4e0d\u63a8\u8350\u4f7f\u7528Spring Cloud\u8fd9\u7c7b\u67b6\u6784\uff0c \u56e0\u4e3a\u5f88\u591a\u529f\u80fd\u90fd\u662f\u7c7b\u4f3c\u7684\uff0c \u5728Kubernetes\u4e0a\u4ecd\u65e7\u4f7f\u7528Spring Cloud\u5c5e\u4e8e\u201c\u5957\u5a03\u201d\u578b\u67b6\u6784\uff0c\u5e94\u8be5\u5411\u7740\u5355\u670d\u52a1\u65b9\u5411\u8fdb\u884c\u5f00\u53d1\uff0c\u6bd4\u5982\u76f4\u63a5\u4f7f\u7528Spring Boot\u5373\u53ef\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/","title":"Kubernetes\u914d\u7f6e\u7ba1\u7406","text":"<p>\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2a\u670d\u52a1\u7684\u542f\u52a8\u9700\u8981\u4f9d\u8d56\u4e00\u4e9b\u914d\u7f6e\uff0c\u6bd4\u5982\u4e00\u4e2aJava\u5e94\u7528\u9700\u8981\u77e5\u9053\u81ea\u5df1\u94fe\u63a5\u7684\u6570\u636e\u5e93\u6216\u5176\u4ed6\u4e2d\u95f4\u4ef6\u7684\u5730\u5740\u662f\u4ec0\u4e48\uff0c \u9700\u8981\u77e5\u9053\u94fe\u63a5\u53e6\u4e00\u4e2a\u670d\u52a1\u7684\u63a5\u53e3\u5730\u5740\u662f\u4ec0\u4e48\uff0c\u6240\u4ee5\u9700\u8981\u544a\u8bc9\u5e94\u7528\u5176\u4ed6\u670d\u52a1\u7684\u914d\u7f6e\u4fe1\u606f\u3002</p> <p>\u4e00\u822c\u53ef\u4ee5\u901a\u8fc7\u73af\u5883\u6ce8\u5165\u6216\u8005\u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u7edf\u4e00\u7ba1\u7406\uff0c\u800c\u4e0d\u662f\u5199\u6b7b\u5728\u4ee3\u7801\u91cc\u9762\uff0c\u8fd9\u4e5f\u662f\u4e91\u539f\u751f\u5e94\u7528\u8bbe\u8ba1\u6bd4\u8f83\u91cd\u8981\u7684\u56e0\u7d20\u2014\u2014\u914d\u7f6e\u5206\u79bb\u3002</p> <p>\u5728\u4f20\u7edf\u67b6\u6784\u4e2d\u914d\u7f6e\u6587\u4ef6\u53ef\u4ee5\u4fdd\u5b58\u5728\u672c\u5730\u670d\u52a1\u5668\u3001\u4ee3\u7801\u4ed3\u5e93\u6216\u914d\u7f6e\u4e2d\u5fc3\uff0c\u800c\u5728Kubernetes\u4e0a\uff0c\u5176\u62bd\u8c61\u4e3aConfigMap\uff08\u7f29\u5199\u4e3aCM\uff09\u548cSecret\u7684\u6982\u5ff5\uff0c \u7528\u6765\u7ba1\u7406\u7a0b\u5e8f\u7684\u914d\u7f6e\u6587\u4ef6\u6216Pod\u53d8\u91cf\uff0c\u6bd4\u5982Nginx\u914d\u7f6e\u3001\u5e94\u7528\u914d\u7f6e\u3001Maven Setting\u914d\u7f6e\u6587\u4ef6\u7b49\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#1-\u4ec0\u4e48\u662fconfigmap","title":"1. \u4ec0\u4e48\u662fConfigMap","text":"<p>\u4f20\u7edf\u67b6\u6784\u4e2d\uff0c\u914d\u7f6e\u6587\u4ef6\u5f80\u5f80\u88ab\u4fdd\u5b58\u5728\u5bbf\u4e3b\u673a\u4e0a\uff0c\u7a0b\u5e8f\u542f\u52a8\u65f6\u53ef\u4ee5\u6307\u5b9a\u67d0\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u4f46\u662f\u4f7f\u7528\u5bb9\u5668\u90e8\u7f72\u65f6\uff0c\u5bb9\u5668\u6240\u5728\u7684\u8282\u70b9\u5e76\u4e0d\u56fa\u5b9a\uff0c \u6240\u4ee5\u4e0d\u80fd\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u6b64\u5904\u5728\u6784\u5efa\u955c\u50cf\u65f6\uff0c\u5982\u679c\u628a\u914d\u7f6e\u6587\u4ef6\u4e5f\u653e\u5728\u5bb9\u5668\u91cc\u9762\uff0c\u90a3\u4e48\u914d\u7f6e\u6587\u4ef6\u4e00\u65e6\u6709\u66f4\u6539\u7684\u8bdd\uff0c\u4e5f\u662f\u4e00\u4ef6\u975e\u5e38\u9ebb\u70e6\u7684\u4e8b\u60c5\u3002 \u6240\u4ee5Kubernetes\u62bd\u8c61\u4e86\u4e00\u4e2aConfigMap\u7684\u6982\u5ff5\uff0c\u5c06\u914d\u7f6e\u4e0ePod\u548c\u7ec4\u4ef6\u5206\u5f00\uff0c\u8fd9\u6709\u52a9\u4e8e\u4fdd\u6301\u5de5\u4f5c\u8d1f\u8f7d\u7684\u53ef\u79fb\u690d\u6027\uff0c\u4f7f\u914d\u7f6e\u66f4\u6613\u4e8e\u66f4\u6539\u548c\u7ba1\u7406\u3002</p> <p>\u6bd4\u5982\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u53ef\u4ee5\u5c06Nginx\u3001Redis\u7b49\u5e94\u7528\u7684\u914d\u7f6e\u6587\u4ef6\u5b58\u50a8\u5728ConfigMap\u4e0a\uff0c\u7136\u540e\u5c06\u5176\u6302\u8f7d\u5373\u53ef\u4f7f\u7528\u3002</p> <p>\u76f8\u5bf9\u4e8eSecret\uff0cConfigMap\u66f4\u503e\u5411\u4e8e\u5b58\u50a8\u548c\u5171\u4eab\u975e\u654f\u611f\u3001\u672a\u52a0\u5bc6\u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u5047\u5982\u662f\u5728\u96c6\u7fa4\u4e2d\u4f7f\u7528\u654f\u611f\u4fe1\u606f\uff0c\u6700\u597d\u4f7f\u7528Secret\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#2-\u521b\u5efaconfigmap","title":"2. \u521b\u5efaConfigMap","text":"<p>ConfigMap\u53ef\u4ee5\u7528\u76ee\u5f55\uff08\u76ee\u5f55\u4e0b\u6709\u591a\u4e2a\u6587\u4ef6\uff09\u3001\u5355\u4e2a\u6587\u4ef6\u6216\u5b57\u7b26\u503c\u7684\u65b9\u5f0f\u521b\u5efa\uff0c\u4f7f\u7528kubectl\u521b\u5efa\u4e00\u4e2aConfigMap\u7684\u547d\u4ee4\u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>$ kubectl create configmap &lt;map-name&gt; &lt;data-source&gt;\n</code></pre> <ul> <li>map-name\uff1aConfigMap\u7684\u540d\u79f0\u3002</li> <li>data-source\uff1a\u6570\u636e\u6e90\uff0c\u53ef\u4ee5\u662f\u6570\u636e\u7684\u76ee\u5f55\u3001\u6587\u4ef6\u6216\u5b57\u7b26\u503c\u3002</li> </ul> <p>ConfigMap\u4e2d\u7684\u6570\u636e\u662f\u4ee5\u952e-\u503c\u5bf9\uff08key-value pair\uff09\u7684\u5f62\u5f0f\u4fdd\u5b58\u7684\uff0c\u5176\u4e2d\uff1a</p> <ul> <li>key\uff1a\u6587\u4ef6\u540d\u6216\u5bc6\u94a5\u3002</li> <li>value\uff1a\u6587\u4ef6\u5185\u5bb9\u6216\u5b57\u7b26\u503c\u3002</li> </ul>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#21-\u57fa\u4e8e\u76ee\u5f55\u521b\u5efaconfigmap","title":"2.1 \u57fa\u4e8e\u76ee\u5f55\u521b\u5efaConfigMap","text":"<p>\u5047\u5982\u4e00\u6b21\u6027\u9700\u8981\u591a\u4e2a\u6587\u4ef6\u6765\u521b\u5efaConfigMap\uff0c\u53ef\u4ee5\u4f7f\u7528kubectl create configmap\u547d\u4ee4\u4ece\u540c\u4e00\u4e2a\u76ee\u5f55\u4e2d\u7684\u591a\u4e2a\u6587\u4ef6\u521b\u5efaConfigMap\u3002</p> <p>\u6bd4\u5982\u6709\u4e00\u4e2aconf\u6587\u4ef6\u5939\uff0c\u91cc\u9762\u5305\u542b\u4e24\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>$ cat conf/game.properties\nenemies=aliens\nlives=3\nenemies.cheat=true\nenemies.cheat.level=noGoodRotten\nsecret.code.passphrase=UUDDLRLRBABAS\nsecret.code.allowed=true\nsecret.code.lives=30\n$ cat conf/ui.properties\ncolor.good=purple\ncolor.bad=yellow\nallow.textmode=true\nhow.nice.to.look=fairlyNice\n</code></pre> <p>ConfigMap\u4e5f\u662f\u6309Namespace\u9694\u79bb\u7684\uff0c\u4e0d\u540c\u7684Namespace\u4e4b\u95f4ConfigMap\u7684\u540d\u79f0\u53ef\u4ee5\u76f8\u540c\uff0c\u4f46\u662f\u4e0d\u80fd\u8de8Namespace\u8fdb\u884c\u8bbf\u95ee\u3002 \u6240\u4ee5\u521b\u5efaConfigMap\uff0c\u53ef\u4ee5\u4f7f\u7528-n\u6307\u5b9a\u8d44\u6e90\u6240\u5728\u7684Namespace\uff08\u547d\u540d\u7a7a\u95f4\uff09\uff0c\u9ed8\u8ba4\u521b\u5efa\u5728default\u547d\u540d\u7a7a\u95f4\u4e0b\u3002</p> <p>\u57fa\u4e8e\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u521b\u5efaConfigMap\u7684\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>$ kubectl create configmap game-config --from-file=conf\nconfigmap/game-config created\n\n$ kubectl get cm\nNAME               DATA   AGE\ngame-config        2      &lt;invalid&gt;\n</code></pre> <p>\u7531\u4e8e\u8be5ConfigMap\u662f\u76f4\u63a5\u57fa\u4e8e\u76ee\u5f55\u521b\u5efa\u7684\uff0c\u6ca1\u6709\u6307\u5b9aConfigMap\u4e2d\u7684Key\u540d\uff0c\u56e0\u6b64\u9ed8\u8ba4\u662f\u6309\u7167\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u540d\u4f5c\u4e3aConfigMap\u6570\u636e\u4e2d\u7684Key\u540d\uff0c\u67e5\u770b\u5f53\u524d\u521b\u5efa\u7684ConfigMap\uff1a <pre><code># \u67e5\u770b\u5f53\u524d\u521b\u5efa\u7684ConfigMap\n$ kubectl get cm game-config -o yaml\napiVersion: v1\ndata:\n  game.properties: |\nenemies=aliens\n    lives=3\nenemies.cheat=true\nenemies.cheat.level=noGoodRotten\n    secret.code.passphrase=UUDDLRLRBABAS\n    secret.code.allowed=true\nsecret.code.lives=30\nui.properties: |\ncolor.good=purple\n    color.bad=yellow\n    allow.textmode=true\nhow.nice.to.look=fairlyNice\nkind: ConfigMap\n</code></pre></p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#22-\u57fa\u4e8e\u6587\u4ef6\u521b\u5efaconfigmap","title":"2.2 \u57fa\u4e8e\u6587\u4ef6\u521b\u5efaConfigMap","text":"<p>\u5728\u5b9e\u9645\u4f7f\u7528\u65f6\uff0c\u5927\u90e8\u5206\u90fd\u662f\u57fa\u4e8e\u5355\u4e2a\u6587\u4ef6\u521b\u5efaConfigMap\u7684\uff0c\u7136\u540e\u6302\u8f7d\u81f3\u67d0\u4e2a\u8d44\u6e90\u6587\u4ef6\u4f9b\u5176Pod\u4f7f\u7528\u3002</p> <p>\u4f8b\u5982\u6709\u4e00\u4e2agame.properties\u6587\u4ef6\uff0c\u53ef\u4ee5\u57fa\u4e8e\u6b64\u6587\u4ef6\u4f7f\u7528<code>kubectl create cm</code>\u521b\u5efaConfigMap\uff1a</p> <pre><code>$ kubectl create configmap game-config-2 --from-file=conf/game.properties\nconfigmap/game-config-2 created\n\n$ kubectl get cm\nNAME               DATA   AGE\ngame-config-2      1      &lt;invalid&gt;\n</code></pre> <p>\u7531\u4e8e\u6ca1\u6709\u6307\u5b9aConfigMap\u7684Key\uff0c\u56e0\u6b64\u4f9d\u65e7\u4f7f\u7528\u6587\u4ef6\u540d\u4f5c\u4e3aKey\uff0c\u67e5\u770b\u5f53\u524d\u7684ConfigMap\uff1a</p> <pre><code>$ kubectl get cm game-config-2 -o yaml\napiVersion: v1\ndata:\n  game.properties: |\nenemies=aliens\n    lives=3\nenemies.cheat=true\nenemies.cheat.level=noGoodRotten\n    secret.code.passphrase=UUDDLRLRBABAS\n    secret.code.allowed=true\nsecret.code.lives=30\nkind: ConfigMap\n</code></pre> <p>\u5982\u679c\u9700\u8981\u6307\u5b9aConfigMap\u7684Key\u540d\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u683c\u5f0f\u8fdb\u884c\u521b\u5efa\uff1a</p> <pre><code>$ kubectl create configmap game-config-3 --from-file=self-key=conf/game.properties\nconfigmap/game-config-3 created\n\n$ kubectl get cm\nNAME               DATA   AGE\ngame-config-3      1      24s\nkube-root-ca.crt   1      143d\n\n$ kubectl get cm game-config-3 -o yaml\napiVersion: v1\ndata:\n  self-key: |\nenemies=aliens\n    lives=3\nenemies.cheat=true\nenemies.cheat.level=noGoodRotten\n    secret.code.passphrase=UUDDLRLRBABAS\n    secret.code.allowed=true\nsecret.code.lives=30\nkind: ConfigMap\n</code></pre> <p>\u5f53\u7136\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528--from-file\u591a\u6b21\u4f20\u5165\u53c2\u6570\u4ee5\u4ece\u591a\u4e2a\u6570\u636e\u6e90\u521b\u5efaConfigMap\uff0c\u6b64\u65b9\u5f0f\u548c\u57fa\u4e8e\u6587\u4ef6\u5939\u7c7b\u4f3c\uff0c\u53ea\u4e0d\u8fc7\u53ef\u4ee5\u5355\u72ec\u8bbe\u7f6eConfigMap\u7684Key\u540d\uff1a</p> <pre><code>$ kubectl create configmap game-config-4 --from-file=conf/game.properties --from-file=conf/ui.properties\nconfigmap/game-config-4 created\n\n$ kubectl get cm\nNAME               DATA   AGE\ngame-config-4      2      &lt;invalid&gt;\nkube-root-ca.crt   1      143d\n\n# \u67e5\u770b\u5f53\u524d\u7684ConfigMap\uff1a\n$ kubectl get cm game-config-4 -o yaml\napiVersion: v1\ndata:\n  game.properties: |\nenemies=aliens\n    lives=3\nenemies.cheat=true\nenemies.cheat.level=noGoodRotten\n    secret.code.passphrase=UUDDLRLRBABAS\n    secret.code.allowed=true\nsecret.code.lives=30\nui.properties: |\ncolor.good=purple\n    color.bad=yellow\n    allow.textmode=true\nhow.nice.to.look=fairlyNice\nkind: ConfigMap\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#23-\u57fa\u4e8eenv\u6587\u4ef6\u521b\u5efaconfigmap","title":"2.3 \u57fa\u4e8eENV\u6587\u4ef6\u521b\u5efaConfigMap","text":"<p>\u5047\u5982\u6709\u4e00\u4e2a\u6587\u4ef6game-env-file.properties\uff0c\u91cc\u9762\u5b58\u50a8\u7684\u662fkey=value\u5f62 \u5f0f\u7684\u6570\u636e\uff0c\u6b64\u7c7b\u6587\u4ef6\u53ef\u4ee5\u5f53\u4f5c\u67d0\u4e2a\u5e94\u7528\u7684\u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff0c \u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528<code>--from-env-file</code>\u4eceENV\u6587\u4ef6\u521b\u5efaConfigMap\uff1a <pre><code>$ cat conf/game-env-file.properties\nenemies=aliens\nlives=3\nallowed=\"true\"\n# \u521b\u5efaConfigMap\uff1a\n$ kubectl create cm game-config-env-file --from-env-file=conf/game-env-file.properties\nconfigmap/game-config-env-file created\n\n# \u67e5\u770b\u5f53\u524d\u7684ConfigMap\uff0c\u6ce8\u610f\u6b64\u65f6ConfigMap\u7684data\u5185\u5bb9\u5df2\u7ecf\u53d8\u6210\u4e86key\u5192 \u53f7\uff08:\uff09\u7684\u5f62\u5f0f\uff0c\u800c\u4e0d\u662f\u4e4b\u524d\u548c\u6587\u4ef6\u5185\u5bb9\u4e00\u81f4\u7684\u6570\u636e\uff1a\n$ kubectl get cm/game-config-env-file -o yaml\napiVersion: v1\ndata:\n  allowed: '\"true\"'\niiienemies: aliens\n  lives: \"3\"\nkind: ConfigMap\nmetadata:\n  name: game-config-env-file\n  namespace: default\n</code></pre></p> <p>\u6ce8\u610f</p> <p>\u5982\u679c\u4f7f\u7528--from-env-file\u591a\u6b21\u4f20\u9012\u53c2\u6570\u4ee5\u4ece\u591a\u4e2a\u6570\u636e\u6e90\u521b\u5efaConfigMap\uff0c\u4ec5\u6700\u540e\u4e00\u4e2aENV\u751f\u6548\uff081.23\u4ee5\u4e0a\u7248\u672c\u652f\u6301\u591a\u4e2a--from-env-file\u53c2\u6570\uff09\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#24-\u4ecekey-value\u5b57\u7b26\u4e32\u521b\u5efa","title":"2.4 \u4ecekey-value\u5b57\u7b26\u4e32\u521b\u5efa","text":"<p>\u6709\u65f6\u5019\u914d\u7f6e\u5e76\u4e0d\u662f\u5f88\u591a\uff0c\u53ea\u6709\u51e0\u4e2akey=value\u7684\u53c2\u6570\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528<code>kubectl create configmap</code>\u4e0e<code>--from-literal</code>\u53c2\u6570\u6765\u5b9a\u4e49\u547d\u4ee4\u884c\u7684\u5b57\u7b26\u503c\uff0c \u6bd4\u5982\u4ee5special.how=very\u548cspecial.type=charm\u8fdb\u884c\u521b\u5efa\uff1a</p> <pre><code>$ kubectl create configmap special-config --from-literal=special.how=very\nconfigmap \"special-config\" created\n\n$ kubectl get configmap special-config -o go-template='{{.data}}'\nmap[special.how:very]\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#25-configmap\u5b9e\u8df5","title":"2.5 ConfigMap\u5b9e\u8df5","text":""},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#1\u4f7f\u7528valuefrom\u5b9a\u4e49\u5bb9\u5668\u73af\u5883\u53d8\u91cf","title":"1.\u4f7f\u7528valueFrom\u5b9a\u4e49\u5bb9\u5668\u73af\u5883\u53d8\u91cf","text":"<pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nlabels:\napp: env-valuefrom\nname: env-valuefrom\nnamespace: default\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: env-valuefrom\nstrategy:\nrollingUpdate:\nmaxSurge: 1\nmaxUnavailable: 0\ntype: RollingUpdate\ntemplate:\nmetadata:\nlabels:\napp: env-valuefrom\nspec:\ncontainers:\n- command:\n- sh\n- -c\n- env\nenv:\n- name: TZ\nvalue: Asia/Shanghai\n- name: LANG\nvalue: C.UTF-8\n- name: SPECIAL_LEVEL_KEY\nvalueFrom:\nconfigMapKeyRef:\nkey: special.how\nname: special-config\nimage: busybox\nimagePullPolicy: IfNotPresent\nname: env-valuefrom\nresources:\nlimits:\ncpu: 100m\nmemory: 100Mi\nrequests:\ncpu: 10m\nmemory: 10Mi\ndnsPolicy: ClusterFirst\nrestartPolicy: Never\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#2\u4f7f\u7528envfrom\u5b9a\u4e49\u5bb9\u5668\u7684\u73af\u5883\u53d8\u91cf","title":"2.\u4f7f\u7528envFrom\u5b9a\u4e49\u5bb9\u5668\u7684\u73af\u5883\u53d8\u91cf","text":"<p>\u4e0a\u8ff0\u6f14\u793a\u7684valueFrom\u901a\u5e38\u7528\u4e8e\u4f7f\u7528ConfigMap\u7684\u5355\u4e2aKey\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\uff0c \u4f46\u5b9e\u9645\u4f7f\u7528\u65f6\u66f4\u5e38\u7528\u7684\u662f\u628aConfigMap\u91cc\u9762\u6240\u6709\u7684\u6570\u636e\u90fd\u4f5c\u4e3a\u73af\u5883\u53d8\u91cf\uff0c \u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528envFrom\u53c2\u6570\uff0c\u5bf9\u5e94\u7684YAML\u6587\u4ef6\u5982\u4e0b\uff08\u6ce8\u610fenvFrom\u7684\u914d\u7f6e\u4f4d\u7f6e\uff09\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nlabels:\napp: env-valuefrom\nname: env-valuefrom\nnamespace: default\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: env-valuefrom\nstrategy:\nrollingUpdate:\nmaxSurge: 1\nmaxUnavailable: 0\ntype: RollingUpdate\ntemplate:\nmetadata:\nlabels:\napp: env-valuefrom\nspec:\ncontainers:\n- command:\n- sh\n- -c\n- env\nenv:\n- name: TZ\nvalue: Asia/Shanghai\n- name: LANG\nvalue: C.UTF-8\nenvFrom:\n- configMapRef:\nname: game-config-env-file\nprefix: fromCm_\nimage: busybox\nimagePullPolicy: IfNotPresent\nname: env-valuefrom\nresources:\nlimits:\ncpu: 100m\nmemory: 100Mi\nrequests:\ncpu: 10m\nmemory: 10Mi\ndnsPolicy: ClusterFirst\nrestartPolicy: Never\n</code></pre> <p>\u6ce8\u610f</p> <p>\u4f7f\u7528envFrom\u65f6\uff0c\u73af\u5883\u53d8\u91cf\u7684\u540d\u5b57\u662fConfigMap\u4e2d\u6570\u636e\u7684key\u540d\u3002</p> <p>prefix\u53c2\u6570\u662f\u5c06ConfigMap\u4e2d\u7684key\u6dfb\u52a0\u4e00\u4e2a\u524d\u7f00\uff0c\u6bd4\u5982key\u540d\u662fself-key\uff0c\u52a0\u4e86prefix\u5c31\u662ffromCm_self-key\uff0cprefix\u4e3a\u53ef\u9009\u53c2\u6570\u3002</p> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\uff0c\u5f53\u4f7f\u7528ConfigMap\u6216\u8005Secret\u5b9a\u4e49Pod\u53d8\u91cf\u65f6\uff0c\u5982\u679cConfigMap\u548cSecret\u5185\u5bb9\u6709\u53d8\u5316\uff0c\u800cPod\u6ca1\u6709\u91cd\u542f\u7684\u8bdd\uff0cPod\u91cc\u9762\u7684\u53d8\u91cf\u5c31\u4e0d\u4f1a\u66f4\u65b0\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#3\u7528\u4f5c\u547d\u4ee4\u884c\u53c2\u6570","title":"3.\u7528\u4f5c\u547d\u4ee4\u884c\u53c2\u6570","text":"<p>\u5c06 ConfigMap \u7528\u4f5c\u547d\u4ee4\u884c\u53c2\u6570\u65f6\uff0c\u9700\u8981\u5148\u628a ConfigMap \u7684\u6570\u636e\u4fdd\u5b58\u5728\u73af\u5883\u53d8\u91cf\u4e2d\uff0c\u7136\u540e\u901a\u8fc7 $(VAR_NAME) \u7684\u65b9\u5f0f\u5f15\u7528\u73af\u5883\u53d8\u91cf.</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: dapi-test-pod\nspec:\ncontainers:\n- name: test-container\nimage: busybox\ncommand: [\"/bin/sh\", \"-c\", \"echo $(SPECIAL_LEVEL_KEY) $(SPECIAL_TYPE_KEY)\" ]\nenv:\n- name: SPECIAL_LEVEL_KEY\nvalueFrom:\nconfigMapKeyRef:\nname: special-config\nkey: special.how\n- name: SPECIAL_TYPE_KEY\nvalueFrom:\nconfigMapKeyRef:\nname: special-config\nkey: special.type\nrestartPolicy: Never\n</code></pre> <p>\u5f53 Pod \u7ed3\u675f\u540e\u4f1a\u8f93\u51fa</p> <pre><code>very charm\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#4\u4ee5\u6587\u4ef6\u5f62\u5f0f\u6302\u8f7dconfigmap","title":"4.\u4ee5\u6587\u4ef6\u5f62\u5f0f\u6302\u8f7dConfigMap","text":"<p>\u5927\u90e8\u5206\u60c5\u51b5\u4e0b\uff0cConfigMap\u5b9a\u4e49\u7684\u90fd\u662f\u914d\u7f6e\u6587\u4ef6\uff0c\u800c\u4e0d\u662f\u73af\u5883\u53d8\u91cf\uff0c\u56e0\u6b64 \u9700\u8981\u5c06ConfigMap\u4e2d\u7684\u6587\u4ef6\uff08\u4e00\u822c\u4e3a--from-file\u521b\u5efa\uff09\u6302\u8f7d\u5230Pod\u4e2d\uff0c\u7136\u540ePod\u4e2d\u7684\u5bb9\u5668\u5c31\u53ef\u4ee5\u5f15\u7528\uff0c\u6b64\u65f6\u53ef\u4ee5\u901a\u8fc7Pod\u7684volume\u5b57\u6bb5\u8fdb\u884c\u6302\u8f7d\u3002</p> <p>\u4f8b\u5982\u5c06\u540d\u79f0\u4e3aspecial-config\u7684ConfigMap\u6302\u8f7d\u5230\u5bb9\u5668\u7684/etc/config/\u76ee\u5f55\u4e0b\uff1a</p> <p>key\u4e3a\u6587\u4ef6\u540d\uff0cvalue \u4e3a\u5185\u5bb9</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: dapi-test-pod\nspec:\ncontainers:\n- name: test-container\nimage: busybox\ncommand: [ \"/bin/sh\", \"-c\", \"ls /etc/config/\" ]\nvolumeMounts:\n- name: config-volume\nmountPath: /etc/config\nvolumes:\n- name: config-volume\nconfigMap:\n# Provide the name of the ConfigMap containing the files you want\n# to add to the container\nname: special-config\nrestartPolicy: Never\n</code></pre> <p>\u4f7f\u7528kubectl\u521b\u5efa\u8be5Pod\u540e\uff0c\u4f1a\u6267\u884cPod\u8bbe\u7f6e\u7684command\u547d\u4ee4\uff0c\u5373\u6267\u884cls /etc/config/\uff1a <pre><code>special.level\nspecial.type\n</code></pre></p> <p>\u6ce8\u610f</p> <p>/etc/config/\u76ee\u5f55\u4f1a\u88ab\u8986\u76d6\uff0c\u6302\u8f7d\u6587\u4ef6\u65f6\u9700\u8981\u6ce8\u610f\u8fd9\u4e00\u70b9\uff0c\u540e\u9762\u7684\u7ae0\u8282\u4f1a \u8bb2\u89e3\u5982\u4f55\u4e0d\u8986\u76d6\u6302\u8f7dConfigMap\u548cSecret\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#5\u81ea\u5b9a\u4e49\u6587\u4ef6\u540d\u6302\u8f7dconfigmap","title":"5.\u81ea\u5b9a\u4e49\u6587\u4ef6\u540d\u6302\u8f7dConfigMap","text":"<p>\u5f88\u591a\u60c5\u51b5\u4e0b\uff0c\u9700\u8981\u66f4\u6539\u6302\u8f7d\u7684\u6587\u4ef6\u540d\uff0c\u53ef\u4ee5\u4f7f\u7528path\u5b57\u6bb5\u6307\u5b9aConfigMap \u6302\u8f7d\u7684\u6587\u4ef6\u540d\uff0c \u6bd4\u5982\u5c06special.level\u6302\u8f7d\u5230/etc/config\uff0c\u5e76\u6307\u5b9a\u540d\u79f0\u4e3akeys\uff1a</p> <p><pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: dapi-test-pod\nspec:\ncontainers:\n- name: test-container\nimage: busybox\ncommand: [ \"/bin/sh\",\"-c\",\"cat /etc/config/keys\" ]\nvolumeMounts:\n- name: config-volume\nmountPath: /etc/config\nvolumes:\n- name: config-volume\nconfigMap:\nname: special-config\nitems:\n- key: special.how\npath: keys\nrestartPolicy: Never\n</code></pre> \u6b64\u65f6\u542f\u52a8Pod\u65f6\u4f1a\u6253\u5370\uff1a<code>very</code>\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#6\u6307\u5b9a\u6302\u8f7d\u7684\u6587\u4ef6\u6743\u9650","title":"6.\u6307\u5b9a\u6302\u8f7d\u7684\u6587\u4ef6\u6743\u9650","text":"<p>ConfigMap\u5728\u6302\u8f7d\u4f7f\u7528\u65f6\u53ef\u4ee5\u66f4\u6539\u6587\u4ef6\u7684\u6743\u9650\uff08\u9ed8\u8ba4\u662f0644\uff09\uff0c\u6bd4\u5982\u5c06\u4e0a\u8ff0\u7684\u6587\u4ef6\u6302\u8f7d\u6743\u9650\u81ea\u5b9a\u4e49\u4e3a0666\uff08\u5bf9\u5e94Linux\u7684\u6587\u4ef6\u6743\u9650\u4e3arw-rw-rw-\uff09\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: dapi-test-pod\nspec:\ncontainers:\n- name: test-container\nimage: busybox\ncommand: [ \"/bin/sh\",\"-c\",\"ls -l /etc/config/..data/\" ]\nvolumeMounts:\n- name: config-volume\nmountPath: /etc/config\nvolumes:\n- name: config-volume\nconfigMap:\nname: special-config\nitems:\n- key: special.how\npath: keys\ndefaultMode: 0666\nrestartPolicy: Never\n</code></pre> <p>\u4e0a\u6587\u4f7f\u7528.configMap.defaultMode\u5b57\u6bb5\u81ea\u5b9a\u4e49\u6587\u4ef6\u6743\u9650\uff0c\u8be5\u6743\u9650\u5bf9.configMap.items\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u5747\u751f\u6548\u3002</p> <p>\u53ef\u4ee5\u4f7f\u7528items[].mode\u5b57\u6bb5\u5355\u72ec \u8bbe\u7f6e\u67d0\u4e2a\u6587\u4ef6\u7684\u6743\u9650\uff0c\u7528\u4e8e\u4e0d\u540c\u6587\u4ef6\u7684\u4e0d\u540c\u6743\u9650\u6302\u8f7d\uff0c\u6bd4\u5982\uff08\u90e8\u5206\u4ee3\u7801\uff09\uff1a <pre><code>volumes:\n- name: config-volume\nconfigMap:\nname: special-config\nitems:\n- key: special.how\npath: keys\nmode: 328\n- key: special.level\npath: level\nmode: 0644\ndefaultMode: 0666\n</code></pre></p> <p>\u6ce8\u610f</p> <p>mode\u5b57\u6bb5\u4f18\u5148\u7ea7\u8f83\u9ad8\uff0c\u4f1a\u8986\u76d6\u5168\u5c40\u7684defaultMode\u3002</p> <p>\u53e6\u5916\u6ce8\u610f\u6743\u9650\u7684\u5199\u6cd5\uff0c \u5728Linux\u4e2d\u7684\u6587\u4ef6\u6743\u9650\u4e3a\u516b\u8fdb\u5236\uff0c\u6bd4\u5982\u4e0a\u8ff0\u76840644\u4e3a\u516b\u8fdb\u5236\u5199\u6cd5\uff0c\u5bf9\u5e94Linux\u7684\u6587\u4ef6\u6743\u9650\u5c31\u662f644\uff08rw-r--r--\uff09\uff0c328\u4e3a\u5341\u8fdb\u5236\u5199\u6cd5\uff0c\u6362\u7b97\u4e3a\u516b\u8fdb\u5236\u4e3a510\uff0c\u90a3\u4e48\u5bf9\u5e94Linux\u7684\u6587\u4ef6\u6743\u9650\u5c31\u662f510\uff08r-x--x---\uff09\u3002 \u5176\u4e2d\u516b\u8fdb\u5236\u7684\u53ef\u914d\u7f6e\u8303\u56f4\u4e3a0000 ~ 0777\uff0c\u5341\u8fdb\u5236\u53ef\u914d\u7f6e\u8303\u56f4\u4e3a0 ~ 511\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#7configmap\u9650\u5236","title":"7.ConfigMap\u9650\u5236","text":"<p>ConfigMap\u5728\u4f7f\u7528\u65f6\u6709\u5f88\u591a\u5c40\u9650\u6027\uff0c\u5982\u679c\u6ca1\u6709\u6b63\u786e\u4f7f\u7528ConfigMap\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4Pod\u4e0d\u80fd\u6b63\u5e38\u64cd\u4f5c\u3002\u76ee\u524d\u5177\u6709\u7684\u9650\u5236\u5982\u4e0b\uff1a</p> <ol> <li>\u5fc5\u987b\u5148\u521b\u5efaConfigMap\u624d\u80fd\u5728Pod\u4e2d\u5f15\u7528\u5b83\uff0c\u5982\u679cPod\u5f15\u7528\u7684ConfigMap\u4e0d\u5b58\u5728\uff0cPod\u5c06\u65e0\u6cd5\u542f\u52a8\uff0c\u4e00\u76f4\u5904\u4e8ePending\u72b6\u6001\uff0c\u53ef\u4ee5\u901a\u8fc7describe\u547d\u4ee4\u67e5\u770b\u3002</li> <li>Pod\u5f15\u7528\u7684\u952e\u5fc5\u987b\u5b58\u5728\u4e8eConfigMap\u4e2d\uff0c\u5426\u5219Pod\u65e0\u6cd5\u542f\u52a8\uff0c\u4e00\u76f4\u5904\u4e8eContainerCreating\u72b6\u6001\uff0c\u53ef\u4ee5\u901a\u8fc7describe\u547d\u4ee4\u67e5\u770b\u3002</li> <li>ConfigMap\u548c\u5f15\u7528\u5b83\u7684Pod\u9700\u8981\u5728\u540c\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u3002 </li> <li>\u4f7f\u7528envFrom\u914d\u7f6e\u5bb9\u5668\u73af\u5883\u53d8\u91cf\u65f6\uff0c\u9ed8\u8ba4\u4f1a\u8df3\u8fc7\u88ab\u89c6\u4e3a\u65e0\u6548\u7684\u952e\uff0c\u4f46\u662f\u4e0d\u5f71\u54cdPod\u542f\u52a8\uff0c\u65e0\u6548\u7684\u53d8\u91cf\u4f1a\u8bb0\u5f55\u5728\u4e8b\u4ef6\u65e5\u5fd7\u4e2d\uff0c\u5177\u4f53\u5982\u4e0b\uff1a     <pre><code># \u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u67e5\u770b\n$ kubectl get events\n</code></pre></li> </ol> <p>\u53c2\u8003\u6587\u6863</p> <p>https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#8\u4f7f\u7528subpath\u5c06configmap\u4f5c\u4e3a\u5355\u72ec\u7684\u6587\u4ef6\u6302\u8f7d\u5230\u76ee\u5f55","title":"8.\u4f7f\u7528subpath\u5c06ConfigMap\u4f5c\u4e3a\u5355\u72ec\u7684\u6587\u4ef6\u6302\u8f7d\u5230\u76ee\u5f55","text":"<p>\u5728\u4e00\u822c\u60c5\u51b5\u4e0bconfigmap\u6302\u8f7d\u6587\u4ef6\u65f6\uff0c\u4f1a\u5148\u8986\u76d6\u6389\u6302\u8f7d\u76ee\u5f55\uff0c\u7136\u540e\u518d\u5c06congfigmap\u4e2d\u7684\u5185\u5bb9\u4f5c\u4e3a\u6587\u4ef6\u6302\u8f7d\u8fdb\u884c\u3002</p> <p>\u5982\u679c\u60f3\u4e0d\u5bf9\u539f\u6765\u7684\u6587\u4ef6\u5939\u4e0b\u7684\u6587\u4ef6\u9020\u6210\u8986\u76d6\uff0c\u53ea\u662f\u5c06 configmap\u4e2d\u7684\u6bcf\u4e2akey\uff0c\u6309\u7167\u6587\u4ef6\u7684\u65b9\u5f0f\u6302\u8f7d\u5230\u76ee\u5f55\u4e0b\uff0c\u53ef\u4ee5\u4f7f\u7528subpath\u53c2\u6570\u3002</p> <p>SubPath\u4e3b\u8981\u7528\u4e8e\u5c06\u540c\u4e00\u4e2aVolume\u7684\u6570\u636e\u6302\u8f7d\u5230\u4e0d\u540c\u7684\u8def\u5f84\uff0c\u540c\u65f6\u4e5f\u80fd\u7528 subPath\u7684\u529f\u80fd\u89e3\u51b3\u6302\u8f7d\u8986\u76d6\u7684\u95ee\u9898\u3002 </p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: dapi-test-pod\nspec:\ncontainers:\n- name: test-container\nimage: nginx\ncommand: [\"/bin/sh\",\"-c\",\"sleep 36000\"]\nvolumeMounts:\n- name: config-volume\nmountPath: /etc/nginx/special.how\nsubPath: special.how\nvolumes:\n- name: config-volume\nconfigMap:\nname: special-config\nitems:\n- key: special.how\npath: special.how\nrestartPolicy: Never\n</code></pre> <pre><code>root@dapi-test-pod:/# ls /etc/nginx/\nconf.d    fastcgi_params    koi-utf  koi-win  mime.types  modules  nginx.conf  scgi_params    special.how  uwsgi_params  win-utf\nroot@dapi-test-pod:/# cat /etc/nginx/special.how\nvery\nroot@dapi-test-pod:/#\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#3-\u52a0\u5bc6\u6570\u636e\u7ba1\u7406secret","title":"3. \u52a0\u5bc6\u6570\u636e\u7ba1\u7406Secret","text":"<p>\u4e0a\u4e00\u8282\u8bb2\u89e3\u7684ConfigMap\u4e3b\u8981\u7528\u4e8e\u975e\u5b89\u5168\u7684\u6570\u636e\uff0c\u4e0e\u5176\u5bf9\u5e94\u7684\u662fSecret\u5bf9 \u8c61\u7c7b\u578b\uff0c\u7528\u6765\u4fdd\u5b58\u654f\u611f\u4fe1\u606f\uff0c\u4f8b\u5982\u5bc6\u7801\u3001\u4ee4\u724c\u548cSSH Key\uff0c\u5c06\u8fd9\u4e9b\u4fe1\u606f\u653e\u5728 Secret\u4e2d\u6bd4\u8f83\u5b89\u5168\u548c\u7075\u6d3b\u3002\u7528\u6237\u53ef\u4ee5\u521b\u5efaSecret\u5e76\u4e14\u5f15\u7528\u5230Pod\u4e2d\uff0c\u6bd4\u5982\u4f7f\u7528 Secret\u521d\u59cb\u5316Redis\u3001MySQL\u5bc6\u7801\u7b49\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#31-secret-\u4e0e-configmap-\u5bf9\u6bd4","title":"3.1 Secret \u4e0e ConfigMap \u5bf9\u6bd4","text":"<p>\u76f8\u540c\u70b9\uff1a</p> <ol> <li>key/value \u7684\u5f62\u5f0f</li> <li>\u5c5e\u4e8e\u67d0\u4e2a\u7279\u5b9a\u7684 namespace</li> <li>\u53ef\u4ee5\u5bfc\u51fa\u5230\u73af\u5883\u53d8\u91cf</li> <li>\u53ef\u4ee5\u901a\u8fc7\u76ee\u5f55 / \u6587\u4ef6\u5f62\u5f0f\u6302\u8f7d (\u652f\u6301\u6302\u8f7d\u6240\u6709 key \u548c\u90e8\u5206 key)</li> </ol> <p>\u4e0d\u540c\u70b9\uff1a</p> <ol> <li>Secret \u53ef\u4ee5\u88ab ServerAccount \u5173\u8054 (\u4f7f\u7528)</li> <li>Secret \u53ef\u4ee5\u5b58\u50a8 register \u7684\u9274\u6743\u4fe1\u606f\uff0c\u7528\u5728 ImagePullSecret \u53c2\u6570\u4e2d\uff0c\u7528\u4e8e\u62c9\u53d6\u79c1\u6709\u4ed3\u5e93\u7684\u955c\u50cf</li> <li>Secret \u652f\u6301 Base64 \u52a0\u5bc6</li> <li>Secret \u5206\u4e3a Opaque\uff0ckubernetes.io/Service Account\uff0ckubernetes.io/dockerconfigjson \u4e09\u79cd\u7c7b\u578b, Configmap \u4e0d\u533a\u5206\u7c7b\u578b</li> <li>Secret \u6587\u4ef6\u5b58\u50a8\u5728 tmpfs \u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0cPod \u5220\u9664\u540e Secret \u6587\u4ef6\u4e5f\u4f1a\u5bf9\u5e94\u7684\u5220\u9664\u3002</li> </ol>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#32-\u4ee5\u6587\u4ef6\u5f62\u5f0f\u6302\u8f7dsecret","title":"3.2 \u4ee5\u6587\u4ef6\u5f62\u5f0f\u6302\u8f7dSecret","text":"<pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: mypod\nspec:\ncontainers:\n- name: mypod\nimage: redis\nvolumeMounts:\n- name: foo\nmountPath: \"/etc/foo\"\nreadOnly: true\nvolumes:\n- name: foo\nsecret: # configMap\u6362\u6210secret\nsecretName: mysecret # configMap\u7c7b\u578b\u4e3aname\n</code></pre> <p>\u7528\u5230\u7684\u6bcf\u4e2aSecret\u90fd\u9700\u8981\u5728spec.volumes\u4e2d\u6307\u660e\uff0c\u5982\u679cPod\u4e2d\u6709\u591a\u4e2a\u5bb9 \u5668\uff0c\u6bcf\u4e2a\u5bb9\u5668\u90fd\u9700\u8981\u81ea\u5df1\u7684volumeMounts\u914d\u7f6e\u5757\uff0c\u7528\u4ee5\u6302\u8f7dvolume\u81f3\u672c\u5730\u67d0 \u4e2a\u76ee\u5f55\uff0c\u4f46\u662f\u6bcf\u4e2aSecret\u53ea\u9700\u8981\u4e00\u4e2aspec.volumes\uff08\u6ce8\u610fvolumes\u7684\u4f4d\u7f6e\uff09\uff0c \u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u5e94\u7528\u573a\u666f\u5c06\u591a\u4e2a\u6587\u4ef6\u6253\u5305\u5230\u4e00\u4e2aSecret\u4e2d\uff0c\u6216\u8005\u4f7f\u7528\u591a\u4e2a Secret\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#33-\u81ea\u5b9a\u4e49\u6587\u4ef6\u540d\u6302\u8f7d","title":"3.3 \u81ea\u5b9a\u4e49\u6587\u4ef6\u540d\u6302\u8f7d","text":"<pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: mypod\nspec:\ncontainers:\n- name: mypod\nimage: redis\nvolumeMounts:\n- name: foo\nmountPath: \"/etc/foo\"\nreadOnly: true\nvolumes:\n- name: foo\nsecret:\nsecretName: mysecret\nitems:\n- key: username\npath: my-group/my-username\n</code></pre>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#34-secret\u4f5c\u4e3a\u73af\u5883\u53d8\u91cf","title":"3.4 Secret\u4f5c\u4e3a\u73af\u5883\u53d8\u91cf","text":"<p>Secret\u540c\u6837\u53ef\u4ee5\u4f5c\u4e3a\u73af\u5883\u53d8\u91cf\u4f7f\u7528\uff0c\u548cConfigMap\u7684\u914d\u7f6e\u65b9\u5f0f\u4e00\u81f4\uff0c\u53ea\u9700\u8981\u66f4\u6539\u5bf9\u5e94\u7684\u5b57\u6bb5\u540d\u5373\u53ef\uff0c\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <p>1\uff09\u521b\u5efa\u4e00\u4e2aSecret\u6216\u8005\u4f7f\u7528\u4e00\u4e2a\u5df2\u5b58\u5728\u7684Secret\uff0c\u591a\u4e2aPod\u53ef\u4ee5\u5f15\u7528\u540c \u4e00\u4e2aSecret\u3002 2) \u4e3a\u6bcf\u4e2a\u5bb9\u5668\u6dfb\u52a0\u5bf9\u5e94\u7684Secret env.valueFrom.secretKeyRef\u3002</p> <p>Key\u73af\u5883\u53d8\u91cf\u6bd4\u5982\uff0c\u5b9a\u4e49SECRET_USERNAME\u548cSECRET_PASSWORD\u4e24\u4e2a\u73af\u5883\u53d8\u91cf\uff0c\u5176\u503c\u6765\u81ea\u4e8e\u540d\u5b57\u4e3amysecret\u7684Secret\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: secret-env-pod\nspec:\ncontainers:\n- name: mycontainer\nimage: redis\nenv:\n- name: SECRET_USERNAME\nvalueFrom:\nsecretKeyRef:\nname: mysecret\nkey: username\n- name: SECRET_PASSWORD\nvalueFrom:\nsecretKeyRef:\nname: mysecret\nkey: password\nrestartPolicy: Never\n</code></pre> <p>\u6ce8\u610f</p> <p>envFrom\u7684\u7528\u6cd5\u548cConfigMap\u4e00\u81f4\uff0c\u5c06configMapRef\u6539\u4e3asecretRef\u5373\u53ef\uff0c\u5728\u6b64\u4e0d\u518d\u6f14\u793a\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#35-secret\u6587\u4ef6\u6743\u9650","title":"3.5 Secret\u6587\u4ef6\u6743\u9650","text":"<p>\u6587\u4ef6\u6743\u9650\u548cConfigMap\u65e0\u533a\u522b\uff0c\u5728\u6b64\u4e0d\u518d\u6f14\u793a\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#36-\u5e38\u7528\u7684secret\u7c7b\u578b","title":"3.6 \u5e38\u7528\u7684Secret\u7c7b\u578b","text":"<p>\u4e0a\u8ff0\u521b\u5efa\u7684Secret\u5747\u4e3a\u901a\u7528\u578bSecret\uff0c\u5373\u901a\u8fc7\u547d\u4ee4\u884ckubectl create secret generic\u521b\u5efa\u7684\uff0c\u521b\u5efa\u540e\u7684\u7c7b\u578b\u4e3aOpaque\uff0c\u53ef\u4ee5\u901a\u8fc7get\u547d\u4ee4\u67e5\u770b\u3002</p> <p>\u4f46\u662f\u548cConfigMap\u4e0d\u540c\u7684\u662fSecret\u6709\u5f88\u591a\u79cd\u7c7b\u578b\uff0c\u6bd4\u5982\uff1a</p> <ul> <li>Opaque\uff1a\u901a\u7528\u578bSecret\uff0c\u9ed8\u8ba4\u7c7b\u578b\u3002</li> <li>kubernetes.io/service-account-token\uff1a\u4f5c\u7528\u4e8eServiceAccount,\u5305\u542b\u4e00\u4e2a\u4ee4\u724c\uff0c\u7528\u4e8e\u6807\u8bc6API\u670d\u52a1\u8d26\u6237\u3002</li> <li> <p>kubernetes.io/dockercfg: Kubernetes\u4e0b\u8f7d\u79c1\u6709\u4ed3\u5e93\u955c\u50cf\u4f7f\u7528\u7684Secret\uff0c\u548c\u5bbf\u4e3b\u673a\u7684~/.dockercfg\u4e00\u81f4,\u65b0\u7248\u672c\u7684Kubernetes(1.8+)\u4f7f\u7528kubernetes.io/dockerconfigjson\u66ff\u4ee3kubernetes.io/dockercfg\u3002</p> </li> <li> <p>kubernetes.io/dockerconfigjson \uff1a \u4e0b\u8f7d\u79c1\u6709\u4ed3\u5e93\u955c\u50cf\u4f7f\u7528\u7684Secret\uff0c\u548c\u5bbf\u4e3b\u673a\u7684/root/.docker/config.json\u4e00\u81f4\uff0c\u5bbf\u4e3b\u673a\u767b\u5f55 \u540e\u5373\u53ef\u4ea7\u751f\u8be5\u6587\u4ef6\u3002</p> </li> <li>kubernetes.io/basic-auth\uff1a\u7528\u4e8e\u4f7f\u7528\u57fa\u672c\u8ba4\u8bc1\uff08\u8d26\u53f7\u3001\u5bc6\u7801\uff09\u7684Secret\uff0c\u53ef\u4ee5\u4f7f\u7528Opaque\u53d6\u4ee3\u3002</li> <li>kubernetes.io/ssh-auth\uff1a\u7528\u4e8e\u5b58\u50a8SSH\u5bc6\u94a5\u7684Secret\u3002</li> <li>kubernetes.io/tls\uff1a\u7528\u4e8e\u5b58\u50a8HTTPS\u57df\u540d\u8bc1\u4e66\u6587\u4ef6\u7684Secret\uff0c\u53ef\u4ee5\u88abIngress\u4f7f\u7528\u3002</li> <li>bootstrap.kubernetes.io/token\uff1a\u4e00\u79cd\u7b80\u5355\u7684bearer token\uff0c\u7528\u4e8e\u521b\u5efa\u65b0\u96c6\u7fa4\u6216\u5c06\u65b0\u8282\u70b9\u6dfb\u52a0\u5230\u73b0\u6709\u96c6\u7fa4\uff0c\u5728\u96c6\u7fa4\u5b89\u88c5\u65f6\u53ef\u7528\u4e8e\u81ea\u52a8 \u9881\u53d1\u96c6\u7fa4\u7684\u8bc1\u4e66\u3002</li> </ul> <p>Secret\u7c7b\u578b\u6709\u5f88\u591a\uff0c\u4f46\u662f\u5728\u5b9e\u9645\u4f7f\u7528\u65f6\uff0c\u7528\u5f97\u6700\u591a\u7684\u662f\u901a\u7528\u578bOpaque\u3001 \u955c\u50cf\u4ed3\u5e93Secret\u548cHTTPS\u8bc1\u4e66\u7684Secret\uff0c\u4e0a\u8ff0\u4ecb\u7ecd\u7684\u5747\u4e3a\u901a\u7528\u578b\u7684Opaque\uff0c \u63a5\u4e0b\u6765\u8bb2\u89e3\u4e00\u4e0b\u5176\u4ed6\u7c7b\u578b\u7684Secret\u5982\u4f55\u4f7f\u7528\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#37-docker\u955c\u50cf\u4ed3\u5e93secret","title":"3.7 Docker\u955c\u50cf\u4ed3\u5e93Secret","text":"\u53c2\u8003\u6587\u732e <p>https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/pull-image-private-registry/</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#38-https\u8bc1\u4e66\u7c7b\u578b\u7684secret","title":"3.8 HTTPS\u8bc1\u4e66\u7c7b\u578b\u7684Secret","text":"<p>\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5e94\u7528\u670d\u52a1\u4e00\u822c\u90fd\u662f\u4f7f\u7528HTTPS\u534f\u8bae\u53d1\u5e03\u7684\uff0c\u53ef\u4ee5\u8d77\u5230\u52a0\u5bc6\u901a \u4fe1\u7684\u4f5c\u7528\u3002\u5728\u4f20\u7edf\u67b6\u6784\u4e2d\uff0c\u57df\u540d\u8bc1\u4e66\u4e00\u822c\u5728\u96c6\u7fa4\u5165\u53e3\u7684\u4ee3\u7406\u670d\u52a1\u5668\u4e0a\u8fdb\u884c\u7ba1 \u7406\uff0c\u6bd4\u5982Nginx\uff0c\u800c\u5728Kubernetes\u4e2d\uff0c\u4e00\u822c\u670d\u52a1\u90fd\u662f\u901a\u8fc7Ingress\u53d1\u5e03\u7684\uff0c\u6b64 \u65f6\u53ef\u4ee5\u5c06\u57df\u540d\u8bc1\u4e66\u4fdd\u5b58\u5728TLS\u7c7b\u578b\u7684Secret\u4e0a\uff0c\u4e4b\u540eIngress\u5373\u53ef\u7ed1\u5b9a\u8be5\u8bc1\u4e66\u3002 \u9996\u5148\u521b\u5efaHTTPS\u7684\u8bc1\u4e66\u6587\u4ef6\uff0c\u5047\u8bbe\u57df\u540d\u4e3atest.com\uff08\u751f\u4ea7\u73af\u5883\u4e2d\u7684\u8bc1\u4e66\u4e3a \u8d2d\u4e70\u7684\u53d7\u4fe1\u4efb\u7684\u8bc1\u4e66\uff0c\u81ea\u7b7e\u540d\u8bc1\u4e66\u4e0d\u53d7\u6d4f\u89c8\u5668\u4fe1\u4efb\uff09\uff1a</p> <pre><code>$ openssl req -x509 -nodes -days 365 --newkey rsa:2048 -keyout tls.key -out tls.crt =subj \"/CN=test.com\"\n</code></pre> <p>\u4e4b\u540e\u6839\u636e\u751f\u6210\u7684tls.key\u548ctls.crt\u521b\u5efaSecret\uff1a</p> <pre><code>$ kubectl -n default create secret tls nginx-test-tls -- key=tls.key --cert=tls.crt\n</code></pre> <p>\u6700\u540e\u521b\u5efa\u4e00\u4e2aIngress\u5c06\u8bc1\u4e66\u7ed1\u5b9a\u5230\u6307\u5b9a\u7684\u57df\u540d\u4e0a\uff1a <pre><code>apiVersion: networking.k8s.io/v1beta1\nkind: Ingress\nmetadata:\nname: nginx-https-test\nannotations:\nkubernetes.io/ingress.class: \"nginx\" # \u4e0d\u540c\u7684controller\uff0cingress.class\u53ef\u80fd\u4e0d\u4e00\u81f4\nspec:\nrules:\n- host: https-test.com\nhttp:\npaths:\n- backend:\nserviceName: nginx-svc\nservicePort: 80\ntls:\n- secretName: nginx-test-tls\n</code></pre></p> <p>\u5c0f\u77e5\u8bc6</p> <p>\u4e00\u4e2aIngress\u53ef\u4ee5\u7ed1\u5b9a\u591a\u4e2aTLS\u7c7b\u578b\u7684Secret\uff0c\u540c\u4e00\u4e2aSecret\u4e5f\u53ef\u4ee5\u88ab\u591a\u4e2a Ingress\u4f7f\u7528\u3002</p> <p>\u53c2\u8003\u6587\u6863 <p>Secret</p> <p>https://kubernetes.io/docs/concepts/configuration/secret/</p> </p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#4-configmap\u70ed\u66f4\u65b0\u548c\u683c\u5f0f\u4fee\u590d","title":"4. ConfigMap\u70ed\u66f4\u65b0\u548c\u683c\u5f0f\u4fee\u590d","text":"<p>\u5b9e\u9645\u4f7f\u7528ConfigMap\u548cSecret\u65f6\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u90fd\u662f\u76f4\u63a5\u4f7f\u7528\u6587\u4ef6\u521b\u5efa\uff0c \u4e5f\u5c31\u662f\u4f7f\u7528--from-file=xxx\u7684\u683c\u5f0f\u8fdb\u884c\u521b\u5efa\u3002</p> <p>\u521b\u5efa\u7684ConfigMap\u53ef\u80fd\u56e0\u4e3a\u6362\u884c\u7684\u95ee\u9898\uff0c\u5bfc\u81f4\u4f7f\u7528<code>kubectl edit cm xxx</code>\u65f6\u6392\u7248\u5f88\u4e71\uff0c\u7f16\u8f91\u8d77\u6765\u5f88\u53d7\u5f71\u54cd\u3002</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#41-configmap\u683c\u5f0f\u4fee\u590d","title":"4.1 Configmap\u683c\u5f0f\u4fee\u590d","text":"<p>\u5907\u5fd8configmap\u683c\u5f0f\u5316</p> <pre><code>#kubectl create cm node-local-dns  --from-file Corefile\nkubectl get cm node-local-dns -o json | jq '.data.Corefile' -r\n\n# \u4f7f\u7528\u4ee5\u4e0b\u65b9\u6cd5\u5220\u9664\u5c3e\u968f\u7a7a\u683c\nsed -i -E 's/[[:space:]]+$//g' file.txt\n# \u4f7f\u7528\u7a7a\u683c\u66ff\u6362\u5236\u8868\u7b26\nsed -i 's/\\t/    /g' file.txt\n</code></pre> <p>\u53c2\u8003</p> <p>https://stackoverflow.com/questions/51291521/kubernetes-configmap-prints-n-instead-of-a-newline</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#42-configmap\u70ed\u66f4\u65b0","title":"4.2 Configmap\u70ed\u66f4\u65b0","text":"<p>\u53e6\u5916\uff0c\u4f7f\u7528<code>kubectl edit secret xxx</code>\u65f6\uff0c\u7531\u4e8eSecret\u6570\u636e\u4e3a\u52a0\u5bc6\u6570\u636e,\u65e0\u6cd5\u76f4\u63a5\u7f16\u8f91\u3002</p> <p>\u56e0\u6b64\u4e00\u822c\u60c5\u51b5\u4e0b\u90fd\u662f\u4fee\u6539\u6e90\u6587\u4ef6\uff0c\u7136\u540ereplace\u4e4b\u524d\u7684ConfigMap\u6216Secret,\u547d\u4ee4\u5982\u4e0b\uff08Secret\u548cConfigMap\u70ed\u66f4\u65b0\u547d\u4ee4\u683c\u5f0f\u4e00\u81f4\uff09\uff1a</p> <pre><code>$ kubectl create secret generic nginx-conf --from-file=nginx.conf --dry-run -o yaml | kubectl replace -f -\n</code></pre> <ul> <li>generic\uff1a\u6307\u5b9a\u4e3a\u901a\u7528\u578bSecret\u3002</li> <li>nginx-conf\uff1aSecret\u7684\u540d\u79f0\u3002</li> <li>dry-run -o yaml\uff1a\u53ea\u8fd0\u884c\u547d\u4ee4,\u5e76\u4e0d\u771f\u6b63\u5730\u521b\u5efa\uff0c\u5e76\u4ee5YAML\u7684\u683c\u5f0f\u8f93\u51fa,\u6bd4\u5982\uff1a</li> </ul> <pre><code>kubectl create secret generic nginx-conf --from-file=nginx.conf --dry-run -o yaml apiVersion: v1\ndata:\n  nginx.conf: ZGFlbW9uIG9uOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIOS7peWuiOaKpOi/m+eoi+eahOaWueW8j+i......\nkind: Secret\nmetadata:\n  name: nginx-conf\n</code></pre> <p><code>kubectl replace -f -</code>\uff1a\u901a\u8fc7\u6587\u4ef6\u521b\u5efa\u7684Secret\u548cConfigMap\u4e0d\u80fd\u88ab\u76f4\u63a5\u66ff\u6362\uff0c\u4f46\u662f\u901a\u8fc7YAML\u6587\u4ef6\u521b\u5efa\u53ef\u4ee5\u88ab\u66ff\u6362\uff0c\u6240\u4ee5\u5148\u4f7f\u7528<code>dry-run -o yaml</code>\u751f\u6210YAML\u6587\u4ef6\uff0c</p> <p>\u518d\u8fdb\u884creplace\u5373\u53ef\u5b9e\u73b0\u70ed\u66f4\u65b0\uff0c\u8be5\u65b9\u6cd5\u53ef\u4ee5\u7528\u4e8e\u5176\u4ed6\u8d44\u6e90\u7c7b\u578b\uff0c\u901a\u8fc7YAML\u6587\u4ef6\u66ff\u6362\u5df2\u7ecf\u521b\u5efa\u7684\u8d44\u6e90\u4e5f\u662f\u53ef\u4ee5\u7684\u3002</p> <p>\u6ce8\u610f</p> <ul> <li> <p>\u5982\u679cConfigMap\u548cSecret\u662f\u901a\u8fc7\u67d0\u4e2aYAML\u6587\u4ef6\u521b\u5efa\u7684\uff0c\u53ef\u4ee5\u76f4\u63a5\u4fee\u6539\u8fd9\u4e2aYAML\u6587\u4ef6\uff0c\u7136\u540e\u8fdb\u884creplace\u5373\u53ef\u66f4\u65b0\u3002</p> </li> <li> <p>\u53e6\u5916\u66f4\u65b0\u540e\uff0c\u6302\u8f7d\u5230\u5bb9\u5668\u91cc\u9762\u7684\u6587\u4ef6\u4e0d\u4f1a\u88ab\u7acb\u5373\u66f4\u65b0\uff0c\u800c\u662fkubelet\u4f1a\u5468\u671f\u6027\u5730\u68c0\u67e5\u5e76\u8fdb\u884c\u91cd\u65b0\u6302\u8f7d\u64cd\u4f5c\u3002</p> </li> <li> <p>\u6302\u8f7d\u7684\u6587\u4ef6\u66f4\u65b0\u540e\uff0c\u9700\u8981\u7a0b\u5e8f\u81ea\u884c\u5904\u7406\u65b0\u914d\u7f6e\uff0c\u4e5f\u5c31\u662f\u7a0b\u5e8f\u70ed\u52a0\u8f7d\u529f\u80fd\uff0c\u6bd4\u5982Kubernetes\u4e91\u539f\u751f\u76d1\u63a7\u5e73\u53f0Prometheus\u5c31\u5b9e\u73b0\u4e86\u8be5\u529f\u80fd\uff0c\u66f4\u6539Prometheus\u7684\u914d\u7f6e\u6587\u4ef6\u540e\uff0c\u65e0\u987b\u91cd\u542fPrometheus\u8fdb\u7a0b\u53caPrometheus\u5bb9\u5668\u5373\u53ef\u52a0\u8f7d\u65b0\u914d\u7f6e\uff0c\u5982\u679c\u7a0b\u5e8f\u6ca1\u6709\u5b9e\u73b0\u8be5\u529f\u80fd\uff0c\u90a3\u4e48\u53ea\u80fd\u91cd\u542f\u5bb9\u5668\u52a0\u8f7d\u65b0\u914d\u7f6e\u3002</p> </li> </ul> <p>\u53c2\u8003\u6587\u732e</p> <p>https://www.yuque.com/jiaoyin-j930b/mry4p5/bhbyor</p> <p>https://jimmysong.io/kubernetes-handbook/concepts/configmap-hot-update.html</p>"},{"location":"Kubernetes/2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/#5-\u5c0f\u7ed3","title":"5. \u5c0f\u7ed3","text":"<p>\u672c\u7ae0\u5b66\u4e60\u4e86Kubernetes\u7684\u914d\u7f6e\u7ba1\u7406\uff0c\u53ef\u4ee5\u4f7f\u7528ConfigMap\u548cSecret\u7ba1\u7406\u5e94\u7528\u7a0b\u5e8f\u7684\u914d\u7f6e\uff0c\u8fd9\u4e5f\u662f\u4e91\u539f\u751f\u8981\u7d20\u975e\u5e38\u91cd\u8981\u7684\u4e00\u73af\u2014\u2014\u914d\u7f6e\u5206\u79bb\u3002</p> <p>\u5728\u7a0b\u5e8f\u5f00\u53d1\u65f6\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u7a0b\u5e8f\u5458\u9700\u8981\u6709\u8fd9\u79cd\u610f\u8bc6\uff0c\u5c31\u662f\u5c06\u6240\u6709\u7684\u53ef\u53d8\u914d\u7f6e\u90fd\u653e\u7f6e\u4e8e\u4ee3\u7801\u4e4b\u5916\uff0c\u8fd9\u662f\u975e\u5e38\u91cd\u8981\u7684\u7a0b\u5e8f\u8bbe\u8ba1\u3002</p> <p>\u4e0d\u4ec5\u7a0b\u5e8f\u7684\u7075\u6d3b\u6027\u9ad8\uff0c\u7ba1\u7406\u8d77\u6765\u4e5f\u4f1a\u66f4\u52a0\u65b9\u4fbf\uff0c\u5728\u4e0d\u540c\u7684\u73af\u5883\u90e8\u7f72\u5e94\u7528\uff0c\u4e0d\u9700\u8981\u4fee\u6539\u4efb\u4f55\u4ee3\u7801\uff0c\u53ea\u9700\u8981\u4fee\u6539\u5916\u7f6e\u7684\u914d\u7f6e\u6587\u4ef6\u5373\u53ef\u3002</p> <p>Kubernetes\u7684\u914d\u7f6e\u7ba1\u7406\u53ef\u4ee5\u4f5c\u4e3a\u914d\u7f6e\u6587\u4ef6\u6302\u8f7d\uff0c\u4e5f\u53ef\u4ee5\u914d\u7f6e\u4e3a\u73af\u5883\u53d8\u91cf\uff0c\u7a0b\u5e8f\u9002\u914d\u5176\u4e2d\u7684\u4e00\u79cd\u5373\u53ef\u6ee1\u8db3\u9700\u6c42\u3002</p> <p>\u5982\u679c\u6709\u66f4\u590d\u6742\u7684\u914d\u7f6e\u9700\u6c42\uff0c\u6bd4\u5982\u9700\u8981\u5ba1\u6838\u3001\u5907\u4efd\u3001\u56de\u6eda\u7b49\uff0c\u53ef\u4ee5\u91c7\u7528\u4e13\u7528\u7684\u914d\u7f6e\u4e2d\u5fc3\uff0c\u6bd4\u5982Apollo\u3001Nacos\u548cSpringCloud\u7684ConfigServer\u7b49\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/","title":"Kubernetes\u5b58\u50a8\u5165\u95e8","text":"<p>\u524d\u9762\u5df2\u7ecf\u8bb2\u89e3\u4e86Kubernetes\u7684\u5927\u90e8\u5206\u77e5\u8bc6\u70b9\uff0c\u76f8\u4fe1\u8bfb\u8005\u5df2\u7ecf\u6162\u6162\u9886\u609f\u5230\u4e86Kubernetes\u7684\u7cbe\u9ad3\u3002\u4f46\u662f\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u8fd8\u4e0d\u8db3\u4ee5\u6ee1\u8db3\u4f01\u4e1a\u5185\u5404\u79cd\u590d\u6742\u7684\u573a\u666f\uff0c\u56e0\u4e3a\u6211\u4eec\u5e76\u6ca1\u6709\u8bb2\u5230\u4efb\u4f55\u5173\u4e8e\u6570\u636e\u5b58\u50a8\u548c\u6570\u636e\u4ea4\u6362\u7684\u5185\u5bb9\u3002</p> <p>\u800c\u6570\u636e\u662f\u4e00\u4e2a\u4f01\u4e1a\u53d1\u5c55\u7684\u6838\u5fc3\uff0c\u5728\u751f\u4ea7\u4e2d\u662f\u5c24\u4e3a\u91cd\u8981\u7684\u4e00\u90e8\u5206\uff0c\u6240\u4ee5\u672c\u7ae0\u5c06\u5e26\u9886\u8bfb\u8005\u5b66\u4e60Kubernetes\u53e6\u4e00\u4e2a\u6bd4\u8f83\u91cd\u8981\u5e76\u4e14\u7a0d\u5fae\u6709\u4e9b\u96be\u5ea6\u7684\u77e5\u8bc6\u70b9\u2014\u2014\u6570\u636e\u6301\u4e45\u5316Volume\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#1-volume\u7684\u6982\u5ff5","title":"1. Volume\u7684\u6982\u5ff5","text":"<p>\u5bf9\u4e8e\u5927\u591a\u6570\u9879\u76ee\u800c\u8a00\uff0c\u6570\u636e\u6587\u4ef6\u7684\u5b58\u50a8\u662f\u975e\u5e38\u5e38\u89c1\u7684\u9700\u6c42\uff0c\u6bd4\u5982\u5b58\u50a8\u7528\u6237\u4e0a\u4f20\u7684\u5934\u50cf\u3001\u4e0a\u4f20\u7684\u6587\u4ef6\u4ee5\u53ca\u6570\u636e\u5e93\u7684\u6570\u636e\u3002</p> <p>\u5728Kubernetes\u4e2d\uff0c\u7531\u4e8e\u5e94\u7528\u7684\u90e8\u7f72\u5177\u6709\u9ad8\u5ea6\u7684\u53ef\u6269\u5c55\u6027\u548c\u7f16\u6392\u80fd\u529b\uff08\u4e0d\u50cf\u4f20\u7edf\u67b6\u6784\u90e8\u7f72\u5728\u56fa\u5b9a\u7684\u4f4d\u7f6e\uff09\uff0c\u56e0\u6b64\u628a\u6570\u636e\u5b58\u653e\u5728\u672c\u5730\u662f\u975e\u5e38\u4e0d\u53ef\u53d6\u7684\uff0c\u8fd9\u6837\u505a\u4e5f\u65e0\u6cd5\u4fdd\u969c\u6570\u636e\u7684\u5b89\u5168\u3002</p> <p>\u5982\u679c\u8bfb\u8005\u5bf9\u4e91\u539f\u751f\u5e94\u7528\u6709\u6240\u4e86\u89e3\uff0c\u5c31\u4f1a\u77e5\u9053\u5176\u4e2d\u7684\u4e00\u4e2a\u6982\u5ff5\u2014\u2014\u628a\u6709\u72b6\u6001\u5e94\u7528\u53d8\u6210\u65e0\u72b6\u6001\u5e94\u7528\uff0c\u610f\u6307\u628a\u6570\u636e\u4ece\u5e94\u7528\u4e2d\u5265\u79bb\u51fa\u6765\uff0c\u628a\u4ea7\u751f\u7684\u6570\u636e\u6587\u4ef6\u6216\u8005\u7f13\u5b58\u4fe1\u606f\u90fd\u653e\u5728\u201c\u4e91\u7aef\u201d\uff0c \u6bd4\u5982\u5e38\u7528\u7684NFS\uff08\u751f\u4ea7\u73af\u5883\u6781\u4e0d\u5efa\u8bae\u4f7f\u7528\uff0c\u56e0\u4e3aNFS\u5b58\u5728\u5355\u70b9\u6545\u969c\uff0c\u63a8\u8350\u4f7f\u7528\u5206\u5e03\u5f0f\u5b58\u50a8\u6216\u8005\u516c\u6709\u4e91\u7684NAS\u670d\u52a1\uff09\u3001Ceph\u3001GlusterFS\uff08\u53ef\u80fd\u4f1a\u505c\u6b62\u7ef4\u62a4\uff09\u3001Minio\u7b49\u3002</p> <p>\u5728\u4f20\u7edf\u67b6\u6784\u4e2d\uff0c\u5982\u679c\u8981\u4f7f\u7528\u8fd9\u4e9b\u5b58\u50a8\uff0c\u9700\u8981\u63d0\u524d\u5728\u5bbf\u4e3b\u673a\u6302\u8f7d\uff0c\u7136\u540e\u7a0b\u5e8f\u624d\u80fd\u8bbf\u95ee\uff0c\u5728\u5b9e\u9645\u4f7f\u7528\u65f6\uff0c\u7ecf\u5e38\u78b0\u5230\u65b0\u52a0\u8282\u70b9\u5fd8\u8bb0\u6302\u8f7d\u5b58\u50a8\u5bfc\u81f4\u7684\u4e00\u7cfb\u5217\u95ee\u9898\u3002\u800cKubernetes\u5728\u8bbe\u8ba1\u4e4b\u521d\u5c31\u8003\u8651\u4e86\u8fd9\u4e9b\u95ee\u9898\uff0c\u5e76\u62bd\u8c61\u51faVolume\u7684\u6982\u5ff5\u7528\u4e8e\u89e3\u51b3\u6570\u636e\u5b58\u50a8\u7684\u95ee\u9898\u3002</p> <p>\u5728\u5bb9\u5668\u4e2d\u7684\u78c1\u76d8\u6587\u4ef6\u662f\u77ed\u6682\u7684\uff0c\u5f53\u5bb9\u5668\u5d29\u6e83\u65f6\uff0cKubelet\u4f1a\u91cd\u65b0\u542f\u52a8\u5bb9\u5668\uff0c\u4f46\u5bb9\u5668\u8fd0\u884c\u65f6\u4ea7\u751f\u7684\u6570\u636e\u6587\u4ef6\u90fd\u5c06\u4f1a\u4e22\u5931\uff0c\u4e4b\u540e\u5bb9\u5668\u4f1a\u4ee5\u6700\u5e72\u51c0\u7684\u72b6\u6001\u542f\u52a8\u3002</p> <p>\u53e6\u5916\uff0c\u5f53\u4e00\u4e2aPod\u8fd0\u884c\u591a\u4e2a\u5bb9\u5668\u65f6\uff0c\u5404\u4e2a\u5bb9\u5668\u53ef\u80fd\u9700\u8981\u5171\u4eab\u4e00\u4e9b\u6587\u4ef6\uff0c\u8bf8\u5982\u6b64\u7c7b\u7684\u9700\u6c42\u90fd\u53ef\u4ee5\u4f7f\u7528Volume\u89e3\u51b3\u3002</p> <p>Docker\u4e5f\u6709\u5377\u7684\u6982\u5ff5\uff0c\u4f46\u662f\u5728Docker\u4e2d\uff0c\u5377\u53ea\u662f\u78c1\u76d8\u4e0a\u6216\u53e6\u4e00\u4e2a\u5bb9\u5668\u4e2d\u7684\u76ee\u5f55\uff0c\u5176\u751f\u547d\u5468\u671f\u4e0d\u53d7\u7ba1\u7406\u3002</p> <p>\u867d\u7136Docker\u5df2\u7ecf\u63d0\u4f9b\u4e86\u5377\u9a71\u52a8\u7a0b\u5e8f\uff0c\u4f46\u662f\u529f\u80fd\u975e\u5e38\u6709\u9650\uff0c\u4f8b\u5982\u4eceDocker 1.7\u7248\u672c\u5f00\u59cb\uff0c\u6bcf\u4e2a\u5bb9\u5668\u53ea\u5141\u8bb8\u4e00\u4e2a\u5377\u9a71\u52a8\u7a0b\u5e8f\uff0c\u5e76\u4e14\u65e0\u6cd5\u5c06\u4e00\u4e9b\u7279\u6b8a\u7684\u53c2\u6570\u4f20\u9012\u7ed9\u540e\u7aef\u5b58\u50a8\u3002</p> <p>\u4ece\u672c\u8d28\u4e0a\u8bb2\uff0c\u548c\u865a\u62df\u673a\u6216\u8005\u7269\u7406\u673a\u4e00\u6837\uff0c\u5377\u88ab\u6302\u8f7d\u540e\uff0c\u5728\u5bb9\u5668\u4e2d\u4e5f\u53ea\u662f\u4e00\u4e2a\u76ee\u5f55\uff0c\u53ef\u80fd\u5305\u542b\u4e00\u4e9b\u6570\u636e\uff0cPod\u4e2d\u7684\u5bb9\u5668\u4e5f\u53ef\u4ee5\u5bf9\u5176\u8fdb\u884c\u589e\u5220\u6539\u67e5\u64cd\u4f5c\uff0c\u4f7f\u7528\u65b9\u5f0f\u548c\u88f8\u673a\u6302\u8f7d\u51e0\u4e4e\u6ca1\u6709\u533a\u522b\u3002</p> <p>\u8981\u4f7f\u7528\u5377\u4e5f\u975e\u5e38\u7b80\u5355\uff0c\u548c\u5176\u4ed6\u53c2\u6570\u7c7b\u4f3c\uff0cPod\u53ea\u9700\u8981\u901a\u8fc7.spec.volumes\u5b57\u6bb5\u6307\u5b9a\u4e3aPod\u63d0\u4f9b\u7684\u5377\uff0c \u7136\u540e\u5728\u5bb9\u5668\u4e2d\u914d\u7f6e\u5757\uff0c\u4f7f\u7528.spec.containers.volumeMounts\u5b57\u6bb5\u6307\u5b9a\u5377\u6302\u8f7d\u7684\u76ee\u5f55\u5373\u53ef\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#2-volume\u7684\u7c7b\u578b","title":"2. Volume\u7684\u7c7b\u578b","text":"<p>\u5728\u4f20\u7edf\u67b6\u6784\u4e2d\uff0c\u4f01\u4e1a\u5185\u53ef\u80fd\u6709\u81ea\u5df1\u7684\u5b58\u50a8\u5e73\u53f0\uff0c\u6bd4\u5982NFS\u3001Ceph\u3001GlusterFS\u3001Minio\u7b49\u3002\u5982\u679c\u8bfb\u8005\u7684\u73af\u5883\u5728\u516c\u6709\u4e91\uff0c\u53ef\u4ee5\u4f7f\u7528\u516c\u6709\u4e91\u63d0\u4f9b\u7684NAS\u3001\u5bf9\u8c61\u5b58\u50a8\u7b49\u3002\u5728Kubernetes\u4e2d\uff0cVolume\u4e5f\u652f\u6301\u914d\u7f6e\u4ee5\u4e0a\u5b58\u50a8\uff0c\u7528\u4e8e\u6302\u8f7d\u5230Pod\u4e2d\u5b9e\u73b0\u6570\u636e\u7684\u6301\u4e45\u5316\u3002</p> <p>Kubernetes Volume\u652f\u6301\u7684\u5377\u7684\u7c7b\u578b\u6709\u5f88\u591a\uff0c\u4ee5\u4e0b\u4e3a\u5e38\u7528\u7684\u5377\uff1a</p> <ul> <li>CephFS\u3002</li> <li>GlusterFS\u3002</li> <li>ISCSI\u3002</li> <li>Cinder\u3002</li> <li>NFS\u3002</li> <li>RBD\u3002</li> <li>HostPath\u3002</li> </ul> <p>\u5f53\u7136\uff0c\u4e5f\u652f\u6301\u4e00\u4e9bKubernetes\u72ec\u6709\u7684\u7c7b\u578b\uff1a</p> <ul> <li>ConfigMap\uff1a\u7528\u4e8e\u5b58\u50a8\u914d\u7f6e\u6587\u4ef6\u3002</li> <li>Secret\uff1a\u7528\u4e8e\u5b58\u50a8\u654f\u611f\u6570\u636e\u3002</li> <li>EmptyDir\uff1a\u7528\u4e8e\u4e00\u4e2aPod\u5185\u591a\u4e2a\u5bb9\u5668\u7684\u6570\u636e\u5171\u4eab\u3002</li> <li>PersistentVolumeClaim\uff1a\u5bf9PersistentVolume\u7684\u7533\u8bf7\u3002</li> </ul> <p>\u4ee5\u4e0a\u5217\u4e3e\u7684\u662f\u4e00\u4e9b\u6bd4\u8f83\u5e38\u7528\u7684\u7c7b\u578b\uff0c\u5176\u4ed6\u652f\u6301\u7684\u7c7b\u578b\u53ef\u4ee5\u67e5\u770bVolume\u7684\u5b98\u65b9\u6587\u6863\uff1a</p> <p>https://kubernetes.io/docs/concepts/storage/volumes/</p> <p>\u63a5\u4e0b\u6765\u901a\u8fc7\u51e0\u4e2a\u6bd4\u8f83\u5e38\u7528\u7684\u7c7b\u578b\u7684Volume\u914d\u7f6e\u6f14\u793a\u4e00\u4e0bVolume\u7684\u4f7f\u7528\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#3-\u793a\u4f8b1-\u901a\u8fc7emptydir\u5171\u4eab\u6570\u636e","title":"3. \u793a\u4f8b1: \u901a\u8fc7emptyDir\u5171\u4eab\u6570\u636e","text":"<p>EmptyDir\u662f\u4e00\u4e2a\u7279\u6b8a\u7684Volume\u7c7b\u578b\uff0c\u4e0e\u4e0a\u8ff0Volume\u4e0d\u540c\u7684\u662f\uff0c \u5982\u679c\u5220\u9664Pod\uff0cemptyDir\u5377\u4e2d\u7684\u6570\u636e\u4e5f\u5c06\u88ab\u5220\u9664\uff0c\u6240\u4ee5\u4e00\u822cemptyDir\u7528\u4e8ePod\u4e2d\u7684\u4e0d\u540cContainer\u5171\u4eab\u6570\u636e\uff0c</p> <p>\u6bd4\u5982\u4e00\u4e2aPod\u5b58\u5728\u4e24\u4e2a\u5bb9\u5668A\u548cB\uff0c\u5bb9\u5668A\u9700\u8981\u4f7f\u7528\u5bb9\u5668B\u4ea7\u751f\u7684\u6570\u636e\uff0c\u6b64\u65f6\u53ef\u4ee5\u91c7\u7528emptyDir\u5171\u4eab\u6570\u636e\uff0c\u7c7b\u4f3c\u7684\u4f7f\u7528\u5982Filebeat\u6536\u96c6\u5bb9\u5668\u5185\u7a0b\u5e8f\u4ea7\u751f\u7684\u65e5\u5fd7\u3002</p> <p>\u4f7f\u7528emptyDir\u5377\u7684\u793a\u4f8b\u5982\u4e0b\uff0c\u76f4\u63a5\u6307\u5b9aemptyDir\u4e3a{}\u5373\u53ef\uff1a</p> <p>nginx-empty.yaml</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nlabels:\napp: nginx\nname: nginx\nnamespace: default\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: nginx\ntemplate:\nmetadata:\nlabels:\napp: nginx\nspec:\ncontainers:\n- image: nginx:1.15.2\nimagePullPolicy: IfNotPresent\nname: nginx\nvolumeMounts:\n- mountPath: /opt\nname: share-volume\n- image: nginx:1.15.2\nimagePullPolicy: IfNotPresent\nname: nginx2\ncommand:\n- sh\n- -c\n- sleep 3600\nvolumeMounts:\n- mountPath: /mnt\nname: share-volume\nvolumes:\n- name: share-volume\nemptyDir: {}\n#medium: Memory\n</code></pre> <p>\u6b64\u90e8\u7f72\u6587\u4ef6\u521b\u5efa\u4e00\u4e2aDeployment\uff0c\u91c7\u7528spec.volumes\u5b57\u6bb5\u914d\u7f6e\u4e86\u4e00\u4e2a\u540d\u5b57\u4e3ashare-volume\u3001\u7c7b\u578b\u4e3aemptyDir\u7684Volume\uff0c\u540c\u65f6\u91cc\u9762\u5305\u542b\u4e24\u4e2a\u5bb9\u5668nginx\u548cnginx2\uff0c \u5e76\u5c06\u8be5Volume\u6302\u8f7d\u5230\u4e86/opt\u548c/mnt\u76ee\u5f55\u4e0b\uff0c\u6b64\u65f6/opt\u548c/mnt\u76ee\u5f55\u7684\u6570\u636e\u5c31\u5b9e\u73b0\u4e86\u5171\u4eab\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cemptyDir\u652f\u6301\u8282\u70b9\u4e0a\u7684\u4efb\u4f55\u4ecb\u8d28\uff0c\u53ef\u80fd\u662fSSD\u3001\u78c1\u76d8\u6216\u7f51\u7edc\u5b58\u50a8\uff0c\u5177\u4f53\u53d6\u51b3\u4e8e\u81ea\u8eab\u7684\u73af\u5883\u3002</p> <p>\u53ef\u4ee5\u5c06emptyDir.medium\u5b57\u6bb5\u8bbe\u7f6e\u4e3aMemory\uff0c\u8ba9Kubernetes\u4f7f\u7528tmpfs\uff08\u5185\u5b58\u652f\u6301\u7684\u6587\u4ef6\u7cfb\u7edf\uff09\uff0c \u867d\u7136tmpfs\u975e\u5e38\u5feb\uff0c\u4f46\u662ftmpfs\u5728\u8282\u70b9\u91cd\u542f\u65f6\uff0c\u6570\u636e\u540c\u6837\u4f1a\u88ab\u6e05\u9664\uff0c\u5e76\u4e14\u8bbe\u7f6e\u7684\u5927\u5c0f\u4f1a\u88ab\u8ba1\u5165Container\u7684\u5185\u5b58\u9650\u5236\u4e2d\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#4-\u793a\u4f8b2-\u4f7f\u7528hostpath\u6302\u8f7d\u5bbf\u4e3b\u673a\u6587\u4ef6","title":"4. \u793a\u4f8b2: \u4f7f\u7528HostPath\u6302\u8f7d\u5bbf\u4e3b\u673a\u6587\u4ef6","text":"<p>HostPath\u5377\u53ef\u5c06\u8282\u70b9\u4e0a\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u6302\u8f7d\u5230Pod\u4e0a\uff0c\u7528\u4e8e\u5b9e\u73b0Pod\u548c\u5bbf\u4e3b\u673a\u4e4b\u95f4\u7684\u6570\u636e\u5171\u4eab\uff0c</p> <p>\u5e38\u7528\u7684\u793a\u4f8b\u6709\u6302\u8f7d\u5bbf\u4e3b\u673a\u7684\u65f6\u533a\u81f3Pod\uff0c\u6216\u8005\u5c06Pod\u7684\u65e5\u5fd7\u6587\u4ef6\u6302\u8f7d\u5230\u5bbf\u4e3b\u673a\u7b49\u3002</p> <p>\u4ee5\u4e0b\u4e3a\u4f7f\u7528hostPath\u5377\u7684\u793a\u4f8b\uff0c\u5b9e\u73b0\u5c06\u4e3b\u673a\u7684/etc/timezone\u6587\u4ef6\u6302\u8f7d\u5230Pod\u7684/etc/timezone\uff08\u6302\u8f7d\u8def\u5f84\u53ef\u4ee5\u4e0d\u4e00\u81f4\uff09\uff1a</p> <p>nginx-hostPath.yaml</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nlabels:\napp: nginx\nname: nginx\nnamespace: default\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: nginx\ntemplate:\nmetadata:\nlabels:\napp: nginx\nspec:\ncontainers:\n- image: nginx:1.15.2\nimagePullPolicy: IfNotPresent\nname: nginx\nvolumeMounts:\n- mountPath: /opt\nname: share-volume\n- mountPath: /etc/timezone\nname: timezone\n- image: nginx:1.15.2\nimagePullPolicy: IfNotPresent\nname: nginx2\ncommand:\n- sh\n- -c\n- sleep 3600\nvolumeMounts:\n- mountPath: /mnt\nname: share-volume\nvolumes:\n- name: share-volume\nemptyDir: {}\n#medium: Memory\n- name: timezone\nhostPath:\npath: /etc/timezone\ntype: File\n</code></pre> <p>\u5728\u914d\u7f6eHostPath\u65f6\uff0c\u6709\u4e00\u4e2atype\u7684\u53c2\u6570\uff0c\u7528\u4e8e\u8868\u8fbe\u4e0d\u540c\u7684\u6302\u8f7d\u7c7b\u578b\uff0cHostPath\u5377\u5e38\u7528\u7684type\uff08\u7c7b\u578b\uff09\u5982\u4e0b\uff1a</p> <ul> <li> <p>type\u4e3a\u7a7a\u5b57\u7b26\u4e32\uff1a\u9ed8\u8ba4\u9009\u9879\uff0c\u610f\u5473\u7740\u6302\u8f7dhostPath\u5377\u4e4b\u524d\u4e0d\u4f1a\u6267\u884c\u4efb\u4f55\u68c0\u67e5\u3002</p> </li> <li> <p>DirectoryOrCreate\uff1a\u5982\u679c\u7ed9\u5b9a\u7684path\u4e0d\u5b58\u5728\u4efb\u4f55\u4e1c\u897f\uff0c\u90a3\u4e48\u5c06\u6839\u636e\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u6743\u9650\u4e3a0755\u7684\u7a7a\u76ee\u5f55\uff0c\u548cKubelet\u5177\u6709\u76f8\u540c\u7684\u7ec4\u548c\u6743\u9650</p> </li> <li>Directory\uff1a\u76ee\u5f55\u5fc5\u987b\u5b58\u5728\u4e8e\u7ed9\u5b9a\u7684\u8def\u5f84\u4e0b\u3002</li> <li>FileOrCreate\uff1a\u5982\u679c\u7ed9\u5b9a\u7684\u8def\u5f84\u4e0d\u5b58\u50a8\u4efb\u4f55\u5185\u5bb9\uff0c\u5219\u4f1a\u6839\u636e\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u7a7a\u6587\u4ef6\uff0c\u6743\u9650\u8bbe\u7f6e\u4e3a0644\uff0c\u548cKubelet\u5177\u6709\u76f8\u540c\u7684\u7ec4\u548c\u6240\u6709\u6743\u3002</li> <li>File\uff1a\u6587\u4ef6\uff0c\u5fc5\u987b\u5b58\u5728\u4e8e\u7ed9\u5b9a\u8def\u5f84\u4e2d\u3002</li> <li>Socket\uff1aUNIX\u5957\u63a5\u5b57\uff0c\u5fc5\u987b\u5b58\u5728\u4e8e\u7ed9\u5b9a\u8def\u5f84\u4e2d\u3002</li> <li>CharDevice\uff1a\u5b57\u7b26\u8bbe\u5907\uff0c\u5fc5\u987b\u5b58\u5728\u4e8e\u7ed9\u5b9a\u8def\u5f84\u4e2d\u3002</li> <li>BlockDevice\uff1a\u5757\u8bbe\u5907\uff0c\u5fc5\u987b\u5b58\u5728\u4e8e\u7ed9\u5b9a\u8def\u5f84\u4e2d\u3002</li> </ul>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#5-\u793a\u4f8b3-\u6302\u8f7dnfs\u81f3\u5bb9\u5668","title":"5. \u793a\u4f8b3: \u6302\u8f7dNFS\u81f3\u5bb9\u5668","text":"<p>\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u8003\u8651\u5230\u6570\u636e\u7684\u9ad8\u53ef\u7528\u6027\uff0c\u4ecd\u7136\u4e0d\u5efa\u8bae\u4f7f\u7528NFS\u4f5c\u4e3a\u540e\u7aef\u5b58\u50a8\u3002</p> <p>\u56e0\u4e3aNFS\u5b58\u5728\u5355\u70b9\u6545\u969c\uff0c\u5f88\u591a\u4f01\u4e1a\u5e76\u975e\u5bf9\u5176\u5b9e\u73b0\u9ad8\u53ef\u7528\uff0c\u5e76\u4e14NFS\u7684\u6027\u80fd\u5b58\u5728\u5f88\u5927\u7684\u74f6\u9888\u3002</p> <p>\u6240\u4ee5\u751f\u4ea7\u4e2d\uff0c\u5efa\u8bae\u4f7f\u7528\u5206\u5e03\u5f0f\u5b58\u50a8\uff0c\u5728\u516c\u6709\u4e91\u4e2d\u5efa\u8bae\u4f7f\u7528\u516c\u6709\u4e91\u63d0\u4f9b\u7684NAS\u5b58\u50a8\u6765\u66ff\u4ee3NFS\uff0c\u5e76\u4e14NAS\u6027\u80fd\u66f4\u597d\uff0c\u53ef\u7528\u6027\u66f4\u9ad8\u3002</p> <p>NFS\u4f5c\u4e3a\u4e00\u4e2a\u6bd4\u8f83\u6d41\u884c\u7684\u8fdc\u7aef\u5b58\u50a8\u5de5\u5177\uff0c\u5728\u975e\u751f\u4ea7\u73af\u5883\u4e2d\u662f\u4e00\u4e2a\u6bd4\u8f83\u597d\u7528\u7684\u9009\u62e9\uff0c\u53ef\u4ee5\u5feb\u901f\u5730\u642d\u5efa\u4f7f\u7528\u3002\u63a5\u4e0b\u6765\u6f14\u793a\u5982\u4f55\u4f7f\u7528Volume\u6302\u8f7dNFS\u4e3a\u5bb9\u5668\u63d0\u4f9b\u6301\u4e45\u5316\u5b58\u50a8\u3002</p> <p>\u5728\u5f00\u59cb\u4e4b\u524d\uff0c\u9700\u8981\u63d0\u524d\u914d\u7f6eNFS\u7684\u6743\u9650\u548c\u6570\u636e\u76ee\u5f55\uff0c\u5177\u4f53\u53ef\u4ee5\u53c2\u8003NFS\u7684\u6587\u6863\uff0c\u6b64\u5904\u53ea\u63d0\u4f9bNFS\u7684exporter\u914d\u7f6e\uff0c</p> <p>\u5047\u8bbeNFS\u63d0\u4f9b\u7684\u6570\u636e\u76ee\u5f55\u4e3a/data/nfs\uff0c\u6388\u6743\u53ef\u6302\u8f7d\u8be5\u76ee\u5f55\u7684IP\u6bb5\u4e3a192.168.0.0/24\uff1a</p> <pre><code>/data/nfs/ 192.168.0.0/24(rw,sync,no_subtree_check,no_root_squash)\n</code></pre> <p>\u548cemptyDir\u3001HostPath\u7684\u914d\u7f6e\u65b9\u6cd5\u7c7b\u4f3c\uff0cNFS\u7684Volume\u914d\u7f6e\u4e5f\u662f\u5728Volumes\u5b57\u6bb5\u4e2d\u914d\u7f6e\u7684\uff0c\u548cemptyDir\u4e0d\u540c\u7684\u662f\uff0cNFS\u5c5e\u4e8e\u6301\u4e45\u5316\u5b58\u50a8\u7684\u4e00\u79cd\uff0c\u5728Pod\u5220\u9664\u6216\u8005\u91cd\u542f\u540e\uff0c\u6570\u636e\u4f9d\u65e7\u4f1a\u5b58\u50a8\u5728NFS\u8282\u70b9\u4e0a\u3002</p> <p>NFS \u662f Network File System \u7684\u7f29\u5199\uff0c\u5373\u7f51\u7edc\u6587\u4ef6\u7cfb\u7edf\u3002Kubernetes \u4e2d\u901a\u8fc7\u7b80\u5355\u5730\u914d\u7f6e\u5c31\u53ef\u4ee5\u6302\u8f7d NFS \u5230 Pod \u4e2d\uff0c\u800c NFS \u4e2d\u7684\u6570\u636e\u662f\u53ef\u4ee5\u6c38\u4e45\u4fdd\u5b58\u7684\uff0c\u540c\u65f6 NFS \u652f\u6301\u540c\u65f6\u5199\u64cd\u4f5c\u3002</p> <p>\u914d\u7f6eNFS\u4e5f\u76f8\u5bf9\u7b80\u5355\uff0c\u4ee3\u7801\u5982\u4e0b\uff08\u6302\u8f7d\u65b9\u5f0f\u548chostPath\u3001emptyDir\u7c7b\u4f3c\uff0c\u5728\u6b64\u4e0d\u518d\u6f14\u793a\uff09\uff1a</p> <pre><code>volumes:\n- name: nfs\nnfs:\n# FIXME: use the right hostname\nserver: 10.254.234.223\npath: \"/\"\n</code></pre> <ul> <li>Server\uff1aNFS\u670d\u52a1\u5668\u7684IP\u3002</li> <li>Path\uff1aNFS\u670d\u52a1\u5668\u7684\u5171\u4eab\u76ee\u5f55\u3002</li> </ul> <p>\u6ce8\u610f</p> <p>Kubernetes\u6240\u6709\u7684\u8282\u70b9\u90fd\u9700\u8981\u5b89\u88c5\u4e0anfs-utils\u624d\u53ef\u4ee5\u6b63\u5e38\u6302\u8f7dNFS\u3002</p> <p>\u672c\u8282\u6f14\u793a\u4e86\u7c7b\u578b\u4e3aemptyDir\u3001hostPath\u3001NFS\u7684Volume\u7684\u4f7f\u7528\uff0c\u5728\u914d\u7f6e\u7ba1\u7406ConfigMap\u3001Secret\u65f6\u4e5f\u8bb2\u89e3\u4e86\u7c7b\u578b\u4e3aSecret\u548cConfigMap\u7684\u4f7f\u7528\uff0c\u540e\u9762\u7684\u7ae0\u8282\u5c06\u4e3a\u8bfb\u8005\u8bb2\u89e3persistentVolumeClaim\u4ee5\u53ca\u66f4\u9ad8\u7ea7\u7684\u5b58\u50a8\u914d\u7f6e\u7684\u4f7f\u7528\u3002</p> <p>\u5bf9\u4e8e\u5176\u4ed6\u7c7b\u578b\u7684Volume\u914d\u7f6e\uff0c\u539f\u7406\u548c\u914d\u7f6e\u65b9\u6cd5\u7c7b\u4f3c\uff0c</p> <p>\u5177\u4f53\u53ef\u4ee5\u53c2\u8003\uff1a</p> <p>https://kubernetes.io/docs/concepts/storage/volumes/\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#6-persistentvolume","title":"6. PersistentVolume","text":"<p>\u4e0a\u4e00\u8282\u8bb2\u89e3\u4e86Volume\u7684\u6982\u5ff5\u548c\u4f7f\u7528\uff0c\u867d\u7136Volume\u5df2\u7ecf\u53ef\u4ee5\u63a5\u5165\u5927\u90e8\u5206\u5b58\u50a8\u540e\u7aef\uff0c\u4f46\u662f\u5b9e\u9645\u4f7f\u7528\u65f6\u8fd8\u6709\u8bf8\u591a\u95ee\u9898\uff0c\u6bd4\u5982\uff1a</p> <ul> <li>\u5f53\u67d0\u4e2a\u6570\u636e\u5377\u4e0d\u518d\u88ab\u6302\u8f7d\u4f7f\u7528\u65f6\uff0c\u91cc\u9762\u7684\u6570\u636e\u5982\u4f55\u5904\u7406\uff1f</li> <li>\u5982\u679c\u60f3\u8981\u5b9e\u73b0\u53ea\u8bfb\u6302\u8f7d\u5982\u4f55\u5904\u7406\uff1f</li> <li>\u5982\u679c\u60f3\u8981\u53ea\u80fd\u6709\u4e00\u4e2aPod\u6302\u8f7d\u5982\u4f55\u5904\u7406\uff1f</li> </ul> <p>\u5982\u4e0a\u6240\u8ff0\uff0c\u5bf9\u4e8e\u5f88\u591a\u590d\u6742\u7684\u9700\u6c42Volume\u53ef\u80fd\u96be\u4ee5\u5b9e\u73b0\uff0c\u5e76\u4e14\u65e0\u6cd5\u5bf9\u5b58\u50a8\u5377\u7684\u751f\u547d\u5468\u671f\u8fdb\u884c\u7ba1\u7406\u3002\u53e6\u4e00\u4e2a\u5f88\u5927\u7684\u95ee\u9898\u662f\uff0c\u5728\u4f01\u4e1a\u5185\u4f7f\u7528Kubernetes\u7684\u4e0d\u4ec5\u4ec5\u662fKubernetes\u7ba1\u7406\u5458\uff0c\u53ef\u80fd\u8fd8\u6709\u5f00\u53d1\u4eba\u5458\u3001\u6d4b\u8bd5\u4eba\u5458\u4ee5\u53ca\u521d\u5b66Kubernetes\u7684\u6280\u672f\u4eba\u5458\uff0c\u5bf9\u4e8eKubernetes\u7684Volume\u6216\u8005\u76f8\u5173\u5b58\u50a8\u5e73\u53f0\u7684\u914d\u7f6e\u53c2\u6570\u5e76\u4e0d\u4e86\u89e3\uff0c\u6240\u4ee5\u65e0\u6cd5\u81ea\u884c\u5b8c\u6210\u5b58\u50a8\u7684\u914d\u7f6e\u3002</p> <p>\u4e3a\u6b64\uff0cKubernetes\u5f15\u5165\u4e86\u4e24\u4e2a\u65b0\u7684API\u8d44\u6e90\uff1aPersistentVolume\u548cPersistentVolumeClaim\u3002PersistentVolume\uff08\u7b80\u79f0PV\uff09\u662f\u7531Kubernetes\u7ba1\u7406\u5458\u8bbe\u7f6e\u7684\u5b58\u50a8\uff0cPersistentVolumeClaim\uff08\u7b80\u79f0PVC\uff09\u662f\u5bf9PV\u7684\u8bf7\u6c42\uff0c\u8868\u793a\u9700\u8981\u4ec0\u4e48\u7c7b\u578b\u7684PV\u3002\u5b83\u4eec\u540c\u6837\u662f\u96c6\u7fa4\u4e2d\u7684\u4e00\u7c7b\u8d44\u6e90\uff0c\u4f46\u5176\u751f\u547d\u5468\u671f\u6bd4\u8f83\u72ec\u7acb\uff0c\u7ba1\u7406\u5458\u53ef\u4ee5\u5355\u72ec\u5bf9PV\u8fdb\u884c\u589e\u5220\u6539\u67e5\uff0c\u4e0d\u53d7Pod\u7684\u5f71\u54cd\uff0c\u751f\u547d\u5468\u671f\u53ef\u80fd\u6bd4\u6302\u8f7d\u5b83\u7684\u5176\u4ed6\u8d44\u6e90\u8fd8\u8981\u957f\u3002</p> <p>\u5982\u679c\u4e00\u4e2aKubernetes\u96c6\u7fa4\u7684\u4f7f\u7528\u8005\u5e76\u975e\u53ea\u6709Kubernetes\u7ba1\u7406\u5458\uff0c\u90a3\u4e48\u53ef\u4ee5\u901a\u8fc7\u63d0\u524d\u521b\u5efaPV\uff0c\u7528\u4ee5\u89e3\u51b3\u5bf9\u5b58\u50a8\u6982\u5ff5\u4e0d\u662f\u5f88\u4e86\u89e3\u7684\u6280\u672f\u4eba\u5458\u5bf9\u5b58\u50a8\u7684\u9700\u6c42\u3002\u548c\u5355\u72ec\u914d\u7f6eVolume\u7c7b\u4f3c\uff0cPV\u4e5f\u53ef\u4ee5\u4f7f\u7528NFS\u3001GFS\u3001CEPH\u7b49\u5e38\u7528\u7684\u5b58\u50a8\u540e\u7aef\uff0c\u5e76\u4e14\u53ef\u4ee5\u63d0\u4f9b\u66f4\u52a0\u9ad8\u7ea7\u7684\u914d\u7f6e\uff0c\u6bd4\u5982\u8bbf\u95ee\u6a21\u5f0f\u3001\u7a7a\u95f4\u5927\u5c0f\u4ee5\u53ca\u56de\u6536\u7b56\u7565\u7b49\u3002</p> <p>\u76ee\u524dPV\u7684\u63d0\u4f9b\u65b9\u5f0f\u6709\u4e24\u79cd\uff1a\u9759\u6001\u6216\u52a8\u6001\u3002\u9759\u6001PV\u7531\u7ba1\u7406\u5458\u63d0\u524d\u521b\u5efa\uff0c\u52a8\u6001PV\u65e0\u987b\u63d0\u524d\u521b\u5efa\uff08\u52a8\u6001PV\u57288.8\u8282\u8fdb\u884c\u8bb2\u89e3\uff09\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#61-pv\u56de\u6536\u7b56\u7565","title":"6.1 PV\u56de\u6536\u7b56\u7565","text":"<p>\u5f53\u7528\u6237\u4f7f\u7528\u5b8c\u5377\u65f6\uff0c\u53ef\u4ee5\u4eceAPI\u4e2d\u5220\u9664PVC\u5bf9\u8c61\uff0c\u4ece\u800c\u5141\u8bb8\u56de\u6536\u8d44\u6e90\u3002\u56de\u6536\u7b56\u7565\u4f1a\u544a\u8bc9PV\u5982\u4f55\u5904\u7406\u8be5\u5377\u3002</p> <p>\u76ee\u524d\u56de\u6536\u7b56\u7565\u53ef\u4ee5\u8bbe\u7f6e\u4e3aRetain\u3001Recycle\u548cDelete\uff1a</p> <ul> <li>Retain\uff1a\u4fdd\u7559\uff0c\u8be5\u7b56\u7565\u5141\u8bb8\u624b\u52a8\u56de\u6536\u8d44\u6e90\uff0c\u5f53\u5220\u9664PVC\u65f6\uff0cPV\u4ecd\u7136\u5b58\u5728\uff0cVolume\u88ab\u89c6\u4e3a\u5df2\u91ca\u653e\uff0c\u7ba1\u7406\u5458\u53ef\u4ee5\u624b\u52a8\u56de\u6536\u5377\u3002</li> <li>Recycle\uff1a\u56de\u6536\uff0c\u5982\u679cVolume\u63d2\u4ef6\u652f\u6301\uff0cRecycle\u7b56\u7565\u4f1a\u5bf9\u5377\u6267\u884crm -rf\u6e05\u7406\u8be5PV\uff0c\u5e76\u4f7f\u5176\u53ef\u7528\u4e8e\u4e0b\u4e00\u4e2a\u65b0\u7684PVC\uff0c\u4f46\u662f\u672c\u7b56\u7565\u5c06\u6765\u4f1a\u88ab\u5f03\u7528\uff0c\u76ee\u524d\u53ea\u6709NFS\u548cHostPath\u652f\u6301\u8be5\u7b56\u7565\u3002</li> <li>Delete\uff1a\u5220\u9664\uff0c\u5982\u679cVolume\u63d2\u4ef6\u652f\u6301\uff0c\u5220\u9664PVC\u65f6\u4f1a\u540c\u65f6\u5220\u9664PV\uff0c\u52a8\u6001\u5377\u9ed8\u8ba4\u4e3aDelete\uff0c\u76ee\u524d\u652f\u6301Delete\u7684\u5b58\u50a8\u540e\u7aef\u5305\u62ecAWS EBS\u3001GCE PD\u3001Azure Disk\u3001OpenStack Cinder\u7b49\u3002</li> </ul>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#62-pv\u8bbf\u95ee\u7b56\u7565","title":"6.2 PV\u8bbf\u95ee\u7b56\u7565","text":"<p>\u5728\u5b9e\u9645\u4f7f\u7528PV\u65f6\uff0c\u53ef\u80fd\u9488\u5bf9\u4e0d\u540c\u7684\u5e94\u7528\u4f1a\u6709\u4e0d\u540c\u7684\u8bbf\u95ee\u7b56\u7565\uff0c\u6bd4\u5982\u67d0\u7c7bPod\u53ef\u4ee5\u8bfb\u5199\uff0c\u67d0\u7c7bPod\u53ea\u80fd\u8bfb\uff0c\u6216\u8005\u9700\u8981\u914d\u7f6e\u662f\u5426\u53ef\u4ee5\u88ab\u591a\u4e2a\u4e0d\u540c\u7684Pod\u540c\u65f6\u8bfb\u5199\u7b49\uff0c\u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528PV\u7684\u8bbf\u95ee\u7b56\u7565\u8fdb\u884c\u7b80\u5355\u63a7\u5236\uff0c\u76ee\u524d\u652f\u6301\u7684\u8bbf\u95ee\u7b56\u7565\u5982\u4e0b\uff1a</p> <ul> <li>ReadWriteOnce\uff1a\u53ef\u4ee5\u88ab\u5355\u8282\u70b9\u4ee5\u8bfb\u5199\u6a21\u5f0f\u6302\u8f7d\uff0c\u547d\u4ee4\u884c\u4e2d\u53ef\u4ee5\u88ab\u7f29\u5199\u4e3aRWO\u3002</li> <li>ReadOnlyMany\uff1a\u53ef\u4ee5\u88ab\u591a\u4e2a\u8282\u70b9\u4ee5\u53ea\u8bfb\u6a21\u5f0f\u6302\u8f7d\uff0c\u547d\u4ee4\u884c\u4e2d\u53ef\u4ee5\u88ab\u7f29\u5199\u4e3aROX\u3002</li> <li>ReadWriteMany\uff1a\u53ef\u4ee5\u88ab\u591a\u4e2a\u8282\u70b9\u4ee5\u8bfb\u5199\u6a21\u5f0f\u6302\u8f7d\uff0c\u547d\u4ee4\u884c\u4e2d\u53ef\u4ee5\u88ab\u7f29\u5199\u4e3aRWX\u3002</li> <li>ReadWriteOncePod\uff1a\u53ea\u80fd\u88ab\u4e00\u4e2aPod\u4ee5\u8bfb\u5199\u7684\u6a21\u5f0f\u6302\u8f7d\uff0c\u547d\u4ee4\u4e2d\u53ef\u4ee5\u88ab\u7f29\u5199\u4e3aRWOP\uff081.22\u4ee5\u4e0a\u7248\u672c\uff09\u3002</li> </ul> <p>\u867d\u7136PV\u5728\u521b\u5efa\u65f6\u53ef\u4ee5\u6307\u5b9a\u4e0d\u540c\u7684\u8bbf\u95ee\u7b56\u7565\uff0c\u4f46\u662f\u4e5f\u8981\u540e\u7aef\u7684\u5b58\u50a8\u652f\u6301\u624d\u884c\u3002</p> <p>\u6bd4\u5982\u4e00\u822c\u60c5\u51b5\u4e0b\u5927\u90e8\u5206\u5757\u5b58\u50a8\u662f\u4e0d\u652f\u6301ReadWriteMany\u7684\uff0c</p> <p>\u5177\u4f53\u540e\u7aef\u5b58\u50a8\u652f\u6301\u7684\u8bbf\u95ee\u6a21\u5f0f\u53ef\u4ee5\u53c2\u8003\uff1ahttps://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes\u3002</p> <p>\u5728\u4f01\u4e1a\u5185\uff0c\u53ef\u80fd\u5b58\u50a8\u5f88\u591a\u4e0d\u540c\u7c7b\u578b\u7684\u5b58\u50a8\uff0c\u6bd4\u5982NFS\u3001Ceph\u3001GlusterFS\u7b49\uff0c\u9488\u5bf9\u4e0d\u540c\u7c7b\u578b\u7684\u540e\u7aef\u5b58\u50a8\u5177\u6709\u4e0d\u540c\u7684\u914d\u7f6e\u65b9\u5f0f\uff0c\u8fd9\u4e5f\u662f\u5bf9\u96c6\u7fa4\u7ba1\u7406\u5458\u7684\u4e00\u79cd\u6311\u6218\uff0c\u56e0\u4e3a\u96c6\u7fa4\u7ba1\u7406\u5458\u9700\u8981\u5bf9\u6bcf\u79cd\u5b58\u50a8\u90fd\u6709\u6240\u4e86\u89e3\u3002\u63a5\u4e0b\u6765\u770b\u4e00\u4e0b\u51e0\u4e2a\u5e38\u7528\u7684PV\u914d\u7f6e\u793a\u4f8b\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#63-\u57fa\u4e8enfs\u7684pv","title":"6.3 \u57fa\u4e8eNFS\u7684PV","text":"<p>\u521b\u5efa\u4e00\u4e2a\u57fa\u4e8eNFS\u7684PV\uff08PV\u76ee\u524d\u6ca1\u6709Namespace\u9694\u79bb\uff0c\u4e0d\u9700\u8981\u6307\u5b9a\u547d\u540d\u7a7a\u95f4\uff0c\u5728\u4efb\u610f\u547d\u540d\u7a7a\u95f4\u4e0b\u521b\u5efa\u7684PV\u5747\u53ef\u4ee5\u5728\u5176\u4ed6Namespace\u4f7f\u7528\uff09\uff1a</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\nname: pv0003\nspec:\ncapacity:\nstorage: 5Gi\nvolumeMode: Filesystem\naccessModes:\n- ReadWriteOnce\npersistentVolumeReclaimPolicy: Recycle\nstorageClassName: nfs-slow\nmountOptions:\n- hard\n- nfsvers=4.1\nnfs:\npath: /tmp\nserver: 172.17.0.2\n</code></pre> <ul> <li>capacity\uff1a\u5bb9\u91cf\u914d\u7f6e\u3002</li> <li>volumeMode\uff1a\u5377\u7684\u6a21\u5f0f\uff0c\u76ee\u524d\u652f\u6301Filesystem\uff08\u6587\u4ef6\u7cfb\u7edf\uff09\u548cBlock\uff08\u5757\uff09\uff0c\u5176\u4e2dBlock\u7c7b\u578b\u9700\u8981\u540e\u7aef\u5b58\u50a8\u652f\u6301\uff0c\u9ed8\u8ba4\u4e3a\u6587\u4ef6\u7cfb\u7edf\u3002l accessModes\uff1a\u8be5PV\u7684\u8bbf\u95ee\u6a21\u5f0f\u3002</li> <li>storageClassName\uff1aPV\u7684\u7c7b\uff0c\u4e00\u4e2a\u7279\u5b9a\u7c7b\u578b\u7684PV\u53ea\u80fd\u7ed1\u5b9a\u5230\u7279\u5b9a\u7c7b\u522b\u7684PVC\u3002</li> <li>persistentVolumeReclaimPolicy\uff1a\u56de\u6536\u7b56\u7565\u3002</li> <li>mountOptions\uff1a\u975e\u5fc5\u9700\uff0c\u65b0\u7248\u672c\u4e2d\u5df2\u5f03\u7528\u3002</li> <li>nfs\uff1aNFS\u670d\u52a1\u914d\u7f6e\uff0c\u5305\u62ec\u4ee5\u4e0b\u4e24\u4e2a\u9009\u9879\u3002</li> <li>path\uff1aNFS\u4e0a\u7684\u5171\u4eab\u76ee\u5f55\u3002</li> <li>server\uff1aNFS\u7684IP\u5730\u5740\u3002</li> </ul> <p>\u6ce8\u610f</p> <p>\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u4f01\u4e1a\u5185\u7684NFS\u5f88\u6709\u53ef\u80fd\u662f\u6ca1\u6709\u9ad8\u53ef\u7528\u6027\u7684\uff0c\u6240\u4ee5\u5728\u4f01\u4e1a\u5185\u90e8\u8981\u8c28\u614e\u4f7f\u7528NFS\u4f5c\u4e3a\u540e\u53f0\u5b58\u50a8\uff0c\u53ef\u4ee5\u4f7f\u7528\u516c\u6709\u4e91\u7684NAS\u670d\u52a1\uff0c\u548cNFS\u7684\u534f\u8bae\u4e00\u81f4\uff0c\u6216\u8005\u4f7f\u7528\u652f\u6301\u6587\u4ef6\u7cfb\u7edf\u7c7b\u578b\u7684\u5206\u5e03\u5f0f\u5b58\u50a8\uff0c\u6bd4\u5982Ceph\u7b49\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#64-\u57fa\u4e8ehostpath\u7684pv","title":"6.4 \u57fa\u4e8eHostPath\u7684PV","text":"<p>\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u57fa\u4e8ehostPath\u7684PV\uff0c\u548c\u914d\u7f6eNFS\u7684PV\u7c7b\u4f3c\uff0c\u53ea\u9700\u8981\u914d\u7f6ehostPath\u5b57\u6bb5\u5373\u53ef\uff0c\u5176\u4ed6\u914d\u7f6e\u57fa\u672c\u4e00\u81f4\uff1a</p> <pre><code>kind: PersistentVolume\napiVersion: v1\nmetadata:\nname: task-pv-volume\nlabels:\ntype: local\nspec:\nstorageClassName: manual\ncapacity:\nstorage: 10Gi\naccessModes:\n- ReadWriteOnce\nhostPath:\npath: \"/mnt/data\"\n</code></pre> <p>\u914d\u7f6e\u53c2\u6570\u8bf4\u660e\uff1a</p> <ul> <li>hostPath\uff1a\u5bbf\u4e3b\u673a\u8def\u5f84\u914d\u7f6e\u3002</li> </ul> <p>\u6ce8\u610f</p> <p>\u4f7f\u7528hostPath\u7c7b\u578b\u9700\u8981\u56fa\u5b9aPod\u6240\u5728\u7684\u8282\u70b9\uff0c\u9632\u6b62Pod\u6f02\u79fb\u9020\u6210\u6570\u636e\u4e22\u5931\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#65-\u57fa\u4e8eceph-rbd\u7684pv","title":"6.5 \u57fa\u4e8eCeph RBD\u7684PV","text":"<p>Ceph\u53ef\u80fd\u662f\u76ee\u524d\u4f01\u4e1a\u5185\u6700\u5e38\u7528\u7684\u4e00\u79cd\u5206\u5e03\u5f0f\u5b58\u50a8\u4e4b\u4e00\uff0c\u540c\u65f6\u652f\u6301\u6587\u4ef6\u7cfb\u7edf\u3001\u5757\u5b58\u50a8\u53ca\u5bf9\u8c61\u5b58\u50a8\uff0c\u548c\u4e0a\u8ff0NFS\u548cHostPath\u76f8\u6bd4\uff0c\u5177\u6709\u9ad8\u53ef\u7528\u6027\u548c\u8bfb\u5199\u9ad8\u6548\u6027\u3002 \u63a5\u4e0b\u6765\u770b\u4e00\u4e0bCeph RBD\u7c7b\u578b\u7684PV\u914d\u7f6e\uff1a</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\nname: ceph-rbd-pv\nspec:\ncapacity:\nstorage: 1Gi\naccessModes:\n- ReadWriteOnce\nrbd:\nmonitors:\n- 192.168.1.123:6789\n- 192.168.1.124:6789\n- 192.168.1.125:6789\npool: rbd\nimage: ceph-rbd-pv-test\nuser: admin\nsecretRef:\nname: ceph-secret\nfsType: ext4\nreadOnly: false\n</code></pre> <p>\u914d\u7f6e\u53c2\u6570\u8bf4\u660e\uff1a</p> <ul> <li>monitors\uff1aCeph\u7684monitor\u8282\u70b9\u7684IP\u3002</li> <li>pool\uff1a\u6240\u7528Ceph Pool\u7684\u540d\u79f0\uff0c\u53ef\u4ee5\u4f7f\u7528ceph osd pool ls\u67e5\u770b\u3002</li> <li>image\uff1aCeph\u5757\u8bbe\u5907\u4e2d\u7684\u78c1\u76d8\u6620\u50cf\u6587\u4ef6\uff0c\u53ef\u4ee5\u4f7f\u7528rbd create POOL_NAME/IMAGE_NAME--size 1024\u521b\u5efa\uff0c\u4f7f\u7528rbd list POOL_NAME\u67e5\u770b\u3002</li> <li>user\uff1aRados\u7684\u7528\u6237\u540d\uff0c\u9ed8\u8ba4\u662fadmin\u3002</li> <li>secretRef\uff1a\u7528\u4e8e\u9a8c\u8bc1Ceph\u8eab\u4efd\u7684\u5bc6\u94a5\u3002</li> <li>fsType\uff1a\u6587\u4ef6\u7c7b\u578b\uff0c\u53ef\u4ee5\u662fExt4\u3001XFS\u7b49\u3002</li> <li>readOnly\uff1a\u662f\u5426\u662f\u53ea\u8bfb\u6302\u8f7d\u3002</li> </ul> <p>\u6ce8\u610f</p> <p>Ceph\u7684Pool\u548cImage\u9700\u8981\u63d0\u524d\u521b\u5efa\u624d\u80fd\u4f7f\u7528\u3002</p> <p>\u867d\u7136\u524d\u9762\u8bb2\u8ff0\u4e86RBD\u7c7b\u578b\u7684PV\u914d\u7f6e\u793a\u4f8b\uff0c\u4f46\u662f\u5728\u5b9e\u9645\u4f7f\u7528\u65f6\uff0c\u5927\u591a\u6570Ceph\u5b58\u50a8\u7684\u4f7f\u7528\u90fd\u662f\u91c7\u7528\u52a8\u6001\u5b58\u50a8\u7684\u65b9\u5f0f\uff0c\u5f88\u5c11\u901a\u8fc7\u9759\u6001\u65b9\u5f0f\u53bb\u7ba1\u7406\u3002</p> <p>\u540c\u65f6\uff0cKubernetes\u6240\u6709\u7684\u8282\u70b9\u90fd\u9700\u8981\u5b89\u88c5ceph-common\u624d\u80fd\u6b63\u5e38\u6302\u8f7dCeph\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#66-pv\u7684\u72b6\u6001","title":"6.6 PV\u7684\u72b6\u6001","text":"<p>\u5728\u521b\u5efaPV\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7kubectl get pv\u67e5\u770b\u5df2\u7ecf\u521b\u5efa\u7684PV\u7684\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pv\nNAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                            STORAGECLASS                        REASON   AGE\ngitlab-postgresql-pv                       200Gi      RWO            Retain           Bound    kube-ops/gitlab-postgresql-pvc   managed-nfs-storage                          115d\ngitlab-pv                                  500Gi      RWO            Retain           Bound    kube-ops/gitlab-pvc              managed-nfs-storage  </code></pre> <p>\u5176\u4e2d\u6709\u4e00\u4e2a\u5b57\u6bb5STATUS\u8868\u793a\u5f53\u524dPV\u7684\u72b6\u6001\uff0c\u4f1a\u6709\u4ee5\u4e0b\u51e0\u79cd\u72b6\u6001\uff1a</p> <ul> <li>Available\uff1a\u53ef\u7528\uff0c\u6ca1\u6709\u88abPVC\u7ed1\u5b9a\u7684\u7a7a\u95f2\u8d44\u6e90\u3002</li> <li>Bound\uff1a\u5df2\u7ed1\u5b9a\uff0c\u5df2\u7ecf\u88abPVC\u7ed1\u5b9a\u3002</li> <li>Released\uff1a\u5df2\u91ca\u653e\uff0cPVC\u88ab\u5220\u9664\uff0c\u4f46\u662f\u8d44\u6e90\u8fd8\u672a\u88ab\u91cd\u65b0\u4f7f\u7528\u3002</li> <li>Failed\uff1a\u5931\u8d25\uff0c\u81ea\u52a8\u56de\u6536\u5931\u8d25\u3002</li> </ul>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#7-persistentvolumeclaim","title":"7. PersistentVolumeClaim","text":"<p>\u7531Kubernetes\u7ba1\u7406\u5458\u63d0\u524d\u521b\u5efa\u4e86PV\uff0c\u6211\u4eec\u5e94\u8be5\u600e\u6837\u4f7f\u7528\u5b83\u5462\uff1f</p> <p>\u8fd9\u91cc\u4ecb\u7ecdKubernetes\u7684\u53e6\u4e00\u4e2a\u6982\u5ff5PersistentVolumeClaim\uff08 \u7b80 \u79f0 PVC\uff09\u3002</p> <p>PVC\u662f\u5176\u4ed6\u6280\u672f\u4eba\u5458\u5728Kubernetes\u4e0a\u5bf9\u5b58\u50a8\u7684\u7533\u8bf7\uff0c\u5b83\u53ef\u4ee5\u6807\u660e\u4e00\u4e2a\u7a0b\u5e8f\u9700\u8981\u7528\u5230\u4ec0\u4e48\u6837\u7684\u540e\u7aef\u5b58\u50a8\u3001\u591a\u5927\u7684\u7a7a\u95f4\u4ee5\u53ca\u4ee5\u4ec0\u4e48\u8bbf\u95ee\u6a21\u5f0f\u8fdb\u884c\u6302\u8f7d\u3002 \u8fd9\u4e00\u70b9\u548cPod\u7684QoS\u914d\u7f6e\u7c7b\u4f3c\uff0cPod\u6d88\u8017\u8282\u70b9\u8d44\u6e90\uff0cPVC\u6d88\u8017PV\u8d44\u6e90\uff0cPod\u53ef\u4ee5\u8bf7\u6c42\u7279\u5b9a\u7ea7\u522b\u7684\u8d44\u6e90\uff08CPU\u548c\u5185\u5b58\uff09\uff0cPVC\u53ef\u4ee5\u8bf7\u6c42\u7279\u5b9a\u7684\u5927\u5c0f\u548c\u8bbf\u95ee\u6a21\u5f0f\u7684PV\u3002</p> <p>\u4f8b\u5982\u7533\u8bf7\u4e00\u4e2a\u5927\u5c0f\u4e3a5Gi\u4e14\u53ea\u80fd\u88ab\u4e00\u4e2aPod\u53ea\u8bfb\u8bbf\u95ee\u7684\u5b58\u50a8\u3002</p> <p>\u5728\u5b9e\u9645\u4f7f\u7528\u65f6\uff0c\u867d\u7136\u7528\u6237\u901a\u8fc7PVC\u83b7\u53d6\u5b58\u50a8\u652f\u6301\uff0c\u4f46\u662f\u7528\u6237\u53ef\u80fd\u9700\u8981\u5177\u6709\u4e0d\u540c\u6027\u8d28\u7684PV\u6765\u89e3\u51b3\u4e0d\u540c\u7684\u95ee\u9898\uff0c\u6bd4\u5982\u4f7f\u7528SSD\u786c\u76d8\u6765\u63d0\u9ad8\u6027\u80fd\u3002 \u6240\u4ee5\u96c6\u7fa4\u7ba1\u7406\u5458\u9700\u8981\u6839\u636e\u4e0d\u540c\u7684\u5b58\u50a8\u540e\u7aef\u6765\u63d0\u4f9b\u5404\u79cdPV\uff0c\u800c\u4e0d\u4ec5\u4ec5\u662f\u5927\u5c0f\u548c\u8bbf\u95ee\u6a21\u5f0f\u7684\u533a\u522b\uff0c\u5e76\u4e14\u65e0\u987b\u8ba9\u7528\u6237\u4e86\u89e3\u8fd9\u4e9b\u5377\u7684\u5177\u4f53\u5b9e\u73b0\u65b9\u5f0f\u548c\u5b58\u50a8\u7c7b\u578b\uff0c\u8fbe\u5230\u4e86\u5b58\u50a8 \u7684\u89e3\u85d5\uff0c\u964d\u4f4e\u4e86\u5b58\u50a8\u4f7f\u7528\u7684\u590d\u6742\u5ea6\u3002</p> <p>\u57288.6\u8282\u7684PV\u90e8\u5206\uff0c\u6211\u4eec\u5217\u4e3e\u4e86\u51e0\u4e2a\u5e38\u7528\u7684\u5b58\u50a8\u7c7b\u578b\u7684\u914d\u7f6e\u65b9\u5f0f\uff0c\u63a5\u4e0b\u6765\u770b\u4e00\u4e0b\u5982\u4f55\u8ba9PVC\u548c\u8fd9\u4e9bPV\u7ed1\u5b9a\u3002</p> <p>\u6ce8\u610f</p> <p>PVC\u548cPV\u8fdb\u884c\u7ed1\u5b9a\u7684\u524d\u63d0\u6761\u4ef6\u662f\u4e00\u4e9b\u53c2\u6570\u5fc5\u987b\u5339\u914d\uff0c\u6bd4\u5982accessModes\u3001storageClassName\u3001volumeMode\u90fd\u9700\u8981\u76f8\u540c\uff0c \u5e76\u4e14PVC\u7684storage\u9700\u8981\u5c0f\u4e8e\u7b49\u4e8ePV\u7684storage\u914d\u7f6e\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#71-pvc\u7684\u521b\u5efa","title":"7.1 PVC\u7684\u521b\u5efa","text":"<p>\u6b64\u65f6\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2aPVC\u5373\u53ef\u4e0e\u5176\u7ed1\u5b9a\uff08\u6ce8\u610fPV\u548cPVC\u52a0\u7c97\u7684\u90e8\u5206\uff0cPV\u548cPVC\u8fdb\u884c\u7ed1\u5b9a\u5e76\u975e\u662f\u540d\u5b57\u76f8\u540c\uff0c\u800c\u662fStorageClassName\u76f8\u540c\u4e14\u5176\u4ed6\u53c2\u6570\u4e00\u81f4\u624d\u53ef\u4ee5\u8fdb\u884c\u7ed1\u5b9a\uff09\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a</p> <pre><code>kind: PersistentVolume\napiVersion: v1\nmetadata:\nname: task-pv-volume\nlabels:\ntype: local\nspec:\nstorageClassName: manual\ncapacity:\nstorage: 10Gi\naccessModes:\n- ReadWriteOnce\nhostPath:\npath: \"/mnt/data\"\n---\nkind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\nname: task-pv-claim\nspec:\nstorageClassName: manual\naccessModes:\n- ReadWriteOnce\nresources:\nrequests:\nstorage: 3Gi\n</code></pre> <p>\u6ce8\u610f</p> <p>PVC\u5177\u6709\u547d\u540d\u7a7a\u95f4\u9694\u79bb\u6027\uff0c\u4e0a\u8ff0\u4ee3\u7801\u6ca1\u6709\u6dfb\u52a0namespace\u53c2\u6570\uff0c\u4f1a\u9ed8\u8ba4\u521b\u5efa\u5728default\u547d\u540d\u7a7a\u95f4\u3002</p> <p>\u5982\u679c\u9700\u8981\u7ed9\u5176\u4ed6\u547d\u540d\u7a7a\u95f4\u7684Pod\u4f7f\u7528\uff0c\u5c31\u5e94\u5c06\u5176\u521b\u5efa\u5728\u6307\u5b9a\u7684\u547d\u540d\u7a7a\u95f4\u3002</p> <p>\u540c\u6837\u7684\u65b9\u5f0f\u4e5f\u53ef\u4ee5\u7ed9NFS\u7c7b\u578b\u7684PV\u521b\u5efa\u4e00\u4e2aPVC\uff1a</p> <pre><code>kind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\nname: pvc-nfs\nspec:\nstorageClassName: nfs-slow\naccessModes:\n- ReadWriteOnce\nresources:\nrequests:\nstorage: 3Gi\n</code></pre> <p>\u4ece\u4e0a\u8ff0\u4e24\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\u53ef\u4ee5\u770b\u51fa\uff0cPVC\u7684\u5b9a\u4e49\u548c\u540e\u7aef\u5b58\u50a8\u5e76\u6ca1\u6709\u5173\u7cfb\u3002</p> <p>\u5bf9\u4e8e\u6709\u5b58\u50a8\u9700\u6c42\u7684\u6280\u672f\u4eba\u5458\uff0c\u76f4\u63a5\u5b9a\u4e49PVC\u5373\u53ef\u7ed1\u5b9a\u4e00\u5757PV\uff0c\u4e4b\u540e\u5c31\u53ef\u4ee5\u4f9bPod\u4f7f\u7528\uff0c\u800c\u4e0d\u7528\u53bb\u5173\u5fc3\u5177\u4f53\u7684\u5b9e\u73b0\u7ec6\u8282\uff0c\u5927\u5927\u964d\u4f4e\u4e86\u5b58\u50a8\u7684\u590d\u6742\u5ea6\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u770b\u4e00\u4e0bPVC\u5982\u4f55\u63d0\u4f9b\u7ed9Pod\u4f7f\u7528\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#72-pvc\u7684\u4f7f\u7528","title":"7.2 PVC\u7684\u4f7f\u7528","text":"<p>\u4e0a\u8ff0\u521b\u5efa\u4e86PV\uff0c\u5e76\u4f7f\u7528PVC\u4e0e\u5176\u7ed1\u5b9a\uff0c\u73b0\u5728\u8fd8\u5dee\u4e00\u6b65\u5c31\u80fd\u8ba9\u7a0b\u5e8f\u4f7f\u7528\u8fd9\u5757\u5b58\u50a8\uff0c\u90a3\u5c31\u662f\u5c06PVC\u6302\u8f7d\u5230Pod\u3002\u548c\u4e4b\u524d\u7684\u6302\u8f7d\u65b9\u5f0f\u7c7b\u4f3c\uff0cPVC\u7684\u6302\u8f7d\u4e5f\u662f\u901a\u8fc7volumes\u5b57\u6bb5\u8fdb\u884c\u914d\u7f6e\u7684\uff0c\u53ea\u4e0d\u8fc7\u4e4b\u524d\u9700\u8981\u6839\u636e\u4e0d\u540c\u7684\u5b58\u50a8\u540e\u7aef\u586b\u5199\u5f88\u591a\u590d\u6742\u7684\u53c2\u6570\uff0c\u800c\u4f7f\u7528PVC\u8fdb\u884c\u6302\u8f7d\u65f6\uff0c\u53ea\u586b\u5199PVC\u7684\u540d\u5b57\u5373\u53ef\uff0c\u4e0d\u9700\u8981\u518d\u5173\u5fc3\u4efb\u4f55\u7684\u5b58\u50a8\u7ec6\u8282\uff0c\u8fd9\u6837\u5373\u4f7f\u4e0d\u662fKubernetes\u7ba1\u7406\u5458\uff0c\u4e0d\u61c2\u5b58\u50a8\u7684\u5176\u4ed6\u6280\u672f\u4eba\u5458\u60f3\u8981\u4f7f\u7528\u5b58\u50a8\uff0c\u4e5f\u53ef\u4ee5\u975e\u5e38\u7b80\u5355\u5730\u8fdb\u884c\u914d\u7f6e\u548c\u4f7f\u7528\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u5c06\u4e4b\u524d\u521b\u5efa\u7684hostPath\u7c7b\u578b\u7684PVC\u6302\u8f7d\u5230Pod\u4e2d\uff0c\u53ef\u4ee5\u770b\u5230\u53ea\u9700\u8981\u914d\u7f6e\u4e00\u4e2apersistentVolumeClaim\u7c7b\u578b\u7684volumes\uff0cclaimName\u914d\u7f6e\u4e3aPVC\u7684\u540d\u79f0\u5373\u53ef\uff1a</p> <pre><code>kind: Pod\napiVersion: v1\nmetadata:\nname: task-pv-pod\nspec:\nvolumes:\n- name: task-pv-storage\npersistentVolumeClaim:\nclaimName: task-pv-claim\ncontainers:\n- name: task-pv-container\nimage: nginx\nports:\n- containerPort: 80\nname: \"http-server\"\nvolumeMounts:\n- mountPath: \"/usr/share/nginx/html\"\nname: task-pv-storage\n</code></pre> <p>\u6ce8\u610f</p> <p>claimName\u9700\u8981\u548c\u4e0a\u8ff0\u5b9a\u4e49\u7684PVC\u540d\u79f0task-pv-claim\u4e00\u81f4\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#8\u52a8\u6001\u5b58\u50a8storageclass","title":"8.\u52a8\u6001\u5b58\u50a8StorageClass","text":"<p>\u867d\u7136\u4f7f\u7528PV\u548cPVC\u80fd\u5c4f\u853d\u4e00\u4e9b\u5b58\u50a8\u4f7f\u7528\u4e0a\u7684\u7ec6\u8282\uff0c\u964d\u4f4e\u4e86\u5b58\u50a8\u4f7f\u7528\u7684\u590d\u6742\u5ea6\uff0c\u4f46\u662f\u4e5f\u4f1a\u6709\u53e6\u4e00\u4e2a\u95ee\u9898\u65e0\u6cd5\u89e3\u51b3\u3002</p> <p>\u5f53\u516c\u53f8Kubernetes\u96c6\u7fa4\u5f88\u591a\uff0c\u5e76\u4e14\u4f7f\u7528\u5b83\u4eec\u7684\u6280\u672f\u4eba\u5458\u8fc7\u591a\u65f6\uff0c\u5bf9\u4e8ePV\u7684\u521b\u5efa\u662f\u4e00\u4e2a\u5f88\u8017\u65f6\u3001\u8017\u529b\u7684\u5de5\u4f5c\uff0c\u5e76\u4e14\u8fbe\u5230\u4e00\u5b9a\u89c4\u6a21\u540e\uff0c\u8fc7\u591a\u7684PV\u5c06\u96be\u4ee5\u7ef4\u62a4\u3002</p> <p>\u6240\u4ee5\u5c31\u9700\u8981\u67d0\u79cd\u673a\u5236\u7528\u4e8e\u81ea\u52a8\u7ba1\u7406PV\u7684\u751f\u547d\u5468\u671f\uff0c\u6bd4\u5982\u521b\u5efa\u3001\u5220\u9664\u3001\u81ea\u52a8\u6269\u5bb9\u7b49\uff0c\u4e8e\u662fKubernetes\u5c31\u8bbe\u8ba1\u4e86\u4e00\u4e2a\u540d\u4e3aStorageClass\uff08\u7f29\u5199\u4e3aSC\uff0c\u6ca1\u6709\u547d\u540d\u7a7a\u95f4\u9694\u79bb\u6027\uff09\u7684\u4e1c\u897f\uff0c\u901a\u8fc7\u5b83\u53ef\u4ee5\u52a8\u6001\u7ba1\u7406\u96c6\u7fa4\u4e2d\u7684PV\uff0c\u8fd9\u6837Kubernetes\u7ba1\u7406\u5458\u5c31\u65e0\u987b\u6d6a\u8d39\u5927\u91cf\u7684\u65f6\u95f4\u5728PV\u7684\u7ba1\u7406\u4e2d\u3002</p> <p>\u5728Kubernetes\u4e2d\uff0c\u7ba1\u7406\u5458\u53ef\u4ee5\u53ea\u521b\u5efaStorageClass\u201c\u94fe\u63a5\u201d\u5230\u540e\u7aef\u4e0d\u540c\u7684\u5b58\u50a8\uff0c\u6bd4\u5982Ceph\u3001GlusterFS\u3001OpenStack\u7684Cinder\u3001\u5176\u4ed6\u516c\u6709\u4e91\u63d0\u4f9b\u7684\u5b58\u50a8\u7b49\uff0c\u4e4b\u540e\u6709\u5b58\u50a8\u9700\u6c42\u7684\u6280\u672f\u4eba\u5458\uff0c\u521b\u5efa\u4e00\u4e2aPVC\u6307\u5411\u5bf9\u5e94\u7684StorageClass\u5373\u53ef\uff0cStorageClass\u4f1a\u81ea\u52a8\u521b\u5efaPV\u4f9bPod\u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528StatefulSet\u7684volumeClaimTemplate\u81ea\u52a8\u5206\u522b\u4e3a\u6bcf\u4e2aPod\u7533\u8bf7\u4e00\u4e2aPVC\u3002</p> <p>\u63a5\u4e0b\u6765\u770b\u4e00\u4e0b\u5982\u4f55\u5b9a\u4e49\u4e00\u4e2aStorageClass\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#81-\u5b9a\u4e49storageclass","title":"8.1 \u5b9a\u4e49StorageClass","text":"<p>\u5b9a\u4e49\u4e00\u4e2aStorageClass\u7684\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\nname: slow\nprovisioner: kubernetes.io/glusterfs\nparameters:\nresturl: \"http://127.0.0.1:8081\"\nclusterid: \"630372ccdc720a92c681fb928f27b53f\"\nrestauthenabled: \"true\"\nrestuser: \"admin\"\nsecretNamespace: \"default\"\nsecretName: \"heketi-secret\"\ngidMin: \"40000\"\ngidMax: \"50000\"\nvolumetype: \"replicate:3\"\n</code></pre> <p>\u8be5\u793a\u4f8b\u662f\u4f7f\u7528StorageClass\u94fe\u63a5GlusterFS\u7684\u4e00\u4e2a\u793a\u4f8b\uff0cPV\u548cVolume\u53ef\u4ee5\u76f4\u63a5\u914d\u7f6eGlusterFS\uff0c\u5176\u914d\u7f6e\u53c2\u6570\u548cStorageClass\u7684parameters\u7c7b\u4f3c\uff0c\u53ea\u4e0d\u8fc7PV\u662f\u5355\u72ec\u4f9bPVC\u4f7f\u7528\u7684\uff0c</p> <p>Volume\u662f\u9488\u5bf9\u67d0\u4e2aPod\u4f7f\u7528\u7684\uff0c\u800cStorageClass\u662f\u4e00\u4e2a\u5168\u5c40\u7684\u914d\u7f6e\uff0c\u6ca1\u6709\u547d\u540d\u7a7a\u95f4\u9694\u79bb\u6027\uff0c\u4efb\u4f55\u547d\u540d\u7a7a\u95f4\u4e0b\u6709\u5b58\u50a8\u9700\u6c42\u7684\u5e94\u7528\u90fd\u53ef\u4ee5\u914d\u7f6e\u5bf9\u5e94\u7684StorageClass\u6765\u83b7\u53d6\u5b58\u50a8\u3002</p> <p>StorageClass\u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e9b\u66f4\u9ad8\u7ea7\u7684\u914d\u7f6e\uff0c\u6bd4\u5982provisioner\u3001parameters\u3001reclaimPolicy\u3001allowVolumeExpansion\u7b49\u3002</p> <ul> <li>Provisioner\uff1a\u76f4\u8bd1\u8fc7\u6765\u662f\u4f9b\u5e94\u5546\u7684\u610f\u601d\uff0c\u4e5f\u5c31\u662f\u901a\u8fc7\u8be5\u53c2\u6570\u6765\u6807\u660e\u5bf9\u4e8ePV\u7684\u521b\u5efa\u4f7f\u7528\u54ea\u4e2a\u63d2\u4ef6\u6765\u6267\u884c\uff0c\u6bd4\u5982\u521b\u5efaGlusterFS\u7c7b\u578b\u7684PV\uff0c\u9700\u8981\u4f7f\u7528GlusterFS\u7684\u63d2\u4ef6\u624d\u80fd\u521b\u5efa\uff0c\u5fc5\u987b\u6307\u5b9a\u6b64\u5b57\u6bb5\u3002</li> </ul> <p>\u76ee\u524d\u5b98\u65b9\u652f\u6301\u7684Provisioner\u53ef\u4ee5\u5728\u6b64\u5904\u67e5\u770b\uff1ahttps://kubernetes.io/docs/concepts/storage/storage-classes/#provisioner\u3002</p> <p>\u6ce8\u610f</p> <p>Provisioner\u4e0d\u4ec5\u9650\u4e8e\u5b98\u65b9\u5217\u51fa\u7684\u5185\u90e8provisioner\uff0c\u8fd8\u53ef\u4ee5\u8fd0\u884c\u548c\u6307\u5b9a\u5916\u90e8\u4f9b\u5e94\u5546\u3002</p> <p>\u4f8b\u5982\uff0cNFS\u4e0d\u63d0\u4f9b\u5185\u90e8\u914d\u7f6e\u7a0b\u5e8f\uff0c\u4f46\u662f\u53ef\u4ee5\u4f7f\u7528\u5916\u90e8\u914d\u7f6e\u7a0b\u5e8f\uff0c\u5916\u90e8\u914d\u7f6e\u65b9\u5f0f\u53c2\u89c1\u7f51\u5740\uff08\u5176\u4ed6\u7c7b\u578b\u7684\u5b58\u50a8\u53ef\u4ee5\u5728\u5176\u5b98\u65b9\u6587\u6863\u6216\u8005GitHub\u8fdb\u884c\u67e5\u627e\uff09\uff1a</p> <p>https://github.com/kubernetes-incubator/external-storage\u3002</p> <ul> <li>Parameters\uff1a\u9488\u5bf9\u540e\u7aef\u914d\u7f6e\u7684\u4e0d\u540c\u53c2\u6570\uff0c\u6bd4\u5982\u4e0a\u8ff0\u7684GlusterFS\u7c7b\u578b\u7684StorageClass\uff0c\u53ef\u4ee5\u6307\u5b9a\u6570\u636e\u7684\u526f\u672c\u6570\uff08replicate:3\uff09\u3001Gluster REST\u670d\u52a1/Heketi\u670d\u52a1\u7684URL\u7b49\u3002\u8be5\u53c2\u6570\u7684\u5b9a\u4e49\u53d6\u51b3\u4e8eprovisioner\uff0c\u4e0d\u540c\u7684provisioner\u914d\u7f6e\u7684\u53c2\u6570\u4e0d\u540c\u3002\u5982\u679c\u8be5\u53c2\u6570\u7701\u7565\u4f1a\u4f7f\u7528\u9ed8\u8ba4\u503c\u3002</li> <li>ReclaimPolicy\uff1a\u56de\u6536\u7b56\u7565\uff0c\u53ef\u4ee5\u662fDelete\u3001Retain\uff0c\u9ed8\u8ba4\u4e3aDelete\uff0c\u4e5f\u5c31\u662fPVC\u88ab\u5220\u9664\u540e\uff0c\u5bf9\u5e94\u7684PV\u5982\u4f55\u5904\u7406\u3002</li> <li>MountOptions\uff1a\u901a\u8fc7StorageClass\u52a8\u6001\u521b\u5efa\u7684PV\u53ef\u4ee5\u4f7f\u7528MountOptions\u6307\u5b9a\u6302\u8f7d\u53c2\u6570\u3002\u5982\u679c\u6307\u5b9a\u7684\u5377\u63d2\u4ef6\u4e0d\u652f\u6301\u6307\u5b9a\u7684\u6302\u8f7d\u9009\u9879\uff0c\u5c31\u4e0d\u4f1a\u88ab\u521b\u5efa\u6210\u529f\uff0c\u56e0\u6b64\u5728\u8bbe\u7f6e\u65f6\u9700\u8981\u8fdb\u884c\u786e\u8ba4\u3002</li> <li>AllowVolumeExpansion\uff1a\u662f\u5426\u5141\u8bb8\u5bf9PV\u8fdb\u884c\u6269\u5bb9\uff0c\u9700\u8981\u540e\u7aef\u5b58\u50a8\u652f\u6301\uff0c\u4e00\u822c\u4e0d\u63a8\u8350\u8fdb\u884c\u7f29\u5bb9\u3002\u76ee\u524d\u652f\u6301\u6269\u5bb9\u7684\u5b58\u50a8\u7c7b\u578b\u53ef\u4ee5\u5728\u4ee5\u4e0b\u6587\u6863\u67e5\u770b\uff1ahttps://kubernetes.io/docs/concepts/storage/storage-classes/#allow-volume-expansion\u3002</li> </ul> <p>\u8be5\u5c0f\u8282\u901a\u8fc7\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\u6765\u8bf4\u660e\u5982\u4f55\u914d\u7f6e\u4e00\u4e2aStorageClass\uff0c\u5bf9\u4e8e\u5176\u4ed6\u4e0d\u540c\u7c7b\u578b\u7684\u5b58\u50a8\u914d\u7f6e\u65b9\u5f0f\u53ea\u662fparameters\u4e0d\u4e00\u6837\uff0c\u4f7f\u7528\u65b9\u5f0f\u90fd\u662f\u4e00\u6837\u7684\u3002</p> <p>\u5176\u4ed6\u7c7b\u578b\u7684\u5b58\u50a8\u53ef\u4ee5\u53c2\u8003\u5b98\u65b9\u6587\u6863\uff1ahttps://kubernetes.io/docs/concepts/storage/storage-classes/#parameters\u3002</p> <p>\u63a5\u4e0b\u6765\u901a\u8fc7\u4e00\u4e2aCeph RBD\u7684\u793a\u4f8b\u6765\u6f14\u793a\u4e00\u4e0bStorageClass\u7684\u4f7f\u7528\u65b9\u6cd5\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#82-\u6574\u5408storageclass\u548cceph-rbd","title":"8.2 \u6574\u5408StorageClass\u548cCeph RBD","text":"<ol> <li>Kubernetes\u96c6\u7fa4\u7684\u5b89\u88c5\u53ef\u4ee5\u53c2\u8003\u672c\u4e66\u5b89\u88c5\u7bc7</li> <li>Ceph\u96c6\u7fa4\u7684\u642d\u5efa\u53ef\u4ee5\u53c2\u8003\u5176\u5b98\u65b9\u6587\u6863\uff1ahttps://docs.ceph.com/en/latest/install/</li> </ol> <p>\u672c\u5c0f\u8282\u5185\u5bb9\u5047\u5b9a\u5b9e\u9a8c\u73af\u5883\u5df2\u7ecf\u6709\u4e86Kubernetes\u96c6\u7fa4\u548cCeph\u96c6\u7fa4\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#821-\u90e8\u7f72ceph-rbd-provisioner","title":"8.2.1 \u90e8\u7f72Ceph RBD Provisioner","text":"<p>provi-cephrbd.yaml</p> <pre><code>---\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\nname: rbd-provisioner\nnamespace: kube-system\nrules:\n- apiGroups: [\"\"]\nresources: [\"persistentvolumes\"]\nverbs: [\"get\", \"list\", \"watch\", \"create\", \"delete\"]\n- apiGroups: [\"\"]\nresources: [\"persistentvolumeclaims\"]\nverbs: [\"get\", \"list\", \"watch\", \"update\"]\n- apiGroups: [\"storage.k8s.io\"]\nresources: [\"storageclasses\"]\nverbs: [\"get\", \"list\", \"watch\"]\n- apiGroups: [\"\"]\nresources: [\"events\"]\nverbs: [\"create\", \"update\", \"patch\"]\n- apiGroups: [\"\"]\nresources: [\"services\"]\nresourceNames: [\"kube-dns\",\"coredns\"]\nverbs: [\"list\", \"get\"]\n- apiGroups: [\"\"]\nresources: [\"endpoints\"]\nverbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\"]\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\nname: rbd-provisioner\nnamespace: kube-system\nsubjects:\n- kind: ServiceAccount\nname: rbd-provisioner\nnamespace: kube-system\nroleRef:\nkind: ClusterRole\nname: rbd-provisioner\napiGroup: rbac.authorization.k8s.io\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\nname: rbd-provisioner\nnamespace: kube-system\nrules:\n- apiGroups: [\"\"]\nresources: [\"secrets\"]\nverbs: [\"get\"]\n- apiGroups: [\"\"]\nresources: [\"endpoints\"]\nverbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\nname: rbd-provisioner\nnamespace: kube-system\nroleRef:\napiGroup: rbac.authorization.k8s.io\nkind: Role\nname: rbd-provisioner\nsubjects:\n- kind: ServiceAccount\nname: rbd-provisioner\nnamespace: kube-system\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: rbd-provisioner\nnamespace: kube-system\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: rbd-provisioner\nstrategy:\ntype: Recreate\ntemplate:\nmetadata:\nlabels:\napp: rbd-provisioner\nspec:\ncontainers:\n- name: rbd-provisioner\nimage: \"registry.cn-beijing.aliyuncs.com/dotbalo/rbd-provisioner:latest\"\nenv:\n- name: PROVISIONER_NAME\nvalue: ceph.com/rbd\n</code></pre> <p>\u9996\u5148\u5b89\u88c5Ceph RBD\u7684Provisioner\uff0c\u76f4\u63a5\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u5373\u53ef\u5b89\u88c5Ceph RBD Provisioner\uff0c\u5e76\u521b\u5efa\u5176\u76f8\u5173\u7684\u6743\u9650\uff1a</p> <pre><code>$ kubectl  apply -f provi-cephrbd.yaml\nserviceaccount/rbd-provisioner created\nclusterrole.rbac.authorization.k8s.io/rbd-provisioner created\nclusterrolebinding.rbac.authorization.k8s.io/rbd-provisioner created\nrole.rbac.authorization.k8s.io/rbd-provisioner created\nrolebinding.rbac.authorization.k8s.io/rbd-provisioner created\ndeployment.apps/rbd-provisioner created\n</code></pre> <p>\u67e5\u770bPod\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods -n kube-system -l app=rbd-provisioner\n</code></pre>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#822-\u521b\u5efaceph-pool","title":"8.2.2 \u521b\u5efaCeph Pool","text":"<p>\u63a5\u4e0b\u6765\u521b\u5efa\u4e00\u4e2aKubernetes\u4e13\u7528\u7684Pool\u4e3aPod\u63d0\u4f9bPV\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5df2\u7ecf\u5b58\u5728\u7684Pool\u3002</p> <p>\u767b\u5f55Ceph\u7684\u7ba1\u7406\u7aef\uff0c\u521b\u5efa\u4e00\u4e2a\u540d\u4e3arbdfork8s\u3001pg_num\u4e3a128\uff08\u751f\u4ea7\u73af\u5883\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u914d\u7f6epg_num\uff0c\u5177\u4f53\u53ef\u4ee5\u53c2\u8003Ceph\u6587\u6863\uff09\u7684Pool\uff1a</p> <pre><code>$ ceph osd pool create rbdfork8s 128\npool 'rbdfork8s' created\n</code></pre> <p>\u5bf9\u65b0\u5efa\u7684Pool\u8fdb\u884c\u5355\u72ec\u6388\u6743\uff1a</p> <pre><code>$ ceph auth add client.kube mon 'allow r' osd 'allow rwx pool=rbdfork8s'\nadded key for client.kube\n</code></pre> <p>\u521d\u59cb\u5316\u8be5Pool\uff08\u4e0d\u662f\u65b0\u5efa\u7684Pool\u65e0\u987b\u521d\u59cb\u5316\uff09\uff1a</p> <pre><code>$ ceph osd pool application enable rbdfork8s rbd\nenabled application 'rbd' on pool 'rbdfork8s'\n$ rbd pool init rbdfork8s\n</code></pre> <p>\u67e5\u770bclient.kube\u7684Key\uff1a</p> <pre><code>$ ceph auth get-key client.kube\nAQB/eopgaqSRJxAAYDs2gKTXSpcpY2m+yHJaJw==\n</code></pre> <p>\u5728Kubernetes\u4e2d\u521b\u5efa\u5177\u6709\u8be5Key\u7684Secret\uff0c\u4f9bStorageClass\u914d\u7f6e\u4f7f\u7528\uff1a</p> <pre><code>$ kubectl create secret generic ceph-k8s-secret \\\n--type=\"kubernetes.io/rbd\" \\\n--from-literal=key='AQB/eopgaqSRJxAAYDs2gKTXSpcpY2m+yHJaJw==' \\\n-n kube-system\n</code></pre> <p>admin\u7528\u6237\u7684Key\u4e5f\u8981\u521b\u5efa\u4e00\u4e2aSecret\u4f9bStorageClass\u4f7f\u7528\uff0c\u67e5\u770bceph admin\u7684Key\uff1a</p> <pre><code>$ ceph auth get-key client.admin\nAQA8HP9ezBHPDBAAdL+NteK0d1mjXZV47r4I7w==\n</code></pre> <p>\u5c06Key\u4fdd\u5b58\u5728Kubernetes\u7684Secret\u4e2d\uff1a</p> <pre><code>$ kubectl create secret generic ceph-admin-secret \\\n--type=\"kubernetes.io/rbd\" \\\n--from-literal=key='AQA8HP9ezBHPDBAAdL+NteK0d1mjXZV47r4I7w==' \\\n-n kube-system\n\n$ kubectl get secret -n kube-system ceph-admin-secret\n</code></pre>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#823-\u521b\u5efastorageclass","title":"8.2.3 \u521b\u5efaStorageClass","text":"<p>\u5728Ceph\u7684\u7ba1\u7406\u7aef\u67e5\u770bMonitor\u7684\u8282\u70b9\u4fe1\u606f\uff1a</p> <pre><code>$ ceph mon dump\n</code></pre> <p>\u5c06\u6253\u5370\u7684\u7ed3\u679c\u4e2d\u7684Monitor\u7684IP\u5730\u5740\u586b\u5199\u5230StorageClass\u4e2d\uff0c\u4e00\u822c\u4e3aIP\u5730\u5740+6789\u7aef\u53e3\uff08\u66ff\u6362\u4ee5\u4e0b\u6587\u4ef6\u7684monitors\u53c2\u6570\uff09\uff1a</p> <p>rbd-sc.yaml</p> <pre><code>---\nkind: StorageClass\napiVersion: storage.k8s.io/v1\nmetadata:\nname: ceph-rbd\nprovisioner: ceph.com/rbd\nparameters:\nmonitors: x.x.x.x:6789,x.x.x.x:6789,x.x.x.x:6789\npool: rbdfork8s\nadminId: admin\nadminSecretNamespace: kube-system\nadminSecretName: ceph-admin-secret\nuserId: kube\nuserSecretNamespace: kube-system\nuserSecretName: ceph-k8s-secret\nimageFormat: \"2\"\nimageFeatures: layering\n</code></pre> <p>\u521b\u5efa\u8be5StorageClass\uff1a</p> <pre><code>$ kubectl create -f rbd-sc.yaml\n$ kubectl get sc\n</code></pre>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#824-\u521b\u5efapvc","title":"8.2.4 \u521b\u5efaPVC","text":"<p>\u4e4b\u540e\u521b\u5efa\u4e00\u4e2aPVC\u6307\u5411\u8be5StorageClass\uff08\u6ce8\u610fstorageClassName\u4e3a\u4e0a\u8ff0\u521b\u5efa\u7684StorageClass\u7684\u540d\u5b57\uff09\uff1a</p> <p>rbd-pvc.yaml</p> <pre><code>---\nkind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\nname: rbd-pvc-test\nspec:\naccessModes:\n- ReadWriteOnce\nstorageClassName: ceph-rbd\nresources:\nrequests:\nstorage: 100Mi\n</code></pre> <pre><code>$ kubectl create -f rbd-pvc.yaml </code></pre> <p>\u521b\u5efa\u5b8c\u6210\u4e4b\u540e\uff0cStorageClass\u4f1a\u81ea\u52a8\u521b\u5efaPV\uff0c\u7136\u540e\u4e0ePVC\u8fdb\u884c\u7ed1\u5b9a\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#9\u5b58\u50a8\u7684\u672a\u6765csi","title":"9.\u5b58\u50a8\u7684\u672a\u6765\uff1aCSI","text":"<p>\u524d\u9762\u8bb2\u89e3\u4e86Kubernetes\u5b58\u50a8\u7684\u591a\u79cd\u4f7f\u7528\u65b9\u5f0f\uff0c\u6bd4\u5982Volumes\u76f4\u8fde\u3001PV\u548c\u52a8\u6001\u5b58\u50a8StorageClass\uff0c\u867d\u7136PV\u964d\u4f4e\u4e86\u5176\u4ed6\u4eba\u5458\u4f7f\u7528\u5b58\u50a8 \u7684\u590d\u6742\u6027 \uff0c StorageClass\u4e5f\u964d\u4f4e\u4e86Kubernetes\u7ba1\u7406\u5458\u7ba1\u7406PV\u7684\u96be\u5ea6\u3002</p> <p>\u4f46\u662f\u5728Kubernetes \u53d1\u5c55\u4e2d\u8fd8\u6709\u4e00\u4e2a\u68d8\u624b\u7684\u95ee\u9898\uff0c\u5c31\u662f\u5e02\u9762\u4e0a\u76ee\u524d\u6709\u5f88\u591a\u5b58\u50a8\u63d0\u4f9b\u5546\uff0c\u6bd4\u5982NFS\u3001 Ceph\u3001NAS\u7b49\uff0c\u5b83\u4eec\u90fd\u5c5e\u4e8e\u4e0d\u540c\u7684\u201c\u5382\u5546\u201d\uff0c\u7531\u4e0d\u540c\u7684\u56e2\u961f\u7ef4\u62a4\uff0c\u800c\u6bcf\u4e2a\u516c\u53f8\u6839\u636e\u81ea\u5df1\u7684\u5b9e\u9645\u60c5\u51b5\u9009\u62e9\u4e0d\u540c\u7684\u5b58\u50a8\uff0c</p> <p>Kubernetes\u4f5c\u4e3a\u4e00\u4e2a\u6bd4\u8f83\u6d41\u884c\u7684\u4e91\u539f \u751f\u64cd\u4f5c\u7cfb\u7edf\uff0c\u60f3\u8981\u6709\u66f4\u597d\u7684\u517c\u5bb9\u6027\uff0c\u5c31\u9700\u8981\u53bb\u517c\u5bb9\u8fd9\u4e9b\u5b58\u50a8\uff0c\u8fd9\u5c31\u610f\u5473\u7740 Kubernetes\u7684\u7ef4\u62a4\u4eba\u5458\u9700\u8981\u5b66\u4e60\u6bcf\u79cd\u5b58\u50a8\u7684\u4f7f\u7528\u65b9\u6cd5\uff0c\u624d\u80fd\u5f00\u53d1\u51fa\u4f7f\u7528\u67d0\u7c7b \u5b58\u50a8\u7684\u529f\u80fd\uff0c\u8fd9\u5bf9\u4e8eKubernetes\u7ef4\u62a4\u4eba\u5458\u6765\u8bf4\u5c06\u662f\u4e00\u79cd\u6311\u6218\uff0c\u540c\u65f6\u968f\u7740\u5b58\u50a8\u7684\u589e\u591a\uff0cKubernetes\u7684\u4ee3\u7801\u4f1a\u663e\u5f97\u8d8a\u6765\u8d8a\u81c3\u80bf\u3001\u96be\u4ee5\u7ef4\u62a4\uff0c\u6240\u4ee5\u8981\u6709\u4e00\u79cd\u65b9\u5f0f\u6765\u89e3\u51b3\u8fd9\u7c7b\u95ee\u9898\u3002</p> <p>\u5728\u4e4b\u524d\u7684\u7ae0\u8282\u63d0\u5230\u8fc7\uff0cKubernetes\u4f5c\u4e3a\u4e00\u4e2a\u5bb9\u5668\u7684\u7f16\u6392\u5e73\u53f0\uff0c\u80fd\u591f\u8c03\u5ea6 \u591a\u79cd\u4e0d\u540c\u7684\u5bb9\u5668\u5f15\u64ce\uff0c\u6bd4\u5982Containerd\u3001Docker\uff081.24\u7248\u672c\u4e4b\u524d\uff09\u3001CRI-O \u7b49\u3002</p> <p>\u4e3a\u4e86\u80fd\u591f\u517c\u5bb9\u66f4\u591a\u7684\u5bb9\u5668\u5f15\u64ce\uff0c\u65e0\u987bKubernetes\u7ba1\u7406\u5458\u7f16\u5199\u591a\u4f59\u7684\u4ee3 \u7801\uff0cKubernetes\u63d0\u51fa\u4e86CRI\uff08Container Runtime Interface\uff0c\u5bb9\u5668\u8fd0\u884c\u65f6\u63a5 \u53e3\uff09\u7684\u6982\u5ff5\uff0c\u4efb\u4f55\u5f00\u53d1\u5bb9\u5668\u5f15\u64ce\u7684\u516c\u53f8\u53ea\u9700\u8981\u517c\u5bb9\u8fd9\u4e2a\u63a5\u53e3\uff0c\u5c31\u53ef\u4ee5\u88ab Kubernetes\u8c03\u5ea6\u3002</p> <p>\u4e3a\u5b9e\u73b0\u4e0a\u8ff0\u76ee\u6807\uff0cKubernetes\u53c8\u63d0\u51fa\u4e86\u4e00\u4e2a\u65b0\u7684\u6807\u51c6CSI\uff08Container Storage Interface\uff0c\u5bb9\u5668\u5b58\u50a8\u63a5\u53e3\uff09\uff0c\u8be5\u6807\u51c6\u76f8\u5f53\u4e8e\u5728\u5bb9\u5668\u7f16\u6392\u5e73\u53f0\u548c\u5b58\u50a8 \u4e4b\u95f4\u63d0\u4f9b\u4e86\u4e00\u4e2a\u201c\u6865\u6881\u201d\uff0c\u53ea\u8981\u5b58\u50a8\u5e73\u53f0\u5b9e\u73b0\u4e86\u8fd9\u4e2a\u63a5\u53e3\uff0c\u5c31\u80fd\u4e3a\u7f16\u6392\u5e73\u53f0 \uff08\u4e0d\u9650\u4e8eKubernetes\uff09\u63d0\u4f9b\u5b58\u50a8\u529f\u80fd\u3002\u8fd9\u79cd\u5b58\u50a8\u7684\u5b9e\u73b0\u9700\u8981\u5b58\u50a8\u5382\u5546\u63d0\u4f9b\u7b26\u5408CSI\u6807\u51c6\u7684\u9a71\u52a8\uff0c\u53ea\u8981\u914d\u7f6eStorageClass\u94fe\u63a5\u8be5\u9a71\u52a8\u5373\u53ef\u4e3aKubernetes\u63d0\u4f9b \u5b58\u50a8\u3002 CSI\u6807\u51c6\u5c06\u5b58\u50a8\u7684\u4ee3\u7801\u4e0b\u6c89\u5230\u4e86\u5b58\u50a8\u5382\u5546\uff0c\u800cKubernetes\u7ef4\u62a4\u4eba\u5458\u65e0\u987b \u518d\u5173\u6ce8\u5b58\u50a8\u7ec6\u8282\uff0c\u53ea\u9700\u8981\u5173\u6ce8Kubernetes\u6838\u5fc3\u4ee3\u7801\u5373\u53ef\u3002</p> <p>\u8fd9\u7c7b\u5f00\u53d1\u65b9\u5f0f\u79f0\u4e3aout-of-tree\uff0c\u610f\u601d\u5c31\u662f\u5728Kubernetes\u6838\u5fc3\u4ee3\u7801\u5916\u7ef4\u62a4\u5b9e\u73b0\u5404\u7c7b\u5b58\u50a8\u7684\u63a5\u5165\uff0c \u4e4b\u524d\u7684Volume \u3001 PV \u3001 StorageClass\u79f0\u4e3ain-tree\u7684\u5f00\u53d1\u65b9\u5f0f\uff0c\u610f\u601d\u662f\u5728Kubernetes\u5185\u90e8\u7ef4\u62a4\u5b58\u50a8\u7684\u63a5\u5165\u3002</p> <p>\u76f8\u6bd4\u4e4b\u4e0b\uff0cout-of-tree\u662f\u66f4\u4f73\u7684\u5b9e\u73b0\u65b9\u5f0f\uff0c\u4e8e\u662f\u73b0\u5728\u5f88\u591ain-tree\u7684\u5b9e\u73b0\u65b9\u5f0f\u90fd\u5728\u6162\u6162\u5730\u5411out-of-tree\u8fc1\u79fb\u3002</p> <p>\u63d0\u793a</p> <p>\u5916\u7f6e\u5b58\u50a8\u9a71\u52a8\u9664CSI\u5916\uff0c\u8fd8\u6709\u4e00\u79cd\u5b9e\u73b0\u65b9\u5f0f\uff0c\u79f0\u4e3aFlex Volume\uff0c\u7531\u4e8e\u5df2\u7ecf\u8fc7\u65f6\uff0c\u672c\u4e66\u4e0d\u518d\u4ecb\u7ecd\u3002\u9488\u5bf9\u5b58\u50a8\u7684\u63a5\u5165\uff0c\u5e94\u8be5\u66f4\u503e\u5411\u4e8eCSI\u7684\u65b9\u5f0f\u3002</p> <p>\u4ee5\u4e0a\u7b80\u5355\u8bb2\u89e3\u4e86CSI\u7684\u6982\u5ff5\uff0c\u4e0b\u9762\u901a\u8fc7\u793a\u4f8b\u4e86\u89e3\u4e00\u4e0bCSI\u5177\u4f53\u7684\u5b9e\u73b0\u65b9\u5f0f\u3002\u5176\u5b9eCSI\u7684\u914d\u7f6e\u4e5f\u662f\u6bd4\u8f83\u7b80\u5355\u7684\uff0c\u53ef\u4ee5\u7b80\u5355\u7406\u89e3\u4e3a\u4ee5\u4e0b\u51e0\u4e2a\u6b65\u9aa4\uff1a</p> <p>1\uff09\u627e\u5230\u5bf9\u5e94\u5b58\u50a8\u7684CSI\u9a71\u52a8\u53ca\u5b89\u88c5\u65b9\u5f0f\u3002 2\uff09\u5728Kubernetes\u96c6\u7fa4\u4e2d\u5b89\u88c5\u8be5\u9a71\u52a8\u3002 3\uff09\u914d\u7f6eStorageClass\u94fe\u63a5\u81f3\u8be5\u9a71\u52a8\u5373\u53ef\u4f7f\u7528\u3002</p> <p>\u63a5\u4e0b\u6765\u901a\u8fc7\u4e24\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff0c\u5373CSI\u5bf9\u63a5CephFS\u548cCeph RBD\u6765\u5b66\u4e60CSI\u5177\u4f53\u7684\u4f7f\u7528\u65b9\u6cd5\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#91-\u901a\u8fc7csi\u8fde\u63a5cephfs","title":"9.1 \u901a\u8fc7CSI\u8fde\u63a5CephFS","text":"<p>\u9996\u5148\u6211\u4eec\u4ecb\u7ecd\u5982\u4f55\u901a\u8fc7CSI\u914d\u7f6eCeph\u7684\u6587\u4ef6\u5b58\u50a8\uff0c Ceph CSI\u7684\u6587\u6863\u53ef\u4ee5\u5728https://github.com/ceph/ceph-csi\u67e5\u770b\uff0c CephFS CSI\u7684\u90e8\u7f72\u6587\u6863\u53ef\u4ee5\u901a\u8fc7\u94fe\u63a5\uff1ahttps://github.com/ceph/ceph-csi/blob/devel/docs/deploy-cephfs.md  \u67e5\u770b\uff08\u8be5\u94fe\u63a5\u53ef\u80fd\u4f1a\u6709\u6240\u53d8\u5316\uff0c\u53ef\u4ee5\u4ecehttps://github.com/ceph/ceph-csi\u7684\u76ee\u5f55\u4e2d\u67e5\u627e\uff09\u3002</p> <p>CephFS\u548cCeph RBD\u7684\u90e8\u7f72\u65b9\u5f0f\u5206\u4e3a\u4e24\u79cd\uff1a Helm\u5b89\u88c5\u548c\u76f4\u63a5\u4f7f\u7528YAML\u8fdb\u884c\u5b89\u88c5\u3002</p> <p>\u7531\u4e8e\u4e24\u8005\u6d89\u53ca\u7684YAML\u6587\u4ef6\u8fc7\u591a\uff0c\u5728\u6b64\u4f7f\u7528Helm\uff08Helm\u662fKubernetes\u7684\u4e00\u79cd\u5305\u7ba1\u7406\u5de5\u5177\uff0c\u53ef\u4ee5\u5f88\u65b9\u4fbf\u5730\u5bf9\u590d\u6742\u7684\u5e73\u53f0\u8fdb\u884c\u4e00\u952e\u5f0f\u5b89\u88c5\uff0cHelm\u5b98\u65b9\u6587 \u6863\uff1ahttps://helm.sh/\uff09\u8fdb\u884c\u5b89\u88c5\u3002</p> <p>\u9996\u5148\u9700\u8981\u5728Kubernetes\uff08\u672c\u5c0f\u8282\u5b9e\u9a8c\u9700\u8981\u6709Kubernetes\u548cCeph\u73af\u5883\uff09\u7684\u63a7\u5236\u7aef\uff08\u4e5f\u5c31\u662f\u6267\u884cKubectl\u547d\u4ee4\u7684\u673a\u5668\uff09\u5b89\u88c5Helm\u7684\u5ba2\u6237\u7aef\u5de5\u5177\uff0c\u53ea\u9700\u8981\u4e0b\u8f7dHelm\u7684\u4e8c\u8fdb\u5236\u5305\u5373\u53ef\uff1a</p> <pre><code>$ curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash\nDownloading https://get.helm.sh/helm-v3.5.4-linux-amd64.tar.gz\nVerifying checksum... Done.\nPreparing to install helm into /usr/local/bin\n</code></pre> <p>\u67e5\u770b\u5b89\u88c5\u7684Helm\u7248\u672c\uff1a <pre><code>$ helm version\nversion.BuildInfo{Version:\"v3.5.4\", GitCommit:\"fe51cd1e31e6a202cba7dead9552a6d418ded79a\", GitTreeState:\"clean\", GoVersion:\"go1.15.11\"}\n</code></pre></p> <p>1\uff0eCephFS\u9a71\u52a8\u5b89\u88c5 Helm\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u8fdb\u5165\u672c\u4e66\u8be5\u5c0f\u8282\u7684\u6587\u6863\u76ee\u5f55\uff0c\u7136\u540e\u8fdb\u5165install\u6587\u4ef6\u5939\uff0c\u5b89\u88c5CephFS CSI\uff1a <pre><code>$ kubectl create namespace ceph-csi-cephfs\nnamespace/ceph-csi-cephfs created\n\n$ helm install --namespace \"ceph-csi-cephfs\" \"ceph-csi-cephfs\" .\n</code></pre></p> <p>\u6ce8\u610f</p> <p>\u7531\u4e8eHelm\u5305\u9ed8\u8ba4\u7684\u955c\u50cf\u5730\u5740\u662fgcr.io\u4ed3\u5e93\uff0c\u56fd\u5185\u53ef\u80fd\u65e0\u6cd5\u8bbf\u95ee\uff0c\u56e0\u6b64\u672c\u4e66\u6240\u7528\u7684\u5305\u5df2\u7ecf\u4e3a\u8bfb\u8005\u5c06\u76f8\u5173gcr\u955c\u50cf\u540c\u6b65\u5230\u4e86\u963f\u91cc\u4e91\uff0c\u53ef\u4ee5\u76f4\u63a5\u5b89\u88c5\u3002 \u5982\u679c \u4f7f\u7528\u7684\u662f\u65b0\u7684Helm\u5305\uff0c\u9700\u8981\u81ea\u884c\u540c\u6b65gcr\u955c\u50cf\u81f3\u963f\u91cc\u4e91\u6216\u516c\u53f8\u5185\u7684\u955c\u50cf\u4ed3\u5e93\uff0c\u65b0\u7248\u5b89\u88c5\u6587\u6863\uff1a https://github.com/ceph/ceph-csi/blob/devel/charts/ceph-csi-cephfs/README.md</p> <p>\u67e5\u770bCSI\u9a71\u52a8Pod\u7684\u72b6\u6001\uff1a <pre><code>$ kubectl get pod -n ceph-csi-cephfs\n</code></pre></p> <p>2\uff0eCeph\u914d\u7f6e</p> <p>\u4e4b\u540e\u9700\u8981\u5728Ceph\u4e2d\u521b\u5efa\u4e00\u4e2aPool\u4e3aKubernetes\u96c6\u7fa4\u63d0\u4f9b\u5b58\u50a8\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5df2\u7ecf\u5b58\u5728\u7684Pool\u3002 </p> <p>\u9996\u5148\u67e5\u770b\u5f53\u524dCeph\u96c6\u7fa4\u6709\u65e0Filesystem\u7c7b\u578b\u7684Pool\uff0c\u5982\u679c\u6709\u5219\u65e0\u987b\u518d\u521b\u5efa\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\uff1a</p> <pre><code>$ ceph fs ls\nname: sharefs, metadata pool: sharefs-metadata, data pools: [sharefs-data0 ]\n</code></pre> <p>\u5982\u679c\u6ca1\u6709\u7684\u8bdd\uff0c\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u7c7b\u578b\u7684Pool\uff08\u5927\u5c0f\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u8fdb\u884c\u914d\u7f6e\uff09\uff1a <pre><code>$ ceph osd pool create sharefs-data0 128 128\n$ ceph osd pool create sharefs-metadata 64 64\n$ ceph fs new sharefs sharefs-metadata sharefs-data0\n$ ceph fs ls\nname: sharefs, metadata pool: sharefs-metadata, data pools: [sharefs-data0 ]\n</code></pre></p> <p>Kubernetes\u4f7f\u7528Ceph\u4f5c\u4e3a\u540e\u7aef\u5b58\u50a8\uff0c\u4f1a\u5bf9Ceph\u96c6\u7fa4\u7684\u5377\u8fdb\u884c\u76f8\u5173\u64cd\u4f5c\uff0c \u6bd4\u5982\u521b\u5efa\u3001\u5220\u9664\u3001\u66f4\u6539\u7b49\uff0c\u6240\u4ee5Kubernetes\u9700\u8981\u6709\u76f8\u5173\u7684\u6743\u9650\uff0c \u6b64\u65f6\u53ef\u4ee5\u628a Ceph\u7684\u8ba4\u8bc1\u4fe1\u606f\u4fdd\u5b58\u5728Secret\u4e2d\uff0c\u4e4b\u540e\u914d\u7f6eStorageClass\u4f7f\u7528\u8be5Secret\u5373\u53ef\u3002</p> <p>\u67e5\u770bclient.admin\u7684Key\uff1a <pre><code>$ ceph auth get-key client.admin\nAQA8HP9ezBHPDBAAdL+NteK0d1mjXZV47r4I7w==\n</code></pre></p> <p>\u521b\u5efaSecret\uff1a <pre><code>$ kubectl create secret generic csi-cephfs-secret \\\n--type=\"kubernetes.io/cephfs\" \\\n--from-literal=adminKey='AQA8HP9ezBHPDBAAdL+NteK0d1mjXZV47r4I7w==' \\\n--from-literal-adminID='admin' \\\n--namespace=ceph-csi-cephfs\n</code></pre> \u67e5\u770b\u5e76\u8bb0\u5f55\u96c6\u7fa4\u7684fsid\uff1a <pre><code>$ ceph fsid\n48ddd55b-28ce-43f3-92a8-d17d9ad2c0de\n</code></pre></p> <p>\u67e5\u770bCeph\u7684Monitors\u8282\u70b9\u4fe1\u606f\uff1a</p> <p><pre><code>$ ceph mon dump\n</code></pre> \u7ed3\u679c\u4e2d\u7684Monitor\u7684IP+6789\u7aef\u53e3\u5373\u4e3aCeph Monitor\u7684\u5730\u5740\uff0c\u4e4b\u540e\u9700\u8981\u5728StorageClass\u4f7f\u7528\u3002</p> <p>3\uff0e\u521b\u5efa\u6587\u4ef6\u5171\u4eab\u578bStorageClass</p> <p>\u521b\u5efa\u8fde\u63a5Ceph\u7684\u4fe1\u606f\uff0c\u5176\u4e2dclusterID\u662f\u4e0a\u8ff0\u67e5\u8be2\u7684fsid\uff0cmonitors\u662f\u4e0a\u8ff0\u67e5\u8be2\u7684Monitor\u5730\u5740\uff0csubvolumeGroup\u76f8\u5f53\u4e8e\u5b50\u76ee\u5f55\uff1a</p> <p>ceph-configmap.yaml</p> <pre><code>apiVersion: v1\nkind: ConfigMap\ndata:\nconfig.json: |-\n[\n{\n\"clusterID\": \"48ddd55b-28ce-43f3-92a8-d17d9ad2c0de\",\n\"monitors\": [\n\"xxx:6789\",\n\"xxx:6789\",\n\"xxx:6789\"\n],\n\"cephFS\": {\n\"subvolumeGroup\": \"cephfs-k8s-csi\"\n}\n}\n]\nmetadata:\nname: ceph-csi-config\n</code></pre> <pre><code>$ kubectl create -f ceph-configmap.yaml -n ceph-csi-cephfs\n</code></pre> <p>\u521b\u5efaStorageClass\uff1a</p> <p>cephfs-csi-sc.yaml</p> <pre><code>---\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\nname: csi-cephfs-sc\nprovisioner: cephfs.csi.ceph.com\nparameters:\nclusterID: 48ddd55b-28ce-43f3-92a8-d17d9ad2c0de fsName: sharefs\npool: sharefs-data0\n# The secrets have to contain user and/or Ceph admin credentials.\ncsi.storage.k8s.io/provisioner-secret-name: csi-cephfs-secret\ncsi.storage.k8s.io/provisioner-secret-namespace: ceph-csi-cephfs\ncsi.storage.k8s.io/controller-expand-secret-name: csi-cephfs-secret\ncsi.storage.k8s.io/controller-expand-secret-namespace: ceph-csi-cephfs\ncsi.storage.k8s.io/node-stage-secret-name: csi-cephfs-secret\ncsi.storage.k8s.io/node-stage-secret-namespace: ceph-csi-cephfs\n# (optional) The driver can use either ceph-fuse (fuse) or\n# ceph kernelclient (kernel).\n# If omitted, default volume mounter will be used - this is\n# determined by probing for ceph-fuse and mount.ceph\n# mounter: kernel\n# (optional) Prefix to use for naming subvolumes.\n# If omitted, defaults to \"csi-vol-\".\n# volumeNamePrefix: \"foo-bar-\"\nreclaimPolicy: Delete\nallowVolumeExpansion: true\nmountOptions:\n- debug\n</code></pre> <ul> <li>clusterID\uff1aCeph\u96c6\u7fa4\u7684fsid\u3002</li> <li>fsName\uff1aCeph\u6587\u4ef6\u7cfb\u7edf\u7684\u540d\u5b57\u3002</li> <li>pool\uff1aData Pool\u7684\u540d\u5b57\u3002</li> </ul> <p>csi.storage.k8s.io/provisioner-secret-name\uff1a\u8fde\u63a5\u4fe1\u606f\u7684Secret\uff0c\u5176\u4ed6\u7684\u7c7b\u4f3c\u3002</p> <ul> <li>reclaimPolicy\uff1a\u56de\u6536\u7b56\u7565\uff0c\u9ed8\u8ba4\u662f\u5220\u9664\u3002</li> <li>allowVolumeExpansion\uff1a\u5141\u8bb8\u6269\u5bb9\uff0c\u9700\u8981\u540e\u7aef\u5b58\u50a8\u652f\u6301\u3002</li> </ul> <p>\u521b\u5efaStorageClass\uff1a <pre><code>$ kubectl create -f cephfs-csi-sc.yaml\nstorageclass.storage.k8s.io/csi-cephfs-sc created\n</code></pre></p> <p>\u67e5\u770bStorageClass\uff1a <pre><code>$ kubectl get sc csi-cephfs-sc\n</code></pre></p> <p>4\uff0eCeph CSI\u9a8c\u8bc1 \u521b\u5efa\u4e00\u4e2aPVC\u6307\u5411\u8be5StorageClass\uff08storageClassName\u53c2\u6570\uff09\uff0c\u67e5\u770b\u4e00\u4e0b\u662f\u5426\u80fd\u6b63\u5e38\u521b\u5efaPV\uff1a</p> <p>vim pvc.yaml</p> <pre><code>---\nkind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\nname: cephfs-pvc-test-csi\nspec:\naccessModes:\n- ReadWriteMany\nstorageClassName: csi-cephfs-sc\nresources:\nrequests:\nstorage: 100Mi\n</code></pre> <p>test-pvc-dp.yaml</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nlabels:\napp: test-cephfs\nname: test-cephfs\nnamespace: default\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: test-cephfs\nstrategy:\nrollingUpdate:\nmaxSurge: 1\nmaxUnavailable: 0\ntype: RollingUpdate\ntemplate:\nmetadata:\nlabels:\napp: test-cephfs\nspec:\ncontainers:\n- command:\n- sh\n- -c\n- sleep 36000\nimage: registry.cn-beijing.aliyuncs.com/dotbalo/debug-tools\nname: test-cephfs\nvolumeMounts:\n- mountPath: /mnt\nname: cephfs-pvc-test\nvolumes:\n- name: cephfs-pvc-test\npersistentVolumeClaim:\nclaimName: cephfs-pvc-test-csi\n</code></pre> <p><pre><code>$ kubectl create -f pvc.yaml\n\n$ kubectl get pvc\n</code></pre> \u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6210\u529f\u521b\u5efa\u4e86\u4e00\u4e2a\u540d\u4e3apvc-9cad122e-632e-408e-bce1-69186ae71cb6\u7684PV\uff0c \u72b6\u6001\u4e5f\u53d8\u6210\u4e86Bound\uff0c\u4e4b\u540e\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2aPod\u8fdb\u884c\u6570\u636e\u8bfb\u5199\u6d4b\u8bd5\uff0c\u5c06PV\u6302\u8f7d\u5230/mnt\u76ee\u5f55\uff0c\u53ef\u4ee5\u6309\u9700\u4fee\u6539\uff1a</p> <p>test-pvc-dp.yaml</p> <p><pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nlabels:\napp: test-rbd\nname: test-rbd\nnamespace: default\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: test-rbd\nstrategy:\nrollingUpdate:\nmaxSurge: 1\nmaxUnavailable: 0\ntype: RollingUpdate\ntemplate:\nmetadata:\nlabels:\napp: test-rbd\nspec:\ncontainers:\n- command:\n- sh\n- -c\n- sleep 36000\nimage: registry.cn-beijing.aliyuncs.com/dotbalo/debug-tools\nname: test-rbd\nvolumeMounts:\n- mountPath: /mnt\nname: rbd-pvc-test\nvolumes:\n- name: rbd-pvc-test\npersistentVolumeClaim:\nclaimName: rbd-pvc-test-csi\n</code></pre> \u521b\u5efa\u8be5Deployment\uff1a <pre><code>$ kubectl apply -f test-pvc-dp.yaml\n$ kubectl get pod -l app=test-cephfs\n</code></pre> \u5728\u5176\u4e2d\u7684\u526f\u672c\u8fdb\u884c\u6570\u636e\u5199\u5165\uff1a <pre><code>$ kubectl exec test-cephfs-811238bfb7-splxx -- bash\n# echo \"hello, csi\" &gt; /mnt/test.txt \n# exit\n</code></pre></p> <p>\u5728\u53e6\u4e00\u4e2a\u526f\u672c\u4e2d\u67e5\u770b\u6570\u636e\uff1a <pre><code>$ kubectl exec test-cephfs-85f8f8bfb7-splxg -- cat /mnt/test.txt\nhello, csi\n</code></pre></p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#92-\u901a\u8fc7csi\u8fde\u63a5ceph-rbd","title":"9.2 \u901a\u8fc7CSI\u8fde\u63a5Ceph RBD","text":"<p>\u548cCephFS CSI\u7c7b\u4f3c\uff0c\u5b89\u88c5Ceph RBD CSI\u7684\u6b65\u9aa4\u51e0\u4e4e\u4e00\u6837\uff0c\u53ea\u662f\u5bf9\u5e94\u7684\u5b89\u88c5\u6587\u4ef6\u4e0d\u4e00\u6837 \uff0c </p> <p>RBD CSI\u7684\u6587\u6863\u53ef\u4ee5\u901a\u8fc7https://github.com/ceph/ceph-csi/blob/devel/docs/deploy-rbd.md\u67e5\u770b\uff0c  \u901a\u8fc7Helm\u5b89\u88c5\u6587\u6863\u5730\u5740 \uff1a https://github.com/ceph/ceph-csi/blob/devel/charts/ceph-csi-rbd/README.md\u3002</p> <p>1\uff0eCeph RBD\u9a71\u52a8\u5b89\u88c5</p> <p>\u540c\u6837\uff0c\u8be5Helm\u5305\u9ed8\u8ba4\u7684\u955c\u50cf\u5730\u5740\u4e5f\u662fgcr.io\uff0c\u7b14\u8005\u5df2\u7ecf\u4e3a\u8bfb\u8005\u540c\u6b65\u4e86\u76f8\u5173\u955c\u50cf\uff0c\u653e\u5728\u4e86\u672c\u5c0f\u8282\u7684install\u76ee\u5f55\uff0c\u53ef\u4ee5\u76f4\u63a5\u8fdb\u884c\u5b89\u88c5\uff08Helm\u5b89\u88c5\u53ef\u4ee5\u53c2 \u80038.9.1\u8282\uff09\uff1a</p> <pre><code>$ kubectl create namespace \"ceph-csi-rbd\"\nnamespace/ceph-csi-rbd created\n\n# \u6ce8\u610f\u547d\u4ee4\u6700\u540e\u7684\u4e00\u4e2a\u70b9\n$ helm install --namespace \"ceph-csi-rbd\" \"ceph-csi-rbd\" .\nNAME: ceph-csi-rbd\n...\nNOTES:\nExamples on how to configure a storage class and start using thedriver are here:\nhttps://github.com/ceph/ceph-csi/tree/v3.3.1/examples/rbd\n</code></pre> <p>\u67e5\u770bPod\u72b6\u6001 <pre><code>$ kubectl get po -n ceph-csi-rbd\n</code></pre></p> <p>2\uff0eCeph\u914d\u7f6e</p> <p>\u521b\u5efaCeph Pool\uff0c\u5982\u679c\u6709Pool\u7684\u8bdd\u53ef\u4ee5\u4e0d\u7528\u521b\u5efa\uff08\u5927\u5c0f\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u8fdb\u884c\u914d\u7f6e\uff09\uff1a</p> <pre><code>$ ceph osd pool create rbdfork8s 128\npool 'rbdfork8s' created\n</code></pre> <p>\u76f8\u5bf9\u4e8e\u7ba1\u7406\u5458\u7528\u6237\uff0cRBD\u53ef\u4ee5\u5355\u72ec\u6388\u6743\u4e00\u4e2a\u4f4e\u6743\u9650\u7684\u7528\u6237\u7ba1\u7406Pool\uff0c\u6bd4\u5982 \u521b\u5efa\u4e00\u4e2akube\u7528\u6237\uff0c\u5bf9osd\u6709\u67e5\u770b\u6743\u9650\uff0c\u5bf9rbdfork8s\u6709\u8bfb\u5199\u6743\u9650\uff08\u5177\u4f53\u6743\u9650 \u914d\u7f6e\u53ef\u4ee5\u53c2\u8003Ceph\u6587\u6863\uff09\uff1a</p> <pre><code>$ ceph auth add client.kube mon 'allow r' osd 'allow rwx pool=rbdfork8s'\nadded key for client.kube\n</code></pre> <p>\u521d\u59cb\u5316Pool\uff0c\u6ce8\u610f\u5982\u679c\u4e0d\u662f\u65b0\u5efa\u7684\u5c31\u4e0d\u7528\u521d\u59cb\u5316\uff1a <pre><code>$ ceph osd pool application enable rbdfork8s rbd\nenabled application 'rbd' on pool 'rbdfork8s'\n$ rbd pool init rbdfork8s\n</code></pre></p> <p>\u67e5\u770bclient.kube\u7684key\uff1a <pre><code>$ ceph auth get-key client.kube\nAQB/eopgaqSRJxAAYDs2gKTXSpcpY2m+yHJaJw==\n</code></pre></p> <p>\u521b\u5efaSecret\uff1a <pre><code>$ kubectl create secret generic csi-rbd-secret \\\n--type=\"kubernetes.io/rbd\" \\\n--from-literal=userKey=\"AQB/eopgaqSRJxAAYDs2gKTXSpcpY2m+yHJaJw==\" \\\n--from-literal=userID=\"kube\" \\\n--namespace=ceph-csi-rbd\n</code></pre></p> <p>\u67e5\u770b\u5e76\u8bb0\u5f55\u96c6\u7fa4\u7684fsid\uff1a <pre><code>$ ceph fsid\n48ddd55b-28ce-43f3-92a8-d17d9ad2c0de\n</code></pre></p> <p>\u67e5\u770bCeph\u7684Monitors\u8282\u70b9\u4fe1\u606f\uff1a <pre><code>$ ceph mon dump\n</code></pre></p> <p>\u7ed3\u679c\u4e2d\u7684Monitor\u7684IP+6789\u7aef\u53e3\u5373\u4e3aCeph Monitor\u7684\u5730\u5740\uff0c\u4e4b\u540e\u9700\u8981\u5728StorageClass\u4e2d\u4f7f\u7528\u3002</p> <p>3\uff0e\u521b\u5efaStorageClass</p> <p>\u521b\u5efaStorageClass\u548cCephFS\u7684\u7c7b\u4f3c\uff0c\u5177\u4f53\u7ec6\u8282\u53ef\u4ee5\u53c2\u8003CephFS CSI\u7684StorageClass\u914d\u7f6e\uff1a</p> <p>ceph-configmap.yaml</p> <p><pre><code>apiVersion: v1\nkind: ConfigMap\ndata:\nconfig.json: |-\n[\n{\n\"clusterID\": \"48ddd55b-28ce-43f3-92a8-d17d9ad2c0de\",\n\"monitors\": [\n\"xxx:6789\",\n\"xxx:6789\",\n\"xxx:6789\"\n],\n\"cephFS\": {\n\"subvolumeGroup\": \"cephrbd-k8s-csi\"\n}\n}\n]\nmetadata:\nname: ceph-csi-config\n</code></pre> <pre><code>$ kubectl create -f ceph-configmap.yaml -n ceph-csi-rbd\n</code></pre></p> <p>\u521b\u5efaStorageClass\uff1a</p> <p>rbd-csi-sc.yaml</p> <pre><code>---\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\nname: csi-rbd-sc\nprovisioner: rbd.csi.ceph.com\nparameters:\nclusterID: 48ddd55b-28ce-43f3-92a8-d17d9ad2c0de pool: rbdfork8s\nimageFeatures: layering\ncsi.storage.k8s.io/provisioner-secret-name: csi-rbd-secret\ncsi.storage.k8s.io/provisioner-secret-namespace: ceph-csi-rbd csi.storage.k8s.io/controller-expand-secret-name: csi-rbd-secret\ncsi.storage.k8s.io/controller-expand-secret-namespace: ceph-csi-rbd\ncsi.storage.k8s.io/node-stage-secret-name: csi-rbd-secret\ncsi.storage.k8s.io/node-stage-secret-namespace: ceph-csi-rbd\ncsi.storage.k8s.io/fstype: ext4\nreclaimPolicy: Delete\nallowVolumeExpansion: true\nmountOptions:\n- discard\n</code></pre> <p>4\uff0eCeph RBD\u9a8c\u8bc1</p> <p>\u521b\u5efaPVC\uff0c\u67e5\u770b\u662f\u5426\u80fd\u81ea\u52a8\u521b\u5efaPV\uff0c\u521b\u5efa\u7684\u914d\u7f6e\u548c\u4e4b\u524d\u5e76\u65e0\u592a\u5927\u533a\u522b\uff0c\u53ea\u662fstorageClassName\u6362\u6210\u4e86RBD\u7684StorageClass\u540d\u79f0\uff1a</p> <p>pvc.yaml <pre><code>---\nkind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\nname: rbd-pvc-test-csi\nspec:\naccessModes:\n- ReadWriteOnce\nstorageClassName: csi-rbd-sc\nresources:\nrequests:\nstorage: 100Mi\n</code></pre></p> <p>test-pvc-dp.yaml</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nlabels:\napp: test-rbd\nname: test-rbd\nnamespace: default\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: test-rbd\nstrategy:\nrollingUpdate:\nmaxSurge: 1\nmaxUnavailable: 0\ntype: RollingUpdate\ntemplate:\nmetadata:\nlabels:\napp: test-rbd\nspec:\ncontainers:\n- command:\n- sh\n- -c\n- sleep 36000\nimage: registry.cn-beijing.aliyuncs.com/dotbalo/debug-tools\nname: test-rbd\nvolumeMounts:\n- mountPath: /mnt\nname: rbd-pvc-test\nvolumes:\n- name: rbd-pvc-test\npersistentVolumeClaim:\nclaimName: rbd-pvc-test-csi\n</code></pre> <p>\u521b\u5efa\u8be5Deployment\uff1a</p> <p><pre><code>$ kubectl apply -f test-pvc-dp.yaml\n$ kubectl get pod -l app=test-cephfs\n</code></pre> \u5728\u5176\u4e2d\u7684\u526f\u672c\u8fdb\u884c\u6570\u636e\u5199\u5165\uff1a <pre><code>$ kubectl exec test-cephfs-811238bfb7-splxx -- bash\n# echo \"hello, csi rbd\" &gt; /mnt/test.txt \n# exit\n</code></pre></p> <p>\u5728\u53e6\u4e00\u4e2a\u526f\u672c\u4e2d\u67e5\u770b\u6570\u636e\uff1a <pre><code>$ kubectl exec test-cephfs-85f8f8bfb7-splxg -- cat /mnt/test.txt\nhello, csi rbd\n</code></pre></p> <p>K8S\u4f7f\u7528ceph-csi\u6301\u4e45\u5316\u5b58\u50a8\u4e4bRBD</p> <p>https://mp.weixin.qq.com/s?__biz=MzAxMjk0MTYzNw==&amp;mid=2247484067</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/#10-\u5c0f\u7ed3","title":"10. \u5c0f\u7ed3","text":"<p>\u672c\u7ae0\u4e3b\u8981\u8bb2\u89e3\u4e86Kubernetes\u5b58\u50a8\u7f16\u6392\u529f\u80fd\uff0c\u76ee\u524d\u5b58\u50a8\u7684\u65b9\u5411\u66f4\u504f\u5411\u4e8eCSI\u7684\u7ba1\u7406\u65b9\u5f0f\u3002</p> <p>\u6240\u4ee5\u8bfb\u8005\u60f3\u8981Kubernetes\u96c6\u7fa4\u63a5\u5165\u5b58\u50a8\u5e73\u53f0\uff0c\u9996\u9009\u7684\u65b9\u5f0f\u5e94\u8be5\u662fCSI\u3002</p> <p>\u76ee\u524d\u5927\u90e8\u5206\u5b58\u50a8\u5e73\u53f0\u7684\u4f9b\u5e94\u5546\u90fd\u63d0\u4f9b\u4e86CSI\u7684\u9a71\u52a8\uff0c\u8bfb\u8005\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\u4f7f\u7528\uff08\u9700\u8981\u5728GitHub\u6216\u8005\u5bf9\u5e94\u5b58\u50a8\u5e73\u53f0\u7684\u5b98\u65b9\u7f51\u7ad9\u8fdb\u884c\u67e5\u627e\uff09\uff0c CSI\u7684\u7ba1\u7406 \u65b9\u5f0f\u5927\u5927\u964d\u4f4e\u4e86\u5b58\u50a8\u7684\u590d\u6742\u5ea6\uff0c\u53ef\u4ee5\u66f4\u52a0\u65b9\u4fbf\u5730\u5b9e\u73b0\u5b58\u50a8\u7684\u7ba1\u7406\uff0c\u6bd4\u5982\u521b\u5efa \u5b58\u50a8\u3001\u5220\u9664\u3001\u6269\u5bb9\u3001\u5907\u4efd\u7b49\u3002</p> <p>\u76f8\u5bf9\u4e8e\u914d\u7f6e\u5206\u79bb\uff0c\u5b58\u50a8\u5206\u79bb\u4e5f\u662f\u4e91\u539f\u751f\u8bbe\u8ba1\u975e\u5e38\u91cd\u8981\u7684\u56e0\u7d20\uff0c\u5373\u6709\u72b6\u6001\u5e94\u7528\u65e0\u72b6\u6001\u5316\u2014\u2014\u628a\u5b58\u50a8\u4ea4\u7ed9\u8fdc\u7aef\u3002</p> <p>\u5728\u4e4b\u524d\u7684\u7a0b\u5e8f\u8bbe\u8ba1\u4e2d\uff0c\u53ef\u80fd\u4f1a\u628a\u4e00\u4e9b\u6570\u636e\u653e\u5728\u672c\u5730\u6216\u8005\u5185\u5b58\u4e2d\uff0c\u56e0\u4e3a\u4e4b\u524d\u7684\u90e8\u7f72\u65b9\u5f0f\u4e0d\u4f1a\u5177\u6709\u5f88\u5927\u7684\u53d8\u5316\uff0c\u6240\u4ee5\u8fd9\u79cd\u67b6\u6784\u4e0d\u4f1a\u6709\u5927\u7684\u95ee\u9898\u3002</p> <p>\u4f46\u662f\u73b0\u5728\u7684\u67b6\u6784\u5177\u6709\u5f88\u9ad8\u7684\u5f39\u6027\uff0c\u6211\u4eec\u5f80\u5f80\u5e76\u4e0d\u77e5\u9053\u670d\u52a1\u5230\u5e95\u90e8\u7f72\u5728\u4e86\u54ea\u53f0\u670d\u52a1\u5668\u3001\u54ea\u4e2a\u4f4d\u7f6e\uff0c\u6240\u4ee5\u4ecd\u65e7\u5c06\u7a0b\u5e8f\u7684\u6570\u636e\u653e\u7f6e\u4e8e\u672c\u5730\u548c\u5185\u5b58\u4e2d\u662f\u4e0d\u53ef\u53d6\u7684\u65b9\u5f0f\u3002</p> <p>\u5bf9\u4e8e\u6587\u4ef6\u578b\u5b58\u50a8\uff0c\u53ef\u4ee5\u4f7f\u7528\u5bf9\u8c61\u5b58\u50a8\u7684\u65b9\u5f0f\u5c06\u6587\u4ef6\u76f4\u63a5\u5b58\u50a8\u5728\u5bf9\u8c61\u5b58\u50a8\u5e73\u53f0\u4e0a\u3002</p> <p>\u5bf9\u4e8e\u7f13\u5b58\u6570\u636e\uff0c\u53ef\u4ee5\u4f7f\u7528\u7c7b\u4f3cRedis\u7684\u4e2d\u95f4\u4ef6\u8fdb\u884c\u5b58\u53d6\u3002</p> <p>\u8fd9\u6837\u7684\u8bdd\uff0c\u6211\u4eec\u7684\u7a0b\u5e8f\u5c06\u4f1a\u5f7b\u5e95\u53d8\u6210\u65e0\u72b6\u6001\u7684\u5f62\u5f0f\uff0c\u65e0\u8bba\u5982\u4f55\u90e8\u7f72\u3001\u91cd\u542f\u3001\u8fc1\u79fb\u90fd\u4e0d\u4f1a \u9020\u6210\u6570\u636e\u7684\u4e22\u5931\uff0c\u6240\u4ee5\u5728\u8bbe\u8ba1\u7a0b\u5e8f\u65f6\u4e5f\u8981\u6709\u6b64\u7c7b\u610f\u8bc6\uff0c\u5c06\u6709\u72b6\u6001\u8bbe\u8ba1\u53d8\u6210\u65e0\u72b6\u6001\u8bbe\u8ba1\u3002</p> <p>\u53c2\u8003\u6587\u732e\uff1a</p> <p>https://www.qikqiak.com/k8strain2/storage/ceph/</p> <p>https://imszz.com/p/4aa1a279/</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/","title":"Kubernetes\u9ad8\u7ea7\u8c03\u5ea6","text":"<p>\u5728\u524d\u9762\u7684\u7ae0\u8282\u5df2\u7ecf\u5b66\u4e60\u8fc7Kubernetes\u7684\u8c03\u5ea6\u57fa\u7840\uff0c\u5b9e\u73b0\u4e86\u5c06\u81ea\u5df1\u7684\u670d\u52a1\u90e8\u7f72\u5230Kubernetes\u3002\u4f46\u662f\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u8c03\u5ea6\u8fdc\u8fdc\u6bd4\u81ea\u5df1\u60f3\u8c61\u7684\u8981\u590d\u6742\u3002 \u6bd4\u5982\uff1a</p> <ul> <li>\u67d0\u4e9b\u7a0b\u5e8f\u53ea\u80fd\u90e8\u7f72\u5728\u56fa\u5b9a\u7684\u51e0\u53f0\u673a\u5668\u4e0a\u3002</li> <li>\u67d0\u4e9b\u673a\u5668\u53ea\u80fd\u90e8\u7f72\u6307\u5b9a\u7684Pod\u3002</li> <li>\u8282\u70b9\u6302\u4e86\u600e\u4e48\u5feb\u901f\u6062\u590d\u3002</li> <li>\u8282\u70b9\u6302\u4e86\u5982\u4f55\u8ba9\u5f71\u54cd\u5ea6\u6700\u5c0f\u3002</li> <li>\u5728\u7ebfDebug\u6ca1\u6709\u547d\u4ee4\u600e\u4e48\u529e\u3002</li> </ul> <p>\u4e0a\u8ff0\u53ea\u662f\u5217\u4e3e\u4e86\u4e00\u4e9b\u9700\u6c42\uff0c\u771f\u5b9e\u7684\u60c5\u51b5\u53ef\u80fd\u66f4\u4e3a\u590d\u6742\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u66f4 \u9ad8\u7ea7\u7684\u8c03\u5ea6\u65b9\u5f0f\u3001\u66f4\u5b9e\u7528\u7684\u529f\u80fd\u6765\u89e3\u51b3\u4e0a\u8ff0\u95ee\u9898\u3002</p> <p>\u5e78\u8fd0\u7684\u662f\uff0cKubernetes\u539f\u751f\u7684\u5f88\u591a\u529f\u80fd\u5747\u80fd\u89e3\u51b3\u4e0a\u8ff0\u95ee\u9898\uff0c\u672c\u7ae0\u6211\u4eec\u5c31\u6765\u5b66\u4e60Kubernetes\u66f4\u9ad8\u7ea7\u7684\u8c03\u5ea6\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/#1-\u521d\u59cb\u5316\u5bb9\u5668initcontainer","title":"1. \u521d\u59cb\u5316\u5bb9\u5668InitContainer","text":"<p>InitContainer\u662fKubernetes\u7684\u521d\u59cb\u5316\u5bb9\u5668\uff08\u4e5f\u53ef\u79f0\u4e4b\u4e3aInit\u5bb9\u5668\uff09\uff0c\u5b83\u662f\u4e00\u79cd\u7279\u6b8a\u7684\u5bb9\u5668\uff0c\u5728Pod\u5185\u7684\u5e94\u7528\u5bb9\u5668\u542f\u52a8\u4e4b\u524d\u8fd0\u884c\uff0c\u53ef\u4ee5\u5305\u62ec\u4e00\u4e9b\u5e94\u7528\u955c\u50cf\u4e2d\u4e0d\u5b58\u5728\u7684\u5b9e\u7528\u5de5\u5177\u548c\u5b89\u88c5\u811a\u672c\uff0c\u7528\u4ee5\u5728\u7a0b\u5e8f\u542f\u52a8\u65f6\u8fdb\u884c\u521d\u59cb\u5316\uff0c\u6bd4\u5982\u521b \u5efa\u6587\u4ef6\u3001\u4fee\u6539\u5185\u6838\u53c2\u6570\u3001\u7b49\u5f85\u4f9d\u8d56\u7a0b\u5e8f\u542f\u52a8\u7b49\u3002</p> <p>\u6bcf\u4e2aPod\u4e2d\u53ef\u4ee5\u5305\u542b\u591a\u4e2a\u5bb9\u5668\uff0c\u540c\u65f6Pod\u4e5f\u53ef\u4ee5\u6709\u4e00\u4e2a\u6216\u591a\u4e2a\u5148\u4e8e\u5e94\u7528\u5bb9\u5668\u542f\u52a8\u7684Init\u5bb9\u5668\uff0c\u5728Pod\u5b9a\u4e49\u4e2d\u548ccontainers\u540c\u7ea7\uff0c\u6309\u987a\u5e8f\u9010\u4e2a\u6267\u884c\uff0c \u5f53\u6240\u6709\u7684Init\u5bb9\u5668\u8fd0\u884c\u5b8c\u6210\u65f6\uff0cKubernetes\u624d\u4f1a\u542f\u52a8Pod\u5185\u7684\u666e\u901a\u5bb9\u5668\u3002</p> <p>Init\u5bb9\u5668\u4e0e\u666e\u901a\u7684\u5bb9\u5668\u975e\u5e38\u50cf\uff0c\u9664\u4e86\u5982\u4e0b\u51e0\u70b9\uff1a</p> <ul> <li> <p>\u5b83\u4eec\u603b\u662f\u8fd0\u884c\u5230\u5b8c\u6210\u3002</p> </li> <li> <p>\u4e0a\u4e00\u4e2a\u8fd0\u884c\u5b8c\u6210\u624d\u4f1a\u8fd0\u884c\u4e0b\u4e00\u4e2a\u3002</p> </li> <li> <p>\u5982\u679cPod\u7684Init\u5bb9\u5668\u5931\u8d25\uff0cKubernetes\u4f1a\u4e0d\u65ad\u5730\u91cd\u542f\u8be5Pod\uff0c\u76f4\u5230Init\u5bb9\u5668\u6210\u529f\u4e3a\u6b62 \uff0c \u4f46\u662fPod\u5bf9\u5e94\u7684restartPolicy\u503c\u4e3aNever\uff0c Kubernetes\u4e0d\u4f1a\u91cd\u65b0\u542f\u52a8Pod\u3002</p> </li> </ul> <p>\u4e3aPod\u8bbe\u7f6eInit\u5bb9\u5668\u9700\u8981\u5728Pod\u7684spec\u4e2d\u6dfb\u52a0initContainers\u5b57\u6bb5\uff0c\u8be5\u5b57 \u6bb5\u548c\u5e94\u7528\u7684containers\u6570\u7ec4\u540c\u7ea7\u76f8\u90bb\uff0c\u914d\u7f6e\u65b9\u5f0f\u548ccontainers\u4e2d\u7684\u666e\u901a\u5bb9\u5668 \u5dee\u4e0d\u591a\uff0cInit\u5bb9\u5668\u652f\u6301\u5e94\u7528\u5bb9\u5668\u7684\u5168\u90e8\u5b57\u6bb5\u548c\u7279\u6027\uff0c\u5305\u62ec\u8d44\u6e90\u9650\u5236\u3001\u6570\u636e\u5377 \u548c\u5b89\u5168\u8bbe\u7f6e\u3002</p> <p>\u4f46\u662fInit\u5bb9\u5668\u5bf9\u8d44\u6e90\u8bf7\u6c42\u548c\u9650\u5236\u7684\u5904\u7406\u7a0d\u6709\u4e0d\u540c\uff0cInit\u5bb9\u5668\u4e0d\u652f\u6301lifecycle\u3001livenessProbe\u3001readinessProbe\u548cstartupProbe\uff0c\u56e0\u4e3a\u5b83 \u4eec\u5fc5\u987b\u5728Pod\u5c31\u7eea\u4e4b\u524d\u8fd0\u884c\u5b8c\u6210\u3002</p> <p>\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u4e3a\u4e86\u5e94\u7528\u7684\u5b89\u5168\u548c\u4f18\u5316\u955c\u50cf\u7684\u4f53\u79ef\uff0c\u4e1a\u52a1\u955c\u50cf\u4e00\u822c\u4e0d\u4f1a \u5b89\u88c5\u9ad8\u5371\u5de5\u5177\u548c\u5e76\u4e0d\u5e38\u7528\u7684\u8fd0\u7ef4\u5de5\u5177\uff0c\u6bd4\u5982curl\u3001sed\u3001awk\u3001python\u6216dig\u7b49\uff0c\u540c\u65f6\u5efa\u8bae\u4f7f\u7528\u975eroot\u7528\u6237\u53bb\u542f\u52a8\u5bb9\u5668\u3002</p> <p>\u4f46\u662f\u67d0\u4e9b\u5e94\u7528\u542f\u52a8\u4e4b\u524d\u53ef\u80fd\u9700\u8981\u68c0\u6d4b\u4f9d\u8d56\u7684\u670d\u52a1\u6709\u6ca1\u6709\u6210\u529f\u8fd0\u884c\uff0c\u6216\u8005\u9700\u8981\u9ad8\u6743\u9650\u53bb\u4fee\u6539\u4e00\u4e9b\u7cfb\u7edf\u7ea7\u914d\u7f6e\uff0c \u800c\u8fd9\u4e9b\u68c0\u6d4b\u6216\u914d\u7f6e\u66f4\u6539\u90fd\u662f\u4e00\u6b21\u6027\u7684\uff0c\u6240\u4ee5\u5728\u5236\u4f5c\u4e1a\u52a1\u955c\u50cf\u65f6\u6ca1\u6709\u5fc5\u8981\u4e3a\u4e86\u4e00\u6b21\u914d\u7f6e\u7684\u53d8\u66f4\u53bb\u5b89\u88c5\u4e00\u4e2a\u914d\u7f6e\u5de5\u5177\uff0c\u66f4\u6ca1\u6709\u5fc5\u8981\u56e0\u4e3a\u4f7f\u7528\u4e00\u6b21\u9ad8\u6743\u9650\u800c\u628a\u6574\u4e2a\u955c\u50cf\u6539\u6210\u4ee5root\u8eab\u4efd\u8fd0\u884c\u3002</p> <p>\u8003\u8651\u5230\u4e0a\u8ff0\u95ee\u9898\u548c\u9700\u6c42\uff0cKubernetes\u5f15\u5165\u4e86\u521d\u59cb\u5316\u5bb9\u5668\u7684\u6982\u5ff5\uff0cInit\u5bb9\u5668\u5177\u6709\u4e0e\u5e94\u7528\u5bb9\u5668\u5206\u79bb\u7684\u5355\u72ec\u955c\u50cf\uff0c\u5176\u542f\u52a8\u76f8\u5173\u4ee3\u7801\u5177\u6709\u5982\u4e0b\u4f18\u52bf\uff1a</p> <ul> <li>Init\u5bb9\u5668\u53ef\u4ee5\u5305\u542b\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u5e94\u7528\u5bb9\u5668\u4e2d\u4e0d\u5b58\u5728\u7684\u5b9e\u7528\u5de5\u5177\u6216\u4e2a\u6027\u5316\u4ee3\u7801\u3002</li> <li>Init\u5bb9\u5668\u53ef\u4ee5\u5b89\u5168\u5730\u8fd0\u884c\u8fd9\u4e9b\u5de5\u5177\uff0c\u907f\u514d\u8fd9\u4e9b\u5de5\u5177\u5bfc\u81f4\u5e94\u7528\u955c\u50cf\u7684\u5b89\u5168\u6027\u964d\u4f4e\u3002</li> <li>Init\u5bb9\u5668\u53ef\u4ee5\u4ee5root\u8eab\u4efd\u8fd0\u884c\uff0c\u6267\u884c\u4e00\u4e9b\u9ad8\u6743\u9650\u547d\u4ee4\u3002</li> <li>Init\u5bb9\u5668\u76f8\u5173\u64cd\u4f5c\u6267\u884c\u5b8c\u6210\u540e\u5c31\u4f1a\u9000\u51fa\uff0c\u4e0d\u4f1a\u7ed9\u4e1a\u52a1\u5bb9\u5668\u5e26\u6765\u5b89\u5168\u9690\u60a3\u3002</li> </ul> <p>\u7531\u4e8eInit\u5bb9\u5668\u5fc5\u987b\u5728\u5e94\u7528\u5bb9\u5668\u542f\u52a8\u4e4b\u524d\u8fd0\u884c\u5b8c\u6210\uff0c\u56e0\u6b64Init\u5bb9\u5668\u63d0\u4f9b\u4e86\u4e00\u79cd\u673a\u5236\u6765\u963b\u585e\u6216\u5ef6\u8fdf\u5e94\u7528\u5bb9\u5668\u7684\u542f\u52a8\uff0c\u76f4\u5230\u6ee1\u8db3\u4e00\u7ec4\u5148\u51b3\u6761\u4ef6\uff0cPod\u5185\u7684\u6240\u6709\u5e94\u7528\u5bb9\u5668\u624d\u4f1a\u5e76\u884c\u542f\u52a8\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/#11-\u793a\u4f8b1\u7b49\u5f85\u4f9d\u8d56\u670d\u52a1\u542f\u52a8","title":"1.1 \u793a\u4f8b1\uff1a\u7b49\u5f85\u4f9d\u8d56\u670d\u52a1\u542f\u52a8","text":"<p>\u6709\u65f6\u67d0\u4e9b\u670d\u52a1\u9700\u8981\u4f9d\u8d56\u5176\u4ed6\u7ec4\u4ef6\u624d\u80fd\u542f\u52a8\uff0c\u6bd4\u5982\u540e\u7aef\u5e94\u7528\u9700\u8981\u6570\u636e\u5e93\u542f\u52a8\u4e4b\u540e\uff0c\u5e94\u7528\u624d\u80fd\u6b63\u5e38\u542f\u52a8\uff0c\u6240\u4ee5\u6b64\u65f6\u9700\u8981\u68c0\u6d4b\u6570\u636e\u5e93\u5b9e\u4f8b\u662f\u5426\u6b63\u5e38\uff0c \u5f85\u6570\u636e\u5e93\u53ef\u4ee5\u6b63\u5e38\u4f7f\u7528\u65f6\uff0c\u518d\u542f\u52a8\u540e\u7aef\u5e94\u7528\uff0c\u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528\u521d\u59cb\u5316\u5bb9\u5668\u8fdb\u884c\u63a7\u5236\uff0c\u5bf9\u5e94\u7684YAML\u6587\u4ef6\u5982\u4e0b\uff08\u90e8\u5206\u4ee3\u7801\uff09\uff1a <pre><code>apiVersion: apps/v1beta1\nkind: Deployment\nmetadata:\nname: init-test\nspec:\nreplicas: 1\ntemplate:\nmetadata:\nlabels:\napp: init\nspec:\ncontainers:\n- name: nginx-init\nimage: nginx:1.7.9\nports:\n- containerPort: 80\ninitContainers:\n- name: init-mydb\nimage: busybox\ncommand: ['sh', '-c', 'until nslookup mysql; do echo waiting for mysql; sleep 2; done;']\nrestartPolicy: Always\n</code></pre> \u4e0a\u9762\u7684\u793a\u4f8b\u662f\u6253\u7b97\u542f\u52a8\u4e00\u4e2aNginx\u670d\u52a1\uff0c\u5728\u542f\u52a8\u670d\u52a1\u4e4b\u524d\u6765\u5224\u65adMySQL\u7684\u670d\u52a1\u662f\u5426\u542f\u52a8\u3002\u901a\u8fc7nslookup\u68c0\u6d4bmysql\u670d\u52a1\u662f\u5426\u6210\u529f\u542f\u52a8\u3002\u5982\u679cmysql\u670d\u52a1\u542f\u52a8\u4e86\u4e4b\u540e\uff0cnslookup \u68c0\u6d4b\u57df\u540d\u4e5f\u4f1a\u6210\u529f\uff0c\u540e\u7eed\u4f1a\u542f\u52a8Nginx\u5bb9\u5668\uff1b</p> <p>\u5426\u5219\uff0c\u5c06\u4f1a\u7b49\u5f85\u4e24\u79d2\u4e4b\u540e\uff0c\u518d\u6b21\u68c0\u6d4b\u3002</p> <p>\u4f46\u662f\uff0c\u8fd9\u79cd\u65b9\u5f0f\u6211\u5728\u4f7f\u7528\u8fc7\u7a0b\u4e2d\uff0c\u5e76\u6ca1\u6709\u6210\u529f\u3002\u6211\u7684\u73af\u5883\u662f\u4e3amysql\u914d\u7f6e\u4e86Deploy\u548cService\uff0c\u5728\u5173\u95edpod\u7684\u60c5\u51b5\u4e0b\u901a\u8fc7nslookup\u6765\u68c0\u6d4b\u57df\u540d\u8fd8\u662f\u53ef\u4ee5\u6210\u529f\u3002</p> <p>\u540e\u9762\u6211\u76f4\u63a5\u4f7f\u7528curl\u6765\u5224\u65ad\u7aef\u53e3\u670d\u52a1\u662f\u5426\u53ef\u7528\u3002 <pre><code>apiVersion: apps/v1beta1\nkind: Deployment\nmetadata:\nname: init-test\nspec:\nreplicas: 1\ntemplate:\nmetadata:\nlabels:\napp: init\nspec:\ncontainers:\n- name: nginx-init\nimage: nginx:1.7.9\nports:\n- containerPort: 80\ninitContainers:\n- name: init-mydb\nimage: curlimages/curl:7.68.0\ncommand: ['sh', '-c', 'until curl 192.168.10.254:6379;; do echo waiting for mysql; sleep 2; done;']\nrestartPolicy: Always\n</code></pre></p> <p>Init container\u5bb9\u5668\u4e2d\u4f7f\u7528curl\u955c\u50cf\uff0c\u547d\u4ee4\u901a\u8fc7curl + \u670d\u52a1\u5730\u5740,\u670d\u52a1\u5730\u5740\u5c31\u662f\u4f60\u7684MySQL\u670d\u52a1\u5730\u5740\uff0c\u76f4\u63a5\u6765\u5224\u65ad\u670d\u52a1\u662f\u5426\u53ef\u7528\u6b63\u5e38\u4f7f\u7528\u3002</p> <p>\u5f53MySQL\u670d\u52a1\u6ca1\u6709\u6b63\u5e38\u542f\u52a8\u65f6\uff0c\u9519\u8bef\u4fe1\u606f\uff1a <pre><code>curl: (7) Failed to connect to 192.168.10.254 port 6379: Connection refused\uff0cinit container\n</code></pre> \u4f1a\u4e00\u76f4\u5faa\u73af\u68c0\u6d4b\u3002</p> <p>\u5230\u670d\u52a1\u6b63\u5e38\u542f\u52a8\u4e4b\u540e\uff0c <pre><code>It looks like you are trying to access mysql over HTTP on the native driver port.\n</code></pre> \u4e4b\u540e\u670d\u52a1\u5c31\u53ef\u4ee5\u6b63\u5e38\u542f\u52a8\u4e86\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/#12-\u793a\u4f8b2\u670d\u52a1\u6ce8\u518c","title":"1.2 \u793a\u4f8b2\uff1a\u670d\u52a1\u6ce8\u518c","text":"<p>\u6ce8\u518c\u8fd9\u4e2aPod\u7684IP\u5230\u8fdc\u7a0b\u670d\u52a1\u5668\uff0c\u901a\u8fc7\u5728\u547d\u4ee4\u4e2d\u8c03\u7528API\uff0c\u7c7b\u4f3c\u5982\u4e0b\uff08\u90e8\u5206\u4ee3\u7801\uff09\uff1a <pre><code>      initContainers:\n- command:\n- sh - -c - |\ncurl -X POST http://$MANAGEMENT_SERVICE_HOST: $MANAGEMENT_SERVICE_PORT/REGISTER \\\n-d 'instance=$(&lt;POD_NAME&gt;)&amp;ip=$(&lt;POD_IP&gt;)'\nenv:\n- name: TZ\nvalue: Asia/Shanghai\n- name: LANG\nvalue: C.UTF-8\nimage: curl\nimagePullPolicy: Always\nname: init_curl restartPolicy: Always\n</code></pre></p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/#13-\u793a\u4f8b3\u514b\u9686git\u4ee3\u7801\u5230\u5bb9\u5668\u4e2d","title":"1.3 \u793a\u4f8b3\uff1a\u514b\u9686Git\u4ee3\u7801\u5230\u5bb9\u5668\u4e2d","text":"<pre><code>     initContainers:\n- command:\n- sh - -c - |\ngit clone https://github.com/dotbalo/kubenetes-guide.git\nenv:\n- name: TZ\nvalue: Asia/Shanghai\n- name: LANG\nvalue: C.UTF-8\nimage: alpine/git:latest\nimagePullPolicy: Always\nname: init_git\nrestartPolicy: Always\n</code></pre>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/#14-\u793a\u4f8b4\u591a\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\u4f7f\u7528","title":"1.4 \u793a\u4f8b4\uff1a\u591a\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\u4f7f\u7528","text":"<p>\u5982\u524d\u9762\u6240\u8ff0\uff0c\u4e00\u4e2aPod\u4e2d\u53ef\u4ee5\u8fd0\u884c\u591a\u4e2aInit\u5bb9\u5668\u3002\u6bd4\u5982\u4e00\u4e2a\u5e94\u7528\u9700\u8981\u7b49\u5f85\u8be5\u5e94\u7528\u6240\u5728Namespace\u7684\u4e00\u4e2aService\u5bf9\u5e94\u7684Pod\u542f\u52a8\uff0c\u4e5f\u9700\u8981\u4e00\u4e2aDB\u7684 Service\u542f\u52a8\uff0c\u5f53\u4e24\u4e2aInitContainer\u90fd\u6210\u529f\u540e\uff0c\u624d\u53ef\u4ee5\u542f\u52a8\u4e1a\u52a1\u5e94\u7528\u5bb9\u5668\uff0c \u6b64\u65f6\u53ef\u4ee5\u53c2\u8003\u5982\u4e0b\u914d\u7f6e\uff1a <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: myapp-pod\nlabels:\napp: myapp\nspec:\ncontainers:\n# \u4e1a\u52a1\u5e94\u7528\u5bb9\u5668\n- name: myapp-container\nimage: busybox:1.28\ncommand: ['sh', '-c', 'echo The app is running! &amp;&amp; sleep 3600']\n# \u521d\u59cb\u5316\u5bb9\u5668\u5217\u8868\ninitContainers:\n# \u7b2c\u4e00\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\uff0c\u7b49\u5f85\u5f53\u524dNamespace\u4e0b\u7684myservice\u542f\u52a8\n- name: init-myservice\nimage: busybox:1.28\ncommand: ['sh', '-c', \"until nslookup myservice.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for myservice; sleep 2; done\"]\n# \u7b2c\u4e8c\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\uff0c\u7b49\u5f85DB\u7684Service\u542f\u52a8\n- name: init-mydb\nimage: busybox:1.28\ncommand: ['sh', '-c', \"until nslookup mydb.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for mydb; sleep 2; done\"]\n</code></pre></p> <p>\u6b64\u65f6\u53ef\u4ee5\u67e5\u770b\u8be5Pod\u7684\u521d\u59cb\u5316\u5bb9\u5668\u7684\u65e5\u5fd7\uff1a <pre><code># \u67e5\u770b\u7b2c\u4e00\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\n$ kubectl logs myapp-container -c init-myservice  # \u67e5\u770b\u7b2c\u4e8c\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\n$ kubectl logs myapp-container -c init-mydb\n</code></pre></p> <p>\u6b64\u65f6Init\u5bb9\u5668\u5c06\u4f1a\u4e00\u76f4\u7b49\u5f85mydb\u548cmyservice\u7684Service\u53ef\u7528\u3002\u5f53mydb\u548cmyservice\u53ef\u7528\u540e\uff0cmy-app\u7684Pod\u8fdb\u5165Running\u72b6\u6001\uff1a <pre><code>$ kubectl get -f myapp.yaml\n</code></pre></p> <p>\u5176\u4ed6\u793a\u4f8b\uff08\u5982sleep\u6307\u5b9a\u7684\u65f6\u95f4\u3001\u6839\u636e\u5f53\u524dPod\u73af\u5883\u53d8\u91cf\u4f7f\u7528jinja\u751f\u6210\u914d \u7f6e\u6587\u4ef6\uff09\u5728\u6b64\u4e0d\u518d\u6f14\u793a\uff0c\u53ea\u9700\u8981\u627e\u5230\u5bf9\u5e94\u7684\u955c\u50cf\uff0c\u4e4b\u540e\u66f4\u6539\u6267\u884c\u547d\u4ee4\u5373\u53ef\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/#2-\u4e34\u65f6\u5bb9\u5668ephemeral-containers","title":"2. \u4e34\u65f6\u5bb9\u5668Ephemeral Containers","text":"<p>\u4e34\u65f6\u5bb9\u5668\u529f\u80fd\u5728Kubernetes 1.16 \u540e\u7684\u7248\u672c\u624d\u53ef\u4ee5\u4f7f\u7528\uff0c\u5e76\u4e14\u57281.16~1.18\u7248\u672c\u548c1.18+\u7248\u672c\u7684\u4f7f\u7528\u65b9\u6cd5\u4e0d\u592a\u4e00\u81f4\uff0c\u4f7f\u7528\u65f6\u9700\u8981\u591a\u52a0\u6ce8\u610f\u3002</p> <p>\uff081\uff09\u57281.16~1.18\u7248\u672c\u4e2d\u4e34\u65f6\u5bb9\u5668\u7684\u4f7f\u7528\u65b9\u6cd5</p> <p>\u4e34\u65f6\u5bb9\u5668\u662f\u4f7f\u7528Pod\u7684ephemeralcontainers\u5b50\u8d44\u6e90\u521b\u5efa\u7684\uff0c \u53ef\u4ee5\u4f7f\u7528kubectl --raw\u5411\u4e00\u4e2a\u6b63\u5728\u8fd0\u884c\u7684Pod\u6ce8\u5165\u4e00\u4e2a\u4e34\u65f6\u5bb9\u5668\uff0c\u5047\u5982\u5411kube-system\u547d\u540d\u7a7a\u95f4\u4e0b\u7684metrics-server\u5bb9\u5668\u6dfb\u52a0\u4e00\u4e2abusybox\u7684\u4e34\u65f6\u5bb9\u5668\u3002</p> <p>\u9996\u5148\u67e5\u770bmetrics-server\u7684Pod\u540d\u79f0\uff1a <pre><code>$ kubectl get pod -n kube-system -l k8s-app=metrics-server\n</code></pre></p> <p>\u63a5\u7740\u521b\u5efa\u4e00\u4e2aec.json\u6587\u4ef6\uff0c\u58f0\u660e\u4e34\u65f6\u5bb9\u5668\u7684\u914d\u7f6e\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a <pre><code>{\n\"apiVersion\": \"v1\",\n\"kind\":\"EphemeralContainers\",\n\"metadata\":{\"name\": \"metrics-server-89786cd84-t9dwm\"},\n\"ephemeralContainers\": [{\n\"command\": [\n\"sh\"\n],\n\"image\": \"busybox\",\n\"imagePullPolicy\": \"IfNotPresent\",\n\"name\":\"debugger\",\n\"stdin\": true,\n\"tty\":true,\n\"terminationMessagePolicy\": \"File\"\n}]\n}\n</code></pre> \u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\uff1a</p> <ul> <li>metadata.name\uff1a\u88ab\u6ce8\u5165\u5bb9\u5668\u7684\u540d\u5b57\u3002</li> <li>ephemeralContainers[].image\uff1a\u4e34\u65f6\u5bb9\u5668\u4f7f\u7528\u7684\u955c\u50cf\u3002</li> <li>ephemeralContainers[].name\uff1a\u4e34\u65f6\u5bb9\u5668\u7684\u540d\u79f0\u3002</li> </ul> <p>\u4e4b\u540e\u4f7f\u7528kubectl replace --raw\u547d\u4ee4\u66f4\u65b0\u5df2\u8fd0\u884c\u7684\u4e34\u65f6\u5bb9\u5668metrics-server-89786cd84-t9dwm\uff1a</p> <pre><code>$ kubectl replace --raw /api/v1/namespaces/kube-system/pods/ metrics-server-89786cd84-t9dwm/ephemeralcontainers -f ec.json\n</code></pre> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0bexec\u6216\u8005attach\u547d\u4ee4\u8fde\u63a5\u65b0\u7684\u4e34\u65f6\u5bb9\u5668\uff08-c\u6307\u5b9a\u4e3a\u4e34\u65f6\u5bb9\u5668\u7684\u540d\u79f0\uff09\uff1a</p> <pre><code>$ kubectl attach -it metrics-server-89786cd84-t9dwm -n kube- system -c debugger\n</code></pre> <p>\u5982\u679c\u542f\u7528\u4e86\u8fdb\u7a0b\u547d\u540d\u7a7a\u95f4\u5171\u4eab\uff0c\u5219\u53ef\u4ee5\u5728\u4e34\u65f6\u5bb9\u5668\u4e2d\u67e5\u770b\u8be5Pod\u6240\u6709\u5bb9\u5668\u4e2d\u7684\u8fdb\u7a0b\u3002</p> <p>\u4f8b\u5982\uff0c\u8fd0\u884c\u4e0a\u8ff0attach\u64cd\u4f5c\u540e\uff0c\u5728\u8c03\u8bd5\u5668\u5bb9\u5668\u65f6\u8fdb\u884cps\u548cnetstat\u64cd\u4f5c\uff1a</p> <pre><code>$ ps aux\n\n$ netstat -lntp\n</code></pre> <p>\u5728\u4e34\u65f6\u5bb9\u5668busybox\u4e2d\u6267\u884cps aux\u80fd\u770b\u5230\u5176\u4ed6\u5bb9\u5668\u7684\u8fdb\u7a0b\uff0c\u6267\u884cnetstat\u4e5f\u80fd\u770b\u5230Pod\u4e2d\u6240\u6709\u5bb9\u5668\u7684\u542f\u52a8\u7aef\u53e3\u53f7\uff0c\u53ef\u4ee5\u770b\u5230\u5728\u4e1a\u52a1\u5bb9\u5668\u6ca1\u6709\u57fa\u672c\u5de5\u5177\u7684\u524d\u63d0\u4e0b\uff0c\u4f7f\u7528\u4e34\u65f6\u5bb9\u5668\u5927\u5927\u63d0\u9ad8\u4e86\u6392\u67e5\u6545\u969c\u7684\u6548\u7387\u3002</p> <p>\uff082\uff09\u57281.18+\u7248\u672c\u4e2d\u4e34\u65f6\u5bb9\u5668\u7684\u4f7f\u7528\u65b9\u6cd5  Kubernetes\u7248\u672c\u4f4e\u4e8e1.18\u65f6\uff0c\u4f7f\u7528\u4e34\u65f6\u5bb9\u5668\u5728\u7ebfDebug\u7684\u8fc7\u7a0b\u8fd8\u662f\u6bd4\u8f83\u9ebb\u70e6\u7684\uff0c\u57281.18\u7248\u672c\u4e4b\u540e\uff08\u5305\u62ec1.18),\u4f7f\u7528\u4e34\u65f6\u5bb9\u5668\u5728\u7ebfDebug\u5c31\u76f8\u5bf9\u7b80\u5355\u4e86\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528kubectl alpha debug\u8fdb\u884c\u8c03\u8bd5\uff0c\u6bd4\u5982\u4e0a\u8ff0\u64cd\u4f5c\u53ef\u4ee5\u7528\u4e00\u6761\u547d\u4ee4\u4ee3\u66ff\uff1a</p> <pre><code>$ kubectl -n kube-system alpha debug metrics-server-89786cd84- t9dwm -i --image=busybox\n</code></pre> <p>\u6ce8\u610f</p> <p>1.18\u7248\u672c\u4e5f\u9700\u8981\u5f00\u542f\u4e34\u65f6\u5bb9\u5668\u529f\u80fd\u30021.19\u4ee5\u4e0a\u7248\u672ckubectl\u547d\u4ee4\u4e0d\u7528\u518d\u52a0alpha\u5b57\u6bb5\u3002</p> <p>\u4f7f\u7528\u4e34\u65f6\u8c03\u8bd5\u5bb9\u5668\u6765\u8fdb\u884c\u8c03\u8bd5</p> <p>https://kubernetes.io/zh-cn/docs/tasks/debug/debug-application/debug-running-pod/#ephemeral-container</p> <p>Kubernetes\u4e2d\u4f7f\u7528\u4e34\u65f6\u5bb9\u5668\u8fdb\u884c\u6545\u969c\u6392\u67e5\u7684\u65b9\u6cd5</p> <p>https://www.zhangshengrong.com/p/OQNzr70eNR/</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/#3-\u81ea\u52a8\u6269\u7f29\u5bb9hpa","title":"3. \u81ea\u52a8\u6269\u7f29\u5bb9HPA","text":"<p>\u5728\u96c6\u7fa4\u5b89\u88c5\u7684\u7b2c1\u30012\u7ae0\uff0c\u6211\u4eec\u5b89\u88c5\u4e86\u4e00\u4e2a\u53ebMetrics Server\u7684\u7ec4\u4ef6\uff0c\u8be5\u7ec4\u4ef6\u5728\u96c6\u7fa4\u4e2d\u8d1f\u8d23\u91c7\u96c6Pod\u548cNode\u7684\u5ea6\u91cf\u6307\u6807\uff0c \u6bd4\u5982Pod\u7684CPU\u3001\u5185\u5b58\u4f7f\u7528\u7387\u548c\u8282\u70b9\u7684\u5185\u5b58\u3001CPU\u4f7f\u7528\u7387\uff0c\u800c\u4e14\u5b89\u88c5\u7684Dashboard\u53ef\u4ee5\u5c55\u793aCPU\u3001\u5185\u5b58\u4fe1\u606f\u4e5f\u662f \u4f9d\u9760Metrics Server\u7684\u3002</p> <p>\u5f53\u7136\uff0c\u8be5\u7ec4\u4ef6\u4e0d\u4ec5\u4ec5\u662f\u7528\u6765\u5c55\u793a\u6570\u636e\u7684\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528Metrics Server\u63d0\u4f9b\u7684\u6570\u636e\u7ed3\u5408Kubernetes\u7684HPA\u529f\u80fd\u5b9e\u73b0Pod\u7684\u81ea\u52a8\u6269\u5bb9\u548c\u7f29\u5bb9\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/#31-\u4ec0\u4e48\u662fhpa","title":"3.1 \u4ec0\u4e48\u662fHPA","text":"<p>HPA\uff08Horizontal Pod Autoscaler\uff0c\u6c34\u5e73Pod\u81ea\u52a8\u4f38\u7f29\u5668\uff09\u53ef\u4ee5\u6839\u636e\u89c2\u5bdf\u5230\u7684CPU\u3001\u5185\u5b58\u4f7f\u7528\u7387\u6216\u81ea\u5b9a\u4e49\u5ea6\u91cf\u6807\u51c6\u6765\u81ea\u52a8\u6269\u5c55\u6216\u7f29\u5bb9Pod\u7684\u6570\u91cf\u3002</p> <p>\u6ce8\u610f\uff1a HPA\u4e0d\u9002\u7528\u4e8e\u65e0\u6cd5\u7f29\u653e\u7684\u5bf9\u8c61\uff0c\u6bd4\u5982DaemonSet\u3002</p> <p>HPA\u63a7\u5236\u5668\u4f1a\u5b9a\u671f\u8c03\u6574RC\u6216Deployment\u7684\u526f\u672c\u6570\uff0c\u4ee5\u4f7f\u89c2\u5bdf\u5230\u7684\u5e73\u5747CPU \u5229\u7528\u7387\u4e0e\u7528\u6237\u6307\u5b9a\u7684\u76ee\u6807\u76f8\u5339\u914d\u3002</p> <p>HPA\u9700\u8981Metrics Server\uff08\u9879\u76ee\u5730\u5740\uff1ahttps://github.com/kubernetes- sigs/metrics-server\uff09\u83b7\u53d6\u5ea6\u91cf\u6307\u6807\uff0c\u7531\u4e8e\u5728\u9ad8\u53ef\u7528\u96c6\u7fa4\u5b89\u88c5\u4e2d\u5df2\u7ecf\u5b89\u88c5\u4e86Metrics Server\uff0c\u6240\u4ee5\u672c\u8282\u7684\u5b9e\u8df5\u90e8\u5206\u65e0\u987b\u518d\u6b21\u5b89\u88c5\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/#32-hpa\u5b9e\u8df5--\u5b9e\u73b0web\u670d\u52a1\u5668\u7684\u81ea\u52a8\u4f38\u7f29\u7279\u6027","title":"3.2 HPA\u5b9e\u8df5--\u5b9e\u73b0Web\u670d\u52a1\u5668\u7684\u81ea\u52a8\u4f38\u7f29\u7279\u6027","text":"<p>\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u603b\u4f1a\u6709\u4e00\u4e9b\u610f\u60f3\u4e0d\u5230\u7684\u4e8b\u60c5\u53d1\u751f\uff0c\u6bd4\u5982\u516c\u53f8\u7f51\u7ad9\u6d41\u91cf\u7a81 \u7136\u5347\u9ad8\uff0c\u6b64\u65f6\u4e4b\u524d\u521b\u5efa\u7684Pod\u5df2\u4e0d\u8db3\u4ee5\u652f\u6491\u6240\u6709\u7684\u8bbf\u95ee\uff0c \u800c\u8fd0\u7ef4\u4eba\u5458\u4e5f\u4e0d\u53ef\u80fd 24\u5c0f\u65f6\u5b88\u7740\u4e1a\u52a1\u670d\u52a1\uff0c\u8fd9\u65f6\u5c31\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6eHPA\uff0c\u5b9e\u73b0\u8d1f\u8f7d\u8fc7\u9ad8\u7684\u60c5\u51b5\u4e0b\u81ea\u52a8\u6269\u5bb9Pod\u526f\u672c\u6570\u4ee5\u5206\u644a\u9ad8\u5e76\u53d1\u7684\u6d41\u91cf\uff0c\u5f53\u6d41\u91cf\u6062\u590d\u6b63\u5e38\u540e\uff0cHPA\u4f1a\u81ea\u52a8\u7f29\u51cfPod\u7684\u6570\u91cf\u3002</p> <p>\u672c\u8282\u5c06\u6d4b\u8bd5\u5b9e\u73b0\u4e00\u4e2aWeb\u670d\u52a1\u5668\u7684\u81ea\u52a8\u4f38\u7f29\u7279\u6027\uff0c\u5177\u4f53\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <p>hpa-demo.yml</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: hpa-demo\nspec:\nselector:\nmatchLabels:\napp: nginx\ntemplate:\nmetadata:\nlabels:\napp: nginx\nspec:\ncontainers:\n- name: nginx\nimage: nginx\nports:\n- containerPort: 80\nresources:\nrequests:\nmemory: 50Mi\ncpu: 50m\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u66f4\u65b0 Deployment\uff0c\u91cd\u65b0\u521b\u5efa HPA \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f hpa-demo.yml\ndeployment.apps/hpa-demo configured\n\n$ kubectl get pods -o wide -l app=nginx\nNAME                        READY   STATUS    RESTARTS   AGE     IP            NODE         NOMINATED NODE   READINESS GATES\nhpa-demo-69968bb59f-twtdp   1/1     Running   0          4m11s   10.244.4.97   ydzs-node4   &lt;none&gt;           &lt;none&gt;\n\n$ kubectl delete hpa hpa-demo\nhorizontalpodautoscaler.autoscaling \"hpa-demo\" deleted\n\n$ kubectl autoscale deployment hpa-demo --cpu-percent=10 --min=1 --max=10\nhorizontalpodautoscaler.autoscaling/hpa-demo autoscaled\n\n$ kubectl describe hpa hpa-demo\nName:                                                  hpa-demo\nNamespace:                                             default\nLabels:                                                &lt;none&gt;\nAnnotations:                                           &lt;none&gt;\nCreationTimestamp:                                     Tue, 19 Nov 2019 17:23:49 +0800\nReference:                                             Deployment/hpa-demo\nMetrics:                                               ( current / target )\nresource cpu on pods  (as a percentage of request):  0% (0) / 10%\nMin replicas:                                          1\nMax replicas:                                          10\nDeployment pods:                                       1 current / 1 desired\nConditions:\n  Type            Status  Reason               Message\n  ----            ------  ------               -------\n  AbleToScale     True    ScaleDownStabilized  recent recommendations were higher than current one, applying the highest recent recommendation\n  ScalingActive   True    ValidMetricFound     the HPA was able to successfully calculate a replica count from cpu resource utilization (percentage of request)\nScalingLimited  False   DesiredWithinRange   the desired count is within the acceptable range\nEvents:           &lt;none&gt;\n\n$ kubectl get hpa\nNAME       REFERENCE             TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\nhpa-demo   Deployment/hpa-demo   0%/10%    1         10        1          52s </code></pre> <p>\u73b0\u5728\u53ef\u4ee5\u770b\u5230 HPA \u8d44\u6e90\u5bf9\u8c61\u5df2\u7ecf\u6b63\u5e38\u4e86\uff0c\u73b0\u5728\u6211\u4eec\u6765\u589e\u5927\u8d1f\u8f7d\u8fdb\u884c\u6d4b\u8bd5\uff0c\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a busybox \u7684 Pod\uff0c\u5e76\u4e14\u5faa\u73af\u8bbf\u95ee\u4e0a\u9762\u521b\u5efa\u7684 Pod\uff1a</p> <pre><code>$ kubectl run -it --image busybox test-hpa --restart=Never --rm /bin/sh\nIf you don't see a command prompt, try pressing enter.\n/ # while true; do wget -q -O- http://10.244.4.97; done\n</code></pre> <p>\u5982\u4e0b\u53ef\u4ee5\u770b\u5230\uff0cHPA \u5df2\u7ecf\u5f00\u59cb\u5de5\u4f5c\uff1a</p> <pre><code>$  kubectl get hpa\nNAME       REFERENCE             TARGETS    MINPODS   MAXPODS   REPLICAS   AGE\nhpa-demo   Deployment/hpa-demo   338%/10%   1         10        1          5m15s\n\n$ kubectl get pods -l app=nginx --watch\nNAME                        READY   STATUS              RESTARTS   AGE\nhpa-demo-69968bb59f-8hjnn   1/1     Running             0          22s\nhpa-demo-69968bb59f-9ss9f   1/1     Running             0          22s\nhpa-demo-69968bb59f-bllsd   1/1     Running             0          22s\nhpa-demo-69968bb59f-lnh8k   1/1     Running             0          37s\nhpa-demo-69968bb59f-r8zfh   1/1     Running             0          22s\nhpa-demo-69968bb59f-twtdp   1/1     Running             0          6m43s\nhpa-demo-69968bb59f-w792g   1/1     Running             0          37s\nhpa-demo-69968bb59f-zlxkp   1/1     Running             0          37s\nhpa-demo-69968bb59f-znp6q   0/1     ContainerCreating   0          6s\nhpa-demo-69968bb59f-ztnvx   1/1     Running             0          6s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u81ea\u52a8\u62c9\u8d77\u4e86\u5f88\u591a\u65b0\u7684 Pod\uff0c\u6700\u540e\u5b9a\u683c\u5728\u4e86\u6211\u4eec\u4e0a\u9762\u8bbe\u7f6e\u7684 10 \u4e2a Pod\uff0c\u540c\u65f6\u67e5\u770b\u8d44\u6e90 hpa-demo \u7684\u526f\u672c\u6570\u91cf\uff0c\u526f\u672c\u6570\u91cf\u5df2\u7ecf\u4ece\u539f\u6765\u76841\u53d8\u6210\u4e8610\u4e2a\uff1a</p> <pre><code>$ kubectl get deployment hpa-demo\nNAME       READY   UP-TO-DATE   AVAILABLE   AGE\nhpa-demo   10/10   10           10          17m\n</code></pre> <p>\u67e5\u770b HPA \u8d44\u6e90\u7684\u5bf9\u8c61\u4e86\u89e3\u5de5\u4f5c\u8fc7\u7a0b\uff1a</p> <pre><code>$ kubectl describe hpa hpa-demo\nName:                                                  hpa-demo\nNamespace:                                             default\nLabels:                                                &lt;none&gt;\nAnnotations:                                           &lt;none&gt;\nCreationTimestamp:                                     Tue, 19 Nov 2019 17:23:49 +0800\nReference:                                             Deployment/hpa-demo\nMetrics:                                               ( current / target )\nresource cpu on pods  (as a percentage of request):  0% (0) / 10%\nMin replicas:                                          1\nMax replicas:                                          10\nDeployment pods:                                       10 current / 10 desired\nConditions:\n  Type            Status  Reason               Message\n  ----            ------  ------               -------\n  AbleToScale     True    ScaleDownStabilized  recent recommendations were higher than current one, applying the highest recent recommendation\n  ScalingActive   True    ValidMetricFound     the HPA was able to successfully calculate a replica count from cpu resource utilization (percentage of request)\nScalingLimited  True    TooManyReplicas      the desired replica count is more than the maximum replica count\nEvents:\n  Type    Reason             Age    From                       Message\n  ----    ------             ----   ----                       -------\n  Normal  SuccessfulRescale  5m45s  horizontal-pod-autoscaler  New size: 4; reason: cpu resource utilization (percentage of request) above target\n  Normal  SuccessfulRescale  5m30s  horizontal-pod-autoscaler  New size: 8; reason: cpu resource utilization (percentage of request) above target\n  Normal  SuccessfulRescale  5m14s  horizontal-pod-autoscaler  New size: 10; reason: cpu resource utilization (percentage of request) above target\n</code></pre> <p>\u540c\u6837\u7684\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u6765\u5173\u6389 busybox \u6765\u51cf\u5c11\u8d1f\u8f7d\uff0c\u7136\u540e\u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4\u89c2\u5bdf\u4e0b HPA \u548c Deployment \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get hpa\nNAME       REFERENCE             TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\nhpa-demo   Deployment/hpa-demo   0%/10%    1         10        1          14m\n\n$ kubectl get deployment hpa-demo\nNAME       READY   UP-TO-DATE   AVAILABLE   AGE\nhpa-demo   1/1     1            1           24m\n</code></pre> <p>\u7f29\u653e\u95f4\u9699</p> <p>\u4eceKubernetes v1.12\u7248\u672c\u5f00\u59cb\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6ekube-controller-manager\u7ec4\u4ef6\u7684<code>--horizontal-pod-autoscaler-downscale-stabilization</code>\u53c2\u6570\u6765\u8bbe\u7f6e\u4e00\u4e2a\u6301\u7eed\u65f6\u95f4\uff0c \u7528\u4e8e\u6307\u5b9a\u5728\u5f53\u524d\u64cd\u4f5c\u5b8c\u6210\u540e\uff0cHPA \u5fc5\u987b\u7b49\u5f85\u591a\u957f\u65f6\u95f4\u624d\u80fd\u6267\u884c\u53e6\u4e00\u6b21\u7f29\u653e\u64cd\u4f5c\u3002</p> <p>\u9ed8\u8ba4\u4e3a5\u5206\u949f\uff0c\u4e5f\u5c31\u662f\u9ed8\u8ba4\u9700\u8981\u7b49\u5f855\u5206\u949f\u540e\u624d\u4f1a\u5f00\u59cb\u81ea\u52a8\u7f29\u653e\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\u526f\u672c\u6570\u91cf\u5df2\u7ecf\u753110\u53d8\u4e3a1\uff0c\u5f53\u524d\u6211\u4eec\u53ea\u662f\u6f14\u793a\u4e86CPU\u4f7f\u7528\u7387\u8fd9\u4e00\u4e2a\u6307\u6807\uff0c\u5728\u540e\u9762\u7684\u8bfe\u7a0b\u4e2d\u6211\u4eec\u8fd8\u4f1a\u5b66\u4e60\u5230\u6839\u636e\u81ea\u5b9a\u4e49\u7684\u76d1\u63a7\u6307\u6807\u6765\u81ea\u52a8\u5bf9 Pod \u8fdb\u884c\u6269\u7f29\u5bb9\u3002</p> <p>Pod\u6c34\u5e73\u81ea\u52a8\u6269\u7f29</p> <p>https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale/</p> <p>HorizontalPodAutoscaler\u6f14\u7ec3</p> <p>https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/#4-taint\u548ctoleration","title":"4. Taint\u548cToleration","text":"<p>\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u7ecf\u5e38\u4f1a\u6709\u8fd9\u6837\u7684\u9700\u6c42\uff1a</p> <ul> <li> <p>Master\u8282\u70b9\u53ea\u90e8\u7f72\u7cfb\u7edf\u7ec4\u4ef6\u5bb9\u5668\uff0c\u6bd4\u5982Calico\u3001Metrics Server\u3001 Dashboard\u7b49\uff0c\u4e0d\u5e94\u8be5\u90e8\u7f72\u4e1a\u52a1\u5e94\u7528\u3002</p> </li> <li> <p>\u65b0\u6dfb\u52a0\u8282\u70b9\u4e0d\u5e94\u8be5\u7acb\u9a6c\u5c31\u5141\u8bb8\u90e8\u7f72\u4e1a\u52a1\u5bb9\u5668\uff0c\u4e5f\u5c31\u662f\u65b0\u8282\u70b9\u9700\u8981\u7ecf\u8fc7\u5b8c\u6574\u6027\u53ca\u7a33\u5b9a\u6027\u6d4b\u8bd5\u624d\u53ef\u4ee5\u88ab\u5141\u8bb8\u8c03\u5ea6\u3002</p> </li> <li> <p>\u67d0\u4e9b\u8282\u70b9\u53ef\u80fd\u9700\u8981\u8fdb\u884c\u7cfb\u7edf\u5347\u7ea7\u6216\u8005\u5176\u4ed6\u7ef4\u62a4\uff0c\u53ef\u80fd\u4f1a\u5f15\u8d77\u8282\u70b9\u4e0a\u7684\u5bb9\u5668\u4e0d\u53ef\u7528\uff0c\u6b64\u65f6\u9700\u8981\u5c06\u8be5\u8282\u70b9\u4e0a\u7684Pod\u6f02\u79fb\u81f3\u5176\u4ed6\u8282\u70b9\uff0c\u518d\u8fdb\u884c\u7ef4\u62a4\u3002</p> </li> <li> <p>\u6709\u4e00\u4e9bGPU\u670d\u52a1\u5668\u6216\u5176\u4ed6\u4e13\u7528\u8282\u70b9\u670d\u52a1\u5668\uff0c\u9664\u4e86\u6307\u5b9a\u7684Pod\u5916\uff0c\u5e76\u4e0d\u60f3\u8ba9\u5b83\u4eec\u90e8\u7f72\u5176\u4ed6Pod\u3002</p> </li> </ul> <p>\u9762\u5bf9\u8fd9\u6837\u7684\u9700\u6c42\uff0cKubernetes\u62bd\u8c61\u4e86\u6c61\u70b9(Taint)\u548c\u5bb9\u5fcd(Toleration)\u7684\u6982\u5ff5\uff0c\u53ef\u4ee5\u975e\u5e38\u65b9\u4fbf\u5730\u5b9e\u73b0\u8fd9\u4e9b\u9700\u6c42\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/#41-\u5bb9\u5fcd\u548c\u6c61\u70b9\u7684\u57fa\u672c\u6982\u5ff5","title":"4.1 \u5bb9\u5fcd\u548c\u6c61\u70b9\u7684\u57fa\u672c\u6982\u5ff5","text":"<p>Taint\u4f5c\u7528\u5728\u8282\u70b9\u4e0a\uff0c\u80fd\u591f\u4f7f\u8282\u70b9\u6392\u65a5\u4e00\u7c7b\u7279\u5b9a\u7684Pod\uff0c\u4e5f\u5c31\u662f\u4e0d\u80fd\u201c\u517c \u5bb9\u201d\u8be5\u8282\u70b9\u7684\u6c61\u70b9\u7684Pod\u3002</p> <p>\u5bf9\u5e94\u7684Toleration\u4f5c\u7528\u5728Pod\u4e0a\uff0c\u610f\u4e3a\u5bb9\u5fcd\uff0c\u4e5f\u5c31\u662f\u53ef\u4ee5\u517c\u5bb9\u67d0\u7c7b\u6c61\u70b9\u3002</p> <p>Taint\u548cToleration\u76f8\u4e92\u914d\u5408\u53ef\u4ee5\u7528\u6765\u907f\u514dPod\u88ab\u5206\u914d\u5230\u4e0d\u5408\u9002\u7684\u8282\u70b9\uff0c\u6bd4\u5982\u6709\u4e00\u6279GPU\u670d\u52a1\u5668\u53ea\u80fd\u90e8\u7f72\u8981\u4f7f\u7528GPU\u7684Pod\u3002</p> <p>\u6bcf\u4e2a\u8282\u70b9\u4e0a\u90fd\u53ef\u4ee5\u5e94\u7528\u4e00\u4e2a\u6216\u591a\u4e2aTaint\uff0c\u8fd9\u8868\u793a\u5bf9\u4e8e\u90a3\u4e9b\u4e0d\u80fd\u5bb9\u5fcd\u8fd9\u4e9bTaint\u7684Pod\u662f\u4e0d\u80fd\u90e8\u7f72\u5728\u8be5\u670d\u52a1\u5668\u4e0a\u7684\u3002</p> <p>\u5982\u679cPod\u914d\u7f6e\u4e86Toleration\uff0c\u5219\u8868\u793a\u8fd9\u4e9bPod\u53ef\u4ee5\u88ab\u8c03\u5ea6\u5230\u8bbe\u7f6e\u4e86Taint\u7684\u8282\u70b9\u4e0a\uff0c\u5f53\u7136\u6ca1\u6709\u8bbe\u7f6eTaint\u7684\u8282\u70b9\u4e5f\u662f\u53ef\u4ee5\u90e8\u7f72\u7684\u3002</p> <p>\u7ed9\u8282\u70b9\u589e\u52a0\u4e00\u4e2aTaint\u4e5f\u5f88\u7b80\u5355\uff0c\u76f4\u63a5\u4f7f\u7528kubectl taint\u547d\u4ee4\u5373\u53ef\uff0c\u6bd4\u5982\u7ed9k8s-node01\u8282\u70b9\u8bbe\u7f6e\u4e00\u4e2aTaint\uff1a</p> <pre><code># kubectl taint nodes k8s-node01 taintKey=taintValue:NoSchedule\nnode/k8s-node01 tainted\n</code></pre> <p>\u4e0a\u8ff0\u547d\u4ee4\u7ed9k8s-node01\u589e\u52a0\u4e86\u4e00\u4e2aTaint\uff0c\u5b83\u7684taintKey(\u53ef\u4ee5\u8bbe\u7f6e\u4e3a\u5176\u4ed6\u503c)\u5bf9\u5e94\u7684\u5c31\u662fTaint\u7684\u952e\uff0c taintValue(\u53ef\u4ee5\u8bbe\u7f6e\u4e3a\u5176\u4ed6\u503c)\u5bf9\u5e94\u5c31\u662fTaint\u7684\u503c,Effect\u5bf9\u5e94\u7684\u5c31\u662fNoSchedule\uff0c \u987e\u540d\u601d\u4e49\uff0c\u4e5f\u5c31\u662f\u8fd9\u4e2aTaint\u7684\"\u5f71\u54cd\"\u76f8\u5f53\u4e8eTaint\u7684\"\u7ea7\u522b\"\u3002</p> <p>\u8fd9\u8868\u660e\u53ea\u6709\u548c\u8fd9\u4e2aTaint\u76f8\u5339\u914d\u7684Toleration\u7684Pod\u624d\u80fd\u591f\u88ab\u5206\u914d\u5230k8s-node01\u8282\u70b9\u4e0a\u3002</p> <p>\u6309\u5982\u4e0b\u65b9\u5f0f\u5728PodSpec\u4e2d\u5b9a\u4e49Pod\u7684Toleration\uff0c\u5c31\u53ef\u4ee5\u5c06Pod\u90e8\u7f72\u5230\u8be5\u8282\u70b9\u4e0a\u3002</p> <p>\u65b9\u5f0f\u4e00</p> <p>\u5b8c\u5168\u5339\u914d\uff0coperator\u4e3aEqual\uff0c\u6bd4\u5982\u80fd\u5bb9\u5fcdkey\u540d\u4e3ataintKey\u3001value\u4e3ataintValue\u3001effect\u4e3aNoSchedule\u7684Taint\uff08Toleration\u53ef\u4ee5\u5b9a\u4e49\u591a\u4e2a\uff09\uff1a</p> <pre><code>tolerations:\n- key: \"taintKey\"\n  operator: \"Equal\"\n  value: \"taintValue\"\n  effect: \"NoSchedule\"\n</code></pre> <p>\u65b9\u5f0f\u4e8c</p> <p>\u4e0d\u5b8c\u5168\u5339\u914d\uff0coperator\u4e3aExists\uff0c\u6bd4\u5982\u80fd\u5bb9\u5fcdkey\u540d\u4e3ataintKey\u3001effect\u4e3aNoSchedule\u7684Taint\uff0c\u4e0d\u8003\u8651Taint\u7684value\u662f\u4ec0\u4e48\uff1a</p> <pre><code>tolerations:\n- key: \"taintKey\"\n  operator: \"Exists\"\n  effect: \"NoSchedule\"\n</code></pre> <p>\u5f53\u7136\uff0c\u8fd8\u53ef\u4ee5\u5339\u914d\u66f4\u5927\u7684\u8303\u56f4\uff0c\u6bd4\u5982\u80fd\u5bb9\u5fcdkey\u540d\u4e3ataintKey\u7684Taint\uff1a</p> <pre><code>- key: \"taintKey\"\n  operator: \"Exists\"\n</code></pre> <p>\u7efc\u4e0a\u53ef\u77e5\uff0c \u5982\u679cPod\u7684Toleration\u914d\u7f6e\u7684operator\u4e3aExists(\u6b64\u65f6toleration\u4e0d\u6307\u5b9avalue\uff09\uff0c \u90a3\u4e48\u4e00\u4e2aToleration\u548c\u4e00\u4e2aTaint\u76f8\u5339\u914d\u662f\u6307\u5b83\u4eec\u6709\u4e00\u6837\u7684key\u548ceffect\uff0c\u5982\u679coperator\u662fEqual\uff0c\u5219\u5b83\u4eec\u7684value\u4e5f\u5e94\u8be5\u76f8\u7b49\u3002</p> <p>\u6ce8\u610f\u4e24\u79cd\u7279\u6b8a\u60c5\u51b5\uff1a - \u5982\u679c\u4e00\u4e2aToleration\u7684key\u3001value\u548ceffect\u5747\u4e3a\u7a7a\uff0c\u4e14operator\u4e3aExists\uff0c\u8868\u793a\u8fd9\u4e2aToleration\u4e0e\u4efb\u610f\u7684key\u3001value\u548ceffect\u90fd\u5339   \u914d\uff0c\u5373\u8fd9\u4e2aToleration\u80fd\u5bb9\u5fcd\u4efb\u610f\u7684Taint\uff1a</p> <pre><code>tolerations:\n- operator: \"Exists\"\n</code></pre> <ul> <li>\u5982\u679c\u4e00\u4e2aToleration\u7684effect\u4e3a\u7a7a\uff0c\u5219\u8fd9\u4e2aToleration\u53ef\u4ee5\u5bb9\u5fcd\u4efb\u4f55key\u4e3a\u540dtaintKey\u7684Taint\uff0c\u65e0\u8bba\u8be5Taint\u7684value\u548ceffect\u662f\u4ec0\u4e48\uff1a <pre><code>tolerations:\n- key: \"taintKey\"\n  operator: \"Exists\"\n</code></pre></li> </ul> <p>\u4e0a\u8ff0\u4f8b\u5b50\u4f7f\u7528\u5230effect\u7684\u4e00\u4e2a\u503cNoSchedule\uff08\u7981\u6b62\u8c03\u5ea6\u7684\u610f\u601d\uff0c\u4e00\u822c\u8be5\u8282\u70b9\u8981\u7ef4\u62a4\u6216\u8005\u521a\u6dfb\u52a0\u8282\u70b9\u4f1a\u914d\u7f6e\u8be5Taint\uff09\uff0c \u4e5f\u53ef\u4ee5\u4f7f\u7528PreferNoSchedule\uff0c\u8be5\u503c\u5b9a\u4e49\u5c3d\u91cf\u907f\u514d\u5c06Pod\u8c03\u5ea6\u5230\u5b58\u5728\u5176\u4e0d\u80fd\u5bb9\u5fcd\u7684Taint \u7684\u8282\u70b9\u4e0a\uff0c\u4f46\u5e76\u4e0d\u662f\u5f3a\u5236\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e00\u4e2a\u6ca1\u6709\u914d\u7f6eToleration\u7684Pod\u4f1a\u4f18 \u5148\u90e8\u7f72\u81f3\u5176\u4ed6\u8282\u70b9\uff0c\u6ca1\u6709\u5176\u4ed6\u53ef\u4ee5\u8c03\u5ea6\u7684\u8282\u70b9\u65f6\uff0c\u8fd8\u662f\u53ef\u4ee5\u90e8\u7f72\u5230effect\u4e3a PreferNoSchedule\u7684\u8282\u70b9\u4e0a\u7684\uff0cNoSchedule\u6ca1\u6709\u8fd9\u79cd\u673a\u5236\u3002</p> <p>Effect\u7684\u503c\u8fd8\u53ef \u4ee5\u8bbe\u7f6e\u4e3aNoExecute\uff0c\u5982\u679c\u4e00\u4e2a\u8282\u70b9\u7684Taint\u7684Effect\u914d\u7f6e\u4e3aNoExecute\uff0c\u90a3\u4e48\u5df2\u7ecf\u5728\u8fd9\u4e2a\u8282\u70b9\u4e0a\u7684Pod\u6ca1\u6709\u914d\u7f6e\u5bb9\u5fcd\u8be5Taint\u7684Toleration\uff0c \u8fd9\u4e2a\u8282\u70b9\u4e0a\u7684Pod\u4f1a\u5728\u6307\u5b9a\u65f6\u95f4\u5185\u88ab\u9a71\u9010\u5230\u5176\u4ed6\u8282\u70b9\u4e0a\uff0c\u4f46Effect\u4e3aNoSchedule\u6216PreferNoSchedule\u65f6\u4e0d\u4f1a\u9a71\u9010\u5df2\u7ecf\u5728\u8be5\u8282\u70b9\u4e0a\u7684Pod\u3002</p> <p>\u4e00\u4e2a\u8282\u70b9\u53ef\u4ee5\u8bbe\u7f6e\u591a\u4e2aTaint\uff0c\u4e5f\u53ef\u4ee5\u7ed9\u4e00\u4e2aPod\u6dfb\u52a0\u591a\u4e2aToleration\u3002</p> <p>Kubernetes\u5904\u7406\u591a\u4e2aTaint\u548cToleration\u7684\u8fc7\u7a0b\u5c31\u50cf\u4e00\u4e2a\u8fc7\u6ee4\u5668\uff1a \u4ece\u4e00\u4e2a\u8282\u70b9 \u7684\u6240\u6709Taint\u5f00\u59cb\u904d\u5386\uff0c\u8fc7\u6ee4\u6389\u90a3\u4e9bPod\u4e2d\u5b58\u5728\u4e0e\u4e4b\u76f8\u5339\u914d\u7684Toleration\u7684Taint\uff0c\u4f59\u4e0b\u672a\u88ab\u8fc7\u6ee4\u7684Taint\u7684effect\u503c\u51b3\u5b9a\u4e86Pod\u662f\u5426\u4f1a\u88ab\u5206\u914d\u5230\u8be5\u8282\u70b9\uff0c \u7279\u522b\u662f\u4ee5\u4e0b\u60c5\u51b5\uff1a</p> <ul> <li> <p>\u5982\u679c\u672a\u88ab\u8fc7\u6ee4\u7684Taint\u4e2d\u5b58\u5728\u4e00\u4e2a\u4ee5\u4e0aeffect\u503c\u4e3aNoSchedule\u7684Taint\uff0c\u5219Kubernetes\u4e0d\u4f1a\u5c06Pod\u5206\u914d\u5230\u8be5\u8282\u70b9\u3002</p> </li> <li> <p>\u5982\u679c\u672a\u88ab\u8fc7\u6ee4\u7684Taint\u4e2d\u4e0d\u5b58\u5728effect\u503c\u4e3aNoExecute\u7684Taint\uff0c\u4f46\u662f\u5b58\u5728effect\u503c\u4e3aPreferNoSchedule\u7684Taint\uff0c\u5219Kubernetes\u4f1a\u5c1d\u8bd5\u5c06Pod\u5206\u914d\u5230\u8be5\u8282\u70b9\u3002</p> </li> <li> <p>\u5982\u679c\u672a\u88ab\u8fc7\u6ee4\u7684Taint\u4e2d\u5b58\u5728\u4e00\u4e2a\u4ee5\u4e0aeffect\u503c\u4e3aNoExecute\u7684Taint\uff0c\u5219Kubernetes\u4e0d\u4f1a\u5c06Pod\u5206\u914d\u5230\u8be5\u8282\u70b9(\u5982\u679cPod\u8fd8\u672a\u5728\u8282\u70b9\u4e0a\u8fd0\u884c)\uff0c\u6216\u8005\u5c06Pod\u4ece\u8be5\u8282\u70b9\u9a71\u9010(\u5982\u679cPod\u5df2\u7ecf\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\uff09\u3002</p> </li> </ul> <p>\u4f8b\u5982\uff0c\u5047\u8bbe\u7ed9\u4e00\u4e2a\u8282\u70b9\u6dfb\u52a0\u4e86\u4ee5\u4e0bTaint\uff1a <pre><code>kubectl taint nodes k8s-node01 key1=value1:NoSchedule\nkubectl taint nodes k8s-node01 key1=value1:NoExecute\nkubectl taint nodes k8s-node01 key2=value2:NoSchedule\n</code></pre></p> <p>\u7136\u540e\u5b58\u5728\u4e00\u4e2aPod\uff0c\u5b83\u6709\u4e24\u4e2aToleration\uff1a</p> <p><pre><code>tolerations:\n- key: \"key1\"\n  operator: \"Equal\"\n  value: \"value1\"\n  effect: \"NoSchedule\"\n\n- key: \"key1\"\n  operator: \"Equal\"\n  value: \"value1\"\n  effect: \"NoExecute\"\n</code></pre> \u5728\u4e0a\u8ff0\u4f8b\u5b50\u4e2d\uff0c\u8be5Pod\u4e0d\u4f1a\u88ab\u5206\u914d\u5230\u4e0a\u8ff0\u8282\u70b9\uff0c\u56e0\u4e3a\u6ca1\u6709\u5339\u914d\u7b2c3\u4e2aTaint\u3002</p> <p>\u4f46\u662f\u5982\u679c\u7ed9\u8282\u70b9\u6dfb\u52a0\u4e0a\u8ff03\u4e2aTaint\u4e4b\u524d\uff0c\u8be5Pod\u5df2\u7ecf\u5728\u4e0a\u8ff0\u8282\u70b9\u4e2d\u8fd0\u884c\uff0c\u90a3\u4e48\u5b83\u4e0d\u4f1a\u88ab\u9a71\u9010\uff0c\u8fd8\u4f1a\u7ee7\u7eed\u8fd0\u884c\u5728\u8fd9\u4e2a\u8282\u70b9\u4e0a\uff0c \u56e0\u4e3aEffect\u4e3aNoSchedule\u7684Taint\u53ea\u662f\u7981\u6b62\u8ba9\u6ca1\u6709\u5339\u914d\u8be5Taint\u7684Pod\u4e0d\u4f1a\u88ab\u8c03\u5ea6\u5230\u8be5\u8282\u70b9\u4e0a\uff0c\u4e0d\u4f1a\u5f71\u54cd\u5df2\u7ecf\u90e8\u7f72\u7684Pod\u3002</p> <p>\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u7ed9\u4e00\u4e2a\u8282\u70b9\u6dfb\u52a0\u4e86\u4e00\u4e2aeffect\u503c\u4e3aNoExecute\u7684Taint\uff0c\u5219\u4efb\u4f55\u4e0d\u80fd\u5bb9\u5fcd\u8fd9\u4e2aTaint\u7684Pod\u90fd\u4f1a\u9a6c\u4e0a\u88ab\u9a71\u9010\uff0c\u4efb\u4f55\u53ef\u4ee5\u5bb9\u5fcd\u8fd9\u4e2a Taint\u7684Pod\u90fd\u4e0d\u4f1a\u88ab\u9a71\u9010\u3002</p> <p>\u4f46\u662f\uff0c\u5982\u679cPod\u5b58\u5728\u4e00\u4e2aeffect\u503c\u4e3aNoExecute\u7684Toleration\u6307\u5b9a\u4e86\u53ef\u9009\u5c5e\u6027tolerationSeconds\u7684\u503c\uff0c\u5219\u8be5\u503c\u8868\u793a\u5728\u7ed9\u8282\u70b9\u6dfb\u52a0\u4e86\u4e0a\u8ff0Taint\u4e4b\u540e\uff0cPod\u8fd8\u80fd\u7ee7\u7eed\u5728\u8be5\u8282\u70b9\u4e0a\u8fd0\u884c\u7684\u65f6\u95f4\uff0c\u4f8b\u5982\uff1a <pre><code>tolerations:\n- key: \"key1\"\n  operator: \"Equal\"\n  value: \"value1\"\n  effect: \"NoExecute\"\n  tolerationSeconds: 3600\n</code></pre> \u8868\u793a\u5982\u679c\u8fd9\u4e2aPod\u6b63\u5728\u67d0\u4e2a\u8282\u70b9\u8fd0\u884c\uff0c\u7136\u540e\u4e00\u4e2aEffect\u4e3aNoExecute\u7684Taint\u88ab\u6dfb\u52a0\u5230\u5176\u6240\u5728\u7684\u8282\u70b9\uff0c\u90a3\u4e48Pod\u8fd8\u5c06\u7ee7\u7eed\u5728\u8282\u70b9\u4e0a\u8fd0\u884c3600\u79d2\uff0c\u7136\u540e\u88ab\u9a71\u9010\u3002</p> <p>\u5982\u679c\u5728\u6b64\u4e4b\u524d\u4e0a\u8ff0Taint\u88ab\u5220\u9664\u4e86\uff0c\u5219Pod\u4e0d\u4f1a\u88ab\u9a71\u9010\u3002</p> <p>\u5220\u9664\u4e00\u4e2aTaint\u548c\u5220\u9664Label\u7c7b\u4f3c\uff0c\u4f7f\u7528\u51cf\u53f7\uff08\u2012\uff09\u5373\u53ef\uff1a <pre><code># kubectl taint nodes k8s-node01 key1:NoExecute-\n</code></pre></p> <p>\u67e5\u770b\u67d0\u4e2a\u8282\u70b9\u7684Taint\u53ef\u4ee5\u4f7f\u7528describe\uff1a <pre><code># kubectl describe node k8s-node01 | grep Taint\nTaints:            key=value:NoSchedule\n</code></pre></p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/#42-\u4f7f\u7528\u6848\u4f8b","title":"4.2 \u4f7f\u7528\u6848\u4f8b","text":"<p>\u901a\u8fc7Taint\u548cToleration\u53ef\u4ee5\u7075\u6d3b\u5730\u8ba9Pod\u907f\u5f00\u67d0\u4e9b\u8282\u70b9\u6216\u8005\u5c06Pod\u4ece\u67d0\u4e9b\u8282\u70b9\u9a71\u9010\u3002 \u4e0b\u9762\u662f\u51e0\u79cd\u4f7f\u7528\u6848\u4f8b\u3002</p> <p>\uff081\uff09\u4e13\u7528\u8282\u70b9 \u5982\u679c\u60f3\u5c06\u67d0\u4e9b\u8282\u70b9\u4e13\u95e8\u5206\u914d\u7ed9\u7279\u5b9a\u7684\u4e00\u7ec4\u7528\u6237\u4f7f\u7528\uff0c\u53ef\u4ee5\u7ed9\u8fd9\u4e9b\u8282\u70b9\u6dfb\u52a0\u4e00\u4e2aTaint( kubectl taint nodes nodename dedicated=groupName:NoSchedule\uff09\uff0c \u7136\u540e\u7ed9\u8fd9\u7ec4\u7528\u6237\u7684Pod\u6dfb\u52a0\u4e00\u4e2a\u76f8\u5bf9\u5e94\u7684Toleration\uff0c\u90a3\u4e48\u62e5\u6709\u4e0a\u8ff0Toleration\u7684Pod\u5c31\u80fd\u591f\u88ab\u5206\u914d\u5230\u4e0a\u8ff0\u4e13\u7528\u8282\u70b9\uff0c\u540c\u65f6\u4e5f\u80fd\u591f\u88ab\u5206\u914d\u5230\u96c6\u7fa4\u4e2d\u7684\u5176\u4ed6\u8282\u70b9\u3002</p> <p>\u5982\u679c\u5e0c\u671b\u8fd9\u4e9bPod\u53ea\u80fd\u5206\u914d\u5230\u4e0a\u8ff0\u4e13\u7528\u8282\u70b9\u4e2d\uff0c\u90a3\u4e48\u8fd8\u9700\u8981\u7ed9\u8fd9\u4e9b\u4e13\u7528\u8282\u70b9\u53e6\u5916\u6dfb\u52a0\u4e00\u4e2a\u548c\u4e0a\u8ff0Taint\u7c7b\u4f3c\u7684Label\uff08\u4f8b\u5982dedicated=groupName\uff09\uff0c\u7136\u540e\u7ed9Pod\u589e\u52a0\u8282\u70b9\u4eb2\u548c\u6027\u8981\u6c42\u6216\u8005\u4f7f \u7528NodeSelector\uff0c\u5c31\u80fd\u5c06Pod\u53ea\u5206\u914d\u5230\u6dfb\u52a0\u4e86dedicated=groupName\u6807\u7b7e\u7684\u8282\u70b9\u4e0a\u3002</p> <p>\uff082\uff09\u7279\u6b8a\u786c\u4ef6\u7684\u8282\u70b9 \u5728\u90e8\u5206\u8282\u70b9\u4e0a\u914d\u5907\u4e86\u7279\u6b8a\u786c\u4ef6\uff08\u6bd4\u5982GPU\uff09\u7684\u96c6\u7fa4\u4e2d\uff0c\u6211\u4eec\u53ea\u5141\u8bb8\u7279\u5b9a\u7684Pod\u624d\u80fd\u90e8\u7f72\u5728\u8fd9\u4e9b\u8282\u70b9\u4e0a\u3002 \u8fd9\u65f6\u53ef\u4ee5\u4f7f\u7528Taint\u8fdb\u884c\u63a7\u5236\uff0c\u6dfb\u52a0Taint\uff0c\u5982<code>kubectl taint nodes nodename special=true:NoSchedule</code> \u6216\u8005  <code>kubectl taint nodes nodename special=true:PreferNoSchedule</code>\uff0c\u7136\u540e\u7ed9\u9700\u8981\u90e8\u7f72\u5728\u8fd9\u4e9b\u8282\u70b9\u4e0a\u7684Pod\u6dfb\u52a0\u76f8\u5339\u914d\u7684Toleration\u5373\u53ef\u3002</p> <p>\uff083\uff09\u57fa\u4e8eTaint\u7684\u9a71\u9010 \u5c5e\u4e8ealpha\u7279\u6027\uff0c\u5728\u6bcf\u4e2aPod\u4e2d\u914d\u7f6e\u5728\u8282\u70b9\u51fa\u73b0\u95ee\u9898\u65f6\u7684\u9a71\u9010\u884c\u4e3a\uff0c\u53c2\u8003\u4e0b\u4e00\u5c0f\u8282\u3002</p> <p>\u6807\u7b7e\u3001\u6c61\u70b9\u8bbe\u7f6e\u4e3e\u4f8b</p> <pre><code># \u8bbe\u7f6e\u6807\u7b7e\nkubectl label nodes 172.18.0.76 node_role=giteePraefect\n\n# \u8bbe\u7f6e\u6c61\u70b9\nkubectl taint nodes 172.18.0.76 GiteePraefectOnly=yes:NoSchedule\n\n# \u5220\u9664\u6807\u7b7e\nkubectl label nodes 172.18.0.66 node_role-\n\n# \u5220\u9664\u6c61\u70b9\nkubectl taint node 172.18.0.66 GiteeInternalOnly:NoSchedule-\n\n# \u67e5\u770b\u6807\u7b7e\nkubectl get node --show-labels\nkubectl get node 172.18.0.66 --show-labels|grep giteeInternal\n\n# \u67e5\u770b\u6c61\u70b9\nkubectl describe nodes 172.18.0.66|grep -A 5 Taints\n</code></pre>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/#43-\u57fa\u4e8etaint\u7684\u9a71\u9010","title":"4.3 \u57fa\u4e8eTaint\u7684\u9a71\u9010","text":"<p>\u4e4b\u524d\u63d0\u5230\u8fc7Taint\u7684effect\u503cNoExecute\uff0c\u5b83\u4f1a\u5f71\u54cd\u5df2\u7ecf\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u7684Pod\u3002</p> <p>\u5982\u679cPod\u4e0d\u80fd\u5fcd\u53d7effect\u503c\u4e3aNoExecute\u7684Taint\uff0c\u90a3\u4e48Pod\u5c06\u4f1a\u88ab\u9a6c\u4e0a\u9a71\u9010\u3002 \u5982\u679c\u80fd\u591f\u5fcd\u53d7effect\u503c\u4e3aNoExecute\u7684Taint\uff0c\u4f46\u662f\u5728Toleration\u5b9a\u4e49\u4e2d\u6ca1\u6709\u6307\u5b9atolerationSeconds\uff0c\u5219Pod\u8fd8\u4f1a\u4e00\u76f4\u5728\u8fd9\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u3002</p> <p>\u5728Kubernetes 1.6\u7248\u4ee5\u540e\u5df2\u7ecf\u652f\u6301\uff08alpha\uff09\u5f53\u67d0\u79cd\u6761\u4ef6\u4e3a\u771f\u65f6\uff0cNode Controller\u4f1a\u81ea\u52a8\u7ed9\u8282\u70b9\u6dfb\u52a0\u4e00\u4e2aTaint\uff0c\u7528\u4ee5\u8868\u793a\u8282\u70b9\u7684\u95ee\u9898\u3002 \u5f53\u524d\u5185\u7f6e\u7684Taint\u5305\u62ec\uff1a</p> <ul> <li>node.kubernetes.io/not-ready\uff1a\u8282\u70b9\u672a\u51c6\u5907\u597d\uff0c\u76f8\u5f53\u4e8e\u8282\u70b9\u72b6\u6001 Ready\u7684\u503c\u4e3aFalse\u3002</li> <li>node.kubernetes.io/unreachable\uff1a Node Controller\u8bbf\u95ee\u4e0d\u5230\u8282\u70b9\uff0c\u76f8\u5f53\u4e8e\u8282\u70b9\u72b6\u6001Ready\u7684\u503c\u4e3aUnknown\u3002</li> <li>node.kubernetes.io/out-of-disk\uff1a\u8282\u70b9\u78c1\u76d8\u8017\u5c3d\u3002</li> <li>node.kubernetes.io/memory-pressure\uff1a\u8282\u70b9\u5b58\u5728\u5185\u5b58\u538b\u529b\u3002</li> <li>node.kubernetes.io/disk-pressure\uff1a\u8282\u70b9\u5b58\u5728\u78c1\u76d8\u538b\u529b\u3002</li> <li>node.kubernetes.io/network-unavailable\uff1a\u8282\u70b9\u7f51\u7edc\u4e0d\u53ef\u8fbe\u3002</li> <li>node.kubernetes.io/unschedulable\uff1a\u8282\u70b9\u4e0d\u53ef\u8c03\u5ea6\u3002</li> <li>node.cloudprovider.kubernetes.io/uninitialized\uff1a\u5982\u679cKubelet \u542f\u52a8\u65f6\u6307\u5b9a\u4e86\u4e00\u4e2a\u5916\u90e8\u7684cloudprovider\uff0c\u5b83\u5c06\u7ed9\u5f53\u524d\u8282\u70b9\u6dfb\u52a0\u4e00\u4e2aTaint\u5c06\u5176\u6807\u8bb0\u4e3a\u4e0d\u53ef\u7528\u3002\u5728cloud-controller-manager\u7684\u4e00\u4e2aController\u521d\u59cb\u5316\u8fd9\u4e2a\u8282\u70b9\u540e\uff0cKubelet\u5c06\u5220\u9664\u8fd9\u4e2aTaint\u3002</li> </ul> <p>\u4f7f\u7528\u8fd9\u4e2aalpha\u529f\u80fd\u7279\u6027\u7ed3\u5408tolerationSeconds\uff0cPod\u5c31\u53ef\u4ee5\u6307\u5b9a\u5f53\u8282\u70b9\u51fa\u73b0\u4e00\u4e2a\u6216\u5168\u90e8\u4e0a\u8ff0\u95ee\u9898\u65f6\uff0cPod\u8fd8\u80fd\u5728\u8fd9\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u591a\u957f\u65f6\u95f4\u3002</p> <p>\u6bd4\u5982\uff0c\u4e00\u4e2a\u4f7f\u7528\u4e86\u5f88\u591a\u672c\u5730\u72b6\u6001\u7684\u5e94\u7528\u7a0b\u5e8f\u5728\u7f51\u7edc\u65ad\u5f00\u65f6\uff0c\u4ecd\u7136\u5e0c\u671b\u505c \u7559\u5728\u5f53\u524d\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u6bb5\u65f6\u95f4\uff0c\u613f\u610f\u7b49\u5f85\u7f51\u7edc\u6062\u590d\u4ee5\u907f\u514d\u88ab\u9a71\u9010\u3002 \u5728\u8fd9\u79cd\u60c5 \u51b5\u4e0b\uff0cPod\u7684Toleration\u53ef\u4ee5\u8fd9\u6837\u914d\u7f6e\uff1a</p> <pre><code>tolerations:\n- key: \"node.cloudprovider.kubernetes.io/uninitialized\"\n  operator: \"Exists\"\n  effect: \"NoExecute\"\n  tolerationSeconds: 6000\n</code></pre> <p>\u6ce8\u610f\u4e8b\u9879</p> <p>Kubernetes\u4f1a\u81ea\u52a8\u7ed9Pod\u6dfb\u52a0\u4e00\u4e2akey\u4e3anode.kubernetes.io/not-ready\u7684 Toleration\u5e76\u914d\u7f6etolerationSeconds=300\uff0c \u540c\u6837\u4e5f\u4f1a\u7ed9Pod\u6dfb\u52a0\u4e00\u4e2akey\u4e3a <code>node.kubernetes.io/unreachable</code>\u7684Toleration\u5e76\u914d\u7f6e tolerationSeconds=300\uff0c\u9664\u975e\u7528\u6237\u81ea\u5b9a\u4e49\u4e86\u4e0a\u8ff0key\uff0c\u5426\u5219\u4f1a\u91c7\u7528\u8fd9\u4e2a\u9ed8\u8ba4\u8bbe\u7f6e\uff0c \u610f\u601d\u5c31\u662f\u8bf4\u5982\u679c\u8282\u70b9\u7531\u4e8e\u67d0\u4e9b\u539f\u56e0\u9020\u6210\u4e0d\u53ef\u7528\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0bPod\u4f1a \u57285\u5206\u949f\u540e\u624d\u4f1a\u6f02\u79fb\u81f3\u5176\u4ed6\u8282\u70b9\uff0c\u5bf9\u4e8e\u8981\u6c42\u9ad8\u53ef\u7528\u7387\u7684Pod\u6309\u9700\u4fee\u6539\u8fd9\u4e24\u5904 \u7684tolerationSeconds\u4e3a\u8f83\u77ed\u7684\u503c\uff0c\u5c31\u53ef\u4ee5\u5728\u8282\u70b9\u6545\u969c\u540e\u5feb\u901f\u8fdb\u884c\u6545\u969c\u6062\u590d\uff0c\u5f53\u7136\u4e5f\u4e0d\u80fd\u592a\u77ed\uff0c\u56e0\u4e3a\u53ef\u80fd\u67d0\u4e9b\u8282\u70b9\u662f\u7531\u4e8e\u7f51\u7edc\u6ce2\u52a8\u9020\u6210\u7684\u4e0d\u53ef\u7528\uff0c\u6240\u4ee5\u8be5\u503c\u53ef\u4ee5\u6839\u636e\u5b9e\u9645\u9700\u6c42\u573a\u666f\u8fdb\u884c\u8bbe\u7f6e\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u81ea\u52a8\u6dfb\u52a0Toleration\u7684\u673a\u5236\u4fdd\u8bc1\u4e86\u5728\u5176\u4e2d\u4e00\u79cd\u95ee\u9898\u88ab\u68c0\u6d4b\u5230\u65f6\uff0cPod\u9ed8\u8ba4\u8fd8\u80fd\u7ee7\u7eed\u505c\u7559\u5728\u5f53\u524d\u8282\u70b9\u8fd0\u884c5\u5206\u949f\u3002</p> <p>\u8fd9\u4e24\u4e2a\u9ed8\u8ba4Toleration\u662f\u7531DefaultTolerationSeconds admission controller\u6dfb\u52a0\u7684\u3002</p> <p>DaemonSet\u4e2d\u7684Pod\u88ab\u521b\u5efa\u65f6\uff0c\u9488\u5bf9\u4ee5\u4e0bTaint\u81ea\u52a8\u6dfb\u52a0\u7684NoExecute\u7684Toleration\u5c06\u4e0d\u4f1a\u6307\u5b9atolerationSeconds\uff1a - node.alpha.kubernetes.io/unreachable\u3002 - node.kubernetes.io/not-ready\u3002</p> <p>\u8fd9\u4fdd\u8bc1\u4e86\u51fa\u73b0\u4e0a\u8ff0\u95ee\u9898\u65f6\uff0cDaemonSet\u4e2d\u7684Pod\u6c38\u8fdc\u4e0d\u4f1a\u88ab\u9a71\u9010\uff0c\u5f53\u7136DaemonSet\u7684Pod\u4e0d\u9700\u8981\u8fdb\u884c\u6f02\u79fb\u3002</p>"},{"location":"Kubernetes/3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/#5-affinity\u4eb2\u548c\u529b","title":"5. Affinity\u4eb2\u548c\u529b","text":""},{"location":"Kubernetes/4.%E9%AB%98%E7%BA%A7%E7%AF%87/12.%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AD%98%E5%82%A8Rook/","title":"\u4e91\u539f\u751f\u5b58\u50a8Rook","text":"<p>\u5728\u7b2c8\u7ae0\uff0c\u6211\u4eec\u5b66\u4e60\u4e86\u57fa\u4e8eCeph\u5206\u5e03\u5f0f\u7684Kubernetes\u52a8\u6001\u5b58\u50a8\u3002</p> <p>\u8bfb\u8005\u5728\u5b66\u4e60Kubernetes\u7684\u8fc7\u7a0b\u4e2d\uff0c\u53ef\u80fd\u5e76\u6ca1\u6709\u73b0\u6210\u7684Ceph\u96c6\u7fa4\u7528\u4e8e\u7ec3\u4e60\uff0c\u6216\u8005\u5728\u516c\u53f8\u5185\u90e8\uff0c\u9664\u4e86\u751f\u4ea7\u73af\u5883\u5e76\u6ca1\u6709\u4e00\u4e2a\u591a\u4f59\u7684Ceph\u96c6\u7fa4\uff0c\u56e0\u4e3a\u5efa\u7acbCeph\u96c6\u7fa4\u4e0d\u4ec5\u9700\u8981\u5927\u91cf\u7684\u670d\u52a1\u5668\u8d44\u6e90\uff0c\u672c\u8eab\u7684\u590d\u6742\u5ea6\u4e5f\u9700\u8981\u4eba\u529b\u6210\u672c\u3002</p> <p>\u4f46\u662f\u5728\u4f01\u4e1a\u5185\u90e8\u4f7f\u7528Kubernetes\u65f6\uff0c\u65e0\u8bba\u662f\u5728\u90e8\u7f72\u4e1a\u52a1\u670d\u52a1\u8fd8\u662f\u4e2d\u95f4\u4ef6\u670d\u52a1\uff0c\u90fd\u80fd\u5f88\u660e\u663e\u5730\u4f53\u4f1a\u5230Kubernetes\u7684\u4fbf\u5229\u6027\u548c\u5f3a\u5927\u4e4b\u5904\uff0c\u6240\u4ee5\u6211\u4eec\u5728\u4f01\u4e1a\u5185\u90e8\u4f7f\u7528Kubernetes\u65f6\uff0c\u540c\u65f6\u4e5f\u4f1a\u628a\u4e2d\u95f4\u4ef6\u670d\u52a1\uff08\u6bd4\u5982MySQL\u3001RabbitMQ\u3001Zookeeper\u7b49\uff09\u90e8\u7f72\u5728Kubernetes\u96c6\u7fa4\u4e2d\u3002</p> <p>\u76f8\u5bf9\u4e8e\u751f\u4ea7\u73af\u5883\uff0c\u4e5f\u9700\u8981\u4fdd\u7559\u5b83\u4eec\u7684\u6570\u636e\uff0c\u4f46\u662f\u975e\u751f\u4ea7\u73af\u5883\u53ef\u80fd\u5e76\u6ca1\u6709\u73b0\u6210\u7684\u5b58\u50a8\u5e73\u53f0\u4f9bKubernetes\u4f7f\u7528\uff0c\u65b0\u5efa\u4e00\u4e2a\u5e73\u53f0\u4f9b\u5176\u4f7f\u7528\u4e5f\u4f1a\u6d6a\u8d39\u5f88\u591a\u7cbe\u529b\u3002</p> <p>\u4e3a\u4e86\u89e3\u51b3\u975e\u751f\u4ea7\u73af\u5883\u7684\u6570\u636e\u6301\u4e45\u5316\u95ee\u9898\uff0c\u5f88\u591a\u516c\u53f8\u90fd\u91c7\u7528\u4e86NFS\u4f5c\u4e3a\u540e\u7aef\uff0c\u4f46\u662f\u4e00\u65e6\u4f7f\u7528\u7684\u5bb9\u5668\u8f83\u591a\u6216\u8005\u5b58\u50a8\u7684\u6570\u636e\u91cf\u6bd4\u8f83\u5927\uff0c\u5c31\u5bb9\u6613\u9020\u6210\u6027\u80fd\u95ee\u9898\uff0c\u5e76\u4e14NFS\u670d\u52a1\u5668\u4e00\u65e6\u51fa\u73b0\u95ee\u9898\uff0c\u6574\u4e2a\u6570\u636e\u53ef\u80fd\u4f1a\u5168\u90e8\u4e22\u5931\uff0c\u6240\u4ee5\u5728\u975e\u751f\u4ea7\u73af\u5883\u4e5f\u9700\u8981\u4e00\u4e2a\u9ad8\u53ef\u7528\u3001\u5206\u5e03\u5f0f\u5e76\u4e14\u514d\u8fd0\u7ef4\u7684\u5b58\u50a8\u5e73\u53f0\uff0c\u4e8e\u662fRook\u5c31\u8bde\u751f\u4e86\u3002</p> <p>Rook\u662f\u4e00\u4e2a\u81ea\u6211\u7ba1\u7406\u7684\u5206\u5e03\u5f0f\u5b58\u50a8\u7f16\u6392\u7cfb\u7edf\uff0c\u5b83\u672c\u8eab\u5e76\u4e0d\u662f\u5b58\u50a8\u7cfb\u7edf\uff0cRook\u5728\u5b58\u50a8\u548cKubernetes\u4e4b\u95f4\u642d\u5efa\u4e86\u4e00\u4e2a\u6865\u6881\uff0c\u4f7f\u5b58\u50a8\u7cfb\u7edf\u7684\u642d\u5efa\u6216\u8005\u7ef4\u62a4\u53d8\u5f97\u7279\u522b\u7b80\u5355\uff0cRook\u5c06\u5206\u5e03\u5f0f\u5b58\u50a8\u7cfb\u7edf\u8f6c\u53d8\u4e3a\u81ea\u6211\u7ba1\u7406\u3001\u81ea\u6211\u6269\u5c55\u3001\u81ea\u6211\u4fee\u590d\u7684\u5b58\u50a8\u670d\u52a1\u3002</p> <p>\u5b83\u8ba9\u4e00\u4e9b\u5b58\u50a8\u7684\u64cd\u4f5c\uff0c\u6bd4\u5982\u90e8\u7f72\u3001\u914d\u7f6e\u3001\u6269\u5bb9\u3001\u5347\u7ea7\u3001\u8fc1\u79fb\u3001\u707e\u96be\u6062\u590d\u3001\u76d1\u89c6\u548c\u8d44\u6e90\u7ba1\u7406\u53d8\u5f97\u81ea\u52a8\u5316\uff0c\u65e0\u987b\u4eba\u5de5\u5904\u7406\u3002\u540c\u65f6Rook\u652f\u6301CSI\uff0c\u53ef\u4ee5\u5229\u7528CSI\u505a\u4e00\u4e9bPVC\u7684\u5feb\u7167\u3001\u6269\u5bb9\u3001\u514b\u9686\u7b49\u64cd\u4f5c\u3002</p> <p>\u6709\u4e86Rook\u5c31\u53ef\u4ee5\u5728\u975e\u751f\u4ea7\u73af\u5883\u5feb\u901f\u5730\u642d\u5efa\u4e00\u4e2a\u5b58\u50a8\u7cfb\u7edf\uff0c\u7528\u6765\u6301\u4e45\u5316\u4e00\u4e9b\u5fc5\u9700\u7684\u6570\u636e\uff0c\u4e0d\u4ec5\u964d\u4f4e\u4e86\u8fd0\u7ef4\u590d\u6742\u5ea6\uff0c\u4e5f\u80fd\u66f4\u52a0\u65b9\u4fbf\u5730\u4f53\u9a8cKubernetes\u5e26 \u6765\u7684\u6536\u76ca\uff0c\u540c\u65f6\u4e5f\u53ef\u4ee5\u901a\u8fc7Rook\u6765\u6f14\u793a\u66f4\u591a\u7684Kubernetes\u5b58\u50a8\u7684\u9ad8\u7ea7\u529f\u80fd\u3002</p>"},{"location":"Kubernetes/4.%E9%AB%98%E7%BA%A7%E7%AF%87/12.%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AD%98%E5%82%A8Rook/#1rook\u7684\u5b89\u88c5","title":"1.Rook\u7684\u5b89\u88c5","text":"<p>Rook\u662f\u4e13\u95e8\u4e3aKubernetes\u8bbe\u8ba1\u7684\u4e91\u539f\u751f\u5b58\u50a8\uff0c\u6240\u4ee5\u5b83\u672c\u8eab\u548c\u7531Rook\u521b\u5efa\u7684Ceph\u96c6\u7fa4\u90fd\u662f\u90e8\u7f72\u5728Kubernetes\u5e73\u53f0\u4e0a\u7684\u3002\u672c\u4e66\u5b89\u88c5\u7684Rook\u7248\u672c\u4e3a v1.10.10\uff08\u672c\u4e66\u622a\u6b62\u524d\u6700\u65b0\u7248\uff09\uff0c\u6700\u65b0\u7248\u53ef\u4ee5\u901a\u8fc7\u5b98\u65b9\u6587\u6863https://rook.io\u83b7\u53d6\uff0c\u5176\u5b89\u88c5\u8fc7\u7a0b\u7c7b\u4f3c\u3002</p> <p>\u9996\u5148\u4e0b\u8f7dv1.10.10\u7248\u672c\u7684Rook\u6e90\u7801\uff0c\u672c\u7ae0\u6240\u6709\u793a\u4f8b\u5747\u53ef\u4ee5\u5728\u6e90\u7801\u4e2d\u627e\u5230\uff1a</p> <pre><code># git clone --single-branch --branch v1.10.10 https://github.com/rook/rook.git\n</code></pre>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/14.Kubernetes%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/","title":"Kubernetes\u65e5\u5fd7\u6536\u96c6","text":""},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/","title":"Kubernetes\u76d1\u63a7\u544a\u8b66","text":"<p>\u672c\u7ae0\u5c06\u5e26\u9886\u8bfb\u8005\u5b66?\u5982\u4f55\u5bf9Kubernetes\u96c6\u7fa4\u4ee5\u53ca\u90e8\u7f72\u7684\u5e94\u7528\u8fdb\u884c\u76d1\u63a7\u3002</p> <p>\u4f20\u7edf\u67b6\u6784\u4e2d\u6bd4\u8f83\u6d41\u884c\u7684\u76d1\u63a7\u5de5\u5177\u6709Zabbix\u3001Nagios\u7b49\uff0c\u8fd9\u4e9b\u76d1\u63a7\u5de5\u5177\u5bf9\u4e8eKubernetes\u8fd9\u7c7b\u4e91\u5e73\u53f0\u76d1\u63a7\u4e0d\u662f\u5f88\u53cb\u597d\uff0c\u7279\u522b\u662f\u5f53Kubernetes\u96c6\u7fa4\u4e2d\u6709\u4e86\u6210\u5343\u4e0a\u4e07\u7684\u5bb9\u5668\u540e\u66f4\u662f\u5982\u6b64\uff0c\u672c\u7ae0\u5c06\u5e26\u9886\u8bfb\u8005\u5b66\u4e60\u4e0b\u4e00\u4ee3\u7684\u4e91\u539f\u751f\u76d1\u63a7\u5e73\u53f0\u2014Prometheus\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#1prometheus\u7684\u67b6\u6784\u4ecb\u7ecd","title":"1.Prometheus\u7684\u67b6\u6784\u4ecb\u7ecd","text":"<p>Prometheus\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u7cfb\u7edf\u76d1\u63a7\u548c\u62a5\u8b66\u6846\u67b6\uff0c\u5176\u672c\u8eab\u4e5f\u662f\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5e93\uff08Time Series Database\uff0cTSDB),\u5b83\u7684\u8bbe\u8ba1\u7075\u611f\u6765\u6e90\u4e8eGoogle\u7684Borgmon\uff0c\u5c31\u50cfKubernetes\u662f\u57fa\u4e8eBorg\u7cfb\u7edf\u5f00\u6e90\u7684\u3002</p> <p>Prometheus\u662f\u7531Sound Cloud\u7684Google\u524d\u5458\u5de5\u8bbe\u8ba1\u5e76\u5f00\u6e90\u7684\uff0c\u5b98\u65b9\u7f51\u7ad9\u4e3ahttps://prometheus.io/\u3002 Prometheus\u4e8e2016\u5e74\u52a0\u5165\u4e91\u539f\u751f\u8ba1\u7b97\u57fa\u91d1\u4f1a\uff08Cloud Native Computing Foundation\uff0cCNCF\uff09,\u6210\u4e3a\u53d7\u6b22\u8fce\u7a0b\u5ea6\u4ec5\u6b21\u4e8eKubernetes\u7684\u5f00\u6e90\u9879\u76ee\u3002</p> <p>\u8be5\u9879\u76ee\u62e5\u6709\u975e\u5e38\u6d3b\u8dc3\u7684\u5f00\u53d1\u8005\u548c\u7528\u6237\u793e\u533a\uff0c\u76ee\u524d\u5df2\u7ecf\u88ab\u5f88\u591a\u516c\u53f8\u91c7\u7528\uff0c\u5e76\u4e14\u90e8\u5206\u516c\u53f8\u4e5f\u53c2\u4e0e\u4e86\u8be5\u9879\u76ee\u7684\u7ef4\u62a4\u3002</p> <p>Prometheus\u88ab\u79f0\u4e3a\u4e0b\u4e00\u4ee3\u7684\u76d1\u63a7\u5e73\u53f0\uff0c\u5177\u6709\u5f88\u591a\u548c\u201c\u8001\u724c\u201d\u76d1\u63a7\u4e0d\u4e00\u6837\u7684\u7279\u6027\uff0c\u6bd4\u5982\uff1a</p> <ul> <li>\u4e00\u4e2a\u591a\u7ef4\u7684\u6570\u636e\u6a21\u578b\uff0c\u5177\u6709\u7531\u6307\u6807\u540d\u79f0\u548c\u952e-\u503c\u5bf9\u6807\u8bc6\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u3002</li> <li>\u4f7f\u7528PromQL\u67e5\u8be2\u548c\u805a\u5408\u6570\u636e\uff0c\u53ef\u4ee5\u975e\u5e38\u7075\u6d3b\u5730\u5bf9\u6570\u636e\u8fdb\u884c\u68c0\u7d22\u3002</li> <li>\u4e0d\u4f9d\u8d56\u989d\u5916\u7684\u6570\u636e\u5b58\u50a8\uff0cPrometheus\u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u65f6\u5e8f\u6570\u636e\u5e93\uff0c\u63d0\u4f9b\u672c\u5730\u5b58\u50a8\u548c\u5206\u5e03\u5f0f\u5b58\u50a8\uff0c\u5e76\u4e14\u6bcf\u4e2aPrometheus\u90fd\u662f\u81ea\u6cbb\u7684\u3002</li> <li>\u5e94\u7528\u7a0b\u5e8f\u66b4\u9732Metrics\u63a5\u53e3\uff0cPrometheus\u901a\u8fc7\u57fa\u4e8eHTTP\u7684Pull\u6a21\u578b\u91c7\u96c6\u6570\u636e\u3002</li> <li>\u540c\u65f6\u53ef\u4ee5\u4f7f\u7528PushGateway\u8fdb\u884cPush\u6570\u636e\u3002</li> <li>Prometheus\u540c\u65f6\u652f\u6301\u52a8\u6001\u670d\u52a1\u548c\u9759\u6001\u914d\u7f6e\u53d1\u73b0\u76ee\u6807\u673a\u5668\u3002</li> <li>\u652f\u6301\u591a\u79cd\u56fe\u5f62\u548c\u4eea\u8868\u76d8\uff0c\u548cGrafana\u582a\u79f0\u201c\u7edd\u914d\u201d</li> </ul> <p>Prometheus\u751f\u6001\u7cfb\u7edf\u7531\u591a\u4e2a\u7ec4\u4ef6\u7ec4\u6210\uff0c\u5176\u67b6\u6784\u56fe\u5982\u56fe15.1\u6240\u793a\u3002</p> <p>) \u56fe15.1\u3000Prometheus\u67b6\u6784</p> <p>\u867d\u7136Prometheus\u7684\u7ec4\u4ef6\u6709\u5f88\u591a\uff0c\u4f46\u662f\u5f88\u591a\u7ec4\u4ef6\u90fd\u662f\u53ef\u9009\u7684\uff0c\u6240\u4ee5Prometheus\u8981\u6bd4\u5176\u4ed6\u76d1\u63a7\u5e73\u53f0\u66f4\u7075\u6d3b\u3002\u63a5\u4e0b\u6765\u770b\u4e00\u4e0b\u6bcf\u4e2a\u7ec4\u4ef6\u7684\u7528\u9014\u3002</p> <p>Prometheus Server\uff1aPrometheus\u751f\u6001\u6700\u91cd\u8981\u7684\u7ec4\u4ef6\uff0c\u4e3b\u8981\u7528\u4e8e\u6293\u53d6\u548c\u5b58\u50a8\u65f6\u95f4\u5e8f\u5217\u6570\u636e\uff0c\u540c\u65f6\u63d0\u4f9b\u6570\u636e\u7684\u67e5\u8be2\u548c\u544a\u8b66\u7b56\u7565\u7684\u914d\u7f6e\u7ba1 \u7406\u3002</p> <ul> <li> <p>Alertmanager\uff1aPrometheus\u751f\u6001\u7528\u4e8e\u544a\u8b66\u7684\u7ec4\u4ef6\uff0cPrometheus Server\u4f1a\u5c06\u544a\u8b66\u53d1\u9001\u7ed9Alertmanager\uff0cAlertmanager\u6839\u636e\u8def\u7531\u914d\u7f6e   \u5c06\u544a\u8b66\u4fe1\u606f\u53d1\u9001\u7ed9\u6307\u5b9a\u7684\u4eba\u6216\u7ec4\u3002Alertmanager\u652f\u6301\u90ae\u4ef6\u3001Webhook\u3001\u5fae\u4fe1\u3001\u9489\u9489\u3001\u77ed\u4fe1\u7b49\u5a92\u4ecb\u8fdb\u884c\u544a\u8b66\u901a\u77e5\u3002</p> </li> <li> <p>Grafana\uff1a\u7528\u4e8e\u5c55\u793a\u6570\u636e\uff0c\u4fbf\u4e8e\u6570\u636e\u7684\u67e5\u8be2\u548c\u89c2\u6d4b\u3002</p> </li> <li> <p>Push Gateway\uff1aPrometheus\u672c\u8eab\u662f\u901a\u8fc7Pull\u7684\u65b9\u5f0f\u62c9\u53d6\u6570\u636e\u7684\uff0c\u4f46\u662f\u6709\u4e9b\u76d1\u63a7\u6570\u636e\u53ef\u80fd\u662f\u77ed\u671f\u7684\uff0c\u5982\u679c\u6ca1\u6709\u91c7\u96c6\u6570\u636e\u53ef\u80fd\u4f1a\u51fa\u73b0\u4e22   \u5931\u3002Push Gateway\u53ef\u4ee5\u7528\u6765\u89e3\u51b3\u6b64\u7c7b\u95ee\u9898\uff0c\u5b83\u53ef\u4ee5\u7528\u6765\u63a5\u6536\u6570\u636e\uff0c\u4e5f\u5c31\u662f\u5ba2\u6237\u7aef\u53ef\u4ee5\u901a\u8fc7Push\u7684\u65b9\u5f0f\u5c06\u6570\u636e\u63a8\u9001\u5230Push Gateway\uff0c\u4e4b\u540ePrometheus\u53ef\u4ee5\u901a\u8fc7Pull\u62c9\u53d6\u8be5\u6570\u636e\u3002</p> </li> <li> <p>Exporter\uff1a\u4e3b\u8981\u7528\u6765\u91c7\u96c6\u76d1\u63a7\u6570\u636e\uff0c\u6bd4\u5982\u4e3b\u673a\u7684\u76d1\u63a7\u6570\u636e\u53ef\u4ee5\u901a\u8fc7node_exporter\u91c7\u96c6\uff0cMySQL\u7684\u76d1\u63a7\u6570\u636e\u53ef\u4ee5\u901a\u8fc7mysql_exporter\u91c7\u96c6\uff0c\u4e4b\u540eExporter\u66b4\u9732\u4e00\u4e2a\u63a5\u53e3\uff0c\u6bd4\u5982/metrics\uff0cPrometheus\u53ef\u4ee5\u901a\u8fc7\u8be5\u63a5\u53e3\u91c7\u96c6\u5230\u6570\u636e\u3002</p> </li> <li> <p>PromQL\uff1aPromQL\u5176\u5b9e\u4e0d\u7b97Prometheus\u7684\u7ec4\u4ef6\uff0c\u5b83\u662f\u7528\u6765\u67e5\u8be2\u6570\u636e\u7684   \u4e00\u79cd\u8bed\u6cd5\uff0c\u6bd4\u5982\u53ef\u4ee5\u901a\u8fc7SQL\u8bed\u53e5\u67e5\u8be2\u6570\u636e\u5e93\u7684\u6570\u636e\uff0c\u901a\u8fc7LogQL\u8bed\u53e5\u67e5\u8be2Loki\u7684\u6570\u636e\uff0c\u901a\u8fc7PromQL\u8bed\u53e5\u67e5\u8be2Prometheus\u7684\u6570\u636e\u3002</p> </li> <li> <p>Service Discovery\uff1a\u7528\u6765\u53d1\u73b0\u76d1\u63a7\u76ee\u6807\u7684\u81ea\u52a8\u53d1\u73b0\uff0c\u5e38\u7528\u7684\u6709\u57fa\u4e8eKubernetes\u3001Consul\u3001Eureka\u3001\u6587\u4ef6\u7684\u81ea\u52a8\u53d1\u73b0\u7b49\u3002</p> </li> </ul> <p>\u4ee5\u4e0a\u5bf9Prometheus\u8fdb\u884c\u4e86\u7b80\u5355\u7684\u4ecb\u7ecd\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u4e0a\u624b\u4f53\u9a8cPrometheus\u7684\u5f3a\u5927\u4e4b\u5904\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#2prometheus\u7684\u5b89\u88c5","title":"2.Prometheus\u7684\u5b89\u88c5","text":"<p>Prometheus\u6709\u591a\u79cd\u5b89\u88c5\u65b9\u5f0f\uff0c\u6bd4\u5982\u4e8c\u8fdb\u5236\u5b89\u88c5\u3001\u5bb9\u5668\u5b89\u88c5\u548cKubernetes \u96c6\u7fa4\u4e2d\u5b89\u88c5\uff0c\u7531\u4e8e\u672c\u4e66\u662f\u57fa\u4e8eKubernetes\u5c55\u5f00\u7684\uff0c\u56e0\u6b64\u4f1a\u5c06Prometheus\u5b89\u88c5\u5230Kubernetes\u96c6\u7fa4\u4e2d\uff0c\u5f53\u7136\u8fd9\u4e5f\u662f\u5b98\u65b9\u63a8\u8350\u7684\u90e8\u7f72\u65b9\u5f0f\u3002</p> <p>\u5c06Prometheus\u5b89\u88c5\u5230Kubernetes\u96c6\u7fa4\u4e5f\u6709\u5f88\u591a\u65b9\u5f0f\uff0c\u6bd4\u5982\u4e4b\u524d\u63d0\u5230\u8fc7\u7684Helm\u3001Operator\u7b49\uff0cPrometheus\u4e5f\u662f\u652f\u6301\u4e0a\u8ff0\u5b89\u88c5\u65b9\u5f0f\u7684\u3002</p> <p>\u4f46\u662fPrometheus\u662f\u4e00\u4e2a\u751f\u6001\u7cfb\u7edf\uff0c\u6709\u5f88\u591a\u7ec4\u4ef6\u90fd\u9700\u8981\u5b89\u88c5\uff0c\u5e76\u4e14\u4e5f\u6709\u5f88\u591a\u76d1\u63a7\u9700\u8981\u5355\u72ec\u914d\u7f6e\uff0c\u4e8e\u662fPrometheus\u5b98\u65b9\u5f00\u6e90\u4e86\u4e00\u4e2akube-prometheus\u9879\u76ee\uff0c\u8be5\u9879\u76ee\u4e0d\u4ec5\u4ec5\u662f\u7528\u6765\u5b89\u88c5Prometheus\u7684\uff0c\u4e5f\u5305\u542b\u5f88\u591a\u5176\u4ed6\u7684\u7ec4\u4ef6\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <ul> <li>Prometheus Operator\u3002</li> <li>\u9ad8\u53ef\u7528\u7684Prometheus\u3002</li> <li>\u9ad8\u53ef\u7528\u7684Alertmanager\u3002</li> <li>\u4e3b\u673a\u76d1\u63a7Node Exporter\u3002</li> <li>Prometheus Adapter\u3002</li> <li>\u5bb9\u5668\u76d1\u63a7kube-state-metrics\u3002</li> <li>\u56fe\u5f62\u5316\u5c55\u793aGrafana\u3002</li> </ul> <p>\u5177\u4f53\u53ef\u4ee5\u901a\u8fc7https://github.com/prometheus-operator/kube-prometheus/\u627e\u5230\u8be5\u9879\u76ee\u8fdb\u884c\u67e5\u770b\u3002</p> <p>\u6709\u4e86kube-prometheus\u9879\u76ee\uff0c\u5bf9\u5176\u7684\u5b89\u88c5\u4e5f\u53d8\u5f97\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u4e24\u6761\u547d\u4ee4\u5373\u53ef\u3002</p> <p>\u9996\u5148\u9700\u8981\u901a\u8fc7\u8be5\u9879\u76ee\u5730\u5740\u627e\u5230\u548c\u81ea\u5df1Kubernetes\u7248\u672c\u5bf9\u5e94\u7684Kube Prometheus Stack\u7684\u7248\u672c\uff0c\u5982\u56fe15.2\u6240\u793a\u3002</p> <p>)</p> <p>\u56fe15.2\u3000Prometheus\u7248\u672c\u9009\u62e9</p> <p>\u4e4b\u540e\u5c06\u8be5\u9879\u76ee\u5bf9\u5e94\u5206\u652f\u514b\u9686\u5230\u672c\u5730\uff1a</p> <p>kubernetes1.21\u4f7f\u7528\u5982\u4e0b\u65b9\u5f0f <pre><code># git clone -b release-0.9 https://github.com/prometheus-operator/kube-prometheus.git\n# cd kube-prometheus/manifests\n</code></pre></p> <p>kubernetes1.20\u4f7f\u7528\u5982\u4e0b\u65b9\u5f0f <pre><code># git clone https://github.com/prometheus-operator/kube-prometheus.git\n# cd kube-prometheus\n# git checkout -b origin/release-0.8 remotes/origin/release-0.8\n# cd manifests/\n</code></pre></p> <p>\u9996\u5148\u5b89\u88c5Prometheus Operator\uff1a</p> <pre><code># kubectl create -f setup/\nnamespace/monitoring created\n...\ndeployment.apps/prometheus-operator created\nservice/prometheus-operator created\nserviceaccount/prometheus-operator created\n</code></pre> <p>\u67e5\u770bOperator\u5bb9\u5668\u7684\u72b6\u6001\uff1a</p> <pre><code># kubectl get pod -n monitoring\nNAME                                   READY   STATUS    RESTARTS   AGE\nprometheus-operator-75d9b475d9-pk8qb   2/2     Running   0          4m16s\n</code></pre> <p>\u6570\u636e\u6301\u4e45\u5316</p> <p>\u914d\u7f6eprometheus\u6301\u4e45\u5316\u7684\u914d\u7f6e\u6e05\u5355\uff1a</p> <p>prometheus-prometheus.yaml</p> <pre><code>  image: quay.io/prometheus/prometheus:v2.26.0\nenv:\n- name: TZ\nvalue: \"Asia/Shanghai\"\n......\nretention: 15d\nstorage:\nvolumeClaimTemplate:\nspec:\nstorageClassName: gitee-nfs-client\nresources:\nrequests:\nstorage: 20Gi\n</code></pre> <p>\u914d\u7f6egrafana\u6301\u4e45\u5316\u7684\u914d\u7f6e\u6e05\u5355\uff1a</p> <p>grafana-pvc.yaml</p> <pre><code># mkdir grafana-pvc \n# vim grafana-pvc.yaml\n</code></pre> <pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\nname: grafana-pvc\nnamespace: monitoring\nspec:\naccessModes:\n- ReadWriteMany\nresources:\nrequests:\nstorage: 20M\nstorageClassName: gitee-nfs-client\n</code></pre> <p>grafana-deployment.yaml</p> <pre><code>.......\nspec:\ncontainers:\n# \u56fa\u5b9agrafana\u7684\u767b\u9646\u5bc6\u7801\n- env:\n- name: GF_SECURITY_ADMIN_USER\nvalue: admin\n- name: GF_SECURITY_ADMIN_PASSWORD\nvalue: oschina123\n- name: TZ\nvalue: Asia/Shanghai\n# image: grafana/grafana:8.1.1\nimage: grafana/grafana:8.4.7\nname: grafana\nports:\n- containerPort: 3000\nname: http\nreadinessProbe:\nhttpGet:\npath: /api/health\nport: http\nresources:\nlimits:\ncpu: 200m\nmemory: 200Mi\nrequests:\ncpu: 100m\nmemory: 100Mi\n.......\nnodeSelector:\nkubernetes.io/os: linux\nsecurityContext:\nfsGroup: 65534\nrunAsNonRoot: true\nrunAsUser: 65534\nserviceAccountName: grafana\nvolumes:\n# \u6301\u4e45\u5316pvc\n- name: grafana-storage\npersistentVolumeClaim:\nclaimName: grafana-pvc\n.......\n</code></pre> <p>\u914d\u7f6ealertmanager\u6301\u4e45\u5316\u7684\u914d\u7f6e\u6e05\u5355\uff1a</p> <p>alertmanager-alertmanager.yaml</p> <pre><code>....\nretention: 24h\nstorage:\nvolumeClaimTemplate:\nspec:\nstorageClassName: gitee-nfs-client\nresources:\nrequests:\nstorage: 10Gi\n</code></pre> <p>\u53c2\u8003\u6587\u732e</p> <p>https://www.lhl.zone/virtualization/kube-prometheus/102.html</p> <p>Operator\u5bb9\u5668\u542f\u52a8\u540e\uff0c\u5b89\u88c5Prometheus Stack\uff1a</p> <pre><code># kubectl create -f .\nalertmanager.monitoring.coreos.com/main created\nWarning: policy/v1beta1 PodDisruptionBudget is deprecated in v1.21+, unavailable in v1.25+; use policy/v1 PodDisruptionBudget\npoddisruptionbudget.policy/alertmanager-main created\nprometheusrule.monitoring.coreos.com/alertmanager-main-rules created\n....\nrole.rbac.authorization.k8s.io/prometheus-k8s-config created\nrole.rbac.authorization.k8s.io/prometheus-k8s created\nrole.rbac.authorization.k8s.io/prometheus-k8s created\nrole.rbac.authorization.k8s.io/prometheus-k8s created\nservice/prometheus-k8s created\nserviceaccount/prometheus-k8s created\nservicemonitor.monitoring.coreos.com/prometheus-k8s created\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u6709\u4e00\u4e9b\u8d44\u6e90\u7684\u955c\u50cf\u6765\u81ea\u4e8e <code>k8s.gcr.io</code>\uff0c\u5982\u679c\u4e0d\u80fd\u6b63\u5e38\u62c9\u53d6\uff0c\u5219\u53ef\u4ee5\u5c06\u955c\u50cf\u66ff\u6362\u6210\u53ef\u62c9\u53d6\u7684\uff1a</p> <ul> <li><code>prometheusAdapter-deployment.yaml</code>\uff1a\u5c06 <code>image: k8s.gcr.io/prometheus-adapter/prometheus-adapter:v0.9.1</code> \u66ff\u6362\u4e3a <code>cnych/prometheus-adapter:v0.9.1</code></li> <li><code>kubeStateMetrics-deployment.yaml</code>\uff1a\u5c06 <code>image: k8s.gcr.io/kube-state-metrics/kube-state-metrics:v2.4.2</code> \u66ff\u6362\u4e3a <code>cnych/kube-state-metrics:v2.4.2</code></li> </ul> <pre><code># sed 's#k8s.gcr.io/kube-state-metrics/kube-state-metrics:v2.1.1#cnych/kube-state-metrics:v2.4.2#g' -i *.yaml\n# sed 's#k8s.gcr.io/prometheus-adapter/prometheus-adapter:v0.9.0#cnych/prometheus-adapter:v0.9.1#g' -i *.yaml\n</code></pre> <p>\u8fd9\u4f1a\u81ea\u52a8\u5b89\u88c5 prometheus-operator\u3001node-exporter\u3001kube-state-metrics\u3001grafana\u3001prometheus-adapter \u4ee5\u53ca prometheus \u548c alertmanager \u7b49\u5927\u91cf\u7ec4\u4ef6\uff0c\u5982\u679c\u6ca1\u6210\u529f\u53ef\u4ee5\u591a\u6b21\u6267\u884c\u4e0a\u9762\u7684\u5b89\u88c5\u547d\u4ee4\u3002</p> <p>\u67e5\u770bPrometheus\u5bb9\u5668\u7684\u72b6\u6001\uff1a</p> <pre><code># kubectl get pods -n monitoring\nNAME                                   READY   STATUS    RESTARTS   AGE\nalertmanager-main-0                    2/2     Running   0          6m41s\nalertmanager-main-1                    2/2     Running   0          6m41s\nalertmanager-main-2                    2/2     Running   0          6m41s\nblackbox-exporter-6798fb5bb4-9rg5s     3/3     Running   0          6m41s\ngrafana-7476b4c65b-6qrxh               1/1     Running   0          6m40s\nkube-state-metrics-64c7ff87dc-8b4bs    3/3     Running   0          6m40s\nnode-exporter-2f2h2                    2/2     Running   0          6m40s\nnode-exporter-2zcbr                    2/2     Running   0          6m40s\nnode-exporter-5txxx                    2/2     Running   0          6m40s\nnode-exporter-7wxp6                    2/2     Running   0          6m40s\nnode-exporter-99wrh                    2/2     Running   0          6m40s\nnode-exporter-dcfdn                    2/2     Running   0          6m40s\nnode-exporter-g7hl9                    2/2     Running   0          6m40s\nnode-exporter-hsgwx                    2/2     Running   0          6m40s\nnode-exporter-jp8qs                    2/2     Running   0          6m40s\nprometheus-adapter-77774d7447-r7m9p    1/1     Running   0          6m40s\nprometheus-adapter-77774d7447-xjcm5    1/1     Running   0          6m40s\nprometheus-k8s-0                       2/2     Running   0          6m39s\nprometheus-k8s-1                       2/2     Running   0          6m39s\nprometheus-operator-75d9b475d9-pk8qb   2/2     Running   0          97m\n\n# kubectl get svc -n monitoring\nNAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE\nalertmanager-main       ClusterIP   10.111.159.143   &lt;none&gt;        9093/TCP                     6m58s\nalertmanager-operated   ClusterIP   None             &lt;none&gt;        9093/TCP,9094/TCP,9094/UDP   6m58s\nblackbox-exporter       ClusterIP   10.103.27.127    &lt;none&gt;        9115/TCP,19115/TCP           6m58s\ngrafana                 ClusterIP   10.102.99.88     &lt;none&gt;        3000/TCP                     6m57s\nkube-state-metrics      ClusterIP   None             &lt;none&gt;        8443/TCP,9443/TCP            6m57s\nnode-exporter           ClusterIP   None             &lt;none&gt;        9100/TCP                     6m57s\nprometheus-adapter      ClusterIP   10.110.138.216   &lt;none&gt;        443/TCP                      6m57s\nprometheus-k8s          ClusterIP   10.106.193.178   &lt;none&gt;        9090/TCP                     6m56s\nprometheus-operated     ClusterIP   None             &lt;none&gt;        9090/TCP                     6m56s\nprometheus-operator     ClusterIP   None             &lt;none&gt;        8443/TCP                     97m\n</code></pre> <p>\u5f85\u5bb9\u5668\u5168\u90e8\u4e0b\u8f7d\u5b8c\u6210(\u9996\u6b21\u5b89\u88c5\u955c\u50cf\u4e0b\u8f7d\u53ef\u80fd\u4f1a\u5f88\u6162)\u5e76\u4e14\u542f\u52a8\u540e\uff0c\u53ef\u4ee5\u8bbf\u95eeGrafana\u548cPrometheus \u3002</p> <p>\u5728\u6267\u884c\u5b89\u88c5\u65f6\u4f1a\u81ea\u52a8\u521b\u5efaGrafana\u548cPrometheus\u7684Service\uff0c\u53ef\u4ee5\u901a\u8fc7NodePort\u6216\u8005Ingress\u7684\u65b9\u5f0f\u8bbf\u95ee\uff0c\u5728\u6b64\u6f14\u793a\u7684\u4e3aNodePort\u65b9\u5f0f\u3002</p> <p>\u9996\u5148\u5c06Grafana\u7684Service\u6539\u6210NodePort\u7c7b\u578b\uff1a</p> <pre><code># kubectl edit svc grafana -n monitoring\nselector:\n    app.kubernetes.io/component: grafana\n    app.kubernetes.io/name: grafana\n    app.kubernetes.io/part-of: kube-prometheus\n  sessionAffinity: None\n  # \u66f4\u6539Grafana\u7684Service\u7c7b\u578b\ntype: NodePort\n</code></pre> <p>\u6216\u8005\u76f4\u63a5\u4fee\u6539<code>grafana-service.yaml</code>\u6587\u4ef6\u5185\u5bb9 <pre><code>apiVersion: v1\nkind: Service\nmetadata:\nlabels:\napp.kubernetes.io/component: grafana\napp.kubernetes.io/name: grafana\napp.kubernetes.io/part-of: kube-prometheus\napp.kubernetes.io/version: 7.5.4\nname: grafana\nnamespace: monitoring\nspec:\ntype: NodePort\nports:\n- name: http\nport: 3000\nnodePort: 30030\ntargetPort: http\nselector:\napp.kubernetes.io/component: grafana\napp.kubernetes.io/name: grafana\napp.kubernetes.io/part-of: kube-prometheus\n</code></pre></p> <p>\u67e5\u770bGrafana Service\u7684NodePort\uff1a</p> <pre><code># kubectl get svc grafana -n monitoring\nNAME      TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE\ngrafana   NodePort   10.102.99.88   &lt;none&gt;        3000:31790/TCP   8m55s\n</code></pre> <p>\u4e4b\u540e\u901a\u8fc7\u4efb\u610f\u4e00\u4e2a\u5b89\u88c5\u4e86kube-proxy\u670d\u52a1\u7684\u8282\u70b9IP+31790\u7aef\u53e3\u5373\u53ef\u8bbf\u95eeGrafana\uff0c\u5982\u56fe15.4\u6240\u793a\u3002</p> <p>)</p> <p>Grafana\u9ed8\u8ba4\u767b\u5f55\u7684\u8d26\u53f7\u548c\u5bc6\u7801\u4e3aadmin/admin\uff0c\u767b\u5f55\u4f1a\u63d0\u793a\u66f4\u6539\u5bc6\u7801\uff0c\u4e5f\u53ef\u4ee5\u5355\u51fbskip\u4e0d\u66f4\u6539\u5bc6\u7801\u3002\u7136\u540e\u4ee5\u76f8\u540c\u7684\u65b9\u5f0f\u66f4\u6539Prometheus\u7684Service\u4e3aNodePort\uff1a</p> <pre><code># kubectl edit svc prometheus-k8s -n monitoring\nselector:\n    app: prometheus\n    app.kubernetes.io/component: prometheus\n    app.kubernetes.io/name: prometheus\n    app.kubernetes.io/part-of: kube-prometheus\n    prometheus: k8s\n  sessionAffinity: ClientIP\n  sessionAffinityConfig:\n    clientIP:\n      timeoutSeconds: 10800\n# \u66f4\u6539prometheus\u7684Service\u7c7b\u578b\ntype: NodePort\n\n# kubectl get svc prometheus-k8s -n monitoring\nNAME             TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nprometheus-k8s   NodePort   10.106.193.178   &lt;none&gt;        9090:31635/TCP   13m\n</code></pre> <p>\u6700\u540e\u901a\u8fc7\u4efb\u610f\u4e00\u4e2a\u5b89\u88c5\u4e86kube-proxy\u670d\u52a1\u7684\u8282\u70b9IP+31635\u7aef\u53e3\u5373\u53ef\u8bbf\u95eePrometheus\u7684Web UI\uff0c\u5982\u56fe15.5\u6240\u793a\u3002</p> <p>) \u56fe15.5 \u8bbf\u95eePrometheus Web UI</p> <p>\u63d0\u793a</p> <p>\u9ed8\u8ba4\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u4f1a\u6709\u51e0\u4e2a\u544a\u8b66\uff0c\u5148\u5ffd\u7565\u3002</p> <p>\u5982\u679c\u8981\u6e05\u7406 Prometheus-Operator\uff0c\u53ef\u4ee5\u76f4\u63a5\u5220\u9664\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u5373\u53ef\uff1a</p> <pre><code># kubectl delete -f kube-prometheus/manifests/\n# kubectl delete -f kube-prometheus/manifests/setup/\n</code></pre>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#3\u4e91\u539f\u751f\u548c\u975e\u4e91\u539f\u751f\u5e94\u7528\u7684\u76d1\u63a7\u6d41\u7a0b","title":"3.\u4e91\u539f\u751f\u548c\u975e\u4e91\u539f\u751f\u5e94\u7528\u7684\u76d1\u63a7\u6d41\u7a0b","text":"<p>\u901a\u8fc7\u524d\u9762\u7684\u5b66?\uff0c\u53ef\u4ee5\u770b\u5230\u53ea\u9700\u8981\u51e0\u6761\u547d\u4ee4\u5373\u53ef\u5b8c\u6210Prometheus Stack\u7684\u5b89\u88c5\uff0c\u63a5\u4e0b\u6765\u5f00\u59cb\u4ecb\u7ecdPrometheus\u662f\u5982\u4f55\u6293\u53d6\u6570\u636e\u7684\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#31-\u76d1\u63a7\u6570\u636e\u6765\u6e90","title":"3.1 \u76d1\u63a7\u6570\u636e\u6765\u6e90","text":"<p>\u4ecePrometheus\u7684\u67b6\u6784\u4e2d\u4e86\u89e3\u5230\uff0cPrometheus\u901a\u5e38\u91c7\u7528Pull\u7684\u5f62\u5f0f\u6765\u62c9\u53d6\u6570\u636e\uff0c\u4e5f\u5c31\u610f\u5473\u7740\u88ab\u76d1\u63a7\u5e94\u7528\u53ea\u8981\u6709\u4e00\u4e2a\u80fd\u83b7\u53d6\u5230\u76d1\u63a7\u6570\u636e\u7684\u63a5\u53e3\uff0c\u5c31\u53ef\u4ee5\u91c7\u96c6\u5230\u76d1\u63a7\u6570\u636e\uff0c\u6240\u4ee5\u63a5\u4e0b\u6765\u8bb2\u4e00\u4e0b\u8fd9\u4e2a\u63a5\u53e3\u4ece\u4f55\u800c\u6765\u3002</p> <p>\u5982\u679c\u8bfb\u8005\u4ece\u4e8b\u4e91\u76f8\u5173\u7684\u5de5\u4f5c\uff0c\u80af\u5b9a\u90fd\u542c\u8bf4\u8fc7\u4e91\u539f\u751f\u8fd9\u4e2a\u8bcd\u8bed\uff0c\u5176\u4e2d\u4e91\u539f\u751f\u6d89\u53ca12\u4e2a\u5173\u952e\u8981\u7d20\uff0c\u5176\u4e2d\u4e00\u9879\u5c31\u662f\u5e94\u7528\u7684\u5f00\u53d1\u8005\u5728\u8fdb\u884c\u76f8\u5173\u7a0b\u5e8f\u5f00\u53d1\u65f6\uff0c\u8981\u8003\u8651\u7a0b\u5e8f\u672c\u8eab\u4e00\u4e9b\u5185\u90e8\u7684\u8fd0\u884c\u60c5\u51b5\uff0c\u6bd4\u5982\u7a0b\u5e8f\u5f53\u524d\u7684\u8fde\u63a5\u6570\u3001\u8d44\u6e90\u5360\u7528\u60c5\u51b5\u7b49\uff0c\u6b64\u65f6\u53ef\u4ee5\u5f15\u7528Prometheus\u7684\u5ba2\u6237\u7aef\u5de5\u5177\u6765\u91c7\u96c6\u5e76\u66b4\u9732\u6570\u636e\uff0c\u4e5f\u5c31\u662f\u57fa\u4e8e\u4e91\u539f\u751f\u7406\u5ff5\u5f00\u53d1\u7684\u7a0b\u5e8f\u81ea\u5df1\u4f1a\u66b4\u9732Metrics\u63a5\u53e3\uff0c\u5c31\u50cfKubernetes\u672c\u8eab\u7684\u7ec4\u4ef6\u3001Etcd\u7b49\uff0c\u90fd\u6709\u4e00\u4e2a/metrics\u63a5\u53e3\uff0cPrometheus\u53ea\u9700\u8981\u8bf7\u6c42\u8fd9\u4e2a\u63a5\u53e3\u5373\u53ef\u83b7\u53d6\u5230\u76f8\u5173\u6570\u636e\u3002</p> <p>\u57fa\u4e8e\u4e91\u539f\u751f\u7406\u5ff5\u5f00\u53d1\u7684\u7a0b\u5e8f\u5927\u90e8\u5206\u90fd\u6709\u76f8\u5173\u63a5\u53e3\uff0c\u4f46\u662f\u6709\u5f88\u591a\u5e94\u7528\u5e76\u975e\u662f\u57fa\u4e8e\u4e91\u539f\u751f\u7406\u5ff5\u5f00\u53d1\u7684\uff0c\u6240\u4ee5\u6ca1\u6709\u6b64\u7c7b\u63a5\u53e3\uff0c\u6bd4\u5982MySQL\u3001Redis\u7b49\u3002</p> <p>\u90a3\u4e48\u5982\u4f55\u91c7\u96c6\u8fd9\u7c7b\u7a0b\u5e8f\u7684\u76d1\u63a7\u6570\u636e\u5462\uff1f\u8fd9\u4e2a\u65f6\u5019\u5728\u8bb2\u89e3Prometheus\u67b6\u6784\u65f6\u63d0\u5230\u7684Exporter\u5c31\u6d3e\u4e0a\u7528\u573a\u4e86\uff0cExporter\u4e3b\u8981\u7528\u6765\u91c7\u96c6\u975e\u4e91\u539f\u751f\u5e94\u7528\u7684\u5185\u90e8\u6570\u636e\uff0c\u5b83\u53ef\u4ee5\u901a\u8fc7\u67d0\u4e9b\u673a\u5236\uff08\u6bd4\u5982\u8c03\u7528\u63a5\u53e3\u3001\u6267\u884c\u5ba2\u6237\u7aef\u547d\u540d\uff09\u6765\u83b7\u53d6\u5185\u90e8\u4e00\u4e9b\u6bd4\u8f83\u91cd\u8981\u7684\u6570\u636e\uff0c\u7136\u540e\u5c06\u5176\u8f6c\u6362\u6210Prometheus\u80fd\u591f\u8bc6\u522b\u7684\u6570\u636e\uff0c\u5e76\u4e14\u7531Exporter\u66b4\u9732/metrics\uff0c\u6b64\u65f6Prometheus\u5c31\u53ef\u4ee5\u91c7\u96c6\u5230\u7531Exporter\u66b4\u9732\u7684\u975e\u4e91\u539f\u751f\u5e94\u7528\u7684\u5185\u90e8\u8fd0\u884c\u72b6\u6001\u3002\u76ee\u524d\u6bd4\u8f83\u5e38\u7528\u7684Exporter\u5de5\u5177\u5982\u886815.1\u6240\u793a\u3002</p> <p>\u886815.1\u3000\u76ee\u524d\u6bd4\u8f83\u5e38\u7528\u7684Exporter\u5de5\u5177</p> <p>)</p> <p>\u5728\u5b89\u88c5\u4e86Prometheus Stack\u540e\uff0c\u9ed8\u8ba4\u4f1a\u5b89\u88c5\u4e00\u4e9b\u5e38\u7528\u7684\u76d1\u63a7\uff0c\u6bd4\u5982Kubernetes\u7ec4\u4ef6\u3001\u96c6\u7fa4\u72b6\u6001\u3001\u4e3b\u673a\u72b6\u6001\u7684\u76d1\u63a7\u7b49\u3002\u5176\u4e2dKubernetes\u7ec4\u4ef6\u662f\u57fa\u4e8e\u4e91\u539f\u751f\u7406\u5ff5\u5f00\u53d1\u7684\uff0c\u5b83\u81ea\u8eab\u63d0\u4f9b\u4e86Metrics\u63a5\u53e3\uff0c\u6bd4\u5982Kubelet\u7ec4\u4ef6\u53ef\u4ee5\u901a\u8fc7\u4e3b\u673a\u768410255\u7aef\u53e3\u8bbf\u95ee\u76d1\u63a7\u6570\u636e\uff1a</p> <pre><code># curl -s 127.0.0.1:10255/metrics| tail -5\n</code></pre> <p>\u5982\u679c\u8bfb\u8005\u7684Kubelet\u4e0d\u662f10255\u7aef\u53e3\uff0c\u53ef\u4ee5\u901a\u8fc7netstat\u67e5\u770b\u76d1\u542c\u7684\u7aef\u53e3\u53f7\uff1a</p> <pre><code># netstat -lnpt|grep kubelet\ntcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      96284/kubelet\ntcp6       0      0 :::10250                :::*                    LISTEN      96284/kubelet\n</code></pre> <p>\u4e4b\u540e\u5728Grafana\u9875\u9762\u5373\u53ef\u770b\u5230\u76f8\u5173\u7684\u76d1\u63a7\u6570\u636e\uff0c\u4f9d\u6b21\u5355\u51fbGeneral/Home\u2192Default\u2192Kubernetes/Kubelet\u5373\u53ef\u770b\u5230\u9762\u677f\uff0c\u5982\u56fe15.6\u6240\u793a\u3002</p> <p>)</p> <p>Kubernetes\u8282\u70b9\uff08\u4e5f\u5c31\u662f\u670d\u52a1\u5668\u672c\u8eab\uff09\u80af\u5b9a\u4e0d\u662f\u4e91\u539f\u751f\u5e94\u7528\uff0c\u6216\u8005\u8bf4\u5b83\u4e0d\u7b97\u4e00\u4e2a\u5e94\u7528\uff0c\u800c\u662f\u4e00\u4e2a\u7cfb\u7edf\uff0c\u90a3\u4e48\u7cfb\u7edf\u672c\u8eab\u80af\u5b9a\u6ca1\u6709\u7c7b\u4f3c\u7684Metrics\u63a5\u53e3\u3002</p> <p>\u6309\u7167\u4e4b\u524d\u7684\u8bb2\u89e3\uff0c\u9700\u8981\u6709\u4e00\u4e2aExporter\u91c7\u96c6\u5bbf\u4e3b\u673a\u4fe1\u606f\uff0c\u7136\u540e\u66b4\u9732\u7ed9Prometheus\uff0c\u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528\u4e13\u7528\u4e8e\u4e3b\u673a\u4fe1\u606f\u91c7\u96c6\u7684node-exporter\u5e94\u7528\u6765\u91c7\u96c6\u6570\u636e\uff0c\u5e76\u66b4\u9732Metrics\u63a5\u53e3\u7ed9Prometheus\u3002</p> <p>\u5b89\u88c5Prometheus Stack\u65f6\uff0c\u9ed8\u8ba4\u7528DaemonSet\u5b89\u88c5\u4e86node-exporter\uff0c\u5b83\u4f1a\u5728\u6bcf\u4e2aKubernetes\u8282\u70b9\u90e8\u7f72\u4e00\u4e2anode-exporter\uff1a</p> <pre><code># kubectl get ds -n monitoring\nNAME            DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE\nnode-exporter   9         9         9       9            9           kubernetes.io/os=linux   34m\n\n# kubectl get pod -n monitoring|grep node-exporter\nnode-exporter-2f2h2                    2/2     Running   0          34m\nnode-exporter-2zcbr                    2/2     Running   0          34m\nnode-exporter-5txxx                    2/2     Running   0          34m\nnode-exporter-7wxp6                    2/2     Running   0          34m\nnode-exporter-99wrh                    2/2     Running   0          34m\nnode-exporter-dcfdn                    2/2     Running   0          34m\nnode-exporter-g7hl9                    2/2     Running   0          34m\nnode-exporter-hsgwx                    2/2     Running   0          34m\nnode-exporter-jp8qs                    2/2     Running   0          34m\n</code></pre> <p>\u6b64\u65f6\u53ef\u4ee5\u5728\u6bcf\u4e2a\u5bbf\u4e3b\u673a\u770b\u5230node-exporter\u76d1\u542c\u76849100\u7aef\u53e3\uff1a</p> <pre><code># netstat -lntp|grep node_exporter\ntcp        0      0 127.0.0.1:9100          0.0.0.0:*               LISTEN      40711/node_exporter\n</code></pre> <p>\u6b64\u65f6\u8bbf\u95ee9100\u5373\u53ef\u8bbf\u95ee\u5230\u4e3b\u673a\u7684\u76d1\u63a7\u4fe1\u606f\uff1a</p> <pre><code># curl -s 127.0.0.1:9100/metrics| tail -5\n# HELP promhttp_metric_handler_requests_total Total number of scrapes by HTTP status code.\n# TYPE promhttp_metric_handler_requests_total counter\npromhttp_metric_handler_requests_total{code=\"200\"} 281\npromhttp_metric_handler_requests_total{code=\"500\"} 0\npromhttp_metric_handler_requests_total{code=\"503\"} 0\n</code></pre> <p>\u540c\u65f6\u5728Grafana\u4e0a\u4e5f\u53ef\u4ee5\u770b\u5230\u76d1\u63a7\u9762\u677f,\u5355\u51fbGeneral/Home\u2192Default\u2192Node Exporter\u3002</p> <p>\u901a\u8fc7\u4e0a\u9762\u7684\u7406\u89e3\uff0c\u6211\u4eec\u77e5\u9053\u4e86\u9488\u5bf9\u4e91\u539f\u751f\u5e94\u7528\u6216\u975e\u4e91\u539f\u751f\u5e94\u7528\u7684\u76d1\u63a7\u6570\u636e\u6765\u6e90\uff0c\u4f46\u662fPrometheus\u662f\u5982\u4f55\u77e5\u9053\u8981\u91c7\u96c6\u54ea\u4e9b\u6570\u636e\u7684\u5462\uff1f\u63a5\u4e0b\u6765\u6211\u4eec\u4ecb\u7ecd\u5982\u4f55\u914d\u7f6ePrometheus\u91c7\u96c6\u6307\u5b9a\u76ee\u6807\u5e94\u7528\u7684\u76d1\u63a7\u6570\u636e\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#32-\u4ec0\u4e48\u662fservicemonitor","title":"3.2 \u4ec0\u4e48\u662fServiceMonitor","text":"<p>\u5982\u679c\u8bfb\u8005\u4f53\u9a8c\u8fc7\u5bb9\u5668\u5316\u6216\u8005\u4e8c\u8fdb\u5236\u7684\u65b9\u5f0f\u5b89\u88c5Prometheus\uff0c\u5c31\u4f1a\u6ce8\u610f\u5230Prometheus\u6709\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u7528\u4e8e\u914d\u7f6e\u9700\u8981\u76d1\u63a7\u54ea\u4e9b\u6570\u636e\uff0c\u6216\u8005\u914d\u7f6e\u4e00\u4e9b\u544a\u8b66\u7b56\u7565\u3002</p> <p>\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6\u7684\u7ef4\u62a4\u975e\u5e38\u9ebb\u70e6\uff0c\u7279\u522b\u662f\u76d1\u63a7\u9879\u975e\u5e38\u591a\u7684\u60c5\u51b5\u4e0b\uff0c\u5f88\u5bb9\u6613\u51fa\u73b0\u914d\u7f6e\u9519\u8bef\uff0c\u800c\u5728Kubernetes\u4e0a\u90e8\u7f72Prometheus\uff0c\u53ef\u4ee5\u4e0d\u7528\u53bb\u7ef4\u62a4\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u800c\u662f\u901a\u8fc7\u4e00\u4e2a\u53ebServiceMonitor\u7684\u8d44\u6e90\u6765\u81ea\u52a8\u53d1\u73b0\u76d1\u63a7\u76ee\u6807\u5e76\u52a8\u6001\u751f\u6210\u914d\u7f6e\u3002</p> <p>\u6bd4\u5982\u4e0a\u8ff0\u5c55\u793a\u7684Kubelet\u548cNodeExporter\u7684\u76d1\u63a7 \uff0c \u90fd\u6709\u4e00\u4e2aServiceMonitor\uff1a</p> <pre><code># kubectl get servicemonitor -n monitoring\nNAME                      AGE\nalertmanager              42m\nblackbox-exporter         42m\ncoredns                   42m\ngrafana                   42m\nkube-apiserver            42m\nkube-controller-manager   42m\nkube-scheduler            42m\nkube-state-metrics        42m\nkubelet                   42m\nnode-exporter             42m\nprometheus-adapter        42m\nprometheus-k8s            42m\nprometheus-operator       42m\n</code></pre> <p>\u53ef\u4ee5\u901a\u8fc7-o\u547d\u4ee4\u67e5\u770b\u914d\u7f6e\u8be6\u60c5\uff1a</p> <pre><code># kubectl get servicemonitor -n monitoring kubelet -o yaml\napiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  creationTimestamp: \"2022-12-28T06:35:18Z\"\ngeneration: 1\nlabels:\n    app.kubernetes.io/name: kubelet\n  name: kubelet\n  namespace: monitoring\n  resourceVersion: \"269124093\"\nselfLink: /apis/monitoring.coreos.com/v1/namespaces/monitoring/servicemonitors/kubelet\n  uid: 0295ed26-49c4-4b15-ba92-f63a0bc5e7ec\nspec:\n  endpoints:\n  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token\n    honorLabels: true\ninterval: 30s\n    metricRelabelings:\n......\n\njobLabel: app.kubernetes.io/name\n  namespaceSelector:\n    matchNames:\n    - kube-system\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: kubelet\n</code></pre> <p>\u4e0a\u8ff0\u5c55\u793a\u7684\u662f\u4e00\u4e2aKubelet\u7684ServiceMonitor\u914d\u7f6e\uff0c\u53ef\u4ee5\u770b\u5230\u5b83\u7684kind\u914d\u7f6e\u4e3aServiceMonitor\uff0c\u5e76\u975e\u6807\u51c6\u7684Kubernetes\u63d0\u4f9b\u7684\u8d44\u6e90\u7c7b\u578b\u3002</p> <p>\u5728\u7b2c13\u7ae0\uff0c\u6211\u4eec\u8bb2\u8fc7Operator\u548cCRD\uff0cPrometheus Stack\u4e5f\u662f\u4e00\u79cdCRD\u548cOperator\u7684\u5b9e\u73b0\u3002\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u7c7b\u578b\u4e3aServiceMonitor\u7684\u81ea\u5b9a\u4e49\u8d44\u6e90\uff0cPrometheus\u7684Operator\u4f1a\u89e3\u6790\u8be5\u8d44\u6e90\u7c7b\u578b\u7684\u914d\u7f6e\uff0c\u7136\u540e\u52a8\u6001\u751f\u6210Prometheus\u7684\u914d\u7f6e\uff0c</p> <p>\u8fd9\u5c31\u662fServiceMonitor\u7684\u4f5c\u7528,\u5b83\u53ef\u4ee5\u8ba9\u6211\u4eec\u7528\u8d44\u6e90\u5b9a\u4e49\u7684\u65b9\u5f0f\u53bb\u914d\u7f6ePrometheus\u9700\u8981\u76d1\u63a7\u8c01\uff0c\u4e0d\u7528\u518d\u5904\u7406\u6210\u767e\u4e0a\u5343\u884c\u7684Prometheus\u914d\u7f6e\uff0c\u4e5f\u4e0d\u9700\u8981\u6bcf\u6b21\u66f4\u6539Prometheus\u914d\u7f6e\u540e\u91cd\u542fPrometheus\u5b9e\u4f8b\u3002</p> <p>\u63a5\u4e0b\u6765\u770b\u4e00\u4e2aServiceMonitor\u914d\u7f6e\u793a\u4f8b\uff1a</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\nlabels:\nk8s-app: elasticsearch-exporter\nrelease: es-exporter\nname: es-exporter-elasticsearch-exporter\nnamespace: monitoring\nspec:\nendpoints:\n- honorLabels: true\ninterval: 10s\npath: /metrics\nport: http\nscheme: http\njobLabel: es-exporter\nnamespaceSelector:\nmatchNames:\n- monitoring\nselector:\nmatchLabels:\nk8s-app: elasticsearch-exporter\nrelease: es-exporter\n</code></pre> <ul> <li>honorLabels\uff1a\u5982\u679c\u76ee\u6807\u6807\u7b7e\u548c\u670d\u52a1\u5668\u6807\u7b7e\u51b2\u7a81\uff0c\u662f\u5426\u4fdd\u7559\u76ee\u6807\u6807\u7b7e\u3002</li> <li>interval\uff1a\u76d1\u63a7\u6570\u636e\u6293\u53d6\u7684\u65f6\u95f4\u95f4\u9694\u3002</li> <li>path\uff1aMetrics\u63a5\u53e3\u8def\u5f84\u3002</li> <li>port\uff1aMetrics\u7aef\u53e3\u3002</li> <li>scheme\uff1aMetrics\u63a5\u53e3\u7684\u534f\u8bae\u3002</li> <li>namespaceSelector\uff1a\u76d1\u63a7\u76ee\u6807Service\u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4\u3002</li> <li>selector\uff1a\u76d1\u63a7\u76ee\u6807Service\u7684\u6807\u7b7e\u3002</li> </ul> <p>\u53cd\u8fc7\u6765\u518d\u770bKubelet\u7684ServiceMonitor\uff1a</p> <pre><code>  namespaceSelector:\nmatchNames:\n- kube-system\nselector:\nmatchLabels:\napp.kubernetes.io/name: kubelet\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8be5ServiceMonitor\u7684\u76d1\u63a7\u76ee\u6807\u662fkube-system\u547d\u540d\u7a7a\u95f4\u4e0b\u5177\u6709app.kubernetes.io/name=kubelet\u6807\u7b7e\u7684Service,\u6b64\u65f6\u53ef\u4ee5\u67e5 \u770b\u8be5Service\uff1a</p> <pre><code># kubectl get svc -n kube-system -l app.kubernetes.io/name=kubelet\nNAME      TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                        AGE\nkubelet   ClusterIP   None         &lt;none&gt;        10250/TCP,10255/TCP,4194/TCP   161m\n</code></pre> <p>\u901a\u8fc7\u4e0a\u9762\u7684\u5b66\u4e60\uff0c\u6211\u4eec\u7b80\u5355\u603b\u7ed3\u4e00\u4e0b\uff0c\u5728\u4f7f\u7528Prometheus\u76d1\u63a7\u5e94\u7528\u65f6\uff0c\u6709\u4e91\u539f\u751f\u548c\u975e\u4e91\u539f\u751f\u5e94\u7528\u4e4b\u5206\uff0c\u8bf4\u767d\u4e86\u5c31\u662f\u76d1\u63a7\u6570\u636e\u662f\u7531\u7a0b\u5e8f\u672c\u8eab\u63d0\u4f9b\u8fd8\u662f\u901a\u8fc7Exporter\u63d0\u4f9b\u3002\u5bf9\u4e8e\u4e0d\u540c\u7684\u5e94\u7528\uff0c\u53ef\u4ee5\u91c7\u7528\u4e0d\u540c\u7684\u7ba1\u63a7\u6d41\u7a0b\uff0c\u5177\u4f53\u8bf4\u660e\u5982\u4e0b\uff1a</p> <ul> <li> <p>\u4e91\u539f\u751f\u5e94\u7528\uff1a\u627e\u5230\u672c\u8eab\u63d0\u4f9b\u7684Metrics\u63a5\u53e3\uff0c\u7136\u540e\u914d\u7f6e\u4e00\u4e2aService\u6307\u5411\u8be5\u5e94\u7528\u7684Pod\uff0c\u6700\u540e\u521b\u5efa\u4e00\u4e2aServiceMonitor\u6307\u5b9a\u8be5\u5e94\u7528\u7684Service\u5373\u53ef\u5b8c\u6210\u76d1\u63a7\u6570\u636e\u7684\u91c7\u96c6\u3002</p> </li> <li> <p>\u975e\u4e91\u539f\u751f\u5e94\u7528\uff1a\u9700\u8981\u627e\u5230\u5408\u9002\u8be5\u5e94\u7528\u7684Exporter\uff0c\u4e4b\u540eExporter\u94fe\u63a5\u81f3\u8be5\u5e94\u7528\u5e76\u91c7\u96c6\u76f8\u5173\u6570\u636e\uff0c\u7136\u540e\u914d\u7f6e\u4e00\u4e2aService\u6307\u5411\u8be5Exporter\u7684Pod\uff0c\u6700\u540e\u521b\u5efa\u4e00\u4e2aServiceMonitor\u6307\u5b9a\u8be5Exporter\u7684Service\u5373\u53ef\u5b8c\u6210\u76d1\u63a7\u6570\u636e\u7684\u91c7\u96c6\u3002</p> </li> </ul>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#33-servicemonitor\u627e\u4e0d\u5230\u76d1\u63a7\u4e3b\u673a\u6392\u67e5","title":"3.3 ServiceMonitor\u627e\u4e0d\u5230\u76d1\u63a7\u4e3b\u673a\u6392\u67e5","text":"<p>\u901a\u8fc7\u4e0a\u9762\u7684\u5b66\u4e60\uff0c\u6211\u4eec\u77e5\u9053\u4e86Prometheus\u76d1\u63a7\u5e94\u7528\u7684\u6d41\u7a0b\uff0c\u63a5\u4e0b\u6765\u8d81\u70ed\u6253\u94c1\u770b\u4e00\u4e2aKubernetes\u7ec4\u4ef6\u7684\u76d1\u63a7\u95ee\u9898\u3002</p> <p>\u5982\u679c\u8bfb\u8005\u91c7\u7528\u7684\u662f\u4e8c\u8fdb\u5236\u65b9\u5f0f\u5b89\u88c5\u7684Kubernetes\u96c6\u7fa4\uff0c\u5b89\u88c5Prometheus\u540e\uff0ckube-controller-manager\u548ckube- scheduler\u53ef\u80fd\u5904\u4e8e\u65e0\u6cd5\u76d1\u63a7\u7684\u72b6\u6001\uff0c\u4e5f\u5c31\u662f\u627e\u4e0d\u5230\u76ee\u6807\u4e3b\u673a\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7Prometheus\u7684Web UI\u7684Status\u2192Service Discovery\u67e5\u770b\uff0c\u5982\u56fe15.7\u6240\u793a\u3002</p> <p>)</p> <p>\u540c\u65f6\u5728Alerts\u9875\u9762\u4e5f\u80fd\u770b\u5230Controller Manager\u548cScheduler\u7684\u544a\u8b66\uff0c\u5982\u56fe15.8\u6240\u793a\u3002</p> <p>)</p> <p>\u56fe15.8\u3000\u67e5\u770b\u544a\u8b66</p> <p>\u6b64\u65f6\u867d\u7136\u6709kube-controller-manager\u548ckube-scheduler\u7684\u76d1\u63a7\u914d\u7f6e\uff0c\u4f46\u662f\u5e76\u6ca1\u6709\u53d1\u73b0\u53ef\u7528\u7684\u76d1\u63a7\u76ee\u6807\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5206\u6790\u4e00\u4e0b\u4e3a\u4ec0\u4e48\u627e\u4e0d\u5230\u76d1\u63a7\u76ee\u6807\u3002</p> <p>\u6ce8\u610f \u672c\u8282\u7684\u6392\u67e5\u601d\u8def\u662f\u901a\u7528\u6b65\u9aa4\uff0c\u4e0d\u4ec5\u4ec5\u5c40\u9650\u4e8econtroller\u548cscheduler\u3002</p> <p>\u5176\u6b21Kubernetes\u7248\u672c\u4e0d\u4e00\u81f4\uff0c\u9488\u5bf9controller\u548cscheduler\u7684\u95ee\u9898\u89e3\u51b3\u65b9\u5f0f\u53ef\u80fd\u5e76\u4e0d\u4e00\u81f4\uff0c\u4f46\u662fServiceMonitor\u627e\u4e0d\u5230\u4e3b\u673a\u7684\u6392\u67e5\u6b65\u9aa4\u662f\u4e00\u81f4\u7684\u3002</p> <p>\u9996\u5148\u6211\u4eec\u6ce8\u610f\u5230Prometheus\u662f\u6709\u76f8\u5173\u914d\u7f6e\u7684\uff0c\u8bf4\u660eServiceMonitor\u5df2\u7ecf\u521b\u5efa\u6210\u529f\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\uff1a</p> <pre><code># kubectl get servicemonitors -n monitoring kube-controller-manager kube-scheduler\nNAME                      AGE\nkube-controller-manager   127m\nkube-scheduler            127m\n</code></pre> <p>\u63a5\u4e0b\u6765\u8fdb\u4e00\u6b65\u5206\u6790 ,\u9996\u5148\u67e5\u770bkube-controller-manager\u7684ServiceMonitor\u914d\u7f6e\uff1a</p> <pre><code># kubectl get servicemonitor -n monitoring kube-controller-manager -o yaml\napiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\n......\n    port: https-metrics\n    scheme: https\n    tlsConfig:\n      insecureSkipVerify: true\njobLabel: app.kubernetes.io/name\n  namespaceSelector:\n    matchNames:\n    - kube-system\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: kube-controller-manager\n</code></pre> <p>\u770b\u5230\u8be5ServiceMonitor \u5339\u914d\u7684\u662fkube-system \u547d\u540d\u7a7a\u95f4\u4e0b\u5177\u6709app.kubernetes.io/name=kubecontroller-manager\u7684\u6807\u7b7e\uff0c\u63a5\u4e0b\u6765\u901a\u8fc7\u8be5\u6807\u7b7e\u67e5\u770b\u662f\u5426\u6709\u8be5Service\uff1a</p> <pre><code># kubectl get svc -n kube-system -l app.kubernetes.io/name=kube-controller-manager\nNo resources found in kube-system namespace.\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5e76\u6ca1\u6709\u6b64\u6807\u7b7e\u7684Service\uff0c\u6240\u4ee5\u5bfc\u81f4\u627e\u4e0d\u5230\u9700\u8981\u76d1\u63a7\u7684\u76ee\u6807\uff0c\u6b64\u65f6\u53ef\u4ee5\u624b\u52a8\u521b\u5efa\u8be5Service\u548cEndpoint\u6307\u5411\u81ea\u5df1\u7684Controller Manager\uff1a</p> <p><code>kubernetesControlPlane-serviceMonitorKubeControllerManager.yaml</code></p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\nnamespace: kube-system\nname: kube-controller-manager\nlabels:\napp.kubernetes.io/name: kube-controller-manager\nspec:\nselector:\ncomponent: kube-controller-manager\nports:\n- name: https-metrics\nport: 10257\ntargetPort: 10257 # controller-manager \u7684\u5b89\u5168\u7aef\u53e3\u4e3a10257\n</code></pre> <p>\u6ce8\u610f\u9700\u8981\u66f4\u6539Endpoint\u914d\u7f6e\u7684YOUR_CONTROLLER_IP\u4e3a\u81ea\u5df1\u7684Controller Manager\u7684IP\uff0c\u63a5\u4e0b\u6765\u521b\u5efa\u8be5Service\u548cEndpoint\uff1a</p> <pre><code># kubectl create -f kubernetesControlPlane-serviceMonitorKubeControllerManager.yaml\nservice/kube-controller-manager created\n</code></pre> <p>\u67e5\u770b\u521b\u5efa\u7684Service\u548cEndpoint\uff1a</p> <pre><code># kubectl get svc -n kube-system kube-controller-manager\nNAME                      TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)     AGE\nkube-controller-manager   ClusterIP   10.99.49.192   &lt;none&gt;        10257/TCP   37s\n</code></pre> <p>\u6b64\u65f6\u8be5Service\u53ef\u80fd\u662f\u4e0d\u901a\u7684\uff0c\u56e0\u4e3a\u5728\u96c6\u7fa4\u642d\u5efa\u65f6\uff0cController Manager\u548cScheduler\u76d1\u542c\u7684\u53ef\u80fd\u662f127.0.0.1\uff0c\u5bfc\u81f4\u65e0\u6cd5\u88ab\u5916\u90e8\u8bbf\u95ee\uff0c\u6b64\u65f6\u9700\u8981\u66f4\u6539\u5b83\u7684\u76d1\u542c\u5730\u5740\u4e3a0.0.0.0\uff08\u5982\u679c\u8bfb\u8005\u7684\u96c6\u7fa4\u539f\u672c\u76d1\u542c\u7684\u5c31\u662f0.0.0.0\uff0c\u5219\u65e0\u987b\u66f4\u6539\uff0ckubeadm\u5b89\u88c5\u65b9\u5f0f\u914d\u7f6e\u6587\u4ef6\u5728/etc/kubernetes/manifests\u76ee\u5f55\uff09\uff1a</p> <pre><code># sed -i 's#address=127.0.0.1#address=0.0.0.0#g' /usr/lib/systemd/system/kube-controller-manager.service\n# systemctl daemon-reload\n# systemctl restart kube-controller-manager\n</code></pre> <p>\u5982\u679c\u4f7f\u7528kubeadm\u542f\u52a8\u7684\u96c6\u7fa4\uff0c\u521d\u59cb\u5316\u65f6\u52a0\u5165\u5982\u4e0b\u53c2\u6570</p> <pre><code>controllerManagerExtraArgs:\n  address: 0.0.0.0\nschedulerExtraArgs:\n  address: 0.0.0.0\n</code></pre> <p>\u5982\u679c\u662f\u5df2\u7ecf\u542f\u52a8\u4e4b\u540e\u7684\u96c6\u7fa4\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u4fee\u6539</p> <pre><code># sed -e \"s/- --address=127.0.0.1/- --address=0.0.0.0/\" -i /etc/kubernetes/manifests/kube-controller-manager.yaml\n# sed -e \"s/- --address=127.0.0.1/- --address=0.0.0.0/\" -i /etc/kubernetes/manifests/kube-scheduler.yaml\n</code></pre> <p>\u63d0\u793a \u5982\u679c\u8bfb\u8005\u7684Kubernetes\u7248\u672c\u5927\u4e8e1.22\uff0c\u5230\u6b64\u6b65\u9aa4\u540e\uff0ccontroller\u7684\u95ee\u9898\u5c31\u5df2\u7ecf\u89e3\u51b3\u4e86\u3002</p> <p>\u901a\u8fc7\u8be5Service\u7684ClusterIP\u8bbf\u95eeController Manager\u7684Metrics\u63a5\u53e3\uff1a</p> <pre><code># kubectl get svc -n kube-system kube-controller-manager\nNAME                      TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)     AGE\nkube-controller-manager   ClusterIP   10.99.49.192   &lt;none&gt;        10257/TCP   37s\n\n# curl -s 10.99.49.192:10257/metrics| tail -1\n</code></pre> <p>\u5230\u6b64\u65f6\uff0c\u8bfb\u8005\u53ef\u80fd\u4f1a\u4ee5\u4e3a\u6709\u4e86\u8fd9\u4e2aService\u4e4b\u540e\uff0cPrometheus\u5c31\u80fd\u53d1\u73b0\u8be5\u76ee\u6807\uff0c\u4f46\u5176\u5b9e\u4e0d\u7136\uff0c\u7ec6\u5fc3\u7684\u8bfb\u8005\u4f1a\u53d1\u73b0ServiceMonitor\u7684port\u548cscheme\u914d\u7f6e\u7684\u548c\u8be5Service\u7684\u4e0d\u4e00\u81f4\u3002</p> <p>\u5728\u521b\u5efaService\u4e4b\u524d\uff0c\u5982\u679c\u8bfb\u8005\u7684\u96c6\u7fa4\u5df2\u7ecf\u6709\u4e86\u7b26\u5408ServiceMonitor\u9009\u62e9\u7684Service\uff0c\u4f9d\u65e7\u4e0d\u80fd\u53d1\u73b0\u76d1\u63a7\u76ee\u6807\uff0c\u5c31\u9700\u8981\u68c0\u67e5\u7aef\u53e3\u548c\u534f\u8bae\u662f\u5426\u548cService\u914d\u7f6e\u7684\u4e00\u81f4\u3002\u66f4\u6539ServiceMonitor\u7684\u914d\u7f6e\u548cService\u4e00\u81f4\uff0c\u5982\u4e0b\u6240\u793a\u3002</p> <pre><code>    port: https-metrics\nscheme: https\ntlsConfig:\ninsecureSkipVerify: true\n</code></pre> <p>\u914d\u7f6eService Monitor</p> <pre><code># kubectl edit servicemonitor kube-controller-manager -n monitoring\n</code></pre> <p>\u7b49\u5f85\u51e0\u5206\u949f\u540e\uff0c \u5c31\u53ef\u4ee5\u5728Prometheus \u7684Web UI\u4e0a\u770b\u5230Controller Manager\u7684\u76d1\u63a7\u76ee\u6807\uff0c\u5982\u56fe15.10\u548c\u56fe15.11\u6240\u793a\u3002</p> <p>) \u56fe15.10\u3000\u67e5\u770bTargets</p> <p>) \u56fe15.11\u3000\u67e5\u770bService Discovery</p> <p>\u53c2\u8003</p> <p>https://p8s.io/docs/operator/install/</p> <p>\u6b64\u65f6\u544a\u8b66\u4e5f\u4f1a\u6d88\u5931\uff0cGrafana\u4e5f\u80fd\u67e5\u770b\u5230Controller Manager\u7684\u76d1\u63a7\u6570\u636e\u3002Scheduler\u7684\u6392\u67e5\u548cController Manager\u4e00\u81f4\u3002</p> <p><code>kubernetesControlPlane-serviceMonitorKubeScheduler.yaml</code></p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\nlabels:\napp.kubernetes.io/name: kube-scheduler\napp.kubernetes.io/part-of: kube-prometheus\nname: kube-scheduler\nnamespace: monitoring\nspec:\nendpoints:\n- bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token\ninterval: 30s\nport: https-metrics\nscheme: https\ntlsConfig:\ninsecureSkipVerify: true\njobLabel: app.kubernetes.io/name\nnamespaceSelector:\nmatchNames:\n- kube-system\nselector:\nmatchLabels:\napp.kubernetes.io/name: kube-scheduler\n---\napiVersion: v1\nkind: Service\nmetadata:\nnamespace: kube-system\nname: kube-scheduler\nlabels: # \u5fc5\u987b\u548c\u4e0a\u9762\u7684 ServiceMonitor \u4e0b\u9762\u7684 matchLabels \u4fdd\u6301\u4e00\u81f4\napp.kubernetes.io/name: kube-scheduler\nspec:\nselector:\ncomponent: kube-scheduler\nports:\n- name: https-metrics\nport: 10259\n# \u9700\u8981\u6ce8\u610f\u73b0\u5728\u7248\u672c\u9ed8\u8ba4\u7684\u5b89\u5168\u7aef\u53e3\u662f10259\ntargetPort: 10259 </code></pre> <p>\u7efc\u4e0a\u6240\u8ff0\uff0c\u901a\u8fc7ServiceMonitor\u76d1\u63a7\u5e94\u7528\u65f6\uff0c\u5982\u679c\u76d1\u63a7\u6ca1\u6709\u627e\u5230\u76ee\u6807\u4e3b\u673a\u7684\u6392\u67e5\u6b65\u9aa4\uff0c\u6392\u67e5\u6b65\u9aa4\u5927\u81f4\u5982\u4e0b\uff1a</p> <ul> <li>\u786e\u8ba4ServiceMonitor\u662f\u5426\u6210\u529f\u521b\u5efa\u3002</li> <li>\u786e\u8ba4Prometheus\u662f\u5426\u751f\u6210\u4e86\u76f8\u5173\u914d\u7f6e\u3002</li> <li>\u786e\u8ba4\u5b58\u5728ServiceMonitor\u5339\u914d\u7684Service\u3002</li> <li>\u786e\u8ba4\u901a\u8fc7Service\u80fd\u591f\u8bbf\u95ee\u7a0b\u5e8f\u7684Metrics\u63a5\u53e3\u3002</li> <li>\u786e\u8ba4Service\u7684\u7aef\u53e3\u548cScheme\u3001ServiceMonitor\u4e00\u81f4\u3002</li> </ul>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#34-\u4e91\u539f\u751f\u5e94\u7528\u76d1\u63a7","title":"3.4 \u4e91\u539f\u751f\u5e94\u7528\u76d1\u63a7","text":"<p>\u901a\u8fc7\u524d\u9762\u7684\u5b66\u4e60\uff0c\u6211\u4eec\u5bf9Prometheus\u76f8\u5173\u77e5\u8bc6\u505a\u4e86\u4e00\u4e9b\u4e86\u89e3\uff0c\u4e5f\u7406\u89e3\u4e86\u4e91\u539f\u751f\u548c\u975e\u4e91\u539f\u751f\u5e94\u7528\u7684\u76d1\u63a7\u6d41\u7a0b\uff0c\u63a5\u4e0b\u6765\u901a\u8fc7\u4e24\u4e2a\u793a\u4f8b\u6f14\u793a\u5e94\u7528\u76d1\u63a7\u7684\u57fa\u672c\u6d41\u7a0b\u3002</p> <p>\u9664\u4e86 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u4e00\u4e9b\u8d44\u6e90\u5bf9\u8c61\u3001\u8282\u70b9\u4ee5\u53ca\u7ec4\u4ef6\u9700\u8981\u76d1\u63a7\uff0c\u6709\u7684\u65f6\u5019\u6211\u4eec\u53ef\u80fd\u8fd8\u9700\u8981\u6839\u636e\u5b9e\u9645\u7684\u4e1a\u52a1\u9700\u6c42\u53bb\u6dfb\u52a0\u81ea\u5b9a\u4e49\u7684\u76d1\u63a7\u9879\uff0c\u6dfb\u52a0\u4e00\u4e2a\u81ea\u5b9a\u4e49\u76d1\u63a7\u7684\u6b65\u9aa4\u4e5f\u662f\u975e\u5e38\u7b80\u5355\u7684\u3002</p> <p>\u7b2c\u4e00\u6b65\u5efa\u7acb\u4e00\u4e2a ServiceMonitor \u5bf9\u8c61\uff0c\u7528\u4e8e Prometheus \u6dfb\u52a0\u76d1\u63a7\u9879</p> <p>\u7b2c\u4e8c\u6b65\u4e3a ServiceMonitor \u5bf9\u8c61\u5173\u8054 metrics \u6570\u636e\u63a5\u53e3\u7684\u4e00\u4e2a Service \u5bf9\u8c61</p> <p>\u7b2c\u4e09\u6b65\u786e\u4fdd Service \u5bf9\u8c61\u53ef\u4ee5\u6b63\u786e\u83b7\u53d6\u5230 metrics \u6570\u636e</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u4e3a\u5927\u5bb6\u6f14\u793a\u5982\u4f55\u6dfb\u52a0 etcd \u96c6\u7fa4\u7684\u76d1\u63a7\u3002\u65e0\u8bba\u662f Kubernetes \u96c6\u7fa4\u5916\u7684\u8fd8\u662f\u4f7f\u7528 kubeadm \u5b89\u88c5\u5728\u96c6\u7fa4\u5185\u90e8\u7684 etcd \u96c6\u7fa4\uff0c\u6211\u4eec\u8fd9\u91cc\u90fd\u5c06\u5176\u89c6\u4f5c\u96c6\u7fa4\u5916\u7684\u72ec\u7acb\u96c6\u7fa4\uff0c\u56e0\u4e3a\u5bf9\u4e8e\u4e8c\u8005\u7684\u4f7f\u7528\u65b9\u6cd5\u6ca1\u4ec0\u4e48\u7279\u6b8a\u4e4b\u5904\u3002</p> <p>\u5728\u5b89\u88c5Prometheus\u65f6\uff0c\u5e76\u6ca1\u6709\u5bf9Etcd\u96c6\u7fa4\u8fdb\u884c\u76d1\u63a7\uff0cEtcd\u96c6\u7fa4\u662fKubernetes\u7684\u6570\u636e\u5e93\uff0c\u638c\u63e1\u7740Kubernetes\u6700\u6838\u5fc3\u7684\u6570\u636e\uff0cEtcd\u7684\u72b6\u6001\u548c\u6027\u80fd\u76f4\u63a5\u5f71\u54cdKubernetes\u96c6\u7fa4\u7684\u72b6\u6001\uff0c\u6240\u4ee5\u5bf9Etcd\u96c6\u7fa4\u7684\u76d1\u63a7\u662f\u975e\u5e38\u91cd\u8981\u7684\u3002</p> <p>\u63a5\u4e0b\u6765\u901a\u8fc7Etcd\u7684\u76d1\u63a7\u5b66\u4e60\u5982\u4f55\u5bf9\u4e91\u539f\u751f\u5e94\u7528\u8fdb\u884c\u76d1\u63a7\u3002</p> <p>\u4e4b\u524d\u8bb2\u4e86\uff0c\u4e91\u539f\u751f\u5e94\u7528\u4f1a\u63d0\u4f9b\u4e00\u4e2aMetrics\u63a5\u53e3\uff0c\u53ef\u4ee5\u76f4\u63a5\u83b7\u53d6\u5230\u5185\u90e8\u7684\u8fd0\u884c\u4fe1\u606f\uff0c\u6bd4\u5982Etcd\u7684\u5185\u90e8\u6570\u636e\u53ef\u4ee5\u901a\u8fc72379\u7684/metrics\u5f97\u5230\uff0c\u548c\u4e4b\u524d\u7684kubelet\u7c7b\u4f3c\u3002\u4e0d\u540c\u7684\u662f\uff0cEtcd\u5bf9\u5916\u7684\u63a5\u53e3\u5fc5\u987b\u901a\u8fc7HTTPS\u534f\u8bae\u8bbf\u95ee\uff0c\u6240\u4ee5\u5728\u8bf7\u6c42\u65f6\u9700\u8981\u52a0\u4e0a\u5bf9\u5e94\u7684\u8bc1\u4e66\uff0c\u6bd4\u5982\uff1a</p> <pre><code># curl -s --cert /etc/kubernetes/pki/etcd/etcd.pem --key /etc/kubernetes/pki/etcd/etcd-key.pem https://YOUR_ETCD_IP:2379/metrics -k | tail -1\n</code></pre> <p>\u8bc1\u4e66\u7684\u4f4d\u7f6e\u53ef\u4ee5\u5728Etcd\u914d\u7f6e\u6587\u4ef6\u4e2d\u83b7\u5f97\uff08\u6ce8\u610f\u914d\u7f6e\u6587\u4ef6\u7684\u4f4d\u7f6e\uff0c\u4e0d\u540c\u7684\u96c6\u7fa4\u4f4d\u7f6e\u53ef\u80fd\u4e0d\u540c \uff0c Kubeadm \u5b89 \u88c5 \u65b9 \u5f0f \u53ef \u80fd \u4f1a\u5728/etc/kubernetes/manifests/etcd.yml\u4e2d)\uff1a</p> <pre><code># grep -E \"key-file|cert-file\" /etc/kubernetes/manifests/etcd.yaml\n- --cert-file=/etc/kubernetes/pki/etcd/server.crt\n    - --key-file=/etc/kubernetes/pki/etcd/server.key\n    - --peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt\n    - --peer-key-file=/etc/kubernetes/pki/etcd/peer.key\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u6b64\u65f6\u52a0\u4e0a--cert\u548c--key\u53c2\u6570\u624d\u53ef\u4ee5\u8bbf\u95eeEtcd\u7684Metrics\u63a5\u53e3\uff0c\u6240\u4ee5\u5728\u914d\u7f6eServiceMonitor\u65f6\u9700\u8981\u52a0\u4e0a\u8bc1\u4e66\u7684\u914d\u7f6e\u3002</p> <p>1\uff0e\u521b\u5efaEtcd ServiceMonitor</p> <p>\u9996\u5148\uff0c\u9700\u8981\u914d\u7f6eEtcd\u7684Service\u548cEndpoint\uff1a</p> <p><code>kubernetesControlPlane-serviceMonitorEtcd.yaml</code></p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\nname: etcd-k8s\nnamespace: monitoring\nlabels:\nk8s-app: etcd-k8s\nspec:\njobLabel: k8s-app\nendpoints:\n- port: port\ninterval: 15s\nselector:\nmatchLabels:\nk8s-app: etcd\nnamespaceSelector:\nmatchNames:\n- kube-system\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u5c06YOUR_ETCD_IP\u6539\u6210\u81ea\u5df1\u7684Etcd\u4e3b\u673aIP\uff0c\u53e6\u5916\u9700\u8981\u6ce8\u610fport\u7684\u540d\u79f0\u4e3ahttps-metrics\uff0c\u8981\u548c\u540e\u9762\u7684ServiceMonitor\u4fdd\u6301\u4e00\u81f4\u3002\u4e4b\u540e\u521b\u5efa\u8be5\u8d44\u6e90\u5e76\u67e5\u770bService\u7684ClusterIP\uff1a</p> <pre><code># kubectl create -f kubernetesControlPlane-serviceMonitorEtcd.yaml\nservicemonitor.monitoring.coreos.com/etcd-k8s created\n</code></pre> <p>2.\u521b\u5efaEtcd Service</p> <p>\u4f46\u5b9e\u9645\u4e0a\u73b0\u5728\u5e76\u4e0d\u80fd\u76d1\u63a7\u5230 etcd \u96c6\u7fa4\uff0c\u56e0\u4e3a\u5e76\u6ca1\u6709\u4e00\u4e2a\u6ee1\u8db3 ServiceMonitor \u6761\u4ef6\u7684 Service \u5bf9\u8c61\u4e0e\u4e4b\u5173\u8054\uff1a</p> <pre><code># kubectl get svc -n kube-system -l k8s-app=etcd\nNo resources found in kube-system namespace.\n</code></pre> <p>\u6240\u4ee5\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u6ee1\u8db3\u4e0a\u9762\u6761\u4ef6\u7684 Service \u5bf9\u8c61\uff0c\u7531\u4e8e\u6211\u4eec\u628a etcd \u5f53\u6210\u662f\u96c6\u7fa4\u5916\u90e8\u7684\u670d\u52a1\uff0c\u6240\u4ee5\u8981\u5f15\u5165\u5230\u96c6\u7fa4\u4e2d\u6765\u6211\u4eec\u5c31\u9700\u8981\u81ea\u5b9a\u4e49 Endpoints \u5bf9\u8c61\u6765\u521b\u5efa Service \u5bf9\u8c61\u4e86\uff1a</p> <p><code>etcd-service.yaml</code></p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\nname: etcd-k8s\nnamespace: kube-system\nlabels:\nk8s-app: etcd\nspec:\ntype: ClusterIP\nclusterIP: None # \u4e00\u5b9a\u8981\u8bbe\u7f6e clusterIP:None\nports:\n- name: port\nport: 2381\n---\napiVersion: v1\nkind: Endpoints\nmetadata:\nname: etcd-k8s\nnamespace: kube-system\nlabels:\nk8s-app: etcd\nsubsets:\n- addresses:\n- ip: 192.168.1.56 # \u6307\u5b9aetcd\u8282\u70b9\u5730\u5740\uff0c\u5982\u679c\u662f\u96c6\u7fa4\u5219\u7ee7\u7eed\u5411\u4e0b\u6dfb\u52a0\nnodeName: etc-master\nports:\n- name: port\nport: 2381\n</code></pre> <pre><code># kubectl create -f etcd-service.yaml\nservice/etcd-k8s created\nendpoints/etcd-k8s created\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u521b\u5efa\u7684 Service \u6ca1\u6709\u91c7\u7528\u524d\u9762\u901a\u8fc7 label \u6807\u7b7e\u7684\u5f62\u5f0f\u53bb\u5339\u914d Pod \u7684\u505a\u6cd5\uff0c\u56e0\u4e3a\u524d\u9762\u6211\u4eec\u8bf4\u8fc7\u5f88\u591a\u65f6\u5019\u6211\u4eec\u521b\u5efa\u7684 etcd \u96c6\u7fa4\u662f\u72ec\u7acb\u4e8e\u96c6\u7fa4\u4e4b\u5916\u7684\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\u9762\u6211\u4eec\u5c31\u9700\u8981\u81ea\u5b9a\u4e49\u4e00\u4e2a Endpoints\uff0c\u8981\u6ce8\u610f <code>metadata</code> \u533a\u57df\u7684\u5185\u5bb9\u8981\u548c Service \u4fdd\u6301\u4e00\u81f4\uff0cService \u7684 clusterIP \u8bbe\u7f6e\u4e3a None\uff0c\u65b0\u7248\u672c\u7684 etcd \u5c06 metrics \u63a5\u53e3\u6570\u636e\u653e\u7f6e\u5230\u4e86 2381 \u7aef\u53e3\u3002\u76f4\u63a5\u521b\u5efa\u8be5\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code># kubectl get svc -n kube-system -l k8s-app=etcd\nNAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE\netcd-k8s   ClusterIP   None         &lt;none&gt;        2381/TCP   37s\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u9694\u4e00\u4f1a\u513f\u53bbPrometheus\u7684Dashboard\u4e2d\u67e5\u770btargets\uff0c\u4fbf\u4f1a\u6709etcd\u7684\u76d1\u63a7\u9879\u4e86\uff1a</p> <p>)</p> <p>\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u4e2a\u660e\u663e\u7684\u9519\u8bef\uff0c2381 \u7aef\u53e3\u94fe\u63a5\u88ab\u62d2\u7edd\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u8fd9\u91cc\u7684 etcd \u7684 metrics \u63a5\u53e3\u662f\u76d1\u542c\u5728 <code>127.0.0.1</code> \u8fd9\u4e2a IP \u4e0a\u9762\u7684\uff0c\u6240\u4ee5\u8bbf\u95ee\u4f1a\u62d2\u7edd\uff1a</p> <pre><code>--listen-metrics-urls=http://127.0.0.1:2381\n</code></pre> <p>\u6211\u4eec\u53ea\u9700\u8981\u5728 <code>/etc/kubernetes/manifests/</code>\u76ee\u5f55\u4e0b\u9762\uff08\u9759\u6001Pod\u9ed8\u8ba4\u7684\u76ee\u5f55\uff09\u7684 <code>etcd.yaml</code> \u6587\u4ef6\u4e2d\u5c06\u4e0a\u9762\u7684<code>listen-metrics-urls</code> \u66f4\u6539\u6210\u8282\u70b9IP\u5373\u53ef\uff1a</p> <pre><code>--listen-metrics-urls=http://0.0.0.0:2381\n</code></pre> <p>\u5f53etcd\u91cd\u542f\u751f\u6548\u540e\uff0c\u67e5\u770betcd\u8fd9\u4e2a\u76d1\u63a7\u4efb\u52a1\u5c31\u6b63\u5e38\u4e86\uff1a )</p> <p>3\uff0e\u914d\u7f6eGrafana</p> <p>\u4f9d\u6b21\u5355\u51fb\u201c+\u201d\u2192Import\uff0c\u4e4b\u540e\u8f93\u5165Etcd\u7684Grafana Dashboard\u5730\u5740</p> <p>\u6570\u636e\u91c7\u96c6\u5230\u540e\uff0c\u53ef\u4ee5\u5728 grafana \u4e2d\u5bfc\u5165\u7f16\u53f7\u4e3a <code>3070</code> \u7684 dashboard\uff0c\u5c31\u53ef\u4ee5\u83b7\u53d6\u5230 etcd \u7684\u76d1\u63a7\u56fe\u8868\uff1a</p> <p>\u4e4b\u540e\u5c31\u53ef\u4ee5\u770b\u5230Etcd\u96c6\u7fa4\u7684\u72b6\u6001\uff0c\u5982\u56fe15.16\u6240\u793a\u3002</p> <p>)</p> <p>\u56fe15.16\u3000\u67e5\u770bEtcd\u76d1\u63a7</p> <p>\u53c2\u8003\u6587\u732e</p> <p>https://p8s.io/docs/operator/custom/?h=etc#etcd-%E7%9B%91%E6%8E%A7</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#35-\u975e\u4e91\u539f\u751f\u76d1\u63a7exporter","title":"3.5 \u975e\u4e91\u539f\u751f\u76d1\u63a7Exporter","text":"<p>\u4e0a\u4e00\u5c0f\u8282\u9488\u5bf9\u4e91\u539f\u751f\u5e94\u7528Etcd\u8fdb\u884c\u4e86\u76d1\u63a7\uff0c\u53ef\u4ee5\u770b\u5230\u7b26\u5408\u4e91\u539f\u751f\u8981\u7d20\u5f00\u53d1\u7684\u5e94\u7528\uff0c\u81ea\u5e26\u7684\u90fd\u6709\u4e00\u4e2aMetrics\u63a5\u53e3\uff0c\u53ef\u4ee5\u8ba9\u76d1\u63a7\u5e73\u53f0\u76f4\u63a5\u91c7\u96c6\u5230\u76d1\u63a7\u6570\u636e\u3002</p> <p>\u800c\u975e\u539f\u751f\u5e94\u7528\uff08\u5982MySQL\u3001Redis\u3001Kakfa\u7b49\uff09\u6ca1\u6709\u66b4\u9732Metrics\u63a5\u53e3\uff0c\u6240\u4ee5\u53ef\u4ee5\u4f7f\u7528\u5bf9\u5e94\u7684Exporter\u91c7\u96c6\u6570\u636e\uff0c\u5e76\u66b4\u9732Metrics\u63a5\u53e3\u3002\u672c\u5c0f\u8282\u5c06\u4f7f\u7528MySQL\u4f5c\u4e3a\u4e00\u4e2a\u6d4b\u8bd5\u7528\u4f8b\uff0c\u6f14\u793a\u5982\u4f55\u4f7f\u7528Exporter\u76d1\u63a7\u975e\u4e91\u539f\u751f\u5e94\u7528\u3002</p> <p>1\uff0e\u90e8\u7f72\u6d4b\u8bd5\u7528\u4f8b</p> <p>\u9996\u5148\u90e8\u7f72MySQL\u81f3Kubernetes\u96c6\u7fa4\u4e2d\uff0c\u5982\u679c\u8bfb\u8005\u6709\u9700\u8981\u76d1\u63a7\u7684MySQL\uff0c\u53ef\u4ee5\u5ffd\u7565\u6b64\u6b65\u9aa4\uff0c\u76f4\u63a5\u914d\u7f6eMySQL\u7684\u6743\u9650\u5373\u53ef\uff1a</p> <pre><code># kubectl create deploy mysql --image=registry.cn-beijing.aliyuncs.com/dotbalo/mysql:5.7.23\ndeployment.apps/mysql created\n# kubectl set env deploy/mysql MYSQL_ROOT_PASSWORD=mysql\ndeployment.apps/mysql env updated\n# \u67e5\u770bpod\u662f\u5426\u6b63\u5e38\n# kubectl get po -l app=mysql\nNAME                     READY   STATUS    RESTARTS   AGE\nmysql-69d6f69557-8hdg6   1/1     Running   0          52s\n</code></pre> <p>\u521b\u5efaService\u66b4\u9732MySQL\uff1a</p> <pre><code># kubectl expose deploy mysql --port 3306\nservice/mysql exposed\n# kubectl get svc -l app=mysql\nNAME    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\nmysql   ClusterIP   10.110.161.154   &lt;none&gt;        3306/TCP   24s\n</code></pre> <p>\u68c0\u67e5Service\u662f\u5426\u53ef\u7528\uff1a</p> <pre><code># telnet 10.110.161.154 3306\nTrying 10.110.161.154...\nConnected to 10.110.161.154.\nEscape character is '^]'.\nJ\n5.7.23/adMH4SqV,w+b'y?E8mysql_native_password\n</code></pre> <p>\u767b\u5f55MySQL\uff0c\u521b\u5efaExporter\u6240\u9700\u7684\u7528\u6237\u548c\u6743\u9650\uff08\u5982\u679c\u5df2\u7ecf\u6709\u9700\u8981\u76d1\u63a7\u7684MySQL\uff0c\u76f4\u63a5\u6267\u884c\u6b64\u6b65\u9aa4\u5373\u53ef\uff09\uff1a</p> <pre><code># kubectl exec -ti mysql-69d6f69557-5vnvg -- bash\nroot@mysql-69d6f69557-5vnvg:/# mysql -uroot -pmysql\n\nmysql&gt; CREATE USER 'exporter'@'%' IDENTIFIED BY 'exporter' WITH MAX_USER_CONNECTIONS 3;\nQuery OK, 0 rows affected (0.00 sec)\nmysql&gt; GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO 'exporter'@'%';\nQuery OK, 0 rows affected (0.00 sec)\nmysql&gt; quit\nBye\nroot@mysql-69d6f69557-5vnvg:/# exit\nexit\n</code></pre> <p>\u914d\u7f6eMySQL Exporter\u91c7\u96c6MySQL\u76d1\u63a7\u6570\u636e\uff1a</p> <p>mysql-exporter.yaml</p> <pre><code>---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: mysql-exporter\nnamespace: monitoring\nspec:\nreplicas: 1\nselector:\nmatchLabels:\nk8s-app: mysql-exporter\ntemplate:\nmetadata:\nlabels:\nk8s-app: mysql-exporter\nspec:\ncontainers:\n- name: mysql-exporter\nimage: registry.cn-beijing.aliyuncs.com/dotbalo/mysqld-exporter env:\n- name: DATA_SOURCE_NAME\nvalue: \"root:mysql@(mysql.default:3306)/\"\nimagePullPolicy: IfNotPresent\nports:\n- containerPort: 9104\n---\napiVersion: v1\nkind: Service\nmetadata:\nname: mysql-exporter\nnamespace: monitoring\nlabels:\nk8s-app: mysql-exporter\nspec:\ntype: ClusterIP\nselector:\nk8s-app: mysql-exporter\nports:\n- name: api\nport: 9104\nprotocol: TCP\n</code></pre> <p>\u6ce8 \u610f DATA_SOURCE_NAME \u7684 \u914d \u7f6e \uff0c \u9700\u8981\u5c06 <code>exporter:exporter@(mysql.default:3306)/</code>\u6539\u6210\u81ea\u5df1\u7684\u5b9e\u9645\u914d\u7f6e\uff0c\u683c\u5f0f\u4e3a\uff1a <code>USERNAME:PASSWORD@MYSQL_HOST_ADDRESS:MYSQL_PORT</code>\u3002</p> <p>\u521b\u5efaExporter\uff1a</p> <pre><code># kubectl create -f mysql-exporter.yaml\ndeployment.apps/mysql-exporter created\nservice/mysql-exporter created\n\n# kubectl get -f mysql-exporter.yaml\nNAME                             READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/mysql-exporter   1/1     1            1           9s\n\nNAME                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\nservice/mysql-exporter   ClusterIP   10.105.237.248   &lt;none&gt;        9104/TCP   9s\n</code></pre> <p>\u901a\u8fc7\u8be5Service\u5730\u5740\u68c0\u67e5\u662f\u5426\u80fd\u6b63\u5e38\u83b7\u53d6Metrics\u6570\u636e\uff1a</p> <pre><code># curl -s 10.105.237.248:9104/metrics | tail -1\npromhttp_metric_handler_requests_total{code=\"503\"} 0\n</code></pre> <p>2\uff0e\u914d\u7f6eServiceMonitor\u548cGrafana</p> <p>\u914d\u7f6eExporter\u540e\uff0cMetrics\u63a5\u53e3\u5df2\u7ecf\u6709\u4e86\uff0c\u5269\u4e0b\u7684\u914d\u7f6e\u5176\u5b9e\u548c\u4e91\u539f\u751f\u76d1\u63a7\u6d41\u7a0b\u5df2\u7ecf\u4e00\u6837\u4e86\u3002</p> <p>\u9996\u5148\u914d\u7f6eServiceMonitor\uff0c\u7136\u540e\u5bfc\u5165Grafana Dashboard\u5373\u53ef\u3002\u914d\u7f6eServiceMonitor\uff1a</p> <p>mysql-sm.yaml</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\nname: mysql-exporter\nnamespace: monitoring\nlabels:\nk8s-app: mysql-exporter\nnamespace: monitoring\nspec:\njobLabel: k8s-app\nendpoints:\n- port: api\ninterval: 30s\nscheme: http\nselector:\nmatchLabels:\nk8s-app: mysql-exporter\nnamespaceSelector:\nmatchNames:\n- monitoring\n</code></pre> <p>\u9700\u8981\u6ce8\u610fmatchLabels\u548cendpoints\u7684\u914d\u7f6e\uff0c\u8981\u548cMySQL\u7684Service\u4e00\u81f4\u3002 \u4e4b\u540e\u521b\u5efa\u8be5ServiceMonitor\uff1a</p> <pre><code># kubectl create -f mysql-sm.yaml\nservicemonitor.monitoring.coreos.com/mysql-exporter created\n</code></pre> <p>\u63a5\u4e0b\u6765\u5373\u53ef\u5728Prometheus Web UI\u770b\u5230\u8be5\u76d1\u63a7\uff0c\u5982\u56fe15.17\u6240\u793a\u3002</p> <p>)</p> <p>\u5bfc\u5165Grafana Dashboard, \u5730\u5740\u4e3ahttps://grafana.com/grafana/dashboards/6239\uff0c\u5bfc\u5165\u6b65\u9aa4\u548c\u4e4b\u524d\u7c7b\u4f3c\uff0c\u5728\u6b64\u4e0d\u518d\u6f14\u793a\u3002</p> <p>\u5bfc\u5165\u5b8c\u6210\u540e\uff0c\u5373\u53ef\u5728Grafana\u770b\u5230\u76d1\u63a7\u6570\u636e\uff0c\u5982\u56fe15.18\u6240\u793a\u3002</p> <p>) \u56fe15.18\u3000\u67e5\u770bMySQL\u76d1\u63a7</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#4\u9ed1\u76d2\u76d1\u63a7","title":"4.\u9ed1\u76d2\u76d1\u63a7","text":"<p>\u524d\u9762\u7684\u7ae0\u8282\u5bf9MySQL\u6216\u8005Etcd\u7684\u76d1\u63a7\u90fd\u662f\u76d1\u63a7\u5e94\u7528\u672c\u8eab\uff0c\u4e5f\u5c31\u662f\u7a0b\u5e8f\u5185\u90e8\u7684\u4e00\u4e9b\u6307\u6807\uff0c\u8fd9\u7c7b\u76d1\u63a7\u5173\u6ce8\u7684\u662f\u539f\u56e0\uff0c\u4e00\u822c\u4e3a\u51fa\u73b0\u95ee\u9898\u7684\u6839\u672c\uff0c\u6b64\u7c7b\u76d1\u63a7\u79f0\u4e3a\u767d\u76d2\u76d1\u63a7\u3002</p> <p>\u8fd8\u6709\u4e00\u7c7b\u76d1\u63a7\u5173\u6ce8\u7684\u662f\u73b0\u8c61\uff0c\u4e5f\u5c31\u662f\u6b63\u5728\u53d1\u751f\u7684\u544a\u8b66\uff0c\u6bd4\u5982\u67d0\u4e2a\u7f51\u7ad9\u7a81\u7136\u6162\u4e86\uff0c\u6216\u8005\u6253\u4e0d\u5f00\u4e86\u3002\u6b64\u7c7b\u544a\u8b66\u662f\u7ad9\u5728\u7528\u6237\u7684\u89d2\u5ea6\u770b\u5230\u7684\u4e1c\u897f\uff0c\u6bd4\u8f83\u5173\u6ce8\u73b0\u8c61\uff0c\u8868\u793a\u6b63\u5728\u53d1\u751f\u7684\u95ee\u9898\uff0c\u8fd9\u7c7b\u76d1\u63a7\u79f0\u4e3a\u9ed1\u76d2\u76d1\u63a7\u3002</p> <p>\u767d\u76d2\u76d1\u63a7\u53ef\u4ee5\u901a\u8fc7Exporter\u91c7\u96c6\u6570\u636e\uff0c\u9ed1\u76d2\u76d1\u63a7\u4e5f\u53ef\u4ee5\u901a\u8fc7Exporter\u91c7\u96c6\u6570\u636e\uff0c\u65b0\u7248\u672c\u7684Prometheus Stack\u5df2\u7ecf\u9ed8\u8ba4\u5b89\u88c5\u4e86Blackbox Exporter\uff0c\u53ef\u4ee5\u7528\u5176\u91c7\u96c6\u67d0\u4e2a\u57df\u540d\u3001\u63a5\u53e3\u6216\u8005TCP\u8fde\u63a5\u7684\u72b6\u6001\u3001\u662f\u5426\u53ef\u7528\u7b49\u3002</p> <p>\u65b0\u7248Prometheus Stack\u5df2\u7ecf\u9ed8\u8ba4\u5b89\u88c5\u4e86Blackbox Exporter\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\uff1a</p> <pre><code># kubectl get po -n monitoring -l app.kubernetes.io/name=blackbox-exporter\nNAME                                 READY   STATUS    RESTARTS   AGE\nblackbox-exporter-6798fb5bb4-nqstp   3/3     Running   0          14h\n</code></pre> <p>\u540c\u65f6\u4e5f\u4f1a\u521b\u5efa\u4e00\u4e2aService\uff0c\u53ef\u4ee5\u901a\u8fc7\u8be5Service\u8bbf\u95eeBlackbox Exporter\u5e76\u4f20\u9012\u4e00\u4e9b\u53c2\u6570\uff1a</p> <pre><code># kubectl get svc -n monitoring -l app.kubernetes.io/name=blackbox-exporter\nNAME                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)              AGE\nblackbox-exporter   ClusterIP   10.105.208.175   &lt;none&gt;        9115/TCP,19115/TCP   14h\n</code></pre> <p>\u6bd4\u5982\u68c0\u6d4bwww.baidu.com\uff08\u4f7f\u7528\u4efb\u4f55\u4e00\u4e2a\u516c\u7f51\u57df\u540d\u6216\u8005\u516c\u53f8\u5185\u7684\u57df\u540d\u63a2\u6d4b\u5373\u53ef\uff09\u7f51\u7ad9\u7684\u72b6\u6001\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u8fdb\u884c\u68c0\u67e5\uff1a</p> <pre><code># curl -s \"http://10.105.208.175:19115/probe?target=www.baidu.com&amp;module=http_2xx\" |tail -3\n# HELP probe_success Displays whether or not the probe was a success\n# TYPE probe_success gauge\nprobe_success 1\n</code></pre> <p>probe\u662f\u63a5\u53e3\u5730\u5740\uff0ctarget\u662f\u68c0\u6d4b\u7684\u76ee\u6807\uff0cmodule\u662f\u6307\u4f7f\u7528\u54ea\u4e2a\u6a21\u5757\u8fdb\u884c\u63a2\u6d4b\u3002</p> <p>\u5982\u679c\u96c6\u7fa4\u4e2d\u6ca1\u6709\u914d\u7f6eBlackbox Exporter, \u53ef\u4ee5\u53c2\u8003\u5982\u4e0b\u8fdb\u884c\u5b89\u88c5:</p> <p>https://github.com/prometheus/blackbox_exporter </p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#5prometheus\u9759\u6001\u914d\u7f6e","title":"5.Prometheus\u9759\u6001\u914d\u7f6e","text":"<p>\u524d\u9762\u51e0\u4e2a\u5c0f\u8282\u914d\u7f6e\u76d1\u63a7\u76ee\u6807\u65f6\uff0c\u7528\u7684\u90fd\u662fServiceMonitor\uff0c\u4f46\u662fServiceMonitor\u53ef\u80fd\u4f1a\u6709\u4e00\u4e9b\u9650\u5236 \u3002 \u6bd4\u5982 \uff0c \u5982\u679c\u6ca1\u6709\u5b89\u88c5 Prometheus Operator\uff0c\u53ef\u80fd\u5c31\u65e0\u6cd5\u4f7f\u7528ServiceMonitor\uff0c\u53e6\u5916\u5e76\u4e0d\u662f\u6240\u6709\u7684\u76d1\u63a7\u90fd\u80fd\u4f7f\u7528ServiceMonitor\u8fdb\u884c\u914d\u7f6e\uff0c\u6216\u8005\u4f7f\u7528ServiceMonitor\u914d\u7f6e\u663e\u5f97\u8fc7\u4e8e\u70e6\u7410\u3002</p> <p>\u4e0a\u4e00\u8282\u8bb2\u89e3\u7684\u9ed1\u76d2\u76d1\u63a7\u4f7f\u7528ServiceMonitor\u5c31\u663e\u5f97\u8fc7\u4e8e\u590d\u6742\uff0c\u4f7f\u7528\u4f20\u7edf\u7684\u914d\u7f6e\u65b9\u5f0f\uff0c\u76f4\u63a5\u5c06target\u4f20\u9012\u7ed9Blackbox Exporter\u5373\u53ef\u3002\u867d\u7136\u672c\u4e66\u4f7f\u7528\u7684\u662fOperator\u5b89\u88c5Prometheus\uff0c\u4f46\u662f\u5b83\u4e5f\u662f\u652f\u6301\u9759\u6001\u914d\u7f6e\u7684\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u6b65\u9aa4\u5f00\u542fPrometheus\u7684\u9759\u6001\u914d\u7f6e\u3002</p> <p>\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u7a7a\u6587\u4ef6\uff0c\u7136\u540e\u901a\u8fc7\u8be5\u6587\u4ef6\u521b\u5efa\u4e00\u4e2aSecret\uff0c\u8fd9\u4e2aSecret\u5373\u53ef\u4f5c\u4e3aPrometheus\u7684\u9759\u6001\u914d\u7f6e\uff1a</p> <pre><code># touch prometheus-additional.yaml\n# kubectl create secret generic additional-configs --from-file=prometheus-additional.yaml -n monitoring\nsecret/additional-configs created\n</code></pre> <p>\u521b\u5efa\u5b8cSecret\u540e\uff0c\u9700\u8981\u7f16\u8f91Prometheus\u7684\u914d\u7f6e\uff08\u89c1\u56fe15.19\uff09\uff1a</p> <pre><code># kubectl edit prometheus -n monitoring k8s\n</code></pre> <pre><code>spec:\nadditionalScrapeConfigs:\nkey: prometheus-additional.yaml\nname: additional-configs\noptional: true\nalerting:\nalertmanagers:\n- apiVersion: v2\nname: alertmanager-main\nnamespace: monitoring\nport: web\nenableFeatures: []\nexternalLabels: {}\nimage: quay.io/prometheus/prometheus:v2.29.1\nnodeSelector:\nkubernetes.io/os: linux\n</code></pre> <p>\u6dfb\u52a0\u4e0a\u8ff0\u914d\u7f6e\u540e\u4fdd\u5b58\u9000\u51fa\uff0c\u65e0\u987b\u91cd\u542fPrometheus\u7684Pod\u5373\u53ef\u751f\u6548\u3002</p> <p>\u4e4b\u540e\u5728prometheusadditional.yaml\u6587\u4ef6\u5185\u7f16\u8f91\u4e00\u4e9b\u9759\u6001\u914d\u7f6e\uff0c\u6b64\u5904\u7528\u9ed1\u76d2\u76d1\u63a7\u7684\u914d\u7f6e\u8fdb\u884c\u6f14\u793a\uff1a</p> <pre><code>- job_name: \"blackbox\"\n# \u8fd9\u91cc\u7684\u6307\u6807\u8def\u5f84\u662f /probe\nmetrics_path: /probe\nparams:\n# \u4f7f\u7528 http \u6a21\u5757\nmodelus: [http_2xx]\nstatic_configs:\n# \u68c0\u6d4b\u7684\u76ee\u6807\n- targets:\n- https://www.baidu.com\n- https://youdianzhishi.com\nrelabel_configs:\n- source_labels: [__address__]\ntarget_label: __param_target\n- source_labels: [__param_target]\ntarget_label: instance\n- target_label: __address__\nreplacement: blackbox-exporter:19115\n- job_name: 'other-node_exporter'\nstatic_configs:\n- targets: ['172.18.0.85:9100',\"172.18.0.84:9100\",\"172.18.0.83:9100\",\"172.18.0.82:9100\"]\n- job_name: 'node-exporter-others'\nstatic_configs:\n- targets:\n- *.*.*.149:31190\n- *.*.*.150:31190\n- *.*.*.122:31190\n- job_name: 'mysql-exporter'\nstatic_configs:\n- targets:\n- *.*.*.104:9592\n- *.*.*.125:9592\n- *.*.*.128:9592\n- job_name: 'nacos-exporter'\nmetrics_path: '/nacos/actuator/prometheus'\nstatic_configs:\n- targets:\n- *.*.*.113:8848\n- *.*.*.114:8848\n- *.*.*.118:8848\n- job_name: 'elasticsearch-exporter'\nstatic_configs:\n- targets:\n- *.*.*.110:9597\n- *.*.*.107:9597\n- *.*.*.117:9597\n- job_name: 'zookeeper-exporter'\nstatic_configs:\n- targets:\n- *.*.*.115:9595\n- *.*.*.121:9595\n- *.*.*.120:9595\n- job_name: 'nginx-exporter'\nstatic_configs:\n- targets:\n- *.*.*.149:9593\n- *.*.*.150:9593\n- *.*.*.122:9593\n- job_name: 'redis-exporter'\nstatic_configs:\n- targets:\n- *.*.*.109:9594\n- job_name: 'redis-exporter-targets'\nstatic_configs:\n- targets:\n- redis://*.*.*.146:7090\n- redis://*.*.*.144:7090\n- redis://*.*.*.133:7091\nmetrics_path: /scrape\nrelabel_configs:\n- source_labels: [__address__]\ntarget_label: __param_target\n- source_labels: [__param_target]\ntarget_label: instance\n- target_label: __address__\nreplacement: *.*.*.109:9594\n</code></pre> <ul> <li>targets\uff1a\u63a2\u6d4b\u7684\u76ee\u6807\uff0c\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u8fdb\u884c\u66f4\u6539\u3002</li> <li>params\uff1a\u4f7f\u7528\u54ea\u4e2a\u6a21\u5757\u8fdb\u884c\u63a2\u6d4b\u3002</li> <li>replacement\uff1aBlackbox Exporter\u7684\u5730\u5740\u3002</li> </ul> <p>\u53ef\u4ee5\u770b\u5230\u6b64\u5904\u7684\u5185\u5bb9\u548c\u4f20\u7edf\u914d\u7f6e\u7684\u5185\u5bb9\u4e00\u81f4\uff0c\u53ea\u9700\u8981\u6dfb\u52a0\u5bf9\u5e94\u7684job\u5373\u53ef\u3002\u4e4b\u540e\u901a\u8fc7\u8be5\u6587\u4ef6\u66f4\u65b0\u8be5Secret\uff1a</p> <pre><code># kubectl create secret generic additional-configs --from-file=prometheus-additional.yaml --dry-run=client -o yaml |kubectl replace -f - -n monitoring\nsecret/additional-configs replaced\n</code></pre> <p>\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u7a0d\u7b49\u4e00\u5206\u949f\u5373\u53ef\u5728Prometheus Web UI\u770b\u5230\u8be5\u914d\u7f6e\uff0c\u5982\u56fe15.20\u6240\u793a\u3002</p> <p>)</p> <p>\u56fe15.20\u3000\u67e5\u770b\u9ed1\u76d2\u76d1\u63a7Target</p> <p>\u76d1\u63a7\u72b6\u6001\u4e3aUP\u540e, \u5bfc\u5165\u9ed1\u76d2\u76d1\u63a7\u7684\u6a21\u677f\uff08https://grafana.com/grafana/dashboards/13659\uff09\u5373\u53ef,\u5982\u56fe15.21\u6240\u793a\u3002</p> <p>)</p> <p>\u4ee5\u4e0a\u6f14\u793a\u4e86\u9ed1\u76d2\u76d1\u63a7\u7684HTTP\u6a21\u5757\u7684\u4f7f\u7528\uff0c\u5176\u4ed6\u6a21\u5757\u7684\u4f7f\u7528\u65b9\u6cd5\u7c7b\u4f3c\uff0c\u53ef\u4ee5\u53c2\u8003\uff1a</p> <p>https://github.com/prometheus/blackbox_exporter\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#6prometheus\u76d1\u63a7windows\u5916\u90e8\u4e3b\u673a","title":"6.Prometheus\u76d1\u63a7Windows(\u5916\u90e8)\u4e3b\u673a","text":"<p>\u4e0a\u4e00\u8282\u6f14\u793a\u4e86\u4f7f\u7528Prometheus\u9759\u6001\u914d\u7f6e\u76d1\u63a7\u7f51\u7ad9\u7684\u53ef\u7528\u6027\uff0c\u63a5\u4e0b\u6765\u518d\u901a\u8fc7\u4e00\u4e2a\u5b9e\u4f8b\u6f14\u793a\u9759\u6001\u914d\u7f6e\u7684\u4f7f\u7528\uff0c\u540c\u65f6\u4e5f\u5b66\u4e60\u4e00\u4e0bKubernetes\u96c6\u7fa4\u5916\u90e8\u7684\u670d\u52a1\u662f\u5982\u4f55\u76d1\u63a7\u7684\u3002</p> <p>\u4f7f\u7528Prometheus\u76d1\u63a7Windows\u4e3b\u673a\u548cLinux\u4e3b\u673a\u5e76\u65e0\u592a\u5927\u533a\u522b\uff0c\u90fd\u662f\u4f7f\u7528\u793e\u533a\u7684Exporter\u91c7\u96c6\u6570\u636e\uff0c\u4e4b\u540e\u66b4\u9732\u4e00\u4e2aMetrics\u63a5\u53e3\uff0c\u53ef\u4ee5\u8ba9Prometheus\u91c7\u96c6\u5230\u4e3b\u673a\u7684\u6570\u636e\u3002</p> <p>\u5176\u4e2d </p> <ul> <li>\u76d1\u63a7Linux\u7684Exporter\u662f https://github.com/prometheus/node_exporter </li> <li>\u76d1\u63a7Windows\u4e3b\u673a\u7684Exporter\u662f https://github.com/prometheus-community/windows_exporter</li> </ul> <p>\u9996\u5148\u4e0b\u8f7d\u5bf9\u5e94\u7684Exporter\u81f3Windows\u4e3b\u673a \uff08 MSI\u6587\u4ef6\u4e0b\u8f7d\u5730\u5740 \uff1ahttps://github.com/prometheus-community/windows_exporter/releases\uff09\uff0c\u5982\u56fe15.22\u6240\u793a\u3002</p> <p>)</p> <p>\u56fe15.22\u3000\u4e0b\u8f7dWindows\u76d1\u63a7\u7ec4\u4ef6</p> <p>\u4e0b\u8f7d\u5b8c\u6210\u540e\uff0c\u53cc\u51fb\u6253\u5f00\u5373\u53ef\u5b8c\u6210\u5b89\u88c5\uff0c\u4e4b\u540e\u53ef\u4ee5\u5728\u4efb\u52a1\u7ba1\u7406\u5668\u4e0a\u770b\u5230\u5bf9\u5e94\u7684\u8fdb\u7a0b\uff0c\u5982\u56fe15.23\u6240\u793a\u3002</p> <p>)</p> <p>Windows Exporter\u4f1a\u66b4\u9732\u4e00\u4e2a9182\u7aef\u53e3\uff0c\u53ef\u4ee5\u901a\u8fc7\u8be5\u7aef\u53e3\u8bbf\u95eeWindows\u7684\u76d1\u63a7\u6570\u636e\u3002\u63a5\u4e0b\u6765\u5728\u9759\u6001\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u914d\u7f6e\uff1a</p> <p>Targets\u914d\u7f6e\u7684\u662f\u76d1\u63a7\u4e3b\u673a\uff0c\u5982\u679c\u662f\u591a\u53f0Windows\u4e3b\u673a\uff0c\u914d\u7f6e\u591a\u884c\u5373\u53ef\uff0c\u5f53\u7136\u6bcf\u53f0\u4e3b\u673a\u90fd\u9700\u8981\u914d\u7f6eExporter\u3002\u4e4b\u540e\u53ef\u4ee5\u5728Prometheus Web UI\u770b\u5230\u76d1\u63a7\u6570\u636e\uff0c\u5982\u56fe15.24\u6240\u793a\u3002</p> <pre><code>- job_name: 'WindowsServerMonitor'\nstatic_configs:\n- targets:\n- \"192.168.1.164:9182\"\nlabels:\nserver_type: 'windows'\nrelabel_configs:\n- source_labels: [__address__]\ntarget_label: instance\n</code></pre> <p>Targets\u914d\u7f6e\u7684\u662f\u76d1\u63a7\u4e3b\u673a\uff0c\u5982\u679c\u662f\u591a\u53f0Windows\u4e3b\u673a\uff0c\u914d\u7f6e\u591a\u884c\u5373\u53ef\uff0c\u5f53\u7136\u6bcf\u53f0\u4e3b\u673a\u90fd\u9700\u8981\u914d\u7f6eExporter\u3002</p> <p>\u4e4b\u540e\u53ef\u4ee5\u5728Prometheus Web UI\u770b\u5230\u76d1\u63a7\u6570\u636e\uff0c\u5982\u56fe15.24\u6240\u793a\u3002</p> <p>)</p> <p>\u56fe15.24\u3000\u67e5\u770bWindows\u76d1\u63a7\u6307\u6807</p> <p>\u4e4b\u540e\u5bfc\u5165\u6a21\u677f(\u5730 \u5740:https://grafana.com/grafana/dashboards/12566)\u5373\u53ef\uff0c\u5982\u56fe15.25\u6240\u793a\u3002</p> <p>)</p> <p>\u53ef\u4ee5\u770b\u5230Prometheus\u7684\u9759\u6001\u914d\u7f6e\u5927\u81f4\u6d41\u7a0b\u4e00\u81f4\uff0c\u914d\u7f6e\u5185\u5bb9\u4e5f\u7c7b\u4f3c\uff0c\u6240\u4ee5\u4e00\u4e9b\u4e0d\u65b9\u4fbf\u4f7f\u7528ServiceMonitor\u8fdb\u884c\u914d\u7f6e\u7684\uff0c\u53ef\u4ee5\u91c7\u7528\u9759\u6001\u914d\u7f6e\u7684\u65b9\u5f0f\uff0c\u5f53\u7136\u9759\u6001\u914d\u7f6e\u4e5f\u53ef\u4ee5\u91c7\u7528ServiceMonitor\u65b9\u5f0f\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#7prometheus\u8bed\u6cd5promql\u5165\u95e8","title":"7.Prometheus\u8bed\u6cd5PromQL\u5165\u95e8","text":"<p>\u524d\u9762\u5b66\u4e60\u4e86\u4e91\u539f\u751f\u5e94\u7528\u3001\u975e\u4e91\u539f\u751f\u5e94\u7528\u3001\u9ed1\u76d2\u76d1\u63a7\u548c\u96c6\u7fa4\u5916\u90e8\u4e3b\u673a\u76d1\u63a7\uff0c\u540c\u65f6\u5b66\u4e60\u4e86ServiceMonitor\u548c\u9759\u6001\u914d\u7f6e\u7684\u4f7f\u7528\uff0c\u638c\u63e1\u8fd9\u4e9b\u4ee5\u540e\uff0c\u751f\u4ea7\u73af\u5883\u7684\u5927\u90e8\u5206\u573a\u666f\u90fd\u53ef\u4ee5\u8fdb\u884c\u76d1\u63a7\u3002</p> <p>\u4f46\u662f\u76d1\u63a7\u5e76\u4e0d\u662f\u6700\u7ec8\u7684\u76ee\u7684\uff0c\u867d\u7136\u901a\u8fc7Grafana\u7684Dashboard\u80fd\u770b\u5230\u4e00\u4e9b\u76d1\u63a7\u5927\u5c4f\uff0c\u4f46\u662f\u9700\u8981\u76d1\u63a7\u7684\u5730\u65b9\u592a\u591a\uff0c\u5e76\u4e14\u6280\u672f\u4eba\u5458\u4e0d\u53ef\u80fd\u968f\u65f6\u968f\u5730\u90fd\u76ef\u7740Dashboard\uff0c\u6240\u4ee5\u9700\u8981\u5bf9\u4e25\u91cd\u7684\u544a\u8b66\u8fdb\u884c\u901a\u77e5\u3002</p> <p>\u63a5\u4e0b\u6765\u5c31\u9700\u8981\u7528\u5230Prometheus\u7684\u53e6\u4e00\u4e2a\u7ec4\u4ef6\u2014Alertmanager\uff0c\u4e3b\u8981\u7528\u6765\u8fdb\u884c\u544a\u8b66\u7684\u901a\u77e5\uff0c\u53ef\u4ee5\u91c7\u7528\u90ae\u7bb1\u3001\u9489\u9489\u3001\u5fae\u4fe1\u3001Slack\u3001Webhook\u7b49\u8fdb\u884c\u901a\u77e5\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#71-promql\u8bed\u6cd5\u521d\u4f53\u9a8c","title":"7.1 PromQL\u8bed\u6cd5\u521d\u4f53\u9a8c","text":"<p>\u5728\u5b66\u4e60\u544a\u8b66\u4e4b\u524d\uff0c\u5fc5\u987b\u638c\u63e1\u57fa\u7840\u7684Prometheus\u6570\u636e\u67e5\u8be2\u8bed\u6cd5 \u3002Prometheus\u67e5\u8be2\u8bed\u6cd5\u53ebPromQL\uff0c\u5c31\u50cfMySQL\u7684SQL\u8bed\u53e5\u3002</p> <p>\u9996\u5148\u6839\u636e\u67e5\u8be2\u8bed\u6cd5\u67e5\u51fa\u6765\u60f3\u8981\u7684\u6570\u636e\uff0c\u4e4b\u540e\u6839\u636e\u6761\u4ef6\u5224\u65ad\u5373\u53ef\u8fdb\u884c\u544a\u8b66\u3002</p> <p>PromQL Web UI\u7684Graph\u9009\u9879\u5361\u63d0\u4f9b\u4e86\u7b80\u5355\u7684\u7528\u4e8e\u67e5\u8be2\u6570\u636e\u7684\u5165\u53e3\uff0c\u5bf9\u4e8ePromQL\u7684\u7f16\u5199\u548c\u6821\u9a8c\u90fd\u53ef\u4ee5\u5728\u6b64\u4f4d\u7f6e\uff0c\u5982\u56fe15.26\u6240\u793a\u3002</p> <p>) \u56fe15.26\u3000\u9009\u62e9Graph</p> <p>\u6211\u4eec\u53ef\u4ee5\u5148\u8f93\u5165up\uff0c\u7136\u540e\u5355\u51fbExecute\uff0c\u5c31\u80fd\u67e5\u5230\u76d1\u63a7\u6b63\u5e38\u7684Target\uff0c\u5982\u56fe15.27\u6240\u793a\u3002</p> <p>)</p> <p>up\u547d\u4ee4\u53ef\u4ee5\u67e5\u5230\u6240\u6709\u6b63\u5e38\u76d1\u63a7\u7684\u76ee\u6807\uff0c\u5982\u679c\u76d1\u63a7\u7684\u76ee\u6807\u8fc7\u591a\uff0c\u53ef\u80fd\u4f1a\u67e5\u8be2\u51fa\u6765\u5f88\u591a\u6570\u636e\u3002\u6b64\u65f6\u53ef\u4ee5\u6839\u636e\u4e00\u4e9b\u6761\u4ef6\u8fdb\u884c\u8fc7\u6ee4\uff0c\u5c31\u50cfSQL\u8bed\u53e5\u7684where\u8bed\u6cd5\u3002\u6bd4\u5982\u901a\u8fc7\u6807\u7b7e\u9009\u62e9\u5668\u8fc7\u6ee4\u51fajob\u4e3anode-exporter\u7684\u76d1\u63a7\uff0c\u8bed\u6cd5\u4e3a\uff1aup{job=\"node-exporter\"}\uff0c\u5982\u56fe15.28\u6240\u793a\u3002</p> <p>) \u56fe15.28\u3000\u67e5\u770b\u4e3b\u673a\u76d1\u63a7</p> <p>\u6ce8\u610f\u6b64\u65f6up{job=\"node-exporter\"}\u5c5e\u4e8e\u7edd\u5bf9\u5339\u914d\uff0cProm?L\u4e5f\u652f\u6301\u5982\u4e0b\u8868\u8fbe\u5f0f\uff1a</p> <ul> <li>!=\uff1a\u8868\u793a\u4e0d\u7b49\u4e8e\u67d0\u4e2a\u503c\u7684\u6307\u6807\uff0c\u6bd4\u5982up{job!=\"node-exporter\"}\u8868\u793ajob\u4e0d\u4e3anode-exporter\u7684\u6307\u6807\u3002</li> <li>=~\uff1a\u8868\u793a\u7b26\u5408\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u6307\u6807\uff0c\u6bd4\u5982up{job=~\"node.*\"}\u8868\u793a\u6240\u6709\u4ee5node\u5f00\u5934\u7684\u6307\u6807\u3002</li> <li>!\uff1a\u548c=\u7c7b\u4f3c\uff0c=\u8868\u793a\u6b63\u5219\u5339\u914d\uff0c!\u8868\u793a\u6b63\u5219\u4e0d\u5339\u914d\uff0c\u4e5f\u5c31\u662f\u6392\u9664\u4e00\u4e9b\u6307\u6807\u3002</li> </ul> <p>\u5982\u679c\u60f3\u8981\u67e5\u770b\u4e3b\u673a\u76d1\u63a7\u7684\u6307\u6807\u6709\u54ea\u4e9b\uff0c\u53ef\u4ee5\u8f93\u5165node\uff0c\u4f1a\u63d0\u793a\u6240\u6709\u4e3b\u673a\u76d1\u63a7\u7684\u6307\u6807\uff0c\u5982\u56fe15.29\u6240\u793a\u3002 ) \u56fe15.29\u3000\u67e5\u770b\u4e3b\u673a\u76d1\u63a7\u6307\u6807</p> <p>\u5047\u5982\u60f3\u8981\u67e5\u8be2Kubernetes\u96c6\u7fa4\u4e2d\u6bcf\u4e2a\u5bbf\u4e3b\u673a\u7684\u78c1\u76d8\u603b\u91cf\uff0c\u53ef\u4ee5\u4f7f\u7528node_filesystem_size_bytes\uff0c\u5982\u56fe15.30\u6240\u793a\u3002</p> <p>) \u56fe15.30\u3000\u67e5\u770b\u78c1\u76d8\u7a7a\u95f4</p> <p>\u53ef\u4ee5\u770b\u5230\u6b64\u65f6\u67e5\u8be2\u7ed3\u679c\u8fc7\u591a\uff0c\u6211\u4eec\u53ef\u4ee5\u8fdb\u4e00\u6b65\u8fdb\u884c\u5904\u7406\uff0c\u6bd4\u5982\u53ea\u67e5\u8be2\u6839\u5206\u533a\u7684\u5927\u5c0f\uff0c\u6839\u636e\u524d\u6587\u63d0\u5230\u7684\u6807\u7b7e\u9009\u62e9\u5668\uff0c\u52a0\u4e0amountpoint\u5339\u914d\u89c4\u5219node_filesystem_size_bytes{mountpoint=\"/\"}\u5373\u53ef\uff0c\u5982\u56fe15.31\u6240\u793a\u3002</p> <p>) \u56fe15.31\u3000\u67e5\u770b\u6839\u5206\u533a\u7a7a\u95f4\u5927\u5c0f</p> <p>\u6216\u8005\u67e5\u8be2\u5206\u533a\u4e0d\u662f/boot\uff0c\u4e14\u78c1\u76d8\u662f/dev/\u5f00\u5934\u7684\u5206\u533a\u5927\u5c0f\uff08\u7ed3\u679c\u4e0d\u518d\u5c55\u793a\uff09\uff1a</p> <pre><code>node_filesystem_size_bytes{device=~\"/dev/.*\",mountpoint!=\"/boot\"}\n</code></pre> <p>\u4e0a\u8ff0\u7684PromQL\u67e5\u8be2\u51fa\u6765\u7684\u6570\u636e\u90fd\u662f\u77ac\u65f6\u503c\uff0c\u4e5f\u5c31\u662fPrometheus\u91c7\u96c6\u5230\u7684\u6700\u65b0\u7684\u6570\u636e\uff0c\u5728\u65f6\u5e8f\u6570\u636e\u5e93\u4e2d\u88ab\u79f0\u4e3a\u77ac\u65f6\u5411\u91cf\u3002\u56e0\u4e3aPrometheus\u672c\u8eab\u662f\u4e00\u4e2a\u65f6\u5e8f\u6570\u636e\u5e93\uff0c\u6240\u4ee5\u4e5f\u53ef\u4ee5\u67e5\u8be2\u67d0\u4e2a\u6307\u6807\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u6570\u636e\uff0c\u6bd4\u5982\u67e5\u8be2\u4e3b\u673ak8s-master01\u5728\u6700\u8fd15\u5206\u949f\u53ef\u7528\u7684\u78c1\u76d8\u7a7a\u95f4\u53d8\u5316\uff08\u89c1\u56fe15.32\uff09\uff1a</p> <pre><code>node_filesystem_avail_bytes{instance=\"giteego-k8s-m1\",mountpoint=\"/\",device=\"/dev/sda1\"}[5m]\n</code></pre> <p>) \u56fe15.32\u3000\u67e5\u770b\u6700\u8fd15\u5206\u949f\u7684\u6570\u636e</p> <p>\u53ef\u4ee5\u770b\u5230\u67e5\u8be2\u7684\u6570\u636e\u6709\u4e00\u4e2a\u65f6\u95f4\u6233\uff08\u67e5\u8be2\u7ed3\u679c@\u7b26\u53f7\u540e\u9762\uff09\uff0c\u8fd9\u4e2a\u65f6\u95f4\u6233\u8bb0\u5f55\u4e86\u6570\u636e\u6837\u672c\u7684\u8bb0\u5f55\u65f6\u95f4\u3002</p> <p>\u5e76\u4e14\u80fd\u770b\u5230\u6709\u591a\u6761\u67e5\u8be2\u7ed3\u679c\u4e3a\u8fd95\u5206\u949f\u5185\u7684\u6240\u6709\u6570\u636e\uff0c\u8fd9\u79cd\u67e5\u8be2\u4e00\u6bb5\u65f6\u95f4\u8303\u56f4\u5185\u7684\u6570\u636e\u7ed3\u679c\u88ab\u79f0\u4e3a\u533a\u95f4\u5411\u91cf\u3002\u76ee\u524d\u652f\u6301\u7684\u8303 \u56f4\u5355\u4f4d\u5982\u4e0b\uff1a</p> <ul> <li>s\uff1a\u79d2\u3002</li> <li>m\uff1a\u5206\u949f\u3002</li> <li>h\uff1a\u5c0f\u65f6\u3002</li> <li>d\uff1a\u5929\u3002</li> <li>w\uff1a\u5468\u3002</li> <li>y\uff1a\u5e74\u3002</li> </ul> <p>\u9664\u4e86\u80fd\u67e5\u8be2\u533a\u95f4\u5411\u91cf\u548c\u77ac\u65f6\u5411\u91cf\u7684\u6570\u636e\uff0cPrometheus\u4e5f\u652f\u6301\u67e5\u8be2\u51e0\u5206\u949f\u4e4b\u524d\u7684\u6570\u636e\u6216\u8005\u51e0\u5206\u949f\u4e4b\u524d\u7684\u4e00\u6bb5\u65f6\u95f4\u8303\u56f4\u5185\u7684\u6570\u636e\uff0c\u6bd4\u5982\u67e5\u8be210\u5206\u949f\u4e4b\u524d\u78c1\u76d8\u7684\u53ef\u7528\u7a7a\u95f4\uff0c\u53ea\u9700\u8981\u6307\u5b9aoffset\u53c2\u6570\u5373\u53ef\uff1a</p> <pre><code>node_filesystem_avail_bytes{instance=\"giteego-k8s-m1\",mountpoint=\"/\",device=\"/dev/sda1\"} offset 10m\n</code></pre> <p>\u6216\u8005\u67e5\u8be210\u5206\u949f\u4e4b\u524d\uff0c5\u5206\u949f\u533a\u95f4\u7684\u78c1\u76d8\u53ef\u7528\u7a7a\u95f4\u7684\u53d8\u5316\uff1a</p> <pre><code>node_filesystem_avail_bytes{instance=\"giteego-k8s-m1\",mountpoint=\"/\",device=\"/dev/sda1\"}[5m] offset 10m\n</code></pre>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#72-promql\u64cd\u4f5c\u7b26","title":"7.2 PromQL\u64cd\u4f5c\u7b26","text":"<p>\u4e0a\u4e00\u5c0f\u8282\u6211\u4eec\u901a\u8fc7PromQL\u7684\u8bed\u6cd5\u67e5\u5230\u4e86\u4e3b\u673a\u78c1\u76d8\u7684\u7a7a\u95f4\u6570\u636e\uff0c\u67e5\u8be2\u7ed3\u679c\u5982\u56fe15.33\u6240\u793a\u3002</p> <p>) \u56fe15.33\u3000\u67e5\u770b\u4e3b\u673a\u78c1\u76d8\u7a7a\u95f4\u6570\u636e</p> <p>\u53ef\u4ee5\u770b\u5230\u6b64\u65f6\u7684\u6570\u636e\u4e3a16358440960\uff0c\u8fd9\u4e2a\u7ed3\u679c\u5e76\u4e0d\u9002\u5408\u76f4\u63a5\u9605\u8bfb\uff0c\u56e0\u4e3a\u5b83\u8fd4\u56de\u7684\u6570\u636e\u5355\u4f4d\u4e3a\u5b57\u8282\uff08bytes\uff0c\u5176\u4ed6\u6307\u6807\u53ef\u80fd\u662f\u5176\u4ed6\u5355\u4f4d\uff09\u3002\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u5c06\u5b57\u8282\u8f6c\u6362\u4e3aGB\u6216\u8005MB\uff1a</p> <pre><code>node_filesystem_avail_bytes{instance=\"giteego-k8s-m1\",mountpoint=\"/\",device=\"/dev/sda1\"} / 1024 / 1024 / 1024\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u5c061024/1024/1024\u6539\u4e3a(1024 ^ 3)\uff1a</p> <pre><code>node_filesystem_avail_bytes{instance=\"giteego-k8s-m1\",mountpoint=\"/\",device=\"/dev/sda1\"} / (1024 ^3) \n</code></pre> <p>\u67e5\u8be2\u7ed3\u679c\u5982\u56fe15.34\u6240\u793a\uff0c\u6b64\u65f6\u4e3a12GB\u5de6\u53f3\u3002</p> <p>) \u56fe15.34\u3000\u67e5\u770b\u7a7a\u95f4\u5927\u5c0f</p> <p>\u6b64\u65f6\u53ef\u4ee5\u5728\u5bbf\u4e3b\u673a\u4e0a\u6bd4\u5bf9\u6570\u636e\u662f\u5426\u6b63\u786e\uff1a</p> <pre><code># df -Th|grep /dev/sda1\n/dev/sda1      xfs        20G  7.4G   13G  37% /\n</code></pre> <p>\u4e0a\u8ff0\u4f7f\u7528\u7684\u201c/\u201d\u4e3a\u6570\u5b66\u8fd0\u7b97\u7684\u201c\u9664\u201d\uff0c\u201c^\u201d\u4e3a\u5e42\u8fd0\u7b97\uff0c\u540c\u65f6\u4e5f\u652f\u6301\u5982\u4e0b\u8fd0\u7b97\u7b26\uff1a</p> <ul> <li>+\uff1a\u52a0\u3002</li> <li>\u2012\uff1a\u51cf\u3002</li> <li>*\uff1a\u4e58\u3002</li> <li>/\uff1a\u9664\u3002</li> <li>^\uff1a\u5e42\u8fd0\u7b97\u3002</li> <li>%\uff1a\u6c42\u4f59\u3002</li> </ul> <p>\u901a\u8fc7\u4e0d\u540c\u7684\u6307\u6807\u7ed3\u5408\u4e0d\u540c\u7684\u8868\u8fbe\u5f0f\u53ef\u4ee5\u67e5\u8be2\u5230\u4e0d\u540c\u7684\u6570\u636e\uff0c\u6bd4\u5982\u8981\u67e5\u8be2k8s-master01\u6839\u533a\u5206\u78c1\u76d8\u7684\u53ef\u7528\u7387\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u6307\u4ee4\u8fdb\u884c\u8ba1\u7b97\uff1a</p> <pre><code>node_filesystem_avail_bytes{instance=\"giteego-k8s-m1\",mountpoint=\"/\",device=\"/dev/sda1\"}  /node_filesystem_size_bytes{instance=\"giteego-k8s-m1\",mountpoint=\"/\",device=\"/dev/sda1\"}\n</code></pre> <p>node_filesystem_avail_bytes \u4e3a \u7cfb \u7edf \u53ef \u7528 \u7684 \u78c1 \u76d8 \u7a7a \u95f4 \uff0cnode_filesystem_size_bytes\u4e3a\u78c1\u76d8\u7a7a\u95f4\u7684\u603b\u5927\u5c0f\uff0c\u6240\u4ee5\u4e24\u8005\u7684\u6bd4\u503c\u5373\u4e3a\u78c1 \u76d8\u7a7a\u95f4\u7684\u53ef\u7528\u7387\u3002\u5f53\u7136\u4e5f\u53ef\u4ee5\u53bb\u6389instance\u53c2\u6570\uff0c\u67e5\u8be2\u6240\u6709\u4e3b\u673a\u6839\u5206\u533a\u7684\u53ef\u7528\u7387\uff08\u89c1\u56fe15.35\uff09\uff1a</p> <pre><code>node_filesystem_avail_bytes{mountpoint=\"/\"} /node_filesystem_size_bytes{mountpoint=\"/\"}\n</code></pre> <p>) \u56fe15.35\u3000\u67e5\u770b\u78c1\u76d8\u53ef\u7528\u7387</p> <p>\u4e5f\u53ef\u4ee5\u5c06\u7ed3\u679c\u4e58\u4ee5100\u76f4\u63a5\u5f97\u5230\u767e\u5206\u6bd4\uff1a</p> <pre><code>node_filesystem_avail_bytes{mountpoint=\"/\"} /node_filesystem_size_bytes{mountpoint=\"/\"} * 100\n</code></pre> <p>\u901a\u8fc7\u4e0a\u8ff0\u64cd\u4f5c\u7b26\u7684\u5b66\u4e60\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u8be2\u5230\u4e3b\u673a\u78c1\u76d8\u7684\u4f7f\u7528\u4fe1\u606f\uff0c\u8bfb\u8005\u53ef\u4ee5\u6839\u636e\u4e0a\u8ff0\u8bed\u53e5\u5c1d\u8bd5\u67e5\u8be2\u5176\u4ed6\u6307\u6807\u4fe1\u606f\uff0c\u6bd4\u5982CPU\u3001\u5185\u5b58\u7684\u4f7f\u7528\u7387\u7b49\uff0c\u5982\u56fe15.36\u6240\u793a\u3002</p> <p>)</p> <p>\u56fe15.36\u3000\u67e5\u770b\u78c1\u76d8\u53ef\u7528\u767e\u5206\u6bd4</p> <p>\u867d\u7136\u53ef\u4ee5\u901a\u8fc7\u4e0a\u8ff0\u8bed\u53e5\u67e5\u8be2\u5230\u4e00\u4e9b\u6307\u6807\uff0c\u4f46\u662f\u8fd9\u4e9b\u6307\u6807\u53ef\u80fd\u5e76\u975e\u6211\u4eec\u6700\u7ec8\u60f3\u8981\u7684\u3002</p> <p>\u6bd4\u5982\u60f3\u8981\u627e\u5230\u96c6\u7fa4\u4e2d\u6839\u5206\u533a\u7a7a\u95f4\u53ef\u7528\u7387\u5927\u4e8e60%\u7684\u4e3b\u673a\uff0c\u6b64\u65f6\u53ef\u4ee5\u5c06\u67e5\u8be2\u8bed\u53e5\u6dfb\u52a0\u4e00\u4e2a\u5224\u65ad\u6761\u4ef6\uff0c\u5f97\u5230\u81ea\u5df1\u60f3\u8981\u7684\u7ed3\u679c\uff0c\u6bd4\u5982\uff1a</p> <pre><code>node_filesystem_avail_bytes{mountpoint=\"/\"} /node_filesystem_size_bytes{mountpoint=\"/\"} * 100 &gt;60\n</code></pre> <p>\u7ed3\u679c\u5982\u56fe15.37\u6240\u793a\u3002</p> <p>) \u56fe15.37\u3000\u67e5\u770b\u78c1\u76d8\u53ef\u7528\u7387\u5927\u4e8e60%\u7684\u4e3b\u673a</p> <p>\u6b64\u65f6\u5f97\u5230\u7684\u7ed3\u679c\u4e3a\u76d1\u63a7\u76ee\u6807\u4e3b\u673a\u78c1\u76d8\u53ef\u7528\u7387\u5927\u4e8e60%\u7684\u4e3b\u673a\uff0c\u5982\u679c\u5c06\u5927\u4e8e60\u6539\u4e3a\u5c0f\u4e8e20\uff0c\u5c31\u662f\u67e5\u8be2\u6240\u6709\u78c1\u76d8\u53ef\u7528\u7387\u5c0f\u4e8e20%\u7684\u4e3b\u673a\uff0c\u6b64\u65f6\u662f\u4e0d\u662f\u5c31\u5e94\u8be5\u4ea7\u751f\u544a\u8b66\uff1f\u6240\u4ee5\u8bf4\u5c06PromQL\u7684\u8bed\u6cd5\u7a0d\u52a0\u6539\u9020\u5373\u4e3a\u6211\u4eec\u60f3\u8981\u7684\u544a\u8b66\u6761\u4ef6\u3002</p> <pre><code>node_filesystem_avail_bytes{mountpoint=\"/\"} /node_filesystem_size_bytes{mountpoint=\"/\"} * 100 &lt;20\n</code></pre> <p>\u9664\u4e86\u4ee5\u4e0a\u5224\u65ad\u8bed\u6cd5\u5916\uff0cPromQL\u4e5f\u652f\u6301\u5982\u4e0b\u5224\u65ad\uff1a</p> <ul> <li>==\uff1a\u76f8\u7b49\u3002</li> <li>!=\uff1a\u4e0d\u76f8\u7b49\u3002</li> <li>\uff1a\u5927\u4e8e\u3002</li> <li>&lt;\uff1a\u5c0f\u4e8e\u3002</li> <li>=\uff1a\u5927\u4e8e\u7b49\u4e8e\u3002</li> <li>&lt;=\uff1a\u5c0f\u4e8e\u7b49\u4e8e\u3002</li> </ul> <p>\u4e0a\u8ff0\u8bed\u6cd5\u53ea\u662f\u505a\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u5224\u65ad\uff0c\u6bd4\u5982\u53ea\u8fc7\u6ee4\u4e86\u78c1\u76d8\u53ef\u7528\u7387\u5927\u4e8e60%\u7684\u6307\u6807\uff0c\u5982\u679c\u60f3\u8981\u8fc7\u6ee4\u5176\u4ed6\u8303\u56f4\u4e5f\u662f\u652f\u6301\u7684\uff0c\u6bd4\u5982\u78c1\u76d8\u53ef\u7528\u7387\u5927\u4e8e30%\u5c0f\u4e8e\u7b49\u4e8e60%\u7684\u4e3b\u673a\uff1a</p> <pre><code>30 &lt; node_filesystem_avail_bytes{mountpoint=\"/\"} /node_filesystem_size_bytes{mountpoint=\"/\"} * 100 &lt;=60\n</code></pre> <p>\u5728\u8bed\u53e5\u7684\u524d\u9762\u52a0\u4e0a\u201c30&lt;\u201d\uff0c\u540e\u9762\u52a0\u4e0a\u201c&lt;=\u201d60\u3002\u4e5f\u53ef\u4ee5\u7528and\u8fdb\u884c\u8054\u5408\u67e5\u8be2\uff1a</p> <pre><code>(node_filesystem_avail_bytes{mountpoint=\"/\"} /node_filesystem_size_bytes{mountpoint=\"/\"}) * 100 &gt; 30 and (node_filesystem_avail_bytes{mountpoint=\"/\"} /node_filesystem_size_bytes{mountpoint=\"/\"}) * 100 &lt;= 60\n</code></pre> <p>\u9664\u4e86and\u5916\uff0c\u4e5f\u652f\u6301or\u548cunless\uff1a</p> <ul> <li>and\uff1a\u5e76\u4e14\u3002</li> <li>or\uff1a\u6216\u8005\u3002</li> <li>unless\uff1a\u6392\u9664\u3002</li> </ul> <p>\u7531\u4e0a\u53ef\u77e5\uff0cand\u662f\u5fc5\u987b\u4e24\u4e2a\u6761\u4ef6\u90fd\u7b26\u5408\uff0cor\u53ea\u9700\u8981\u7b26\u5408\u5176\u4e2d\u4e00\u4e2a\u5373\u53ef\uff0c\u8bfb\u8005\u53ef\u4ee5\u81ea\u884c\u7ec3\u4e60\u3002</p> <p>\u800cunless\u662f\u6392\u9664\u67d0\u4e2a\u6307\u6807\uff0c\u6bd4\u5982\u67e5\u8be2\u4e3b\u673a\u78c1\u76d8\u5269\u4f59\u7a7a\u95f4\uff0c\u5e76\u4e14\u6392\u9664\u6389shm\u548ctmpfs\u7684\u78c1\u76d8\uff1a</p> <pre><code>node_filesystem_free_bytes unless node_filesystem_free_bytes{device=~\"shm|tmpfs\"}\n</code></pre> <p>\u5f53\u7136\uff0c\u8fd9\u4e2a\u8bed\u6cd5\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5199\u4e3a\uff1a</p> <pre><code>node_filesystem_free_bytes{device!~\"shm|tmpfs\"}\n</code></pre>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#73-promql\u5e38\u7528\u51fd\u6570","title":"7.3 PromQL\u5e38\u7528\u51fd\u6570","text":"<p>\u4e0a\u4e00\u5c0f\u8282\u4f7f\u7528PromQL\u67e5\u8be2\u4e86\u4e00\u4e9b\u6307\u6807\uff0c\u63a5\u4e0b\u6765\u901a\u8fc7PromQL\u4e00\u4e9b\u5e38\u7528\u7684\u51fd\u6570\u5bf9\u6570\u636e\u8fdb\u4e00\u6b65\u5904\u7406\u3002\u6bd4\u5982\u4f7f\u7528sum\u51fd\u6570\u7edf\u8ba1\u5f53\u524d\u76d1\u63a7\u76ee\u6807\u6240\u6709\u4e3b\u673a\u6839\u5206\u533a\u5269\u4f59\u7684\u7a7a\u95f4\uff08\u89c1\u56fe15.38\uff09\uff1a</p> <pre><code>sum(node_filesystem_free_bytes{mountpoint=\"/\"}) / 1024^3\n</code></pre> <p>) \u56fe15.38\u3000sum\u7edf\u8ba1</p> <p>\u4e5f\u53ef\u4ee5\u7528\u540c\u6837\u65b9\u5f0f\u8ba1\u7b97\u6240\u6709\u7684\u8bf7\u6c42\u603b\u91cf\uff1a</p> <pre><code>sum(http_requests_total)\n</code></pre> <p>sum(http_request_total)\u662f\u5bf9\u6240\u6709\u7684\u8bf7\u6c42\u8fdb\u884c\u6c47\u603b\uff0c\u5982\u679c\u60f3\u8981\u7edf\u8ba1\u66f4\u52a0\u7ec6\u7c92\u5ea6\u7684\u6307\u6807\uff0c\u53ef\u4ee5\u52a0\u4e0a\u5bf9\u5e94\u7684\u5339\u914d\u6761\u4ef6\uff0c\u6bd4\u5982\u60f3\u8981\u7edf\u8ba1\u6240\u6709\u72b6\u6001\u7801\u4e3a200\u7684\u8bf7\u6c42\u3002</p> <p>\u63a5\u4e0b\u6765\u901a\u8fc7http_request_total\u5b66\u4e60\u7ec6\u7c92\u5ea6\u7684\u7edf\u8ba1\uff0c\u9996\u5148\u770b\u4e00\u4e0bhttp_request_total\u7684\u6570\u636e\u7c7b\u578b\u662f\u600e\u6837\u7684 \u3002 </p> <p>\u53ef\u4ee5\u76f4\u63a5\u67e5\u8be2http_request_total\u7684\u6570\u636e\uff08\u89c1\u56fe15.39\uff09\uff1a</p> <p>) \u56fe15.39\u3000sum\u7edf\u8ba1\u8bf7\u6c42\u6570</p> <p>\u4e0a\u9762\u53ea\u5c55\u793a\u4e86\u4e00\u6761\u6570\u636e\uff0c\u53ef\u4ee5\u770b\u5230\u6709handler\u3001statuscode\u548cmethod\uff0c\u4e5f\u5c31\u662f\u8be5\u6761\u6570\u636e\u53ef\u4ee5\u4ee3\u8868\u8bbf\u95ee\u6839\u8def\u5f84\u72b6\u6001\u4e3a200\u4e14\u8bf7\u6c42\u65b9\u5f0f\u4e3aget\u7684\u7edf\u8ba1\uff0c\u6570\u91cf\u4e3a10\u3002</p> <p>\u7531\u8be5\u6761\u6570\u636e\u7ed3\u5408sum\u51fd\u6570\uff0c\u53ef\u4ee5\u6839\u636estatuscode\u5b57\u6bb5\u7edf\u8ba1\u8bf7\u6c42\u6570\u636e\uff08\u89c1\u56fe15.40\uff09\uff1a</p> <pre><code>sum(http_request_total) by (statuscode)\n</code></pre> <p>) \u56fe15.40\u3000\u6839\u636e\u5b57\u6bb5\u8fdb\u884c\u7edf\u8ba1</p> <p>\u53ef\u4ee5\u770b\u5230\u72b6\u6001\u7801\u4e3a404\u7684\u8bf7\u6c42\u6b21\u6570\u662f12\uff0c\u72b6\u6001\u7801\u4e3a200\u7684\u8bf7\u6c42\u6b21\u6570\u662f7156\u3002\u540c\u65f6\u4e5f\u53ef\u4ee5\u6839\u636estatuscode\u548chandler\u4e24\u4e2a\u6307\u6807\u8fdb\u4e00\u6b65\u7edf\u8ba1\uff08\u89c1\u56fe15.41\uff09\uff1a</p> <pre><code>sum(http_request_total) by (statuscode, handler)\n</code></pre> <p>) \u56fe15.41\u3000\u6839\u636e\u591a\u4e2a\u5b57\u6bb5\u7edf\u8ba1</p> <p>\u4e0a\u8ff0\u8bed\u53e5\u53ef\u4ee5\u7edf\u8ba1\u51fa\u8bbf\u95ee\u67d0\u4e2a\u8def\u5f84\u4e14\u72b6\u6001\u7801\u4e3a\u67d0\u4e2a\u503c\u7684\u7edf\u8ba1\u7ed3\u679c\u3002</p> <p>\u6b64\u65f6\u6211\u4eec\u53ef\u4ee5\u7ee7\u7eed\u4f7f\u7528topk\u51fd\u6570\uff0c\u627e\u5230\u7edf\u8ba1\u7ed3\u679c\u4e2d\u6b21\u6570\u6700\u591a\u7684\u51e0\u4e2a\u7ed3\u679c\u3002\u6bd4\u5982\u627e\u5230\u6392\u540d\u524d5\u7684\u6570\u636e\uff08\u4e3a\u8282\u7701\u7bc7\u5e45\uff0c\u7ed3\u679c\u4e0d\u518d\u5c55\u793a\uff09\uff1a</p> <pre><code>topk(5, sum(http_request_total) by (statuscode, handler))\n</code></pre> <p>PromQL\u5f00\u7bb1\u5373\u7528\u7684\u51fd\u6570\u6709\u5f88\u591a\uff0c\u6bd4\u5982\u53d6\u6700\u540e3\u4e2a\u6570\u636e\uff1a</p> <pre><code>grafana(3, sum(http_request_total) by (statuscode, handler))\n</code></pre> <p>\u627e\u51fa\u7edf\u8ba1\u7ed3\u679c\u4e2d\u6700\u5c0f\u7684\u6570\u636e\uff1a</p> <pre><code>min(node_filesystem_avail_bytes{mountpoint=\"/\"})\n</code></pre> <p>\u6700\u5927\u7684\u6570\u636e\uff1a</p> <pre><code>max(node_filesystem_avail_bytes{mountpoint=\"/\"})\n</code></pre> <p>\u5e73\u5747\u503c\uff1a</p> <pre><code>avg(node_filesystem_avail_bytes{mountpoint=\"/\"})\n</code></pre> <p>\u56db\u820d\u4e94\u5165\uff0c\u5411\u4e0a\u53d6\u6700\u63a5\u8fd1\u7684\u6574\u6570\uff0c\u6bd4\u59822.79\u21923\uff1a</p> <pre><code>ceil(node_filesystem_files_free{mountpoint=\"/\"} / 1024 / 1024)\n</code></pre> <p>\u5411\u4e0b\u53d6\u6574\u6570\uff0c\u6bd4\u59822.79\u21922\uff1a</p> <pre><code>floor(node_filesystem_files_free{mountpoint=\"/\"} / 1024 / 1024)\n</code></pre> <p>\u5bf9\u7ed3\u679c\u8fdb\u884c\u6b63\u5411\u6392\u5e8f\uff1a</p> <pre><code>sort(sum(http_request_total) by (handler, statuscode))\n</code></pre> <p>\u5bf9\u7ed3\u679c\u8fdb\u884c\u9006\u5411\u6392\u5e8f\uff1a</p> <pre><code>sort_desc(sum(http_request_total) by (handler, statuscode))\n</code></pre> <p>predict_linear\u51fd\u6570\u53ef\u4ee5\u7528\u4e8e\u9884\u6d4b\u5206\u6790\u548c\u9884\u6d4b\u6027\u544a\u8b66\uff0c\u6bd4\u5982\u53ef\u4ee5\u6839\u636e\u4e00\u5929\u7684\u6570\u636e\u9884\u6d4b4\u4e2a\u5c0f\u65f6\u540e\u78c1\u76d8\u5206\u533a\u7684\u7a7a\u95f4\u4f1a\u4e0d\u4f1a\u5c0f\u4e8e0\uff1a</p> <pre><code>predict_linear(node_filesystem_files_free{mountpoint=\"/\"}[1d],4*3600) &lt; 0\n</code></pre> <p>\u9664\u4e86\u4e0a\u8ff0\u51fd\u6570\uff0c\u8fd8\u6709\u51e0\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u51fd\u6570\uff0c\u6bd4\u5982increase\u3001rate\u3001irate\u3002</p> <p>\u5176\u4e2dincrease\u7528\u4e8e\u8ba1\u7b97\u5728\u4e00\u6bb5\u65f6\u95f4\u8303\u56f4\u5185\u6570\u636e\u7684\u589e\u957f\uff0crate\u548cirate\u7528\u4e8e\u8ba1\u7b97\u589e\u957f\u7387\u3002\u6bd4\u5982\u67e5\u8be2\u67d0\u4e2a\u8bf7\u6c42\u57281\u5c0f\u65f6\u5185\u589e\u957f\u4e86\u591a\u5c11\uff1a</p> <pre><code>increase(http_request_total{handler=\"/api/datasources/proxy/:id/*\",method=\"get\",namespace=\"monitoring\",service=\"grafana\",statuscode=\"200\"}[1h])\n</code></pre> <p>\u5c061\u5c0f\u65f6\u589e\u957f\u7684\u6570\u91cf\u9664\u4ee5\u8be5\u65f6\u95f4\u5373\u4e3a\u589e\u957f\u7387\uff1a</p> <pre><code>increase(http_request_total{handler=\"/api/datasources/proxy/:id/*\",method=\"get\",namespace=\"monitoring\",service=\"grafana\",statuscode=\"200\"}[1h]) / 3600\n</code></pre> <p>\u5f53\u7136\uff0cincrease\u4e5f\u53ef\u4ee5\u7528\u4e8e\u78c1\u76d8\u3001CPU\u3001\u5185\u5b58\u7b49\u6307\u6807\uff0c\u8bfb\u8005\u53ef\u4ee5\u53d1\u6325\u4e00\u4e0b\u81ea\u5df1\u7684\u60f3\u8c61\u3002</p> <p>\u76f8\u5bf9\u4e8eincrease\uff0crate\u53ef\u4ee5\u76f4\u63a5\u8ba1\u7b97\u51fa\u67d0\u4e2a\u6307\u6807\u5728\u7ed9\u5b9a\u65f6\u95f4\u8303\u56f4\u5185\u7684\u589e\u957f\u7387\uff0c\u6bd4\u5982\u8fd8\u662f\u8ba1\u7b971\u5c0f\u65f6\u7684\u589e\u957f\u7387\uff0c\u53ef\u4ee5\u7528rate\u51fd\u6570\u8fdb\u884c\u8ba1\u7b97\uff1a</p> <pre><code>rate(http_request_total{handler=\"/api/datasources/proxy/:id/*\",method=\"get\",namespace=\"monitoring\",service=\"grafana\",statuscode=\"200\"}[1h])\n</code></pre> <p>\u5728\u4f7f\u7528rate\u548cincrease\u65f6\uff0c\u96be\u514d\u4f1a\u9047\u5230\u4e00\u4e2a\u95ee\u9898\uff0c\u5c31\u662f\u5e38\u8bf4\u7684\u201c\u957f\u5c3e\u6548\u5e94\u201d\uff0c\u4e5f\u5c31\u662f\u67d0\u4e2a\u6307\u6807\u4e00\u76f4\u5904\u4e8e\u4e00\u4e2a\u6570\u503c\uff0c\u8fd9\u4e2a\u589e\u957f\u7387\u5373\u4e3a0\uff0c\u6b64\u65f6\u4f1a\u51fa\u73b0\u8bef\u5224\u3002</p> <p>\u6bd4\u5982\u67d0\u4e2a\u4e3b\u673a\u7684\u78c1\u76d8\u7a7a\u95f4\u5df2\u7ecf\u5728\u6628\u5929\u8fbe\u5230\u4e86100%\uff0c\u6b64\u65f6\u67e5\u8be21\u5c0f\u65f6\u7684\u589e\u957f\u7387\uff0c\u7531\u4e8e\u6ca1\u6709\u53d8\u5316\uff0c\u56e0\u6b64\u65e0\u6cd5\u8ba1\u7b97\u5728\u8fd9\u4e2a\u65f6\u95f4\u7a97\u53e3\u7684\u5e73\u5747\u589e\u957f\u7387\uff0c\u5c31\u610f\u5473\u7740\u65e0\u6cd5\u53cd\u6620\u6b64\u95ee\u9898\u3002</p> <p>PromQL\u9488\u5bf9\u201c\u957f\u5c3e\u6548\u5e94\u201d\u63d0\u4f9b\u4e86\u4e00\u4e2a\u66f4\u52a0\u7075\u654f\u7684\u51fd\u6570\uff1a</p> <p>irate\uff0c\u540c\u6837\u7528\u4e8e\u8ba1\u7b97\u533a\u95f4\u5411\u91cf\u7684\u589e\u957f\u901f\u7387\uff0c\u4f46\u662firate\u8ba1\u7b97\u7684\u662f\u77ac\u65f6\u589e\u957f\u7387\uff0c\u5373irate\u662f\u901a\u8fc7 \u533a\u95f4\u5411\u91cf\u4e2d\u6700\u540e\u4e24\u4e2a\u6837\u672c\u6570\u636e\u6765\u8ba1\u7b97\u533a\u95f4\u5411\u91cf\u7684\u589e\u957f\u7387\u7684\uff0c\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u9002\u5f53\u907f\u514d\u4e00\u4e9b\u6307\u6807\u7684\u201c\u957f\u5c3e\u6548\u5e94\u201d\u3002</p> <p>\u867d\u7136irate\u8f83rate\u63d0\u4f9b\u4e86\u66f4\u9ad8\u7684\u7075\u654f\u5ea6\uff0c\u4f46\u662f\u5982\u679c\u9700\u8981\u5206\u6790\u957f\u671f\u8d8b\u52bf\uff0c\u6216\u8005\u5728\u914d\u7f6e\u544a\u8b66\u89c4\u5219\u65f6\uff0cirate\u8fc7\u9ad8\u7684\u7075\u654f\u5ea6\u4f1a\u9020\u6210\u5e72\u6270\uff0c\u9488\u5bf9\u957f\u671f\u8d8b\u52bf\u5206\u6790\u548c\u544a\u8b66\u89c4\u5219\uff0c\u66f4\u63a8\u8350\u4f7f\u7528rate\u51fd\u6570\u3002</p> <p>\u5b9e\u9645\u5e94\u7528\u73af\u5883\u4e2d\u5982\u679c\u9700\u8981\u4e86\u89e3\u66f4\u591a\u5173\u4e8ePromQL\u51fd\u6570\u7684\u5185\u5bb9\uff0c\u8bfb\u8005\u53ef\u4ee5\u4ece\u5b98\u7f51https://prometheus.io/docs/prometheus/2.4/querying/functions/\u4e2d\u7ee7\u7eed\u5b66\u4e60\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#8alertmanager\u544a\u8b66\u5165\u95e8","title":"8.Alertmanager\u544a\u8b66\u5165\u95e8","text":"<p>\u524d\u9762\u4ecb\u7ecd\u4e86\u4e00\u4e9b\u6bd4\u8f83\u5e38\u7528\u7684Prometheus\u67e5\u8be2\u8bed\u6cd5\uff0c\u540c\u65f6\u4e5f\u5b66\u4e60\u4e86\u544a\u8b66\u8bed\u6cd5\u7684\u7f16\u5199\u65b9\u6cd5\u3002</p> <p>\u672c\u8282\u6211\u4eec\u5b66\u4e60Prometheus\u7684\u544a\u8b66\u7ec4\u4ef6Alertmanager\uff0c\u770b\u4e00\u4e0b\u5982\u4f55\u4f7f\u7528\u4e00\u4e9b\u5e38\u7528\u7684\u5a92\u4ecb\u53d1\u9001\u544a\u8b66\u901a\u77e5\uff0c\u540c\u65f6\u4e5f\u4f1a\u5b66\u4e60Alertmanager\u7684\u8def\u7531 \u89c4\u5219\uff0c\u5c06\u544a\u8b66\u8fdb\u884c\u5206\u7ec4\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#81-alertmanager\u914d\u7f6e\u6587\u4ef6\u89e3\u6790","title":"8.1 Alertmanager\u914d\u7f6e\u6587\u4ef6\u89e3\u6790","text":"<p>\u9996\u5148\u770b\u4e00\u4e2a\u7b80\u5355\u7684Alertmanager\u914d\u7f6e\u793a\u4f8b\uff1a</p> <pre><code>## Alertmanager \u914d\u7f6e\u6587\u4ef6\nglobal:\nresolve_timeout: 5m\n# smtp\u914d\u7f6e\nsmtp_from: \"prom-alert@example.com\"\nsmtp_smarthost: 'email-smtp.us-west-2.amazonaws.com:465'\nsmtp_auth_username: \"user\"\nsmtp_auth_password: \"pass\"\nsmtp_require_tls: true\n# email\u3001\u4f01\u4e1a\u5fae\u4fe1\u7684\u6a21\u677f\u914d\u7f6e\u5b58\u653e\u4f4d\u7f6e\uff0c\u9489\u9489\u7684\u6a21\u677f\u4f1a\u5355\u72ec\u8bb2\u5982\u679c\u914d\u7f6e\u3002\ntemplates:\n- '/data/alertmanager/templates/*.tmpl'\n# \u8def\u7531\u5206\u7ec4\nroute:\nreceiver: Default\ngroup_by:\n- namespace\n- job\n- alertname\nroutes:\n- receiver: Watchdog\nmatch:\nalertname: Watchdog\n- receiver: Critical\nmatch:\nseverity: critical\ngroup_wait: 30s\ngroup_interval: 5m\nrepeat_interval: 10m\n# \u6291\u5236\u5668\u914d\u7f6e\ninhibit_rules:\n- source_match: # \u6e90\u6807\u7b7e\u8b66\u62a5\u89e6\u53d1\u65f6\u6291\u5236\u542b\u6709\u76ee\u6807\u6807\u7b7e\u7684\u8b66\u62a5\uff0c\u5728\u5f53\u524d\u8b66\u62a5\u5339\u914d status: 'High'\nseverity: critical\ntarget_match_re:\nseverity: warning|info\nequal:\n- namespace\n- alertname\n- source_match:\nseverity: warning\ntarget_match_re:\nseverity: info\nequal:\n- namespace\n- alertname\n# \u63a5\u6536\u5668\u6307\u5b9a\u53d1\u9001\u4eba\u4ee5\u53ca\u53d1\u9001\u6e20\u9053\nreceivers:\n# ops\u5206\u7ec4\u7684\u5b9a\u4e49\n- name: ops\nemail_configs:\n- to: '9935226@qq.com,10000@qq.com'\nsend_resolved: true\nheaders: subject: \"[operations] \u62a5\u8b66\u90ae\u4ef6\"\nfrom: \"\u8b66\u62a5\u4e2d\u5fc3\"\nto: \"\u5c0f\u715c\u72fc\u7687\" # \u9489\u9489\u914d\u7f6e\nwebhook_configs:\n- url: http://localhost:8070/dingtalk/ops/send\n# \u4f01\u4e1a\u5fae\u4fe1\u914d\u7f6e\nwechat_configs:\n- corp_id: 'ww5421dksajhdasjkhj'\napi_url: 'https://qyapi.weixin.qq.com/cgi-bin/'\nsend_resolved: true\nto_party: '2'\nagent_id: '1000002'\napi_secret: 'Tm1kkEE3RGqVhv5hO-khdakjsdkjsahjkdksahjkdsahkj'\n# web\n- name: web\nemail_configs:\n- to: '9935226@qq.com'\nsend_resolved: true\nheaders: { Subject: \"[web] \u62a5\u8b66\u90ae\u4ef6\"} # \u63a5\u6536\u90ae\u4ef6\u7684\u6807\u9898\nwebhook_configs:\n- url: http://localhost:8070/dingtalk/web/send\n- url: http://localhost:8070/dingtalk/ops/send\n# db\n- name: db\nemail_configs:\n- to: '9935226@qq.com'\nsend_resolved: true\nheaders: { Subject: \"[db] \u62a5\u8b66\u90ae\u4ef6\"} # \u63a5\u6536\u90ae\u4ef6\u7684\u6807\u9898\nwebhook_configs:\n- url: http://localhost:8070/dingtalk/db/send\n- url: http://localhost:8070/dingtalk/ops/send\n# hadoop\n- name: hadoop\nemail_configs:\n- to: '9935226@qq.com'\nsend_resolved: true\nheaders: { Subject: \"[hadoop] \u62a5\u8b66\u90ae\u4ef6\"} # \u63a5\u6536\u90ae\u4ef6\u7684\u6807\u9898\nwebhook_configs:\n- url: http://localhost:8070/dingtalk/hadoop/send\n- url: http://localhost:8070/dingtalk/ops/send\n</code></pre> <p>\u4ece\u914d\u7f6e\u6587\u4ef6\u53ef\u4ee5\u770b\u51fa\uff0cAlertmanager\u7684\u914d\u7f6e\u4e3b\u8981\u5206\u4e3a5\u5927\u5757\uff1a</p> <ul> <li> <p>Global\uff1a\u5168\u5c40\u914d\u7f6e\uff0c\u4e3b\u8981\u8fdb\u884c\u4e00\u4e9b\u901a\u7528\u7684\u914d\u7f6e\uff0c\u6bd4\u5982\u90ae\u4ef6\u901a\u77e5\u7684\u8d26\u53f7\u3001\u5bc6\u7801\u3001SMTP\u670d\u52a1\u5668\u3001\u5fae\u4fe1\u544a\u8b66\u7b49\u3002Global\u5757\u914d\u7f6e\u4e0b\u7684\u914d\u7f6e\u9009\u9879\u5728\u672c\u914d\u7f6e\u6587\u4ef6\u5185\u7684\u6240\u6709\u914d\u7f6e\u9879\u4e0b\u53ef\u89c1\uff0c\u4f46\u662f\u6587\u4ef6\u5185\u5176\u4ed6\u4f4d\u7f6e\u7684\u5b50\u914d\u7f6e\u53ef\u4ee5\u8986\u76d6Global\u914d\u7f6e\u3002</p> </li> <li> <p>Templates\uff1a\u7528\u4e8e\u653e\u7f6e\u81ea\u5b9a\u4e49\u6a21\u677f\u7684\u4f4d\u7f6e\u3002</p> </li> <li>Route\uff1a\u544a\u8b66\u8def\u7531\u914d\u7f6e\uff0c\u7528\u4e8e\u544a\u8b66\u4fe1\u606f\u7684\u5206\u7ec4\u8def\u7531\uff0c\u53ef\u4ee5\u5c06\u4e0d\u540c\u5206\u7ec4\u7684\u544a\u8b66\u53d1\u9001\u7ed9\u4e0d\u540c\u7684\u6536\u4ef6\u4eba\u3002\u6bd4\u5982\u5c06\u6570\u636e\u5e93\u544a\u8b66\u53d1\u9001\u7ed9DBA\uff0c\u670d\u52a1\u5668\u544a\u8b66\u53d1\u9001\u7ed9OPS\u3002</li> <li>Inhibit_rules\uff1a\u544a\u8b66\u6291\u5236\uff0c\u4e3b\u8981\u7528\u4e8e\u51cf\u5c11\u544a\u8b66\u7684\u6b21\u6570\uff0c\u9632\u6b62\u201c\u544a\u8b66\u8f70\u70b8\u201d\u3002\u6bd4\u5982\u67d0\u4e2a\u5bbf\u4e3b\u673a\u5b95\u673a\uff0c\u53ef\u80fd\u4f1a\u5f15\u8d77\u5bb9\u5668\u91cd\u5efa\u3001\u6f02\u79fb\u3001\u670d\u52a1   \u4e0d\u53ef\u7528\u7b49\u4e00\u7cfb\u5217\u95ee\u9898\uff0c\u5982\u679c\u6bcf\u4e2a\u5f02\u5e38\u5747\u6709\u544a\u8b66\uff0c\u4f1a\u4e00\u6b21\u6027\u53d1\u9001\u5f88\u591a\u544a\u8b66\uff0c\u9020\u6210\u544a\u8b66\u8f70\u70b8\uff0c\u5e76\u4e14\u4e5f\u4f1a\u5e72\u6270\u5b9a\u4f4d\u95ee\u9898\u7684\u601d\u8def\uff0c\u6240\u4ee5\u53ef\u4ee5\u4f7f   \u7528\u544a\u8b66\u6291\u5236\uff0c\u5c4f\u853d\u7531\u5bbf\u4e3b\u673a\u5b95\u673a\u5f15\u6765\u7684\u5176\u4ed6\u95ee\u9898\uff0c\u53ea\u53d1\u9001\u5bbf\u4e3b\u673a\u5b95\u673a\u7684\u6d88\u606f\u5373\u53ef\u3002</li> <li>Receivers\uff1a\u544a\u8b66\u6536\u4ef6\u4eba\u914d\u7f6e\uff0c\u6bcf\u4e2areceiver\u90fd\u6709\u4e00\u4e2a\u540d\u5b57\uff0c\u7ecf\u8fc7route\u5206\u7ec4\u5e76\u4e14\u8def\u7531\u540e\u9700\u8981\u6307\u5b9a\u4e00\u4e2areceiver\uff0c\u5c31\u662f\u5728\u6b64\u4f4d\u7f6e\u914d\u7f6e   \u7684\u3002</li> </ul> <p>\u4e86\u89e3\u5b8cAlertmanager\u4e3b\u8981\u7684\u914d\u7f6e\u5757\u540e\uff0c\u63a5\u4e0b\u6765\u5bf9Alertmanager\u6bd4\u8f83\u91cd\u8981\u7684Route\u5355\u72ec\u8bb2\u89e3\uff0c\u5176\u4ed6\u914d\u7f6e\u4f1a\u5728\u5b9e\u8df5\u4e2d\u8fdb\u884c\u8865\u5145\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#82-alertmanager\u8def\u7531\u89c4\u5219","title":"8.2 Alertmanager\u8def\u7531\u89c4\u5219","text":"<p>\u524d\u6587\u63d0\u5230\u8fc7Route\u662f\u544a\u8b66\u7684\u8def\u7531\u914d\u7f6e\uff0c\u5b83\u53ef\u4ee5\u8ba9\u544a\u8b66\u6839\u636e\u5206\u7ec4\u53d1\u9001\u7ed9\u5bf9\u5e94\u7684\u4eba\u6216\u8005\u5c0f\u7ec4\uff0c\u8fd9\u4e00\u5757\u7684\u914d\u7f6e\u662fAlertmanager\u6bd4\u8f83\u590d\u6742\u4e14\u7ecf\u5e38\u53d8\u66f4\u7684\u914d\u7f6e\uff0c\u6240\u4ee5\u672c\u5c0f\u8282\u5c06\u8bb2\u89e3\u4e00\u4e0bAlertmanager\u7684\u8def\u7531\u914d\u7f6e\u3002</p> <p>\u4ece\u4e0a\u8ff0\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u622a\u53d6Route\u914d\u7f6e\uff1a</p> <pre><code># \u8def\u7531\u5206\u7ec4\nroute:\nreceiver: Default\ngroup_by:\n- namespace\n- job\n- alertname\nroutes:\n- receiver: Watchdog\nmatch:\nalertname: Watchdog\n- receiver: Critical\nmatch:\nseverity: critical\ngroup_wait: 30s\ngroup_interval: 5m\nrepeat_interval: 10m\n</code></pre> <p>\u4ece\u914d\u7f6e\u6587\u4ef6\u53ef\u4ee5\u770b\u51fa\uff0c\u8def\u7531\u914d\u7f6e\u5757\u7684\u9876\u7ea7\u914d\u7f6e\u7531route\u5f00\u59cb\uff0c\u5b83\u662f\u6574\u4e2a\u8def\u7531\u7684\u5165\u53e3\uff0c\u79f0\u4f5c\u6839\u8def\u7531\u3002</p> <p>\u6bcf\u4e00\u6761\u544a\u8b66\u8fdb\u6765\u540e\uff0c\u90fd\u5148\u8fdb\u5165route\uff0c\u4e4b\u540e\u6839\u636e\u544a\u8b66\u81ea\u8eab\u7684\u6807\u7b7e\u548croute.group_by\u914d\u7f6e\u7684\u5b57\u6bb5\u8fdb\u884c\u5206\u7ec4\u3002\u6bd4\u5982\u53ef\u4ee5\u6839\u636ejob\u3001 cluster\u6216\u8005\u5176\u4ed6\u81ea\u5b9a\u4e49\u7684\u6807\u7b7e\u540d\u79f0\u8fdb\u884c\u5206\u7ec4\uff0c\u5206\u7ec4\u540e\u8fdb\u5165\u5b50\u8def\u7531\uff08\u901a\u8fc7route.routes\u914d\u7f6e\u5b50\u8def\u7531\uff09\uff0c\u8fdb\u4e00\u6b65\u8fdb\u884c\u66f4\u52a0\u7ec6\u7c92\u5ea6\u7684\u5212\u5206\uff0c\u6bd4\u5982job\u540d\u79f0\u5305\u542bmysql\u7684\u53d1\u9001\u7ed9DBA\u7ec4\u3002</p> <p>\u9664\u4e86group_by\u548croutes\u5916\uff0cRoute\u8fd8\u6709\u4ee5\u4e0b\u5e38\u7528\u7684\u914d\u7f6e\uff1a</p> <ul> <li> <p>receiver\uff1a\u544a\u8b66\u7684\u901a\u77e5\u76ee\u6807\uff0c\u9700\u8981\u548creceivers\u914d\u7f6e\u4e2d\u7684name\u8fdb\u884c\u5339\u914d\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0croute.routes\u4e0b\u4e5f\u53ef\u4ee5\u6709receiver\u914d\u7f6e\uff0c\u4f18\u5148\u7ea7\u9ad8\u4e8eroute.receiver\u914d\u7f6e\u7684\u9ed8\u8ba4\u63a5\u6536\u4eba\uff0c\u5f53\u544a\u8b66\u6ca1\u6709\u5339\u914d\u5230\u5b50\u8def\u7531\u65f6,\u4f1a\u4f7f\u7528route.receiver\u8fdb\u884c\u901a\u77e5,\u6bd4\u5982\u4e0a\u8ff0\u914d\u7f6e\u4e2d\u7684Default\u3002</p> </li> <li> <p>group_by \uff1a \u5206\u7ec4\u914d\u7f6e,\u503c\u7c7b\u578b\u4e3a\u5217\u8868\u3002\u6bd4\u5982\u914d\u7f6e\u6210['job','severity']\uff0c\u4ee3\u8868\u544a\u8b66\u4fe1\u606f\u5305\u542bjob\u548cseverity\u6807\u7b7e\u7684\u4f1a\u8fdb\u884c\u5206\u7ec4\uff0c\u4e14\u6807\u7b7e\u7684key\u548cvalue\u90fd\u76f8\u540c\u624d\u4f1a\u88ab\u5206\u5230\u4e00\u7ec4\u3002</p> </li> <li> <p>continue\uff1a\u51b3\u5b9a\u5339\u914d\u5230\u7b2c\u4e00\u4e2a\u8def\u7531\u540e\uff0c\u662f\u5426\u7ee7\u7eed\u540e\u7eed\u5339\u914d\u3002\u9ed8\u8ba4\u4e3afalse\uff0c\u5373\u5339\u914d\u5230\u7b2c\u4e00\u4e2a\u5b50\u8282\u70b9\u540e\u505c\u6b62\u7ee7\u7eed\u5339\u914d\u3002</p> </li> <li> <p>match\uff1a\u4e00\u5bf9\u4e00\u5339\u914d\u89c4\u5219\uff0c\u6bd4\u5982match\u914d\u7f6e\u7684\u4e3ajob: mysql\uff0c\u90a3\u4e48\u5177\u6709job=mysql\u7684\u544a\u8b66\u4f1a\u8fdb\u5165\u8be5\u8def\u7531\u3002</p> </li> <li> <p>match_re\uff1a\u548cmatch\u7c7b\u4f3c\uff0c\u53ea\u4e0d\u8fc7match_re\u662f\u6b63\u5219\u5339\u914d\u3002</p> </li> <li> <p>matchers\uff1a\u8fd9\u662fAlertmanager 0.22\u7248\u672c\u65b0\u6dfb\u52a0\u7684\u4e00\u4e2a\u914d\u7f6e\u9879\uff0c\u7528\u4e8e\u66ff\u6362match\u548cmatch_re\uff0c\u5982\u679c\u8bfb\u8005\u75280.22\u4ee5\u4e0a\u7248\u672c\u7684Alertmanager\uff0c\u53ef\u4ee5\u5c1d\u8bd5\u4f7f\u7528\u8be5\u53c2\u6570\u3002Matchers\u8bbe\u8ba1\u7406\u5ff5\u53c2\u8003\u4e86PromQL\u548cOpenMetrics\uff0c\u53ef\u4ee5\u76f4\u63a5\u5199\u6210\u5982\u4e0b\u683c\u5f0f\uff1a</p> </li> <li> <p>\u5339\u914dfoo\u7b49\u4e8ebar\u4e14dings\u4e0d\u7b49\u4e8ebums</p> <pre><code>matchers:\n  - foo = bar\n  - dings != bums\n</code></pre> </li> <li> <p>\u5339\u914dfoo\u7b49\u4e8ebar\u548cbaz\uff0c\u4e14dings\u4e0d\u7b49\u4e8ebums\uff1a</p> <pre><code>matchers\uff1a[ \"foo = bar,baz\", \"dings != bums\" ]\n</code></pre> </li> <li> <p>\u5339\u914dfoo\u7b49\u4e8ebar\u4e14dings\u4e0d\u7b49\u4e8ebums\u7684\u53e6\u4e00\u79cd\u5199\u6cd5\uff0c\u548cPromQL\u7c7b\u4f3c\uff1a</p> <pre><code>matchers\uff1a[ '{foo=\"bar\", dings!=\"bums\"}' ]\n</code></pre> </li> <li> <p>group_wait\uff1a\u544a\u8b66\u901a\u77e5\u7b49\u5f85\uff0c\u503c\u7c7b\u578b\u4e3a\u5b57\u7b26\u4e32\u3002\u82e5\u4e00\u7ec4\u65b0\u7684\u544a\u8b66\u4ea7\u751f\uff0c\u5219\u4f1a\u7b49group_wait\u540e\u518d\u53d1\u9001\u901a\u77e5\uff0c\u8be5\u529f\u80fd\u4e3b\u8981\u7528\u4e8e\u5f53\u544a\u8b66\u5728\u5f88\u77ed\u65f6\u95f4\u5185\u63a5\u8fde\u4ea7\u751f\u65f6\uff0c\u5728group_wait\u5185\u5408\u5e76\u4e3a\u5355\u4e00\u7684\u544a\u8b66\u540e\u518d\u53d1\u9001\uff0c\u9632\u6b62\u544a\u8b66\u8fc7\u591a\uff0c\u9ed8\u8ba4\u503c\u4e3a30s\u3002</p> </li> <li> <p>group_interval\uff1a\u540c\u4e00\u7ec4\u544a\u8b66\u901a\u77e5\u540e\uff0c\u5982\u679c\u6709\u65b0\u7684\u544a\u8b66\u6dfb\u52a0\u5230\u8be5\u7ec4\u4e2d\uff0c\u518d\u6b21\u53d1\u9001\u544a\u8b66\u901a\u77e5\u7684\u65f6\u95f4\uff0c\u9ed8\u8ba4\u503c\u4e3a5ms\u3002</p> </li> <li>repeat_interval\uff1a\u5982\u679c\u4e00\u6761\u544a\u8b66\u901a\u77e5\u5df2\u6210\u529f\u53d1\u9001\uff0c\u4e14\u5728\u95f4\u9694repeat_interval\u540e\uff0c\u8be5\u544a\u8b66\u4ecd\u7136\u672a\u88ab\u8bbe\u7f6e\u4e3aresolved\uff0c\u5219\u4f1a\u518d\u6b21\u53d1   \u9001\u8be5\u544a\u8b66\u901a\u77e5\uff0c\u9ed8\u8ba4\u503c\u4e3a4h\u3002</li> </ul> <p>\u4ee5\u4e0a\u5373\u4e3aAlertmanager\u5e38\u7528\u7684\u8def\u7531\u914d\u7f6e\uff0c\u53ef\u4ee5\u770b\u5230Alertmanager\u7684\u8def\u7531\u548c\u5339\u914d\u89c4\u5219\u975e\u5e38\u7075\u6d3b\uff0c\u901a\u8fc7\u4e0d\u540c\u7684\u8def\u7531\u5d4c\u5957\u548c\u5339\u914d\u89c4\u5219\u53ef\u4ee5\u8fbe\u5230\u4e0d\u540c\u7684\u901a\u77e5\u6548\u679c\u3002</p> <p>\u5bf9\u4e8eAlertmanager\u7684\u5176\u4ed6\u914d\u7f6e\uff0c\u4f1a\u5728\u5b9e\u8df5\u4e2d\u8fdb\u884c\u8865\u5145\u3002\u63a5\u4e0b\u6765\u5b66\u4e60\u5982\u4f55\u5c06\u544a\u8b66\u901a\u8fc7\u4e0d\u540c\u7684\u5a92\u4ecb\u8fdb\u884c\u901a\u77e5\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#83-alertmanager\u90ae\u4ef6\u901a\u77e5","title":"8.3 Alertmanager\u90ae\u4ef6\u901a\u77e5","text":"<p>\u544a\u8b66\u90ae\u4ef6\u901a\u77e5\u662f\u4f01\u4e1a\u5185\u6700\u5e38\u7528\u7684\u4e00\u79cd\u901a\u77e5\u65b9\u5f0f\uff0cAlertmanager\u539f\u751f\u652f\u6301\u90ae\u4ef6\u544a\u8b66\u65b9\u5f0f\uff0c\u5176\u914d\u7f6e\u65b9\u5f0f\u76f8\u5bf9\u7b80\u5355\u3002\u9996\u5148\u8fdb\u5165\u5728\u5b89\u88c5\u5c0f\u8282\uff08\u672c\u4e6615.2\u8282\uff09clone\u7684\u4ee3\u7801\u76ee\u5f55\uff0c\u627e\u5230Alertmanager\u7684\u914d\u7f6e\u6587\u4ef6\uff08\u5176\u4ed6\u5b89\u88c5\u65b9\u5f0f\u7684\u4f4d\u7f6e\u53ef\u80fd\u4e0d\u540c\uff0c\u9700\u8981\u81ea\u884c\u627e\u5230\u914d\u7f6e\u6587\u4ef6\u7684\u4f4d\u7f6e\uff0c\u914d\u7f6e\u6587\u4ef6\u7684\u5185\u5bb9\u662f\u4e00\u81f4\u7684\uff09\uff1a</p> <pre><code>[root@centos7-base kube-prometheus]# cd manifests/\n[root@centos7-base manifests]# ls alertmanager-secret.yaml\nalertmanager-secret.yaml\n</code></pre> <p>\u4f7f\u7528Operator\u5f62\u5f0f\u5b89\u88c5\u7684Prometheus\u548cAlertmanager\uff0c\u914d\u7f6e\u90fd\u4f1a\u5b58\u50a8\u5728Kubernetes\u7684ConfigMap\u548cSecret\u4e2d\u3002</p> <p>Alertmanager\u7684\u914d\u7f6e\u6587\u4ef6\u662f\u901a\u8fc7Secret\u8fdb\u884c\u5b58\u50a8\u7684\uff0c\u5176\u539f\u59cb\u6587\u4ef6\u4e3aalertmanagersecret.yaml\uff0c\u5185\u5bb9\u5927\u81f4\u5982\u4e0b\uff1a</p> <pre><code>cat alertmanager-secret.yaml\napiVersion: v1\nkind: Secret\nmetadata:\nlabels:\nalertmanager: main\napp.kubernetes.io/component: alert-router\napp.kubernetes.io/name: alertmanager\napp.kubernetes.io/part-of: kube-prometheus\napp.kubernetes.io/version: 0.22.2\nname: alertmanager-main\nnamespace: monitoring\nstringData:\nalertmanager.yaml: |-\n\"global\":\n\"resolve_timeout\": \"5m\"\n......\n</code></pre> <p>\u524d\u6587\u63d0\u5230\u8fc7\uff0c\u4e00\u822c\u901a\u7528\u914d\u7f6e\u4f1a\u653e\u7f6e\u5728global\u914d\u7f6e\u4e2d\uff0c\u8fdb\u884c\u90ae\u4ef6\u901a\u77e5\u7684SMTP\u914d\u7f6e\u4e5f\u662f\u653e\u5728global\u4e0b\u3002</p> <p>\u63a5\u4e0b\u6765\u901a\u8fc7163\u90ae\u7bb1\u914d\u7f6e\u90ae\u4ef6\u901a\u77e5\uff0c\u9996\u5148\u5728163\u90ae\u7bb1\u5e73\u53f0\u5c06SMTP\u529f\u80fd\u6253\u5f00\uff08\u672c\u4e66\u4e0d\u505a\u6f14\u793a\uff09\uff0c\u4e4b\u540e\u5728alertmanager- secret.yaml\u6587\u4ef6\u7684global\u4e0b\u6dfb\u52a0\u5982\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>  alertmanager.yaml: |-\n\"global\":\nresolve_timeout: \"5m\"\n# smtp\u914d\u7f6e\nsmtp_from: \"1879324764@qq.com\"\nsmtp_smarthost: 'smtp.qq.com:25'\nsmtp_hello: \"smtp.qq.com\"\nsmtp_auth_username: \"1879324764@qq.com\"\nsmtp_auth_password: \"ucpkvebqnkysecgh\"\nsmtp_require_tls: false\n</code></pre> <p>\u4e4b\u540e\u5c06\u540d\u79f0\u4e3aDefault\u7684receiver\u914d\u7f6e\u66f4\u6539\u4e3a\u90ae\u4ef6\u901a\u77e5,\u4fee\u6539alertmanager-secret.yaml\u6587\u4ef6\u7684receivers\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>    \"receivers\":\n- \"name\": \"Default\"\n\"email_configs\":\n- to: \"notification@163.com\"\nsend_resolved: true\n- \"name\": \"Watchdog\"\n- \"name\": \"Critical\"\n</code></pre> <ul> <li>email_configs\uff1a\u4ee3\u8868\u4f7f\u7528\u90ae\u4ef6\u901a\u77e5\u3002</li> <li>to\uff1a\u6536\u4ef6\u4eba\uff0c\u6b64\u5904\u4e3anotification@163.com\uff0c\u53ef\u4ee5\u914d\u7f6e\u591a\u4e2a\uff0c\u7528\u9017\u53f7\u9694\u5f00\u3002</li> <li>send_resolved\uff1a\u5982\u679c\u544a\u8b66\u88ab\u89e3\u51b3\uff0c\u662f\u5426\u53d1\u9001\u89e3\u51b3\u901a\u77e5</li> </ul> <p>\u81f3\u6b64\uff0c\u5373\u5b8c\u6210\u4e86\u544a\u8b66\u7684\u90ae\u4ef6\u901a\u77e5\u3002\u63a5\u4e0b\u6765\u5206\u6790\u4e00\u4e0b\u8def\u7531\u89c4\u5219\uff08\u9ed8\u8ba4\u5206\u7ec4\u53ea\u6709namespace\uff0c\u5728\u6b64\u6dfb\u52a0job\u548calertname\uff0c\u5f53\u7136\u4e0d\u6dfb\u52a0\u4e5f\u53ef\u4ee5\uff09\uff1a</p> <pre><code># \u8def\u7531\u5206\u7ec4\nroute:\ngroup_wait: 30s\ngroup_interval: 5m\nrepeat_interval: 10m\nreceiver: Default\n\"group_by\":\n- \"namespace\"\n- \"job\"\n- \"alertname\"\nroutes:\n- receiver: Watchdog\nmatch:\nalertname: Watchdog\n- receiver: Critical\nmatch:\nseverity: critical\n</code></pre> <p>\u8be5\u544a\u8b66\u89c4\u5219\u5bf9namespace\u6807\u7b7e\u8fdb\u884c\u5206\u7ec4\uff08group_by\u5b57\u6bb5\uff09\uff0c\u6ca1\u6709\u5339\u914d\u5230\u5b50\u8def\u7531\u7684\u544a\u8b66\u9ed8\u8ba4\u53d1\u9001\u7ed9\u540d\u4e3aDefault\u7684receiver\uff08receiver\u5b57\u6bb5\uff09\u3002</p> <p>\u5982\u679c\u5339\u914d\u5230alertname=Watchdog\u7684\u544a\u8b66\uff0c\u5219\u5c06\u901a\u77e5\u53d1\u9001\u7ed9Watchdog\uff0c\u5982\u679c\u5339\u914d\u5230severity=critical\u7684\u544a\u8b66\uff0c\u5219\u5c06\u901a\u77e5\u53d1\u9001\u7ed9Critical\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7Alertmanager\u63d0\u4f9b\u7684Web UI\u67e5\u770b\u5206\u7ec4\u4fe1\u606f\uff0c\u548cPrometheus\u4e00\u81f4\uff0c\u5c06Alertmanager\u7684Service\u66f4\u6539\u4e3aNodePort\uff08\u89c1\u56fe15.42\uff09\uff1a</p> <pre><code># kubectl edit svc -n monitoring alertmanager-main\n</code></pre> <pre><code>  ports:\n- name: web\nnodePort: 32234\nport: 9093\nprotocol: TCP\ntargetPort: web\nselector:\nalertmanager: main\napp: alertmanager\napp.kubernetes.io/component: alert-router\napp.kubernetes.io/name: alertmanager\napp.kubernetes.io/part-of: kube-prometheus\nsessionAffinity: ClientIP\nsessionAffinityConfig:\nclientIP:\ntimeoutSeconds: 10800\ntype: NodePort\n</code></pre> <p>\u67e5\u770b\u76d1\u542c\u7684\u7aef\u53e3\u53f7\uff1a</p> <pre><code># kubectl get svc -n monitoring alertmanager-main\nNAME                TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE\nalertmanager-main   NodePort   10.99.53.46   &lt;none&gt;        9093:32234/TCP   21h\n</code></pre> <p>\u5c06\u66f4\u6539\u597d\u7684Alertmanager\u914d\u7f6e\u52a0\u8f7d\u5230Alertmanager\uff1a</p> <pre><code># kubectl replace -f alertmanager-secret.yaml\nsecret/alertmanager-main replaced\n</code></pre> <p>\u7a0d\u7b49\u51e0\u5206\u949f\uff0c\u5373\u53ef\u5728Alertmanager\u7684Web\u754c\u9762\u770b\u5230\u66f4\u6539\u7684\u914d\u7f6e(Status\uff09\uff0c\u5982\u56fe15.43\u6240\u793a\u3002</p> <p>) \u56fe15.43\u3000\u67e5\u770bAlertmanager\u914d\u7f6e</p> <p>\u4e5f\u53ef\u4ee5\u67e5\u770b\u5206\u7ec4\u4fe1\u606f\uff0c\u5982\u56fe15.44\u6240\u793a\u3002 ) \u56fe15.44\u3000\u67e5\u770b\u544a\u8b66\u5206\u7ec4</p> <p>\u5728\u5b89\u88c5Prometheus\u540e\uff0c\u5982\u679c\u6ca1\u6709\u505a\u4efb\u4f55\u66f4\u6539\uff0c\u53ef\u80fd\u4f1a\u5728Prometheus\u9875\u9762\u770b\u5230\u5982\u4e0b\u544a\u8b66\uff1a</p> <ul> <li>KubeSchedulerDown\u548cKubeControllerManagerDown\u53ef\u4ee5\u53c2\u800315.3.3\u8282\u7684ServiceMonitor\u8fdb\u884c\u89e3\u51b3\u3002</li> <li>Watchdog\uff1a\u5e76\u975e\u662f\u4e00\u4e2a\u5f02\u5e38\u7684\u544a\u8b66\uff0c\u800c\u662fPrometheus\u96c6\u7fa4\u7684\u72b6\u6001\u76d1\u63a7\uff0c\u5b83\u8868\u793aPrometheus\u96c6\u7fa4\u7684\u72b6\u6001\u662f\u6b63\u5e38\u7684\uff0c\u53ef\u4ee5\u5c06\u6b64\u544a\u8b66\u5173\u95ed\u3002</li> <li>CPU?hrottlingHigh\uff1a\u8be5\u544a\u8b66\u53cd\u6620\u7684\u662f\u6700\u8fd15\u5206\u949f\u8d85\u8fc725%\u7684CPU\u6267\u884c\u5468\u671f\u53d7\u5230\u9650\u5236\u7684\u5bb9\u5668\uff0c\u4e00\u822c\u662flimit\u8bbe\u7f6e\u5f97\u4f4e\u6216\u8005\u672a\u8bbe\u7f6e\u5f15\u8d77\u7684\u3002\u53ef\u4ee5\u5c06\u6b64\u544a\u8b66\u5173\u95ed\uff0c\u6216\u8005\u5408\u7406\u914d\u7f6e\u5bb9\u5668\u7684resources\u53c2\u6570\u3002</li> <li>NodeClockNotSynchronising\uff1a\u8be5\u544a\u8b66\u662f\u7531\u4e8e\u4e3b\u673a\u548c\u65f6\u95f4\u670d\u52a1\u5668\u65e0\u6cd5\u8fde\u63a5\u5bfc\u81f4\u7684\uff0c\u8bfb\u8005\u53ef\u80fd\u5e76\u6ca1\u6709\u6b64\u544a\u8b66\uff0c\u8be5\u544a\u8b66\u53ef\u4ee5\u76f4\u63a5\u5173\u95ed\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6eNTP\u670d\u52a1\u5668\u6765\u89e3\u51b3\u3002</li> </ul> <p>\u63a5\u4e0b\u6765\u5355\u51fb\u4efb\u610f\u4e00\u4e2a\u544a\u8b66\uff0c\u53ef\u4ee5\u67e5\u770b\u5230\u8be5\u6761\u544a\u8b66\u4fe1\u606f\u7684\u544a\u8b66\u8bed\u6cd5\uff0c\u5982\u56fe15.45\u548c\u56fe15.46\u6240\u793a\u3002</p> <p>) \u56fe15.45\u3000\u67e5\u770b\u544a\u8b66</p> <p>) \u56fe15.46\u3000\u67e5\u770b\u544a\u8b66\u8bed\u6cd5</p> <p>\u4e4b\u540e\u5355\u51fbexpr\u7684\u8bed\u6cd5\uff0c\u53ef\u4ee5\u8fdb\u5165\u67e5\u8be2\u9875\u9762\uff0c\u5982\u56fe15.47\u6240\u793a\u3002 ) \u56fe15.47\u3000\u67e5\u770bexpr\u8bed\u6cd5</p> <p>\u6b64\u65f6\u53ef\u4ee5\u770b\u5230\u6bcf\u4e2ametric\u7684\u6807\u7b7e\uff0c\u5982\u679c\u67e5\u770b\u6bcf\u4e2a\u5df2\u7ecf\u544a\u8b66\u7684\u8be6\u7ec6\u8bed\u6cd5\uff0c\u53ef\u4ee5\u770b\u5230Watchdog\u5177\u6709alertname=\"Watchdog\"\u6807\u7b7e\uff0c\u4e24\u4e2aKube\u7684\u544a\u8b66\uff08\u5982\u6709\uff09\u5177\u6709severity=\"critical\"\u6807\u7b7e\uff0c\u8fd9\u4e24\u6761\u544a\u8b66\u5747\u88ab\u5b50\u8def\u7531\u5339\u914d\uff0c\u5206\u522b\u5c06\u544a\u8b66\u53d1\u9001\u7ed9\u4e86Watchdog\u548cCritical\uff0c\u7531\u4e8e\u4e24\u8005\u5e76\u6ca1\u6709\u914d\u7f6e\u5b9e\u9645\u7684\u5a92\u4ecb\uff0c\u56e0\u6b64\u6682\u65f6\u65e0\u6cd5\u6536\u5230\u8be5\u544a\u8b66\u3002</p> <p>\u800cCPUThrottlingHigh\u548cNodeClockNotSynchronising\u6ca1\u6709\u5339\u914d\u5230\u4efb\u4f55\u5b50\u8def\u7531\uff0c\u6240\u4ee5\u5c06\u544a\u8b66\u4fe1\u606f\u53d1\u9001\u5230\u4e86\u9ed8\u8ba4\u7684receiver\uff0c\u4e5f\u5c31\u662fDefault\uff0c\u6b64\u65f6Default receiver\u914d\u7f6e\u7684\u90ae\u7bb1\u4f1a\u6536\u5230\u4e24\u8005\u7684\u544a\u8b66\u4fe1\u606f\uff0c\u5982\u56fe15.48\u548c\u56fe15.49\u6240\u793a\u3002</p> <p>) \u56fe15.48\u3000\u67e5\u770b\u90ae\u4ef6\u544a\u8b66</p> <p>\u901a\u8fc7\u4ee5\u4e0a\u6b65\u9aa4\u5373\u53ef\u5b9e\u73b0\u544a\u8b66\u7684\u90ae\u4ef6\u901a\u77e5\uff0c\u5728\u5b9e\u9645\u4f7f\u7528\u65f6\uff0c\u53ef\u4ee5\u6839\u636e\u4e0d\u540c\u7684\u5206\u7ec4\u5c06\u544a\u8b66\u53d1\u9001\u7ed9\u4e0d\u540c\u7684\u6536\u4ef6\u4eba\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#84-alertmanager\u4f01\u4e1a\u5fae\u4fe1\u901a\u77e5","title":"8.4 Alertmanager\u4f01\u4e1a\u5fae\u4fe1\u901a\u77e5","text":"<p>\u4e0a\u4e00\u5c0f\u8282\u5df2\u7ecf\u5b9e\u73b0\u4e86\u4f7f\u7528\u90ae\u4ef6\u8fdb\u884c\u544a\u8b66\u7684\u901a\u77e5\uff0c\u672c\u5c0f\u8282\u6f14\u793a\u4f7f\u7528\u4f01\u4e1a\u5fae\u4fe1\u8fdb\u884c\u544a\u8b66\u3002</p> <p>\u9996\u5148\u5728\u4f01\u4e1a\u5fae\u4fe1\u5b98\u7f51\uff08https://work.weixin.qq.com/\uff09\u6ce8\u518c\u4e00\u4e2a\u4f01\u4e1a(\u4efb\u4f55\u4eba\u90fd\u53ef\u4ee5\u6ce8\u518c\uff0c\u6ce8\u518c\u8fc7\u7a0b\u4e0d\u518d\u6f14\u793a\uff09\uff0c\u5982\u679c\u8bfb\u8005\u6240\u5728\u7684\u516c\u53f8\u5df2\u7ecf\u6709\u76f8\u5173\u4f01\u4e1a\u5fae\u4fe1\uff0c\u53ef\u4ee5\u65e0\u987b\u6ce8\u518c\uff0c\u53ea\u9700\u8981\u6709\u521b\u5efa\u901a\u8baf\u5f55\u548c\u521b\u5efa\u5e94\u7528\u7684\u6743\u9650\u5373\u53ef\u3002</p> <p>1\uff0e\u4f01\u4e1a\u5fae\u4fe1\u914d\u7f6e</p> <p>\u6ce8\u518c\u5b8c\u6210\u540e\u8fdb\u884c\u767b\u5f55\uff0c\u767b\u5f55\u540e\u5355\u51fb\u201c\u6211\u7684\u4f01\u4e1a\u201d\uff0c\u5982\u56fe15.50\u6240\u793a\u3002</p> <p>) \u56fe15.50\u3000\u67e5\u770b\u6211\u7684\u4f01\u4e1a</p> <p>\u5728\u9875\u9762\u7684\u6700\u4e0b\u9762\u627e\u5230\u4f01\u4e1aID\uff08\u5bf9\u5e94Alertmanager\u7684corp_id\u5b57\u6bb5\uff09\u5e76\u8bb0\u5f55\uff0c\u7a0d\u540e\u4f1a\u7528\u5230\uff0c\u5982\u56fe15.51\u6240\u793a\u3002</p> <p>) \u56fe15.51\u3000\u67e5\u770b\u4f01\u4e1aID</p> <p>\u4e4b\u540e\u521b\u5efa\u4e00\u4e2a\u90e8\u95e8\uff0c\u7528\u4e8e\u63a5\u6536\u544a\u8b66\u901a\u77e5\uff0c\u5982\u56fe15.52\u6240\u793a\u3002 ) \u56fe15.52\u3000\u6dfb\u52a0\u5b50\u90e8\u95e8</p> <p>\u8f93\u5165Prom\u544a\u8b66\uff0c\u4e4b\u540e\u5355\u51fb\u201c\u786e\u5b9a\u201d\u6309\u94ae\uff0c\u5982\u56fe15.53\u6240\u793a\u3002 ) \u56fe15.53\u3000\u914d\u7f6e\u90e8\u95e8\u540d\u79f0</p> <p>\u4e4b\u540e\u5728Prom\u544a\u8b66\u5b50\u90e8\u95e8\u6dfb\u52a0\u76f8\u5173\u7684\u6210\u5458\u5373\u53ef\uff0c\u5982\u56fe15.54\u6240\u793a\uff0c\u5728\u6b64\u4e0d\u518d\u6f14\u793a\u3002 ) \u56fe15.54\u3000\u6dfb\u52a0\u6210\u5458</p> <p>\u67e5\u770b\u8be5\u90e8\u95e8ID\uff08\u5bf9\u5e94Alertmanager\u7684to_party\u5b57\u6bb5\uff09\u5e76\u8bb0\u5f55\uff0c\u5982\u56fe15.55\u6240\u793a\u3002 ) \u56fe15.55\u3000\u67e5\u770b\u90e8\u95e8ID</p> <p>\u4e4b\u540e\u521b\u5efa\u673a\u5668\u4eba\u5e94\u7528\uff0c\u9996\u5148\u5355\u51fb\u5e94\u7528\u7ba1\u7406\u2192\u521b\u5efa\u5e94\u7528\uff0c\u5982\u56fe15.56\u6240\u793a\u3002 ) \u56fe15.56\u3000\u6dfb\u52a0\u544a\u8b66\u5e94\u7528</p> <p>\u9009\u62e9\u4e00\u4e2alogo\uff0c\u8f93\u5165\u5e94\u7528\u540d\u79f0\u5e76\u9009\u62e9\u53ef\u89c1\u8303\u56f4\uff0c\u5982\u56fe15.57\u548c\u56fe15.58\u6240\u793a\u3002</p> <p>) \u56fe15.57\u3000\u914d\u7f6e\u5e94\u7528\u53ef\u89c1\u6743\u9650</p> <p>) \u56fe15.58\u3000\u914d\u7f6e\u5e94\u7528\u53ef\u89c1\u8303\u56f4</p> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u67e5\u770bAgentId\u548cSecret\uff08\u5bf9\u5e94Alertmanager\u7684api_secret\u5b57\u6bb5\uff09\u5e76\u8bb0\u5f55\uff0c\u5982\u56fe15.59\u6240\u793a\u3002</p> <p>\u5355\u51fbSecret\u540e\u7684\u201c\u67e5\u770b\u201d\uff0c\u6b64\u65f6\u4f1a\u5c06Secret\u53d1\u9001\u81f3\u4f01\u4e1a\u5fae\u4fe1\uff0c\u5355\u51fb\u201c\u524d\u5f80\u67e5\u770b\u201d\u5e76\u8bb0\u5f55\u5373\u53ef\uff0c\u5982\u56fe15.60\u6240\u793a\u3002 ) \u56fe15.59\u3000\u67e5\u770bAgentId\u548cSecret</p> <p>) \u56fe15.60\u3000\u67e5\u770bSecret\u8be6\u60c5</p> <p>2\uff0eAlertmanager\u914d\u7f6e</p> <p>\u4fee\u6539Alertmanager\u914d\u7f6e\u6587\u4ef6\uff0c\u6dfb\u52a0\u4f01\u4e1a\u5fae\u4fe1\u544a\u8b66\u3002\u9996\u5148\u4fee\u6539global\uff0c\u6dfb\u52a0\u4e00\u4e9b\u901a\u7528\u914d\u7f6e\uff0cwechat_api_url\u662f\u56fa\u5b9a\u914d\u7f6e\uff0ccorp_id\u4e3a\u4f01\u4e1aID\uff1a</p> <pre><code>    \"global\":\nresolve_timeout: \"5m\"\nwechat_api_url: \"https://qyapi.weixin.qq.com/cgi-bin/\"\nwechat api corp id: \"wwef86a30xxxxxxxxxxxx\"\n</code></pre> <p>receivers\u6dfb\u52a0\u5fae\u4fe1\u901a\u77e5\uff1a</p> <pre><code>    \"receivers\":\n- \"name\": wechat-ops\nwechat_configs:\n- send_resolved: true\nto_party: 3\nto_user: \"@all\"\nagent_id: 1000006\napi_secret: \"3bB350Sxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"\n- \"name\": \"Default\"\n\"email_configs\":\n- to: \"notification@163.com\"\nsend_resolved: true\n- \"name\": \"Watchdog\"\n- \"name\": \"Critical\"\n</code></pre> <p>\u6b64\u5904\u914d\u7f6e\u7684receiver\u540d\u5b57\u4e3awechat-ops\uff0c\u53ef\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u5212\u5206\u4e0d\u540c\u7684\u90e8\u95e8\u3002\u6b64\u65f6\u914d\u7f6e\u7684to_user\u4e3a@all\uff0c\u4ee3\u8868\u53d1\u9001\u7ed9\u6240\u6709\u4eba\uff0c\u4e5f\u53ef\u4ee5\u53ea\u53d1\u9001\u7ed9\u90e8\u95e8\u7684\u67d0\u4e00\u4e2a\u4eba\uff0c\u53ea\u9700\u8981\u5c06\u6b64\u5904\u6539\u4e3aUSER_ID\u5373\u53ef\uff0c  \u5982\u56fe15.61\u6240\u793a\u3002</p> <p>) \u56fe15.61\u3000\u7528\u6237ID</p> <p>\u66f4\u6539\u8def\u7531\u914d\u7f6e\uff0c\u5c06Watchdog\u7684\u544a\u8b66\u53d1\u9001\u7ed9\u8be5\u90e8\u95e8\uff08\u4e5f\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u5b9e\u9645\u60c5\u51b5\u5c06\u5176\u4ed6\u544a\u8b66\u53d1\u9001\u7ed9\u8be5\u90e8\u95e8\uff09\uff1a</p> <pre><code>route:\ngroup_wait: 30s\ngroup_interval: 5m\nrepeat_interval: 10m\nreceiver: Default\n\"group_by\":\n- \"namespace\"\n- \"job\"\n- \"alertname\"\nroutes:\n- \"match\":\n\"alertname\": \"Watchdog\"\n\"receiver\": \"wechat-ops\"\n\"repeat_interval\": \"10m\"\n</code></pre> <p>\u4e4b\u540e\u66f4\u65b0Alertmanager\u7684\u914d\u7f6e\uff1a</p> <pre><code># kubectl replace -f alertmanager-secret.yaml\nsecret/alertmanager-main replaced\n</code></pre> <p>\u7b49\u5f85\u51e0\u5206\u949f\u540e\uff0c\u53ef\u4ee5\u5728Alertmanager Web UI\u770b\u5230\u65b0\u914d\u7f6e\uff0c\u5e76\u4e14\u4f01\u4e1a\u5fae\u4fe1\u53ef\u4ee5\u6536\u5230Watchdog\u7684\u544a\u8b66\uff0c\u5982\u56fe15.62\u6240\u793a\u3002</p> <p>) \u56fe15.62\u3000\u67e5\u770b\u5fae\u4fe1\u544a\u8b66</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#85-\u81ea\u5b9a\u4e49\u544a\u8b66\u6a21\u677f","title":"8.5 \u81ea\u5b9a\u4e49\u544a\u8b66\u6a21\u677f","text":"<p>\u4e0a\u4e00\u5c0f\u8282\u4f7f\u7528\u4f01\u4e1a\u5fae\u4fe1\u8fdb\u884c\u4e86\u544a\u8b66\u901a\u77e5\uff0c\u76f8\u5bf9\u4e8e\u90ae\u7bb1\u901a\u77e5\uff0c\u4f01\u4e1a\u5fae\u4fe1\u7684\u544a\u8b66\u901a\u77e5\u5e76\u4e0d\u662f\u5f88\u5bb9\u6613\u9605\u8bfb\uff0c\u6b64\u65f6\u53ef\u4ee5\u901a\u8fc7Alertmanager\u7684\u6a21\u677f\u529f\u80fd\u914d\u7f6e\u4e00\u4e9b\u81ea\u5b9a\u4e49\u6a21\u677f\u3002</p> <p>\u9996\u5148\u4fee\u6539alertmanager-secret.yaml\u6dfb\u52a0\u81ea\u5b9a\u4e49\u6a21\u677f\uff08\u6ce8\u610fwechat.tmpl\u548calertmanager.yaml\u9700\u8981\u5bf9\u9f50\uff0c\u6a21\u677f\u7684\u5185\u5bb9\u4e5f\u662f\u901a\u8fc7go-template\u7f16\u5199\u7684\uff09\uff1a</p> <pre><code>        app.kubernetes.io/part-of: kube-prometheus\napp.kubernetes.io/version: 0.21.0\nname: alertmanager-main\nnamespace: monitoring\nstringData:\nwechat.tmpl: |-\n{{ define \"wechat.default.message\" }}\n... \n{{- end }}\nalertmanager.yaml: |-\n\"global\":\n\"resolve_timeout\": \"5m\"\n</code></pre> <p>\u5728templates\u5b57\u6bb5\u6dfb\u52a0\u6a21\u677f\u4f4d\u7f6e\uff1a</p> <pre><code>templates:\n- '/etc/alertmanager/config/*.tmpl'\n\"inhibit_rules\":\n</code></pre> <p>\u914d\u7f6ewechat-ops receiver\u4f7f\u7528\u8be5\u6a21\u677f\uff1a</p> <pre><code>    \"receivers\":\n- \"name\": wechat-ops\nwechat_configs:\n- send_resolved: true\nto_party: 3\n...\nmessage: '{{ template \"wechat.default.message\" . }}'\n</code></pre> <p>\u6ce8\u610f</p> <p>{{  template  \"wechat.default.message\"  .  }} \u914d \u7f6e \u7684wechat.default.message \u662f \u6a21 \u677f \u6587 \u4ef6 define \u5b9a \u4e49 \u7684 \u540d \u79f0 \uff1a {{ define \"wechat.default.message\" }}\uff0c\u5e76\u975e\u6587\u4ef6\u540d\u79f0\u3002</p> <p>\u5c06\u914d\u7f6e\u66f4\u65b0\u81f3Alertmanager\uff1a</p> <pre><code># kubectl replace -f alertmanager-secret.yaml\nsecret/alertmanager-main replaced\n</code></pre> <p>\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u5728Secret\u4e2d\u67e5\u770b\u8be5\u914d\u7f6e\uff1a</p> <pre><code># kubectl describe secrets alertmanager-main -n monitoring\nName:         alertmanager-main\nNamespace:    monitoring\nLabels:       alertmanager=main\n              app.kubernetes.io/component=alert-router\n              app.kubernetes.io/name=alertmanager\n              app.kubernetes.io/part-of=kube-prometheus\n              app.kubernetes.io/version=0.22.2\nAnnotations:  &lt;none&gt;\n\nType:  Opaque\n\nData\n====\nalertmanager.yaml:  1438 bytes\nwechat.tmpl:     1823 bytes\n</code></pre> <p>\u4e4b\u540e\u518d\u6b21\u6536\u5230\u544a\u8b66\uff0c\u5373\u4e3a\u81ea\u5b9a\u4e49\u544a\u8b66\u6a21\u677f\uff0c\u5982\u56fe15.63\u6240\u793a\u3002</p> <p>)</p> <p>\u56fe15.63\u3000\u67e5\u770b\u5fae\u4fe1\u544a\u8b66</p> <p>\u63d0\u793a</p> <p>\u65b0\u7248\u7684kube-prometheus\u63d0\u4f9b\u4e86Alertmanager \u914d\u7f6e\u7684\u81ea\u5b9a\u4e49\u8d44\u6e90AlertmanagerConfig\uff0c\u4e0a\u8ff0\u914d\u7f6e\u5747\u53ef\u4ee5\u901a\u8fc7AlertmanagerConfig\u8fdb\u884c\u914d \u7f6e\uff0c\u4f46\u662f\u7531\u4e8eAlertmanagerConfig\u8fd8\u4e0d\u591f\u6210\u719f\uff0c\u5e76\u4e14\u5e76\u4e0d\u662f\u6240\u6709\u7684\u516c\u53f8\u90fd\u5c06Prometheus\u6280\u672f\u6808\u90e8\u7f72\u81f3Kubernetes\uff0c \u56e0\u6b64\u672c\u4e66\u8fd8\u662f\u4ee5\u4f20\u7edf\u7684\u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u8bb2\u89e3\uff0c \u6709\u5174\u8da3\u7684\u8bfb\u8005\u53ef\u4ee5\u53c2\u8003 https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/design.md#alertmanagerconfig \u8fdb\u884c\u5b66\u4e60\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#9prometheus\u544a\u8b66\u5b9e\u6218","title":"9.Prometheus\u544a\u8b66\u5b9e\u6218","text":"<p>\u524d\u9762\u7684\u7ae0\u8282\u57fa\u672c\u4e0a\u5bf9Prometheus\u548cAlertmanager\u5e38\u7528\u7684\u914d\u7f6e\u8fdb\u884c\u4e86\u5168\u9762\u7684\u5b66\u4e60\uff0c\u5e76\u4e14\u5b66\u4e60\u4e86PromQL\u8bed\u6cd5\uff0c\u5b9e\u73b0\u4e86\u5e38\u7528\u5a92\u4ecb\u7684\u544a\u8b66\u901a\u77e5\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u4ecb\u7ecd\u5982\u4f55\u4f7f\u7528PromQL\u81ea\u5b9a\u4e49\u544a\u8b66\u7b56\u7565\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#91-prometheusrule","title":"9.1 PrometheusRule","text":"<p>\u5728\u5b89\u88c5Prometheus\u540e\uff0c\u9ed8\u8ba4\u914d\u7f6e\u4e86\u5f88\u591a\u544a\u8b66\u7b56\u7565\uff0c\u90a3\u4e48\u8fd9\u4e9b\u544a\u8b66\u914d\u7f6e\u662f\u5982\u4f55\u52a0\u8f7d\u5230Prometheus\u7684\u5462\uff1f</p> <p>\u5728\u4f20\u7edf\u67b6\u6784\u4e2d\uff0c\u901a\u8fc7\u76f4\u63a5\u4fee\u6539Prometheus\u7684\u914d\u7f6e\u6587\u4ef6\u5373\u53ef\u52a0\u8f7d\u76f8\u5e94\u7684\u544a\u8b66\u7b56\u7565\uff0c\u4f46\u662f\u5728Prometheus Operator\u4e2d\uff0c\u65e0\u987b\u518d\u76f4\u63a5\u4fee\u6539Prometheus\u7684\u914d\u7f6e\uff0c\u901a\u8fc7\u81ea\u5b9a\u4e49\u7684\u8d44\u6e90PrometheusRule\u5373\u53ef\u914d\u7f6e\u544a\u8b66\u7b56\u7565\u3002\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u67e5\u770b\u9ed8\u8ba4\u914d\u7f6e\u7684\u544a\u8b66\u7b56\u7565\uff1a</p> <pre><code># kubectl get prometheusrule -n monitoring\nNAME                              AGE\nalertmanager-main-rules           44h\nkube-prometheus-rules             44h\nkube-state-metrics-rules          44h\nkubernetes-monitoring-rules       44h\nnode-exporter-rules               44h\nprometheus-k8s-prometheus-rules   44h\nprometheus-operator-rules         44h\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u901a\u8fc7-oyaml\u67e5\u770b\u67d0\u4e2arules\u7684\u8be6\u7ec6\u914d\u7f6e\uff1a</p> <pre><code># kubectl get prometheusrule node-exporter-rules -n monitoring -o yaml\napiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\n....    spec:\n  groups:\n  - name: node-exporter\n    rules:\n    - alert: NodeFilesystemSpaceFillingUp\n      annotations:\n        description: Filesystem on {{ $labels.device }} at {{ $labels.instance }}\nhas only {{ printf \"%.2f\" $value }}% available space left and is filling\n          up.\n        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodefilesystemspacefillingup\n        summary: Filesystem is predicted to run out of space within the next 24 hours.\n      expr: |\n(\nnode_filesystem_avail_bytes{job=\"node-exporter\",fstype!=\"\"} / node_filesystem_size_bytes{job=\"node-exporter\",fstype!=\"\"} * 100 &lt; 40\nand\n          predict_linear(node_filesystem_avail_bytes{job=\"node-exporter\",fstype!=\"\"}[6h], 24*60*60) &lt; 0\nand\n          node_filesystem_readonly{job=\"node-exporter\",fstype!=\"\"} == 0\n)\nfor: 1h\n      labels:\n        severity: warning\n</code></pre> <p>groups\u4e0b\u7684\u914d\u7f6e\u5373\u4e3a\u544a\u8b66\u7b56\u7565,\u5982\u679c\u8bfb\u8005\u5b66\u4e60\u8fc7\u4f20\u7edf\u914d\u7f6e\u7684Prometheus\uff0c\u5176\u5b9e\u53ef\u4ee5\u770b\u51fa\u5e76\u65e0\u533a\u522b\uff0c\u53ea\u662fOperator\u662f\u901a\u8fc7kind\u4e3a PrometheusRule\u8fdb\u884c\u5355\u72ec\u7ba1\u7406\u7684\u3002</p> <p>\u63a5\u4e0b\u6765\u8fdb\u884c\u6bcf\u4e2a\u914d\u7f6e\u7684\u89e3\u6790\u3002</p> <ul> <li>alert\uff1a\u544a\u8b66\u7b56\u7565\u7684\u540d\u79f0\u3002</li> <li>annotations\uff1a\u544a\u8b66\u6ce8\u91ca\u4fe1\u606f\uff0c\u4e00\u822c\u5199\u4e3a\u544a\u8b66\u4fe1\u606f\u3002</li> <li>expr\uff1a\u544a\u8b66\u8868\u8fbe\u5f0f\u3002</li> <li>for\uff1a\u8bc4\u4f30\u7b49\u5f85\u65f6\u95f4\uff0c\u544a\u8b66\u6301\u7eed\u591a\u4e45\u624d\u4f1a\u53d1\u9001\u544a\u8b66\u6570\u636e\u3002</li> <li>labels\uff1a\u544a\u8b66\u7684\u6807\u7b7e\uff0c\u7528\u4e8e\u544a\u8b66\u7684\u8def\u7531\u3002</li> </ul> <p>\u4e86\u89e3\u4e86PrometheusRule\u5199\u6cd5\u89c4\u5219\u540e\uff0c\u53ef\u4ee5\u81ea\u5b9a\u4e49\u4e00\u4e2a\u544a\u8b66\u7b56\u7565\u3002</p> <p>\u5b9e\u9645\u4f7f\u7528\u65f6\u53ef\u4ee5\u6309\u7167\u76d1\u63a7\u7684\u76ee\u6807\u5212\u5206PrometheusRule\uff0c\u6bd4\u5982\u4e4b\u524d\u914d\u7f6e\u4e86\u9ed1\u76d2\u76d1\u63a7\uff0c\u90a3\u4e48\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u540d\u4e3ablackbox\u7684PrometheusRule\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/#92-\u544a\u8b66\u901a\u7528\u914d\u7f6e\u6b65\u9aa4","title":"9.2 \u544a\u8b66\u901a\u7528\u914d\u7f6e\u6b65\u9aa4","text":"<p>\u5047\u8bbe\u9700\u8981\u5bf9\u57df\u540d\u8bbf\u95ee\u5ef6\u8fdf\u8fdb\u884c\u76d1\u63a7\uff0c\u8bbf\u95ee\u5ef6\u8fdf\u5927\u4e8e1\u79d2\u8fdb\u884c\u544a\u8b66\uff08\u751f\u4ea7\u73af\u5883\u53ef\u4ee5\u6309\u9700\u8c03\u8282\uff0c\u4e3a\u4e86\u5b9e\u73b0\u544a\u8b66\u6d4b\u8bd5\uff0c\u53ef\u4ee5\u5c06\u8be5\u503c\u8bbe\u7f6e\u5f97\u5c0f\u4e00\u4e9b\uff09\uff0c\u6b64\u65f6\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2aPrometheusRule\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/","title":"\u670d\u52a1\u53d1\u5e03Ingress\u8fdb\u9636","text":"<p>\u8981\u5c06Kubernetes\u96c6\u7fa4\u5185\u7684\u670d\u52a1\u53d1\u5e03\u5230\u96c6\u7fa4\u5916\u6765\u4f7f\u7528\uff0c\u901a\u5e38\u7684\u529e\u6cd5\u662f</p> <ol> <li>\u914d\u7f6eNodePort</li> <li>\u914d\u7f6eLoadBalancer\u7684Service</li> <li>\u914d\u7f6eExternalIP\u7684Service</li> <li>\u901a\u8fc7Pod\u6a21\u677f\u4e2d\u7684HostPort\u8fdb\u884c\u914d\u7f6e\u7b49\u3002</li> </ol> <p>\u4f46\u8fd9\u4e9b\u65b9\u5f0f\u90fd\u5b58\u5728\u6bd4\u8f83\u4e25\u91cd\u7684\u95ee\u9898\u3002\u5b83\u4eec\u51e0\u4e4e\u90fd\u662f\u901a\u8fc7\u8282\u70b9\u7aef\u53e3\u5f62\u5f0f\u5411\u5916\u66b4\u9732\u670d\u52a1\u7684\uff0cService\u4e00\u65e6\u53d8\u591a\uff0c\u6bcf\u4e2a\u8282\u70b9\u4e0a\u5f00\u542f\u7684\u7aef\u53e3\u4e5f\u4f1a \u53d8\u591a\u3002\u8fd9\u6837\u4e0d\u4ec5\u7ef4\u62a4\u8d77\u6765\u76f8\u5f53\u590d\u6742\uff0c\u5b89\u5168\u6027\u8fd8\u4f1a\u5927\u5927\u964d\u4f4e\u3002</p> <p>Ingress\u53ef\u4ee5\u907f\u514d\u8fd9\u4e2a\u95ee\u9898\uff0c\u9664\u4e86Ingress\u81ea\u8eab\u7684\u670d\u52a1\u9700\u8981\u5411\u5916\u53d1\u5e03\u4e4b\u5916\uff0c\u5176\u4ed6\u670d\u52a1\u4e0d\u5fc5\u4f7f\u7528\u8282\u70b9\u7aef\u53e3\u5f62\u5f0f\u5411\u5916\u53d1\u5e03\u3002</p> <p>\u5728\u670d\u52a1\u53d1\u5e03\u57fa\u7840\u7bc7\uff0c\u6211\u4eec\u4ecb\u7ecd\u4e86Ingress\u8fd9\u4e2a\u62bd\u8c61\u6982\u5ff5\uff0c\u5e76\u4e14\u5bf9Ingress\u7684\u914d\u7f6e\u8fdb\u884c\u4e86\u7b80\u5355\u7684\u8bb2\u89e3\u3002</p> <p>\u4f46\u662f\u5728\u5b9e\u9645\u4f7f\u7528\u65f6\uff0c\u5bf9\u4e8e\u5e94\u7528\u7684\u53d1\u5e03\uff0c\u573a\u666f\u66f4\u4e3a\u590d\u6742\uff0c\u4e4b\u524d\u8bb2\u89e3\u7684\u5185\u5bb9\u4e0d\u8db3\u4ee5\u6ee1\u8db3\u751f\u4ea7\u73af\u5883\u7684\u9700\u6c42\u3002 \u672c\u7ae0\u5c06\u4f1a\u8fdb\u4e00\u6b65\u4ecb\u7ecdIngress\u7684\u4f7f\u7528\uff0c\u4ee5\u6ee1\u8db3\u5b9e\u9645\u4f7f\u7528\u65f6\u7684\u5404\u79cd\u9700\u6c42\u3002</p> <p>\u9996\u5148\u56de\u987e\u4e00\u4e0b\u7528\u6237\u8bbf\u95ee\u4e00\u4e2a\u4e1a\u52a1\u7684\u6d41\u7a0b\uff1a</p> <p>1\uff09\u7528\u6237\u5728\u6d4f\u89c8\u5668\u4e2d\u8f93\u5165\u57df\u540d\u3002</p> <p>2\uff09\u57df\u540d\u89e3\u6790\u81f3\u4e1a\u52a1\u7684\u5165\u53e3IP\uff08\u4e00\u822c\u4e3a\u5916\u90e8\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u6bd4\u5982\u963f\u91cc\u4e91\u7684SLB\u6216\u8005DMZ\u7684\u7f51\u5173\uff09\u3002</p> <p>3\uff09\u5916\u90e8\u8d1f\u8f7d\u5747\u8861\u5668\u53cd\u5411\u4ee3\u7406\u81f3Kubernetes\u7684\u5165\u53e3\uff08\u4e00\u822c\u4e3aIngress\uff0c\u6216\u8005\u901a\u8fc7NodePort\u66b4\u9732\u7684\u670d\u52a1\u7b49\uff09\u3002</p> <p>4\uff09Ingress\u6839\u636e\u81ea\u8eab\u7684\u914d\u7f6e\u627e\u5230\u5bf9\u5e94\u7684Service\uff0c\u518d\u4ee3\u7406\u5230\u5bf9\u5e94\u7684Service\u4e0a\u3002</p> <p>5\uff09\u6700\u540e\u5230\u8fbeService\u5bf9\u5e94\u7684\u67d0\u4e00\u4e2aPod\u4e0a\u3002</p> <p>Ingress Controller \u53ef\u4ee5\u7406\u89e3\u4e3a\u4e00\u4e2a\u76d1\u542c\u5668\uff0c\u901a\u8fc7\u4e0d\u65ad\u5730\u76d1\u542c kube-apiserver\uff0c\u5b9e\u65f6\u7684\u611f\u77e5\u540e\u7aef Service\u3001Pod \u7684\u53d8\u5316\uff0c\u5f53\u5f97\u5230\u8fd9\u4e9b\u4fe1\u606f\u53d8\u5316\u540e\uff0cIngress Controller \u518d\u7ed3\u5408 Ingress \u7684\u914d\u7f6e\uff0c\u66f4\u65b0\u53cd\u5411\u4ee3\u7406\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u8fbe\u5230\u670d\u52a1\u53d1\u73b0\u7684\u4f5c\u7528\u3002\u5176\u5b9e\u8fd9\u70b9\u548c\u670d\u52a1\u53d1\u73b0\u5de5\u5177 consul\u3001 consul-template \u975e\u5e38\u7c7b\u4f3c\u3002</p> <p>)</p> <p>\u53ef\u89c1\uff0c\u5728\u4e00\u822c\u60c5\u51b5\u4e0b\uff0cIngress\u4e3b\u8981\u662f\u4e00\u4e2a\u7528\u4e8eKubernetes\u96c6\u7fa4\u4e1a\u52a1\u7684\u5165\u53e3\u3002</p> <p>Ingress\u63a7\u5236\u5668\u4e0d\u4f1a\u968f\u7740Kubernetes\u4e00\u8d77\u5b89\u88c5\u3002\u5982\u679c\u8981\u8ba9Ingress\u8d44\u6e90\u6b63\u5e38\u8fd0\u4f5c\uff0c\u9700\u8981\u5b89\u88c5Ingress\u63a7\u5236\u5668\u3002\u53ef\u4ee5\u9009\u62e9\u7684Ingress\u63a7\u5236\u5668 \u79cd\u7c7b\u5f88\u591a\uff0c\u53ef\u6839\u636e\u60c5\u51b5\u81ea\u884c\u9009\u62e9\u3002</p> <p>\u73b0\u5728\u53ef\u4ee5\u4f9b\u5927\u5bb6\u4f7f\u7528\u7684 Ingress Controller \u6709\u5f88\u591a\uff0c\u6bd4\u5982</p> <ul> <li>traefik</li> <li>nginx-controller</li> <li>Kubernetes Ingress Controller for Kong</li> <li>HAProxy Ingress controller</li> </ul> <p>\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u81ea\u5df1\u5b9e\u73b0\u4e00\u4e2a Ingress Controller\uff0c\u73b0\u5728\u666e\u904d\u7528\u5f97\u8f83\u591a\u7684\u662f traefik \u548c nginx-controller\uff0ctraefik \u7684\u6027\u80fd\u8f83 nginx-controller \u5dee\uff0c\u4f46\u662f\u914d\u7f6e\u4f7f\u7528\u8981\u7b80\u5355\u8bb8\u591a\uff0c\u6211\u4eec\u8fd9\u91cc\u4f1a\u91cd\u70b9\u7ed9\u5927\u5bb6\u4ecb\u7ecd nginx-controller \u4ee5\u53ca traefik \u7684\u4f7f\u7528\u3002</p> <p>\u56e0 \u4e3a \u76f8 \u5bf9 \u4e8e \u5176 \u4ed6 IngressController\uff0c\u7ba1\u7406\u4eba\u5458\u66f4\u719f\u6089Nginx\u6216\u8005HAProxy\u7b49\u670d\u52a1\uff0c\u6240\u4ee5\u672c\u7ae0\u4e3b\u8981\u8bb2\u89e3Ingress Nginx\u7684\u5b89\u88c5\u4e0e\u5e38\u7528\u914d\u7f6e\uff0c\u8fd9\u4e5f\u662fKubernetes\u5b98\u65b9\u63d0\u4f9b\u7684IngressController\uff0c\u6709\u5173\u5176\u4ed6\u7684Ingress\uff0c\u8bfb\u8005\u53ef\u53c2\u8003\u76f8\u5173\u8d44\u6599\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#1-\u5b89\u88c5ingress-nginx-controller","title":"1. \u5b89\u88c5Ingress Nginx Controller","text":"<p>\u4e4b\u524d\u63d0\u5230\u8fc7\uff0c\u7531\u4e8eIngress Controller\u76f8\u5f53\u4e8eKubernetes\u96c6\u7fa4\u4e2d\u670d\u52a1\u7684\u201c\u5927\u95e8\u201d\uff0c\u56e0\u6b64\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u4e00\u5b9a\u8981\u4fdd\u969cController\u7684\u7a33\u5b9a\u6027\u548c\u53ef\u7528\u6027\u3002</p> <p>\u4e3a\u4e86\u63d0\u9ad8Ingress Controller\u7684\u53ef\u7528\u6027\uff0c\u6211\u4eec\u4e00\u822c\u91c7\u7528\u5355\u72ec\u7684\u670d\u52a1\u5668\u4f5c\u4e3aController\u8282\u70b9\uff0c\u4ee5\u6b64\u4fdd\u969cIngress Controller\u7684Pod\u8d44\u6e90\u4e0d\u4f1a\u88ab\u5176\u4ed6\u670d\u52a1\u7684 Pod\u5f71\u54cd\u3002</p> <p>\u7531\u4e8e nginx-ingress \u6240\u5728\u7684\u8282\u70b9\u9700\u8981\u80fd\u591f\u8bbf\u95ee\u5916\u7f51\uff0c\u8fd9\u6837\u57df\u540d\u53ef\u4ee5\u89e3\u6790\u5230\u8fd9\u4e9b\u8282\u70b9\u4e0a\u76f4\u63a5\u4f7f\u7528\uff0c\u6240\u4ee5\u9700\u8981\u8ba9 nginx-ingress \u7ed1\u5b9a\u8282\u70b9\u7684 80 \u548c 443 \u7aef\u53e3\uff0c\u6240\u4ee5\u53ef\u4ee5\u4f7f\u7528 hostPort \u6765\u8fdb\u884c\u8bbf\u95ee\uff0c\u5f53\u7136\u5bf9\u4e8e\u7ebf\u4e0a\u73af\u5883\u6765\u8bf4\u4e3a\u4e86\u4fdd\u8bc1\u9ad8\u53ef\u7528\uff0c\u4e00\u822c\u662f\u9700\u8981\u8fd0\u884c\u591a\u4e2a nginx-ingress \u5b9e\u4f8b\u7684\uff0c\u7136\u540e\u53ef\u4ee5\u7528\u4e00\u4e2a nginx/haproxy \u4f5c\u4e3a\u5165\u53e3\uff0c\u901a\u8fc7 keepalived \u6765\u8bbf\u95ee\u8fb9\u7f18\u8282\u70b9\u7684 vip \u5730\u5740\u3002</p> <p>\u8fb9\u7f18\u8282\u70b9</p> <p>\u6240\u8c13\u7684\u8fb9\u7f18\u8282\u70b9\u5373\u96c6\u7fa4\u5185\u90e8\u7528\u6765\u5411\u96c6\u7fa4\u5916\u66b4\u9732\u670d\u52a1\u80fd\u529b\u7684\u8282\u70b9\uff0c\u96c6\u7fa4\u5916\u90e8\u7684\u670d\u52a1\u901a\u8fc7\u8be5\u8282\u70b9\u6765\u8c03\u7528\u96c6\u7fa4\u5185\u90e8\u7684\u670d\u52a1\uff0c\u8fb9\u7f18\u8282\u70b9\u662f\u96c6\u7fa4\u5185\u5916\u4ea4\u6d41\u7684\u4e00\u4e2aEndpoint\u3002</p> <p>)</p> <p>\u751f\u4ea7\u73af\u5883</p> <p>\u6211\u4eec\u90e8\u7f722\u4e2aingress\u8282\u70b9\uff0c\u505aha\u9ad8\u53ef\u7528\uff0c\u5bf9\u5916\u53d1\u5e03\u670d\u52a1\u3002</p> <ol> <li>\u8bbe\u7f6e\u6c61\u70b9\u548c\u6807\u7b7e</li> </ol> <pre><code># kubectl taint node k8s-node1 GiteeCommonAddonsOnly=yes:NoSchedule\n# kubectl taint node k8s-node2 GiteeCommonAddonsOnly=yes:NoSchedule\n</code></pre> <ol> <li>\u6253\u6807\u7b7e</li> </ol> <pre><code>## \u6253\u4e0a2\u4e2a\u6807\u7b7e\u3002\n## \u5e26\u6709ingress\u6807\u8bc6\u7b26\u7684\u6807\u7b7e\n# kubectl label nodes k8s-node01 node-role.kubernetes.io/ingress=\"true\"\n# kubectl label nodes k8s-node02 node-role.kubernetes.io/ingress=\"true\"\n## \u67e5\u770b\u8282\u70b9\u662f\u5426\u8bbe\u7f6e Label \u6210\u529f\n## \u67e5\u770b\u6240\u6709\u8282\u70b9\n# kubectl get nodes --show-labels\n## \u67e5\u770b\u5355\u4e2a\u8282\u70b9\n# kubectl get nodes k8s-node01 --show-labels\n## \u5220\u9664\u5e26\u6709node-role.kubernetes.io/edge\u6807\u8bc6\u7b26\u7684\u6807\u7b7e\n# kubectl label k8s-node01 node-role.kubernetes.io/ingress-\n# kubectl label k8s-node02 node-role.kubernetes.io/ingress-\n## \u66f4\u65b0deployment\uff0c\u589e\u52a0nodeSelector\u914d\u7f6e\n# $ kubectl -n kube-system patch deployment nginx-ingress-controller -p '{\"spec\": {\"template\": {\"spec\": {\"nodeSelector\": {\"node-role.kubernetes.io/ingress\": \"true\"}}}}}'\n</code></pre> <ol> <li>\u5b89\u88c5keepalived+haproxy</li> </ol> <p>\u8bbe\u7f6e\u8fb9\u7f18\u8282\u70b9\u9ad8\u53ef\u7528\uff0c\u5728k8s-node01\u548ck8s-node02\u4e0a\u5b89\u88c5keepalived+haproxy</p> <p>\u53c2\u8003</p> <p>\u5728\u6307\u5b9a\u8282\u70b9\u90e8\u7f72Ingress\u670d\u52a1</p> <p>\u6d4b\u8bd5\u73af\u5883</p> <p>\u8fd9\u91cc\u5c06k8s-node01\u4f5c\u4e3a\u8fb9\u7f18\u8282\u70b9\uff0c\u6253\u4e0aLabel\uff1a</p> <pre><code># kubectl label nodes k8s-node01 node-role.kubernetes.io/ingress=\"true\"\n# kubectl  get nodes\nNAME           STATUS   ROLES           AGE   VERSION\nk8s-master01   Ready    control-plane   19h   v1.25.6\nk8s-master02   Ready    control-plane   19h   v1.25.6\nk8s-master03   Ready    control-plane   19h   v1.25.6\nk8s-node01     Ready    ingress         19h   v1.25.6\n\n# kubectl get nodes k8s-node01 --show-labels\nNAME         STATUS   ROLES     AGE   VERSION   LABELS\nk8s-node01   Ready    ingress   19h   v1.25.6   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node01,kubernetes.io/os=linux,node-role.kubernetes.io/ingress=true\n</code></pre> <p>\u4e0b\u8f7dingress-nginx\u7684helm chart:</p> <pre><code># \u5982\u679c\u4f60\u4e0d\u559c\u6b22\u4f7f\u7528 helm chart \u8fdb\u884c\u5b89\u88c5\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u4e00\u952e\u5b89\u88c5\n# kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.0/deploy/static/provider/cloud/deploy.yaml\n\u279c helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx\n\u279c helm repo update\n\u279c helm fetch ingress-nginx/ingress-nginx\n\u279c tar -xvf ingress-nginx-4.4.2.tgz &amp;&amp; cd ingress-nginx\n\u279c tree .\n.\n\u251c\u2500\u2500 CHANGELOG.md\n\u251c\u2500\u2500 Chart.yaml\n\u251c\u2500\u2500 OWNERS\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 ci\n\u2502   \u251c\u2500\u2500 controller-custom-ingressclass-flags.yaml\n\u2502   \u251c\u2500\u2500 daemonset-customconfig-values.yaml\n\u2502   \u251c\u2500\u2500 daemonset-customnodeport-values.yaml\n\u2502   \u251c\u2500\u2500 daemonset-headers-values.yaml\n\u2502   \u251c\u2500\u2500 daemonset-internal-lb-values.yaml\n\u2502   \u251c\u2500\u2500 daemonset-nodeport-values.yaml\n\u2502   \u251c\u2500\u2500 daemonset-podannotations-values.yaml\n\u2502   \u251c\u2500\u2500 daemonset-tcp-udp-configMapNamespace-values.yaml\n\u2502   \u251c\u2500\u2500 daemonset-tcp-udp-values.yaml\n\u2502   \u251c\u2500\u2500 daemonset-tcp-values.yaml\n\u2502   \u251c\u2500\u2500 deamonset-default-values.yaml\n\u2502   \u251c\u2500\u2500 deamonset-metrics-values.yaml\n\u2502   \u251c\u2500\u2500 deamonset-psp-values.yaml\n\u2502   \u251c\u2500\u2500 deamonset-webhook-and-psp-values.yaml\n\u2502   \u251c\u2500\u2500 deamonset-webhook-values.yaml\n\u2502   \u251c\u2500\u2500 deployment-autoscaling-behavior-values.yaml\n\u2502   \u251c\u2500\u2500 deployment-autoscaling-values.yaml\n\u2502   \u251c\u2500\u2500 deployment-customconfig-values.yaml\n\u2502   \u251c\u2500\u2500 deployment-customnodeport-values.yaml\n\u2502   \u251c\u2500\u2500 deployment-default-values.yaml\n\u2502   \u251c\u2500\u2500 deployment-headers-values.yaml\n\u2502   \u251c\u2500\u2500 deployment-internal-lb-values.yaml\n\u2502   \u251c\u2500\u2500 deployment-metrics-values.yaml\n\u2502   \u251c\u2500\u2500 deployment-nodeport-values.yaml\n\u2502   \u251c\u2500\u2500 deployment-podannotations-values.yaml\n\u2502   \u251c\u2500\u2500 deployment-psp-values.yaml\n\u2502   \u251c\u2500\u2500 deployment-tcp-udp-configMapNamespace-values.yaml\n\u2502   \u251c\u2500\u2500 deployment-tcp-udp-values.yaml\n\u2502   \u251c\u2500\u2500 deployment-tcp-values.yaml\n\u2502   \u251c\u2500\u2500 deployment-webhook-and-psp-values.yaml\n\u2502   \u251c\u2500\u2500 deployment-webhook-resources-values.yaml\n\u2502   \u2514\u2500\u2500 deployment-webhook-values.yaml\n\u251c\u2500\u2500 templates\n\u2502   \u251c\u2500\u2500 NOTES.txt\n\u2502   \u251c\u2500\u2500 _helpers.tpl\n\u2502   \u251c\u2500\u2500 _params.tpl\n\u2502   \u251c\u2500\u2500 admission-webhooks\n\u2502   \u2502   \u251c\u2500\u2500 job-patch\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 clusterrole.yaml\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 clusterrolebinding.yaml\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 job-createSecret.yaml\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 job-patchWebhook.yaml\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 psp.yaml\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 role.yaml\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 rolebinding.yaml\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 serviceaccount.yaml\n\u2502   \u2502   \u2514\u2500\u2500 validating-webhook.yaml\n\u2502   \u251c\u2500\u2500 clusterrole.yaml\n\u2502   \u251c\u2500\u2500 clusterrolebinding.yaml\n\u2502   \u251c\u2500\u2500 controller-configmap-addheaders.yaml\n\u2502   \u251c\u2500\u2500 controller-configmap-proxyheaders.yaml\n\u2502   \u251c\u2500\u2500 controller-configmap-tcp.yaml\n\u2502   \u251c\u2500\u2500 controller-configmap-udp.yaml\n\u2502   \u251c\u2500\u2500 controller-configmap.yaml\n\u2502   \u251c\u2500\u2500 controller-daemonset.yaml\n\u2502   \u251c\u2500\u2500 controller-deployment.yaml\n\u2502   \u251c\u2500\u2500 controller-hpa.yaml\n\u2502   \u251c\u2500\u2500 controller-ingressclass.yaml\n\u2502   \u251c\u2500\u2500 controller-keda.yaml\n\u2502   \u251c\u2500\u2500 controller-poddisruptionbudget.yaml\n\u2502   \u251c\u2500\u2500 controller-prometheusrules.yaml\n\u2502   \u251c\u2500\u2500 controller-psp.yaml\n\u2502   \u251c\u2500\u2500 controller-role.yaml\n\u2502   \u251c\u2500\u2500 controller-rolebinding.yaml\n\u2502   \u251c\u2500\u2500 controller-service-internal.yaml\n\u2502   \u251c\u2500\u2500 controller-service-metrics.yaml\n\u2502   \u251c\u2500\u2500 controller-service-webhook.yaml\n\u2502   \u251c\u2500\u2500 controller-service.yaml\n\u2502   \u251c\u2500\u2500 controller-serviceaccount.yaml\n\u2502   \u251c\u2500\u2500 controller-servicemonitor.yaml\n\u2502   \u251c\u2500\u2500 default-backend-deployment.yaml\n\u2502   \u251c\u2500\u2500 default-backend-hpa.yaml\n\u2502   \u251c\u2500\u2500 default-backend-poddisruptionbudget.yaml\n\u2502   \u251c\u2500\u2500 default-backend-psp.yaml\n\u2502   \u251c\u2500\u2500 default-backend-role.yaml\n\u2502   \u251c\u2500\u2500 default-backend-rolebinding.yaml\n\u2502   \u251c\u2500\u2500 default-backend-service.yaml\n\u2502   \u251c\u2500\u2500 default-backend-serviceaccount.yaml\n\u2502   \u2514\u2500\u2500 dh-param-secret.yaml\n\u2514\u2500\u2500 values.yaml\n\n4 directories, 81 files\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u6d4b\u8bd5\u73af\u5883\u53ea\u6709 k8s-node01\u8282\u70b9\u53ef\u4ee5\u8bbf\u95ee\u5916\u7f51\uff0c\u8fd9\u91cc\u6211\u4eec\u5c31\u76f4\u63a5\u8bb2 ingress-nginx \u56fa\u5b9a\u5230 k8s-node01\u8282\u70b9\u4e0a\uff0c\u91c7\u7528 hostNetwork \u6a21\u5f0f(\u751f\u4ea7\u73af\u5883\u53ef\u4ee5\u4f7f\u7528 LB + DaemonSet hostNetwork \u6a21\u5f0f)\u3002</p> <p>\u7136\u540e\u65b0\u5efa\u4e00\u4e2a\u540d\u4e3a values-prod.yaml \u7684 Values \u6587\u4ef6\uff0c\u7528\u6765\u8986\u76d6 ingress-nginx \u9ed8\u8ba4\u7684 Values \u503c\uff0c\u5bf9\u5e94\u7684\u6570\u636e\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>\u279c helm show values ingress-nginx &gt; values-prod.yaml\n\u279c vim values-prod.yaml\ncontroller:\n  name: controller\n  image:\n    repository: cnych/ingress-nginx\n    tag: \"v1.1.0\"\ndigest:\n\ndnsPolicy: ClusterFirstWithHostNet\n\nconfig:\n    apiVersion: v1\n    client_max_body_size: 20m\n    custom-http-errors: \"404,415,503\"\nhostNetwork: true\npublishService:  # hostNetwork \u6a21\u5f0f\u4e0b\u8bbe\u7f6e\u4e3afalse\uff0c\u901a\u8fc7\u8282\u70b9IP\u5730\u5740\u4e0a\u62a5ingress status\u6570\u636e\nenabled: false\n# \u662f\u5426\u9700\u8981\u5904\u7406\u4e0d\u5e26 ingressClass \u6ce8\u89e3\u6216\u8005 ingressClassName \u5c5e\u6027\u7684 Ingress \u5bf9\u8c61\n# \u8bbe\u7f6e\u4e3a true \u4f1a\u5728\u63a7\u5236\u5668\u542f\u52a8\u53c2\u6570\u4e2d\u65b0\u589e\u4e00\u4e2a --watch-ingress-without-class \u6807\u6ce8\nwatchIngressWithoutClass: false\nkind: DaemonSet\n\nnodeSelector:   # \u56fa\u5b9a\u5230k8s-node1\u8282\u70b9\nnode-role.kubernetes.io/ingress: 'true'\nservice:  # HostNetwork \u6a21\u5f0f\u4e0d\u9700\u8981\u521b\u5efaservice\nenabled: false\nadmissionWebhooks: # \u5f3a\u70c8\u5efa\u8bae\u5f00\u542f admission webhook\nenabled: true\ncreateSecretJob:\n      resources:\n        limits:\n          cpu: 10m\n          memory: 20Mi\n        requests:\n          cpu: 10m\n          memory: 20Mi\n    patchWebhookJob:\n      resources:\n        limits:\n          cpu: 10m\n          memory: 20Mi\n        requests:\n          cpu: 10m\n          memory: 20Mi\n    patch:\n      enabled: true\nimage:\n        repository: cnych/ingress-nginx-webhook-certgen\n        tag: v1.1.1\n        digest:\n\ndefaultBackend:\n  enabled: true\nname: defaultbackend\n  image:\n    repository: cnych/ingress-nginx-defaultbackend\n    tag: \"1.5\"\n</code></pre> <p>\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u5b89\u88c5 ingress-nginx \u5e94\u7528\u5230 ingress-nginx \u7684\u547d\u540d\u7a7a\u95f4\u4e2d\uff1a</p> <pre><code>\u279c helm install ingress-nginx ingress-nginx -f ./values-prod.yaml --namespace ingress-nginx  --create-namespace\nNAME: ingress-nginx\nLAST DEPLOYED: Thu Feb  9 14:21:40 2023\nNAMESPACE: ingress-nginx\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nThe ingress-nginx controller has been installed.\nIt may take a few minutes for the LoadBalancer IP to be available.\nYou can watch the status by running 'kubectl --namespace ingress-nginx get services -o wide -w ingress-nginx-controller'\nAn example Ingress that makes use of the controller:\n  apiVersion: networking.k8s.io/v1\n  kind: Ingress\n  metadata:\n    name: example\n    namespace: foo\n  spec:\n    ingressClassName: nginx\n    rules:\n      - host: www.example.com\n        http:\n          paths:\n            - pathType: Prefix\n              backend:\n                service:\n                  name: exampleService\n                  port:\n                    number: 80\npath: /\n    # This section is only required if TLS is to be enabled for the Ingress\ntls:\n      - hosts:\n        - www.example.com\n        secretName: example-tls\n\nIf TLS is enabled for the Ingress, a Secret containing the certificate and key must also be provided:\n\napiVersion: v1\n  kind: Secret\n  metadata:\n    name: example-tls\n    namespace: foo\n  data:\n    tls.crt: &lt;base64 encoded cert&gt;\n    tls.key: &lt;base64 encoded key&gt;\n  type: kubernetes.io/tls\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e\u67e5\u770b Pod \u7684\u8fd0\u884c\u72b6\u6001\uff1a</p> <pre><code>\u279c kubectl get svc -n ingress-nginx\nNAME                                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE\ningress-nginx-controller-admission   ClusterIP   192.168.5.132    &lt;none&gt;        443/TCP   2m6s\ningress-nginx-defaultbackend         ClusterIP   192.168.230.39   &lt;none&gt;        80/TCP    2m6s\n\n\u279c kubectl get pods -n ingress-nginx\nNAME                                           READY   STATUS    RESTARTS   AGE\ningress-nginx-controller-j9w5j                 1/1     Running   0          2m36s\ningress-nginx-defaultbackend-f67985f77-t766q   1/1     Running   0          2m36s\n\u279c  POD_NAME=$(kubectl get pods -l app.kubernetes.io/name=ingress-nginx -n ingress-nginx -o jsonpath='{.items[0].metadata.name}')\n\u279c  kubectl exec -it $POD_NAME -n ingress-nginx -- /nginx-ingress-controller --version\n-------------------------------------------------------------------------------\nNGINX Ingress controller\n  Release:       v1.1.0\n  Build:         cacbee86b6ccc45bde8ffc184521bed3022e7dee\n  Repository:    https://github.com/kubernetes/ingress-nginx\n  nginx version: nginx/1.19.9\n\n-------------------------------------------------------------------------------\n</code></pre> <p>\u5f53\u770b\u5230\u4e0a\u9762\u7684\u4fe1\u606f\u8bc1\u660e <code>ingress-nginx</code> \u90e8\u7f72\u6210\u529f\u4e86\uff0c\u8fd9\u91cc\u6211\u4eec\u5b89\u88c5\u7684\u662f\u6700\u65b0\u7248\u672c\u7684\u63a7\u5236\u5668\uff0c\u5b89\u88c5\u5b8c\u6210\u540e\u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a \u540d\u4e3a <code>nginx</code> \u7684 <code>IngressClass</code> \u5bf9\u8c61\uff1a</p> <pre><code>\u279c  kubectl get ingressclass\nNAME    CONTROLLER             PARAMETERS   AGE\nnginx   k8s.io/ingress-nginx   &lt;none&gt;       3m55s\n\n\u279c  kubectl get ingressclass nginx -o yaml\napiVersion: networking.k8s.io/v1\nkind: IngressClass\nmetadata:\n......\n  labels:\n    app.kubernetes.io/component: controller\n    app.kubernetes.io/instance: ingress-nginx\n    app.kubernetes.io/managed-by: Helm\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\n    app.kubernetes.io/version: 1.5.1\n    helm.sh/chart: ingress-nginx-4.4.2\n  name: nginx\n  resourceVersion: \"124250\"\nuid: 0745abff-fc05-4ca8-a3fe-3e6218ed94b6\nspec:\n  controller: k8s.io/ingress-nginx\n</code></pre> <p>\u4e0d\u8fc7\u8fd9\u91cc\u6211\u4eec\u53ea\u63d0\u4f9b\u4e86\u4e00\u4e2a <code>controller</code> \u5c5e\u6027\uff0c\u5982\u679c\u8fd8\u9700\u8981\u914d\u7f6e\u4e00\u4e9b\u989d\u5916\u7684\u53c2\u6570\uff0c\u5219\u53ef\u4ee5\u5728\u5b89\u88c5\u7684 values \u6587\u4ef6\u4e2d\u8fdb\u884c\u914d\u7f6e\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#2-ingress-nginx\u5165\u95e8","title":"2. Ingress Nginx\u5165\u95e8","text":"<p>\u9996\u5148\u4ece\u6700\u7b80\u5355\u7684\u914d\u7f6e\u5f00\u59cb\uff0c\u5047\u5982\u516c\u53f8\u6709\u4e00\u4e2aWeb\u670d\u52a1\u7684\u5bb9\u5668\uff0c\u9700\u8981\u4e3a\u5176\u6dfb\u52a0\u4e00\u4e2a\u57df\u540d\uff0c\u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528Ingress\u5b9e\u73b0\u8be5\u529f\u80fd\u3002</p> <p>\u521b\u5efa\u4e00\u4e2a\u7528\u4e8e\u5b66\u4e60Ingress\u7684Namespace\uff0c\u4e4b\u540e\u6240\u6709\u7684\u64cd\u4f5c\u90fd\u5728\u6b64Namespace\u8fdb\u884c\uff1a</p> <pre><code># kubectl create ns study-ingress\nnamespace/study-ingress created\n</code></pre> <p>\u521b\u5efa\u4e00\u4e2a\u7b80\u5355\u7684Nginx\u6a21\u62dfWeb\u670d\u52a1\uff1a</p> <pre><code># kubectl create deploy nginx --image=registry.cn-beijing.aliyuncs.com/dotbalo/nginx:1.15.12 -n study-ingress                             deployment.apps/nginx created\n</code></pre> <p>\u521b\u5efa\u8be5Web\u5bb9\u5668\u7684Service\uff1a</p> <pre><code># kubectl expose deploy nginx --port 80 -n study-ingress\nservice/nginx exposed\n</code></pre> <p>\u4e4b\u540e\u521b\u5efaIngress\u6307\u5411\u4e0a\u9762\u521b\u5efa\u7684Service\uff1a</p> <p>web-ingress.yaml</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\nname: nginx-ingress\nnamespace: study-ingress\nspec:\ningressClassName: nginx\nrules:\n- host: nginx.test.com\nhttp:\npaths:\n- backend:\nservice:\nname: nginx\nport:\nnumber: 80\npath: /\npathType: ImplementationSpecific\n</code></pre> <p>\u63d0\u793a: </p> <p>\u672c\u7ae0\u5185\u5bb9\u5747\u91c7\u7528networking.k8s.io/v1\u7248\u672c\u521b\u5efaIngress\u8d44\u6e90\uff0c\u5982\u679cKubernetes\u7248\u672c\u4f4e\u4e8e1.19\uff0c\u53ef\u4ee5\u4f7f\u7528networking.k8s.io/v1beta1\u66ff\u4ee3\uff0c\u914d \u7f6e\u53ef\u4ee5\u53c2\u8003\u4e0a\u8ff0\u7684networking.k8s.io/v1beta1\uff0c\u53ea\u6709backend\u914d\u7f6e\u4e0d\u4e00\u6837\u3002</p> <p>v1beta1</p> <pre><code>apiVersion: networking.k8s.io/v1beta1\nkind: Ingress\nmetadata:\n  name: nginx-ingress\n  namespace: study-ingress\nspec:\n  rules:\n  - host: nginx.test.com\n    http:\n      paths:\n      - backend:\n          serviceName: nginx\n          servicePort: 80\n        path: /\n        pathType: ImplementationSpecific\n</code></pre> <p>\u521b\u5efa\u8be5Ingress\uff1a</p> <pre><code># kubectl create -f web-ingress.yaml\n</code></pre> <p>\u521b\u5efa\u7684Ingress\u7ed1\u5b9a\u7684\u57df\u540d\u4e3anginx.test.com\uff0c\u7531\u4e8e\u672c\u4e66\u7684IngressController\u662f\u4ee5hostNetwork\u6a21\u5f0f\u90e8\u7f72\u7684\uff0c\u56e0\u6b64\u5c06\u57df \u540d\u89e3\u6790\u81f3Ingress Controller\u6240\u5728\u7684\u8282\u70b9\u5373\u53ef\u3002(\u4fee\u6539hosts\u6587\u4ef6\uff0c\u6216\u8005DNS\u6307\u5411)</p> <p>\u5982\u679cIngress Controller\u4e0a\u5c42\u8fd8\u6709\u4e00\u5c42\u7f51\u5173\uff0c\u89e3\u6790\u81f3\u7f51\u5173IP\u5373\u53ef\u3002\u63a5\u4e0b\u6765\u901a\u8fc7\u57df\u540dnginx.test.com\u5373\u53ef\u8bbf\u95eeWeb\u670d\u52a1\u5668\uff0c\u5982</p> <p>)</p> <p>\u53ef\u4ee5\u770b\u5230\u901a\u8fc7\u4e0a\u8ff0\u7b80\u5355\u7684Ingress\u8d44\u6e90\u5b9a\u4e49\u5c31\u53ef\u4ee5\u5b9e\u73b0\u4ee5\u57df\u540d\u7684\u65b9\u5f0f\u8bbf\u95ee\u670d\u52a1\uff0c\u4e0d\u9700\u8981\u518d\u53bb\u7ef4\u62a4\u590d\u6742\u7684Nginx\u914d\u7f6e\u6587\u4ef6\uff0c\u5927\u5927\u964d\u4f4e\u4e86\u8fd0\u7ef4\u7684\u590d\u6742\u5ea6\u548c\u51fa\u9519\u7684\u9891\u7387\u3002</p> <p>\u63a5\u4e0b\u6765\u901a\u8fc7\u4e00\u4e9b\u5176\u4ed6\u914d\u7f6e\u5b9e\u73b0\u4f01\u4e1a\u5185\u5e38\u7528\u7684\u529f\u80fd\uff0c\u6bd4\u5982\u91cd\u5b9a\u5411\u3001\u524d\u540e\u7aef\u5206\u79bb\u3001\u9519\u8bef\u53cb\u597d\u9875\u9762\u7b49\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#3-ingress-nginx\u57df\u540d\u91cd\u5b9a\u5411redirect","title":"3. Ingress Nginx\u57df\u540d\u91cd\u5b9a\u5411Redirect","text":"<p>\u5f53\u4e00\u4e2a\u670d\u52a1\u9700\u8981\u66f4\u6362\u57df\u540d\u65f6\uff0c\u5e76\u4e0d\u80fd\u5bf9\u5176\u76f4\u63a5\u66f4\u6539\uff0c\u9700\u8981\u4e00\u4e2a\u8fc7\u6e21\u7684\u8fc7\u7a0b\u3002</p> <p>\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u9700\u8981\u5c06\u65e7\u57df\u540d\u7684\u8bbf\u95ee\u8df3\u8f6c\u5230\u65b0\u57df\u540d\uff0c\u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528Redirect\u529f\u80fd\u3002</p> <p>\u5f85\u65e7\u57df\u540d\u65e0\u8bbf\u95ee\u65f6\uff0c\u518d\u505c\u6b62\u65e7\u57df\u540d\u3002\u5728Nginx\u4f5c\u4e3a\u4ee3\u7406\u670d\u52a1\u5668\u65f6\uff0cRedirect\u53ef\u7528\u4e8e\u57df\u540d\u7684\u91cd\u5b9a\u5411\uff0c\u6bd4\u5982\u8bbf\u95eeold.com\u88ab\u91cd\u5b9a\u5411\u5230new.com\u3002</p> <p>Ingress\u53ef\u4ee5\u66f4\u7b80\u5355\u5730\u5b9e\u73b0Redirect\u529f\u80fd\u3002\u63a5\u4e0b\u6765\u7528nginx.redirect.com\u4f5c\u4e3a\u65e7\u57df\u540d\uff0cbaidu.com\u4f5c\u4e3a\u65b0\u57df\u540d\u8fdb\u884c\u6f14\u793a\uff1a</p> <p>redirect.yaml</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\nannotations:\nnginx.ingress.kubernetes.io/permanent-redirect: https://www.baidu.com\nname: nginx-redirect\nnamespace: study-ingress\nspec:\ningressClassName: nginx\nrules:\n- host: nginx.redirect.com\nhttp:\npaths:\n- backend:\nservice:\nname: nginx\nport:\nnumber: 80\npath: /\npathType: ImplementationSpecific\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u914d\u7f6e\u91cd\u5b9a\u5411\u529f\u80fd\u53ea\u9700\u8981\u586b\u52a0\u4e00\u4e2aannotations\u5373\u53ef\uff0ckey\u4e3anginx.ingress.kubernetes.io/permanent-redirect \uff0c \u503c \u4e3a \u76ee \u6807 URL \uff1ahttps://www.baidu.com\u3002</p> <p>\u63a5\u4e0b\u6765\u540c\u6837\u7684\u65b9\u5f0f\u5c06nginx.redirect.com\u89e3\u6790\u5230Controller\u6240\u5728\u8282\u70b9\uff08\u63a5\u4e0b\u6765\u7684\u793a\u4f8b\u4e0d\u518d\u63d0\u793a\u6dfb\u52a0Host\uff09\uff0c\u5728\u6d4f\u89c8\u5668\u8bbf\u95ee\u6216\u8005\u4f7f\u7528curl\u8bbf\u95ee\uff0c\u5373\u53ef\u770b\u5230\u91cd\u5b9a\u5411\u4fe1\u606f\u3002</p> <p>\u4f7f\u7528curl\u8bbf\u95ee\u57df\u540dnginx.redirect.com\uff0c\u53ef\u4ee5\u770b\u5230301\uff08\u8bf7\u6c42\u88ab\u91cd\u5b9a\u5411\u7684\u8fd4\u56de\u503c\uff09\uff1a</p> <pre><code># curl -I nginx.redirect.com\nHTTP/1.1 301 Moved Permanently\nDate: Fri, 10 Feb 2023 05:39:03 GMT\nContent-Type: text/html\nContent-Length: 162\nConnection: keep-alive\nLocation: https://www.baidu.com\n</code></pre>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#4-ingress-nginx\u524d\u540e\u7aef\u5206\u79bbrewrite","title":"4. Ingress Nginx\u524d\u540e\u7aef\u5206\u79bbRewrite","text":"<p>\u73b0\u5728\u5927\u90e8\u5206\u5e94\u7528\u90fd\u662f\u524d\u540e\u7aef\u5206\u79bb\u7684\u67b6\u6784\uff0c\u4e5f\u5c31\u662f\u524d\u7aef\u7528\u67d0\u4e2a\u57df\u540d\u7684\u6839\u8def\u5f84\u8fdb\u884c\u8bbf\u95ee\uff0c\u540e\u7aef\u63a5\u53e3\u91c7\u7528/api\u8fdb\u884c\u8bbf\u95ee\uff0c\u7528\u6765\u533a\u5206\u524d\u7aef\u548c\u540e\u7aef\u3002</p> <p>\u6216\u8005\u540c\u65f6\u5177\u6709\u5f88\u591a\u4e2a\u540e\u7aef\uff0c\u9700\u8981\u4f7f\u7528/api-a\u5230A\u670d\u52a1\uff0c/api-b\u5230B\u670d\u52a1\uff0c\u4f46\u662f\u7531\u4e8eA\u548cB\u670d\u52a1\u53ef\u80fd\u5e76\u6ca1\u6709/api-a\u548c/api-b\u7684\u8def\u5f84\uff0c\u56e0\u6b64\u9700\u8981\u5c06/api-x\u91cd\u5199\u4e3a\u201c/\u201d\uff0c\u624d \u53ef\u4ee5\u6b63\u5e38\u5230A\u6216\u8005B\u670d\u52a1\uff0c\u5426\u5219\u5c06\u4f1a\u51fa\u73b0404\u7684\u62a5\u9519\u3002</p> <p>\u6b64\u65f6\u53ef\u4ee5\u901a\u8fc7Rewrite\u529f\u80fd\u8fbe\u5230\u8fd9\u79cd\u6548\u679c\uff0c\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u5e94\u7528\u6a21\u62df\u540e\u7aef\u670d\u52a1\uff1a</p> <pre><code># kubectl create deploy backend-api --image=registry.cn-beijing.aliyuncs.com/dotbalo/nginx:backend-api -n study-ingress                   deployment.apps/backend-api created\n</code></pre> <p>\u521b\u5efaService\u66b4\u9732\u8be5\u5e94\u7528\uff1a</p> <pre><code># kubectl expose deploy backend-api --port 80 -n study-ingress\nservice/backend-api exposed\n</code></pre> <p>\u67e5\u770b\u8be5Service\u7684\u5730\u5740\uff0c\u5e76\u4e14\u901a\u8fc7/api-a\u8bbf\u95ee\u6d4b\u8bd5\uff1a</p> <pre><code># kubectl get svc -n study-ingress\nNAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE\nbackend-api   ClusterIP   192.168.27.166   &lt;none&gt;        80/TCP    31s\n\n# curl 192.168.27.166/api-a\n&lt;html&gt;\n&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;\n&lt;hr&gt;&lt;center&gt;nginx/1.15.12&lt;/center&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u76f4\u63a5\u8bbf\u95ee\u6839\u8def\u5f84\u4e5f\u662f\u53ef\u4ee5\u7684\uff1a</p> <pre><code># curl 192.168.27.166\n&lt;h1&gt; backend for ingress rewrite &lt;/h1&gt;\n\n&lt;h2&gt; Path: /api-a &lt;/h2&gt;\n\n&lt;a href=\"http://gaoxin.kubeasy.com\"&gt; Kubeasy &lt;/a&gt;\n</code></pre> <p>\u6240\u4ee5\u6b64\u65f6\u9700\u8981\u901a\u8fc7Ingress Nginx\u7684Rewrite\u529f\u80fd\u5c06/api-a\u91cd\u5199\u4e3a\u201c/\u201d\uff0c\u914d\u7f6e\u793a\u4f8b\u5982\u4e0b\uff1a</p> <p>redirect.yaml</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\nannotations:\nnginx.ingress.kubernetes.io/rewrite-target: /$2\nname: backend-api\nnamespace: study-ingress\nspec:\ningressClassName: nginx\nrules:\n- host: nginx.test.com\nhttp:\npaths:\n- backend:\nservice:\nname: backend-api\nport:\nnumber: 80\npath: /api-a(/|$)(.*)\npathType: ImplementationSpecific\n</code></pre> <pre><code># kubectl apply -f redirect.yaml\n</code></pre> <p>\u9700\u8981\u6dfb\u52a0\u4e00\u4e2akey\u4e3anginx.ingress.kubernetes.io/rewrite-target\u7684annotation\uff0c\u5e76\u4e14value\u662f$2\uff0c\u6b64\u65f6\u8bbf\u95ee/api-a\u5c31\u4f1a\u88ab\u91cd\u5199\u4e3a\u201c/\u201d\uff0c\u8bbf\u95ee/api-a/xxx\u4f1a\u88ab\u91cd\u5199\u4e3a/xxx\u3002</p> <p>\u518d\u6b21\u8bbf\u95eenginx.test.com/api-a\u5373\u53ef\u8bbf\u95ee\u5230\u540e\u7aef\u670d\u52a1\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#5-ingress-nginx\u9519\u8bef\u4ee3\u7801\u91cd\u5b9a\u5411","title":"5. Ingress Nginx\u9519\u8bef\u4ee3\u7801\u91cd\u5b9a\u5411","text":"<p>\u5728\u4e4b\u524d\u7684\u6f14\u793a\u4e2d\uff0c\u5982\u679c\u8bbf\u95ee\u4e00\u4e9b\u4e0d\u5b58\u5728\u7684\u8def\u5f84\u6216\u57df\u540d\uff0c\u5c31\u4f1a\u629b\u51fa404\u7684\u5f02\u5e38\u9875\u9762\u3002</p> <p>\u5bf9\u4e8e\u751f\u4ea7\u73af\u5883\uff0c\u8fd9\u4e2a\u63d0\u793a\u5e76\u4e0d\u53cb\u597d\uff0c\u4f1a\u66b4\u9732Nginx\u7684\u7248\u672c\u53f7\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528Nginx\u7684\u9519\u8bef\u4ee3\u7801\u91cd\u5b9a\u5411\u529f\u80fd\uff0c\u5c06\u67d0\u4e9b\u9519\u8bef\u4ee3\u7801\uff08\u6bd4\u5982404\u3001403\u3001 503\uff09\u91cd\u5b9a\u5411\u5230\u4e00\u4e2a\u56fa\u5b9a\u7684\u9875\u9762\u3002</p> <p>\u672c\u8282\u4e3b\u8981\u6f14\u793a\u5f53\u8bbf\u95ee\u94fe\u63a5\u8fd4\u56de\u503c\u4e3a404\u3001503\u7b49\u9519\u8bef\u65f6\uff0c\u5982\u4f55\u81ea\u52a8\u8df3\u8f6c\u5230\u81ea\u5b9a\u4e49\u7684\u9519\u8bef\u9875\u9762\u3002</p> <p>\u5982\u679c\u8bfb\u8005\u662f\u91c7\u7528Helm\u5b89\u88c5\u7684Ingress Controller \uff0c \u63a8\u8350\u76f4\u63a5\u66f4\u6539values.yaml\uff0c\u4e4b\u540e\u6267\u884chelm upgrade\u5373\u53ef\uff08\u5982\u679c\u662f\u9759\u6001\u6587\u4ef6\u5b89\u88c5\uff0c\u9700\u8981\u66f4\u6539 ingress-nginx \u7684 ConfigMap \u6587 \u4ef6 \uff09 \u3002 \u9996\u5148\u5f00\u542fdefaultBackend \uff0c\u4fee\u6539values.yaml\u3002</p> <p>\u66f4\u65b0values.yaml\u7684ConfigMap\uff1a</p> <pre><code>  config:\napiVersion: v1\nclient_max_body_size: 20m\ncustom-http-errors: \"404,415,503\"\n</code></pre> <p>\u4e4b\u540e\u66f4\u65b0Release\uff1a</p> <pre><code># helm upgrade ingress-nginx ingress-nginx -f ./values-prod.yaml --namespace ingress-nginx  --create-namespace\n</code></pre> <p>\u66f4\u65b0\u540ePod\u4f1a\u81ea\u52a8\u91cd\u542f\uff0c\u5e76\u4e14\u4f1a\u521b\u5efa\u4e00\u4e2adefaultBackend\uff1a</p> <pre><code># kubectl  get pod -n ingress-nginx\nNAME                                           READY   STATUS    RESTARTS   AGE\ningress-nginx-controller-rvgbx                 1/1     Running   0          7h16m\ningress-nginx-defaultbackend-f67985f77-99cxx   1/1     Running   0          7h16m\n</code></pre> <p>\u66f4\u65b0\u5b8c\u6210\u540e\u8bbf\u95ee\u4e00\u4e2a\u4e0d\u5b58\u5728\u7684\u9875\u9762\uff0c\u6bd4\u5982\u4e4b\u524d\u5b9a\u4e49\u7684nginx.test.com\u3002\u8bbf\u95ee\u4e00\u4e2a\u4e0d\u5b58\u5728\u7684\u9875\u9762123\uff0c\u5c31\u4f1a\u8df3\u8f6c\u5230Error Server\u4e2d\u7684\u9875\u9762\uff1a</p> <pre><code># curl nginx.test.com/123\nHTTP/1.1 404 Not Found\n</code></pre>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#6-ingress-nginx-ssl","title":"6. Ingress Nginx SSL","text":"<p>\u751f\u4ea7\u73af\u5883\u5bf9\u5916\u7684\u670d\u52a1\u4e00\u822c\u9700\u8981\u914d\u7f6eHTTPS\u534f\u8bae\uff0c\u4f7f\u7528Ingress\u4e5f\u53ef\u4ee5\u975e\u5e38\u65b9\u4fbf\u5730\u6dfb\u52a0HTTPS\u7684\u8bc1\u4e66\u3002</p> <p>\u7531\u4e8e\u662f\u5b66\u4e60\u73af\u5883\uff0c\u5e76\u6ca1\u6709\u6743\u5a01\u8bc1\u4e66\uff0c\u56e0\u6b64\u9700\u8981\u4f7f\u7528OpenSSL\u751f\u6210\u4e00\u4e2a\u6d4b\u8bd5\u8bc1\u4e66\uff08\u5982\u679c\u662f\u751f\u4ea7\u73af\u5883\uff0c\u90a3\u4e48\u8bc1\u4e66\u4e3a\u5728\u7b2c\u4e09\u65b9\u516c\u53f8\u8d2d\u4e70\u7684\u8bc1\u4e66\uff0c\u65e0\u987b\u81ea\u884c\u751f \u6210\uff09\uff1a</p> <pre><code># openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj \"/CN=nginx/O=nginx\"\nGenerating a 2048 bit RSA private key\n..................+++\n...................................+++\nwriting new private key to 'tls.key'\n-----\n</code></pre> <p>\u521b\u5efa <code>secret</code></p> <pre><code># kubectl create secret tls tls-secret --key tls.key --cert tls.crt\nsecret/tls-secret created\n</code></pre> <p>\u4e3aIngress\u6dfb\u52a0TLS\u914d\u7f6e\uff1a</p> <p>ingress-ssl.yaml</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\ncreationTimestamp: null\nname: nginx-ingress\nspec:\ningressClassName: nginx\nrules:\n- host: nginx.test.com\nhttp:\npaths:\n- backend:\nservice:\nname: nginx\nport:\nnumber: 80\npath: /\npathType: ImplementationSpecific\ntls:\n- hosts:\n- nginx.test.com\nsecretName: tls-secret\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230Ingress\u6dfb\u52a0?LS\u914d\u7f6e\u4e5f\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5728spec\u4e0b\u6dfb\u52a0\u4e00\u4e2atls\u5b57\u6bb5\u5373\u53ef\uff1a</p> <ul> <li>hosts\uff1a\u8bc1\u4e66\u6240\u6388\u6743\u7684\u57df\u540d\u5217\u8868\u3002</li> <li>secretName\uff1a\u8bc1\u4e66\u7684Secret\u540d\u5b57\u3002</li> </ul> <p>\u63a5\u4e0b\u6765\u66f4\u65b0\u8be5Ingress\uff1a</p> <pre><code># kubectl apply -f ingress-ssl.yaml\ningress.networking.k8s.io/nginx-ingress created\n</code></pre> <p>\u4f7f\u7528curl\u8fdb\u884c\u6d4b\u8bd5\uff0c\u57df\u540d\u5df2\u7ecf\u88ab\u91cd\u5b9a\u5411\u5230H??PS\uff1a</p> <pre><code># curl -I nginx.test.com\nHTTP/1.1 308 Permanent Redirect\nDate: Fri, 10 Feb 2023 11:12:58 GMT\nContent-Type: text/html\nContent-Length: 164\nConnection: keep-alive\nLocation: https://nginx.test.com\n</code></pre> <p>\u4f7f\u7528\u6d4f\u89c8\u5668\u8bbf\u95ee\u4f1a\u81ea\u52a8\u8df3\u8f6c\u5230HTTPS\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#7-ingress-nginx\u5339\u914d\u8bf7\u6c42\u5934","title":"7. Ingress Nginx\u5339\u914d\u8bf7\u6c42\u5934","text":"<p>\u5f00\u53d1\u4e00\u4e2a\u7f51\u9875\u6216\u8005\u5e94\u7528\u65f6\uff0c\u5f80\u5f80\u4f1a\u9002\u914d\u8ba1\u7b97\u673a\u7aef\u548c\u624b\u673a\u7aef\uff0c\u901a\u5e38\u4f1a\u5c06\u79fb\u52a8\u5ba2\u6237\u7aef\u8bbf\u95ee\u7684\u9875\u9762\u91cd\u5b9a\u5411\u5230\u79fb\u52a8\u7aef\u7684\u670d\u52a1\u4e0a\uff0c\u8bfb\u8005\u4e5f\u6709\u53ef\u80fd\u7ecf\u5e38\u89c1\u5230 m.xxx.com\u6b64\u7c7b\u7684\u57df\u540d\uff0c\u57fa\u672c\u90fd\u5c5e\u4e8e\u79fb\u52a8\u7aef\u670d\u52a1\u3002</p> <p>Nginx\u53ef\u4ee5\u901a\u8fc7\u4e00\u4e2a\u8bf7\u6c42\u7684\u8bf7\u6c42\u5934\u5224\u65ad\u5ba2\u6237\u7aef\u6765\u6e90\uff0c\u5e76\u5c06\u5176\u8def\u7531\u5230\u6307\u5b9a\u7684\u670d\u52a1\u4e0a\u3002</p> <p>\u672c\u8282\u5c06\u6f14\u793a\u628a\u6765\u81ea\u79fb\u52a8\u7aef\u7684\u8bbf\u95ee\u91cd\u5b9a\u5411\u5230\u79fb\u52a8\u7aef\u670d\u52a1\uff0c\u8ba1\u7b97\u673a\u7aef\u8bbf\u95ee\u4fdd\u6301\u9ed8\u8ba4\u5373\u53ef\u3002</p> <p>\u9996\u5148\u90e8\u7f72\u79fb\u52a8\u7aef\u5e94\u7528\uff1a</p> <pre><code># kubectl create deploy phone --image=registry.cn-beijing.aliyuncs.com/dotbalo/nginx:phone -n study-ingress\ndeployment.apps/phone created\n# kubectl expose deploy phone --port 80 -n study-ingress\nservice/phone exposed\n</code></pre> <p>Ingress\u5b9e\u4f8b\u4e5f\u53ef\u4ee5\u901a\u8fc7kubectl create\u521b\u5efa\uff0c\u53ea\u9700\u8981\u4e00\u6761\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code># kubectl create ingress phone --class=nginx  --rule=m.test.com/*=phone:80 -n study-ingress\ningress.networking.k8s.io/phone created\n</code></pre> <p>\u90e8\u7f72\u8ba1\u7b97\u673a\u7aef\u5e94\u7528\uff1a</p> <pre><code># kubectl create deploy laptop --image=registry.cn-beijing.aliyuncs.com/dotbalo/nginx:laptop -n study-ingress\ndeployment.apps/laptop created\n# kubectl expose deploy laptop --port 80 -n study-ingress\nservice/laptop exposed\n\n# kubectl  get pod -n study-ingress -l app=laptop\nNAME                      READY   STATUS    RESTARTS   AGE\nlaptop-684698ddb4-csv6z   1/1     Running   0          78s\n</code></pre> <p>\u4e4b \u540e \u521b \u5efa \u8ba1 \u7b97 \u673a \u7aef \u7684 Ingress \uff0c \u6ce8 \u610f Ingress annotations \u7684nginx.ingress.kubernetes.io/server-snippet\u914d\u7f6e\u3002Snippet\u914d\u7f6e\u4e13\u95e8\u7528\u4e8e\u4e00\u4e9b\u590d\u6742\u7684Nginx\u914d\u7f6e\uff0c\u548cNginx\u914d\u7f6e\u901a\u7528\u3002</p> <p>\u5339\u914d\u79fb\u52a8\u7aef\u5b9e\u4f8b\u5982\u4e0b\uff1a</p> <p>vim laptop-ingress.yaml</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\nannotations:\nnginx.ingress.kubernetes.io/server-snippet: |\nset $agentflag 0;\nif ($http_user_agent ~* \"(Android|iPhone|Windows Phone|UC|Kindle)\" ){\nset $agentflag 1;\n}\nif ( $agentflag = 1 ) {\nreturn 301 http://m.test.com;\n}\nname: laptop\nnamespace: study-ingress\nspec:\ningressClassName: nginx\nrules:\n- host: test.com\nhttp:\npaths:\n- backend:\nservice:\nname: laptop\nport:\nnumber: 80\npath: /\npathType: ImplementationSpecific\n</code></pre> <pre><code># kubectl apply -f laptop-ingress.yaml\ningress.networking.k8s.io/laptop created\n</code></pre> <p>\u9996\u5148\u901a\u8fc7\u6d4f\u89c8\u5668\u8bbf\u95eetest.com\uff0c\u53ef\u4ee5\u770b\u5230\u9875\u9762\u662fLaptop\uff0c\u5982\u56fe16.7\u6240\u793a\u3002</p> <p>) \u56fe16.7\u3000\u8bbf\u95ee\u8ba1\u7b97\u673a\u7aef</p> <p>\u63a5\u4e0b\u6765\u4f7f\u7528\u6d4f\u89c8\u5668\u7684\u5f00\u53d1\u8005\u5de5\u5177\u5c06\u7ec8\u7aef\u7c7b\u578b\u6539\u4e3aiPhone\uff0c\u6216\u8005\u76f4\u63a5\u7528iPhone\u624b\u673a\u8bbf\u95ee\uff08\u7ebf\u4e0a\u4e1a\u52a1\u4e00\u822c\u914d\u7f6e\u7684\u90fd\u6709DNS\uff0c\u53ef\u4ee5\u76f4\u63a5\u89e3\u6790\u57df\u540d\uff0c\u6d4b\u8bd5\u73af\u5883\u53ef\u80fd\u9700\u8981\u81ea\u5df1\u5355\u72ec\u914d\u7f6e\uff09\uff0c\u5982\u56fe16.8\u6240\u793a\u3002</p> <p>)</p> <p>\u5237\u65b0\u9875\u9762\u4f1a\u81ea\u52a8\u8df3\u8f6c\u81f3m.test.com\uff0c\u5982\u56fe16.9\u6240\u793a\u3002 )</p> <p>\u56fe16.9\u3000\u624b\u673a\u7aef\u9875\u9762</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#8-ingress-nginx\u57fa\u672c\u8ba4\u8bc1","title":"8. Ingress Nginx\u57fa\u672c\u8ba4\u8bc1","text":"<p>\u6709\u4e9b\u7f51\u7ad9\u53ef\u80fd\u9700\u8981\u901a\u8fc7\u5bc6\u7801\u6765\u8bbf\u95ee\uff0c\u5bf9\u4e8e\u8fd9\u7c7b\u7f51\u7ad9\u53ef\u4ee5\u4f7f\u7528Nginx\u7684basic-auth\u8bbe\u7f6e\u5bc6\u7801\u8bbf\u95ee\uff0c\u5177\u4f53\u65b9\u6cd5\u5982\u4e0b\uff0c\u7531\u4e8e\u9700\u8981\u4f7f\u7528htpasswd\u5de5\u5177\uff0c\u56e0 \u6b64\u9700\u8981\u5b89\u88c5httpd\uff1a</p> <pre><code># yum install httpd -y\n</code></pre> <p>\u4f7f\u7528htpasswd\u521b\u5efafoo\u7528\u6237\u7684\u5bc6\u7801\uff1a</p> <pre><code># htpasswd -c auth foo\nNew password:\nRe-type new password:\nAdding password for user foo\n\n# cat auth\nfoo:$apr1$drc3/UbL$TjUp.ZEVK3q6ImJVT/ZYy0\n</code></pre> <p>\u57fa\u4e8e\u4e4b\u524d\u521b\u5efa\u7684\u5bc6\u7801\u6587\u4ef6\u521b\u5efaSecret\uff1a</p> <pre><code># kubectl create secret generic basic-auth --from-file=auth -n study-ingress\nsecret/basic-auth created\n</code></pre> <p>\u521b\u5efa\u5305\u542b\u5bc6\u7801\u8ba4\u8bc1\u7684Ingress\uff1a</p> <p>ingress-with-auth.yaml</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\nannotations:\nnginx.ingress.kubernetes.io/auth-realm: Please Input Your Username and Password\nnginx.ingress.kubernetes.io/auth-secret: basic-auth\nnginx.ingress.kubernetes.io/auth-type: basic\nname: ingress-with-auth\nnamespace: study-ingress\nspec:\ningressClassName: nginx\nrules:\n- host: auth.test.com\nhttp:\npaths:\n- backend:\nservice:\nname: nginx\nport:\nnumber: 80\npath: /\npathType: ImplementationSpecific </code></pre> <ul> <li>nginx.ingress.kubernetes.io/auth-type \uff1a \u8ba4\u8bc1\u7c7b\u578b,\u53ef\u4ee5\u662fbasic\u548cdigest\u3002</li> <li>nginx.ingress.kubernetes.io/auth-secret\uff1a\u5bc6\u7801\u6587\u4ef6\u7684Secret\u540d\u79f0\u3002</li> <li>nginx.ingress.kubernetes.io/auth-realm\uff1a\u9700\u8981\u5bc6\u7801\u8ba4\u8bc1\u7684\u6d88\u606f\u63d0\u9192\u3002</li> </ul> <p>\u521b\u5efa\u8be5Ingress\uff0c\u5e76\u8bbf\u95ee\u6d4b\u8bd5\uff0c\u5982\u56fe16.10\u6240\u793a\u3002</p> <pre><code># kubectl create deploy nginx --image=registry.cn-beijing.aliyuncs.com/dotbalo/nginx:1.15.12 -n study-ingress\ndeployment.apps/nginx created\n\n# kubectl expose deploy nginx --port 80 -n study-ingress\nservice/nginx exposed\n\n# kubectl apply -f ingress-with-auth.yaml\ningress.networking.k8s.io/ingress-with-auth created\n</code></pre> <p>\u521b\u5efa\u8be5Ingress\uff0c\u5e76\u8bbf\u95ee\u6d4b\u8bd5\uff0c\u5982\u56fe16.10\u6240\u793a\u3002 ) \u56fe16.10\u3000\u914d\u7f6e\u8d26\u53f7\u548c\u5bc6\u7801</p> <p>\u8f93\u5165\u5bc6\u7801\u540e\u5373\u53ef\u8fdb\u5165\u9875\u9762\uff0c\u5728\u6b64\u4e0d\u518d\u6f14\u793a\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#9-ingress-nginx\u9ed1\u767d\u540d\u5355","title":"9. Ingress Nginx\u9ed1/\u767d\u540d\u5355","text":"<p>\u6709\u4e9b\u7f51\u9875\u53ef\u80fd\u53ea\u9700\u8981\u6307\u5b9a\u7528\u6237\u8bbf\u95ee\uff0c\u6bd4\u5982\u516c\u53f8\u7684ERP\u53ea\u80fd\u516c\u53f8\u5185\u90e8\u8bbf\u95ee\uff0c\u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528\u767d\u540d\u5355\u9650\u5236\u8bbf\u95ee\u7684IP\u3002</p> <p>\u6709\u4e9b\u7f51\u9875\u4e0d\u5141\u8bb8\u67d0\u4e9bIP\u8bbf\u95ee\uff0c\u6bd4\u5982\u4e00\u4e9b\u6709\u5f02\u5e38\u6d41\u91cf\u7684IP\uff0c\u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528\u9ed1\u540d\u5355\u7981\u6b62\u8be5IP\u8bbf\u95ee\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#91-\u914d\u7f6e\u9ed1\u540d\u5355","title":"9.1 \u914d\u7f6e\u9ed1\u540d\u5355","text":"<p>\u914d\u7f6e\u9ed1\u540d\u5355\u7981\u6b62\u67d0\u4e00\u4e2a\u6216\u67d0\u4e00\u6bb5IP\uff0c\u9700\u8981\u5728Nginx Ingress\u7684ConfigMap\u4e2d\u914d\u7f6e\uff0c\u6bd4\u5982\u5c06192.168.10.130\uff08\u591a\u4e2a\u914d\u7f6e\u4f7f\u7528\u9017\u53f7\u5206\u9694\uff09\u6dfb\u52a0\u81f3\u9ed1\u540d\u5355\uff1a</p> <p>vim values-prod.yaml</p> <pre><code>controller:\nname: controller\nimage:\nrepository: cnych/ingress-nginx\ntag: \"v1.1.0\"\ndigest:\ndnsPolicy: ClusterFirstWithHostNet\nconfig:\nblock-cidrs: 192.168.1.190\napiVersion: v1\nclient_max_body_size: 20m\ncustom-http-errors: \"404,415,503\"\n.......\n</code></pre> <p>\u6eda\u52a8\u66f4\u65b0Nginx Ingress\uff1a</p> <pre><code># helm upgrade ingress-nginx ingress-nginx -f ./values-prod.yaml --namespace ingress-nginx\n</code></pre> <p>\u4f7f\u7528192.168.1.190\u4e3b\u673a\u518d\u6b21\u8bbf\u95ee\uff0c\u53d1\u73b0\u8be5IP\u5df2\u7ecf\u88ab\u7981\u6b62\uff1a</p> <pre><code># # curl -I auth.test.com\nHTTP/1.1 403 Forbidden\nDate: Mon, 13 Feb 2023 07:18:48 GMT\nContent-Type: text/html\nContent-Length: 146\nConnection: keep-alive\n</code></pre>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#92-\u914d\u7f6e\u767d\u540d\u5355","title":"9.2 \u914d\u7f6e\u767d\u540d\u5355","text":"<p>\u767d\u540d\u5355\u8868\u793a\u53ea\u5141\u8bb8\u67d0\u4e2aIP\u8bbf\u95ee\uff0c\u76f4\u63a5\u5728YAML\u6587\u4ef6\u4e2d\u914d\u7f6e\u5373\u53ef\uff08\u4e5f\u53ef\u4ee5\u901a\u8fc7ConfigMap\u914d\u7f6e\uff09\uff0c\u6bd4\u5982\u53ea\u5141\u8bb8192.168.10.128\u8bbf\u95ee\uff0c\u53ea\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a nginx.ingress.kubernetes.io/whitelist-source-range\u6ce8\u91ca\u5373\u53ef\uff1a</p> <p>\u7f51\u6bb5\u548c\u591a\u4e2aIP\u8bbe\u7f6e\u767d\u540d\u5355</p> <pre><code>nginx.ingress.kubernetes.io/whitelist-source-range: 192.168.1.0/24,192.168.2.8\n</code></pre> <p>vim auth-whitelist.yaml</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\nannotations:\nnginx.ingress.kubernetes.io/auth-realm: Please Input Your Username and Password\nnginx.ingress.kubernetes.io/auth-secret: basic-auth\nnginx.ingress.kubernetes.io/auth-type: basic\nnginx.ingress.kubernetes.io/whitelist-source-range: 192.168.1.190\nname: ingress-with-auth\nnamespace: study-ingress\nspec:\ningressClassName: nginx\nrules:\n- host: auth.test.com\nhttp:\npaths:\n- backend:\nservice:\nname: nginx\nport:\nnumber: 80\npath: /\npathType: ImplementationSpecific </code></pre> <p>\u66f4\u65b0\u8be5Ingress\uff1a</p> <pre><code># kubectl apply -f auth-whitelist.yaml\ningress.networking.k8s.io/ingress-with-auth configured\n</code></pre> <p>\u6b64\u65f6192.168.1.190\u4e3b\u673a\u662f\u53ef\u4ee5\u8bbf\u95ee\u7684\uff1a</p> <pre><code># curl auth.test.com -I\nHTTP/1.1 401 Unauthorized\nDate: Mon, 13 Feb 2023 07:48:26 GMT\nContent-Type: text/html\nContent-Length: 172\nConnection: keep-alive\nWWW-Authenticate: Basic realm=\"Please Input Your Username and Password\"\n</code></pre> <p>\u5176\u4ed6IP\u8bbf\u95ee\u88ab\u7981\u6b62\uff1a</p> <pre><code># curl -I auth.test.com\nHTTP/1.1 403 Forbidden\nDate: Mon, 13 Feb 2023 07:49:31 GMT\nContent-Type: text/html\nContent-Length: 146\nConnection: keep-alive\n</code></pre>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#10-ingress-nginx\u901f\u7387\u9650\u5236","title":"10. Ingress Nginx\u901f\u7387\u9650\u5236","text":"<p>\u6709\u65f6\u5019\u53ef\u80fd\u9700\u8981\u9650\u5236\u901f\u7387\u4ee5\u964d\u4f4e\u540e\u7aef\u538b\u529b\uff0c\u6216\u8005\u9650\u5236\u5355\u4e2aIP\u6bcf\u79d2\u7684\u8bbf\u95ee\u901f\u7387\u9632\u6b62\u653b\u51fb\uff0c\u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528Nginx\u7684rate limit\u8fdb\u884c\u914d\u7f6e\u3002</p> <p>\u9996\u5148\u6ca1\u6709\u52a0\u901f\u7387\u9650\u5236\uff0c\u4f7f\u7528ab\u8fdb\u884c\u8bbf\u95ee\uff0cFailed\u4e3a0\uff1a</p> <pre><code># yum -y install httpd-tools\n# ab -c 10 -n 100 http://auth.test.com/ | grep requests\nComplete requests:      100\nFailed requests:        0\nTime per request:       0.579 [ms] (mean, across all concurrent requests)\nPercentage of the requests served within a certain time (ms)\n</code></pre> <p>\u6dfb\u52a0\u901f\u7387\u9650\u5236\uff0c\u9650\u5236\u53ea\u80fd\u6709\u4e00\u4e2a\u8fde\u63a5\uff0c \u53ea\u9700\u8981\u6dfb\u52a0nginx.ingress.kubernetes.io/limit-connections\u4e3a1\u5373\u53ef\uff1a</p> <p>\u200b     vim auth-rate-limit.yaml </p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\nannotations:\nnginx.ingress.kubernetes.io/auth-realm: Please Input Your Username and Password\nnginx.ingress.kubernetes.io/auth-secret: basic-auth\nnginx.ingress.kubernetes.io/auth-type: basic\nnginx.ingress.kubernetes.io/limit-connections: \"1\"\nname: ingress-with-auth\nnamespace: study-ingress\nspec:\ningressClassName: nginx\nrules:\n- host: auth.test.com\nhttp:\npaths:\n- backend:\nservice:\nname: nginx\nport:\nnumber: 80\npath: /\npathType: ImplementationSpecific\n</code></pre> <pre><code># kubectl apply -f auth-rate-limit.yaml\ningress.networking.k8s.io/ingress-with-auth created\n</code></pre> <p>\u518d\u6b21\u4f7f\u7528ab\u6d4b\u8bd5\uff0cFailed\u4e3a32\uff1a</p> <pre><code># ab -c 10 -n 100 http://auth.test.com/ | grep requests\nComplete requests:      100\nFailed requests:        32\nTime per request:       0.511 [ms] (mean, across all concurrent requests)\nPercentage of the requests served within a certain time (ms)\n</code></pre> <p>\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u65b9\u9762\u7684\u9650\u5236\uff0c\u5e38\u7528\u7684\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>#\u9650\u5236\u6bcf\u79d2\u7684\u8fde\u63a5\uff0c\u5355\u4e2aIP\nnginx.ingress.kubernetes.io/limit-rps\nnginx.ingress.kubernetes.io/limit-rps: '100'\n\n#\u9650\u5236\u6bcf\u5206\u949f\u7684\u8fde\u63a5\uff0c\u5355\u4e2aIP\nnginx.ingress.kubernetes.io/limit-rpm\n\n#\u9650\u5236\u5ba2\u6237\u7aef\u6bcf\u79d2\u4f20\u8f93\u7684\u5b57\u8282\u6570\uff0c\u5355\u4f4d\u4e3aKB\uff0c\u9700\u8981\u5f00\u542fproxy-buffering\nnginx.ingress.kubernetes.io/limit-rate\n\n# \u901f\u7387\u9650\u5236\u767d\u540d\u5355\nnginx.ingress.kubernetes.io/limit-whitelist\n</code></pre> <p>\u6bd4\u5982\u5982\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>apiVersion: networking.k8s.io/v1beta1\nkind: Ingress\nmetadata:\nname: ingress-nginx\nannotations:\nkubernetes.io/ingress.class: \"nginx\"\nnginx.ingress.kubernetes.io/limit-rate: \"100K\"\nnginx.ingress.kubernetes.io/limit-whitelist: \"10.1.10.100\"\nnginx.ingress.kubernetes.io/limit-rps: \"1\"\nnginx.ingress.kubernetes.io/limit-rpm: \"30\"\nspec:\nrules:\n- host: iphone.coolops.cn http:\npaths:\n- path: backend:\nserviceName: ng-svc\nservicePort: 80\n</code></pre> <p>\u5176\u4e2d\uff1a</p> <ul> <li>nginx.ingress.kubernetes.io/limit-rate\uff1a\u9650\u5236\u5ba2\u6237\u7aef\u6bcf\u79d2\u4f20\u8f93\u7684\u5b57\u8282\u6570</li> <li>nginx.ingress.kubernetes.io/limit-whitelist\uff1a\u767d\u540d\u5355\u4e2d\u7684IP\u4e0d\u9650\u901f</li> <li>nginx.ingress.kubernetes.io/limit-rps\uff1a\u5355\u4e2aIP\u6bcf\u79d2\u7684\u8fde\u63a5\u6570</li> <li>nginx.ingress.kubernetes.io/limit-rpm\uff1a\u5355\u4e2aIP\u6bcf\u5206\u949f\u7684\u8fde\u63a5\u6570</li> </ul> <p>\u66f4\u591a\u8bf7\u70b9 \u8fd9\u91cc\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#11-ingress-nginx\u8de8\u57df\u914d\u7f6e","title":"11. Ingress Nginx\u8de8\u57df\u914d\u7f6e","text":"<pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\nannotations:\nnginx.ingress.kubernetes.io/cors-allow-headers: &gt;-\nDNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization\nnginx.ingress.kubernetes.io/cors-allow-methods: 'PUT, GET, POST, OPTIONS'\nnginx.ingress.kubernetes.io/cors-allow-origin: '*'\nnginx.ingress.kubernetes.io/enable-cors: 'true'\nnginx.ingress.kubernetes.io/service-weight: ''\ncreationTimestamp: '2019-06-27T12:36:08Z'\ngeneration: 1\nname: hs-http\nnamespace: default\nresourceVersion: '81912785'\nselfLink: /apis/extensions/v1beta1/namespaces/default/ingresses/hs-http\nuid: 2343101d-98d8-11e9-8792-7a7bebcd6704\nspec:\nrules:\n- host: hs.k8s.test.com\nhttp:\npaths:\n- backend:\nserviceName: custom-hs\nservicePort: 80\npath: /\ntls:\n- hosts:\n- hs.k8s.test.com\nsecretName: hs-secret0\nstatus:\nloadBalancer:\ningress:\n- ip: 1.2.3.4\n</code></pre> <p>\u5c06\u8fd9\u4e2a\u914d\u7f6e\u6dfb\u52a0\u5230Ingress\u7684\u6ce8\u89e3\u4e2d\u5373\u53ef\uff0c</p> <p>\u8be6\u89c1</p> <p>https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#enable-cors</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#12-\u4f7f\u7528nginx\u5b9e\u73b0\u7070\u5ea6\u91d1\u4e1d\u96c0\u53d1\u5e03","title":"12. \u4f7f\u7528Nginx\u5b9e\u73b0\u7070\u5ea6/\u91d1\u4e1d\u96c0\u53d1\u5e03","text":"<p>Nginx\u53ef\u4ee5\u5b9e\u73b0\u4e00\u4e9b\u7b80\u5355\u7684\u7070\u5ea6\u3001\u84dd\u7eff\u53d1\u5e03\uff0c\u5f53\u67d0\u4e2a\u670d\u52a1\u9700\u8981\u5728\u4e0a\u7ebf\u4e4b\u524d\u8fdb\u884c\u4e00\u4e9b\u903b\u8f91\u6d4b\u8bd5\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u6b64\u529f\u80fd\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#121-\u521b\u5efav1\u7248\u672c","title":"12.1 \u521b\u5efav1\u7248\u672c","text":"<p>\u5047\u8bbe\u6211\u4eec\u6709\u4e24\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u4e00\u4e2a\u662f\u6b63\u5728\u4f7f\u7528\u7684\u751f\u4ea7\u73af\u5883Production\uff0c\u53e6\u4e00\u4e2a\u662f\u7528\u4e8e\u7070\u5ea6\u6d4b\u8bd5\u7684Canary\u3002</p> <p>\u5728\u53d1\u5e03\u5e94\u7528\u65f6\uff0c\u53ef\u4ee5\u5c06\u5e94\u7528\u5148\u53d1\u5e03\u81f3Canary\uff0c\u7136\u540e\u5207\u4e00\u90e8\u5206\u6d41\u91cf\u5230Canary\uff0c\u4e4b\u540e\u6162\u6162\u5c06\u6d41\u91cf\u5168\u90e8\u5207\u6362\u5230\u4e0a\u9762\u5373\u53ef\u3002</p> <p>\u9996\u5148\u521b\u5efa\u6a21\u62df\u751f\u4ea7\uff08Production\uff09\u73af\u5883\u7684\u547d\u540d\u7a7a\u95f4\u548c\u670d\u52a1\uff1a</p> <pre><code># kubectl create ns production\nnamespace/production created\n\n# kubectl create deploy canary-v1 --image=registry.cn-beijing.aliyuncs.com/dotbalo/canary:v1 -n production\ndeployment.apps/canary-v1 created\n\n# kubectl expose deploy canary-v1 --port 8080 -n production\nservice/canary-v1 exposed\n\n# kubectl create ingress canary-v1 --class=nginx  --rule=canary.com/*=canary-v1:8080 -n production\ningress.networking.k8s.io/canary-v1 created\n\n# k get ingress -n production\nNAME        CLASS   HOSTS        ADDRESS   PORTS   AGE\ncanary-v1   nginx   canary.com             80      22s\n</code></pre> <p>\u4f7f\u7528\u6d4f\u89c8\u5668\u8bbf\u95ee\u8be5\u670d\u52a1\uff0c\u53ef\u4ee5\u770b\u5230Canary v1\u7684\u9875\u9762\uff0c\u5982\u56fe16.11\u6240\u793a\u3002</p> <p>) \u56fe16.11\u3000\u8bbf\u95ee\u7070\u5ea6v1\u7248\u672c</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#122-\u521b\u5efav2\u7248\u672c","title":"12.2 \u521b\u5efav2\u7248\u672c","text":"<p>\u63a5\u4e0b\u6765\u521b\u5efav2\u7248\u672c\uff0c\u5145\u5f53\u7070\u5ea6\u73af\u5883</p> <pre><code># kubectl create ns canary\nnamespace/canary created\n</code></pre> <p>\u521b\u5efav2\u7248\u672c\u7684\u5e94\u7528\u548cService\uff1a</p> <pre><code># kubectl create deploy canary-v2 --image=registry.cn-beijing.aliyuncs.com/dotbalo/canary:v2 -n canary\ndeployment.apps/canary-v2 created\n\n# kubectl expose deploy canary-v2 --port 8080 -n canary\nservice/canary-v2 exposed\n\n# kubectl create ingress canary-v1 --class=nginx  --rule=canary.com/*=canary-v1:8080 -n production\ningress.networking.k8s.io/canary-v1 created\n</code></pre> <p>\u5f85\u7a0b\u5e8f\u542f\u52a8\u5b8c\u6210\u540e\uff0c\u901a\u8fc7Service\u8bbf\u95ee\u8be5\u670d\u52a1\uff0c\u4f1a\u8fd4\u56deCanary v2\uff1a</p> <pre><code># kubectl get svc -n canary\nNAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\ncanary-v2   ClusterIP   192.168.87.20   &lt;none&gt;        8080/TCP   34s\n\n# curl 192.168.87.20:8080\n&lt;h1&gt;Canary v2&lt;/h1&gt;\n</code></pre> <p>\u63a5\u4e0b\u6765\u901a\u8fc7Ingress\u63a7\u5236\u6d41\u91cf\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#123-canary\u7248\u672c\u5207\u5165\u90e8\u5206\u6d41\u91cf","title":"12.3 Canary\u7248\u672c\u5207\u5165\u90e8\u5206\u6d41\u91cf","text":"<p>\u521b\u5efav2\u7248\u672c\u7684Ingress\u65f6,\u9700\u8981\u6dfb\u52a0\u4e24\u4e2a\u6ce8\u91ca\uff1a</p> <ul> <li>nginx.ingress.kubernetes.io/canary\uff0c\u8868\u660e\u662f\u7070\u5ea6\u73af\u5883 \uff1b</li> <li>nginx.ingress.kubernetes.io/canary-weight\uff0c\u8868\u660e\u5206\u914d\u591a\u5c11\u6d41\u91cf\u5230\u8be5\u73af\u5883\uff0c\u672c\u793a\u4f8b\u4e3a10%\uff1a</li> </ul> <p>canary-v2.yaml</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\nannotations:\nnginx.ingress.kubernetes.io/canary: \"true\"\nnginx.ingress.kubernetes.io/canary-weight: \"10\"\nname: canary-v2\nnamespace: canary\nspec:\ningressClassName: nginx\nrules:\n- host: canary.com\nhttp:\npaths:\n- backend:\nservice:\nname: canary-v2\nport:\nnumber: 8080\npath: /\npathType: ImplementationSpecific\n</code></pre> <p>\u6b64\u65f6\u901a\u8fc7nginx.ingress.kubernetes.io/canary-weight: \"10\"\u8bbe\u7f6e\u7684\u6743\u91cd\u662f10\uff0c\u5373v1:v2\u4e3a9:1\u3002</p>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#124-\u6d4b\u8bd5\u7070\u5ea6\u53d1\u5e03","title":"12.4 \u6d4b\u8bd5\u7070\u5ea6\u53d1\u5e03","text":"<p>\u63a5\u4e0b\u6765\u4f7f\u7528shell\u811a\u672c\u8fdb\u884c\u6d4b\u8bd5\uff0c\u6b64\u811a\u672c\u4f1a\u8f93\u51fav1\u548cv2\u7684\u8bbf\u95ee\u6b21\u6570\u6bd4\u503c\uff1a</p> <p>test-canary.sh</p> <pre><code>v1=0;v2=0\nfor i in $(seq 1 100);\ndo\nif $(curl -s \"canary.com\"|grep \"v1\" &gt;/dev/null);then\nv1=$[$v1+1]\nelse\nv2=$[$v2+1]\nfi\ndone\nprintf \"v1:%d  v2:%d\\n\" $v1 $v2\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6bd4\u4f8b\u5dee\u4e0d\u591a\u662f9:1\uff0c\u63a5\u4e0b\u6765\u8bfb\u8005\u53ef\u4ee5\u66f4\u6539\u6743\u91cd\uff0c\u518d\u6b21\u6d4b\u8bd5\uff0c\u5728\u6b64\u4e0d\u518d\u6f14\u793a\u3002</p> <pre><code># bash test-canary.sh\nv1:89  v2:11\n\n# bash test-canary.sh\nv1:91  v2:9\n\n# bash test-canary.sh\nv1:91  v2:9\n</code></pre>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#13--\u73af\u5883\u6e05\u7406","title":"13.  \u73af\u5883\u6e05\u7406","text":"<p>\u6d4b\u8bd5\u65e0\u8bef\u540e\uff0c\u53ef\u4ee5\u6e05\u7406\u4e4b\u524d\u7684\u5b66\u4e60\u6570\u636e\uff1a</p> <pre><code># kubectl delete deploy,svc,ingress -n production --all\n# kubectl delete deploy,svc,ingress -n canary --all\n# kubectl delete deploy,svc,ingress -n study-ingress --all\n# kubectl delete ns study-ingress production canary\n</code></pre>"},{"location":"Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/#14-\u5c0f\u7ed3","title":"14. \u5c0f\u7ed3","text":"<p>\u672c\u7ae0\u8bb2\u89e3\u7684\u662fIngress\u5728\u5b9e\u9645\u5e94\u7528\u65f6\u5e38\u7528\u7684\u6848\u4f8b\uff0c\u5176\u5b9e\u4e0d\u96be\u770b\u51fa\uff0c\u91c7\u7528Ingress\u5145\u5f53\u7f51\u5173\uff0c\u6ca1\u6709\u4e86\u9488\u5bf9Nginx\u3001HAProxy\u7b49\u5de5\u5177\u7684\u914d\u7f6e\u6587\u4ef6\u7684\u5b66\u4e60\u3002</p> <p>\u65e0\u8bba\u4f55\u79cdIngress Controller\u65b9\u6848\uff0c\u5176\u914d\u7f6e\u65b9\u5f0f\u90fd\u662f\u7c7b\u4f3c\u7684\uff0c\u53ea\u9700\u8981\u627e\u5230\u5bf9\u5e94\u63a7\u5236\u5668\u7684\u5b98\u65b9\u6587\u6863\u5373\u53ef\uff0c\u53ef\u80fd\u53ea\u662f\u6ce8\u91ca\uff08IngressClass\u6210\u719f\u540e\uff0c\u53ef\u80fd\u5e76\u4e0d\u518d \u9700\u8981\u6ce8\u91ca\u7684\u65b9\u5f0f\uff09\u7684\u533a\u522b\uff0c\u5bf9\u4e8eIngress\u7684\u914d\u7f6e\u5927\u81f4\u90fd\u662f\u4e00\u6837\u7684\u3002</p> <p>\u76ee\u524d\u6bd4\u8f83\u6d41\u884c\u7684Ingress Controller\u6709ingress-nginx(\u672c\u4e66\u8bb2\u89e3\u7684\uff0c\u7531Kubernetes \u5b98\u65b9\u7ef4\u62a4)\u3001nginx-ingress(\u7531Nginx\u5b98\u65b9\u7ef4\u62a4\uff0c\u6ce8\u610f\u548cingress-nginx\u7684\u533a\u522b)\u3001Traefik\u3001Istio\u7b49\u3002</p> <p>\u5982\u679c\u8bfb\u8005\u4eca\u540e\u9700\u8981\u63a5\u5165Istio\uff0c\u63a8\u8350\u91c7\u7528Istio\u7684ingressgateway\u4f5c\u4e3aIngress\uff08\u5176\u5b9e\u5df2\u7ecf\u4e0d\u80fd\u518d\u79f0\u4e3aIngress\uff0c\u56e0\u4e3aingressgateway\u914d\u7f6e\u65b9\u5f0f\u5e76\u975eIngress\u8d44\u6e90\uff0c\u800c\u662fIstio\u81ea\u5b9a\u4e49\u7684Gateway\u548cVirtualService\u8d44\u6e90\uff09\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/","title":"DevOps\u5b9e\u8df5","text":"<p>\u5728\u4e4b\u524d\u7684\u7ae0\u8282\uff0c\u6211\u4eec\u6240\u4ecb\u7ecd\u7684\u5e94\u7528\u90e8\u7f72\u6216\u8005\u66f4\u65b0\u90fd\u662f\u91c7\u7528\u624b\u5de5\u7684\u65b9\u5f0f\uff0c\u4f46\u5728\u4f01\u4e1a\u5185\u90e8\uff0c\u5e94\u7528\u67b6\u6784\u4e00\u822c\u90fd\u91c7\u7528\u5fae\u670d\u52a1\uff0c\u5927\u90e8\u5206\u9879\u76ee\u90fd\u4f1a\u5bf9\u5e94\u51e0\u5341\u3001\u4e0a \u767e\uff0c\u751a\u81f3\u4e0a\u5343\u4e2a\u5fae\u670d\u52a1\uff0c\u5e76\u4e14\u8fd8\u4e0d\u4ec5\u4ec5\u53ea\u6709\u4e00\u4e2a\u9879\u76ee\uff0c\u6240\u4ee5\u91c7\u7528\u624b\u5de5\u65b9\u5f0f\u4e0a\u7ebf\u662f\u4e0d\u592a\u73b0\u5b9e\u7684\u4e8b\u60c5\uff0c\u7279\u522b\u662f\u968f\u7740\u5e94\u7528\u7684\u589e\u591a\uff0c\u5bf9\u5e94\u7684\u5de5\u4f5c\u91cf\u4e5f\u53d8\u5f97\u4e0d\u53ef\u60f3 \u8c61\u3002</p> <p>\u7531\u4e8e\u4e0a\u7ebf\u7684\u8fc7\u7a0b\u4e00\u822c\u6bd4\u8f83\u56fa\u5b9a\uff0c\u5927\u90fd\u662f\u63d0\u524d\u89c4\u5b9a\u597d\u3001\u6bd4\u8f83\u4e00\u81f4\u7684\u6d41\u7a0b\uff0c\u56e0\u6b64\u91c7\u7528\u5de5\u5177\u6765\u5b8c\u6210\u8fd9\u7c7b\u201c\u6b7b\u677f\u201d\u7684\u5de5\u4f5c\u662f\u6bd4\u8f83\u63a8\u8350\u7684\u65b9\u5f0f\uff0c\u540c\u65f6\u4e5f\u80fd\u51cf\u5c11 \u624b\u5de5\u64cd\u4f5c\u5e26\u6765\u6545\u969c\u7684\u98ce\u9669\u3002</p> <p>\u672c\u7ae0\u4e3b\u8981\u4ecb\u7ecd\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u6301\u7eed\u96c6\u6210\uff08Continuous Integration\uff0cCI\uff09\u4e0e\u6301\u7eed\u90e8\u7f72\uff08Continuous Deployment\uff0cCD\uff09\u7684\u4f7f\u7528--\u5b9e\u73b0Jenkins\u6d41\u6c34\u7ebf \u811a\u672c\u81ea\u52a8\u53d1\u5e03\u5e94\u7528\u5230Kubernetes\u96c6\u7fa4\u4e2d\uff0c\u5f53\u7136CI/CD\u662fDevOps\u4e2d\u975e\u5e38\u91cd\u8981\u7684\u4e00\u4e2a\u73af\u8282\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#1-cicd\u4ecb\u7ecd","title":"1. CI/CD\u4ecb\u7ecd","text":"<p>CI/CD\u662f\u4e00\u79cd\u901a\u8fc7\u5728\u5e94\u7528\u5f00\u53d1\u9636\u6bb5\u5f15\u5165\u81ea\u52a8\u5316\u6765\u9891\u7e41\u5411\u5ba2\u6237\u4ea4\u4ed8\u5e94\u7528\u7684\u65b9\u6cd5\u3002</p> <p>CI/CD\u7684\u6838\u5fc3\u6982\u5ff5\u662f\u6301\u7eed\u96c6\u6210\u3001\u6301\u7eed\u4ea4\u4ed8\uff08Continuous Delivery\uff0cCD\uff09\u548c\u6301\u7eed\u90e8\u7f72\u3002</p> <p>\u4f5c\u4e3a\u4e00\u4e2a\u9762\u5411\u5f00\u53d1\u548c\u8fd0\u8425\u56e2\u961f\u7684\u89e3\u51b3\u65b9\u6848\uff0cCI/CD\u4e3b\u8981\u9488\u5bf9\u5728\u96c6\u6210\u65b0\u4ee3\u7801\u65f6\u6240\u5f15\u53d1\u7684\u95ee\u9898\uff08\u4e5f\u79f0\u201c\u96c6\u6210\u5730\u72f1\u201d\uff09\u3002</p> <p>\u5177\u4f53\u800c\u8a00\uff0cCI/CD\u5728\u6574\u4e2a\u5e94\u7528\u751f\u547d\u5468\u671f\u5185\uff08\u4ece\u96c6\u6210\u548c\u6d4b\u8bd5\u9636\u6bb5\u5230\u4ea4\u4ed8\u548c\u90e8\u7f72\uff09\u5f15\u5165\u4e86\u6301\u7eed\u81ea\u52a8\u5316\u548c\u6301\u7eed\u76d1\u63a7\uff0c\u8fd9\u4e9b\u5173\u8054\u7684\u4e8b\u52a1\u901a\u5e38\u88ab\u79f0\u4e3a\u201cCI/CD\u7ba1 \u9053\u201d\uff0c\u7531\u5f00\u53d1\u548c\u8fd0\u7ef4\u56e2\u961f\u4ee5\u654f\u6377\u65b9\u5f0f\u534f\u540c\u652f\u6301\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#11-\u6301\u7eed\u96c6\u6210ci","title":"1.1 \u6301\u7eed\u96c6\u6210(CI)","text":"<p>\u73b0\u4ee3\u5e94\u7528\u5f00\u53d1\u7684\u76ee\u6807\u662f\u8ba9\u591a\u4f4d\u5f00\u53d1\u4eba\u5458\u540c\u65f6\u5f00\u53d1\u540c\u4e00\u4e2a\u5e94\u7528\u7684\u4e0d\u540c\u529f\u80fd\u3002</p> <p>\u4f46\u662f\uff0c\u5982\u679c\u4f01\u4e1a\u5b89\u6392\u5728\u4e00\u5929\u5185\u5c06\u6240\u6709\u5206\u652f\u6e90\u4ee3\u7801\u5408\u5e76\u5728\u4e00\u8d77\uff0c\u6700\u7ec8\u53ef\u80fd\u5bfc\u81f4\u5de5\u4f5c\u70e6\u7410\u3001\u8017\u65f6\uff0c\u800c\u4e14\u9700\u8981\u624b\u52a8\u5b8c\u6210\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a\u5f53\u4e00\u4f4d\u72ec\u7acb\u5de5\u4f5c\u7684\u5f00\u53d1\u4eba\u5458\u5bf9\u5e94\u7528\u8fdb\u884c\u66f4\u6539\u65f6\uff0c\u6709\u53ef\u80fd\u4f1a\u6709\u5176\u4ed6\u5f00\u53d1\u4eba\u5458\u540c\u65f6\u8fdb\u884c\u66f4\u6539\uff0c\u4ece\u800c\u5f15\u53d1 \u51b2\u7a81\u3002</p> <p>\u6301\u7eed\u96c6\u6210\u53ef\u4ee5\u5e2e\u52a9\u5f00\u53d1\u4eba\u5458\u66f4\u52a0\u9891\u7e41\u5730\u5c06\u4ee3\u7801\u66f4\u6539\u5408\u5e76\u5230\u5171\u4eab\u5206\u652f\u6216\u4e3b\u5e72\u4e2d\u3002\u4e00\u65e6\u5f00\u53d1\u4eba\u5458\u5bf9\u5e94\u7528\u6240\u505a\u7684\u66f4\u6539\u88ab\u5408\u5e76\uff0c\u7cfb\u7edf\u5c31\u4f1a\u901a\u8fc7\u81ea\u52a8\u6784\u5efa\u5e94\u7528 \u5e76\u8fd0\u884c\u4e0d\u540c\u7ea7\u522b\u7684\u81ea\u52a8\u5316\u6d4b\u8bd5\uff08\u901a\u5e38\u662f\u5355\u5143\u6d4b\u8bd5\u548c\u96c6\u6210\u6d4b\u8bd5\uff09\u6765\u9a8c\u8bc1\u8fd9\u4e9b\u66f4\u6539\uff0c\u786e\u4fdd\u66f4\u6539\u6ca1\u6709\u5bf9\u5e94\u7528\u9020\u6210\u7834\u574f\u3002</p> <p>\u8fd9\u610f\u5473\u7740\u6d4b\u8bd5\u5185\u5bb9\u6db5\u76d6\u4e86\u4ece\u7c7b\u548c\u51fd\u6570\u5230\u6784\u6210\u6574\u4e2a\u5e94\u7528\u7684\u4e0d\u540c\u6a21\u5757\uff0c\u5982\u679c\u81ea\u52a8\u5316\u6d4b\u8bd5\u53d1\u73b0\u65b0\u4ee3\u7801\u548c\u73b0\u6709\u4ee3\u7801\u4e4b\u95f4\u6709\u51b2\u7a81\uff0c\u6301\u7eed\u96c6\u6210\u53ef\u4ee5\u66f4\u52a0\u8f7b\u677e\u5feb\u901f\u5730\u4fee\u590d\u8fd9\u4e9b\u9519\u8bef\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#12-\u6301\u7eed\u4ea4\u4ed8cd","title":"1.2 \u6301\u7eed\u4ea4\u4ed8(CD)","text":"<p>\u5b8c\u6210\u6301\u7eed\u96c6\u6210\u4e2d\u6784\u5efa\u5355\u5143\u6d4b\u8bd5\u548c\u96c6\u6210\u6d4b\u8bd5\u7684\u81ea\u52a8\u5316\u6d41\u7a0b\u540e\uff0c\u901a\u8fc7\u6301\u7eed\u4ea4\u4ed8\u53ef\u4ee5\u81ea\u52a8\u5c06\u5df2\u9a8c\u8bc1\u7684\u4ee3\u7801\u53d1\u5e03\u5230\u5b58\u50a8\u5e93\u3002\u4e3a\u4e86\u5b9e\u73b0\u9ad8\u6548\u7684\u6301\u7eed\u4ea4\u4ed8\u6d41\u7a0b\uff0c \u52a1\u5fc5\u8981\u786e\u4fdd\u6301\u7eed\u4ea4\u4ed8\u5df2\u5185\u7f6e\u4e8e\u5f00\u53d1\u7ba1\u9053\u3002</p> <p>\u6301\u7eed\u4ea4\u4ed8\u7684\u76ee\u6807\u662f\u62e5\u6709\u4e00\u4e2a\u53ef\u968f\u65f6\u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\u7684\u4ee3\u7801\u5e93\u3002</p> <p>\u5728\u6301\u7eed\u4ea4\u4ed8\u4e2d\uff0c\u6bcf\u4e2a\u9636\u6bb5\uff08\u4ece\u4ee3\u7801\u66f4\u6539\u7684\u5408\u5e76\u5230\u751f\u4ea7\u5c31\u7eea\u578b\u6784\u5efa\u7248\u672c\u7684\u4ea4\u4ed8\uff09\u90fd\u6d89\u53ca\u6d4b\u8bd5\u81ea\u52a8\u5316\u548c\u4ee3\u7801\u53d1\u5e03\u81ea\u52a8\u5316\u3002\u5728\u6d41\u7a0b\u7ed3\u675f\u65f6\uff0c\u8fd0\u7ef4\u56e2\u961f\u53ef\u4ee5 \u5feb\u901f\u3001\u8f7b\u677e\u5730\u5c06\u5e94\u7528\u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\u4e2d\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#13-\u6301\u7eed\u90e8\u7f72cd","title":"1.3 \u6301\u7eed\u90e8\u7f72(CD)","text":"<p>\u5bf9\u4e8e\u4e00\u4e2a\u6210\u719f\u7684CI/CD\u7ba1\u9053\u6765\u8bf4\uff0c\u6700\u540e\u7684\u9636\u6bb5\u662f\u6301\u7eed\u90e8\u7f72\u3002</p> <p>\u4f5c\u4e3a\u6301\u7eed\u4ea4\u4ed8\uff08\u81ea\u52a8\u5c06\u751f\u4ea7\u5c31\u7eea\u578b\u6784\u5efa\u7248\u672c\u53d1\u5e03\u5230\u4ee3\u7801\u5b58\u50a8\u5e93\uff09\u7684\u5ef6\u4f38\uff0c\u6301\u7eed\u90e8\u7f72\u53ef\u4ee5\u81ea\u52a8\u5c06\u5e94\u7528\u53d1\u5e03\u5230\u751f\u4ea7\u73af\u5883\u4e2d\u3002</p> <p>\u7531\u4e8e\u751f\u4ea7\u4e4b\u524d\u7684\u7ba1\u9053\u9636\u6bb5\u6ca1\u6709\u624b\u52a8\u95e8\u63a7\uff0c\u56e0\u6b64\u6301\u7eed\u90e8\u7f72\u5728\u5f88\u5927\u7a0b\u5ea6\u4e0a\u90fd\u5f97\u4f9d\u8d56\u7cbe\u5fc3\u8bbe\u8ba1\u7684\u6d4b\u8bd5\u81ea\u52a8\u5316\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0c\u6301\u7eed\u90e8\u7f72\u610f\u5473\u7740\u5f00\u53d1\u4eba\u5458\u5bf9\u5e94\u7528\u7684\u66f4\u6539\u5728\u7f16\u5199\u540e\u7684\u51e0\u5206\u949f\u5185\u5c31\u80fd\u751f\u6548\uff0c\u8fd9\u66f4\u52a0\u4fbf\u4e8e\u6301\u7eed\u63a5\u6536\u548c\u6574\u5408\u7528\u6237\u53cd\u9988\u3002</p> <p>\u603b\u800c\u8a00\u4e4b\uff0c\u6240\u6709\u8fd9\u4e9bCI/CD\u7684\u5173\u8054\u6b65\u9aa4\u90fd\u6709\u52a9\u4e8e\u964d\u4f4e\u5e94\u7528\u7684\u90e8\u7f72\u98ce\u9669\uff0c\u56e0\u6b64\u66f4\u4fbf\u4e8e\u4ee5\u5c0f\u4ef6\u7684\u65b9\u5f0f\uff08\u975e\u4e00\u6b21\u6027\uff09\u53d1\u5e03\u5bf9\u5e94\u7528\u7684\u66f4\u6539\u3002</p> <p>\u4e0d\u8fc7\uff0c\u7531\u4e8e\u8fd8\u9700\u8981\u7f16\u5199\u81ea\u52a8\u5316\u6d4b\u8bd5\u4ee5\u9002\u5e94CI/CD\u7ba1\u9053\u4e2d\u7684\u5404\u79cd\u6d4b\u8bd5\u548c\u53d1\u5e03\u9636\u6bb5\uff0c\u56e0\u6b64\u524d\u671f\u6295\u8d44\u4f1a\u5f88\u5927\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#14-ci\u548ccd\u7684\u533a\u522b","title":"1.4 CI\u548cCD\u7684\u533a\u522b","text":"<p>CI/CD\u4e2d\u7684CI\u5373\u6301\u7eed\u96c6\u6210\uff0c\u5b83\u5c5e\u4e8e\u5f00\u53d1\u4eba\u5458\u7684\u81ea\u52a8\u5316\u6d41\u7a0b\u3002</p> <p>\u6210\u529f\u7684CI\u610f\u5473\u7740\u5e94\u7528\u4ee3\u7801\u7684\u6700\u65b0\u66f4\u6539\u4f1a\u5b9a\u671f\u6784\u5efa\u3001\u6d4b\u8bd5\u5e76\u5408\u5e76\u5230\u5171\u4eab\u5b58\u50a8\u4e2d\u3002</p> <p>\u8be5\u89e3\u51b3\u65b9\u6848\u53ef\u4ee5\u89e3\u51b3\u5728\u4e00\u6b21\u5f00\u53d1\u4e2d\u6709\u592a\u591a\u5e94\u7528\u5206\u652f\uff0c\u4ece\u800c\u5bfc\u81f4\u76f8\u4e92\u51b2\u7a81\u7684\u95ee\u9898\u3002</p> <p>CI/CD\u4e2d\u7684CD\u6307\u7684\u662f\u6301\u7eed\u4ea4\u4ed8\u6216\u6301\u7eed\u90e8\u7f72\uff0c\u8fd9\u4e9b\u76f8\u5173\u6982\u5ff5\u6709\u65f6\u4f1a\u4ea4\u53c9\u4f7f\u7528\u3002</p> <p>\u4e24\u8005\u90fd\u4e8b\u5173\u7ba1\u9053\u540e\u7eed\u9636\u6bb5\u7684\u81ea\u52a8\u5316\uff0c\u4f46\u5b83\u4eec\u6709\u65f6\u4e5f\u4f1a\u5355\u72ec\u4f7f\u7528\uff0c\u7528\u4e8e\u8bf4\u660e\u81ea\u52a8\u5316\u7a0b\u5ea6\u3002</p> <p>\u6301\u7eed\u4ea4\u4ed8\u901a\u5e38\u662f\u6307\u5f00\u53d1\u4eba\u5458\u5bf9\u5e94\u7528\u7684\u66f4\u6539\u4f1a\u81ea\u52a8\u8fdb\u884c\u9519\u8bef\u6d4b\u8bd5\u5e76\u4e0a\u4f20\u5230\u5b58\u50a8\u5e93\uff08\u5982GitLab\u6216\u5bb9\u5668\u6ce8\u518c\u8868\uff09\uff0c\u7136\u540e\u7531\u8fd0\u7ef4\u56e2\u961f\u5c06\u5176\u90e8\u7f72\u5230\u5b9e\u65f6\u751f\u4ea7\u73af \u5883\u4e2d\uff0c\u65e8\u5728\u89e3\u51b3\u5f00\u53d1\u548c\u8fd0\u7ef4\u56e2\u961f\u4e4b\u95f4\u53ef\u89c1\u6027\u53ca\u6c9f\u901a\u8f83\u5dee\u7684\u95ee\u9898\uff0c\u56e0\u6b64\u6301\u7eed\u4ea4\u4ed8\u7684\u76ee\u7684\u5c31\u662f\u786e\u4fdd\u5c3d\u53ef\u80fd\u51cf\u5c11\u90e8\u7f72\u65b0\u4ee3\u7801\u65f6\u6240\u9700\u7684\u5de5\u4f5c\u91cf\u3002</p> <p>\u6301\u7eed\u90e8\u7f72\u6307\u7684\u662f\u81ea\u52a8\u5c06\u5f00\u53d1\u4eba\u5458\u7684\u66f4\u6539\u4ece\u4ee3\u7801\u5e93\u53d1\u5e03\u5230\u751f\u4ea7\u73af\u5883\u4e2d\u4ee5\u4f9b\u5ba2\u6237\u4f7f\u7528\uff0c\u5b83\u4e3b\u8981\u4e3a\u89e3\u51b3\u56e0\u624b\u52a8\u6d41\u7a0b\u964d\u4f4e\u5e94\u7528\u4ea4\u4ed8\u901f\u5ea6\uff0c\u4ece\u800c\u4f7f\u8fd0\u7ef4\u56e2\u961f\u8d85 \u8d1f\u8377\u7684\u95ee\u9898\u3002</p> <p>\u6301\u7eed\u90e8\u7f72\u4ee5\u6301\u7eed\u4ea4\u4ed8\u7684\u4f18\u52bf\u4e3a\u6839\u57fa\uff0c\u5b9e\u73b0\u4e86\u7ba1\u9053\u540e\u7eed\u9636\u6bb5\u7684\u81ea\u52a8\u5316\u3002</p> <p>CI/CD\u65e2\u53ef\u80fd\u4ec5\u6307\u6301\u7eed\u96c6\u6210\u548c\u6301\u7eed\u4ea4\u4ed8\u6784\u6210\u7684\u5173\u8054\u73af\u8282\uff0c\u4e5f\u53ef\u4ee5\u6307\u6301\u7eed\u96c6\u6210\u3001\u6301\u7eed\u4ea4\u4ed8\u548c\u6301\u7eed\u90e8\u7f72\u8fd93\u4e2a\u65b9\u9762\u6784\u6210\u7684\u5173\u8054\u73af\u8282\u3002</p> <p>\u66f4\u4e3a\u590d\u6742\u7684\u662f\u6709\u65f6\u6301\u7eed\u4ea4\u4ed8\u4e5f\u5305\u542b\u6301\u7eed\u90e8\u7f72\u6d41\u7a0b\u3002</p> <p>\u7ea0\u7f20\u4e8e\u8fd9\u4e9b\u8bed\u4e49\u5176\u5b9e\u6ca1\u6709\u5fc5\u8981\uff0c\u53ea\u9700\u8bb0\u5f97CI/CD\u5b9e\u9645\u4e0a\u5c31\u662f\u4e00\u4e2a\u6d41\u7a0b\uff08\u901a\u5e38\u8868\u8ff0\u4e3a\u7ba1\u9053\uff09\uff0c\u7528\u4e8e\u5728\u66f4\u5927\u7a0b\u5ea6\u4e0a\u5b9e\u73b0\u5e94\u7528\u5f00\u53d1\u7684\u6301\u7eed\u81ea\u52a8\u5316\u548c\u6301\u7eed\u76d1\u63a7\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#2-jenkins\u6d41\u6c34\u7ebf\u4ecb\u7ecd","title":"2. Jenkins\u6d41\u6c34\u7ebf\u4ecb\u7ecd","text":"<p>\u63d0\u5230CI\u5de5\u5177\uff0c\u9996\u5148\u60f3\u5230\u7684\u5c31\u662f\u201cCI\u754c\u201d\u7684\u5927\u4f6c\u2014\u2014Jenkins\uff0c\u867d\u7136\u5728\u4e91\u539f\u751f\u7206\u53d1\u7684\u5e74\u4ee3\uff0c\u8e66\u51fa\u6765\u4e86\u5f88\u591a\u4e91\u539f\u751f\u7684CI\u5de5\u5177\uff0c\u4f46\u662f\u90fd\u4e0d\u8db3\u4ee5\u64bc\u52a8Jenkins\u7684 \u5730\u4f4d\u3002</p> <p>\u5728\u4f01\u4e1a\u4e2d\u5bf9\u4e8e\u6301\u7eed\u96c6\u6210\u3001\u6301\u7eed\u90e8\u7f72\u7684\u9700\u6c42\u975e\u5e38\u591a\uff0c\u5e76\u4e14\u4e5f\u4f1a\u7ecf\u5e38\u6709\u4e00\u4e9b\u6bd4\u8f83\u590d\u6742\u7684\u9700\u6c42\uff0c\u6b64\u65f6\u65b0\u751f\u7684CI\u5de5\u5177\u4e0d\u8db3\u4ee5\u652f\u6491\u8fd9\u4e9b\u5f88\u590d\u6742\u7684\u9700\u6c42\u3002</p> <p>\u4f46\u662fJenkins\u4e30\u5bcc\u7684\u63d2\u4ef6\u57fa\u672c\u4e0a\u53ef\u4ee5\u6ee1\u8db3\u4efb\u4f55\u573a\u666f\uff0c\u6240\u4ee5\u672c\u4e66\u7684CI/CD\u8fd8\u662f\u56f4\u7ed5Jenkins\u8fdb\u884c\u8bb2\u89e3\u3002</p> <p>\u9650\u4e8e\u7bc7\u5e45\uff0c\u672c\u4e66\u5e76\u4e0d\u6253\u7b97\u4ece\u57fa\u7840\u7684\u6982\u5ff5\u8bb2\u8d77\uff0c\u800c\u662f\u8bb2\u89e3Jenkins\u6700\u4f73\u7684\u4f7f\u7528\u65b9\u5f0f\uff0c\u4e5f\u5c31\u662fJenkins Pipeline\uff08Jenkins\u6d41\u6c34\u7ebf\uff09\u7684\u4f7f\u7528\u3002</p> <p>\u9996\u5148\u4ecb\u7ecd\u6d41\u6c34\u7ebf\u7684\u6982\u5ff5\u548c\u7c7b\u578b\uff0c\u5305\u62ecJenkins\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\uff08Declarative Pipeline\uff09\u548c\u811a\u672c\u5f0f\u6d41\u6c34\u7ebf\uff08Scripted Pipeline\uff09\uff0c\u7136\u540e\u8bb2\u89e3\u6d41\u6c34\u7ebf\u7684\u57fa\u672c\u8bed\u6cd5\u548c\u4e00\u4e9b\u4f8b \u5b50\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#21-\u4ec0\u4e48\u662f\u6d41\u6c34\u7ebf","title":"2.1 \u4ec0\u4e48\u662f\u6d41\u6c34\u7ebf","text":"<p>Jenkins\u6d41\u6c34\u7ebf\u662f\u4e00\u5957\u63d2\u4ef6\uff0c\u5b83\u652f\u6301\u5728Jenkins\u4e2d\u5b9e\u73b0\u548c\u96c6\u6210\u6301\u7eed\u4ea4\u4ed8\u6d41\u6c34\u7ebf\uff08Continuous Delivery Pipeline\uff09\u3002</p> <p>\u6d41\u6c34\u7ebf\u63d0\u4f9b\u4e86\u4e00\u7ec4\u53ef\u6269\u5c55\u7684\u5de5\u5177\uff0c\u7528\u4e8e\u901a\u8fc7Pipeline DSL\u5c06\u7b80\u5355\u5230\u590d\u6742\u7684\u4ea4\u4ed8\u6d41\u6c34\u7ebf\u4ee5\u4ee3\u7801\u7684\u5f62\u52bf\u5c55\u73b0\uff0c\u7c7b\u4f3c\u4e8e\u57fa\u7840\u8bbe\u65bd\u5373\u4ee3\u7801\u3002</p> <p>\u6301\u7eed\u4ea4\u4ed8\u6d41\u6c34\u7ebf\u4f1a\u7ecf\u5386\u4e00\u4e2a\u590d\u6742\u7684\u8fc7\u7a0b\uff1a</p> <p>\u4ece\u7248\u672c\u63a7\u5236\u3001\u5411\u7528\u6237\u548c\u5ba2\u6237\u63d0\u4ea4\u8f6f\u4ef6\u3001\u8f6f\u4ef6\u7684\u6bcf\u6b21\u53d8\u66f4\uff08\u63d0\u4ea4\u4ee3\u7801\u5230\u4ed3\u5e93\uff09\u5230\u8f6f\u4ef6\u53d1\u5e03\uff08Release\uff09\u3002</p> <p>\u8fd9\u4e2a\u8fc7\u7a0b\u5305\u62ec\u4ee5\u4e00\u79cd\u53ef\u9760\u5e76\u53ef\u91cd\u590d\u7684\u65b9\u5f0f\u6784\u5efa\u8f6f\u4ef6\uff0c\u4ee5\u53ca\u901a\u8fc7\u591a\u4e2a\u6d4b\u8bd5\u548c\u90e8\u7f72\u9636\u6bb5\u6765\u5f00\u53d1\u6784\u5efa\u597d\u7684\u8f6f\u4ef6\uff08\u79f0\u4e3aBuild\uff09\u3002</p> <p>Jenkins\u6d41\u6c34\u7ebf\u7684\u5b9a\u4e49\u88ab\u5199\u5728\u4e00\u4e2a\u6587\u672c\u6587\u4ef6\u4e2d\uff08\u4e00\u822c\u4e3aJenkinsfile\uff09\uff0c\u8be5\u6587\u4ef6\u201c\u5b9a\u5236\u201d\u4e86\u6574\u4e2a\u6784\u5efa\u8f6f\u4ef6\u7684\u8fc7\u7a0b\u3002Jenkinsfile\u4e5f\u53ef\u4ee5\u88ab\u63d0\u4ea4\u5230\u9879\u76ee\u7684 \u4ee3\u7801\u4ed3\u5e93\u4e2d\uff0c\u5728Jenkins\u4e2d\u53ef\u4ee5\u76f4\u63a5\u5f15\u7528\u3002\u5c06\u6301\u7eed\u4ea4\u4ed8\u6d41\u6c34\u7ebf\u4f5c\u4e3a\u5e94\u7528\u7a0b\u5e8f\u7684\u4e00\u90e8\u5206\uff0c\u50cf\u5176\u4ed6\u4ee3\u7801\u4e00\u6837\u8fdb\u884c\u7248\u672c\u5316\u548c\u5ba1\u67e5\uff0c\u8fd9\u662f\u6d41\u6c34\u7ebf\u5373\u4ee3\u7801\u7684\u57fa\u7840\u3002</p> <p>\u521b\u5efaJenkinsfile\u5e76\u63d0\u4ea4\u5230\u4ee3\u7801\u4ed3\u5e93\u4e2d\u7684\u597d\u5904\u5982\u4e0b\uff1a</p> <ul> <li>\u81ea\u52a8\u4e3a\u6240\u6709\u5206\u652f\u521b\u5efa\u6d41\u6c34\u7ebf\u6784\u5efa\u8fc7\u7a0b\u3002</li> <li>\u5728\u6d41\u6c34\u7ebf\u4e0a\u8fdb\u884c\u4ee3\u7801\u590d\u67e5/\u8fed\u4ee3\u3002</li> <li>\u5bf9\u6d41\u6c34\u7ebf\u8fdb\u884c\u5ba1\u8ba1\u8ddf\u8e2a\u3002</li> <li>\u6d41\u6c34\u7ebf\u7684\u4ee3\u7801\u53ef\u4ee5\u88ab\u9879\u76ee\u7684\u591a\u4e2a\u6210\u5458\u67e5\u770b\u548c\u7f16\u8f91\u3002</li> <li>\u53ef\u4ee5\u5bf9Jenkinsfile\u8fdb\u884c\u7248\u672c\u63a7\u5236\u3002</li> </ul> <p>Jenkins\u6d41\u6c34\u7ebf\u4e3b\u8981\u5206\u4e3a\u58f0\u660e\u5f0f\u548c\u811a\u672c\u5f0f\u4e24\u79cd\uff0c\u5305\u542bpipeline\uff08\u6d41\u6c34\u7ebf\uff09\u3001node\uff08\u8282\u70b9\uff09\u3001stage\uff08\u9636\u6bb5\uff09\u3001step\uff08\u6b65\u9aa4\uff09\u7b49\u533a\u5757\u3002</p> <p>\uff081\uff09pipeline pipeline\u662f\u7528\u6237\u5b9a\u4e49\u7684\u4e00\u4e2a\u6301\u7eed\u4ea4\u4ed8\uff08CD\uff09\u6d41\u6c34\u7ebf\u6a21\u578b\u3002\u6d41\u6c34\u7ebf\u7684\u4ee3\u7801\u5b9a\u4e49\u4e86\u6574\u4e2a\u6784\u5efa\u8fc7\u7a0b\uff0c\u5305\u62ec\u6784\u5efa\u3001\u6d4b\u8bd5\u548c\u4ea4\u4ed8\u5e94\u7528\u7a0b\u5e8f\u7684\u9636\u6bb5\u3002\u53e6\u5916\uff0c pipeline\u5757\u662f\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u8bed\u6cd5\u7684\u5173\u952e\u90e8\u5206\u3002</p> <p>\uff082\uff09node node\u662f\u4e00\u4e2a\u673a\u5668\uff0c\u5b83\u662fJenkins\u73af\u5883\u7684\u4e00\u90e8\u5206\uff0c\u53e6\u5916\uff0cnode\u5757\u662f\u811a\u672c\u5316\u6d41\u6c34\u7ebf\u8bed\u6cd5\u7684\u5173\u952e\u90e8\u5206\u3002</p> <p>\uff083\uff09stage stage\u5757\u5b9a\u4e49\u4e86\u5728\u6574\u4e2a\u6d41\u6c34\u7ebf\u7684\u6267\u884c\u4efb\u52a1\u4e2d\u6982\u5ff5\u4e0d\u540c\u7684\u5b50\u96c6\uff08\u6bd4\u5982Build\u3001?est\u3001Deploy\u9636\u6bb5\uff09\uff0c\u5b83\u88ab\u8bb8\u591a\u63d2\u4ef6\u7528\u4e8e\u53ef\u89c6\u5316Jenkins\u6d41\u6c34\u7ebf\u5f53\u524d \u7684\u72b6\u6001/\u8fdb\u5c55\u3002</p> <p>\uff084\uff09step \u672c\u8d28\u4e0a\u662f\u6307\u901a\u8fc7\u4e00\u4e2a\u5355\u4e00\u7684\u4efb\u52a1\u544a\u8bc9Jenkins\u5728\u7279\u5b9a\u7684\u65f6\u95f4\u70b9\u9700\u8981\u505a\u4ec0\u4e48\uff0c\u6bd4\u5982\u8981\u6267\u884cshell\u547d\u4ee4\uff0c\u53ef\u4ee5\u4f7f\u7528sh SHELL_COMMAND\u3002 \u4ece\u4e0a\u6587\u53ef\u4ee5\u4e86\u89e3\uff0cJenkins\u6d41\u6c34\u7ebf\u5206\u4e3a\u811a\u672c\u5f0f\u548c\u58f0\u660e\u5f0f\uff0c\u800c\u58f0\u660e\u5f0f\u662f\u201c\u65b0\u4e00\u4ee3\u201d\u7684\u6d41\u6c34\u7ebf\uff0c\u6bd4\u811a\u672c\u5f0f\u66f4\u52a0\u7075\u6d3b\uff0c\u53ef\u8bfb\u6027\u66f4\u5f3a\uff0c\u5e76\u4e14\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u652f\u6301 \u4ee5\u56fe\u5f62\u5316\u7684\u65b9\u5f0f\u8fdb\u884c\u7f16\u8f91\uff0c\u6240\u4ee5\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u662f\u7740\u91cd\u5b66\u4e60\u7684\u5bf9\u8c61\u3002</p> <p>\u63a5\u4e0b\u6765\u770b\u4e00\u4e0b\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u548c\u811a\u672c\u5f0f\u6d41\u6c34\u7ebf\u7684\u8bed\u6cd5\u533a\u522b\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#22-\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf","title":"2.2 \u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf","text":"<p>\u5728\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u7684\u8bed\u6cd5\u4e2d\uff0c\u6d41\u6c34\u7ebf\u8fc7\u7a0b\u5b9a\u4e49\u5728pipeline{}\u4e2d\uff0cpipeline\u5757\u5b9a\u4e49\u4e86\u6574\u4e2a\u6d41\u6c34\u7ebf\u4e2d\u5b8c\u6210\u7684\u6240\u6709\u5de5\u4f5c\uff0c\u6bd4\u5982\uff1a</p> <pre><code>//Jenkinsfile (Declarative Pipeline)\npipeline {\n  agent any\n    stages {\n      stage('Build') {\n        steps {\n          echo 'Build'\n        }\n      }\n      stage('Test') {\n        steps {\n          echo 'Test'\n        }\n      }\n      stage('Deploy') {\n        steps {\n          echo 'Deploy'\n      }\n    }\n  }\n}\n</code></pre> <p>\u53c2\u6570\u8bf4\u660e\uff1a</p> <ul> <li>agent any\uff1a\u5728\u4efb\u4f55\u53ef\u7528\u7684\u4ee3\u7406\u4e0a\u6267\u884c\u6d41\u6c34\u7ebf\u6216\u5b83\u7684\u4efb\u4f55\u9636\u6bb5\uff0c\u4e5f\u5c31\u662f\u6267\u884c\u6d41\u6c34\u7ebf\u8fc7\u7a0b\u7684\u4f4d\u7f6e\uff0c\u4e5f\u53ef\u4ee5\u6307\u5b9a\u5230\u5177\u4f53\u7684\u8282\u70b9\u3002</li> <li>stage\uff1a\u5b9a\u4e49\u6d41\u6c34\u7ebf\u7684\u6267\u884c\u8fc7\u7a0b\uff08\u76f8\u5f53\u4e8e\u4e00\u4e2a\u9636\u6bb5\uff09\uff0c\u6bd4\u5982\u4e0a\u6587\u6240\u793a\u7684Build\u3001Test\u3001Deploy\uff0c\u4f46\u662f\u8fd9\u4e2a\u540d\u5b57\u662f\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u5b9a\u4e49\u7684\uff0c\u5e76   \u975e\u56fa\u5b9a\u7684\u540d\u5b57\u3002</li> <li>steps\uff1a\u6267\u884c\u67d0\u9636\u6bb5\u5177\u4f53\u7684\u6b65\u9aa4\u3002</li> </ul> <p>\u4e00\u4e2a\u4ee5\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u7684\u8bed\u6cd5\u7f16\u5199\u7684Jenkinsfile\u6587\u4ef6\u5982\u4e0b\uff1a</p> <pre><code>//Jenkinsfile (Declarative Pipeline)\npipeline {\n  agent any\n    stages {\n      stage('Build') {\n        steps {\n          sh 'make'\n        }\n      }\n      stage('Test') {\n        steps {\n          sh 'make check'\n          junit 'reports/**/*.xml'\n        }\n      }\n      stage('Deploy') {\n        steps {\n          sh 'make publish'\n      }\n    }\n  }\n}\n</code></pre> <p>\u53c2\u6570\u8bf4\u660e\uff1a</p> <ul> <li>pipeline\uff1a\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u7684\u4e00\u79cd\u7279\u5b9a\u8bed\u6cd5\uff0c\u5b9a\u4e49\u4e86\u5305\u542b\u6267\u884c\u6574\u4e2a\u6d41\u6c34\u7ebf\u7684\u6240\u6709\u5185\u5bb9\u548c\u6307\u4ee4\uff0c\u4e5f\u662f\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u7684\u5f00\u59cb\u3002</li> <li>agent\uff1a\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u7684\u4e00\u79cd\u7279\u5b9a\u8bed\u6cd5\uff0c\u6307\u793aJenkins\u4e3a\u6574\u4e2a\u6d41\u6c34\u7ebf\u5206\u914d\u4e00\u4e2a\u6267\u884c\u5668\u548c\u5de5\u4f5c\u533a\uff0c\u4e5f\u5c31\u662f\u5728\u6d41\u6c34\u7ebf\u4e2d\u7684\u6b65\u9aa4\u5728\u54ea\u4e2aagent\u4e0a   \u6267\u884c\uff0c\u8be5\u53c2\u6570\u540c\u6837\u53ef\u4ee5\u5728stage\u4e2d\u914d\u7f6e\u3002</li> <li>stage\uff1a\u63cf\u8ff0\u6d41\u6c34\u7ebf\u9636\u6bb5\u7684\u8bed\u6cd5\u5757\uff0c\u5728\u811a\u672c\u5f0f\u6d41\u6c34\u7ebf\u8bed\u6cd5\u4e2d\uff0cstage\u5757\u662f\u53ef\u9009\u7684\u3002</li> <li>steps\uff1a\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u7684\u4e00\u79cd\u7279\u5b9a\u8bed\u6cd5\uff0c\u5b83\u63cf\u8ff0\u4e86\u5728\u8fd9\u4e2astage\u4e2d\u8981\u8fd0\u884c\u7684\u6b65\u9aa4\u3002</li> <li>sh\uff1a\u6267\u884c\u4e00\u4e2ashell\u547d\u4ee4\u3002</li> <li>junit\uff1a\u7528\u4e8e\u805a\u5408\u6d4b\u8bd5\u62a5\u544a\u3002</li> </ul>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#23-\u811a\u672c\u5316\u6d41\u6c34\u7ebf","title":"2.3 \u811a\u672c\u5316\u6d41\u6c34\u7ebf","text":"<p>\u5728\u811a\u672c\u5316\u6d41\u6c34\u7ebf\u7684\u8bed\u6cd5\u4e2d\uff0c\u4f1a\u6709\u4e00\u4e2a\u6216\u591a\u4e2anode\u5757\u5728\u6574\u4e2a\u6d41\u6c34\u7ebf\u4e2d\u6267\u884c\u6838\u5fc3\u5de5\u4f5c\uff0c\u6bd4\u5982\uff1a</p> <pre><code>//Jenkinsfile (Scripted Pipeline)\nnode {\n  stage('Build') {\n    echo 'Build'\n  }\n  stage('Test') {\n    echo 'Test'\n  }\n  stage('Deploy') {\n    echo 'Deploy'\n  }\n}\n</code></pre> <p>\u53c2\u6570\u8bf4\u660e\uff1a</p> <ul> <li>node\uff1a\u5728\u4efb\u4f55\u53ef\u7528\u7684\u4ee3\u7406\u4e0a\u6267\u884c\u6d41\u6c34\u7ebf\u6216\u5b83\u7684\u4efb\u4f55\u9636\u6bb5\uff0c\u4e5f\u53ef\u4ee5\u6307\u5b9a\u5230\u5177\u4f53\u7684\u8282\u70b9\u3002</li> <li>stage\uff1a\u548c\u58f0\u660e\u5f0f\u7684\u542b\u4e49\u4e00\u81f4\uff0c\u5b9a\u4e49\u6d41\u6c34\u7ebf\u7684\u9636\u6bb5\u3002stage\u5757\u5728\u811a\u672c\u5316\u6d41\u6c34\u7ebf\u8bed\u6cd5\u4e2d\u662f\u53ef\u9009\u7684\uff0c\u7136\u800c\u5728\u811a\u672c\u5316\u6d41\u6c34\u7ebf\u4e2d\u5b9e\u73b0stage\u5757\uff0c\u53ef   \u4ee5\u6e05\u695a\u5730\u5728Jenkins UI\u754c\u9762\u4e2d\u663e\u793a\u6bcf\u4e2astage\u7684\u4efb\u52a1\u5b50\u96c6\u3002</li> </ul> <p>\u4e0a\u4e00\u5c0f\u8282\u7684\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u4e5f\u53ef\u4ee5\u7528\u4ee5\u4e0b\u811a\u672c\u5f0f\u6d41\u6c34\u7ebf\u4ee3\u66ff\uff1a</p> <pre><code>//Jenkinsfile (Scripted Pipeline)\nnode {\n  stage('Build') {\n    sh 'make'\n  }\n  stage('Test') {\n     sh 'make check'\n     junit 'reports/**/*.xml'\n  }\n  stage('Deploy') {\n      sh 'make publish'\n  }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#3-\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u7684\u8bed\u6cd5","title":"3. \u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u7684\u8bed\u6cd5","text":"<p>\u524d\u6587\u63d0\u5230\uff0c\u58f0\u660e\u5f0f\u662fJenkins\u65b0\u4e00\u4ee3\u7684\u6d41\u6c34\u7ebf\u7f16\u5199\u65b9\u5f0f\uff0c\u800c\u4e14\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u652f\u6301\u7c7b\u4f3cBlue Ocean\u8fd9\u7c7b\u7684\u56fe\u5f62\u5316\u5de5\u5177\u8fdb\u884c\u5728\u7ebf\u7f16\u8f91\uff0c\u56e0\u6b64\u672c\u4e66\u4e3b\u8981\u8bb2\u89e3 \u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u7684\u5199\u6cd5\u3002</p> <p>\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u5728\u6d41\u6c34\u7ebf\u5b50\u7cfb\u7edf\u4e4b\u4e0a\u63d0\u4f9b\u4e86\u4e00\u79cd\u66f4\u7b80\u5355\u3001\u66f4\u5bb9\u6613\u7406\u89e3\u7684\u8bed\u6cd5\u3002</p> <p>\u4e4b\u524d\u4e5f\u63d0\u5230\u8fc7\uff0c\u6240\u6709\u6709\u6548\u7684\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u5fc5\u987b\u5305\u542b\u5728\u4e00\u4e2apipeline\u5757\u4e2d\uff0c\u6bd4\u5982\u4ee5\u4e0b\u662f\u4e00\u4e2apipeline\u5757\u7684\u683c\u5f0f\uff1a</p> <pre><code>//Jenkinsfile (Declarative Pipeline)\npipeline {\n/* insert Declarative Pipeline here */\n}\n</code></pre> <p>\u5728\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u4e2d\uff0c\u6709\u6548\u7684\u57fa\u672c\u8bed\u53e5\u548c\u8868\u8fbe\u5f0f\u9075\u5faa\u4e0eGroovy\u7684\u8bed\u6cd5\u540c\u6837\u7684\u89c4\u5219\uff0c\u4f46\u6709\u4ee5\u4e0b\u4f8b\u5916\uff1a</p> <ul> <li>\u6d41\u6c34\u7ebf\u9876\u5c42\u5fc5\u987b\u662f\u4e00\u4e2a block\uff0c\u5373 <code>pipeline{}</code></li> <li>\u5206\u9694\u7b26\u53ef\u4ee5\u4e0d\u9700\u8981\u5206\u53f7\uff0c\u4f46\u662f\u6bcf\u6761\u8bed\u53e5\u90fd\u5fc5\u987b\u5728\u81ea\u5df1\u7684\u884c\u4e0a</li> <li>\u5757\u53ea\u80fd\u7531 Sections\u3001Directives\u3001Steps \u6216 assignment statements\u7ec4\u6210</li> <li>\u5c5e\u6027\u5f15\u7528\u8bed\u53e5\u88ab\u5f53\u505a\u662f\u65e0\u53c2\u6570\u7684\u65b9\u6cd5\u8c03\u7528\uff0c\u6bd4\u5982 input \u4f1a\u88ab\u5f53\u505ainput()\u3002</li> </ul> <p>\u63a5\u4e0b\u6765\u5b66\u4e60\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u7684\u57fa\u672c\u8bed\u6cd5\uff0c\u5305\u62ecsections\u3001directives\u533a\u5757\u53caparallel\u5b57\u6bb5\u7684\u7528\u6cd5\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#31-sections","title":"3.1 Sections","text":"<p>\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u4e2d\u7684 Sections \u4e0d\u662f\u4e00\u4e2a\u5173\u952e\u5b57\u6216\u6307\u4ee4\uff0c\u800c\u662f\u5305\u542b\u4e00\u4e2a\u6216\u591a\u4e2a Agent\u3001Stages\u3001 post\u3001Directives \u548c Steps \u7684\u4ee3\u7801\u533a\u57df\u5757\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#1-agent","title":"1. agent","text":"<p>agent\u8868\u793a\u6574\u4e2a\u6d41\u6c34\u7ebf\u6216\u7279\u5b9a\u9636\u6bb5\u4e2d\u7684\u6b65\u9aa4\u548c\u547d\u4ee4\u6267\u884c\u7684\u4f4d\u7f6e\uff0c\u8be5\u90e8\u5206\u5fc5\u987b\u5728pipeline\u5757\u7684\u9876\u5c42\u88ab\u5b9a\u4e49\uff0c\u4e5f\u53ef\u4ee5\u5728stage\u4e2d\u518d\u6b21\u5b9a\u4e49\uff0c\u4f46\u662fstage\u7ea7\u522b \u662f\u53ef\u9009\u7684\u3002</p> <p>\uff081\uff09agent\u7684\u914d\u7f6e\u51fd\u6570 \u4e3a\u4e86\u652f\u6301\u53ef\u80fd\u6709\u7684\u5404\u79cd\u5404\u6837\u7684\u6d41\u6c34\u7ebf\uff0cagent\u652f\u6301\u4e00\u4e9b\u4e0d\u540c\u7c7b\u578b\u7684\u53c2\u6570\uff0c\u8fd9\u4e9b\u53c2\u6570\u5e94\u7528\u5728pipeline\u5757\u7684\u9876\u5c42\uff0c\u6216stage\u6307\u4ee4\u5185\u90e8\u3002agent\u53ef\u9009\u914d\u7f6e\u5982 \u4e0b\uff1a</p> <ul> <li>any\uff1a\u5728\u4efb\u4f55\u53ef\u7528\u7684\u4ee3\u7406\u4e0a\u6267\u884c\u6d41\u6c34\u7ebf\uff0c\u914d\u7f6e\u8bed\u6cd5\uff1a</li> </ul> <pre><code>pipeline {\n  agent any\n}\n</code></pre> <ul> <li>none\uff1a\u8868\u793a\u8be5pipeline\u811a\u672c\u6ca1\u6709\u5168\u5c40\u7684agent\u914d\u7f6e\u3002\u5f53\u9876\u5c42\u7684agent\u914d\u7f6e\u4e3anone\u65f6\uff0c\u6bcf\u4e2astage\u90e8\u5206\u90fd\u9700\u8981\u5305\u542b\u5b83\u81ea\u5df1\u7684agent\u3002\u914d\u7f6e\u8bed\u6cd5\uff1a</li> </ul> <pre><code>pipeline {\n  agent none\n  stages {\n    stage('Stage For Build'){\n      agent any\n    }\n  }\n}\n</code></pre> <ul> <li>label: \u4ee5\u8282\u70b9\u6807\u7b7e\u5f62\u5f0f\u9009\u62e9\u67d0\u4e2a\u5177\u4f53\u7684\u8282\u70b9\u6267\u884c Pipeline \u547d\u4ee4\uff0c\u4f8b\u5982\uff1aagent { label 'my-defined-label' }\u3002\u8282\u70b9\u9700\u8981\u63d0\u524d\u914d\u7f6e\u6807\u7b7e\u3002</li> </ul> <pre><code>pipeline {\n  agent none\n    stages {\n      stage('Stage For Build'){\n        agent { label 'role-master' }\n        steps {\n          echo \"role-master\"\n        }\n      }\n    }\n}\n</code></pre> <ul> <li>node: \u548c label \u914d\u7f6e\u7c7b\u4f3c\uff0c\u53ea\u4e0d\u8fc7\u662f\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e9b\u989d\u5916\u7684\u914d\u7f6e\uff0c\u6bd4\u5982 customWorkspace(\u8bbe\u7f6e\u9ed8\u8ba4\u5de5\u4f5c\u76ee\u5f55)</li> </ul> <pre><code>pipeline {\n  agent none\n    stages {\n      stage('Stage For Build'){\n        agent {\n          node {\n            label 'role-master'\n            customWorkspace \"/tmp/zhangzhuo/data\"\n          }\n        }\n        steps {\n          sh \"echo role-master &gt; 1.txt\"\n        }\n      }\n    }\n}\n</code></pre> <ul> <li>dockerfile\uff1a\u4f7f\u7528\u4ece\u6e90\u7801\u4e2d\u5305\u542b\u7684Dockerfile\u6240\u6784\u5efa\u7684\u5bb9\u5668\u6267\u884c\u6d41\u6c34\u7ebf\u6216stage\u3002\u4e3a\u4e86\u4f7f\u7528\u8be5\u9009\u9879\uff0cJenkinsfile\u5fc5\u987b\u4ece\u591a\u4e2a\u5206\u652f\u6d41\u6c34\u7ebf\u4e2d\u52a0\u8f7d\uff0c\u6216\u8005\u4ecepipeline from SCM\uff08\u540e\u9762\u7684\u7ae0\u8282\u4f1a\u6d89\u53ca\uff09\u52a0\u8f7d\u3002</li> </ul> <p>\u5982\u679c\u914d\u7f6e\u7684\u8bed\u6cd5\u4e3aagent {dockerfile true}\uff0c\u90a3\u4e48\u5c06\u4ece\u6e90\u7801\u7684\u6839\u76ee\u5f55\u4e0b\u4f7f\u7528Dockerfile\u6587\u4ef6\u8fdb\u884c\u6784\u5efa\u3002</p> <p>\u5982\u679cDockerfile\u6587\u4ef6\u5728\u5176\u4ed6\u76ee\u5f55\uff0c\u5219\u9700\u8981\u4f7f\u7528dir\u5b57\u6bb5\u66f4\u6539Dockerfile\u6240\u5728\u7684\u76ee\u5f55\uff0c\u914d\u7f6e\u65b9\u6cd5\u4e3aagent { dockerfile { dir 'DockerfileDir'} }\u3002</p> <p>\u5982\u679c\u6784\u5efa\u955c\u50cf\u7684Dockerfile\u540d\u79f0\u4e0d\u662fDockerfile\uff0c\u53ef\u4ee5\u4f7f\u7528filename\u9009\u9879\u6307\u5b9aDockerfile\u6587\u4ef6\u540d\u3002</p> <p>\u540c\u65f6\u4e5f\u53ef\u4ee5\u4f7f\u7528additionalBuildArgs\u53c2\u6570\u4f20\u9012\u6784\u5efa\u955c\u50cf\u7684\u53c2\u6570\uff0c\u6bd4\u5982agent{dockerfile{ additionalBuildArgs '--build-arg version=1.0.2' } }\u3002</p> <p>\u5047\u5982\u6709\u4e00\u4e2a\u9879\u76ee\u9700\u8981\u4f7f\u7528Dockerfile\u7c7b\u578b\u7684agent\uff0c\u5e76\u4e14Dockerfile\u5728build\u76ee\u5f55\uff0c\u6587\u4ef6\u540d\u4e3aDockerfile.build\uff0c\u6784\u5efa\u65f6\u671f\u671b\u6709\u4e00\u4e2aversion\u7684\u53c2\u6570\u3002\u6b64\u65f6\u5bf9\u5e94\u7684   agent\u5199\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>agent {\n   dockerfile {\n     filename 'Dockerfile.build'  //dockerfile\u6587\u4ef6\u540d\u79f0\n     dir 'build'                  //\u6267\u884c\u6784\u5efa\u955c\u50cf\u7684\u5de5\u4f5c\u76ee\u5f55\n     label 'role-master'          //\u6267\u884c\u7684node\u8282\u70b9\uff0c\u6807\u7b7e\u9009\u62e9\n     additionalBuildArgs '--build-arg version=1.0.2' //\u6784\u5efa\u53c2\u6570\n   }\n}\n</code></pre> <ul> <li>docker\uff1a\u76f8\u5f53\u4e8edockerfile\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528docker\u5b57\u6bb5\u6307\u5b9a\u5916\u90e8\u955c\u50cf\uff0c\u53ef\u4ee5\u7701\u53bb\u6784\u5efa\u7684\u65f6\u95f4\u3002\u6bd4\u5982\u4f7f\u7528maven\u955c\u50cf\u8fdb\u884c\u6253\u5305\uff0c\u540c\u65f6\u53ef\u4ee5\u6307\u5b9aargs\uff1a</li> </ul> <pre><code>agent{\n  docker{\n    image '192.168.10.15/kubernetes/alpine:latest'   //\u955c\u50cf\u5730\u5740\n    label 'role-master' //\u6267\u884c\u7684\u8282\u70b9\uff0c\u6807\u7b7e\u9009\u62e9\n    args '-v /tmp:/tmp'      //\u542f\u52a8\u955c\u50cf\u7684\u53c2\u6570\n  }\n}\n</code></pre> <ul> <li>kubernetes\uff1aJenkins\u4e5f\u652f\u6301\u4f7f\u7528Kubernetes\u521b\u5efaSlave\uff0c\u4e5f\u5c31\u662f\u5e38\u8bf4\u7684\u52a8\u6001Slave\u3002</li> </ul> <p>\u9700\u8981\u90e8\u7f72 kubernetes \u76f8\u5173\u7684\u63d2\u4ef6\uff0c\u5b98\u65b9\u6587\u6863\uff1a</p> <p>https://github.com/jenkinsci/kubernetes-plugin/</p> <p>\u914d\u7f6e\u793a\u4f8b\u5982\u4e0b;</p> <ul> <li>cloud: Configure Clouds \u7684\u540d\u79f0\uff0c\u6307\u5b9a\u5230\u5176\u4e2d\u4e00\u4e2a k8s</li> <li>slaveConnectTimeout: \u8fde\u63a5\u8d85\u65f6\u65f6\u95f4</li> <li>yaml: pod \u5b9a\u4e49\u6587\u4ef6\uff0cjnlp \u5bb9\u5668\u7684\u914d\u7f6e\u5fc5\u987b\u6709\u914d\u7f6e\u65e0\u9700\u6539\u53d8\uff0c\u5176\u4f59 containerd \u6839\u636e\u81ea\u5df1\u60c5\u51b5\u6307\u5b9a</li> <li>workspaceVolume\uff1a\u6301\u4e45\u5316 jenkins \u7684\u5de5\u4f5c\u76ee\u5f55\u3002<ul> <li>persistentVolumeClaimWorkspaceVolume\uff1a\u6302\u8f7d\u5df2\u6709 pvc\u3002</li> </ul> </li> </ul> <pre><code>workspaceVolume persistentVolumeClaimWorkspaceVolume(claimName: \"jenkins-agent\", mountPath: \"/\", readOnly: \"false\")\n</code></pre> <ul> <li>nfsWorkspaceVolume\uff1a\u6302\u8f7d nfs \u670d\u52a1\u5668\u76ee\u5f55</li> </ul> <pre><code>workspaceVolume nfsWorkspaceVolume(serverAddress: \"192.168.10.254\", serverPath: \"/nfs\", readOnly: \"false\")\n</code></pre> <ul> <li>dynamicPVC\uff1a\u52a8\u6001\u7533\u8bf7 pvc\uff0c\u4efb\u52a1\u6267\u884c\u7ed3\u675f\u540e\u5220\u9664</li> </ul> <pre><code>workspaceVolume dynamicPVC(storageClassName: \"nfs-client\", requestsSize: \"1Gi\", accessModes: \"ReadWriteMany\")\n</code></pre> <ul> <li>emptyDirWorkspaceVolume\uff1a\u4e34\u65f6\u76ee\u5f55\uff0c\u4efb\u52a1\u6267\u884c\u7ed3\u675f\u540e\u4f1a\u968f\u7740 pod \u5220\u9664\u88ab\u5220\u9664\uff0c\u4e3b\u8981\u529f\u80fd\u591a\u4e2a\u4efb\u52a1 container \u5171\u4eab jenkins \u5de5\u4f5c\u76ee\u5f55\u3002</li> </ul> <pre><code>workspaceVolume emptyDirWorkspaceVolume()\n</code></pre> <ul> <li>hostPathWorkspaceVolume\uff1a\u6302\u8f7d node \u8282\u70b9\u672c\u673a\u76ee\u5f55\uff0c\u6ce8\u610f\u6302\u8f7d\u672c\u673a\u76ee\u5f55\u6ce8\u610f\u6743\u9650\u95ee\u9898\uff0c\u53ef\u4ee5\u5148\u521b\u5efa\u8bbe\u7f6e 777 \u6743\u9650\uff0c\u5426\u5219\u9ed8\u8ba4 kubelet \u521b\u5efa\u7684\u76ee\u5f55\u6743\u9650\u4e3a 755 \u9ed8\u8ba4\u5176\u4ed6\u7528\u6237\u6ca1\u6709\u5199\u6743\u9650\uff0c\u6267\u884c\u6d41\u6c34\u7ebf\u4f1a\u62a5\u9519\u3002</li> </ul> <pre><code>workspaceVolume hostPathWorkspaceVolume(hostPath: \"/opt/workspace\", readOnly: false)\n</code></pre> <p>\u793a\u4f8b</p> <pre><code>agent {\n  kubernetes {\n      cloud 'kubernetes'\n      slaveConnectTimeout 1200\n      workspaceVolume emptyDirWorkspaceVolume()\n      yaml '''\nkind: Pod\nmetadata:\n  name: jenkins-agent\nspec:\n  containers:\n  - args: [\\'$(JENKINS_SECRET)\\', \\'$(JENKINS_NAME)\\']\n    image: '192.168.10.15/kubernetes/jnlp:alpine'\n    name: jnlp\n    imagePullPolicy: IfNotPresent\n  - command:\n      - \"cat\"\n    image: \"192.168.10.15/kubernetes/alpine:latest\"\n    imagePullPolicy: \"IfNotPresent\"\n    name: \"date\"\n    tty: true\n  restartPolicy: Never\n'''\n  }\n}\n</code></pre> <p>\uff082\uff09agent\u7684\u5e38\u89c1\u9009\u9879</p> <ul> <li> <p>label\uff1a\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u8be5\u6807\u7b7e\u7528\u4e8e\u8fd0\u884c\u6d41\u6c34\u7ebf\u7684\u4f4d\u7f6e\u3002\u8be5\u9009\u9879\u5bf9node\u3001docker\u548cdockerfile\u53ef\u7528\uff0cnode\u5fc5\u987b\u9009\u62e9\u8be5\u9009\u9879</p> </li> <li> <p>customWorkspace\uff1a\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u7528\u4e8e\u81ea\u5b9a\u4e49\u5de5\u4f5c\u533a\u8fd0\u884c\u6d41\u6c34\u7ebf\u6216stage\u3002\u5b83\u53ef\u4ee5\u662f\u76f8\u5bf9\u8def\u5f84\uff0c\u4e5f\u53ef\u4ee5\u662f\u7edd\u5bf9\u8def\u5f84\uff0c\u8be5\u9009\u9879\u5bf9node\u3001   docker\u548cdockerfile\u53ef\u7528\u3002\u6bd4\u5982\uff1a</p> </li> </ul> <pre><code>agent {\n  node {\n      label 'my-defied-label'\n      customWorkspace 'some/other/path'\n  }\n}\n</code></pre> <ul> <li>reuseNode\uff1a\u4e00\u4e2a\u5e03\u5c14\u503c\uff0c\u9ed8\u8ba4\u4e3afalse\u3002\u5982\u679c\u662ftrue\uff0c\u5219\u5728\u540c\u4e00\u4e2a\u5de5\u4f5c\u76ee\u5f55\u6267\u884c\u6d41\u6c34\u7ebf\u3002</li> </ul> <p>\u8fd9\u4e2a\u9009\u9879\u5bf9docker\u548cdockerfile\u6709\u7528\uff0c\u5e76\u4e14\u53ea\u6709\u4f7f\u7528\u5728\u4e2a\u522bstage\u7684agent\u4e0a\u624d\u4f1a\u6709\u6548\u3002\u901a\u5e38\u60c5\u51b5\u4e0b\u4f7f\u7528docker   \u4f5c\u4e3aagent\u65f6\u4f1a\u5f00\u542f\u6b64\u53c2\u6570\uff1a</p> <pre><code>agent {\n  docker {\n      image 'maven:3-alpine'\n      label 'my-defined-label'\n      args '-v /tmp:/tmp'\n      reuseNode true\n  }\n}\n</code></pre> <p>\uff083\uff09agent\u7684\u914d\u7f6e\u793a\u4f8b</p> <ul> <li>\u793a\u4f8b1\uff1a\u5047\u8bbe\u6709\u4e00\u4e2aJava\u9879\u76ee\uff0c\u9700\u8981\u7528mvn\u547d\u4ee4\u8fdb\u884c\u7f16\u8bd1\uff0c\u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528maven\u7684\u955c\u50cf\u4f5c\u4e3aagent\u3002\u914d\u7f6e\u5982\u4e0b\uff1a</li> </ul> <pre><code>pipeline {\n  agent { docker 'maven:3-alpine' }\n  stages {\n    stage('Example Build') {\n      steps {\n        echo 'Hello, Maven'\n        sh 'mvn -B clean verify'\n      }\n    }\n  }\n}\n</code></pre> <ul> <li> <p>\u793a\u4f8b2\uff1a\u672c\u793a\u4f8b\u5728\u6d41\u6c34\u7ebf\u9876\u5c42\u5c06agent\u5b9a\u4e49\u4e3anone\uff0c\u90a3\u4e48\u6b64\u65f6stage\u90e8\u5206\u5c31\u5fc5\u987b\u5305\u542b\u5b83\u81ea\u5df1\u7684agent\u90e8\u5206\u3002</p> <p>\u5728stage('Example Build')\u90e8\u5206\u4f7f\u7528maven:3-alpine\u6267\u884c\u8be5\u9636\u6bb5\u7684\u6b65\u9aa4\uff0c\u5728stage('Example Test')\u90e8\u5206\u4f7f\u7528openjdk:8-jre\u6267\u884c\u8be5\u9636\u6bb5\u7684\u6b65\u9aa4\u3002\u6b64\u65f6Pipeline\u5982\u4e0b\uff1a</p> <pre><code>pipeline {\n  agent none\n  stages {\n    stage('Example Build') {\n      agent { docker 'maven:3-alpine' }\n      steps {\n        echo 'Hello, Maven'\n        sh 'mvn --version'\n      }\n    }\n    stage('Example Test') {\n      agent { docker 'openjdk:8-jre' }\n      steps {\n        echo 'Hello, JDK'\n        sh 'java -version'\n      }\n    }\n  }\n}\n</code></pre> </li> <li> <p>kubernetes \u793a\u4f8b</p> <pre><code>pipeline {\n  agent {\n    kubernetes {\n      cloud 'kubernetes'\n      slaveConnectTimeout 1200\n      workspaceVolume emptyDirWorkspaceVolume()\n      yaml '''\nkind: Pod\nmetadata:\n  name: jenkins-agent\nspec:\n  containers:\n  - args: [\\'$(JENKINS_SECRET)\\', \\'$(JENKINS_NAME)\\']\n    image: '192.168.10.15/kubernetes/jnlp:alpine'\n    name: jnlp\n    imagePullPolicy: IfNotPresent\n  - command:\n      - \"cat\"\n    image: \"192.168.10.15/kubernetes/alpine:latest\"\n    imagePullPolicy: \"IfNotPresent\"\n    name: \"date\"\n    tty: true\n  - command:\n      - \"cat\"\n    image: \"192.168.10.15/kubernetes/kubectl:apline\"\n    imagePullPolicy: \"IfNotPresent\"\n    name: \"kubectl\"\n    tty: true\n  restartPolicy: Never\n'''\n    }\n  }\n  environment {\n    MY_KUBECONFIG = credentials('kubernetes-cluster')\n  }\n  stages {\n    stage('Data') {\n      steps {\n        container(name: 'date') {\n          sh \"\"\"\n            date\n          \"\"\"\n        }\n      }\n    }\n    stage('echo') {\n      steps {\n        container(name: 'date') {\n          sh \"\"\"\n            echo 'k8s is pod'\n          \"\"\"\n        }\n      }\n    }\n    stage('kubectl') {\n      steps {\n        container(name: 'kubectl') {\n          sh \"\"\"\n            kubectl get pod -A  --kubeconfig $MY_KUBECONFIG\n          \"\"\"\n        }\n      }\n    }\n  }\n}\n</code></pre> </li> </ul> <p>Jenkins\u7684pipeline\u5b9e\u8df5\u4e4bGitSCM\u53c2\u6570\u914d\u7f6e\u9879\u8be6\u89e3</p> <p>https://cloud.tencent.com/developer/article/2017111</p> <p>\u4ed3\u5e93\u62c9\u53d6</p> <p>\u62c9\u53d6\u4ed3\u5e93\u5206\u652f</p> <pre><code>     stage('Pull master code') {\n        options { retry(3) }\n        steps {\n            checkout([$class: 'GitSCM',\n            branches: [[name: \"*/${RELEASE_VERSION}\"]],\n            extensions: [\n                [$class: 'CleanBeforeCheckout', deleteUntrackedNestedRepositories: true],\n                [$class: 'SparseCheckoutPaths', sparseCheckoutPaths:[[$class:'SparseCheckoutPath', path:'config/']]]],\n            userRemoteConfigs: [[credentialsId: \"${GIT_AUTH}\", url: \"${GIT_ADDRESS}\"]]])\n            }\n     }\n</code></pre> <p>\u62c9\u53d6\u4ed3\u5e93\u5206\u652f\u4e0b\u7684\u76ee\u5f55\u6216\u8005\u6587\u4ef6</p> <pre><code>            stage('pull pr branch config') {\n                steps {\n                   script {\n                      try {\n                        retry(3) {\n                        checkout([$class: 'GitSCM',\n                            branches: [[name: \"pull/${giteePullRequestIid}/MERGE\"]], doGenerateSubmoduleConfigurations: false, submoduleCfg: [],\n                            extensions: [\n                                [$class: 'CleanBeforeCheckout', deleteUntrackedNestedRepositories: true],\n                                [$class: 'SparseCheckoutPaths', sparseCheckoutPaths:[[$class:'SparseCheckoutPath', path:'config/']]],\n                                [$class: 'CloneOption', depth: 1, noTags: false, reference: '', shallow: true]],\n                            userRemoteConfigs: [[credentialsId: \"${GIT_AUTH}\", name: 'origin', refspec: '+refs/pull/*/MERGE:refs/pull/*/MERGE',url: \"${GIT_ADDRESS}\"]]\n                        ])}\n                      } catch(Exception err) {\n                            addGiteeMRComment comment: \"+ CI\u6d41\u6c34\u7ebf\u4e2d\u62c9\u53d6\u4ee3\u7801\u6b65\u9aa4\u5931\u8d25! \u67e5\u770b\u8be6\u7ec6\u6784\u5efa\u8fc7\u7a0b\uff1a [BUILD](\" + env.RUN_DISPLAY_URL + \")\"\n                      }\n                   }\n                }\n            }\n</code></pre> <p>\u8d85\u65f6\u8bbe\u7f6e\u4e0e\u90e8\u7f72\u53c2\u6570switch\u8bed\u53e5\u9009\u62e9</p> <pre><code>timeout(time: 1, unit: 'MINUTES') {\n  script {\n    env.deploy_option = input message: '\u9009\u62e9\u64cd\u4f5c', ok: 'deploy',\n    parameters: [choice(name: 'deploy_option', choices: ['deploy', 'rollback', 'redeploy'], description: '\u9009\u62e9\u90e8\u7f72\u73af\u5883')]\n    switch(\"${env.deploy_option}\"){\n        case 'deploy':\n            println('1.deploy prd env')\n            break;\n        case 'rollback':\n            println('2.rollback env')\n            break;\n        case 'redeploy':\n            println('3.redeploy env')\n            break;\n        default:\n            println('error env')\n    }\n  }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#2-post","title":"2. Post","text":"<p>post\u4e00\u822c\u7528\u4e8e\u6d41\u6c34\u7ebf\u7ed3\u675f\u540e\u7684\u8fdb\u4e00\u6b65\u5904\u7406\uff0c\u6bd4\u5982\u9519\u8bef\u901a\u77e5\u7b49\u3002post\u53ef\u4ee5\u9488\u5bf9\u6d41\u6c34\u7ebf\u4e0d\u540c\u7684\u7ed3\u679c\u505a\u51fa\u4e0d\u540c\u7684\u5904\u7406\uff0c\u5c31\u50cf\u5f00\u53d1\u7a0b\u5e8f\u7684\u9519\u8bef\u5904\u7406\uff0c\u6bd4\u5982Python\u8bed\u8a00\u7684try catch\u3002post\u53ef\u4ee5\u5b9a\u4e49\u5728Pipeline\u6216stage\u4e2d\uff0c\u76ee\u524d\u652f\u6301\u4ee5\u4e0bpost-condition\uff1a</p> <ol> <li>always\uff1a\u65e0\u8bba Pipeline \u6216 stage \u7684\u5b8c\u6210\u72b6\u6001\u5982\u4f55\uff0c\u90fd\u5141\u8bb8\u8fd0\u884c\u8be5 post \u4e2d\u5b9a\u4e49\u7684\u6307\u4ee4\uff1b</li> <li>changed\uff1a\u53ea\u6709\u5f53\u524d Pipeline \u6216 stage \u7684\u5b8c\u6210\u72b6\u6001\u4e0e\u5b83\u4e4b\u524d\u7684\u8fd0\u884c\u4e0d\u540c\u65f6\uff0c\u624d\u5141\u8bb8\u5728\u8be5 post \u90e8\u5206\u8fd0\u884c\u8be5\u6b65\u9aa4\uff1b</li> <li>fixed\uff1a\u5f53\u672c\u6b21 Pipeline \u6216 stage \u6210\u529f\uff0c\u4e14\u4e0a\u4e00\u6b21\u6784\u5efa\u662f\u5931\u8d25\u6216\u4e0d\u7a33\u5b9a\u65f6\uff0c\u5141\u8bb8\u8fd0\u884c\u8be5 post \u4e2d\u5b9a\u4e49\u7684\u6307\u4ee4\uff1b</li> <li>regression\uff1a\u5f53\u672c\u6b21 Pipeline \u6216 stage \u7684\u72b6\u6001\u4e3a\u5931\u8d25\u3001\u4e0d\u7a33\u5b9a\u6216\u7ec8\u6b62\uff0c\u4e14\u4e0a\u4e00\u6b21\u6784\u5efa\u7684 \u72b6\u6001\u4e3a\u6210\u529f\u65f6\uff0c\u5141\u8bb8\u8fd0\u884c\u8be5 post \u4e2d\u5b9a\u4e49\u7684\u6307\u4ee4\uff1b</li> <li>failure\uff1a\u53ea\u6709\u5f53\u524d Pipeline \u6216 stage \u7684\u5b8c\u6210\u72b6\u6001\u4e3a\u5931\u8d25\uff08failure\uff09\uff0c\u624d\u5141\u8bb8\u5728 post \u90e8\u5206\u8fd0\u884c\u8be5\u6b65\u9aa4\uff0c\u901a\u5e38\u8fd9\u65f6\u5728 Web \u754c\u9762\u4e2d\u663e\u793a\u4e3a\u7ea2\u8272</li> <li>success\uff1a\u5f53\u524d\u72b6\u6001\u4e3a\u6210\u529f\uff08success\uff09\uff0c\u6267\u884c post \u6b65\u9aa4\uff0c\u901a\u5e38\u5728 Web \u754c\u9762\u4e2d\u663e\u793a\u4e3a\u84dd\u8272 \u6216\u7eff\u8272</li> <li>unstable\uff1a\u5f53\u524d\u72b6\u6001\u4e3a\u4e0d\u7a33\u5b9a\uff08unstable\uff09\uff0c\u6267\u884c post \u6b65\u9aa4\uff0c\u901a\u5e38\u7531\u4e8e\u6d4b\u8bd5\u5931\u8d25\u6216\u4ee3\u7801 \u8fdd\u89c4\u7b49\u9020\u6210\uff0c\u5728 Web \u754c\u9762\u4e2d\u663e\u793a\u4e3a\u9ec4\u8272</li> <li>aborted\uff1a\u5f53\u524d\u72b6\u6001\u4e3a\u7ec8\u6b62\uff08aborted\uff09\uff0c\u6267\u884c\u8be5 post \u6b65\u9aa4\uff0c\u901a\u5e38\u7531\u4e8e\u6d41\u6c34\u7ebf\u88ab\u624b\u52a8\u7ec8\u6b62\u89e6\u53d1\uff0c\u8fd9\u65f6\u5728 Web \u754c\u9762\u4e2d\u663e\u793a\u4e3a\u7070\u8272\uff1b</li> <li>unsuccessful\uff1a\u5f53\u524d\u72b6\u6001\u4e0d\u662f success \u65f6\uff0c\u6267\u884c\u8be5 post \u6b65\u9aa4\uff1b</li> <li>cleanup\uff1a\u65e0\u8bba pipeline \u6216 stage \u7684\u5b8c\u6210\u72b6\u6001\u5982\u4f55\uff0c\u90fd\u5141\u8bb8\u8fd0\u884c\u8be5 post \u4e2d\u5b9a\u4e49\u7684\u6307\u4ee4\u3002\u548c always \u7684\u533a\u522b\u5728\u4e8e\uff0ccleanup \u4f1a\u5728\u5176\u5b83\u6267\u884c\u4e4b\u540e\u6267\u884c\u3002</li> </ol> <p>\u793a\u4f8b</p> <p>\u4e00\u822c\u60c5\u51b5\u4e0b post \u90e8\u5206\u653e\u5728\u6d41\u6c34\u7ebf\u7684\u5e95\u90e8\uff0c\u6bd4\u5982\u672c\u5b9e\u4f8b\uff0c\u65e0\u8bba stage \u7684\u5b8c\u6210\u72b6\u6001\u5982\u4f55\uff0c\u90fd\u4f1a\u8f93\u51fa\u4e00\u6761 I will always say Hello again!\u4fe1\u606f</p> <pre><code>//Jenkinsfile (Declarative Pipeline)\npipeline {\n  agent any\n  stages {\n    stage('Example1') {\n      steps {\n        echo 'Hello World1'\n      }\n    }\n    stage('Example2') {\n      steps {\n        echo 'Hello World2'\n      }\n    }\n  }\n  post {\n    always {\n      echo 'I will always say Hello again!'\n    }\n  }\n}\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u5c06 post \u5199\u5728 stage\uff0c\u4e0b\u9762\u793a\u4f8b\u8868\u793a Example1 \u6267\u884c\u5931\u8d25\u6267\u884c post\u3002</p> <pre><code>//Jenkinsfile (Declarative Pipeline)\npipeline {\n  agent any\n  stages {\n    stage('Example1') {\n      steps {\n        sh 'ip a'\n      }\n      post {\n        failure {\n          echo 'I will always say Hello again!'\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#3-stages","title":"3. stages","text":"<p>\u5728\u524d\u6587\u4e2d\uff0c\u5176\u5b9e\u5df2\u7ecf\u80fd\u770b\u5230\u4e00\u4e9b\u5bf9stages\u7684\u5b9a\u4e49\uff0cstages\u5305\u542b\u4e00\u4e2a\u6216\u591a\u4e2astage\u6307\u4ee4\uff0c\u540c\u65f6\u53ef\u4ee5\u5728stage\u7684steps\u5757\u4e2d\u5b9a\u4e49\u771f\u6b63\u6267\u884c\u7684\u6307\u4ee4\u3002</p> <p>stages\u90e8\u5206\u662f\u6d41\u6c34\u7ebf\u63cf\u8ff0\u7684\u5927\u90e8\u5206\u5de5\u4f5c\uff08work\uff09\u7684\u4f4d\u7f6e\u3002\u5efa\u8baestages\u81f3\u5c11\u5305\u542b\u4e00\u4e2astage\u6307\u4ee4\uff0c\u7528\u4e8e\u6301\u7eed\u4ea4\u4ed8\u8fc7\u7a0b\u7684\u67d0\u4e2a\u79bb\u6563\u7684\u90e8\u5206\uff0c\u6bd4\u5982\u6784\u5efa\u3001\u6d4b\u8bd5\u6216\u90e8\u7f72\u3002</p> <p>\u6bd4\u5982\u521b\u5efa\u4e00\u4e2a\u6d41\u6c34\u7ebf\uff0cstages\u5305\u542b\u4e00\u4e2a\u540d\u4e3aExample\u7684stage\uff0c\u8be5stage\u6267\u884cecho 'Hello World'\u547d\u4ee4\u8f93\u51faHello World\u5b57\u7b26\u4e32\uff1a</p> <pre><code>//Jenkinsfile (Declarative Pipeline)\npipeline {\n  agent any\n  stages {\n    stage('Example') {\n      steps {\n        echo 'Hello World'\n      }\n    }\n  }\n}\n</code></pre> <p>steps\u90e8\u5206\u5728\u7ed9\u5b9a\u7684stage\u6307\u4ee4\u4e2d\u6267\u884c\u4e00\u4e2a\u6216\u591a\u4e2a\u6b65\u9aa4\uff0c\u6bd4\u5982\u5728steps\u4e2d\u5b9a\u4e49\u6267\u884c\u4e00\u6761shell\u547d\u4ee4\uff1a</p> <pre><code>//Jenkinsfile (Declarative Pipeline)\npipeline {\n  agent any\n  stages {\n    stage('Example') {\n      steps {\n        echo 'Hello World'\n      }\n    }\n  }\n}\n</code></pre> <p>\u6216\u8005\u4e5f\u53ef\u4ee5\u4f7f\u7528sh\u5b57\u6bb5\u6267\u884c\u591a\u6761\u6307\u4ee4\uff1a</p> <pre><code>//Jenkinsfile (Declarative Pipeline)\npipeline {\n  agent any\n  stages {\n    stage('Example') {\n      steps {\n        sh \"\"\"\n           echo 'Hello World1'\n           echo 'Hello World2'\n        \"\"\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#32-directives","title":"3.2 directives","text":"<p>directives\u53ef\u7528\u4e8e\u4e00\u4e9b\u6267\u884cstage\u65f6\u7684\u6761\u4ef6\u5224\u65ad\u6216\u9884\u5904\u7406\u4e00\u4e9b\u6570\u636e\uff0c\u548csections\u4e00\u81f4\u3002directives\u4e0d\u662f\u4e00\u4e2a\u5173\u952e\u5b57\u6216\u6307\u4ee4\uff0c\u800c\u662f\u5305\u542benvironment\u3001options\u3001parameters\u3001triggers\u3001stage\u3001input\u3001when\u7b49\u914d\u7f6e\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#1-environment","title":"1. environment","text":"<p>environment\u4e3b\u8981\u7528\u4e8e\u5728\u6d41\u6c34\u7ebf\u4e2d\u914d\u7f6e\u4e00\u4e9b\u73af\u5883\u53d8\u91cf\uff0c\u6839\u636e\u914d\u7f6e\u7684\u4f4d\u7f6e\u51b3\u5b9a\u73af\u5883\u53d8\u91cf\u7684\u4f5c\u7528\u57df\u3002</p> <p>environment\u53ef\u4ee5\u5b9a\u4e49\u5728pipeline\u4e2d\u4f5c\u4e3a\u5168\u5c40\u53d8\u91cf\uff0c\u4e5f\u53ef\u4ee5\u914d\u7f6e\u5728stage\u4e2d\u4f5c\u4e3a\u8be5stage\u7684\u73af\u5883\u53d8\u91cf\u3002</p> <p>\u8be5\u6307\u4ee4\u652f\u6301\u4e00\u4e2a\u7279\u6b8a\u7684\u65b9\u6cd5credentials()\uff0c\u8be5\u65b9\u6cd5\u53ef\u7528\u4e8e\u5728Jenkins\u73af\u5883\u4e2d\u901a\u8fc7\u6807\u8bc6\u7b26\u8bbf\u95ee\u9884\u5b9a\u4e49\u7684\u51ed\u8bc1\u3002\u5bf9\u4e8e\u7c7b\u578b\u4e3aSecret Text\u7684\u51ed\u8bc1\uff0ccredentials()\u53ef\u4ee5\u5c06\u8be5Secret\u4e2d\u7684\u6587\u672c\u5185\u5bb9\u8d4b\u503c\u7ed9\u73af\u5883\u53d8\u91cf\u3002</p> <p>\u5bf9\u4e8e\u7c7b\u578b\u4e3a\u6807\u51c6\u7684\u8d26\u53f7\u5bc6\u7801\u578b\u7684\u51ed\u8bc1\uff0c\u6307\u5b9a\u7684\u73af\u5883\u53d8\u91cf\u4e3ausername\u548cpassword\uff0c\u5e76\u4e14\u4e5f\u4f1a\u5b9a\u4e49\u4e24\u4e2a\u989d\u5916\u7684\u73af\u5883\u53d8\u91cf\uff0c\u5206\u522b\u4e3aMYVARNAME_USR\u548cMYVARNAME_PSW\u3002</p> <p>\u57fa\u672c\u53d8\u91cf\u4f7f\u7528</p> <pre><code>//\u793a\u4f8b\npipeline {\n  agent any\n  environment {   //\u5168\u5c40\u53d8\u91cf\uff0c\u4f1a\u5728\u6240\u6709stage\u4e2d\u751f\u6548\n    NAME= 'zhangzhuo'\n  }\n  stages {\n    stage('env1') {\n      environment { //\u5b9a\u4e49\u5728stage\u4e2d\u7684\u53d8\u91cf\u53ea\u4f1a\u5728\u5f53\u524dstage\u751f\u6548\uff0c\u5176\u4ed6\u7684stage\u4e0d\u4f1a\u751f\u6548\n        HARBOR = 'https://192.168.10.15'\n      }\n      steps {\n        sh \"env\"\n      }\n    }\n    stage('env2') {\n      steps {\n        sh \"env\"\n      }\n    }\n  }\n}\n</code></pre> <p>\u4f7f\u7528\u53d8\u91cf\u5f15\u7528 secret \u7684\u51ed\u8bc1</p> <pre><code>//\u8fd9\u91cc\u4f7f\u7528k8s\u7684kubeconfig\u6587\u4ef6\u793a\u4f8b\npipeline {\n  agent any\n  environment {\n    KUBECONFIG = credentials('kubernetes-cluster')\n  }\n  stages {\n    stage('env') {\n      steps {\n        sh \"env\"  //\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8f93\u51fa\u7684\u53d8\u91cf\u5185\u5bb9\u4f1a\u88ab\u52a0\u5bc6\n      }\n    }\n  }\n}\n</code></pre> <p>\u4f7f\u7528\u53d8\u91cf\u5f15\u7528\u7c7b\u578b\u4e3a\u6807\u51c6\u7684\u8d26\u53f7\u5bc6\u7801\u578b\u7684\u51ed\u8bc1</p> <p>\u8fd9\u91cc\u4f7f\u7528 HARBOR \u53d8\u91cf\u8fdb\u884c\u6f14\u793a\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8d26\u53f7\u5bc6\u7801\u578b\u7684\u51ed\u8bc1\u4f1a\u81ea\u52a8\u521b\u5efa 3 \u4e2a\u53d8\u91cf</p> <ul> <li>HARBOR_USR:\u4f1a\u628a\u51ed\u8bc1\u4e2d username \u503c\u8d4b\u503c\u7ed9\u8fd9\u4e2a\u53d8\u91cf</li> <li>HARBOR_PSW:\u4f1a\u628a\u51ed\u8bc1\u4e2d password \u503c\u8d4b\u503c\u7ed9\u8fd9\u4e2a\u53d8\u91cf</li> <li>HARBOR:\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8d4b\u503c\u7684\u503c\u4e3a<code>usernamme:password</code></li> </ul> <pre><code>pipeline {\n  agent any\n  environment {\n    HARBOR = credentials('harbor-account')\n  }\n  stages {\n    stage('env') {\n      steps {\n        sh \"env\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#2--options","title":"2.  options","text":"<p>Jenkins \u6d41\u6c34\u7ebf\u652f\u6301\u5f88\u591a\u5185\u7f6e\u6307\u4ee4\uff0c\u6bd4\u5982 retry \u53ef\u4ee5\u5bf9\u5931\u8d25\u7684\u6b65\u9aa4\u8fdb\u884c\u91cd\u590d\u6267\u884c n \u6b21\uff0c\u53ef\u4ee5\u6839\u636e\u4e0d\u540c\u7684\u6307\u4ee4\u5b9e\u73b0\u4e0d\u540c\u7684\u6548\u679c\u3002\u6bd4\u8f83\u5e38\u7528\u7684\u6307\u4ee4\u5982\u4e0b:</p> <ul> <li> <p>buildDiscarder\uff1a\u4fdd\u7559\u591a\u5c11\u4e2a\u6d41\u6c34\u7ebf\u7684\u6784\u5efa\u8bb0\u5f55\uff0c\u6bd4\u5982options {buildDiscarder(logRotator(num?oKeepStr: '1'))}\u3002</p> </li> <li> <p>disableConcurrentBuilds\uff1a\u7981\u6b62\u6d41\u6c34\u7ebf\u5e76\u884c\u6267\u884c\uff0c\u9632\u6b62\u5e76\u884c\u6d41\u6c34\u7ebf\u540c\u65f6\u8bbf\u95ee\u5171\u4eab\u8d44\u6e90\u5bfc\u81f4\u6d41\u6c34\u7ebf\u5931 \u8d25,\u6bd4\u5982options {disableConcurrentBuilds() }\u3002</p> </li> <li> <p>disableResume \uff1a\u5982\u679c\u63a7\u5236\u5668\u91cd\u542f\uff0c\u7981\u6b62\u6d41\u6c34\u7ebf\u81ea\u52a8\u6062\u590d\u3002\u6bd4\u5982options { disableResume() }\u3002</p> </li> <li> <p>newContainerPerStage\uff1aagent \u4e3a docker \u6216 dockerfile \u65f6\uff0c\u6bcf\u4e2a\u9636\u6bb5\u5c06\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u7684\u65b0\u5bb9\u5668\u4e2d\u8fd0\u884c\uff0c\u800c\u4e0d\u662f\u6240\u6709\u7684\u9636\u6bb5\u90fd\u5728\u540c\u4e00\u4e2a\u5bb9\u5668\u4e2d\u8fd0\u884c\u3002\u6bd4\u5982options { newContainerPerStage () }\u3002</p> </li> <li> <p>quietPeriod\uff1a\u6d41\u6c34\u7ebf\u9759\u9ed8\u671f\uff0c\u4e5f\u5c31\u662f\u89e6\u53d1\u6d41\u6c34\u7ebf\u540e\u7b49\u5f85\u4e00\u4f1a\u5728\u6267\u884c\u3002\u6bd4\u5982options{ quietPeriod(30) }\u3002</p> </li> <li> <p>retry\uff1a\u6d41\u6c34\u7ebf\u5931\u8d25\u540e\u91cd\u8bd5\u6b21\u6570\uff0c\u6bd4\u5982options { retry(3) }\u3002</p> </li> <li> <p>timeout\uff1a\u8bbe\u7f6e\u6d41\u6c34\u7ebf\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u8d85\u8fc7\u6d41\u6c34\u7ebf\u65f6\u95f4\uff0cjob \u4f1a\u81ea\u52a8\u7ec8\u6b62\u3002\u5982\u679c\u4e0d\u52a0 unit \u53c2\u6570\u9ed8\u8ba4\u4e3a 1 \u5206,\u6bd4\u5982options{ timeout(time: 1, unit: 'HOURS') }\u3002</p> </li> <li> <p>skipDefaultCheckout\uff1a\u8df3\u8fc7checkout scm\u8bed\u53e5\uff0c\u6bd4\u5982options {skipDefaultCheckout () }\u3002</p> </li> <li> <p>timestamps\uff1a\u4e3a\u63a7\u5236\u53f0\u8f93\u51fa\u65f6\u95f4\u6233, \u6bd4\u5982options { timestamps()}\u3002</p> </li> <li> <p>checkoutToSubdirectory \u6307\u5b9a\u4ee3\u7801\u68c0\u51fa\u5230 <code>$WORKSPACE</code>\u7684\u5b50\u76ee\u5f55\u3002</p> </li> </ul> <pre><code>options {\n      checkoutToSubdirectory('testdir')\n}\n</code></pre> <p>\u5e38\u7528\u6c47\u603b\uff1a</p> <pre><code>options {\n        timestamps()\n        disableConcurrentBuilds()\n        timeout(time: 10, unit: 'MINUTES')\n    buildDiscarder(logRotator(numToKeepStr: '10'))\n}\n</code></pre> <p>\u914d\u7f6e\u793a\u4f8b\u5982\u4e0b\uff0c\u53ea\u9700\u8981\u6dfb\u52a0options\u5b57\u6bb5\u5373\u53ef\uff1a</p> <p>\u5b9a\u4e49\u5728 pipeline \u4e2d</p> <pre><code>pipeline {\n  agent any\n  options {\n    timeout(time: 1, unit: 'HOURS')  //\u8d85\u65f6\u65f6\u95f41\u5c0f\u65f6\uff0c\u5982\u679c\u4e0d\u52a0unit\u53c2\u6570\u9ed8\u8ba4\u4e3a1\u5206\n    timestamps()                     //\u6240\u6709\u8f93\u51fa\u6bcf\u884c\u90fd\u4f1a\u6253\u5370\u65f6\u95f4\u6233\n    buildDiscarder(logRotator(numToKeepStr: '3')) //\u4fdd\u7559\u4e09\u4e2a\u5386\u53f2\u6784\u5efa\u7248\u672c\n    quietPeriod(10)  //\u6ce8\u610f\u624b\u52a8\u89e6\u53d1\u7684\u6784\u5efa\u4e0d\u751f\u6548\n    retry(3)    //\u6d41\u6c34\u7ebf\u5931\u8d25\u540e\u91cd\u8bd5\u6b21\u6570\n  }\n  stages {\n    stage('env1') {\n      steps {\n        sh \"env\"\n        sleep 2\n      }\n    }\n    stage('env2') {\n      steps {\n        sh \"env\"\n      }\n    }\n  }\n}\n</code></pre> <p>\u5b9a\u4e49\u5728 stage \u4e2d</p> <p>Option \u9664\u4e86\u5199\u5728 Pipeline \u9876\u5c42\uff0c\u8fd8\u53ef\u4ee5\u5199\u5728 stage \u4e2d\uff0c\u4f46\u662f\u5199\u5728 stage \u4e2d\u7684 option \u4ec5\u652f\u6301 retry\u3001 timeout\u3001timestamps\uff0c\u6216\u8005\u662f\u548c stage \u76f8\u5173\u7684\u58f0\u660e\u5f0f\u9009\u9879\uff0c\u6bd4\u5982 skipDefaultCheckout\u3002\u5904\u4e8e stage \u7ea7\u522b\u7684 options \u5199\u6cd5\u5982\u4e0b</p> <pre><code>pipeline {\n  agent any\n  stages {\n    stage('env1') {\n      options {   //\u5b9a\u4e49\u5728\u8fd9\u91cc\u8fd9\u5bf9\u8fd9\u4e2astage\u751f\u6548\n        timeout(time: 2, unit: 'SECONDS') //\u8d85\u65f6\u65f6\u95f42\u79d2\n        timestamps()                     //\u6240\u6709\u8f93\u51fa\u6bcf\u884c\u90fd\u4f1a\u6253\u5370\u65f6\u95f4\u6233\n        retry(3)    //\u6d41\u6c34\u7ebf\u5931\u8d25\u540e\u91cd\u8bd5\u6b21\u6570\n      }\n      steps {\n        sh \"env &amp;&amp; sleep 2\"\n      }\n    }\n    stage('env2') {\n      steps {\n        sh \"env\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#3-parameters","title":"3. parameters","text":"<p>parameters\u63d0\u4f9b\u4e86\u4e00\u4e2a\u7528\u6237\u5728\u89e6\u53d1\u6d41\u6c34\u7ebf\u65f6\u5e94\u8be5\u63d0\u4f9b\u7684\u53c2\u6570\u5217\u8868\uff0c\u8fd9\u4e9b\u7528\u6237\u6307\u5b9a\u53c2\u6570\u7684\u503c\u53ef\u4ee5\u901a\u8fc7params\u5bf9\u8c61\u63d0\u4f9b\u7ed9\u6d41\u6c34\u7ebf\u7684step\uff08\u6b65\u9aa4\uff09\u3002</p> <p>\u76ee\u524d\u652f\u6301\u7684\u53c2\u6570\u7c7b\u578b\u5982\u4e0b\uff1a</p> <ul> <li>string\uff1a\u5b57\u7b26\u4e32\u7c7b\u578b\u7684\u53c2\u6570\u3002</li> </ul> <pre><code>parameters { string(name:'DEPLOY_ENV', defaultValue:'staging', description: '') }\n\n// \u8868\u793a\u5b9a\u4e49\u4e00\u4e2a\u540d\u4e3aDEPLOY_ENV\u7684\u5b57\u7b26\u578b\u53d8\u91cf\uff0c\u9ed8\u8ba4\u503c\u4e3astaging\u3002\n</code></pre> <ul> <li>text\uff1a\u6587\u672c\u578b\u53c2\u6570\uff0c\u4e00\u822c\u7528\u4e8e\u5b9a\u4e49\u591a\u884c\u6587\u672c\u5185\u5bb9\u7684\u53d8\u91cf\u3002</li> </ul> <pre><code>parameters {text(name:'DEPLOY_TEXT', defaultValue:'One\\nTwo\\nThree\\n',\ndescription: '')}\n\n// \u8868\u793a\u5b9a\u4e49\u4e00\u4e2a\u540d\u4e3aDEPLOY_TEXT\u7684\u53d8\u91cf\uff0c\u9ed8\u8ba4\u503c\u662f'One\\nTwo\\nThree\\n'\n</code></pre> <ul> <li>booleanParam\uff1a\u5e03\u5c14\u578b\u53c2\u6570\u3002</li> </ul> <pre><code>parameters {booleanParam(name:  'DEBUG_BUILD',defaultValue:  true,description: '')}\n</code></pre> <ul> <li>choice\uff1a\u9009\u62e9\u578b\u53c2\u6570\uff0c\u4e00\u822c\u7528\u4e8e\u7ed9\u5b9a\u51e0\u4e2a\u53ef\u9009\u7684\u503c\uff0c\u7136\u540e\u9009\u62e9\u5176\u4e2d\u4e00\u4e2a\u8fdb\u884c\u8d4b\u503c\u3002</li> </ul> <pre><code>parameters { choice(name: 'CHOICES',choices: ['one', 'two', 'three'], description: '') }\n\n// \u8868\u793a\u5b9a\u4e49\u4e00\u4e2a\u540d\u4e3aCHOICES\u7684\u53d8\u91cf\uff0c\u53ef\u9009\u7684\u503c\u4e3aone\u3001two\u3001three\u3002\n</code></pre> <ul> <li>password\uff1a\u5bc6\u7801\u578b\u53d8\u91cf\uff0c\u4e00\u822c\u7528\u4e8e\u5b9a\u4e49\u654f\u611f\u578b\u53d8\u91cf\uff0c\u5728 Jenkins \u63a7\u5236\u53f0\u4f1a\u8f93\u51fa\u4e3a*\u3002</li> </ul> <pre><code>parameters { password(name: 'PASSWORD',defaultValue: 'SECRET', description: 'A secret password')}\n\n// \u8868\u793a\u5b9a\u4e49\u4e00\u4e2a\u540d\u4e3aPASSWORD\u7684\u53d8\u91cf\uff0c\u5176\u9ed8\u8ba4\u503c\u4e3aSECRE?\u3002\n</code></pre> <p>\u63d2\u4ef6 Parameters</p> <ul> <li>imageTag\uff1a\u955c\u50cf tag\uff0c\u9700\u8981\u5b89\u88c5 Image Tag Parameter \u63d2\u4ef6\u540e\u4f7f\u7528</li> <li>gitParameter\uff1a\u83b7\u53d6 git \u4ed3\u5e93\u5206\u652f\uff0c\u9700\u8981 Git Parameter \u63d2\u4ef6\u540e\u4f7f\u7528</li> </ul> <p>\u793a\u4f8b</p> <pre><code>pipeline {\n  agent any\n  parameters {\n    string(name: 'DEPLOY_ENV', defaultValue:  'staging', description: '1')   //\u6267\u884c\u6784\u5efa\u65f6\u9700\u8981\u624b\u52a8\u914d\u7f6e\u5b57\u7b26\u4e32\u7c7b\u578b\u53c2\u6570\uff0c\u4e4b\u540e\u8d4b\u503c\u7ed9\u53d8\u91cf\n    text(name:  'DEPLOY_TEXT', defaultValue: 'One\\nTwo\\nThree\\n', description: '2')  //\u6267\u884c\u6784\u5efa\u65f6\u9700\u8981\u63d0\u4f9b\u6587\u672c\u53c2\u6570\uff0c\u4e4b\u540e\u8d4b\u503c\u7ed9\u53d8\u91cf\n    booleanParam(name: 'DEBUG_BUILD',  defaultValue: true, description: '3')   //\u5e03\u5c14\u578b\u53c2\u6570\n    choice(name: 'CHOICES', choices: ['one', 'two', 'three'], description: '4')  //\u9009\u62e9\u5f62\u5f0f\u5217\u8868\u53c2\u6570\n    password(name: 'PASSWORD', defaultValue: 'SECRET', description: 'A  secret password')  //\u5bc6\u7801\u7c7b\u578b\u53c2\u6570\uff0c\u4f1a\u8fdb\u884c\u52a0\u5bc6\n    imageTag(name: 'DOCKER_IMAGE', description: '', image: 'kubernetes/kubectl', filter: '.*', defaultTag: '', registry: 'https://192.168.10.15', credentialId: 'harbor-account', tagOrder: 'NATURAL')   //\u83b7\u53d6\u955c\u50cf\u540d\u79f0\u4e0etag\n    gitParameter(branch: '', branchFilter: 'origin/(.*)', defaultValue: '', description: 'Branch for build and deploy', name: 'BRANCH', quickFilterEnabled: false, selectedValue: 'NONE', sortMode: 'NONE',  tagFilter: '*', type: 'PT_BRANCH')\n  }  //\u83b7\u53d6git\u4ed3\u5e93\u5206\u652f\u5217\u8868\uff0c\u5fc5\u987b\u6709git\u5f15\u7528\n  stages {\n    stage('env1') {\n      steps {\n        sh \"env\"\n      }\n    }\n    stage('git') {\n      steps {\n        git branch: \"$BRANCH\", credentialsId: 'gitlab-key', url: 'git@192.168.10.14:root/env.git'   //\u4f7f\u7528gitParameter\uff0c\u5fc5\u987b\u6709\u8fd9\u4e2a\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#4-triggers","title":"4. triggers","text":"<p>\u5728pipeline\u4e2d\u53ef\u4ee5\u7528triggers\u5b9e\u73b0\u81ea\u52a8\u89e6\u53d1\u6d41\u6c34\u7ebf\u6267\u884c\u4efb\u52a1\uff0c\u53ef\u4ee5\u901a\u8fc7Webhook\u3001Cron\u3001pollSCM\u548cupstream\u7b49\u65b9\u5f0f\u89e6\u53d1\u6d41\u6c34\u7ebf\u3002</p> <p>\u5047\u5982\u67d0\u4e2a\u6d41\u6c34\u7ebf\u6784\u5efa\u7684\u65f6\u95f4\u6bd4\u8f83\u957f\uff0c\u6216\u8005\u67d0\u4e2a\u6d41\u6c34\u7ebf\u9700\u8981\u5b9a\u671f\u5728\u67d0\u4e2a\u65f6 \u95f4\u6bb5\u6267\u884c\u6784\u5efa\uff0c\u53ef\u4ee5\u4f7f\u7528cron\u914d\u7f6e\u89e6\u53d1\u5668\uff0c\u6bd4\u5982\u5468\u4e00\u5230\u5468\u4e94\u6bcf\u96944\u4e2a\u5c0f\u65f6\u6267\u884c\u4e00\u6b21\uff1a</p> <p>Cron</p> <p>\u5b9a\u65f6\u6784\u5efa\u5047\u5982\u67d0\u4e2a\u6d41\u6c34\u7ebf\u6784\u5efa\u7684\u65f6\u95f4\u6bd4\u8f83\u957f\uff0c\u6216\u8005\u67d0\u4e2a\u6d41\u6c34\u7ebf\u9700\u8981\u5b9a\u671f\u5728\u67d0\u4e2a\u65f6\u95f4\u6bb5\u6267\u884c\u6784\u5efa\uff0c\u53ef\u4ee5 \u4f7f\u7528 cron \u914d\u7f6e\u89e6\u53d1\u5668\uff0c\u6bd4\u5982\u5468\u4e00\u5230\u5468\u4e94\u6bcf\u9694\u56db\u4e2a\u5c0f\u65f6\u6267\u884c\u4e00\u6b21</p> <p>\u6ce8\u610f\uff1aH \u7684\u610f\u601d\u4e0d\u662f HOURS \u7684\u610f\u601d\uff0c\u800c\u662f Hash \u7684\u7f29\u5199\u3002\u4e3b\u8981\u4e3a\u4e86\u89e3\u51b3\u591a\u4e2a\u6d41\u6c34\u7ebf\u5728\u540c\u4e00\u65f6\u95f4\u540c\u65f6\u8fd0\u884c\u5e26\u6765\u7684\u7cfb\u7edf\u8d1f\u8f7d\u538b\u529b\u3002</p> <pre><code>pipeline {\n  agent any\n  triggers {\n    cron('H */4 * * 1-5')   //\u5468\u4e00\u5230\u5468\u4e94\u6bcf\u9694\u56db\u4e2a\u5c0f\u65f6\u6267\u884c\u4e00\u6b21\n    cron('H/12 * * * *')   //\u6bcf\u969412\u5206\u949f\u6267\u884c\u4e00\u6b21\n    cron('H * * * *')   //\u6bcf\u96941\u5c0f\u65f6\u6267\u884c\u4e00\u6b21\n  }\n  stages {\n    stage('Example') {\n      steps {\n        echo 'Hello World'\n      }\n    }\n  }\n}\n</code></pre> <p>\u4f7f\u7528cron\u5b57\u6bb5\u53ef\u4ee5\u5b9a\u671f\u6267\u884c\u6d41\u6c34\u7ebf\uff0c\u5982\u679c\u4ee3\u7801\u66f4\u65b0\uff0c\u60f3\u8981\u91cd\u65b0\u89e6\u53d1\u6d41\u6c34\u7ebf\uff0c\u53ef\u4ee5\u4f7f\u7528pollSCM\u5b57\u6bb5\uff1a</p> <pre><code>pipeline {\n  agent any\n  triggers {\n    POLLscm('H */4 * * 1-5')\n  }\n  stages {\n    stage('Example') {\n      steps {\n        echo 'Hello World'\n      }\n    }\n  }\n}\n</code></pre> <p>Upstream</p> <p>Upstream \u53ef\u4ee5\u6839\u636e\u4e0a\u6e38 job \u7684\u6267\u884c\u7ed3\u679c\u51b3\u5b9a\u662f\u5426\u89e6\u53d1\u8be5\u6d41\u6c34\u7ebf\u3002\u6bd4\u5982\u5f53 job1 \u6216 job2 \u6267\u884c\u6210\u529f\u65f6\u89e6\u53d1\u8be5\u6d41\u6c34\u7ebf</p> <p>\u76ee\u524d\u652f\u6301\u7684\u72b6\u6001\u6709 SUCCESS\u3001UNSTABLE\u3001FAILURE\u3001NOT_BUILT\u3001ABORTED \u7b49\u3002</p> <pre><code>pipeline {\n  agent any\n  triggers {\n    upstream(upstreamProjects: 'env', threshold: hudson.model.Result.SUCCESS)  //\u5f53env\u6784\u5efa\u6210\u529f\u65f6\u6784\u5efa\u8fd9\u4e2a\u6d41\u6c34\u7ebf\n  }\n  stages {\n    stage('Example') {\n      steps {\n        echo 'Hello World'\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#5-stage","title":"5. stage","text":"<p>stage\u6307\u4ee4\u4f4d\u4e8estages\u4e0b\uff0c\u5305\u542b\u4e00\u4e2asteps\u3001\u4e00\u4e2aagent\uff08\u53ef\u9009\uff09\u6216\u5176\u4ed6\u7279\u5b9a\u7684stage\u6307\u4ee4\u3002</p> <p>\u6d41\u6c34\u7ebf\u4e2d\u5b9e\u9645\u6267\u884c\u7684\u6307\u4ee4\u90fd\u5728stage\u4e2d\u914d\u7f6e\uff0c\u6240\u4ee5\u5728\u6d41\u6c34\u7ebf\u4e2d\uff0c\u81f3\u5c11\u6709\u4e00\u4e2astage\u3002\u914d\u7f6e\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>pipeline {\n  agent any\n  stages {\n    stage('Example') {\n      steps {\n        echo 'Hello World'\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#6-input","title":"6. Input","text":"<p>Input \u5b57\u6bb5\u53ef\u4ee5\u5b9e\u73b0\u5728\u6d41\u6c34\u7ebf\u4e2d\u8fdb\u884c\u4ea4\u4e92\u5f0f\u64cd\u4f5c\uff0c\u6bd4\u5982\u9009\u62e9\u8981\u90e8\u7f72\u7684\u73af\u5883\u3001\u662f\u5426\u7ee7\u7eed\u6267\u884c\u67d0\u4e2a\u9636\u6bb5\u7b49\u3002</p> <p>\u914d\u7f6e Input \u652f\u6301\u4ee5\u4e0b\u9009\u9879</p> <ul> <li>message\uff1a\u5fc5\u9009\uff0c\u9700\u8981\u7528\u6237\u8fdb\u884c input \u7684\u63d0\u793a\u4fe1\u606f\uff0c\u6bd4\u5982\uff1a\u201c\u662f\u5426\u53d1\u5e03\u5230\u751f\u4ea7\u73af\u5883\uff1f\u201d\uff1b</li> <li>id\uff1a\u53ef\u9009\uff0cinput \u7684\u6807\u8bc6\u7b26\uff0c\u9ed8\u8ba4\u4e3a stage \u7684\u540d\u79f0\uff1b</li> <li>ok\uff1a\u53ef\u9009\uff0c\u786e\u8ba4\u6309\u94ae\u7684\u663e\u793a\u4fe1\u606f\uff0c\u6bd4\u5982\uff1a\u201c\u786e\u5b9a\u201d\u3001\u201c\u5141\u8bb8\u201d\uff1b</li> <li>submitter\uff1a\u53ef\u9009\uff0c\u5141\u8bb8\u63d0\u4ea4 input \u64cd\u4f5c\u7684\u7528\u6237\u6216\u7ec4\u7684\u540d\u79f0\uff0c\u5982\u679c\u4e3a\u7a7a\uff0c\u4efb\u4f55\u767b\u5f55\u7528\u6237\u5747\u53ef\u63d0\u4ea4 input\uff1b</li> <li>parameters\uff1a\u63d0\u4f9b\u4e00\u4e2a\u53c2\u6570\u5217\u8868\u4f9b input \u4f7f\u7528\u3002</li> </ul> <p>\u5047\u5982\u9700\u8981\u914d\u7f6e\u4e00\u4e2a\u63d0\u793a\u6d88\u606f\u4e3a\u201c\u8fd8\u7ee7\u7eed\u4e48\u201d\u3001\u786e\u8ba4\u6309\u94ae\u4e3a\u201c\u7ee7\u7eed\u201d\u3001\u63d0\u4f9b\u4e00\u4e2a PERSON \u7684\u53d8\u91cf\u7684\u53c2\u6570\uff0c\u5e76\u4e14\u53ea\u80fd\u7531\u767b\u5f55\u7528\u6237\u4e3a alice \u548c bob \u63d0\u4ea4\u7684 input \u6d41\u6c34\u7ebf</p> <pre><code>pipeline {\n  agent any\n  stages {\n    stage('Example') {\n      input {\n        message \"\u8fd8\u7ee7\u7eed\u4e48?\"\n        ok \"\u7ee7\u7eed\"\n        submitter \"alice,bob\"\n        parameters {\n          string(name: 'PERSON', defaultValue: 'Mr Jenkins', description: 'Who should I say hello to?')\n        }\n      }\n      steps {\n        echo \"Hello, ${PERSON}, nice to meet you.\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#7-when","title":"7. when","text":"<p>When \u6307\u4ee4\u5141\u8bb8\u6d41\u6c34\u7ebf\u6839\u636e\u7ed9\u5b9a\u7684\u6761\u4ef6\u51b3\u5b9a\u662f\u5426\u5e94\u8be5\u6267\u884c\u8be5 stage\uff0cwhen \u6307\u4ee4\u5fc5\u987b\u5305\u542b\u81f3\u5c11 \u4e00\u4e2a\u6761\u4ef6\u3002\u5982\u679c when \u5305\u542b\u591a\u4e2a\u6761\u4ef6\uff0c\u6240\u6709\u7684\u5b50\u6761\u4ef6\u5fc5\u987b\u90fd\u8fd4\u56de True\uff0cstage \u624d\u80fd\u6267\u884c\u3002</p> <p>When \u4e5f\u53ef\u4ee5\u7ed3\u5408 not\u3001allOf\u3001anyOf \u8bed\u6cd5\u8fbe\u5230\u66f4\u7075\u6d3b\u7684\u6761\u4ef6\u5339\u914d\u3002</p> <p>\u76ee\u524d\u6bd4\u8f83\u5e38\u7528\u7684\u5185\u7f6e\u6761\u4ef6\u5982\u4e0b</p> <ul> <li> <p>branch\uff1a\u5f53\u6b63\u5728\u6784\u5efa\u7684\u5206\u652f\u4e0e\u7ed9\u5b9a\u7684\u5206\u652f\u5339\u914d\u65f6\uff0c\u6267\u884c\u8fd9\u4e2a stage\uff0c\u4f8b\u5982when { branch'master' }\u3002\u6ce8\u610f\uff0cbranch \u53ea\u9002\u7528\u4e8e\u591a\u5206\u652f\u6d41\u6c34\u7ebf\u3002</p> </li> <li> <p>changelog\uff1a\u5339\u914d\u63d0\u4ea4\u7684 changeLog \u51b3\u5b9a\u662f\u5426\u6784\u5efa\uff0c\u4f8b\u5982:<code>when { changelog '.*^\\\\[DEPENDENCY\\\\] .+$' }</code></p> </li> <li> <p>environment\uff1a\u5f53\u6307\u5b9a\u7684\u73af\u5883\u53d8\u91cf\u548c\u7ed9\u5b9a\u7684\u53d8\u91cf\u5339\u914d\u65f6\uff0c\u6267\u884c\u8fd9\u4e2a stage\uff0c\u4f8b\u5982\uff1awhen { environment name: 'DEPLOY_TO', value: 'production' }\u3002</p> </li> <li> <p>equals\uff1a\u5f53\u671f\u671b\u503c\u548c\u5b9e\u9645\u503c\u76f8\u540c\u65f6\uff0c\u6267\u884c\u8fd9\u4e2a stage\uff0c\u4f8b\u5982\uff1awhen { equals expected: 2, actual: currentBuild.number }\u3002</p> </li> <li> <p>expression\uff1a\u5f53\u6307\u5b9a\u7684 Groovy \u8868\u8fbe\u5f0f\u8bc4\u4f30\u4e3a True\uff0c\u6267\u884c\u8fd9\u4e2a stage\uff0c\u4f8b\u5982\uff1awhen { expression { return params.DEBUG_BUILD } }\u3002</p> </li> <li> <p>tag\uff1a\u5982\u679c TAG_NAME \u7684\u503c\u548c\u7ed9\u5b9a\u7684\u6761\u4ef6\u5339\u914d\uff0c\u6267\u884c\u8fd9\u4e2a stage\uff0c\u4f8b\u5982\uff1awhen { tag \"release-*\" }\u3002</p> </li> <li> <p>not\uff1a\u5f53\u5d4c\u5957\u6761\u4ef6\u51fa\u73b0\u9519\u8bef\u65f6\uff0c\u6267\u884c\u8fd9\u4e2a stage\uff0c\u5fc5\u987b\u5305\u542b\u4e00\u4e2a\u6761\u4ef6\uff0c\u4f8b\u5982\uff1awhen { not { branch 'master' } }\u3002</p> </li> <li> <p>allOf\uff1a\u5f53\u6240\u6709\u7684\u5d4c\u5957\u6761\u4ef6\u90fd\u6b63\u786e\u65f6\uff0c\u6267\u884c\u8fd9\u4e2a stage\uff0c\u5fc5\u987b\u5305\u542b\u81f3\u5c11\u4e00\u4e2a\u6761\u4ef6\uff0c\u4f8b\u5982\uff1awhen { allOf { branch 'master'; environment name: 'DEPLOY_TO', value: 'production' } }\u3002</p> </li> <li> <p>anyOf\uff1a\u5f53\u81f3\u5c11\u6709\u4e00\u4e2a\u5d4c\u5957\u6761\u4ef6\u4e3a True \u65f6\uff0c\u6267\u884c\u8fd9\u4e2a stage\uff0c\u4f8b\u5982\uff1awhen { anyOf { branch 'master'; branch 'staging' } }\u3002</p> </li> </ul> <p>\u793a\u4f8b\uff1a\u5f53\u5206\u652f\u4e3a main \u65f6\u6267\u884c Example Deploy \u6b65\u9aa4</p> <pre><code>pipeline {\n  agent any\n  stages {\n    stage('Example Build') {\n      steps {\n        echo 'Hello World'\n      }\n    }\n    stage('Example Deploy') {\n      when {\n        branch 'main' //\u591a\u5206\u652f\u6d41\u6c34\u7ebf\uff0c\u5206\u652f\u4e3a\u624d\u4f1a\u6267\u884c\u3002\n      }\n      steps {\n        echo 'Deploying'\n      }\n    }\n  }\n}\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u540c\u65f6\u914d\u7f6e\u591a\u4e2a\u6761\u4ef6\uff0c\u6bd4\u5982\u5206\u652f\u662f production\uff0c\u800c\u4e14 DEPLOY_TO \u53d8\u91cf\u7684\u503c\u4e3a main \u65f6\uff0c\u624d\u6267\u884c Example Deploy</p> <pre><code>pipeline {\n  agent any\n  environment {\n    DEPLOY_TO = \"main\"\n  }\n  stages {\n    stage('Example Deploy') {\n      when {\n        branch 'production'\n        environment name: 'DEPLOY_TO', value: 'main'\n      }\n      steps {\n        echo 'Deploying'\n      }\n    }\n  }\n}\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u4f7f\u7528 anyOf \u8fdb\u884c\u5339\u914d\u5176\u4e2d\u4e00\u4e2a\u6761\u4ef6\u5373\u53ef\uff0c\u6bd4\u5982\u5206\u652f\u4e3a main \u6216 DEPLOY_TO \u4e3a main \u6216 master \u65f6\u6267\u884c Deploy</p> <pre><code>pipeline {\n  agent any\n  stages {\n    stage('Example Deploy') {\n      when {\n        anyOf {\n          branch 'main'\n          environment name: 'DEPLOY_TO', value: 'main'\n          environment name: 'DEPLOY_TO', value: 'master'\n        }\n      }\n      steps {\n        echo 'Deploying'\n      }\n    }\n  }\n}\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u4f7f\u7528 expression \u8fdb\u884c\u6b63\u5219\u5339\u914d\uff0c\u6bd4\u5982\u5f53 BRANCH_NAME \u4e3a main \u6216 master\uff0c\u5e76\u4e14 DEPLOY_TO \u4e3a master \u6216 main \u65f6\u624d\u4f1a\u6267\u884c Example Deploy</p> <pre><code>pipeline {\n  agent any\n  stages {\n    stage('Example Deploy') {\n      when {\n        expression { BRANCH_NAME ==~ /(main|master)/ }\n        anyOf {\n          environment name: 'DEPLOY_TO', value: 'main'\n          environment name: 'DEPLOY_TO', value: 'master'\n        }\n      }\n      steps {\n        echo 'Deploying'\n      }\n    }\n  }\n}\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u5b9a\u4e49\u4e86\u67d0\u4e2a stage \u7684 agent\uff0c\u5728\u8fdb\u5165\u8be5 stage \u7684 agent \u540e\uff0c\u8be5 stage \u7684 when \u6761\u4ef6\u624d\u4f1a\u88ab\u8bc4\u4f30\uff0c\u4f46\u662f\u53ef\u4ee5\u901a\u8fc7\u4e00\u4e9b\u9009\u9879\u66f4\u6539\u6b64\u9009\u9879\u3002</p> <p>\u6bd4\u5982\u5728\u8fdb\u5165stage\u7684agent \u524d\u8bc4\u4f30when\uff0c \u53ef\u4ee5\u4f7f\u7528 beforeAgent\uff0c\u5f53when\u4e3atrue\u65f6\u624d\u8fdb\u884c\u8be5 stage</p> <p>\u76ee\u524d\u652f\u6301\u7684\u524d\u7f6e\u6761\u4ef6\u5982\u4e0b</p> <ul> <li>beforeAgent\uff1a\u5982\u679c beforeAgent \u4e3a true\uff0c\u5219\u4f1a\u5148\u8bc4\u4f30 when \u6761\u4ef6\u3002\u5728 when \u6761\u4ef6\u4e3a true \u65f6\uff0c\u624d\u4f1a\u8fdb\u5165\u8be5 stage</li> <li>beforeInput\uff1a\u5982\u679c beforeInput \u4e3a true\uff0c\u5219\u4f1a\u5148\u8bc4\u4f30 when \u6761\u4ef6\u3002\u5728 when \u6761\u4ef6\u4e3a true \u65f6\uff0c\u624d\u4f1a\u8fdb\u5165\u5230 input \u9636\u6bb5\uff1b</li> <li>beforeOptions\uff1a\u5982\u679c beforeInput \u4e3a true\uff0c\u5219\u4f1a\u5148\u8bc4\u4f30 when \u6761\u4ef6\u3002\u5728 when \u6761\u4ef6\u4e3a true \u65f6\uff0c\u624d\u4f1a\u8fdb\u5165\u5230 options \u9636\u6bb5\uff1b</li> </ul> <p>beforeOptions \u4f18\u5148\u7ea7\u5927\u4e8e beforeInput \u5927\u4e8e beforeAgent</p> <p>\u793a\u4f8b1\uff1a\u914d\u7f6e\u4e00\u4e2abeforeAgent\u3002</p> <pre><code>pipeline {\n  agent none\n  stages {\n    stage('Example Build') {\n      steps {\n        echo 'Hello World'\n      }\n    }\n    stage('Example Deploy') {\n      when {\n        beforeAgent true\n        branch 'production'\n      }\n      steps {\n        echo 'Deploying'\n      }\n    }\n  }\n}\n</code></pre> <p>\u793a\u4f8b2\uff1a\u914d\u7f6e\u4e00\u4e2abeforeInput\u3002</p> <pre><code>pipeline {\n  agent none\n  stages {\n    stage('Example Build') {\n      steps {\n        echo 'Hello World'\n      }\n    }\n    stage('Example Deploy') {\n      when {\n        beforeInput true\n        branch 'production'\n      }\n      input {\n        message \"Deploy to production?\"\n        id \"simple-input\"\n      }\n      steps {\n        echo 'Deploying'\n      }\n    }\n  }\n}\n</code></pre> <p>\u793a\u4f8b3\uff1a\u914d\u7f6e\u4e00\u4e2abeforeOptions\u3002</p> <pre><code>pipeline {\n  agent none\n  stages {\n    stage('Example Build') {\n      steps {\n        echo 'Hello World'\n      }\n    }\n    stage('Example Deploy') {\n      when {\n        beforeOptions true\n        branch 'testing'\n      }\n      options {\n        lock label: 'testing-deploy-envs',quantity: 1, variable: 'deployEnv'    \n        }\n      steps {\n        echo 'Deploying'\n      }\n    }\n  }\n}\n</code></pre> <p>steps\u5305\u542b\u4e00\u4e2a\u5b8c\u6574\u7684script\u6b65\u9aa4\u5217\u8868\uff0c\u662f\u6d41\u6c34\u7ebf\u771f\u6b63\u6307\u5b9a\u64cd\u4f5c\u7684\u4f4d\u7f6e\uff0c \u6bd4\u5982\u6784\u5efa\u547d\u4ee4\u3001\u90e8\u7f72\u547d\u4ee4\u7b49\u3002script\u6b65\u9aa4\u9700\u8981scripted-pipeline\u5757\u5e76\u5728\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u4e2d\u6267\u884c\uff0c\u5bf9\u4e8e\u5927\u591a\u6570\u7528\u4f8b\u6765\u8bf4\uff0cscript\u6b65\u9aa4\u5e76\u4e0d\u662f\u5fc5\u8981\u7684</p> <p>\u53ef\u4ee5\u5728steps\u4e2d\u6dfb\u52a0script\u8fdb\u884cfor\u5faa\u73af\uff0c\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>pipeline {\n  agent any\n  stages {\n    stage('Example') {\n      steps {\n        echo 'Hello World'\n\n        script {\n            def browsers = ['chrome','firefox']\n            for (int i =0; i &lt; browsers.size(); ++i) {\n                echo \"Testing the ${browsers[i]} browsers \"\n            }\n         }   \n       }\n     }\n  } \n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#33-parallel","title":"3.3 parallel","text":"<p>\u5728\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u4e2d\u53ef\u4ee5\u4f7f\u7528 Parallel \u5b57\u6bb5\uff0c\u5373\u53ef\u5f88\u65b9\u4fbf\u7684\u5b9e\u73b0\u5e76\u53d1\u6784\u5efa\uff0c\u6bd4\u5982\u5bf9\u5206\u652f A\u3001B\u3001 C \u8fdb\u884c\u5e76\u884c\u5904\u7406</p> <pre><code>pipeline {\n  agent any\n  stages {\n    stage('Non-Parallel Stage') {\n      steps {\n        echo 'This stage will be executed first.'\n      }\n    }\n    stage('Parallel Stage') {\n      failFast true         //\u8868\u793a\u5176\u4e2d\u53ea\u8981\u6709\u4e00\u4e2a\u5206\u652f\u6784\u5efa\u6267\u884c\u5931\u8d25\uff0c\u5c31\u76f4\u63a5\u63a8\u51fa\u4e0d\u7b49\u5f85\u5176\u4ed6\u5206\u652f\u6784\u5efa\n      parallel {\n        stage('Branch A') {\n          steps {\n            echo \"On Branch A\"\n          }\n        }\n        stage('Branch B') {\n          steps {\n            echo \"On Branch B\"\n          }\n        }\n        stage('Branch C') {\n          stages {\n            stage('Nested 1') {\n              steps {\n                echo \"In stage Nested 1 within Branch C\"\n              }\n            }\n            stage('Nested 2') {\n              steps {\n               echo \"In stage Nested 2 within Branch C\"\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>\u8bbe\u7f6efailFast\u4e3atrue\u8868\u793a\u5e76\u884c\u6d41\u6c34\u7ebf\u4e2d\u4efb\u610f\u4e00\u4e2astage\u51fa\u73b0\u9519\u8bef\uff0c\u5176\u4ed6stage\u4e5f\u4f1a\u7acb\u5373\u7ec8\u6b62\u3002\u4e5f\u53ef\u4ee5\u901a\u8fc7options\u914d\u7f6e\u5728\u5168\u5c40\uff1a</p> <pre><code>pipeline {\n  agent any\n  options {\n    parallelsAlwaysFailFast()\n  }\n  stages {\n    stage('Non-Parallel Stage') {\n      steps {\n        echo 'This stage will be executed first.'\n      }\n    }\n    stage('Parallel Stage') {\n      parallel {\n        stage('Branch A') {\n          steps {\n            echo \"On Branch A\"\n          }\n        }\n        stage('Branch B') {\n          steps {\n            echo \"On Branch B\"\n          }\n        }\n        stage('Branch C') {\n          stages {\n            stage('Nested 1') {\n              steps {\n                echo \"In stage Nested 1 within Branch C\"\n              }\n            }\n            stage('Nested 2') {\n              steps {\n               echo \"In stage Nested 2 within Branch C\"\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#4-jenkinsfile\u7684\u4f7f\u7528","title":"4. Jenkinsfile\u7684\u4f7f\u7528","text":"<p>\u524d\u9762\u8bb2\u8fc7\u6d41\u6c34\u7ebf\u652f\u6301\u4e24\u79cd\u8bed\u6cd5\uff0c\u5373\u58f0\u660e\u5f0f\u548c\u811a\u672c\u5f0f\uff0c\u8fd9\u4e24\u79cd\u8bed\u6cd5\u90fd\u652f\u6301\u6784\u5efa\u6301\u7eed\u4ea4\u4ed8\u6d41\u6c34\u7ebf\uff0c\u5e76\u4e14\u90fd\u53ef\u4ee5\u7528\u6765\u5728Web UI\u6216Jenkinsfile\u4e2d\u5b9a\u4e49\u6d41\u6c34 \u7ebf\uff0c\u4e0d\u8fc7\u901a\u5e38\u5c06Jenkinsfile\u653e\u7f6e\u4e8e\u4ee3\u7801\u4ed3\u5e93\u4e2d\uff08\u5f53\u7136\u4e5f\u53ef\u4ee5\u653e\u5728\u5355\u72ec\u7684\u4ee3\u7801\u4ed3\u5e93\u4e2d\u8fdb\u884c\u7ba1\u7406\uff09\u3002</p> <p>\u521b\u5efa\u4e00\u4e2aJenkinsfile\u5e76\u5c06\u5176\u653e\u7f6e\u4e8e\u4ee3\u7801\u4ed3\u5e93\u4e2d\uff0c\u6709\u4ee5\u4e0b\u597d\u5904\uff1a</p> <ul> <li>\u65b9\u4fbf\u5bf9\u6d41\u6c34\u7ebf\u4e0a\u7684\u4ee3\u7801\u8fdb\u884c\u590d\u67e5/\u8fed\u4ee3\u3002</li> <li>\u5bf9\u7ba1\u9053\u8fdb\u884c\u5ba1\u8ba1\u8ddf\u8e2a\u3002</li> <li>\u6d41\u6c34\u7ebf\u771f\u6b63\u7684\u6e90\u4ee3\u7801\u80fd\u591f\u88ab\u9879\u76ee\u7684\u591a\u4e2a\u6210\u5458\u67e5\u770b\u548c\u7f16\u8f91\u3002</li> </ul>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#41-\u73af\u5883\u53d8\u91cf","title":"4.1 \u73af\u5883\u53d8\u91cf","text":""},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#1-\u9759\u6001\u53d8\u91cf","title":"1. \u9759\u6001\u53d8\u91cf","text":"<p>Jenkins \u6709\u8bb8\u591a\u5185\u7f6e\u53d8\u91cf\u53ef\u4ee5\u76f4\u63a5\u5728 Jenkinsfile \u4e2d\u4f7f\u7528\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>JENKINS_URL/pipeline/syntax/globals#env</code> \u83b7\u53d6\u5b8c\u6574\u5217\u8868\u3002\u76ee\u524d\u6bd4\u8f83\u5e38\u7528\u7684\u73af\u5883\u53d8\u91cf\u5982\u4e0b</p> <ul> <li>BUILD_ID\uff1a\u5f53\u524d\u6784\u5efa\u7684 ID\uff0c\u4e0e Jenkins \u7248\u672c 1.597+\u4e2d\u7684 BUILD_NUMBER \u5b8c\u5168\u76f8\u540c</li> <li>BUILD_NUMBER\uff1a\u5f53\u524d\u6784\u5efa\u7684 ID\uff0c\u548c BUILD_ID \u4e00\u81f4</li> <li>BUILD_TAG\uff1a\u7528\u6765\u6807\u8bc6\u6784\u5efa\u7684\u7248\u672c\u53f7\uff0c\u683c\u5f0f\u4e3a\uff1a<code>jenkins-${JOB_NAME}-${BUILD_NUMBER}</code>\uff0c \u53ef\u4ee5\u5bf9\u4ea7\u7269\u8fdb\u884c\u547d\u540d\uff0c\u6bd4\u5982\u751f\u4ea7\u7684 jar \u5305\u540d\u5b57\u3001\u955c\u50cf\u7684 TAG \u7b49\uff1b</li> <li>BUILD_URL\uff1a\u672c\u6b21\u6784\u5efa\u7684\u5b8c\u6574 URL\uff0c\u6bd4\u5982\uff1ahttp://buildserver/jenkins/job/MyJobName/17/%EF%BC%9B</li> <li>JOB_NAME\uff1a\u672c\u6b21\u6784\u5efa\u7684\u9879\u76ee\u540d\u79f0</li> <li>NODE_NAME\uff1a\u5f53\u524d\u6784\u5efa\u8282\u70b9\u7684\u540d\u79f0\uff1b</li> <li>JENKINS_URL\uff1aJenkins \u5b8c\u6574\u7684 URL\uff0c\u9700\u8981\u5728 SystemConfiguration \u8bbe\u7f6e\uff1b</li> <li>WORKSPACE\uff1a\u6267\u884c\u6784\u5efa\u7684\u5de5\u4f5c\u76ee\u5f55\u3002</li> </ul> <p>\u793a\u4f8b\u5982\u679c\u4e00\u4e2a\u6d41\u6c34\u7ebf\u540d\u79f0\u4e3a<code>print_env</code>\uff0c\u7b2c 2 \u6b21\u6784\u5efa\uff0c\u5404\u4e2a\u53d8\u91cf\u7684\u503c\u3002</p> <pre><code>BUILD_ID\uff1a2\nBUILD_NUMBER\uff1a2\nBUILD_TAG\uff1ajenkins-print_env-2\nBUILD_URL\uff1ahttp://192.168.10.16:8080/job/print_env/2/\nJOB_NAME\uff1aprint_env\nNODE_NAME\uff1abuilt-in\nJENKINS_URL\uff1ahttp://192.168.10.16:8080/\nWORKSPACE\uff1a/bitnami/jenkins/home/workspace/print_env\n</code></pre> <p>\u4e0a\u8ff0\u53d8\u91cf\u4f1a\u4fdd\u5b58\u5728\u4e00\u4e2a Map \u4e2d\uff0c\u53ef\u4ee5\u4f7f\u7528 env.BUILD_ID \u6216 env.JENKINS_URL \u5f15\u7528\u67d0\u4e2a\u5185\u7f6e\u53d8\u91cf</p> <pre><code>pipeline {\n  agent any\n  stages {\n    stage('print env') {\n      parallel {\n        stage('BUILD_ID') {\n          steps {\n            echo \"$env.BUILD_ID\"\n          }\n        }\n        stage('BUILD_NUMBER') {\n          steps {\n            echo \"$env.BUILD_NUMBER\"\n          }\n        }\n        stage('BUILD_TAG') {\n          steps {\n            echo \"$env.BUILD_TAG\"\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#2-\u52a8\u6001\u53d8\u91cf","title":"2. \u52a8\u6001\u53d8\u91cf","text":"<p>\u52a8\u6001\u53d8\u91cf\u662f\u6839\u636e\u67d0\u4e2a\u6307\u4ee4\u7684\u7ed3\u679c\u8fdb\u884c\u52a8\u6001\u8d4b\u503c\uff0c\u53d8\u91cf\u7684\u503c\u6839\u636e\u6307\u4ee4\u7684\u6267\u884c\u7ed3\u679c\u800c\u4e0d\u540c\u3002\u5982\u4e0b\u6240\u793a</p> <ul> <li>returnStdout\uff1a\u5c06\u547d\u4ee4\u7684\u6267\u884c\u7ed3\u679c\u8d4b\u503c\u7ed9\u53d8\u91cf\uff0c\u6bd4\u5982\u4e0b\u8ff0\u7684\u547d\u4ee4\u8fd4\u56de\u7684\u662f clang\uff0c\u6b64\u65f6 CC \u7684\u503c\u4e3a\u201cclang\u201d\u3002</li> <li>returnStatus\uff1a\u5c06\u547d\u4ee4\u7684\u6267\u884c\u72b6\u6001\u8d4b\u503c\u7ed9\u53d8\u91cf\uff0c\u6bd4\u5982\u4e0b\u8ff0\u547d\u4ee4\u7684\u6267\u884c\u72b6\u6001\u4e3a 1\uff0c\u6b64\u65f6 EXIT_STATUS \u7684\u503c\u4e3a 1\u3002</li> </ul> <pre><code>//Jenkinsfile (Declarative Pipeline)\npipeline {\n  agent any\n  environment {\n    // \u4f7f\u7528 returnStdout\n    CC = \"\"\"${sh(\n         returnStdout: true,\n         script: 'echo -n \"clang\"'   //\u5982\u679c\u4f7f\u7528shell\u547d\u4ee4\u7684echo\u8d4b\u503c\u53d8\u91cf\u6700\u597d\u52a0-n\u53d6\u6d88\u6362\u884c\n         )}\"\"\"\n\n    // \u4f7f\u7528 returnStatus\n    EXIT_STATUS = \"\"\"${sh(\n         returnStatus: true,\n         script: 'exit 1'\n         )}\"\"\"\n  }\n  stages {\n    stage('Example') {\n      environment {\n        DEBUG_FLAGS = '-g'\n      }\n      steps {\n        sh 'printenv'\n      }\n    }\n  }\n}\n</code></pre> <ul> <li> <p>\u5fc5\u987b\u5728\u7ba1\u9053\u7684\u9876\u5c42\u8bbe\u7f6eagent\u3002\u5982\u679cagent\u8bbe\u7f6enone\uff0c\u5219\u6b64\u64cd\u4f5c\u5c06\u5931\u8d25\u3002</p> </li> <li> <p>\u4f7f\u7528returnStout\u65f6\uff0c\u5c06\u5728\u8fd4\u56de\u7684\u5b57\u7b26\u4e32\u540e\u9762\u9644\u52a0\u4e00\u4e2a\u5c3e\u968f\u7a7a\u683c\u3002\u4f7f\u7528.trim()\u5220\u9664\u6b64\u9879\u3002</p> </li> </ul>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#42-\u51ed\u8bc1\u7ba1\u7406","title":"4.2 \u51ed\u8bc1\u7ba1\u7406","text":"<p>Jenkins \u7684\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u8bed\u6cd5\u6709\u4e00\u4e2a credentials()\u51fd\u6570\uff0c\u5b83\u652f\u6301 secret text\uff08\u52a0\u5bc6\u6587\u672c\uff09\u3001username \u548c password\uff08\u7528\u6237\u540d\u548c\u5bc6\u7801\uff09\u4ee5\u53ca secret file\uff08\u52a0\u5bc6\u6587\u4ef6\uff09\u7b49\u3002\u63a5\u4e0b\u6765\u770b\u4e00\u4e0b\u4e00\u4e9b\u5e38\u7528\u7684\u51ed\u8bc1\u5904\u7406\u65b9\u6cd5\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#1-\u52a0\u5bc6\u6587\u672c","title":"1. \u52a0\u5bc6\u6587\u672c","text":"<p>\u672c\u5b9e\u4f8b\u6f14\u793a\u5c06\u4e24\u4e2a Secret \u6587\u672c\u51ed\u8bc1\u5206\u914d\u7ed9\u5355\u72ec\u7684\u73af\u5883\u53d8\u91cf\u6765\u8bbf\u95ee Amazon Web \u670d\u52a1\uff0c\u9700\u8981\u63d0\u524d\u521b\u5efa\u8fd9\u4e24\u4e2a\u6587\u4ef6\u7684 credentials\uff08\u5b9e\u8df5\u7684\u7ae0\u8282\u4f1a\u6709\u6f14\u793a\uff09\uff0cJenkinsfile \u6587\u4ef6\u7684\u5185\u5bb9\u5982\u4e0b</p> <pre><code>//Jenkinsfile (Declarative Pipeline)\npipeline {\n  agent any\n  environment {\n    AWS_ACCESS_KEY_ID = credentials('txt1')\n    AWS_SECRET_ACCESS_KEY = credentials('txt2')\n  }\n  stages {\n    stage('Example stage 1') {\n      steps {\n        echo \"$AWS_ACCESS_KEY_ID\"\n      }\n    }\n    stage('Example stage 2') {\n      steps {\n        echo \"$AWS_SECRET_ACCESS_KEY\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#2-\u7528\u6237\u540d\u5bc6\u7801","title":"2. \u7528\u6237\u540d\u5bc6\u7801","text":"<p>\u672c\u793a\u4f8b\u7528\u6765\u6f14\u793a credentials \u8d26\u53f7\u5bc6\u7801\u7684\u4f7f\u7528\uff0c\u6bd4\u5982\u4f7f\u7528\u4e00\u4e2a\u516c\u7528\u8d26\u6237\u8bbf\u95ee Bitbucket\u3001GitLab\u3001 Harbor \u7b49\u3002\u5047\u8bbe\u5df2\u7ecf\u914d\u7f6e\u5b8c\u6210\u4e86\u7528\u6237\u540d\u5bc6\u7801\u5f62\u5f0f\u7684 credentials\uff0c\u51ed\u8bc1 ID \u4e3a harbor-account</p> <pre><code>//Jenkinsfile (Declarative Pipeline)\npipeline {\n  agent any\n  environment {\n    BITBUCKET_COMMON_CREDS = credentials('harbor-account')\n  }\n  stages {\n    stage('printenv') {\n      steps {\n        sh \"env\"\n      }\n    }\n}\n</code></pre> <p>\u4e0a\u8ff0\u7684\u914d\u7f6e\u4f1a\u81ea\u52a8\u751f\u6210 3 \u4e2a\u73af\u5883\u53d8\u91cf</p> <ul> <li>BITBUCKET_COMMON_CREDS\uff1a\u5305\u542b\u4e00\u4e2a\u4ee5\u5192\u53f7\u5206\u9694\u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\uff0c\u683c\u5f0f\u4e3a username:password</li> <li>BITBUCKET_COMMON_CREDS_USR\uff1a\u4ec5\u5305\u542b\u7528\u6237\u540d\u7684\u9644\u52a0\u53d8\u91cf</li> <li>BITBUCKET_COMMON_CREDS_PSW\uff1a\u4ec5\u5305\u542b\u5bc6\u7801\u7684\u9644\u52a0\u53d8\u91cf\u3002</li> </ul>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#3-\u52a0\u5bc6\u6587\u4ef6","title":"3. \u52a0\u5bc6\u6587\u4ef6","text":"<p>\u9700\u8981\u52a0\u5bc6\u4fdd\u5b58\u7684\u6587\u4ef6\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 credential\uff0c\u6bd4\u5982\u94fe\u63a5\u5230 Kubernetes \u96c6\u7fa4\u7684 kubeconfig \u6587\u4ef6\u7b49\u3002</p> <p>\u5047\u5982\u5df2\u7ecf\u914d\u7f6e\u597d\u4e86\u4e00\u4e2a kubeconfig \u6587\u4ef6\uff0c\u6b64\u65f6\u53ef\u4ee5\u5728 Pipeline \u4e2d\u5f15\u7528\u8be5\u6587\u4ef6</p> <pre><code>//Jenkinsfile (Declarative Pipeline)\npipeline {\n  agent {\n    kubernetes {\n      cloud 'kubernetes'\n      slaveConnectTimeout 1200\n      workspaceVolume emptyDirWorkspaceVolume()\n      yaml '''\nkind: Pod\nmetadata:\n  name: jenkins-agent\nspec:\n  containers:\n  - args: [\\'$(JENKINS_SECRET)\\', \\'$(JENKINS_NAME)\\']\n    image: '192.168.10.15/kubernetes/jnlp:alpine'\n    name: jnlp\n    imagePullPolicy: IfNotPresent\n  - command:\n      - \"cat\"\n    image: \"192.168.10.15/kubernetes/kubectl:apline\"\n    imagePullPolicy: \"IfNotPresent\"\n    name: \"kubectl\"\n    tty: true\n  restartPolicy: Never\n'''\n    }\n  }\n  environment {\n    KUBECONFIG = credentials('kubernetes-cluster')\n  }\n  stages {\n    stage('kubectl') {\n      steps {\n        container(name: 'kubectl') {\n          sh \"\"\"\n            # kubectl get pod -A  --kubeconfig $MY_KUBECONFIG\n\n            mkdir -p ~/.kube &amp;&amp; cp ${KUBECONFIG} ~/.kube/config\n            kubectl get nodes\n          \"\"\"\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>\u66f4\u591a\u5176\u4ed6\u7c7b\u578b\u7684\u51ed\u8bc1\u53ef\u4ee5\u53c2\u8003 \uff1ahttps://www.jenkins.io/doc/book/pipeline/jenkinsfile/#handlingcredentials\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#43--\u53c2\u6570\u5904\u7406","title":"4.3  \u53c2\u6570\u5904\u7406","text":"<p>\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u652f\u6301\u5f88\u591a\u5f00\u7bb1\u5373\u7528\u7684\u53c2\u6570\uff0c\u53ef\u4ee5\u8ba9\u6d41\u6c34\u7ebf\u63a5\u6536\u4e0d\u540c\u7684\u53c2\u6570\u4ee5\u8fbe\u5230\u4e0d\u540c\u7684\u6784\u5efa\u6548\u679c\u3002</p> <p>\u5728Jenkinsfile\u4e2d\u6307\u5b9a\u7684parameters\u4f1a\u5728Jenkins Web UI\u81ea\u52a8\u751f\u6210\u5bf9\u5e94\u7684\u53c2\u6570\u5217\u8868\uff0c\u6b64\u65f6\u53ef\u4ee5\u5728Jenkins\u9875\u9762\u5355\u51fbBuild With Parameters\u6765\u6307\u5b9a\u53c2\u6570 \u7684\u503c\uff0c\u8fd9\u4e9b\u53c2\u6570\u53ef\u4ee5\u901a\u8fc7params\u53d8\u91cf\u88ab\u6210\u5458\u8bbf\u95ee\u3002</p> <p>\u5047\u8bbe\u5728Jenkinsfile\u4e2d\u914d\u7f6e\u4e86\u540d\u4e3aGreeting\u7684\u5b57\u7b26\u4e32\u53c2\u6570\uff0c\u53ef\u4ee5\u901a\u8fc7${params.Greeting}\u8bbf\u95ee\u8be5\u53c2\u6570\uff0c\u6bd4\u5982\uff1a</p> <pre><code>//Jenkinsfile (Declarative Pipeline)\npipeline {\n  agent any\n  parameters {\n    string(name\uff1a\u2018Greeting\u2019, defaultValue: 'Hello', description: \"How should I greet the world?\")\n  }\n  stages {\n    stage('Example') {\n      steps {\n        echo \"${params.Greeting} World!\"\n       }\n     }\n  }\n}\n</code></pre> <p>\u5bf9\u5e94\u7684\u811a\u672c\u5f0f\u6d41\u6c34\u7ebf\u5982\u4e0b\uff1a</p> <pre><code>//Jenkinsfile (Scripted Pipeline)\nproperties([parameters([string(name\uff1a\u2018Greeting\u2019, defaultValue: 'Hello', description: \"How should I greet the world?\")])])\n\nnode {\n    echo \"${params.Greeting} World!\" \n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#44-\u5904\u7406\u5931\u8d25","title":"4.4 \u5904\u7406\u5931\u8d25","text":"<p>\u5728\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u4e2d\uff0c\u53ef\u4ee5\u6839\u636e\u4e0d\u540c\u7684\u7ed3\u679c\u8fdb\u884c\u540e\u7f6e\u5904\u7406\uff0c\u6bd4\u5982always\u3001unstable\u3001success\u3001failure\u548cchanged\uff0c\u5177\u4f53\u53ef\u53c2\u8003Pipeline Post\u7684\u8bed\u6cd5\u3002</p> <p>\u5047\u5982\u6d41\u6c34\u7ebf\u6784\u5efa\u5931\u8d25\u9700\u8981\u8fdb\u884c\u90ae\u4ef6\u901a\u77e5\uff0c\u53ef\u4ee5\u53c2\u8003\u5982\u4e0b\u793a\u4f8b\uff08Jenkins\u9700\u8981\u914d\u7f6e\u90ae\u7bb1\uff09\uff1a</p> <pre><code>pipeline { \n    agent any \n\n    parameters {\n        \u7701\u7565\u5185\u5bb9\u2026\u2026\n    }\n    environment {\n        \u7701\u7565\u5185\u5bb9\u2026\u2026\n    }\n    stages {\n        \u7701\u7565\u5185\u5bb9\u2026\u2026\n    }\n    post {\n        success {\n            emailext (\n                subject: \"SUCCESSFUL: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'\",\n                body: \"\"\"&lt;p&gt;SUCCESSFUL: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]':&lt;/p&gt;\n                    &lt;p&gt;Check console output at \"&lt;a href=\"${env.BUILD_URL}\"&gt;${env.JOB_NAME} [${env.BUILD_NUMBER}]&lt;/a&gt;\"&lt;/p&gt;\"\"\",\n                to: \"user1@qq.com,user2@qq.com\",\n                from: \"admin@sina.com\"\n            )\n        }\n        failure {\n            emailext (\n                subject: \"FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'\",\n                body: \"\"\"&lt;p&gt;FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]':&lt;/p&gt;\n                    &lt;p&gt;Check console output at \"&lt;a href=\"${env.BUILD_URL}\"&gt;${env.JOB_NAME}          [${env.BUILD_NUMBER}]&lt;/a&gt;\"&lt;/p&gt;\"\"\",\n                to: \"user1@qq.com,user2@qq.com\",\n                from: \"admin@sina.com\"\n            )\n        }\n    }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#45-\u4f7f\u7528\u591a\u4e2a\u4ee3\u7406","title":"4.5 \u4f7f\u7528\u591a\u4e2a\u4ee3\u7406","text":"<p>\u6d41\u6c34\u7ebf\u5141\u8bb8\u5728Jenkins\u73af\u5883\u4e2d\u4f7f\u7528\u591a\u4e2a\u4ee3\u7406\uff0c\u8fd9\u6709\u52a9\u4e8e\u66f4\u9ad8\u7ea7\u7684\u7528\u4f8b\uff0c\u4f8b\u5982\u8de8\u591a\u4e2a\u5e73\u53f0\u6267\u884c\u6784\u5efa\u3001\u6d4b\u8bd5\u7b49\u3002</p> <p>\u6bd4\u5982\uff0c\u5728Linux\u548cWindows\u7cfb\u7edf\u7684\u4e0d\u540cagent\u4e0a\u8fdb\u884c\u6d4b\u8bd5\uff1a</p> <pre><code>pipeline {\n    agent none\n    stages {\n        stage('Build') {\n            agent any\n            steps {\n                checkout scm\n                sh 'make'\n                stash includes: '**/target/*.jar', name: 'app'\n            }\n        }\n\n         stage('Test on Linux') {\n            agent { label 'linux'}\n            steps {\n              unstash 'app'\n               sh 'make check'\n            }\n            post {\n              always {\n                junit '**/target/*.xml'\n              }\n            }\n        }\n\n       stage('Test on Windows') {\n            agent { label 'windows'}\n            steps {\n              unstash 'app'\n               sh 'make check'\n            }\n            post {\n              always {\n                junit '**/target/*.xml'\n              }\n            }\n        }\n    }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#5-devops\u5e73\u53f0\u5efa\u8bbe","title":"5. DevOps\u5e73\u53f0\u5efa\u8bbe","text":"<p>\u672c\u8282\u4ecb\u7ecd\u6301\u7eed\u96c6\u6210\u3001\u6301\u7eed\u90e8\u7f72\u7684\u6b65\u9aa4\u53ca\u8fc7\u7a0b\uff0c\u4e3b\u8981\u8bb2\u89e3\u5982\u4f55\u57fa\u4e8eKubernetes\u548cJenkins\u642d\u5efaDevOps\u5e73\u53f0\u3001\u5982\u4f55\u5728Kubernetes\u4e2d\u53d1\u7248\u3001DevOps\u5e73 \u53f0\u7528\u5230\u7684\u5de5\u5177\u7684\u5b89\u88c5\u4ee5\u53ca\u57fa\u4e8eKubernetes\u548cJenkins\u7684CI/CD\u8fc7\u7a0b\u3002</p> <p>\u5728Kubernetes\u4e2d\u8fdb\u884cCI/CD\u7684\u8fc7\u7a0b\uff0c\u4e00\u822c\u7684\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <ol> <li> <p>\u5728GitLab\u4e2d\u521b\u5efa\u5bf9\u5e94\u7684\u9879\u76ee\u3002</p> </li> <li> <p>\u914d\u7f6eJenkins\u96c6\u6210Kubernetes\u96c6\u7fa4 \uff0c \u540e\u671fJenkins\u7684Slave\u4e3a\u5728Kubernetes\u4e2d\u52a8\u6001\u521b\u5efa\u7684Slave\u3002</p> </li> <li> <p>Jenkins\u521b\u5efa\u5bf9\u5e94\u7684\u4efb\u52a1(Job)\uff0c\u96c6\u6210\u8be5\u9879\u76ee\u7684Git\u5730\u5740\u548cKubernetes\u96c6\u7fa4\u3002</p> </li> <li> <p>\u5f00\u53d1\u8005\u5c06\u4ee3\u7801\u63d0\u4ea4\u5230GitLab\u3002</p> </li> <li> <p>\u82e5\u914d\u7f6e\u4e86\u94a9\u5b50\uff0c\u5219\u63a8\u9001\uff08Push\uff09\u4ee3\u7801\u4f1a\u81ea\u52a8\u89e6\u53d1Jenkins\u6784\u5efa\uff0c\u82e5\u6ca1\u6709\u914d\u7f6e\u94a9\u5b50\uff0c\u5219\u9700\u8981\u624b\u52a8\u6784\u5efa\u3002</p> </li> <li> <p>Jenkins\u63a7\u5236Kubernetes\uff08\u4f7f\u7528\u7684\u662fKubernetes\u63d2\u4ef6\uff09\u521b\u5efaJenkinsSlave\uff08Pod\u5f62\u5f0f\uff09\u3002</p> </li> <li> <p>Jenkins Slave\u6839\u636e\u6d41\u6c34\u7ebf\u5b9a\u4e49\u7684\u6b65\u9aa4\u6267\u884c\u6784\u5efa\u3002</p> </li> <li> <p>\u901a\u8fc7Dockerfile\u751f\u6210\u955c\u50cf\u3002</p> </li> <li> <p>\u5c06\u955c\u50cf\u63d0\u9001\u5230\u79c1\u6709Harbor\uff08\u6216\u8005\u5176\u4ed6\u7684\u955c\u50cf\u4ed3\u5e93\uff09\u3002</p> </li> <li> <p>Jenkins\u518d\u6b21\u63a7\u5236Kubernetes\u8fdb\u884c\u6700\u65b0\u7684\u955c\u50cf\u90e8\u7f72\u3002</p> </li> <li> <p>\u6d41\u6c34\u7ebf\u7ed3\u675f\uff0c\u5220\u9664Jenkins Slave\u3002</p> </li> </ol> <p>\u4e0a\u8ff0\u4e3a\u6bd4\u8f83\u5e38\u7528\u7684\u6b65\u9aa4\uff0c\u4e2d\u95f4\u8fd8\u53ef\u80fd\u6d89\u53ca\u81ea\u52a8\u5316\u6d4b\u8bd5\u7b49\u5176\u4ed6\u6b65\u9aa4\uff0c\u53ef\u81ea\u884c\u6839\u636e\u4e1a\u52a1\u573a\u666f\u6dfb\u52a0\u6216\u5220\u9664\u3002</p> <p>\u4e0a\u8ff0\u6d41\u6c34\u7ebf\u6b65\u9aa4\u4e00\u822c\u5199\u5728Jenkinsfile\u4e2d\uff0cJenkins\u4f1a\u81ea\u52a8\u8bfb\u53d6\u8be5\u6587\u4ef6\uff0c\u540c\u65f6Jenkinsfile\u548cDockerfile\u53ef\u4e00\u5e76\u548c\u4ee3\u7801\u653e \u7f6e\u4e8eGitLab\u4e2d\uff0c\u53ef\u4ee5\u548c\u4ee3\u7801\u4e00\u6837\u5b9e\u73b0\u7248\u672c\u63a7\u5236\uff0c\u5355\u72ec\u914d\u7f6e\u4e5f\u53ef\u4ee5</p> <p>\u4e0b\u56fe\u662f\u6211\u4eec\u5f53\u524d\u793a\u4f8b\u7684\u6d41\u7a0b\u56fe</p> <p>)</p> <p>)</p> <p>\u751f\u4ea7\u73af\u5883CICD\u6d41\u7a0b</p> <p>)</p> <p>\u4e86\u89e3\u4e86\u57fa\u4e8eKubernetes\u548cJenkins\u7684\u53d1\u7248\u6d41\u7a0b\u540e\uff0c\u63a5\u4e0b\u6765\u9700\u8981\u4e00\u6b65\u4e00\u6b65\u5b89\u88c5\u6240\u9700\u8981\u7684\u5de5\u5177\uff0c\u4e4b\u540e\u5373\u53ef\u5f00\u59cbCI/CD\u7684\u5b66\u4e60\u3002\u5982\u679c\u516c\u53f8\u5185\u5df2\u7ecf\u6709\u53ef\u4ee5\u7528\u6765\u8054\u7cfb\u7684\u5e73\u53f0\uff0c\u53ef\u4ee5\u4e0d\u5b89\u88c5\u8fd9\u4e9b\u5de5\u5177\u3002</p> <p>\u5efa\u8bbeDevOps\u5e73\u53f0\u9700\u8981\u5efa\u8bbe\u5982\u4e0b\u670d\u52a1</p> <ul> <li>Jenkins </li> <li>GitLab </li> <li>Harbor </li> <li>Coredns</li> </ul> <p>\u53ef\u4ee5\u5b89\u88c5\u5728Kubernetes\u96c6\u7fa4\u4e2d\uff0c\u4e5f\u53ef\u4ee5\u5355\u72ec\u90e8\u7f72\uff0c</p> <p>\u751f\u4ea7\u73af\u5883\u5efa\u8bae\u9009\u62e9\u76f4\u63a5\u5728\u5355\u72ec\u7684\u673a\u5668\u4e0a\u90e8\u7f72\uff0c\u8fd9\u662f\u4f01\u4e1a\u5e38\u7528\u7684\u4e00\u79cd\u65b9\u5f0f\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#51--\u5b89\u88c5jenkins","title":"5.1  \u5b89\u88c5Jenkins","text":""},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#1-docker\u65b9\u5f0f\u90e8\u63a8\u8350","title":"1. docker\u65b9\u5f0f\u90e8(\u63a8\u8350)","text":"<p>\u9996\u5148\u9700\u8981\u4e00\u4e2aLinux\u670d\u52a1\u5668\uff0c\u914d\u7f6e\u4e0d\u4f4e\u4e8e2\u6838CPU\u30014GB\u5185\u5b58\u548c40GB\u7684\u786c\u76d8\u3002\u9996\u5148\u5b89\u88c5docker\u548cdocker-compose</p> <p>docker\u5b89\u88c5</p> <pre><code>$ wget https://download.docker.com/linux/static/stable/aarch64/docker-20.10.9.tgz\n$ tar zxf docker-20.10.9.tgz\n$ cp docker/* /usr/bin\n$ cat &gt;/lib/systemd/system/docker.service &lt;&lt;EOF\n[Unit]\nDescription=Docker Application Container Engine\nDocumentation=https://docs.docker.com\nAfter=network-online.target firewalld.service\nWants=network-online.target\n[Service]\nType=notify\nExecStart=/usr/bin/dockerd\nExecReload=/bin/kill -s HUP $MAINPID\nLimitNOFILE=infinity\nLimitNPROC=infinity\nTimeoutStartSec=0\nDelegate=yes\nKillMode=process\nRestart=on-failure\nStartLimitBurst=3\nStartLimitInterval=60s\n[Install]\nWantedBy=multi-user.target\nEOF\n$ systemctl daemon-reload\n$ systemctl start docker $ docker version\n\n# \u5982\u679c\u955c\u50cf\u4ed3\u5e93\u672a\u914d\u7f6e\u8bc1\u4e66\uff0c\u5219\u9700\u8981\u914d\u7f6einsecure-registry\uff1a\n$ cat &gt; /etc/docker/daemon.json &lt;&lt;'EOF'\n{\n  \"graph\": \"/data/docker\",\n  \"storage-driver\": \"overlay2\",\n  \"insecure-registries\": [\"hub.gitee.cc\"],\n  \"registry-mirrors\": [\"https://25bxwt20.mirror.aliyuncs.com\"],\n  \"live-restore\": true,\n  \"bip\": \"172.16.200.1/24\",\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n  \"hosts\": [\"tcp://0.0.0.0:2375\", \"unix:///var/run/docker.sock\"],\n  \"log-opts\": {\n    \"max-size\":\"100M\",\n    \"max-file\":\"3\"\n  }\n}\nEOF\n$ systemctl restart docker\n</code></pre> <p>docker-compose\u5b89\u88c5</p> <pre><code>$ sudo curl -L https://get.daocloud.io/docker/compose/releases/download/v2.4.1/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose\n\n$ sudo chmod +x /usr/local/bin/docker-compose\n$ sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose\n\n$ docker-compose version\nDocker Compose version v2.4.1\n</code></pre> <p>\u7ec4\u6210\u90e8\u5206</p> <ul> <li>master \u63a5\u6536 webhook \uff0c\u8c03\u5ea6\u4efb\u52a1\u7b49</li> <li>agent \u6267\u884c\u6784\u5efa\u4efb\u52a1</li> <li>dind \u6784\u5efa\u955c\u50cf</li> </ul> <p>\u5f00\u59cb\u90e8\u7f72</p> <p>\u4ed3\u5e93\u5730\u5740\uff1a https://gitee.com/hujianli94net/simple-jenkins.git</p> <p>\u90e8\u7f72 master</p> <ul> <li>\u4fee\u6539\u6301\u4e45\u5316\u76ee\u5f55\u5c5e\u4e3b\u4e3a 1000:1000</li> </ul> <pre><code>mkdir devops &amp;&amp; cd devops\ngit clone https://gitee.com/hujianli94net/simple-jenkins.git\ncd simple-jenkins/jenkins/master\nchown -R 1000:1000 jenkins_home\nchown -R 1000:1000 init.groovy.d\n</code></pre> <ul> <li>\u6267\u884c docker-compose \u547d\u4ee4\u5b8c\u6210\u90e8\u7f72</li> </ul> <p>\u521b\u5efa docker network</p> <pre><code>docker network create -d bridge jenkins-cluster\n</code></pre> <p>\u542f\u52a8</p> <pre><code>docker-compose up -d\n</code></pre> <ul> <li>\u5b8c\u6210\u521d\u59cb\u5316\u5e76\u5b89\u88c5\u63d2\u4ef6</li> </ul> <p>blueocean \u955c\u50cf\u5df2\u5305\u542b\u5e38\u7528\u63d2\u4ef6\uff0c\u5728\u9996\u6b21\u8bbf\u95ee Jenkins \u65f6\uff0c\u9009\u62e9\u5b89\u88c5\u63a8\u8350\u63d2\u4ef6\u5373\u53ef\u3002</p> <p>\u5728\u5b89\u88c5\u4e4b\u524d\u5148\u914d\u7f6e\u56fd\u5185\u7684\u63d2\u4ef6\u6e90\uff0c\u5355\u51fbAdvanced\uff0c\u5c06\u63d2\u4ef6\u6e90\u66f4\u6539\u4e3a\u56fd\u5185\u63d2\u4ef6\u6e90(https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json\uff09</p> <p>\u521d\u59cb\u5316\u5b8c\u6210\u540e\uff0c\u767b\u5f55 Jenkins \uff0c\u8fdb\u5165\u201c\u7cfb\u7edf\u7ba1\u7406-&gt;\u63d2\u4ef6\u7ba1\u7406-&gt;\u53ef\u9009\u63d2\u4ef6\u201d \u5728\u641c\u7d22\u6846\u641c\u7d22\u5982\u4e0b\u63d2\u4ef6\u5b89\u88c5\u3002</p> <ul> <li>Git Parameter</li> <li>Git Pipeline for Blue Ocean</li> <li>GitLab</li> <li>GitLab Authentication</li> <li>GitLab Branch Source</li> <li>Generic Webhook Trigger</li> <li>Image Tag Parameter</li> <li>Workspace Cleanup</li> <li>Role-based Authorization Strategy</li> <li>Email Extension Template</li> <li>Git Pipeline for Blue Ocean</li> <li>Pipeline: GitHub</li> <li>Blue Ocean </li> <li>Blue Ocean Pipeline Editor</li> <li>Web for Blue Ocean</li> <li>Blue Ocean Core JS</li> <li>Pipeline SCM API for Blue Ocean</li> <li>Dashboard for Blue Ocean</li> <li>Build With Parameters</li> <li>Dynamic Extended Choice Parameter Plug-In</li> <li>Extended Choice Parameter</li> <li>List Git Branches Parameter</li> <li>Pipeline</li> <li>Pipeline: Deprecated Groovy Libraries</li> <li>SSH Pipeline Steps</li> <li>Kubernetes</li> <li>Kubernetes CLI</li> <li>Kubernetes Credentials</li> <li>Kubernetes Client API</li> <li>Active Choices</li> <li>Design Language</li> <li>REST API for Blue Ocean</li> <li>REST Implementation for Blue Ocean</li> </ul> <p>\u52fe\u9009\u540e\uff0c\u5355\u51fbDownload now and install after restart\uff0c\u4e4b\u540e\u53ef\u4ee5\u5728Installed\u9009\u9879\u5361\u4e0b\u770b\u5230\u5df2\u7ecf\u5b89\u88c5\u7684\u63d2\u4ef6\u3002</p> <ul> <li>\u914d\u7f6e Gitee \u63d2\u4ef6</li> </ul> <p>\u5b8c\u6210 gitee \u63d2\u4ef6\u5b89\u88c5\u540e\uff0c\u8fdb\u5165\u201c\u7cfb\u7edf\u7ba1\u7406-&gt;\u7cfb\u7edf\u914d\u7f6e\u201d\uff0c\u5b9a\u4f4d\u5230 \u201cGitee \u914d\u7f6e\u201d \u90e8\u5206\uff0c\u521b\u5efa\u8bc1\u4e66\u4ee4\u724c\uff08\u9700\u8981\u5148\u5728 Gitee \u521b\u5efa Gitee API V5 \u7684\u79c1\u4eba\u4ee4\u724c\uff09\uff0c\u5e76\u5b8c\u6210\u914d\u7f6e\u3002</p> <p>)</p> <p>)</p> <p>\u70b9\u51fb\u6d4b\u8bd5\u8fde\u63a5\u3002\u663e\u793a\u6210\u529f\u5c31\u4fdd\u5b58\uff0c\u7ee7\u7eed\u5f80\u540e\u64cd\u4f5c</p> <p>)</p> <ul> <li>\u65b0\u5efa agent</li> </ul> <p>\u8fdb\u5165 \u201c\u7cfb\u7edf\u7ba1\u7406-&gt;\u8282\u70b9\u5217\u8868\u201d \uff0c\u70b9\u51fb\u65b0\u5efa\u8282\u70b9</p> <p>\u521b\u5efa\u4e24\u4e2a\u201c\u56fa\u5b9a\u8282\u70b9\u201d\uff0c\u8282\u70b9\u914d\u7f6e\u5982\u4e0b</p> <p>)</p> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u70b9\u51fb\u8282\u70b9\uff0c\u67e5\u770b\u8282\u70b9\u8fde\u63a5\u4fe1\u606f\uff0c\u90e8\u7f72 agent \u65f6\u9700\u8981\u63d0\u4f9b\u8be5\u8fde\u63a5\u4fe1\u606f</p> <p>)</p> <p>)</p> <p>\u90e8\u7f72 agent</p> <ul> <li>\u6784\u5efa\u81ea\u5b9a\u4e49 agent \u955c\u50cf</li> </ul> <p>\u4e0b\u8f7d kubectl \u3001 docker \u3001 helm \u4e8c\u8fdb\u5236\u6587\u4ef6</p> <p>docker\u4e8c\u8fdb\u5236\u4e0b\u8f7d\u5730\u5740</p> <p>https://download.docker.com/linux/static/stable/x86_64/</p> <pre><code># cd jenkins/agent/bin\n## \u4e0b\u8f7dhelm\n# wget -C https://repo.huaweicloud.com/helm/v3.8.0/helm-v3.8.0-linux-386.tar.gz\n## \u4f8b\u5982\uff0c\u8981\u5728 Linux \u4e2d\u4e0b\u8f7d v1.21.0 \u7248\u672c\uff0c\u8bf7\u8f93\u5165\uff1a\n# curl -LO https://dl.k8s.io/release/v1.21.0/bin/linux/amd64/kubectl\n# chmod +x *\n# ll\ntotal 134552\n-rwxr-xr-x 1 root root 50707288 Feb 14 16:45 docker\n-rwxr-xr-x 1 3434 3434 40636416 Jan 25  2022 helm\n-rwxr-xr-x 1 root root 46436352 Feb 14 16:44 kubectl\n</code></pre> <p>\u51c6\u5907 .kube \u548c .docker \u6587\u4ef6\u5939\uff0c\u7528\u4e8e\u6388\u6743\u8bbf\u95ee kubernetes api-server \u548c harbor \u955c\u50cf\u4ed3\u5e93</p> <p><code>.kube/config</code> \u4ece kubernetes \u96c6\u7fa4\u5185\u83b7\u53d6,</p> <p>\u521b\u5efa <code>.docker/config.json</code></p> <pre><code>harbor_addr=hub.gitee.cc\nharbor_username=admin\nharbor_password=oschina123\nauth_str=$(echo -ne \"$harbor_username:$harbor_password\" | base64)\ncat &gt; .docker/config.json &lt;&lt;EOF\n{\n        \"auths\": {\n                \"$harbor_addr\": {\n                        \"auth\": \"$auth_str\"\n                }\n        }\n}\nEOF\n</code></pre> <p>docker build agent \u955c\u50cf</p> <pre><code>docker build -t $harbor_addr/jenkins/inbound-agent:4.11-1-kube .\n\n# \u63a8\u9001\u955c\u50cf\u5230harbor\u4ed3\u5e93\uff0chabor\u4ed3\u5e93\u9700\u8981\u63d0\u524d\u90e8\u7f72\ndocker push $harbor_addr/jenkins/inbound-agent:4.11-1-kube\n</code></pre> <ul> <li>\u6267\u884c docker-compose \u547d\u4ee4\u5b8c\u6210\u90e8\u7f72</li> </ul> <p>\u4fee\u6539 docker-compose.yml \u4e2d\u7684 secret \u4e2a agent_name \uff0c\u5bf9\u5e94\u4e8e\u4e0a\u9762 master \u4e2d\u521b\u5efa\u7684\u8282\u70b9\u8fde\u63a5\u4fe1\u606f</p> <pre><code>chown -R 1000:1000 /root/devops/simple-jenkins/jenkins/agent/\ndocker-compose up -d\n</code></pre> <p>\u90e8\u7f72 dind</p> <ul> <li>\u521b\u5efa daemon.json</li> </ul> <pre><code>cd dind\nharbor_addr=hub.gitee.cc\ndns_addr=192.168.1.60\ncat &gt; etc/daemon.json &lt;&lt;EOF\n{\n  \"registry-mirrors\": [\"https://gfty7g09.mirror.aliyuncs.com\"],\n  \"insecure-registries\": [\"$harbor_addr\"],\n  \"live-restore\": true,\n  \"default-shm-size\": \"128M\",\n  \"max-concurrent-downloads\": 10,\n  \"oom-score-adjust\": -1000,\n  \"log-driver\": \"json-file\",\n  \"log-opts\": {\n    \"max-size\": \"100m\"\n  },\n  \"dns\": [\n    \"$dns_addr\"\n  ]\n}\nEOF\n</code></pre> <ul> <li>\u6267\u884c docker-compose \u547d\u4ee4\u5b8c\u6210\u90e8\u7f72</li> </ul> <pre><code>docker-compose up -d\n</code></pre> <p>\u67e5\u770b\u6240\u6709\u5bb9\u5668</p> <pre><code># docker ps\nCONTAINER ID   IMAGE                                            COMMAND                  CREATED              STATUS              PORTS                                                                                      NAMES\n425c73c120ec   docker:20.10.10-dind                             \"dockerd-entrypoint.\u2026\"   36 seconds ago       Up 16 seconds       2375-2376/tcp                                                                              dind-docker01-1\n89f9bcfd1f12   docker:20.10.10-dind                             \"dockerd-entrypoint.\u2026\"   36 seconds ago       Up 16 seconds       2375-2376/tcp                                                                              dind-docker02-1\n6bd628bfba16   hub.gitee.cc/jenkins/inbound-agent:4.11-1-kube   \"/usr/local/bin/jenk\u2026\"   About a minute ago   Up About a minute                                                                                              agent-agent02-1\n171340672a53   hub.gitee.cc/jenkins/inbound-agent:4.11-1-kube   \"/usr/local/bin/jenk\u2026\"   About a minute ago   Up About a minute                                                                                              agent-agent01-1\n0e4f1c2ca769   jenkins/jenkins:2.390-jdk11                      \"/usr/bin/tini -- /u\u2026\"   11 minutes ago       Up 11 minutes       0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp, 0.0.0.0:50000-&gt;50000/tcp, :::50000-&gt;50000/tcp   jenkins-master\n</code></pre> <p>\u5b8c\u6210</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#2-helm\u65b9\u5f0f\u90e8\u7f72\u63a8\u8350","title":"2. helm\u65b9\u5f0f\u90e8\u7f72(\u63a8\u8350)","text":""},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#21-\u90e8\u7f72nfs","title":"2.1 \u90e8\u7f72nfs","text":"<p>\u51c6\u5907\u4e00\u5757&gt;2T\u7684\u6570\u636e\u76d8\uff0c\u683c\u5f0f\u5316\u540e\u6302\u8f7d\u5230/data\u76ee\u5f55\u4e0b\u3002/data\u76ee\u5f55\u4e3anfs\u7684\u6570\u636e\u76ee\u5f55\u3002</p> <p>\u76f4\u63a5\u547d\u4ee4\u5b89\u88c5\uff0c\u793a\u4f8b\u5982\u4e0b</p> <pre><code>$ docker run -d --name nfs --privileged -v /data:/nfsshare -e SHARED_DIRECTORY=/nfsshare itsthenetwork/nfs-server-alpine:latest\n</code></pre> <p>docker-compose\u90e8\u7f72</p> <p><code>docker-compose.yaml</code></p> <pre><code>---\nversion: '3'\nservices:\nnfs:\nimage: atompi/nfs-server:9\nrestart: always\nports:\n- \"2049:2049\"\nvolumes:\n- /data/nfs:/nfsshare\nenvironment:\n- SHARED_DIRECTORY=/nfsshare\nprivileged: yes\n</code></pre> <p>\u53ef\u53c2\u8003\u6587\u732e</p> <p>https://github.com/ehough/docker-nfs-server.git</p> <p>https://github.com/sjiveson/nfs-server-alpine</p> <p>https://gitee.com/atompi/nfs-server-docker</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#22-\u90e8\u7f72storageclass","title":"2.2 \u90e8\u7f72StorageClass","text":"<p>GitHub \u5730\u5740\uff1ahttps://github.com/kubernetes-sigs/nfs-subdir-external-provisioner</p> <p>Chart \u4ed3\u5e93\u5730\u5740\uff1ahttps://artifacthub.io/packages/helm/nfs-subdir-external-provisioner/nfs-subdir-external-provisioner</p> <p>nfs-subdir-external-provisioner\u4f7f\u7528\u65b9\u6cd5</p> <pre><code>$ helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/\n$ helm repo update\n\n# \u53ef\u4ee5\u4e0b\u8f7d\u5230\u672c\u5730\u79bb\u7ebf\u5b89\u88c5\n# helm pull nfs-subdir-external-provisioner/nfs-subdir-external-provisioner --version 4.0.17 --untar\n# \u9ed8\u8ba4\u955c\u50cf\nhelm install nfs-subdir-external-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner\n--set nfs.server=172.18.0.95 \\\n--set nfs.path=/gitee \\\n--set storageClass.name=gitee-nfs-client \\\n--set storageClass.reclaimPolicy=\"Retain\" \\\n--namespace nfs-sc --create-namespace\n\n# --------------------- \u8ba4\u955c\u50cf\u4e0b\u8f7d\u7f51\u7edc\u53d7\u9650\uff0c\u4f7f\u7528\u4e2d\u56fd\u5185\u90e8\u955c\u50cf ------------------------------------\nhelm install nfs-subdir-external-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \\\n--set image.repository=easzlab/nfs-subdir-external-provisioner \\\n--set image.tag=v4.0.2 \\\n--set nfs.server=192.168.1.60 \\\n--set nfs.path=/QaTest \\\n--set storageClass.name=gitee-nfs-client \\\n--set storageClass.reclaimPolicy=\"Retain\" \\\n--namespace nfs-sc --create-namespace\n</code></pre> <p>\u68c0\u67e5StorageClass\u90e8\u7f72\u72b6\u6001</p> <pre><code>$ kubectl get pod -n nfs-sc\nNAME                                               READY   STATUS    RESTARTS   AGE\nnfs-subdir-external-provisioner-7fdff5bfc9-q28qc   1/1     Running   0          2m49s\n\n$ kubectl get sc\nNAME               PROVISIONER                                     RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE\ngitee-nfs-client   cluster.local/nfs-subdir-external-provisioner   Retain          Immediate           true                   2m54s\n\n$ helm list -n nfs-sc\nNAME                            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                                   APP VERSION\nnfs-subdir-external-provisioner nfs-sc          1               2022-10-18 14:41:18.070839496 +0800 CST deployed        nfs-subdir-external-provisioner-4.0.17  4.0.2\n</code></pre> <p>\u5982\u4e0a\u663e\u793a\uff0c\u8868\u793aStorageClass\u542f\u52a8\u6b63\u5e38\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#23--\u90e8\u7f72jenkins","title":"2.3  \u90e8\u7f72jenkins","text":"<p>\u524d\u63d0\u6761\u4ef6\uff1aNFS \u7c7b\u578b\u7684 StorageClass \u6765\u505a\u6301\u4e45\u5316\u5b58\u50a8,  StorageClass \u540d\u79f0<code>gitee-nfs-client</code></p> <p>\u539f\u59cb\u4ed3\u5e93</p> <pre><code>$ helm repo add jenkins https://charts.jenkins.io\n$ helm repo update\n</code></pre> <p>Chart \u4ed3\u5e93\u5730\u5740\uff1ahttps://hujianli94.github.io/mycharts/jenkinsci</p> <p>\u8bbe\u7f6ehelm\u6e90</p> <pre><code>$ helm repo add mycharts https://hujianli94.github.io/mycharts/\n$ helm repo update\n$ helm search repo jenkinsci\nNAME                    CHART VERSION   APP VERSION     DESCRIPTION\nmycharts/jenkinsci      0.1.0           2.390-jdk11     A Helm chart for Kubernetes\n\n$ helm pull mycharts/jenkinsci --version=0.1.0\n$ helm pull mycharts/jenkinsci --version=0.1.0 --untar\n\n# \u4fee\u6539jenkinsci/values.yaml\u914d\u7f6e\n## \u4fee\u6539storageClassName\n## \u4fee\u6539nfs\u4fe1\u606f\n## \u6839\u636e\u8981\u6c42\u8fdb\u884c\u4fee\u6539\n</code></pre> <p>\u4f7f\u7528helm\u8fdb\u884c\u90e8\u7f72</p> <pre><code>$ helm upgrade jenkinsci jenkinsci --install --namespace kube-ops --create-namespace\nRelease \"jenkinsci\" does not exist. Installing it now.\nNAME: jenkinsci\nLAST DEPLOYED: Wed Feb 15 10:04:21 2023\nNAMESPACE: kube-ops\nSTATUS: deployed\nREVISION: 1\nNOTES:\n1. Get the application URL by running these commands:\n  export NODE_PORT=$(kubectl get --namespace kube-ops -o jsonpath=\"{.spec.ports[0].nodePort}\" services jenkinsci)\nexport NODE_IP=$(kubectl get nodes --namespace kube-ops -o jsonpath=\"{.items[0].status.addresses[0].address}\")\necho http://$NODE_IP:$NODE_PORT\n</code></pre> <p>\u67e5\u770b\u90e8\u7f72pod\u7684\u72b6\u6001\u548c\u65e5\u5fd7</p> <pre><code># kubectl get pod,svc,pvc -n kube-ops\nNAME                             READY   STATUS    RESTARTS   AGE\npod/jenkinsci-6465964b6d-rplhl   1/1     Running   0          2m43s\n\nNAME                TYPE       CLUSTER-IP        EXTERNAL-IP   PORT(S)                          AGE\nservice/jenkinsci   NodePort   192.168.105.182   &lt;none&gt;        8080:32080/TCP,50000:32050/TCP   2m43s\n\nNAME                              STATUS   VOLUME      CAPACITY   ACCESS MODES   STORAGECLASS       AGE\npersistentvolumeclaim/jenkinsci   Bound    jenkinsci   100Gi      RWO            gitee-nfs-client   2m43s\n\n# kubectl exec -it pod/jenkinsci-6465964b6d-rplhl  -n kube-ops -- cat /var/jenkins_home/secrets/initialAdminPassword\n917475173c3746959bcd50d608fb28d7\n\n# kubectl logs -f pod/jenkinsci-6465964b6d-rplhl -n kube-ops\n.....\nJenkins initial setup is required. An admin user has been created and a password generated.\nPlease use the following password to proceed to installation:\n\n917475173c3746959bcd50d608fb28d7\n\nThis may also be found at: /var/jenkins_home/secrets/initialAdminPassword\n\n*************************************************************\n*************************************************************\n*************************************************************\n</code></pre> <p>\u4f7f\u7528Node+NodePort\u7aef\u53e3\u8fdb\u884c\u8bbf\u95ee\uff0c\u4f7f\u7528\u521d\u59cb\u5bc6\u7801\u767b\u5f55\u3002</p> <p>\u5b89\u88c5\u63d2\u4ef6\u914d\u7f6e\u7136\u540e\u57fa\u672c\u73af\u5883\u5176\u4ed6\u64cd\u4f5c\u4e0edocker\u90e8\u7f72\u4e00\u81f4\u3002</p> <p>\u53c2\u8003\u6587\u732e\uff1a</p> <p>https://www.yuque.com/wuyuexin/bu3d95/eikxqa</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#3-yaml\u65b9\u5f0f\u90e8\u7f72\u4e0d\u63a8\u8350","title":"3. yaml\u65b9\u5f0f\u90e8\u7f72(\u4e0d\u63a8\u8350)","text":"<p>\u65e2\u7136\u8981\u57fa\u4e8e Kubernetes \u6765\u505a CI/CD\uff0c\u6211\u4eec\u8fd9\u91cc\u6700\u597d\u8fd8\u662f\u5c06 Jenkins \u5b89\u88c5\u5230 Kubernetes \u96c6\u7fa4\u5f53\u4e2d\uff0c\u5b89\u88c5\u7684\u65b9\u5f0f\u4e5f\u5f88\u591a\uff0c\u6211\u4eec\u8fd9\u91cc\u4ecd\u7136\u8fd8\u662f\u4f7f\u7528\u624b\u52a8\u7684\u65b9\u5f0f\uff0c\u8fd9\u6837\u53ef\u4ee5\u4e86\u89e3\u66f4\u591a\u7ec6\u8282\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <p><code>jenkins-pv.yaml</code></p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\nname: jenkinsci\nlabels:\napp: jenkinsci\nspec:\ncapacity:\nstorage: 100Gi\naccessModes:\n- ReadWriteOnce\npersistentVolumeReclaimPolicy: Retain\nstorageClassName: gitee-nfs-client\nmountOptions:\n- hard\n- nfsvers=4.1\nnfs:\nserver: 192.168.1.60\npath: /QaTest/jenkins\n---\nkind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\nname: jenkins-pvc\nnamespace: kube-ops\nspec:\naccessModes:\n- ReadWriteOnce\nstorageClassName: gitee-nfs-client\nresources:\nrequests:\nstorage: 100Gi\nselector:\nmatchLabels:\napp: jenkinsci\n</code></pre> <p>\u5728storageClassName\u7684\u6307\u5b9a\u76ee\u5f55\u4e0b\u6301\u4e45\u5316\u6570\u636e\uff0c\u8bbe\u7f6e\u6307\u5b9a\u540d\u79f0\u7684\u9759\u6001PV\u548cPVC\u3002</p> <p><code>jenkins.yaml</code></p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\nname: jenkins\nnamespace: kube-ops\n---\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\nname: jenkins\nrules:\n- apiGroups: [\"extensions\", \"apps\"]\nresources: [\"deployments\", \"ingresses\"]\nverbs: [\"create\", \"delete\", \"get\", \"list\", \"watch\", \"patch\", \"update\"]\n- apiGroups: [\"\"]\nresources: [\"services\"]\nverbs: [\"create\", \"delete\", \"get\", \"list\", \"watch\", \"patch\", \"update\"]\n- apiGroups: [\"\"]\nresources: [\"pods\"]\nverbs: [\"create\", \"delete\", \"get\", \"list\", \"patch\", \"update\", \"watch\"]\n- apiGroups: [\"\"]\nresources: [\"pods/exec\"]\nverbs: [\"create\", \"delete\", \"get\", \"list\", \"patch\", \"update\", \"watch\"]\n- apiGroups: [\"\"]\nresources: [\"pods/log\", \"events\"]\nverbs: [\"get\", \"list\", \"watch\"]\n- apiGroups: [\"\"]\nresources: [\"secrets\"]\nverbs: [\"get\"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\nname: jenkins\nnamespace: kube-ops\nroleRef:\napiGroup: rbac.authorization.k8s.io\nkind: ClusterRole\nname: jenkins\nsubjects:\n- kind: ServiceAccount\nname: jenkins\nnamespace: kube-ops\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: jenkins\nnamespace: kube-ops\nspec:\nselector:\nmatchLabels:\napp: jenkins\ntemplate:\nmetadata:\nlabels:\napp: jenkins\nspec:\nserviceAccount: jenkins\ninitContainers:\n- name: fix-permissions\nimage: busybox:1.35.0\ncommand: [\"sh\", \"-c\", \"chown -R 1000:1000 /var/jenkins_home\"]\nsecurityContext:\nprivileged: true\nvolumeMounts:\n- name: jenkinshome\nmountPath: /var/jenkins_home\ncontainers:\n- name: jenkins\nimage: jenkins/jenkins:2.390-jdk11\nimagePullPolicy: IfNotPresent\nenv:\n- name: JAVA_OPTS\nvalue: -Dhudson.model.DownloadService.noSignatureCheck=true\nports:\n- containerPort: 8080\nname: web\nprotocol: TCP\n- containerPort: 50000\nname: agent\nprotocol: TCP\nresources:\nlimits:\ncpu: 1500m\nmemory: 2048Mi\nrequests:\ncpu: 1500m\nmemory: 2048Mi\nreadinessProbe:\nhttpGet:\npath: /login\nport: 8080\ninitialDelaySeconds: 60\ntimeoutSeconds: 5\nfailureThreshold: 12\nvolumeMounts:\n- name: jenkinshome\nmountPath: /var/jenkins_home\nvolumes:\n- name: jenkinshome\npersistentVolumeClaim:\nclaimName: jenkins-pvc\n---\napiVersion: v1\nkind: Service\nmetadata:\nname: jenkins\nnamespace: kube-ops\nlabels:\napp: jenkins\nspec:\ntype: NodePort\nselector:\napp: jenkins\nports:\n- name: web\nport: 8080\ntargetPort: web\nnodePort: 32080\n- name: agent\nport: 50000\ntargetPort: agent\nnodePort: 32050\n</code></pre> <p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u955c\u50cf\u5185\u90e8\u8fd0\u884c\u7684\u7528\u6237 <code>uid=1000</code>\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u6302\u8f7d\u51fa\u6765\u540e\u4f1a\u51fa\u73b0\u6743\u9650\u95ee\u9898\uff0c\u4e3a\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u540c\u6837\u8fd8\u662f\u7528\u4e00\u4e2a\u7b80\u5355\u7684 <code>initContainer</code> \u6765\u4fee\u6539\u4e0b\u6211\u4eec\u6302\u8f7d\u7684\u6570\u636e\u76ee\u5f55\u3002</p> <p>\u6211\u4eec\u76f4\u63a5\u6765\u521b\u5efa jenkins \u7684\u8d44\u6e90\u6e05\u5355\u5373\u53ef\uff1a</p> <pre><code># kubectl apply -f jenkins-pv.yaml\n# kubectl apply -f jenkins.yaml\n# kubectl get all -n kube-ops\nNAME                          READY   STATUS    RESTARTS   AGE\npod/jenkins-95db8c7dc-d9hrq   1/1     Running   0          7m52s\n\nNAME              TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                          AGE\nservice/jenkins   NodePort   192.168.59.29   &lt;none&gt;        8080:32080/TCP,50000:32050/TCP   7m52s\n\nNAME                      READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/jenkins   1/1     1            1           7m52s\n\nNAME                                DESIRED   CURRENT   READY   AGE\nreplicaset.apps/jenkins-95db8c7dc   1         1         1       7m52s\n</code></pre> <p>\u7136\u540e\u53ef\u4ee5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u83b7\u53d6\u89e3\u9501\u7684\u7ba1\u7406\u5458\u5bc6\u7801\uff1a</p> <pre><code># kubectl exec -it pod/jenkins-95db8c7dc-d9hrq  -n kube-ops -- cat /var/jenkins_home/secrets/initialAdminPassword\nDefaulted container \"jenkins\" out of: jenkins, fix-permissions (init)\nb9a201f71e67434f828c0fe59a94e460  # jenkins\u542f\u52a8\u65e5\u5fd7\u91cc\u9762\u4e5f\u6709\n</code></pre> <p>\u4f7f\u7528Node+NodePort\u7aef\u53e3\u8fdb\u884c\u8bbf\u95ee\uff0c\u4f7f\u7528\u521d\u59cb\u5bc6\u7801\u767b\u5f55\u3002</p> <p>\u5b89\u88c5\u63d2\u4ef6\u914d\u7f6e\u7136\u540e\u57fa\u672c\u73af\u5883\u5176\u4ed6\u64cd\u4f5c\u4e0edocker\u90e8\u7f72\u4e00\u81f4\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#4-\u67b6\u6784","title":"4. \u67b6\u6784","text":"<p>Jenkins \u5b89\u88c5\u5b8c\u6210\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u4e0d\u7528\u6025\u7740\u5c31\u53bb\u4f7f\u7528\uff0c\u6211\u4eec\u8981\u4e86\u89e3\u4e0b\u5728 Kubernetes \u73af\u5883\u4e0b\u9762\u4f7f\u7528 Jenkins \u6709\u4ec0\u4e48\u597d\u5904\u3002</p> <p>\u6211\u4eec\u77e5\u9053\u6301\u7eed\u6784\u5efa\u4e0e\u53d1\u5e03\u662f\u6211\u4eec\u65e5\u5e38\u5de5\u4f5c\u4e2d\u5fc5\u4e0d\u53ef\u5c11\u7684\u4e00\u4e2a\u6b65\u9aa4\uff0c\u76ee\u524d\u5927\u591a\u516c\u53f8\u90fd\u91c7\u7528 Jenkins \u96c6\u7fa4\u6765\u642d\u5efa\u7b26\u5408\u9700\u6c42\u7684 CI/CD \u6d41\u7a0b\uff0c\u7136\u800c\u4f20\u7edf\u7684 Jenkins Slave \u4e00\u4e3b\u591a\u4ece\u65b9\u5f0f\u4f1a\u5b58\u5728\u4e00\u4e9b\u75db\u70b9\uff0c\u6bd4\u5982\uff1a</p> <ul> <li>\u4e3b Master \u53d1\u751f\u5355\u70b9\u6545\u969c\u65f6\uff0c\u6574\u4e2a\u6d41\u7a0b\u90fd\u4e0d\u53ef\u7528\u4e86</li> <li>\u6bcf\u4e2a Slave \u7684\u914d\u7f6e\u73af\u5883\u4e0d\u4e00\u6837\uff0c\u6765\u5b8c\u6210\u4e0d\u540c\u8bed\u8a00\u7684\u7f16\u8bd1\u6253\u5305\u7b49\u64cd\u4f5c\uff0c\u4f46\u662f\u8fd9\u4e9b\u5dee\u5f02\u5316\u7684\u914d\u7f6e\u5bfc\u81f4\u7ba1\u7406\u8d77\u6765\u975e\u5e38\u4e0d\u65b9\u4fbf\uff0c\u7ef4\u62a4\u8d77\u6765\u4e5f\u662f\u6bd4\u8f83\u8d39\u52b2</li> <li>\u8d44\u6e90\u5206\u914d\u4e0d\u5747\u8861\uff0c\u6709\u7684 Slave \u8981\u8fd0\u884c\u7684 job \u51fa\u73b0\u6392\u961f\u7b49\u5f85\uff0c\u800c\u6709\u7684 Slave \u5904\u4e8e\u7a7a\u95f2\u72b6\u6001</li> <li>\u8d44\u6e90\u6709\u6d6a\u8d39\uff0c\u6bcf\u53f0 Slave \u53ef\u80fd\u662f\u7269\u7406\u673a\u6216\u8005\u865a\u62df\u673a\uff0c\u5f53 Slave \u5904\u4e8e\u7a7a\u95f2\u72b6\u6001\u65f6\uff0c\u4e5f\u4e0d\u4f1a\u5b8c\u5168\u91ca\u653e\u6389\u8d44\u6e90\u3002</li> </ul> <p>\u6b63\u56e0\u4e3a\u4e0a\u9762\u7684\u8fd9\u4e9b\u79cd\u79cd\u75db\u70b9\uff0c\u6211\u4eec\u6e34\u671b\u4e00\u79cd\u66f4\u9ad8\u6548\u66f4\u53ef\u9760\u7684\u65b9\u5f0f\u6765\u5b8c\u6210\u8fd9\u4e2a CI/CD \u6d41\u7a0b\uff0c\u800c Docker \u865a\u62df\u5316\u5bb9\u5668\u6280\u672f\u80fd\u5f88\u597d\u7684\u89e3\u51b3\u8fd9\u4e2a\u75db\u70b9\uff0c\u53c8\u7279\u522b\u662f\u5728 Kubernetes \u96c6\u7fa4\u73af\u5883\u4e0b\u9762\u80fd\u591f\u66f4\u597d\u6765\u89e3\u51b3\u4e0a\u9762\u7684\u95ee\u9898\uff0c\u4e0b\u56fe\u662f\u57fa\u4e8e Kubernetes \u642d\u5efa Jenkins \u96c6\u7fa4\u7684\u7b80\u5355\u793a\u610f\u56fe\uff1a</p> <p>)</p> <p>\u4ece\u56fe\u4e0a\u53ef\u4ee5\u770b\u5230 <code>Jenkins Master</code> \u548c <code>Jenkins Slave</code> \u4ee5 Pod \u5f62\u5f0f\u8fd0\u884c\u5728 Kubernetes \u96c6\u7fa4\u7684 Node \u4e0a\uff0cMaster \u8fd0\u884c\u5728\u5176\u4e2d\u4e00\u4e2a\u8282\u70b9\uff0c\u5e76\u4e14\u5c06\u5176\u914d\u7f6e\u6570\u636e\u5b58\u50a8\u5230\u4e00\u4e2a Volume \u4e0a\u53bb\uff0cSlave \u8fd0\u884c\u5728\u5404\u4e2a\u8282\u70b9\u4e0a\uff0c\u5e76\u4e14\u5b83\u4e0d\u662f\u4e00\u76f4\u5904\u4e8e\u8fd0\u884c\u72b6\u6001\uff0c\u5b83\u4f1a\u6309\u7167\u9700\u6c42\u52a8\u6001\u7684\u521b\u5efa\u5e76\u81ea\u52a8\u5220\u9664\u3002</p> <p>\u8fd9\u79cd\u65b9\u5f0f\u7684\u5de5\u4f5c\u6d41\u7a0b\u5927\u81f4\u4e3a\uff1a\u5f53 Jenkins Master \u63a5\u53d7\u5230 Build \u8bf7\u6c42\u65f6\uff0c\u4f1a\u6839\u636e\u914d\u7f6e\u7684 Label \u52a8\u6001\u521b\u5efa\u4e00\u4e2a\u8fd0\u884c\u5728 Pod \u4e2d\u7684 Jenkins Slave \u5e76\u6ce8\u518c\u5230 Master \u4e0a\uff0c\u5f53\u8fd0\u884c\u5b8c Job \u540e\uff0c\u8fd9\u4e2a Slave \u4f1a\u88ab\u6ce8\u9500\u5e76\u4e14\u8fd9\u4e2a Pod \u4e5f\u4f1a\u81ea\u52a8\u5220\u9664\uff0c\u6062\u590d\u5230\u6700\u521d\u72b6\u6001\u3002</p> <p>\u90a3\u4e48\u6211\u4eec\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u5e26\u6765\u4e86\u54ea\u4e9b\u597d\u5904\u5462\uff1f</p> <ul> <li>\u670d\u52a1\u9ad8\u53ef\u7528\uff0c\u5f53 Jenkins Master \u51fa\u73b0\u6545\u969c\u65f6\uff0cKubernetes \u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Jenkins Master \u5bb9\u5668\uff0c\u5e76\u4e14\u5c06 Volume \u5206\u914d\u7ed9\u65b0\u521b\u5efa\u7684\u5bb9\u5668\uff0c\u4fdd\u8bc1\u6570\u636e\u4e0d\u4e22\u5931\uff0c\u4ece\u800c\u8fbe\u5230\u96c6\u7fa4\u670d\u52a1\u9ad8\u53ef\u7528\u3002</li> <li>\u52a8\u6001\u4f38\u7f29\uff0c\u5408\u7406\u4f7f\u7528\u8d44\u6e90\uff0c\u6bcf\u6b21\u8fd0\u884c Job \u65f6\uff0c\u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a Jenkins Slave\uff0cJob \u5b8c\u6210\u540e\uff0cSlave \u81ea\u52a8\u6ce8\u9500\u5e76\u5220\u9664\u5bb9\u5668\uff0c\u8d44\u6e90\u81ea\u52a8\u91ca\u653e\uff0c\u800c\u4e14 Kubernetes \u4f1a\u6839\u636e\u6bcf\u4e2a\u8d44\u6e90\u7684\u4f7f\u7528\u60c5\u51b5\uff0c\u52a8\u6001\u5206\u914d Slave \u5230\u7a7a\u95f2\u7684\u8282\u70b9\u4e0a\u521b\u5efa\uff0c\u964d\u4f4e\u51fa\u73b0\u56e0\u67d0\u8282\u70b9\u8d44\u6e90\u5229\u7528\u7387\u9ad8\uff0c\u8fd8\u6392\u961f\u7b49\u5f85\u5728\u8be5\u8282\u70b9\u7684\u60c5\u51b5\u3002</li> <li>\u6269\u5c55\u6027\u597d\uff0c\u5f53 Kubernetes \u96c6\u7fa4\u7684\u8d44\u6e90\u4e25\u91cd\u4e0d\u8db3\u800c\u5bfc\u81f4 Job \u6392\u961f\u7b49\u5f85\u65f6\uff0c\u53ef\u4ee5\u5f88\u5bb9\u6613\u7684\u6dfb\u52a0\u4e00\u4e2a Kubernetes Node \u5230\u96c6\u7fa4\u4e2d\uff0c\u4ece\u800c\u5b9e\u73b0\u6269\u5c55\u3002 \u662f\u4e0d\u662f\u4ee5\u524d\u6211\u4eec\u9762\u4e34\u7684\u79cd\u79cd\u95ee\u9898\u5728 Kubernetes \u96c6\u7fa4\u73af\u5883\u4e0b\u9762\u662f\u4e0d\u662f\u90fd\u6ca1\u6709\u4e86\u554a\uff1f\u770b\u4e0a\u53bb\u975e\u5e38\u5b8c\u7f8e\u3002</li> </ul>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#1-\u914d\u7f6e","title":"1. \u914d\u7f6e","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u9700\u8981\u6765\u914d\u7f6e Jenkins\uff0c\u8ba9\u4ed6\u80fd\u591f\u52a8\u6001\u7684\u751f\u6210 Slave \u7684 Pod\u3002</p> <p>\u7b2c 1 \u6b65. \u6211\u4eec\u9700\u8981\u5b89\u88c5 kubernetes \u63d2\u4ef6\uff0c \u70b9\u51fb Manage Jenkins -&gt; Manage Plugins -&gt; Available -&gt; Kubernetes \u52fe\u9009\u5b89\u88c5\u5373\u53ef\u3002</p> <p>\u7b2c 2 \u6b65. \u5b89\u88c5\u5b8c\u6bd5\u540e\uff0c\u8fdb\u5165configureClouds\u9875\u9762\uff1a</p> <p>)</p> <p>\u5728\u8be5\u9875\u9762\u6211\u4eec\u53ef\u4ee5\u70b9\u51fb <code>Add a new cloud</code> -&gt; \u9009\u62e9 <code>Kubernetes</code>\uff0c\u9996\u5148\u70b9\u51fb <code>Kubernetes Cloud details...</code> \u6309\u94ae\u8fdb\u884c\u914d\u7f6e\u3002</p> <p>\u9996\u5148\u914d\u7f6e\u8fde\u63a5 Kubernetes APIServer \u7684\u5730\u5740\uff0c\u7531\u4e8e\u6211\u4eec\u7684 Jenkins \u8fd0\u884c\u5728 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u6240\u4ee5\u53ef\u4ee5\u4f7f\u7528 Service \u7684 DNS \u5f62\u5f0f\u8fdb\u884c\u8fde\u63a5 <code>https://kubernetes.default.svc.cluster.local</code>\uff1a</p> <p>\u6ce8\u610f namespace\uff0c\u6211\u4eec\u8fd9\u91cc\u586b kube-ops\uff0c\u51ed\u636e\u8f93\u5165KUBECONFIG\u6587\u4ef6\u5bf9\u5e94\u7684\u51ed\u8bc1\uff0c\u7136\u540e\u70b9\u51fb <code>Test Connection</code>\uff0c\u5982\u679c\u51fa\u73b0 <code>Connected to Kubernetes...</code> \u7684\u63d0\u793a\u4fe1\u606f\u8bc1\u660e Jenkins \u5df2\u7ecf\u53ef\u4ee5\u548c Kubernetes \u7cfb\u7edf\u6b63\u5e38\u901a\u4fe1\u4e86\u3002</p> <p>)</p> <p>\u7136\u540e\u4e0b\u65b9\u7684 Jenkins URL \u5730\u5740\uff1a<code>http://jenkinsci.kube-ops.svc.cluster.local:8080</code>\uff0c\u8fd9\u91cc\u7684\u683c\u5f0f\u4e3a\uff1a<code>\u670d\u52a1\u540d.namespace.svc.cluster.local:8080</code>\uff0c\u6839\u636e\u4e0a\u9762\u521b\u5efa\u7684 jenkins \u7684\u670d\u52a1\u540d\u586b\u5199\uff0c\u5305\u62ec\u4e0b\u9762\u7684Jenkins\u901a\u9053\uff0c\u9ed8\u8ba4\u662f50000\u7aef\u53e3\uff08\u8981\u6ce8\u610f\u662f TCP\uff0c\u6240\u4ee5\u4e0d\u8981\u586b\u5199 http\uff09\u3002</p> <p>\u914d\u7f6ejenkins-slave\u955c\u50cf\u3002</p> <pre><code>[root@k8s-master01 jenkins-slave]# tree -a\n.\n\u251c\u2500\u2500 bin\n    \u251c\u2500\u2500 docker\n    \u251c\u2500\u2500 helm\n    \u2514\u2500\u2500 kubectl\n\u251c\u2500\u2500 config\n    \u2514\u2500\u2500 config\n\u251c\u2500\u2500 Dockerfile\n\u2514\u2500\u2500 .ssh\n    \u251c\u2500\u2500 authorized_keys\n    \u251c\u2500\u2500 id_rsa\n    \u251c\u2500\u2500 id_rsa.pub\n    \u2514\u2500\u2500 known_hosts\n3 directories, 9 files\n\n# cat Dockerfile\nFROM jenkins/jnlp-slave:4.13.3-1-jdk11\nMAINTAINER hjl@94qq.com\n\nUSER root\n\nENV JENKINS_AGENT_WORKDIR=/home/jenkins/agent\n\nRUN set -eux; \\\nsed -i 's#http://deb.debian.org#https://mirrors.163.com#g' /etc/apt/sources.list \\\n&amp;&amp; apt update \\\n&amp;&amp; apt install -y python  \\\nsshpass  \\\nrsync \\\nmake  \\\ngcc  \\\ncurl  \\\nnet-tools  \\\nwget  \\\n--no-install-recommends \\\n&amp;&amp; apt-get -y autoremove --purge \\\n&amp;&amp; rm -rf /var/lib/apt/lists/* \\\n&amp;&amp; mkdir -p /home/jenkins/.ssh\n\nENV PATH=/opt/java/openjdk/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/jenkins/bin\n\nCOPY --chown=root:root bin /home/jenkins/bin\nCOPY --chown=root:root .ssh /root/.ssh\n\nRUN set -eux ; \\\nchmod 755 /home/jenkins/bin/*\n\n# docker build -t hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11 .\n# docker push hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11\nThe push refers to repository [hub.gitee.cc/kubernetes/jenkins-salve]\nf861fb1f9735: Pushing [===&gt;                                               ]  11.11MB/150.2MB\n.....\n</code></pre> <p>\u7b2c 3 \u6b65. \u70b9\u51fb\u6700\u4e0b\u65b9\u7684 <code>Pod Templates</code> \u6309\u94ae\u7528\u4e8e\u914d\u7f6e Jenkins Slave \u8fd0\u884c\u7684 Pod \u6a21\u677f\uff0c\u547d\u540d\u7a7a\u95f4\u6211\u4eec\u540c\u6837\u662f\u7528 kube-ops\uff0cLabels \u8fd9\u91cc\u4e5f\u975e\u5e38\u91cd\u8981\uff0c\u5bf9\u4e8e\u540e\u9762\u6267\u884c Job \u7684\u65f6\u5019\u9700\u8981\u7528\u5230\u8be5\u503c\u3002</p> <p>)</p> <p>\u914d\u7f6e\u7684Slave Pod\u4e2d\u7684Label\u540d\u79f0</p> <p>)</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#11-docker-in-pod","title":"1.1 docker in pod","text":"<p>\u914d\u7f6e\u5bb9\u5668\u6a21\u677f</p> <p>jenkins-salve\u6a21\u677f\u5bb9\u5668\u914d\u7f6e</p> <p>)</p> <p>\u6ce8\u610f</p> <p>\u5bb9\u5668\u7684\u540d\u79f0\u5fc5\u987b\u662f <code>jnlp</code>\uff0c\u8fd9\u662f\u9ed8\u8ba4\u62c9\u8d77\u7684\u5bb9\u5668\uff0c\u53e6\u5916\u9700\u8981\u5c06 <code>\u8fd0\u884c\u7684\u547d\u4ee4</code> \u548c <code>\u547d\u4ee4\u53c2\u6570</code> \u7684\u503c\u90fd\u5220\u9664\u6389\uff0c\u5426\u5219\u4f1a\u5931\u8d25\u3002</p> <p>\u7531\u4e8ejnlp\u5bb9\u5668\u4e2d\u53ea\u662f docker cli\uff0c\u9700\u8981 docker daemon \u624d\u80fd\u6b63\u5e38\u4f7f\u7528\uff0c\u6211\u4eec\u901a\u5e38\u60c5\u51b5\u4e0b\u7684\u505a\u6cd5\u662f\u5c06\u5bbf\u4e3b\u673a\u4e0a\u7684 docker sock \u6587\u4ef6 <code>/var/run/docker.sock</code> \u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\uff0c\u4f46\u662f\u6211\u4eec\u73b0\u5728\u7684 Kubernetes \u96c6\u7fa4\u4f7f\u7528\u7684\u662f containerd \u8fd9\u79cd\u5bb9\u5668\u8fd0\u884c\u65f6\uff0c\u8282\u70b9\u4e0a\u6ca1\u6709 docker daemon\u3002\u6211\u4eec\u53ef\u4ee5\u5355\u72ec\u4ee5 Pod \u7684\u5f62\u5f0f\u5728\u96c6\u7fa4\u4e2d\u8dd1\u4e00\u4e2a docker daemon \u7684\u670d\u52a1\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>---\napiVersion: v1\nkind: PersistentVolume\nmetadata:\nname: docker-dind-pv\nlabels:\napp: docker-dind-pv\nspec:\ncapacity:\nstorage: 10Gi\naccessModes:\n- ReadWriteOnce\npersistentVolumeReclaimPolicy: Retain\nstorageClassName: gitee-nfs-client\nmountOptions:\n- hard\n- nfsvers=4.1\nnfs:\nserver: 192.168.1.60\npath: /QaTest/docker-dind\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\nlabels:\napp: docker-dind\nname: docker-dind-data\nnamespace: kube-ops\nspec:\naccessModes:\n- ReadWriteOnce\nstorageClassName: gitee-nfs-client\nresources:\nrequests:\nstorage: 10Gi\nselector:\nmatchLabels:\napp: docker-dind-pv\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: docker-dind\nnamespace: kube-ops\nlabels:\napp: docker-dind\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: docker-dind\ntemplate:\nmetadata:\nlabels:\napp: docker-dind\nspec:\ncontainers:\n- image: docker:dind\nname: docker-dind\nargs:\n# \u963f\u91cc\u4e91\u52a0\u901f\n- --registry-mirror=https://25bxwt20.mirror.aliyuncs.com\n# \u79c1\u6709harbor\u4ed3\u5e93\n- --insecure-registry=http://hub.gitee.cc\nenv:\n- name: DOCKER_TLS_CERTDIR\nvalue: \"\"\n- name: DOCKER_HOST\nvalue: tcp://0.0.0.0:2375\nvolumeMounts:\n- name: docker-dind-data-vol\nmountPath: /var/lib/docker/\n# \u751f\u4ea7\u73af\u5883\u5c06docker-dind\u90e8\u7f72\u56fa\u5b9a\u5728\u6027\u80fd\u597d\u7684\u670d\u52a1\u5668\u4e0a\uff0c\u6253\u4e0atag\nresources:\nrequests:\nmemory: \"8192Mi\"\ncpu: \"8192m\"\nlimits:\nmemory: \"1024Mi\"\ncpu: \"1024m\"\nports:\n- name: daemon-port\ncontainerPort: 2375\nsecurityContext:\nprivileged: true\nvolumes:\n- name: docker-dind-data-vol\npersistentVolumeClaim:\nclaimName: docker-dind-data\n---\napiVersion: v1\nkind: Service\nmetadata:\nname: docker-dind\nnamespace: kube-ops\nlabels:\napp: docker-dind\nspec:\nports:\n- port: 2375\ntargetPort: 2375\nselector:\napp: docker-dind\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code># kubectl apply -f docker-dind.yaml\n# kubectl get pods -n kube-ops -l app=docker-dind\nNAME                           READY   STATUS    RESTARTS   AGE\ndocker-dind-86d95bfc49-wq248   1/1     Running   0          17s\n\n# kubectl get svc -n kube-ops -l app=docker-dind\nNAME          TYPE        CLUSTER-IP        EXTERNAL-IP   PORT(S)    AGE\ndocker-dind   ClusterIP   192.168.172.137   &lt;none&gt;        2375/TCP   6m3s\n</code></pre> <p>\u6269\u5c55\u53c2\u8003\u6587\u732e</p> <p>\u6d41\u6c34\u7ebf\u4e2d\u4f7f\u7528 docker in pod \u65b9\u5f0f\u6784\u5efa\u5bb9\u5668\u955c\u50cf</p> <p>https://blog.csdn.net/alex_yangchuansheng/article/details/123564347</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#12-\u7269\u7406\u673abuild\u63a8\u8350","title":"1.2 \u7269\u7406\u673abuild(\u63a8\u8350)","text":"<p>\u7269\u7406\u673a\u53ef\u4ee5\u5b89\u88c5\u8d1f\u8f7d\u5747\u8861\u3001\u53cd\u5411\u4ee3\u7406\uff08haproxy\u3001nginx\uff09\u8f6f\u4ef6\uff0c\u5236\u4f5c\u4e00\u4e2adocker build \u5206\u53d1\u6c60\uff0c\u5206\u644abuild\u6784\u5efa\u538b\u529b\u3002</p> <p>\u53c2\u8003\uff1ahttps://www.weixueyuan.net/a/790.html</p> <p>\u5728\u547d\u4ee4\u884c\u4e0a\u6765\u521b\u5efa Secret\u63d0\u4f9b\u79c1\u6709\u4ed3\u5e93\u62c9\u53d6\u51ed\u8bc1\u3002\u8fd9\u6837<code>hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11</code>\u79c1\u6709\u955c\u50cf\u5c31\u80fd\u6b63\u5e38\u62c9\u53d6\u4e86\u3002</p> <pre><code># kubectl -n kube-ops create secret docker-registry regcred \\\n--docker-server=http://hub.gitee.cc \\\n--docker-username=admin \\\n--docker-password=oschina123 \\\n--docker-email=1@1.com\n</code></pre> <p>\u53c2\u8003\uff1ahttps://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/pull-image-private-registry/</p> <p>\u5728\u56fe\u5f62\u754c\u9762\u4e2d\u8bbe\u7f6e\u62c9\u53d6\u51ed\u8bc1\u4fe1\u606f\u3002</p> <p>)</p> <p>\u6ce8\u610f</p> <p>\u5982\u679c\u8bfb\u8005\u7684Kubernetes\u96c6\u7fa4\u91c7\u7528\u7684\u662fContainerd\u4f5c\u4e3aRuntime\uff0c\u914d\u7f6einsecure-registry\u53ea\u9700\u8981\u5728Containerd\u914d\u7f6e\u6587\u4ef6\u7684mirrors\u4e0b\u6dfb\u52a0\u81ea\u5df1\u7684\u955c\u50cf\u4ed3\u5e93\u5730\u5740\u5373\u53ef</p> <p>vim /etc/containerd/config.toml</p> <pre><code>    [plugins.\"io.containerd.grpc.v1.cri\".registry]\n      config_path = \"\"\n\n      [plugins.\"io.containerd.grpc.v1.cri\".registry.auths]\n\n      [plugins.\"io.containerd.grpc.v1.cri\".registry.configs]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"hub.gitee.cc\".tls]\n          insecure_skip_verify = true\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"hub.gitee.cc\".auth]\n      [plugins.\"io.containerd.grpc.v1.cri\".registry.headers]\n\n      [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"]\n          endpoint = [\"https://pooj3a7i.mirror.aliyuncs.com\"]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"hub.gitee.cc\"]\n          endpoint = [\"http://hub.gitee.cc\"]\n</code></pre> <p>\u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u91cd\u542fContainerd\uff0c\u4e4b\u540e\u8fdb\u884cpull\u6d4b\u8bd5\uff1a</p> <pre><code># systemctl restart containerd\n# ctr -n k8s.io image pull hub.gitee.cc/kubernetes/webkubectl:latest --plain-http --user admin:oschina123 \n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf <code>DOCKER_HOST: tcp://docker-dind:2375</code> \u53bb\u8fde\u63a5 docker dind \u670d\u52a1\u3002</p> <p>\u53e6\u5916\u9700\u8981\u5c06\u6587\u4ef6 <code>/root/.kube/config</code> \u6302\u8f7d\u5230\u5bb9\u5668\u7684 <code>/root/.kube/</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u8fd9\u662f\u4e3a\u4e86\u8ba9\u6211\u4eec\u80fd\u591f\u5728 Pod \u7684\u5bb9\u5668\u4e2d\u80fd\u591f\u4f7f\u7528 <code>kubectl</code> \u5de5\u5177\u6765\u8bbf\u95ee\u6211\u4eec\u7684Kubernetes\u96c6\u7fa4\uff0c\u65b9\u4fbf\u6211\u4eec\u540e\u9762\u5728 <code>Slave Pod</code> \u90e8\u7f72 Kubernetes \u5e94\u7528\u3002</p> <p>\u9996\u5148\u5728master\u4e0a\u521b\u5efacm\u6587\u4ef6\uff0ccm\u6587\u4ef6\u4f4d\u4e8ekube-ops\u540d\u79f0\u7a7a\u95f4\u4e0b\uff1a</p> <pre><code># kubectl create configmap kubeconfig --from-file=/root/.kube/config -n kube-ops\n# k get cm -n kube-ops\nNAME               DATA   AGE\nkube-root-ca.crt   1      2d\nkubeconfig         1      6m4s\n</code></pre> <p>)</p> <p>\u53e6\u5916\u5982\u679c\u5728\u914d\u7f6e\u4e86\u540e\u8fd0\u884c Slave Pod \u7684\u65f6\u5019\u51fa\u73b0\u4e86\u6743\u9650\u95ee\u9898\uff0c\u8fd9\u662f\u56e0\u4e3aJenkins Slave Pod\u4e2d\u6ca1\u6709\u914d\u7f6e\u6743\u9650\uff0c\u6240\u4ee5\u9700\u8981\u914d\u7f6e\u4e0a ServiceAccount\uff0c \u5728Slave Pod\u914d\u7f6e\u7684\u5730\u65b9\u70b9\u51fb\u4e0b\u9762\u7684\u9ad8\u7ea7\uff0c\u6dfb\u52a0\u4e0a\u5bf9\u5e94\u7684 ServiceAccount \u5373\u53ef\uff1a</p> <p>)</p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u7684 Kubernetes \u63d2\u4ef6\u5c31\u7b97\u914d\u7f6e\u5b8c\u6210\u4e86\uff0c\u8bb0\u5f97\u4fdd\u5b58\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#2-\u6d4b\u8bd5","title":"2. \u6d4b\u8bd5","text":"<p>Kubernetes \u63d2\u4ef6\u7684\u914d\u7f6e\u5de5\u4f5c\u5b8c\u6210\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u6dfb\u52a0\u4e00\u4e2aJob\u4efb\u52a1\uff0c\u770b\u662f\u5426\u80fd\u591f\u5728Slave Pod\u4e2d\u6267\u884c\uff0c\u4efb\u52a1\u6267\u884c\u5b8c\u6210\u540e\u770bPod\u662f\u5426\u4f1a\u88ab\u9500\u6bc1\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#21-\u81ea\u7531\u98ce\u683c\u7684\u6d41\u6c34\u7ebf","title":"2.1 \u81ea\u7531\u98ce\u683c\u7684\u6d41\u6c34\u7ebf","text":"<p>\u5728 Jenkins \u9996\u9875\u70b9\u51fb <code>\u65b0\u5efa\u4efb\u52a1</code>\uff0c\u521b\u5efa\u4e00\u4e2a\u6d4b\u8bd5\u7684\u4efb\u52a1\uff0c\u8f93\u5165\u4efb\u52a1\u540d\u79f0\uff0c\u7136\u540e\u6211\u4eec\u9009\u62e9 <code>\u6784\u5efa\u4e00\u4e2a\u81ea\u7531\u98ce\u683c\u7684\u8f6f\u4ef6\u9879\u76ee</code> \u7c7b\u578b\u7684\u4efb\u52a1\uff0c\u6ce8\u610f\u5728\u4e0b\u9762\u7684 <code>Label Expression</code> \u8fd9\u91cc\u8981\u586b\u5165 <code>jenkins-jnlp</code>\uff0c\u5c31\u662f\u524d\u9762\u6211\u4eec\u914d\u7f6e\u7684 Slave Pod \u4e2d\u7684 Label\uff0c\u8fd9\u4e24\u4e2a\u5730\u65b9\u5fc5\u987b\u4fdd\u6301\u4e00\u81f4\uff1a</p> <p>)</p> <p>\u7136\u540e\u5f80\u4e0b\u62c9\uff0c\u5728 <code>\u6784\u5efa</code> \u533a\u57df\u9009\u62e9 <code>\u6267\u884c shell</code>\uff1a</p> <p>)</p> <p>\u7136\u540e\u8f93\u5165\u6211\u4eec\u6d4b\u8bd5\u547d\u4ee4</p> <pre><code>echo \"\u6d4b\u8bd5 Kubernetes \u52a8\u6001\u751f\u6210 jenkins slave\"\necho \"==============docker in docker===========\"\ndocker version\n\necho \"=============kubectl=============\"\nkubectl get pods\n</code></pre> <p>\u6700\u540e\u70b9\u51fb\u4fdd\u5b58\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u5728\u9875\u9762\u70b9\u51fb\u5de6\u4fa7\u7684 <code>\u7acb\u5373\u6784\u5efa</code> \u89e6\u53d1\u6784\u5efa\u5373\u53ef\uff0c\u7136\u540e\u89c2\u5bdf Kubernetes \u96c6\u7fa4\u4e2d Pod \u7684\u53d8\u5316\uff1a</p> <pre><code>$ kubectl get pods -n kube-ops\nNAME                          READY   STATUS              RESTARTS   AGE\njenkins-556cd59c8c-2vl8m    1/1     Running             0          64m\njenkins-agent-rb8hk           0/1     ContainerCreating   0          8s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5728\u6211\u4eec\u70b9\u51fb\u7acb\u523b\u6784\u5efa\u7684\u65f6\u5019\u53ef\u4ee5\u770b\u5230\u4e00\u4e2a\u65b0\u7684 Pod\uff1a<code>jenkins-agent-rb8hk</code> \u88ab\u521b\u5efa\u4e86\uff0c\u8fd9\u5c31\u662f\u6211\u4eec\u7684 Jenkins Slave\u3002\u4efb\u52a1\u6267\u884c\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4efb\u52a1\u4fe1\u606f:</p> <p>\u5230\u8fd9\u91cc\u8bc1\u660e\u6211\u4eec\u7684\u4efb\u52a1\u5df2\u7ecf\u6784\u5efa\u5b8c\u6210\uff0c\u7136\u540e\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u53bb\u96c6\u7fa4\u67e5\u770b\u6211\u4eec\u7684 Pod \u5217\u8868\uff0c\u53d1\u73b0 kube-ops \u8fd9\u4e2a namespace \u4e0b\u9762\u5df2\u7ecf\u6ca1\u6709\u4e4b\u524d\u7684 Slave \u8fd9\u4e2a Pod \u4e86\u3002</p> <pre><code>$ kubectl get pods -n kube-ops\nNAME                                           READY   STATUS              RESTARTS   AGE\njenkins-556cd59c8c-2vl8m                       1/1     Running             0          12h\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u4f7f\u7528 Kubernetes \u52a8\u6001\u751f\u6210 Jenkins Slave \u7684\u65b9\u6cd5\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#22-pipeline\u6d41\u6c34\u7ebf","title":"2.2 pipeline\u6d41\u6c34\u7ebf","text":"<p>)</p> <p>\u4f7f\u7528\u7269\u7406\u673a\u7528\u4e8ebuild\u3002\u7269\u7406\u673a\u53ef\u4ee5\u5b89\u88c5\u8d1f\u8f7d\u5747\u8861\u3001\u53cd\u5411\u4ee3\u7406\uff08haproxy\u3001nginx\uff09\u8f6f\u4ef6\uff0c\u5236\u4f5c\u4e00\u4e2adocker build \u5206\u53d1\u6c60\uff0c\u5206\u644abuild\u6784\u5efa\u538b\u529b\u3002</p> <pre><code>pipeline{\n    environment {\n        VERSION = \"v5.0.0\"\n        RELEASE_VERSION = \"master\"\n        GIT_ADDRESS = \"https://gitee.com/oschina/gitee.git\"\n\n    }\n\n    options {\n      parallelsAlwaysFailFast()\n      disableResume()\n      skipDefaultCheckout()\n      quietPeriod(1)\n      preserveStashes(buildCount: 5)\n      timestamps()\n      buildDiscarder(logRotator(numToKeepStr: '100'))\n      timeout(time: 60, unit: 'MINUTES')\n    }\n\n    agent {\n        kubernetes {\n            cloud 'kubernetes'\n            slaveConnectTimeout 1200\n            workspaceVolume nfsWorkspaceVolume(serverAddress: \"192.168.1.60\", serverPath: \"/QaTest/jenkins-salve\", readOnly: \"false\")\n            yaml '''\n\n---\napiVersion: \"v1\"\nkind: \"Pod\"\nmetadata:\n  labels:\n    jenkins: \"slave\"\n    jenkins/label: \"jenkins-jnlp\"\n  name: \"jenkins-slave\"\n  namespace: \"kube-ops\"\n\nspec:\n  containers:\n  - env:\n    - name: \"DOCKER_HOST\"\n      value: \"tcp://192.168.1.141:2375\"\n\n    - name: \"JENKINS_AGENT_WORKDIR\"\n      value: \"/home/jenkins/agent\"\n\n    image: \"hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11\"\n    imagePullPolicy: \"IfNotPresent\"\n    name: \"jnlp\"\n    tty: true\n    resources:\n      limits:\n        cpu: 1000m\n        memory: 2000Mi\n      requests:\n        cpu: 200m\n        memory: 400Mi\n\n    volumeMounts:\n    - mountPath: \"/root/.kube/config\"\n      name: \"volume-0\"\n      readOnly: false\n      subPath: \"config\"\n\n    - name: localtime\n      mountPath: /etc/localtime\n\n    - mountPath: \"/home/jenkins/agent\"\n      name: \"workspace-volume\"\n      readOnly: false\n    workingDir: \"/home/jenkins/agent\"\n\n  hostNetwork: false\n  imagePullSecrets:\n  - name: \"regcred\"\n  nodeSelector:\n    kubernetes.io/os: \"linux\"\n\n  restartPolicy: \"Never\"\n  volumes:\n  - name: localtime\n    hostPath:\n      path: /usr/share/zoneinfo/Asia/Shanghai\n\n  - configMap:\n      name: \"kubeconfig\"\n      optional: false\n    name: \"volume-0\"\n\n  - emptyDir:\n      medium: \"\"\n    name: \"workspace-volume\"\n            '''\n        }\n    }\n\n    stages {\n      stage('Build') {\n        steps {\n          sh '''#!/bin/bash\n                set -eu\n                echo 'Build'\n                echo\n                docker version\n                echo\n             '''\n        }\n      }\n      stage('Test') {\n        steps {\n          echo 'Test'\n        }\n      }\n      stage('Deploy') {\n        steps {\n            sh '''#!/bin/bash\n                set -eu\n                echo 'Deploy'\n                echo\n                kubectl get nodes\n                echo\n             '''\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#52--\u5b89\u88c5gitlab","title":"5.2  \u5b89\u88c5GitLab","text":"<p>GitLab\u5728\u4f01\u4e1a\u5185\u7ecf\u5e38\u7528\u4e8e\u4ee3\u7801\u7684\u7248\u672c\u63a7\u5236\uff0c\u662fDevOps\u5e73\u53f0\u4e2d\u5c24\u4e3a\u91cd\u8981\u7684\u4e00\u4e2a\u5de5\u5177\u3002\u63a5\u4e0b\u6765\u5728\u53e6\u4e00\u53f0\u670d\u52a1\u5668\uff0840GB\u4ee5\u4e0a\uff09\u4e0a\u5b89\u88c5GitLab\uff08\u5982\u679c\u6709\u53ef\u7528 \u7684GitLab\uff0c\u4e5f\u65e0\u987b\u5b89\u88c5\uff09\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#1-\u670d\u52a1\u65b9\u5f0f\u90e8\u7f72\u63a8\u8350","title":"1. \u670d\u52a1\u65b9\u5f0f\u90e8\u7f72(\u63a8\u8350)","text":"<p>\u9996\u5148\u5728GitLab\u56fd\u5185\u6e90\u4e0b\u8f7dGitLab\u7684\u5b89\u88c5\u5305\uff1ahttps://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/\u3002 \u5c06\u4e0b\u8f7d\u540e\u7684RPM\u5305\u4e0a\u4f20\u5230\u670d\u52a1\u5668\uff0c\u4e4b\u540e\u901a\u8fc7yum\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\uff1a</p> <pre><code># mkdir gitlab\n# cd gitlab/\n# wget -c https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-15.8.2-ce.0.el7.x86_64.rpm\n# yum install gitlab-ce-14.2.3-ce.0.el7.x86_64.rpm -y\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u9700\u8981\u66f4\u6539\u51e0\u5904\u914d\u7f6e\uff1a <pre><code>vim /etc/gitlab/gitlab.rb\n</code></pre></p> <p>\u5c06external_url\u66f4\u6539\u4e3a\u81ea\u5df1\u7684\u53d1\u5e03\u5730\u5740\uff0c\u53ef\u4ee5\u662f\u670d\u52a1\u5668\u7684IP\uff0c\u4e5f\u53ef\u4ee5\u662f\u4e00\u4e2a\u53ef\u88ab\u89e3\u6790\u7684\u57df\u540d\uff0c\u66f4\u6539\u5b8c\u6210\u540e\u9700\u8981\u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code># gitlab-ctl reconfigure\n</code></pre> <p>\u4e4b\u540e\u53ef\u4ee5\u901a\u8fc7\u6d4f\u89c8\u5668\u8bbf\u95eeGitLab \uff0c \u8d26\u53f7\u4e3aroot \uff0c\u9ed8\u8ba4\u5bc6\u7801\u5728/etc/gitlab/initial_root_password\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#2-docker\u65b9\u5f0f\u90e8\u7f72\u63a8\u8350","title":"2. docker\u65b9\u5f0f\u90e8\u7f72(\u63a8\u8350)","text":"<p>gitlab-ce \u6709\u4e24\u4e2a\u4e0d\u540c\u7684\u5bb9\u5668\u5316\u955c\u50cf\uff0csameersbn/gitlab \u548c gitlab/gitlab-ce\uff0c \u524d\u8005\u662f\u7b2c\u4e09\u65b9\u7ef4\u62a4\u7684\uff0c\u7528\u6237\u5e7f\u6cdb\uff0c\u5e74\u4ee3\u4e45\u8fdc\uff0c\u901a\u8fc7\u6ce8\u5165\u73af\u5883\u53d8\u91cf\u6765\u81ea\u52a8\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u5c31\u662f\u7248\u672c\u4e00\u822c\u4f1a\u843d\u540e\u5b98\u65b9\u3002\u540e\u8005\u662f\u5b98\u65b9\u7684\u955c\u50cf\uff0c\u66f4\u65b0\u53ca\u65f6\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#21-sameersbngitlab","title":"2.1 sameersbn/gitlab","text":"<p>\u4ed3\u5e93\u5730\u5740\uff1a https://github.com/sameersbn/docker-gitlab</p> <p>https://www.jianshu.com/p/abd406052677</p> <p>https://www.jianshu.com/p/ee0c8ed4795e</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#22-gitlabgitlab-ce","title":"2.2 gitlab/gitlab-ce","text":"<p>\u521b\u5efa\u5b89\u88c5\u76ee\u5f55\u3001\u62c9\u53d6\u955c\u50cf</p> <pre><code># docker pull gitlab/gitlab-ce\n# mkdir -p /root/wokerdir/gitlab\n</code></pre> <p><code>docker-compose.yaml</code></p> <pre><code>version: '3.1'\nservices:\ngitlab:\nimage: 'gitlab/gitlab-ce:latest'\ncontainer_name: gitlab\nrestart: always\nenvironment:\nGITLAB_OMNIBUS_CONFIG: |\nexternal_url 'http://gitlab.runjs.cn:8929'\ngitlab_rails['gitlab_shell_ssh_port'] = 2224\nports:\n- '8929:8929'\n- '2224:22'\nvolumes:\n- './config:/etc/gitlab'\n- './logs:/var/log/gitlab'\n- './data:/var/opt/gitlab'\nshm_size: '256m'\n</code></pre> <ol> <li>\u6307\u5b9a\u4e09\u4e2a\u7aef\u53e3,22\u4e3assh\u7aef\u53e3,80\u4e3ahttp\u7aef\u53e3,443\u4e3ahttps\u7aef\u53e3,\u5206\u522b\u6620\u5c04\u5230\u5bbf\u4e3b\u673a\u76847022\u30018080\u548c7443\u7aef\u53e3</li> <li> <p>\u901a\u8fc7--volume\u6307\u5b9a\u76ee\u5f55\u6620\u5c04,\u5176\u4e2d</p> </li> <li> <p>/etc/gitlab\u8868\u793agitlab\u7684\u914d\u7f6e\u76ee\u5f55,\u6620\u5c04\u5230\u5bbf\u4e3b\u673a\u7684/opt/gitlab/config\u76ee\u5f55.</p> </li> <li>/var/log/gitlab\u8868\u793agitlab\u7684\u65e5\u5fd7\u76ee\u5f55,\u6620\u5c04\u5230\u5bbf\u4e3b\u673a\u7684/opt/gitlab/logs\u76ee\u5f55.</li> <li> <p>/var/opt/gitlab\u8868\u793agitlab\u7684\u6570\u636e\u76ee\u5f55,\u6620\u5c04\u5230\u5bbf\u4e3b\u673a\u7684/opt/gitlab/data\u76ee\u5f55.</p> </li> <li> <p>\u76ee\u5f55\u8bf4\u660e</p> </li> <li> <p>/opt/gitlab/config \u5b58\u50a8 GitLab \u914d\u7f6e\u4fe1\u606f</p> </li> <li>/opt/gitlab/data \u5b58\u50a8\u6570\u636e\u5e93</li> <li>/opt/gitlab/logs \u5b58\u50a8\u65e5\u5fd7</li> </ol> <pre><code># docker-compose up -d\n## \u91cd\u542fgitlab\u5bb9\u5668\n# docker restart gitlab\n</code></pre> <p>\u542f\u52a8\u5bb9\u5668\uff08\u9700\u8981\u7a0d\u7b49\u4e00\u5c0f\u4f1a\u2026\u2026\uff09</p> <p>\u91cd\u542f\u914d\u7f6e\u670d\u52a1\uff08\u51fa\u73b0\u95ee\u9898\uff09 </p> <p>\u7531\u4e8e\u6211\u4eec\u8fd0\u884c\u662f\u4f7f\u7528\u6570\u636e\u5377\u53c2\u6570\u8fdb\u884c\u8fd0\u884c\u7684\uff0c\u5bbf\u4e3b\u673a\u7684gitlab.rb\u6587\u4ef6\u4fee\u6539\u4e86\uff0cgitlab\u7684\u6587\u4ef6\u4f1a\u8ddf\u7740\u6539\uff0c\u4f46\u662f\u5bb9\u5668\u7684\u6587\u4ef6\u4e0d\u4f1a\u8ddf\u7740\u751f\u6548\uff0c\u5fc5\u987b\u8981\u8fdb\u53bb\u5bb9\u5668\u91cc\u9762\u8fdb\u884c\u547d\u4ee4\u6267\u884c\uff0c\u91cd\u7f6e\u914d\u7f6e\u6587\u4ef6\u6bd4\u8f83\u8017\u8d39\u65f6\u95f4\uff0c\u9700\u8981\u8010\u5fc3\u7b49\u5f85\uff0c\u5982\u679c\u65f6\u95f4\u6bd4\u8f83\u77ed\u8bf4\u660e\u6210\u529f\u7387\u4e0d\u9ad8\uff0c\u800c\u4e14\u8fdb\u53bb\u5bb9\u5668\u4e4b\u540e\u5c31\u9000\u51fa\u5566\u3002</p> <pre><code># docker exec -it gitlab /bin/bash  #\u8fdb\u53bbgitlab\u5bb9\u5668\u7684\u547d\u4ee4\n# gitlab-ctl reconfigure        #\u91cd\u7f6egitlab\u5ba2\u6237\u7aef\u7684\u547d\u4ee4\n# gitlab-ctrl restart\n</code></pre> <p>\u67e5\u770broot\u767b\u5f55\u5bc6\u7801</p> <pre><code># docker exec  $(docker ps | grep gitlab | awk '{print $1}') grep 'Password:' /etc/gitlab/initial_root_password\nPassword: lB7RIXsS41R7on31KPHAzJ0FE736mBMPxTdjOt4g2Lo=\n</code></pre> <p>\u91cd\u7f6e\u7ba1\u7406\u5458\u5bc6\u7801</p> <pre><code>root@docker-node141:~/gitlab# docker exec -it gitlab /bin/bash\nroot@192:/# gitlab-rails console -e production\n--------------------------------------------------------------------------------\n Ruby:         ruby 2.7.5p203 (2021-11-24 revision f69aeb8314) [x86_64-linux]\nGitLab:       14.6.1 (661d663ab2b) FOSS\n GitLab Shell: 13.22.1\n PostgreSQL:   12.7\n--------------------------------------------------------------------------------\nLoading production environment (Rails 6.1.4.1)\nirb(main):001:0&gt; user = User.where(id: 1).first\n=&gt; #&lt;User id:1 @root&gt;\nirb(main):002:0&gt; user.password = 'oschina123'\n=&gt; \"oschina123\"\nirb(main):003:0&gt; user.password_confirmation = 'oschina123'\n=&gt; \"oschina123\"\nirb(main):004:0&gt; user.save!\n=&gt; true\nirb(main):005:0&gt; exit\n</code></pre> <p>\u5e38\u7528\u547d\u4ee4</p> <pre><code># \u8fdb\u5165\u5bb9\u5668\ndocker exec -it gitlab /bin/bash\n\n# \u542f\u52a8\u6240\u6709gitlab\u7ec4\u4ef6\ngitlab-ctl start\n\n# \u67e5\u770bgitlab\u72b6\u6001\ngitlab-ctl status\n\n# \u91cd\u65b0\u542f\u7528\u914d\u7f6e\ngitlab-ctl reconfigure\n\n# \u91cd\u542fgitlab\ndocker restart gitlab\n</code></pre> <p>\u767b\u5f55\u540e\uff0c\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u6d4b\u8bd5\u9879\u76ee\uff0c\u8fdb\u884c\u4e00\u4e9b\u7b80\u5355\u7684\u6d4b\u8bd5\u3002\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u7ec4\u3002\u7ec4\u540d\u4e3akubernetes\uff0c\u7c7b\u578b\u4e3aPrivate\uff0c\u4e4b\u540e\u5355\u51fbCreate group</p> <p>)</p> <p>\u9009\u62e9\u521b\u5efa\u4e00\u4e2a\u7a7a\u7684\u9879\u76ee\uff0c\u8f93\u5165\u9879\u76ee\u540d\u79f0test-project\uff0c\u7136\u540e\u5355\u51fbCreate project\u5982\u56fe )</p> <p>\u4e4b\u540e\u53ef\u4ee5\u5c06Jenkins\u670d\u52a1\u5668\u7684key\u5bfc\u5165GitLab\uff0c\u9996\u5148\u751f\u6210\u5bc6\u94a5\uff08\u5982\u6709\u53ef\u4ee5\u4e0d\u751f\u6210\uff09\uff1a</p> <pre><code># ssh-keygen -t rsa -C \"YOUR_EMAIL@ADDRESS.COM\"\n</code></pre> <p>\u5c06\u516c\u94a5\u7684\u5185\u5bb9\u653e\u5728GitLab\u4e2d\uff1a</p> <pre><code># cat ~/.ssh/id_rsa.pub\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDAipO4jkJioJBW57Nv25i95yAiWNCeaySwvtFViOqtcX644WbN81SDwMscYCvKNcdgPmXkzBaKWBzehAVZ9RhVN1gqp9/BvnGzhyz6IpYXMgQfsDLIakARM4uJjxKt9LCTVugUL3kA5p+fsNsaMwpSy/+scnfUsuKCTqDuCBBGbdRkBIjC2ZuXzXs2ei2jWwVavJbxSZwMxPT2pNeHG7GxiyIBVwR6kbdDQNqzDBOBSATKSFp8XKhdc+7Mu3f6cUD64i+TxBgqqG1rA29yb4xn0iB1IHxsOCc5RO4WrfwrYQxMsMiB2cxQK2sKhrNrggeQ4LQhsWRWQWxTaDEB5TbvMsdKoEAivGE8OjUyyz/3VTPFqMtLEeAB5RDjOwFKeJBB6aYNOqOYlI7nm1g9oLm4OtiSjeSxz2MvO0N4KPMBgX6qW5lecYbD6VrJC2RVic05NouViRWoJPJEIUn9c3wNd0lDYMYhDVAOfW4PPx0B6gf1b40+aTlUxoUPLAhTocs= 1879324764@qq.com\n</code></pre> <p>\u5728GitLab\u627e\u5230Profile\uff0c\u4e4b\u540e\u5728SSH Keys\u6dfb\u52a0\u516c\u94a5\uff0c\u5982\u56fe )</p> <p>\u521b\u5efa\u51e0\u4e2a\u6587\u4ef6\uff0c\u7136\u540e\u63d0\u4ea4\u6d4b\u8bd5\uff1a</p> <pre><code># git clone ssh://git@gitlab.runjs.cn:7022/kubernetes/test-project.git\n# cd test-project/\n# touch aaa{1..3}.py\nroot@docker-node141:~/gitlab/test-project# echo 'aaa' &gt; aaa1.py\nroot@docker-node141:~/gitlab/test-project# git add .\n\nroot@docker-node141:~/gitlab/test-project# git config --global user.email \"18793247642qq.com\"\nroot@docker-node141:~/gitlab/test-project# git config --global user.name \"hujianli\"\nroot@docker-node141:~/gitlab/test-project# git commit -m \"first commit\"\n[main 515ab18] first commit\n 3 files changed, 1 insertion(+)\ncreate mode 100644 aaa1.py\n create mode 100644 aaa2.py\n create mode 100644 aaa3.py\n\nroot@docker-node141:~/gitlab/test-project# git push origin main\nWarning: Permanently added '[gitlab.runjs.cn]:7022,[192.168.1.141]:7022' (ECDSA) to the list of known hosts.\nEnumerating objects: 5, done.\nCounting objects: 100% (5/5), done.\nDelta compression using up to 8 threads\nCompressing objects: 100% (2/2), done.\nWriting objects: 100% (4/4), 313 bytes | 313.00 KiB/s, done.\nTotal 4 (delta 0), reused 0 (delta 0)\nTo ssh://gitlab.runjs.cn:7022/kubernetes/test-project.git\n   b77d308..515ab18  main -&gt; main\n</code></pre> <p>\u53c2\u8003\u6587\u732e</p> <p>https://www.cnblogs.com/linanjie/p/13932352.html</p> <p>https://wtl4it.blog.csdn.net/article/details/125019372</p> <p>\u4f01\u4e1a\u7ea7GitLab\u5728Docker\u90e8\u7f72\u4f7f\u7528</p> <p>\u5b98\u65b9\u6587\u6863</p> <p>https://docs.gitlab.com/ee/install/docker.html</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#3-yaml\u65b9\u5f0f\u90e8\u7f72\u4e0d\u63a8\u8350_1","title":"3. yaml\u65b9\u5f0f\u90e8\u7f72(\u4e0d\u63a8\u8350)","text":"<p>\u53c2\u8003\u6587\u732e</p> <p>https://www.qikqiak.com/k8strain2/devops/gitlab/</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#4-helm3\u5b89\u88c5gitlab\u4e0d\u63a8\u8350","title":"4. helm3\u5b89\u88c5gitlab(\u4e0d\u63a8\u8350)","text":"<p>\u53c2\u8003\u6587\u732e</p> <p>https://blog.51cto.com/u_14268033/2456991</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#53-\u5b89\u88c5harbor","title":"5.3 \u5b89\u88c5Harbor","text":"<p>\u5728\u4f7f\u7528\u5bb9\u5668\u6216\u8005Kubernetes\u53d1\u5e03\u670d\u52a1\u65f6\uff0c\u90fd\u662f\u4ee5\u955c\u50cf\u4e3a\u57fa\u51c6\u53d1\u5e03\u7684\uff0c\u800c\u955c\u50cf\u7684\u5b58\u50a8\u9700\u8981\u955c\u50cf\u4ed3\u5e93\u6765\u652f\u6301\uff0c\u76ee\u524d\u6bd4\u8f83\u5e38\u7528\u7684\u6709Harbor\u3001Nexus\u3001JFrog Artifactory\u7b49\u3002</p> <p>\u672c\u5c0f\u8282\u5c06\u6f14\u793aHarbor\u7684\u5b89\u88c5\u548c\u4f7f\u7528\uff0c\u8fd9\u4e5f\u662f\u4f01\u4e1a\u5185\u6bd4\u8f83\u5e38\u7528\u7684\u955c\u50cf\u4ed3\u5e93\u3002</p> <p>\u6ce8\u610f</p> <p>\u63a8\u8350\u4f7f\u7528docker-compose\u7684\u65b9\u5f0f\u90e8\u7f72\uff0c\u8282\u7701kubernetes\u8d44\u6e90\uff0c\u5355\u72ec\u955c\u50cf\u4ed3\u5e93\u73af\u5883</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#1-docker\u65b9\u5f0f\u90e8\u7f72\u63a8\u8350","title":"1. docker\u65b9\u5f0f\u90e8\u7f72(\u63a8\u8350)","text":"<p>\u9996\u5148\u5728GitHub\u4e0b\u8f7d\u65b0\u7684Harbor\u79bb\u7ebf\u5305\uff0c\u5e76\u4e0a\u4f20\u81f3Harbor\u670d\u52a1\u5668\uff0c\u5b98\u65b9\u4e0b\u8f7d\u5730\u5740\uff1ahttps://github.com/goharbor/harbor/releases/\u3002 \u7531\u4e8eHarbor\u662f\u91c7\u7528docker-compose\u4e00\u952e\u90e8\u7f72\u7684\uff0c\u56e0\u6b64Harbor\u670d\u52a1\u5668\u4e5f\u9700\u8981\u5b89\u88c5Docker</p> <p>Harbor \u9ad8\u53ef\u7528\u642d\u5efa(docker-compose)</p> <p>\u53c2\u8003\u6587\u732e</p> <p>https://clay-wangzhi.com/cloudnative/kubernetes/docker-harbor-ha.html#summary</p> <p>Harbor \u662f\u4e00\u4e2a\u4e3b\u6d41\u7684\u955c\u50cf\u4ed3\u5e93\u7cfb\u7edf\uff0c\u5728 v1.6 \u7248\u672c\u4ee5\u540e\u7684 harbor \u4e2d\u65b0\u589e\u52a0\u4e86 helm charts \u7684\u7ba1\u7406\u529f\u80fd\uff0c\u53ef\u4ee5\u5b58\u50a8Chart\u6587\u4ef6\u3002</p> <p>\u53c2\u8003\u6587\u732e</p> <p>\u90e8\u7f72\u4ed3\u5e93\u5730\u5740\uff1ahttps://gitee.com/autom-studio/simple-harbor</p> <p>\u79bb\u7ebf\u5305\uff1aharbor-offline-installer-v240.tgz</p> <pre><code># wget https://github.com/goharbor/harbor/releases/download/v2.4.2/harbor-online-installer-v2.4.2.tgz\n# \u4e0a\u4f20\u5b89\u88c5\u5305\u5230\u670d\u52a1\u5668/root/wokerdir/harbor\u76ee\u5f55\u4e0b\n# cd /root/wokerdir/harbor\n# tar -zxf harbor-online-installer-v2.4.2.tgz\n# cd /root/wokerdir/harbor/harbor\n## \u590d\u5236 harbor \u914d\u7f6e\u6a21\u677f\n# cp harbor.yml.tmpl harbor.yml\n</code></pre> <p>\u89e3\u538b\u5e76\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u53ea\u9700\u4fee\u6539 harbor.yml \uff0c\u4fee\u6539\u9879\u5982\u4e0b\uff1a</p> <pre><code>hostname: hub.gitee.cc  # \u8bbf\u95ee\u57df\u540d\u6216IP\u5730\u5740\n\n# \u5982\u679c\u6ca1\u6709ssl\u8bc1\u4e66\uff0c\u5219\u6ce8\u91ca\u6389 https \u5b57\u6bb5\nharbor_admin_password: admin123    # \u521d\u59cb\u7ba1\u7406\u5458\u5bc6\u7801\ndata_volume: /data/harbor    # \u955c\u50cf\u6587\u4ef6\u5b58\u50a8\u8def\u5f84\uff0c\u9700\u8981\u6307\u5b9a\u4e00\u4e2a\u7a7a\u6587\u4ef6\u5939\u4e14\u7a7a\u95f4\u8db3\u591f\n\nexternal_url: http://hub.gitee.cc\n</code></pre> <p>\u6267\u884c\u5b89\u88c5\u547d\u4ee4</p> <pre><code>## \u540c\u65f6\u5f00\u542f helm chart \u4ed3\u5e93\u652f\u6301\n# sudo ./install.sh --with-chartmuseum\n</code></pre> <p>\u5b8c\u6210</p> <p>\u6210\u529f\u542f\u52a8\u540e\uff0c\u5373\u53ef\u901a\u8fc7\u914d\u7f6e\u7684\u5730\u5740\u6216\u57df\u540d\u8bbf\u95ee\u3002</p> <p>\u5982\u679c\u914d\u7f6e\u4e0d\u662fHTTPS\u534f\u8bae\uff0c\u6240\u6709\u7684Kubernetes\u8282\u70b9\u7684Docker\uff08\u5982\u679c\u662fcontainerd\u4f5c\u4e3aRuntime\uff0c\u53ef\u4ee5\u53c2\u8003\u4e0b\u6587\u914d\u7f6einsecure-registry\uff09\u90fd\u9700\u8981\u6dfb \u52a0insecure-registries\u914d\u7f6e\uff1a</p> <pre><code># cat &gt;/etc/docker/daemon.json &lt;&lt;EOF\n{\n\"insecure-registries\": [\"http://hub.gitee.cc\"],\n  \"registry-mirrors\": [\"https://25bxwt20.mirror.aliyuncs.com\"],\n  \"live-restore\": true,\n  \"default-shm-size\": \"128M\",\n  \"max-concurrent-downloads\": 10,\n  \"oom-score-adjust\": -1000,\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n  \"hosts\": [\"tcp://0.0.0.0:2375\", \"unix:///var/run/docker.sock\"],\n  \"log-driver\": \"json-file\",\n  \"log-opts\": {\n\"max-size\": \"100m\",\n    \"max-file\":\"3\"\n}\n}\nEOF\n# systemctl daemon-reload\n# systemctl restart docker\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e\u5982\u679c\u9700\u8981\u4fee\u6539harbor.yml \uff0c\u9700\u8981\u5728\u4fee\u6539\u540e\u91cd\u65b0\u521d\u59cb\u5316\u914d\u7f6e\uff0c\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <pre><code>docker-compose down -v\nvim harbor.yml\nsudo ./prepare --with-chartmuseum\ndocker-compose up -d\n</code></pre> <p>\u521b\u5efaexternal nginx \u914d\u7f6e\u6587\u4ef6</p> <p>\u6839\u636e\u5b9e\u9645\u73af\u5883\u914d\u7f6e</p> <pre><code>upstream harbor {\n    server 192.168.1.188:8080;\n    keepalive 32;\n}\n\nserver {\n    listen 80;\n    server_name hub.gitee.com;\n    access_log /var/log/nginx/hub_302_access.log main;\n    error_log /var/log/nginx/hub_302_error.log;\n    return 302 https://$server_name$request_uri;\n}\n\nserver {\n    include ssl.d/ssl.conf;\n    server_name hub.gitee.com;\n    access_log /var/log/nginx/hub_access.log main;\n    error_log /var/log/nginx/hub_error.log;\n\n    location / {\n        proxy_set_header Connection \"\";\n        proxy_set_header Host $http_host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_set_header X-Frame-Options SAMEORIGIN;\n        proxy_buffers 256 16k;\n        proxy_buffer_size 16k;\n        proxy_read_timeout 600s;\n        proxy_cache_revalidate on;\n        proxy_cache_min_uses 2;\n        proxy_cache_use_stale timeout;\n        proxy_cache_lock on;\n        proxy_http_version 1.1;\n        proxy_pass http://harbor;\n    }\n\n    error_page 500 502 503 504 /50x.html;\n    location = /50x.html {\n        root /usr/share/nginx/html;\n    }\n}\n</code></pre> <p>\u767b\u5f55\u6d4b\u8bd5\uff1a</p> <pre><code># docker login http://hub.gitee.cc\nUsername: admin\nPassword:\nWARNING! Your password will be stored unencrypted in /root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\n\nLogin Succeeded\n</code></pre> <p>\u63a5\u4e0b\u6765\u5728Harbor\u4e0a\u521b\u5efa\u4e00\u4e2aProject\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002\u521b\u5efa\u4e00\u4e2a\u540d\u4e3akubernetes\u7684Project</p> <p>)</p> <p>\u4e4b\u540e\u5728\u670d\u52a1\u5668\u4e0a\u627e\u4efb\u610f\u4e00\u4e2a\u955c\u50cf\uff0c\u4fee\u6539tag\u4e3aHarbor\u7684\u5730\u5740\uff0c\u5e76\u8fdb\u884cpush\u6d4b\u8bd5\uff1a</p> <pre><code># docker tag kubeoperator/webkubectl:latest hub.gitee.cc/kubernetes/webkubectl:latest\n# docker push hub.gitee.cc/kubernetes/webkubectl:latest\nThe push refers to repository [hub.gitee.cc/kubernetes/webkubectl]\n99b13cfbfb0f: Pushed\n0e658bc0176b: Pushed\n9eba8e5bc7c8: Pushed\nadc0cdf505f7: Pushed\nad4e41a7f1d3: Pushed\n7ba699eb6203: Pushed\nb4c5273b6d27: Pushed\ne5e13b0c77cb: Mounted from library/mailcat\nlatest: digest: sha256:51cacad0e26ebacc59de84ba71fb50e161ff3e1b8337e39d448c91d6cd048062 size: 1990\n</code></pre> <p>\u4e4b\u540e\u5c31\u53ef\u4ee5\u5728Harbor\u67e5\u770b\u8be5\u955c\u50cf\uff0c\u5982\u56fe</p> <p>)</p> <p>\u5982\u679c\u8bfb\u8005\u7684Kubernetes\u96c6\u7fa4\u91c7\u7528\u7684\u662fContainerd\u4f5c\u4e3aRuntime\uff0c\u914d\u7f6einsecure-registry\u53ea\u9700\u8981\u5728Containerd\u914d\u7f6e\u6587\u4ef6\u7684mirrors\u4e0b\u6dfb\u52a0\u81ea\u5df1\u7684\u955c\u50cf\u4ed3\u5e93\u5730\u5740\u5373\u53ef\u3002</p> <pre><code>## Containerd\u914d\u7f6einsecure\u4ed3\u5e93\n# vim /etc/containerd/config.toml\n[plugins.\"io.containerd.grpc.v1.cri\".registry]\nconfig_path = \"\"\n[plugins.\"io.containerd.grpc.v1.cri\".registry.auths]\n[plugins.\"io.containerd.grpc.v1.cri\".registry.configs]\n[plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"hub.gitee.cc\".tls]\ninsecure_skip_verify = true\n[plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"hub.gitee.cc\".auth]\n[plugins.\"io.containerd.grpc.v1.cri\".registry.headers]\n[plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors]\n[plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"]\nendpoint = [\"https://pooj3a7i.mirror.aliyuncs.com\"]\n[plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"hub.gitee.cc\"]\nendpoint = [\"http://hub.gitee.cc\"]\n.....\n</code></pre> <p>\u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u91cd\u542fContainerd\uff0c\u4e4b\u540e\u8fdb\u884cpull\u6d4b\u8bd5\uff1a</p> <pre><code># systemctl restart containerd\n# ctr -n k8s.io image pull hub.gitee.cc/kubernetes/webkubectl:latest --plain-http --user admin:oschina123 \n</code></pre> <p>\u81f3\u6b64\uff0c\u7528\u5230\u7684\u5de5\u5177\u90fd\u5df2\u7ecf\u5b89\u88c5\u5b8c\u6210\u3002\u63a5\u4e0b\u6765\u9700\u8981\u8fdb\u884c\u4e00\u4e9b\u914d\u7f6e\u3002</p> <p>\u53c2\u8003\u6587\u732e</p> <p>Harbor\u914d\u5408Nginx\u914d\u7f6e\u516c\u7f51\u57df\u540d</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#2-helm\u65b9\u5f0f\u90e8\u7f72","title":"2. helm\u65b9\u5f0f\u90e8\u7f72","text":"<p>\u524d\u63d0\u6761\u4ef6\uff1aNFS \u7c7b\u578b\u7684 StorageClass \u6765\u505a\u6301\u4e45\u5316\u5b58\u50a8,  StorageClass \u540d\u79f0<code>gitee-nfs-client</code></p> <p>Chart \u4ed3\u5e93\u5730\u5740\uff1ahttps://helm.goharbor.io</p> <p>\u7531\u4e8e Harbor \u6d89\u53ca\u7684\u7ec4\u4ef6\u592a\u591a\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u7528\u66f4\u52a0\u4fbf\u6377\u7684 Helm \u6765\u8fdb\u884c\u5b89\u88c5\u3002\u9996\u5148\u6dfb\u52a0 Chart \u4ed3\u5e93\u5730\u5740\uff1a</p> <pre><code># \u6dfb\u52a0 Chart \u4ed3\u5e93\n$ helm repo add harbor https://helm.goharbor.io\n\n# \u66f4\u65b0\n$ helm repo update\n</code></pre> <p>\u6211\u4eec\u4f7f\u7528\u5b9a\u5236\u7684 values \u6587\u4ef6\u6765\u8fdb\u884c\u5b89\u88c5\u4e86\uff0c\u5b8c\u6574\u5b9a\u5236\u7684 values \u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># \u62c9\u53d61.10.1\u7248\u672c\u5e76\u89e3\u538b\n$ helm pull harbor/harbor --version 1.10.1\n$ helm pull harbor/harbor --untar --version 1.10.1\n\n$ cat &gt; values-prod.yaml &lt;&lt;'EOF'\n# \u5916\u7f51\u8bbf\u95eeIP\nexternalURL: http://106.12.45.72:30002\nharborAdminPassword: Harbor12345\nlogLevel: debug\nexpose:\n  type: nodePort\n  tls:\n    enabled: false\n  nodePort:\n    name: harbor\n    ports:\n      http:\n        port: 80\n        nodePort: 30002\n      https:\n        port: 443\n        nodePort: 30003\n      notary:\n        port: 4443\n        nodePort: 30004\npersistence:\n  enabled: true\n  resourcePolicy: \"keep\"\n  persistentVolumeClaim:\n    registry:\n      storageClass: \"gitee-nfs-client\"\n      # \u5982\u679c\u662f\u9ad8\u53ef\u7528\u7684\uff0c\u591a\u4e2a\u526f\u672c\u7ec4\u4ef6\u9700\u8981\u4f7f\u7528 ReadWriteMany\uff0c\u9ed8\u8ba4\u4e3a ReadWriteOnce\n      accessMode: ReadWriteMany\n      size: 500Gi\n    chartmuseum:\n      storageClass: \"gitee-nfs-client\"\n      accessMode: ReadWriteMany\n      size: 20Gi\n    jobservice:\n      storageClass: \"gitee-nfs-client\"\n      accessMode: ReadWriteMany\n      size: 10Gi\n    database:\n      storageClass: \"gitee-nfs-client\"\n      accessMode: ReadWriteMany\n      size: 20Gi\n    redis:\n      storageClass: \"gitee-nfs-client\"\n      accessMode: ReadWriteMany\n      size: 8Gi\n    trivy:\n      storageClass: \"gitee-nfs-client\"\n      accessMode: ReadWriteMany\n      size: 10Gi\n# \u4f7f\u7528Harboar\u5185\u7f6e\u7684PostgreSQL\u548credis\u6570\u636e\u5e93\ndatabase:\n  type: internal\n  internal:\n    serviceAccountName: \"\"\n    image:\n      repository: goharbor/harbor-db\n      tag: v2.2.2\n    password: \"oschina123\"\nredis:\n  type: internal\n  internal:\n    serviceAccountName: \"\"\n    image:\n      repository: goharbor/redis-photon\n      tag: v2.2.2\nportal:\n  replicas: 2\ncore:\n  replicas: 2\njobservice:\n  replicas: 2\nregistry:\n  replicas: 2\nchartmuseum:\n  replicas: 2\nclair:\n  replicas: \nnotary:\n  server:\n    replicas: 2\n  signer:\n    replicas: 2\nEOF\n$ helm install -f values-prod.yaml harbor harbor --namespace pub-comm --create-namespace\n</code></pre> <p>\u6b63\u5e38\u60c5\u51b5\u4e0b\u9694\u4e00\u4f1a\u513f\u5c31\u53ef\u4ee5\u5b89\u88c5\u6210\u529f\u4e86\uff1a</p> <pre><code>$ helm ls -n pub-comm\nNAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION\nharbor          pub-comm        1               2022-10-19 09:41:55.531221406 +0800 CST deployed        harbor-1.6.2            2.2.2\n$ kubectl get pods -n pub-comm -l app=harbor\nharbor-harbor-chartmuseum-5d5dc4c5fc-75qx2     1/1     Running   0          3m24s\nharbor-harbor-chartmuseum-5d5dc4c5fc-xsngf     1/1     Running   0          3m24s\nharbor-harbor-core-5559c6b95d-wqcgb            1/1     Running   2          3m24s\nharbor-harbor-core-5559c6b95d-xlxpd            1/1     Running   2          3m24s\nharbor-harbor-database-0                       1/1     Running   0          3m24s\nharbor-harbor-jobservice-7599dc87cd-95z8v      1/1     Running   2          3m24s\nharbor-harbor-jobservice-7599dc87cd-np8jr      1/1     Running   0          3m24s\nharbor-harbor-nginx-9bc874c4c-xfgrc            1/1     Running   0          3m24s\nharbor-harbor-notary-server-7788bcd6c4-wbgdn   1/1     Running   3          3m24s\nharbor-harbor-notary-server-7788bcd6c4-z2hxq   1/1     Running   3          3m24s\nharbor-harbor-notary-signer-58894fb464-59k6z   1/1     Running   3          3m24s\nharbor-harbor-notary-signer-58894fb464-vr6t6   1/1     Running   0          3m24s\nharbor-harbor-portal-559c4d4bfd-kmdnx          1/1     Running   0          3m24s\nharbor-harbor-portal-559c4d4bfd-v8vqx          1/1     Running   0          3m24s\nharbor-harbor-redis-0                          1/1     Running   0          3m24s\nharbor-harbor-registry-9b46998cf-kd969         2/2     Running   0          3m24s\nharbor-harbor-registry-9b46998cf-kmjmq         2/2     Running   0          3m24s\nharbor-harbor-trivy-0                          1/1     Running   0          3m23s\n\n$ kubectl get svc -n pub-comm -l app=harbor\nNAME                          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                       AGE\nharbor                        NodePort    172.24.58.77     &lt;none&gt;        80:30002/TCP,4443:30004/TCP   5m16s\nharbor-harbor-chartmuseum     ClusterIP   172.24.99.83     &lt;none&gt;        80/TCP                        5m16s\nharbor-harbor-core            ClusterIP   172.24.117.61    &lt;none&gt;        80/TCP                        5m16s\nharbor-harbor-database        ClusterIP   172.24.252.137   &lt;none&gt;        5432/TCP                      5m16s\nharbor-harbor-jobservice      ClusterIP   172.24.51.73     &lt;none&gt;        80/TCP                        5m16s\nharbor-harbor-notary-server   ClusterIP   172.24.241.2     &lt;none&gt;        4443/TCP                      5m16s\nharbor-harbor-notary-signer   ClusterIP   172.24.177.134   &lt;none&gt;        7899/TCP                      5m16s\nharbor-harbor-portal          ClusterIP   172.24.192.233   &lt;none&gt;        80/TCP                        5m16s\nharbor-harbor-redis           ClusterIP   172.24.242.178   &lt;none&gt;        6379/TCP                      5m16s\nharbor-harbor-registry        ClusterIP   172.24.182.141   &lt;none&gt;        5000/TCP,8080/TCP             5m16s\nharbor-harbor-trivy           ClusterIP   172.24.251.45    &lt;none&gt;        8080/TCP                      5m16s\n</code></pre> <p>\u5982\u4e0a\u72b6\u6001\u6240\u793a\u8868\u793aharbor\u90e8\u7f72\u5b8c\u6210\uff0c\u8bbf\u95ee\u4f7f\u7528externalURL: http://106.12.45.72:30002\u8fdb\u884c\u8bbf\u95ee\uff0c\u7528\u6237\u540d\u4f7f\u7528\u9ed8\u8ba4\u7684 admin\uff0c\u5bc6\u7801\u5219\u662f\u4e0a\u9762\u914d\u7f6e\u7684\u9ed8\u8ba4 <code>Harbor12345</code>\u3002</p> <p>\u53c2\u8003\u6587\u732e</p> <p>Harbor \u5b89\u88c5\u914d\u7f6e(k8s)</p> <p>Kubernetes\u90e8\u7f72Harbor</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#54-jenkins\u51ed\u8bc1credentials","title":"5.4 Jenkins\u51ed\u8bc1Credentials","text":"<p>\u5728\u4f7f\u7528Jenkins\u3001GitLab\u3001Harbor\u3001Kubernetes\u6253\u9020DevOps\u5e73\u53f0\u5b9e\u73b0CI/CD\u65f6\uff0c\u9700\u8981\u6d89\u53ca\u5f88\u591a\u8bc1\u4e66\u3001\u8d26\u53f7\u548c\u5bc6\u7801\u3001\u516c\u94a5\u548c\u79c1\u94a5\u7684\u914d\u7f6e\uff0c\u8fd9\u4e9b\u51ed\u8bc1\u9700 \u8981\u653e\u5728\u4e00\u4e2a\u7edf\u4e00\u7684\u5730\u65b9\u7ba1\u7406\uff0c\u5e76\u4e14\u80fd\u5728\u6574\u4e2a\u6d41\u6c34\u7ebf\u4e2d\u4f7f\u7528\uff0c\u800cJenkins\u63d0\u4f9b\u7684Credentials\u63d2\u4ef6\u53ef\u4ee5\u6ee1\u8db3\u4ee5\u4e0a\u8981\u6c42\uff0c\u5e76\u4e14\u5728\u6d41\u6c34\u7ebf\u4e2d\u4e5f\u4e0d\u4f1a\u6cc4\u9732\u76f8\u5173\u7684\u52a0\u5bc6 \u4fe1\u606f\u3002</p> <p>\u6240\u4ee5Harbor\u7684\u8d26\u53f7\u548c\u5bc6\u7801\u3001GitLab\u7684\u79c1\u94a5\u3001Kubernetes\u7684\u8bc1\u4e66\u5747\u4f7f\u7528Jenkins\u7684Credentials\u7ba1\u7406\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#1-\u914d\u7f6ekubernetes\u8bc1\u4e66","title":"1. \u914d\u7f6eKubernetes\u8bc1\u4e66","text":"<p>\u5728\u5b89\u88c5\u548c\u7ef4\u62a4Kubernetes\u96c6\u7fa4\u65f6\uff0c\u90fd\u662f\u4f7f\u7528kubectl\u64cd\u4f5c\u96c6\u7fa4\uff0c\u800ckubectl\u64cd\u4f5c\u96c6\u7fa4\u9700\u8981\u4e00\u4e2aKUBECONFIG\u6587\u4ef6\uff0c\u6211\u4eec\u4f7f\u7528Jenkins\u63a7\u5236Kubernetes\u65f6\uff0c\u4e5f\u662f\u4f7f\u7528\u8be5\u6587\u4ef6\uff0c\u6240\u4ee5\u8be5\u6587\u4ef6\u9700\u8981\u653e\u7f6e\u5728Credentials\u4e2d\uff0c\u4e4b\u540e\u53ef\u4ee5\u88abJenkins\u7684Kubernetes\u63d2\u4ef6\u4f7f\u7528\u3002</p> <p>\u9996\u5148\u9700\u8981\u627e\u5230\u96c6\u7fa4\u4e2d\u7684KUBECONFIG\uff0c\u4e00\u822c\u662fkubectl\u8282\u70b9\u7684~/.kube/config\u6587\u4ef6\uff0c\u6216\u8005\u662fKUBECONFIG\u73af\u5883\u53d8\u91cf\u6240\u6307\u5411\u7684\u6587\u4ef6\u3002</p> <p>\u63a5\u4e0b\u6765\u53ea\u9700\u8981\u628a\u8bc1\u4e66\u6587\u4ef6\u653e\u7f6e\u4e8eJenkins\u7684Credentials\u4e2d\u5373\u53ef\u3002\u9996\u5148\u5355\u51fbManage Jenkins\uff0c\u4e4b\u540e\u5355\u51fbManage Credentials\u3002</p> <p>\u7136\u540e\u5355\u51fbGlobal\u7684\u4e0b\u62c9\u9009\u9879\uff0c\u4e4b\u540e\u5355\u51fbAdd Credentials\u3002 \u5728\u6253\u5f00\u6dfb\u52a0\u51ed\u8bc1\u9875\u9762\u65f6\uff0c\u9700\u8981\u5c06\u51ed\u8bc1\u7c7b\u578b\u6539\u4e3aSecret file\uff0c\u5982\u56fe\u6240\u793a\u3002</p> <ul> <li>File\uff1aKUBECONFIG\u6587\u4ef6\u6216\u5176\u4ed6\u52a0\u5bc6\u6587\u4ef6\u3002</li> <li>ID\uff1a\u8be5\u51ed\u8bc1\u7684ID\u3002</li> <li>Description\uff1a\u8bc1\u4e66\u7684\u63cf\u8ff0\u3002</li> </ul> <p>)</p> <p>\u6dfb\u52a0Kubernetes\u7684kubeconfig</p> <p>\u53ea\u9700\u8981\u7b80\u5355\u7684\u51e0\u6b65\uff0c \u5c31\u53ef\u4ee5\u6dfb\u52a0Kubernetes\u7684KUBECONFIG\u6587\u4ef6\u81f3Jenkins\uff0c\u4e4b\u540e\u5c31\u53ef\u4ee5\u4f7f\u7528\u524d\u9762\u8bb2\u8fc7\u7684Jenkins\u8bed\u6cd5\u5f15\u7528\u8be5\u51ed\u8bc1\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#2-\u914d\u7f6eharbor\u8d26\u53f7\u548c\u5bc6\u7801","title":"2. \u914d\u7f6eHarbor\u8d26\u53f7\u548c\u5bc6\u7801","text":"<p>\u5bf9\u4e8e\u8d26\u53f7\u3001\u5bc6\u7801\u548cKey\u7c7b\u578b\u7684\u51ed\u8bc1\uff0c\u914d\u7f6e\u6b65\u9aa4\u662f\u4e00\u81f4\u7684\uff0c\u53ea\u662f\u9009\u62e9\u7684\u51ed\u8bc1\u7c7b\u578b\u4e0d\u4e00\u6837\u3002\u63a5\u4e0b\u6765\u901a\u8fc7Jenkins\u51ed\u8bc1\u7ba1\u7406Harbor\u7684\u8d26\u53f7\u548c\u5bc6\u7801\u3002</p> <p>\u5728\u540c\u6837\u7684\u4f4d\u7f6e\u5355\u51fbAdd Credentials</p> <p>\u9009\u62e9\u7c7b\u578b\u4e3aUsername with password\uff0c\u5982\u56fe</p> <p>)</p> <ul> <li>Username\uff1aHarbor\u6216\u8005\u5176\u4ed6\u5e73\u53f0\u7684\u7528\u6237\u540d\u3002</li> <li>Password\uff1aHarbor\u6216\u8005\u5176\u4ed6\u5e73\u53f0\u7684\u5bc6\u7801\u3002</li> <li>ID\uff1a\u8be5\u51ed\u8bc1\u7684ID\uff0charbor-user-passwd\u3002</li> <li>Description\uff1a\u8bc1\u4e66\u7684\u63cf\u8ff0</li> </ul> <p>\u4e4b\u540e\u5355\u51fbOK\u6309\u94ae\u4fdd\u5b58\u5373\u53ef\uff0c\u7136\u540e\u5728\u6d41\u6c34\u7ebf\u4e2d\u5373\u53ef\u901a\u8fc7\u7c7b\u4f3cenvironment\u8fd9\u6837\u7684\u6307\u4ee4\u5f15\u7528\u8be5\u51ed\u8bc1\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#3-\u914d\u7f6egitlab-key","title":"3. \u914d\u7f6eGitLab Key","text":"<p>\u5728\u642d\u5efaGitLab\u65f6\uff0c\u5c06Jenkins\u670d\u52a1\u5668\u7684\u516c\u94a5\u653e\u5728GitLab\u4e2d\uff0c\u4e4b\u540eJenkins\u5c31\u53ef\u4ee5\u901a\u8fc7\u81ea\u5df1\u7684\u79c1\u94a5\u767b\u5f55GitLab\uff0c\u7136\u540e\u4e0b\u8f7d\u548c\u4e0a\u4f20\u4ee3\u7801\u3002</p> <p>\u5728\u6d41\u6c34\u7ebf\u7684\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u5f80\u5f80\u7b2c\u4e00\u4e2a\u8fc7\u7a0b\u5c31\u662f\u4e0b\u8f7d\u4ee3\u7801\uff0c\u6240\u4ee5Jenkins\u7684\u6d41\u6c34\u7ebf\u9700\u8981\u6709\u4e0b\u8f7d\u4ee3\u7801\u7684\u6743\u9650\u3002\u6b64\u65f6\u53ef\u4ee5\u5c06Jenkins\u7684\u79c1\u94a5\u4fdd\u5b58\u81f3Jenkins\u51ed \u8bc1\u4e2d\uff0c\u4e4b\u540e\u5728\u6d41\u6c34\u7ebf\u4e2d\u5f15\u7528\u5373\u53ef\u3002</p> <p>\u5355\u51fbAdd Credentials\uff0c\u7c7b\u578b\u9009\u62e9\u4e3aSSH Username with private key\uff0c\u5982\u56fe</p> <ul> <li>Username\uff1a\u7528\u6237\u540d\uff0c\u65e0\u5f3a\u5236\u6027\u3002</li> <li>Private Key\uff1aJenkins\u670d\u52a1\u5668\u7684\u79c1\u94a5\uff0c\u4e00\u822c\u4f4d\u4e8e~/.ssh/id_rsa</li> </ul> <pre><code># tree -a\n.\n\u251c\u2500\u2500 bin\n    \u251c\u2500\u2500 docker \u251c\u2500\u2500 helm\n    \u2514\u2500\u2500 kubectl\n\u251c\u2500\u2500 config\n    \u2514\u2500\u2500 config\n\u251c\u2500\u2500 Dockerfile\n\u2514\u2500\u2500 .ssh\n    \u251c\u2500\u2500 authorized_keys\n    \u251c\u2500\u2500 id_rsa\n    \u251c\u2500\u2500 id_rsa.pub\n    \u2514\u2500\u2500 known_hosts\n\n## \u6211\u4eec\u5df2\u7ecf\u5c06Jenkins\u670d\u52a1\u5668\u7684\u79c1\u94a5\u653e\u5165jenkins-slave\u5bb9\u5668\u4e2d\n</code></pre> <p>)</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#4-\u914d\u7f6egitlab\u8d26\u53f7\u5bc6\u7801","title":"4. \u914d\u7f6eGitLab\u8d26\u53f7\u5bc6\u7801","text":"<p>\u7531\u4e8e\u6211\u4eec\u662f\u5728\u4e00\u4e2a Slave Pod \u4e2d\u53bb\u8fdb\u884c\u6784\u5efa\uff0c\u6240\u4ee5\u5982\u679c\u4f7f\u7528 SSH \u7684\u65b9\u5f0f\u53bb\u8bbf\u95ee Gitlab \u4ee3\u7801\u4ed3\u5e93\u7684\u8bdd\u5c31\u9700\u8981\u9891\u7e41\u7684\u53bb\u66f4\u65b0 <code>SSH-KEY</code>\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u91c7\u7528\u76f4\u63a5\u4f7f\u7528\u7528\u6237\u540d\u548c\u5bc6\u7801\u7684\u5f62\u5f0f\u6765\u65b9\u5f0f\u3002</p> <p>\u5728 <code>Credentials</code> \u533a\u57df\u70b9\u51fb\u6dfb\u52a0\u6309\u94ae\u6dfb\u52a0\u6211\u4eec\u8bbf\u95ee Gitlab \u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\uff1a</p> <p>)</p> <p>\u901a\u8fc7\u4e0a\u8ff04\u79cd\u7c7b\u578b\u51ed\u8bc1\u7684\u914d\u7f6e\uff0c\u5c31\u53ef\u4ee5\u5bf9Kubernetes\u8bc1\u4e66\u3001Harbor\u8d26\u53f7\u548c\u5bc6\u7801\u4ee5\u53caGitLab Key\u6216\u8005\u8d26\u53f7\u5bc6\u7801\u8fdb\u884c\u7ba1\u7406\u3002</p> <p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u9664Jenkins\u7684\u51ed\u8bc1\u5916\uff0c\u5176\u4ed6\u7c7b\u578b\u7684\u51ed\u8bc1\u4e5f\u53ef\u4ee5\u5728Jenkins\u4e2d\u7ba1\u7406\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#55-\u914d\u7f6eagent","title":"5.5 \u914d\u7f6eAgent","text":"<p>\u901a\u5e38\u60c5\u51b5\u4e0b\uff0cJenkins Slave\u4f1a\u901a\u8fc7Jenkins Master\u8282\u70b9\u768450000\u7aef\u53e3\u4e0e\u4e4b\u901a\u4fe1\uff0c\u6240\u4ee5\u9700\u8981\u5f00\u542fAgent\u768450000\u7aef\u53e3\u3002</p> <p>\u5355\u51fbManage Jenkins\uff0c\u7136\u540e\u5355\u51fbConfigure Global Security\uff0c\u5728\u5b89\u5168\u914d\u7f6e\u4e0b\u65b9\u627e\u5230Agents\uff0c\u5355\u51fbFixed\uff0c\u8f93\u516550000\u5373\u53ef\uff0c\u5982\u56fe\uff1a</p> <p>)</p> <p>\u5b9e\u9645\u4f7f\u7528\u65f6\uff0c\u6ca1\u6709\u5fc5\u8981\u628a\u6574\u4e2aKubernetes\u96c6\u7fa4\u7684\u8282\u70b9\u90fd\u5145\u5f53\u521b\u5efaJenkins Slave Pod\u7684\u8282\u70b9\uff0c\u53ef\u4ee5\u9009\u62e9\u4efb\u610f\u4e00\u4e2a\u6216\u591a\u4e2a\u8282\u70b9\u4f5c\u4e3a\u521b\u5efaSlave Pod\u7684\u8282 \u70b9\u3002</p> <p>\u63a5\u4e0b\u6765\u9009\u62e9\u4e00\u4e2a\u6216\u591a\u4e2a\u8282\u70b9\u4f5c\u4e3aKubernetes\u521b\u5efaJenkins Slave Pod\u7684\u8282\u70b9\uff0c\u53ea\u9700\u8981\u914d\u7f6e\u4e00\u4e2a\u6807\u7b7e\u5373\u53ef\uff0c\u4e4b\u540eJenkinsfile\u7684agent\u4f1a\u6839\u636e\u6807\u7b7e\u521b\u5efa Slave Pod\u3002\u5047\u8bbek8s-node01\u4f5c\u4e3aSlave\u8282\u70b9\uff1a</p> <pre><code># kubectl label node k8s-node01 build=true\n# kubectl get nodes k8s-node01 --show-labels\nNAME         STATUS   ROLES     AGE     VERSION   LABELS\nk8s-node01   Ready    ingress   7d18h   v1.25.6   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,build=true,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node01,kubernetes.io/os=linux,node-role.kubernetes.io/ingress=true\n</code></pre> <p>\u81ea\u7531\u98ce\u683c\u91cc\u9762\u914d\u7f6e Cloud\u4e2d\u914d\u7f6e\u5982\u4e0b\uff1a</p> <p>)</p> <p>pipeline\u6d41\u6c34\u7ebf\u4e2d\u914d\u7f6e\u5982\u4e0b</p> <pre><code>pipeline{\n......\n\n    agent {\n        kubernetes {\n            cloud 'kubernetes'\n            slaveConnectTimeout 1200\n            workspaceVolume nfsWorkspaceVolume(serverAddress: \"192.168.1.60\", serverPath: \"/QaTest/jenkins-salve\", readOnly: \"false\")\n            yaml '''\n\n---\napiVersion: \"v1\"\nkind: \"Pod\"\nmetadata:\n  labels:\n    jenkins: \"slave\"\n    jenkins/label: \"jenkins-jnlp\"\n  name: \"jenkins-slave\"\n  namespace: \"kube-ops\"\n\nspec:\n  containers:\n  - env:\n    - name: \"DOCKER_HOST\"\n      value: \"tcp://docker-dind:2375\"\n\n    - name: \"JENKINS_AGENT_WORKDIR\"\n      value: \"/home/jenkins/agent\"\n\n    image: \"hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11\"\n    imagePullPolicy: \"IfNotPresent\"\n    .....\n  hostNetwork: false\n  imagePullSecrets:\n  - name: \"regcred\"\n  nodeSelector:\n    build: \"true\"\n......\n }\n</code></pre> <p>\u8bfb\u8005\u7684Kubernetes\u96c6\u7fa4\u53ef\u80fd\u5e76\u975e\u4f7f\u7528Docker\u4f5c\u4e3aRuntime\uff0c\u4f46\u662f\u7531\u4e8e\u6784\u5efa\u955c\u50cf\u65f6\u9700\u8981\u4f7f\u7528Docker\uff0c\u56e0\u6b64\u8be5\u8282\u70b9\u9700\u8981\u5b89\u88c5Docker\uff1a</p> <pre><code>$ wget https://download.docker.com/linux/static/stable/aarch64/docker-20.10.9.tgz\n$ tar zxf docker-20.10.9.tgz\n$ cp docker/* /usr/bin\n$ cat &gt;/lib/systemd/system/docker.service &lt;&lt;EOF\n[Unit]\nDescription=Docker Application Container Engine\nDocumentation=https://docs.docker.com\nAfter=network-online.target firewalld.service\nWants=network-online.target\n[Service]\nType=notify\nExecStart=/usr/bin/dockerd\nExecReload=/bin/kill -s HUP $MAINPID\nLimitNOFILE=infinity\nLimitNPROC=infinity\nTimeoutStartSec=0\nDelegate=yes\nKillMode=process\nRestart=on-failure\nStartLimitBurst=3\nStartLimitInterval=60s\n[Install]\nWantedBy=multi-user.target\nEOF\n$ systemctl daemon-reload\n$ systemctl enable --now docker $ docker version\n\n# \u5982\u679c\u955c\u50cf\u4ed3\u5e93\u672a\u914d\u7f6e\u8bc1\u4e66\uff0c\u5219\u9700\u8981\u914d\u7f6einsecure-registry\uff1a\n$ cat &gt; /etc/docker/daemon.json &lt;&lt;'EOF'\n{\n  \"graph\": \"/data/docker\",\n  \"storage-driver\": \"overlay2\",\n  \"insecure-registries\": [\"hub.gitee.cc\"],\n  \"registry-mirrors\": [\"https://25bxwt20.mirror.aliyuncs.com\"],\n  \"live-restore\": true,\n  \"bip\": \"172.16.200.1/24\",\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n  \"hosts\": [\"tcp://0.0.0.0:2375\", \"unix:///var/run/docker.sock\"],\n  \"log-opts\": {\n    \"max-size\":\"100M\",\n    \"max-file\":\"3\"\n  }\n}\nEOF\n$ systemctl restart docker\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#56-jenkins\u914d\u7f6ekubernetes\u591a\u96c6\u7fa4","title":"5.6 Jenkins\u914d\u7f6eKubernetes\u591a\u96c6\u7fa4","text":"<p>\u672c\u4e66\u8bb2\u89e3\u7684Pipeline\u91c7\u7528\u7684Agent\u4e3a\u5728Kubernetes\u96c6\u7fa4\u4e2d\u521b\u5efa\u7684Pod\uff0c\u6240\u4ee5Jenkins\u8981\u63a7\u5236Kubernetes\u96c6\u7fa4\u521b\u5efaPod\u5145\u5f53Jenkins\u7684Slave\u3002</p> <p>\u4e4b\u524d\u6211\u4eec\u6dfb\u52a0\u4e86Kubernetes\u7684\u8bc1\u4e66\u81f3Jenkins\u51ed\u8bc1\uff0c\u63a5\u4e0b\u6765\u5728Jenkins\u4e2d\u914d\u7f6eKubernetes\u76f4\u63a5\u5f15\u7528\u8be5\u8bc1\u4e66\u3002</p> <p>\u9996\u5148\u5355\u51fbManage Jenkins\uff0c\u4e4b\u540e\u5355\u51fbConfigure Clouds\uff0c\u5982\u56fe\u6240\u793a\u3002</p> <p>)</p> <p>\u5355\u51fbAdd a new cloud\uff0c\u9009\u62e9Kubernetes</p> <p>\u4e4b\u540e\u5728Name\u5b57\u6bb5\u8f93\u5165\u96c6\u7fa4\u7684\u540d\u79f0\uff0c\u4e00\u822c\u8f93\u5165\u53ef\u8bc6\u522b\u7684\u540d\u79f0\u5373\u53ef\uff0c\u6bd4\u5982\u73b0\u5728\u662f\u5b66\u4e60\u73af \u5883 \u7684 Kubernetes \uff0c \u53ef \u4ee5 \u53eb \u4f5c kubernetes\u3002 </p> <p>\u4e4b\u540e\u5355\u51fbKubernetes Cloud details\uff0c\u5982\u56fe</p> <p>\u7136\u540e\u5728Credentials\u5904\u9009\u62e9\u4e4b\u524d\u6dfb\u52a0\u7684Kubernetes\u8bc1\u4e66\uff0c\u9009\u62e9\u540e\u5355\u51fbTest Connection\uff0c\u6700\u540e\u5728\u51ed\u8bc1\u4e0b\u65b9\u5373\u53ef\u770b\u5230\u80fd\u5426\u6b63\u5e38\u8fde\u63a5\u7684\u7ed3\u679c\u3002</p> <p>)</p> <p>\u6700\u540e\u5355\u51fbSave\u5373\u53ef\uff0c\u6dfb\u52a0\u5b8cKubernetes\u540e\uff0c\u5728Jenkinsfile\u7684Agent\u4e2d\u5c31\u53ef\u4ee5\u9009\u62e9\u8be5\u96c6\u7fa4\u4f5c\u4e3a\u521b\u5efaSlave\u7684\u96c6\u7fa4\u3002</p> <p>\u5982\u679c\u60f3\u8981\u6dfb\u52a0\u591a\u4e2a\u96c6\u7fa4\uff0c\u91cd\u590d\u4e0a\u8ff0\u6b65\u9aa4\u5373\u53ef\u3002\u9996\u5148\u6dfb\u52a0Kubernetes\u51ed\u8bc1\uff0c\u7136\u540e\u6dfb\u52a0Cloud\u5373\u53ef\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#6-\u81ea\u52a8\u5316\u6784\u5efajava\u5e94\u7528","title":"6. \u81ea\u52a8\u5316\u6784\u5efaJava\u5e94\u7528","text":"<p>\u672c\u8282\u5c06\u6f14\u793a\u81ea\u52a8\u5316\u6784\u5efaJava\u5e94\u7528\uff0c\u4f7f\u7528Spring Cloud\u7684Eureka\u8fdb\u884c\u6f14\u793a\uff0c\u5176\u4ed6Spring Boot\u6216\u8005Java\u5e94\u7528\u57fa\u672c\u4e0a\u90fd\u662f\u540c\u6837\u7684\u6b65\u9aa4\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#61-\u90e8\u7f72kubernetes\u5e94\u7528","title":"6.1 \u90e8\u7f72Kubernetes\u5e94\u7528","text":"<p>\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\u4e86\u5982\u4f55\u5728 Jenkins Slave \u4e2d\u6784\u5efa\u4efb\u52a1\u4e86\uff0c\u90a3\u4e48\u5982\u4f55\u6765\u90e8\u7f72\u4e00\u4e2a\u539f\u751f\u7684 Kubernetes \u5e94\u7528\u5462\uff1f \u8981\u90e8\u7f72 Kubernetes \u5e94\u7528\uff0c\u6211\u4eec\u5c31\u5f97\u5bf9\u6211\u4eec\u4e4b\u524d\u90e8\u7f72\u5e94\u7528\u7684\u6d41\u7a0b\u8981\u975e\u5e38\u719f\u6089\u624d\u884c\uff0c\u6211\u4eec\u4e4b\u524d\u7684\u6d41\u7a0b\u662f\u600e\u6837\u7684\uff1a</p> <ul> <li>\u7f16\u5199\u4ee3\u7801</li> <li>\u6d4b\u8bd5</li> <li>\u7f16\u5199 Dockerfile</li> <li>\u6784\u5efa\u6253\u5305 Docker \u955c\u50cf</li> <li>\u63a8\u9001 Docker \u955c\u50cf\u5230\u4ed3\u5e93</li> <li>\u7f16\u5199 Kubernetes YAML \u6587\u4ef6</li> <li>\u66f4\u6539 YAML \u6587\u4ef6\u4e2d Docker \u955c\u50cf TAG</li> <li>\u5229\u7528 kubectl \u5de5\u5177\u90e8\u7f72\u5e94\u7528</li> </ul>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#62-\u521b\u5efajava\u6d4b\u8bd5\u7528\u4f8b","title":"6.2 \u521b\u5efaJava\u6d4b\u8bd5\u7528\u4f8b","text":"<p>\u672c\u4e66\u4e3a\u8bfb\u8005\u51c6\u5907\u4e86\u4e00\u4e2a\u7b80\u5355\u7684Java\u6d4b\u8bd5\u7528\u4f8b\uff0c\u7528\u4e8e\u8bfb\u8005\u7684\u5b66\u4e60\uff0c\u53ef\u4ee5\u4ecehttps://gitee.com/dukuan/spring-boot-project.git\u627e\u5230\u8be5\u9879\u76ee\uff08\u4e5f\u53ef\u4ee5 \u4f7f\u7528\u516c\u53f8\u7684Java\u9879\u76ee\uff09\u3002</p> <p>\u63a5\u4e0b\u6765\u5c06\u8be5\u9879\u76ee\u5bfc\u5165\u81ea\u5df1\u7684GitLab\u4e2d\u3002\u9996\u5148\u627e\u5230\u4e4b\u524d\u521b\u5efa\u7684Kubernetes\u7ec4\uff0c\u7136\u540e\u5355\u51fbNew project\uff0c\u5982\u56fe )</p> <p>\u5728Git repository URL\u4e2d\u8f93\u5165\u793a\u4f8b\u5730\u5740\uff0c\u7136\u540e\u5355\u51fbCreate project\uff0c\u5982\u56fe )</p> <p>\u5bfc\u5165\u540e\uff0c\u7ed3\u679c\u5982\u56fe )</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#63-\u5b9a\u4e49jenkinsfile","title":"6.3 \u5b9a\u4e49Jenkinsfile","text":"<p>\u5148\u5c06\u955c\u50cf\u4e0a\u4f20\u5230harbor\u79c1\u6709\u4ed3\u5e93</p> <pre><code># docker pull registry.cn-beijing.aliyuncs.com/citools/maven:3.5.3\n# docker tag registry.cn-beijing.aliyuncs.com/citools/maven:3.5.3 hub.gitee.cc/kubernetes/maven:3.5.3\n# docker push hub.gitee.cc/kubernetes/maven:3.5.3\n</code></pre> <p>Jenkinsfile\u5b9a\u4e49\u6d41\u6c34\u7ebf\u7684\u6b65\u9aa4\u5305\u62ec\u62c9\u53d6\u4ee3\u7801\u3001\u6267\u884c\u6784\u5efa\u3001\u751f\u6210\u955c\u50cf\u3001\u66f4\u65b0Kubernetes\u8d44\u6e90\u7b49\u3002</p> <p>\u672c\u4e66\u5c06Jenkinsfile\u653e\u7f6e\u4e8e\u9879\u76ee\u6e90\u4ee3\u7801\u4e00\u5e76\u7ba1\u7406\uff0c\u4e5f\u53ef\u4ee5\u5355\u72ec\u653e\u7f6e\u4e8e\u4e00\u4e2aGit\u4ed3\u5e93\u8fdb\u884c\u7ba1\u7406\u3002</p> <p>\u63a5\u4e0b\u6765\u5728GitLab\u7684\u6e90\u4ee3\u7801\u4e2d\u6dfb\u52a0Jenkinsfile\u3002\u9996\u5148\u5355\u51fb\u4ee3\u7801\u9996\u9875\u7684\u201c+\u201d\uff0c\u7136\u540e\u5355\u51fbNew file\uff0c</p> <p>)</p> <p>\u5728\u7a97\u53e3\u4e2d\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>pipeline{\n    // \u5b9a\u4e49\u4e00\u4e9b\u5168\u5c40\u7684\u73af\u5883\u53d8\u91cf\n    environment {\n        COMMIT_ID = \"\"\n        // harbor\u5730\u5740\n        HARBOR_ADDRESS = \"hub.gitee.cc\"\n        // harbor\u7684\u9879\u76ee\u76ee\u5f55\n        REGISTRY_DIR = \"kubernetes\"\n        // \u955c\u50cf\u540d\u79f0\n        IMAGE_NAME = \"spring-boot-project\"\n        // kubernetes\u4e2d\u7684\u540d\u79f0\u7a7a\u95f4\n        NAMESPACE = \"kubernetes\"\n        // \u955c\u50cf\u7684\u5206\u652f\uff0c\u7531BUILD_TAG+COMMIT_ID\u7ec4\u6210\n        TAG = \"\"\n        // gitlab\u8d26\u53f7\u5bc6\u7801\u8ba4\u8bc1\n        GITLAB_AUTH = \"gitlab-auth\"\n        // harbor\u8d26\u53f7\u5bc6\u7801\u8ba4\u8bc1\n        HARBOR_AUTH = \"harbor-user-passwd\"\n    }\n  parameters {\n    // \u4f7f\u7528GitParameter\u63d2\u4ef6\uff0c\u8be5\u5b57\u6bb5\u4f1a\u5728jenkins\u9875\u9762\u751f\u6210\u4e00\u4e2a\u9009\u62e9\u5206\u652f\u7684\u9009\u9879\n    gitParameter(branch: '', branchFilter: 'origin/(.*)', defaultValue: 'master', description: 'Branch for build and deploy', name: 'BRANCH', quickFilterEnabled: false, selectedValue: 'NONE', sortMode: 'NONE', tagFilter: '*', type: 'PT_BRANCH')\n  }\n\n    options {\n      parallelsAlwaysFailFast()\n      disableResume()\n      quietPeriod(1)\n      preserveStashes(buildCount: 5)\n      timestamps()\n      buildDiscarder(logRotator(numToKeepStr: '100'))\n      timeout(time: 60, unit: 'MINUTES')\n    }\n\n    agent {\n        // \u5b9a\u4e49kubernetes\u4f5c\u4e3aagent\n        kubernetes {\n            // \u9009\u62e9\u7684\u4e91\u4e3a\u4e4b\u524d\u914d\u7f6e\u7684\u540d\u79f0\n            cloud 'kubernetes'\n            slaveConnectTimeout 1200\n            // \u5b58\u50a8\u4e3anfs\u65b9\u5f0f\u6301\u4e45\u5316\u6302\u8f7d\n            workspaceVolume nfsWorkspaceVolume(serverAddress: \"192.168.1.60\", serverPath: \"/QaTest/jenkins-salve\", readOnly: \"false\")\n            yaml '''\napiVersion: v1\nkind: Pod\nmetadata:\n  name: \"jenkins-slave\"\n  namespace: \"kube-ops\"\n  labels:\n    jenkins: \"slave\"\n    jenkins/label: \"jenkins-jnlp\"\nspec:\n  containers:\n  # jnlp\u5bb9\u5668\uff0c\u548cjenkins\u4e3b\u8282\u70b9\u901a\u4fe1\u3002\u5305\u542bkubectl\u547d\u4ee4\u3001helm\u547d\u4ee4\u3001docker\u547d\u4ee4\n  - name: \"jnlp\"\n    image: \"hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11\"\n    imagePullPolicy: \"IfNotPresent\"\n    tty: true\n    resources:\n      limits:\n        cpu: 1000m\n        memory: 2000Mi\n      requests:\n        cpu: 200m\n        memory: 400Mi\n    env:\n    - name: \"DOCKER_HOST\"\n      value: \"tcp://192.168.1.141:2375\"\n    - name: \"JENKINS_AGENT_WORKDIR\"\n      value: \"/home/jenkins/agent\"\n    volumeMounts:\n    - mountPath: \"/root/.kube/config\"\n      name: \"volume-0\"\n      readOnly: false\n      subPath: \"config\"\n    - name: localtime\n      mountPath: /etc/localtime\n\n    - mountPath: \"/home/jenkins/agent\"\n      name: \"workspace-volume\"\n      readOnly: false\n    workingDir: \"/home/jenkins/agent\"\n\n  # build\u5bb9\u5668\uff0c\u5305\u542b\u6784\u5efa\u7684\u547d\u4ee4\uff0cjava\u9700\u8981maven\u6784\u5efa\uff0c\u9700\u8981\u4e00\u4e2amaven\u955c\u50cf\n  - name: \"build\"\n    image: \"hub.gitee.cc/kubernetes/maven:3.5.3\"\n    imagePullPolicy: \"IfNotPresent\"\n    tty: true\n    volumeMounts:\n      - name: localtime\n        mountPath: /etc/localtime\n      # Pod\u5355\u72ec\u521b\u5efa\u4e86\u4e00\u4e2a\u7f13\u5b58\u7684volume\uff0c\u5c06\u5176\u6302\u8f7d\u5230\u4e86maven\u63d2\u4ef6\u7684\u7f13\u5b58\u76ee\u5f55\uff0c\u9ed8\u8ba4\u662f/root/.m2\n      - name:  cachedir\n        mountPath: \"/root/.m2/\"\n        readOnly: false\n    command:\n      - \"cat\"\n    env:\n      - name: \"LANGUAGE\"\n        value: \"en_US:en\"\n      - name: \"LC_ALL\"\n        value: \"en_US.UTF-8\"\n      - name: \"LANG\"\n        value: \"en_US.UTF-8\"\n\n  volumes:\n    - name: localtime\n      hostPath:\n        path: /usr/share/zoneinfo/Asia/Shanghai\n\n    - configMap:\n        name: \"kubeconfig\"\n        optional: false\n      name: \"volume-0\"\n    # \u7f13\u5b58\u76ee\u5f55\n    - name: \"cachedir\"\n      hostPath:\n        path: \"/opt/m2\"\n\n    - emptyDir:\n        medium: \"\"\n      name: \"workspace-volume\"\n  restartPolicy: Always\n  hostNetwork: false\n  imagePullSecrets:\n  - name: \"regcred\"\n  # \u56fa\u5b9a\u8282\u70b9\u90e8\u7f72\n  nodeSelector:\n    build: \"true\"\n\n            '''\n        }\n    }\n\n    stages {\n      stage('Pulling Code') {\n        parallel {\n        stage('Pulling Code by Jenkins') {\n          when {\n            expression {\n              // \u82e5env.gitlabBranch\u4e3a\u7a7a\uff0c\u5219\u4e3a\u624b\u52a8\u89e6\u53d1\u6267\u884c\u624b\u52a8 stage,\u82e5\u4e0d\u4e3a\u7a7a\uff0c\u4e4b\u524d\u540c\u7ea7\u7684\u53e6\u5916\u4e00\u4e2astage\n              env.gitlabBranch == null\n            }\n\n          }\n          steps {\n            git(changelog: true, poll: true, url: 'http://gitlab.runjs.cn:8929/kubernetes/spring-boot-project.git', branch: \"${BRANCH}\", credentialsId: \"${GITLAB_AUTH}\")\n            script {\n              // \u5b9a\u4e49\u53d8\u91cf\u7528\u4e8e\u751f\u6210\u955c\u50cf\u7684Tag\n              // \u83b7\u53d6\u6700\u8fd1\u4e00\u6b21\u63d0\u4ea4\u7684Commit ID\n              COMMIT_ID = sh(returnStdout: true, script: \"git log -n 1 --pretty=format:'%h'\").trim()\n              // \u8d4b\u503c\u7ed9TAG\u53d8\u91cf\uff0c\u540e\u9762\u7684docker build\u53ef\u4ee5\u83b7\u53d6\u5230\u8be5TAG\u7684\u503c\n              TAG = BUILD_TAG + '-' + COMMIT_ID\n              println \"Current branch is ${BRANCH}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}\"\n\n            }\n\n          }\n        }\n        stage('Pulling Code by trigger') {\n          when {\n            expression {\n              // \u82e5env.gitlabBranch\u4e0d\u4e3a\u7a7a\uff0c\u5219\u4e3awebook\u89e6\u53d1\u7684\u6267\u884cwebook stage\u3002\u4e0a\u9762\u7684stage\u4e0d\u6267\u884c\uff0c\u6b64\u65f6BRANCH\u53d8\u91cf\u4e3a\u7a7a\n              env.gitlabBranch != null\n            }\n\n          }\n          steps {\n            git(url: 'http://gitlab.runjs.cn:8929/kubernetes/spring-boot-project.git', branch: env.gitlabBranch, changelog: true, poll: true, credentialsId: \"${GITLAB_AUTH}\")\n            script {\n              COMMIT_ID = sh(returnStdout: true, script: \"git log -n 1 --pretty=format:'%h'\").trim()\n              TAG = BUILD_TAG + '-' + COMMIT_ID\n              println \"Current branch is ${env.gitlabBranch}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}\"\n              }\n            }\n          }\n        }\n      }\n\n    stage('Building') {\n      steps {\n        container(name: 'build') {\n            sh \"\"\"\n              # \u7f16\u8bd1\u547d\u4ee4\uff0c\u9700\u8981\u6839\u636e\u81ea\u5df1\u7684\u5b9e\u9645\u60c5\u51b5\u8fdb\u884c\u4fee\u6539\uff0c\u53ef\u80fd\u4f1a\u4e0d\u4e00\u81f4\n              mvn clean install -DskipTests\n              # \u5b8c\u6210\u6784\u5efa\u540e\u4e00\u822c\u4f1a\u5728target\u76ee\u5f55\u751f\u4ea7jar\u5305\n              ls target/*\n            \"\"\"\n        }\n      }\n    }\n\n    stage('Docker build for creating image') {\n      steps {\n        withCredentials([[$class: 'UsernamePasswordMultiBinding',\n        credentialsId: \"${HARBOR_AUTH}\",\n        usernameVariable: 'Harbor_user',\n        passwordVariable: 'Harbor_password']]) {\n            sh \"\"\"#!/bin/bash\n              set -eux\n              # \u767b\u5f55Harbor\n              docker login -u ${Harbor_user} -p ${Harbor_password} ${HARBOR_ADDRESS}\n\n              # Dockerfile\u653e\u5728\u4ee3\u7801\u4ed3\u548cJenkinsfile\u540c\u7ea7\n              docker build --no-cache -t ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG} .\n\n              # \u63a8\u9001\u955c\u50cf\u81f3\u79c1\u6709harbor\u4ed3\u5e93\n              docker push ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG}\n              \"\"\"\n        }\n      }\n    }\n\n    stage('Deploying to K8s') {\n      steps {\n           sh \"\"\"#!/bin/bash\n           set -ux\n\n           # set\u66f4\u65b0deployment\u955c\u50cf\n           kubectl set image deploy -l app=${IMAGE_NAME} ${IMAGE_NAME}=${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG} -n $NAMESPACE\n           \"\"\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#64-jenkinsfile\u8be6\u89e3","title":"6.4 Jenkinsfile\u8be6\u89e3","text":"<p>\u9996\u5148\u662f\u9876\u5c42\u7684agent\uff0c\u5b9a\u4e49Kubernetes\u7684Pod\u4f5c\u4e3aJenkins\u7684Slave\uff1a</p> <pre><code>    agent {\n        // \u5b9a\u4e49kubernetes\u4f5c\u4e3aagent\n        kubernetes {\n            // \u9009\u62e9\u7684\u4e91\u4e3a\u4e4b\u524d\u914d\u7f6e\u7684\u540d\u79f0\n            cloud 'kubernetes'\n            slaveConnectTimeout 1200\n            // \u5b58\u50a8\u4e3anfs\u65b9\u5f0f\u6301\u4e45\u5316\u6302\u8f7d\n            workspaceVolume nfsWorkspaceVolume(serverAddress: \"192.168.1.60\", serverPath: \"/QaTest/jenkins-salve\", readOnly: \"false\")\n            yaml '''\napiVersion: v1\nkind: Pod\nmetadata:\n  name: \"jenkins-slave\"\n  namespace: \"kube-ops\"\n  labels:\n    jenkins: \"slave\"\n    jenkins/label: \"jenkins-jnlp\"\nspec:\n  containers:\n  # jnlp\u5bb9\u5668\uff0c\u548cjenkins\u4e3b\u8282\u70b9\u901a\u4fe1\u3002\u5305\u542bkubectl\u547d\u4ee4\u3001helm\u547d\u4ee4\u3001docker\u547d\u4ee4\n  - name: \"jnlp\"\n    image: \"hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11\"\n    imagePullPolicy: \"IfNotPresent\"\n    tty: true\n    resources:\n      limits:\n        cpu: 1000m\n        memory: 2000Mi\n      requests:\n        cpu: 200m\n        memory: 400Mi\n    env:\n    - name: \"DOCKER_HOST\"\n      value: \"tcp://192.168.1.141:2375\"\n    - name: \"JENKINS_AGENT_WORKDIR\"\n      value: \"/home/jenkins/agent\"\n    volumeMounts:\n    # \u6302\u8f7dkubeconfig\u6587\u4ef6\n    - mountPath: \"/root/.kube/config\"\n      name: \"volume-0\"\n      readOnly: false\n      subPath: \"config\"\n    - name: localtime\n      mountPath: /etc/localtime\n\n    - mountPath: \"/home/jenkins/agent\"\n      name: \"workspace-volume\"\n      readOnly: false\n    workingDir: \"/home/jenkins/agent\"\n\n  # build\u5bb9\u5668\uff0c\u5305\u542b\u6784\u5efa\u7684\u547d\u4ee4\uff0cjava\u9700\u8981maven\u6784\u5efa\uff0c\u9700\u8981\u4e00\u4e2amaven\u955c\u50cf\n  - name: \"build\"\n    image: \"registry.cn-beijing.aliyuncs.com/citools/maven:3.5.3\"\n    imagePullPolicy: \"IfNotPresent\"\n    tty: true\n    volumeMounts:\n      - name: localtime\n        mountPath: /etc/localtime\n      # Pod\u5355\u72ec\u521b\u5efa\u4e86\u4e00\u4e2a\u7f13\u5b58\u7684volume\uff0c\u5c06\u5176\u6302\u8f7d\u5230\u4e86maven\u63d2\u4ef6\u7684\u7f13\u5b58\u76ee\u5f55\uff0c\u9ed8\u8ba4\u662f/root/.m2\n      - name:  cachedir\n        mountPath: \"/root/.m2/\"\n        readOnly: false\n    command:\n      - \"cat\"\n    env:\n      - name: \"LANGUAGE\"\n        value: \"en_US:en\"\n      - name: \"LC_ALL\"\n        value: \"en_US.UTF-8\"\n      - name: \"LANG\"\n        value: \"en_US.UTF-8\"\n\n  volumes:\n    - name: localtime\n      hostPath:\n        path: /usr/share/zoneinfo/Asia/Shanghai\n\n    - configMap:\n        name: \"kubeconfig\"\n        optional: false\n      name: \"volume-0\"\n    # \u7f13\u5b58\u76ee\u5f55\n    - name: \"cachedir\"\n      hostPath:\n        path: \"/opt/m2\"\n\n    - emptyDir:\n        medium: \"\"\n      name: \"workspace-volume\"\n  restartPolicy: Always\n  hostNetwork: false\n  imagePullSecrets:\n  - name: \"regcred\"\n  # \u56fa\u5b9a\u8282\u70b9\u90e8\u7f72\n  nodeSelector:\n    build: \"true\"\n\n            '''\n        }\n    }\n</code></pre> <p>\u4e4b\u540e\u770b\u4e00\u4e0bJenkinsfile\u6700\u540e\u7684\u73af\u5883\u53d8\u91cf\u548cparameters\u7684\u914d\u7f6e\uff1a</p> <pre><code>    // \u5b9a\u4e49\u4e00\u4e9b\u5168\u5c40\u7684\u73af\u5883\u53d8\u91cf\n    environment {\n        COMMIT_ID = \"\"\n        // harbor\u5730\u5740\n        HARBOR_ADDRESS = \"hub.gitee.cc\"\n        // harbor\u7684\u9879\u76ee\u76ee\u5f55\n        REGISTRY_DIR = \"kubernetes\"\n        // \u955c\u50cf\u540d\u79f0\n        IMAGE_NAME = \"spring-boot-project\"\n        // kubernetes\u4e2d\u7684\u540d\u79f0\u7a7a\u95f4\n        NAMESPACE = \"kubernetes\"\n        // \u955c\u50cf\u7684\u5206\u652f\uff0c\u7531BUILD_TAG+COMMIT_ID\u7ec4\u6210\n        TAG = \"\"\n        // gitlab\u8d26\u53f7\u5bc6\u7801\u8ba4\u8bc1\n        GITLAB_AUTH = \"gitlab-auth\"\n        // harbor\u8d26\u53f7\u5bc6\u7801\u8ba4\u8bc1\n        HARBOR_AUTH = \"harbor-user-passwd\"\n    }\n  parameters {\n    // \u4f7f\u7528GitParameter\u63d2\u4ef6\uff0c\u8be5\u5b57\u6bb5\u4f1a\u5728jenkins\u9875\u9762\u751f\u6210\u4e00\u4e2a\u9009\u62e9\u5206\u652f\u7684\u9009\u9879\n    gitParameter(branch: '', branchFilter: 'origin/(.*)', defaultValue: 'master', description: 'Branch for build and deploy', name: 'BRANCH', quickFilterEnabled: false, selectedValue: 'NONE', sortMode: 'NONE', tagFilter: '*', type: 'PT_BRANCH')\n  }\n</code></pre> <p>\u63a5\u4e0b\u6765\u662f\u62c9\u53d6\u4ee3\u7801\u7684stage\uff0c\u8fd9\u4e2astage\u662f\u4e00\u4e2a\u5e76\u884c\u7684stage\uff0c\u56e0\u4e3a\u8003\u8651\u4e86\u8be5\u6d41\u6c34\u7ebf\u662f\u624b\u52a8\u89e6\u53d1\u8fd8\u662f\u81ea\u52a8\u89e6\u53d1\uff1a</p> <pre><code>      stage('Pulling Code') {\n        parallel {\n        stage('Pulling Code by Jenkins') {\n          when {\n            expression {\n              // \u82e5env.gitlabBranch\u4e3a\u7a7a\uff0c\u5219\u4e3a\u624b\u52a8\u89e6\u53d1\u6267\u884c\u624b\u52a8 stage,\u82e5\u4e0d\u4e3a\u7a7a\uff0c\u4e4b\u524d\u540c\u7ea7\u7684\u53e6\u5916\u4e00\u4e2astage\n              env.gitlabBranch == null\n            }\n\n          }\n          steps {\n            git(changelog: true, poll: true, url: 'http://gitlab.runjs.cn:8929/kubernetes/spring-boot-project.git', branch: \"${BRANCH}\", credentialsId: \"${GITLAB_AUTH}\")\n            script {\n              // \u5b9a\u4e49\u53d8\u91cf\u7528\u4e8e\u751f\u6210\u955c\u50cf\u7684Tag\n              // \u83b7\u53d6\u6700\u8fd1\u4e00\u6b21\u63d0\u4ea4\u7684Commit ID\n              COMMIT_ID = sh(returnStdout: true, script: \"git log -n 1 --pretty=format:'%h'\").trim()\n              // \u8d4b\u503c\u7ed9TAG\u53d8\u91cf\uff0c\u540e\u9762\u7684docker build\u53ef\u4ee5\u83b7\u53d6\u5230\u8be5TAG\u7684\u503c\n              TAG = BUILD_TAG + '-' + COMMIT_ID\n              println \"Current branch is ${BRANCH}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}\"\n\n            }\n\n          }\n        }\n        stage('Pulling Code by trigger') {\n          when {\n            expression {\n              // \u82e5env.gitlabBranch\u4e0d\u4e3a\u7a7a\uff0c\u5219\u4e3awebook\u89e6\u53d1\u7684\u6267\u884cwebook stage\u3002\u4e0a\u9762\u7684stage\u4e0d\u6267\u884c\uff0c\u6b64\u65f6BRANCH\u53d8\u91cf\u4e3a\u7a7a\n              env.gitlabBranch != null\n            }\n\n          }\n          steps {\n            git(url: 'http://gitlab.runjs.cn:8929/kubernetes/spring-boot-project.git', branch: env.gitlabBranch, changelog: true, poll: true, credentialsId: \"${GITLAB_AUTH}\")\n            script {\n              COMMIT_ID = sh(returnStdout: true, script: \"git log -n 1 --pretty=format:'%h'\").trim()\n              TAG = BUILD_TAG + '-' + COMMIT_ID\n              println \"Current branch is ${env.gitlabBranch}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}\"\n              }\n            }\n          }\n        }\n      }\n</code></pre> <p>\u4ee3\u7801\u62c9\u4e0b\u6765\u540e\uff0c\u5c31\u53ef\u4ee5\u6267\u884c\u6784\u5efa\u547d\u4ee4\uff0c\u7531\u4e8e\u672c\u6b21\u5b9e\u9a8c\u662fJava\u793a\u4f8b\uff0c\u56e0\u6b64\u9700\u8981\u4f7f\u7528mvn\u547d\u4ee4\u8fdb\u884c\u6784\u5efa\uff1a</p> <pre><code>    stage('Building') {\n      steps {\n        # \u4f7f\u7528pod\u6a21\u677f\u91cc\u9762build\u5bb9\u5668\u8fdb\u884c\u6784\u5efa\n        container(name: 'build') {\n            sh \"\"\" \n              # \u7f16\u8bd1\u547d\u4ee4\uff0c\u9700\u8981\u6839\u636e\u81ea\u5df1\u7684\u5b9e\u9645\u60c5\u51b5\u8fdb\u884c\u4fee\u6539\n              mvn clean install -DskipTests\n              # \u5b8c\u6210\u6784\u5efa\u540e\u4e00\u822c\u4f1a\u5728target\u76ee\u5f55\u751f\u4ea7jar\u5305\n              ls target/*\n            \"\"\"\n        }\n      }\n    }\n</code></pre> <p>\u751f\u6210\u7f16\u8bd1\u4ea7\u7269\u540e\uff0c\u9700\u8981\u6839\u636e\u8be5\u4ea7\u7269\u751f\u6210\u5bf9\u5e94\u7684\u955c\u50cf,\u5e76\u5c06\u955c\u50cf\u63a8\u9001\u5230harbor\u79c1\u6709\u4ed3\u5e93\uff1a</p> <pre><code>    stage('Docker build for creating image') {\n      steps {\n        withCredentials([[$class: 'UsernamePasswordMultiBinding',\n        credentialsId: \"${HARBOR_AUTH}\",\n        usernameVariable: 'Harbor_user',\n        passwordVariable: 'Harbor_password']]) {\n            sh \"\"\"#!/bin/bash\n              set -eux\n              # \u767b\u5f55Harbor\n              docker login -u ${Harbor_user} -p ${Harbor_password} ${HARBOR_ADDRESS}\n\n              # Dockerfile\u653e\u5728\u4ee3\u7801\u4ed3\u548cJenkinsfile\u540c\u7ea7\n              docker build --no-cache -t ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG} .\n\n              # \u63a8\u9001\u955c\u50cf\u81f3\u79c1\u6709harbor\u4ed3\u5e93\n              docker push ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG}\n              docker rmi -f ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG}\n              \"\"\"\n        }\n      }\n    }\n</code></pre> <p>\u6700\u540e\u4e00\u6b65\u5c31\u662f\u5c06\u8be5\u955c\u50cf\u53d1\u7248\u81f3Kubernetes\u96c6\u7fa4\u4e2d\uff0c\u6b64\u65f6\u4f7f\u7528\u7684\u662f\u5305\u542bkubectl\u547d\u4ee4\u7684\u5bb9\u5668\uff1a</p> <pre><code>    stage('Deploying to K8s') {\n      steps {\n           sh \"\"\"#!/bin/bash\n           set -ux\n\n           # set\u66f4\u65b0deployment\u955c\u50cf\n           kubectl set image deploy -l app=${IMAGE_NAME} ${IMAGE_NAME}=${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG} -n $NAMESPACE\n           \"\"\"\n      }\n    }\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#65-\u5b9a\u4e49dockerfile","title":"6.5 \u5b9a\u4e49Dockerfile","text":"<p>\u5728\u6267\u884c\u6d41\u6c34\u7ebf\u8fc7\u7a0b\u65f6\uff0c\u9700\u8981\u5c06\u4ee3\u7801\u7684\u7f16\u8bd1\u4ea7\u7269\u505a\u6210\u955c\u50cf\u3002Dockerfile\u4e3b\u8981\u5199\u7684\u662f\u5982\u4f55\u751f\u6210\u516c\u53f8\u4e1a\u52a1\u7684\u955c\u50cf\uff0c\u800c\u672c\u793a\u4f8b\u662fJava\u9879\u76ee\uff0c\u53ea\u9700\u8981\u628aJAR\u5305\u653e\u5728\u6709JRE\u73af\u5883\u7684\u955c\u50cf\u4e2d\uff0c\u7136\u540e\u542f\u52a8\u8be5JAR\u5305\u5373\u53ef\uff1a</p> <p><code>Dockerfile</code></p> <pre><code># \u57fa\u7840\u955c\u50cf\u53ef\u4ee5\u6309\u9700\u4fee\u6539\uff0c\u53ef\u4ee5\u66f4\u6539\u4e3a\u516c\u53f8\u81ea\u6709\u7684\u955c\u50cf\nFROM registry.cn-beijing.aliyuncs.com/dotbalo/jre:8u211-data\n# JAR\u5305\u540d\u79f0\u6539\u6210\u5b9e\u9645\u7684\u540d\u79f0\uff0c\u672c\u793a\u4f8b\u4e3aspring-cloud-eureka-0.0.1-SNAPSHOT.jar\nCOPY target/spring-cloud-eureka-0.0.1-SNAPSHOT.jar ./\n\n# \u542f\u52a8JAR\u5305\nCMD java -jar spring-cloud-eureka-0.0.1-SNAPSHOT.jar\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#66-\u5b9a\u4e49kubernetes\u8d44\u6e90","title":"6.6 \u5b9a\u4e49Kubernetes\u8d44\u6e90","text":"<p>\u672c\u4e66\u7684\u793a\u4f8b\u5728GitLab\u521b\u5efa\u7684Group\u4e3akubernetes\uff0c\u53ef\u4ee5\u8ba4\u4e3a\u5176\u662f\u4e00\u4e2a\u9879\u76ee\uff0c\u540c\u4e00\u4e2a\u9879\u76ee\u53ef\u4ee5\u90e8\u7f72\u81f3Kubernetes\u96c6\u7fa4\u4e2d\u7684\u540c\u4e00\u4e2aNamespace\u4e2d\uff0c\u672c\u793a\u4f8b \u4e3akubernetes\u547d\u540d\u7a7a\u95f4\u3002\u7531\u4e8e\u4f7f\u7528\u7684\u662f\u79c1\u6709\u4ed3\u5e93\uff0c\u56e0\u6b64\u9700\u8981\u5148\u914d\u7f6e\u62c9\u53d6\u79c1\u6709\u4ed3\u5e93\u955c\u50cf\u7684\u5bc6\u94a5\uff1a</p> <pre><code># kubectl create ns kubernetes\nnamespace/kubernetes created\n# kubectl -n kubernetes create secret docker-registry harborkey \\\n--docker-server=http://hub.gitee.cc \\\n--docker-username=admin \\\n--docker-password=oschina123 \\\n--docker-email=1@2.com\n</code></pre> <p>\u914d\u7f6e\u8be5\u5e94\u7528\u7684Deployment\uff08\u90e8\u5206\u5185\u5bb9\uff09\uff0c\u9700\u8981\u6ce8\u610f\u6587\u4ef6\u7684\u6587\u5b57\u6ce8\u91ca\u90e8\u5206\uff1a</p> <p><code>deployment.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nlabels:\napp: spring-boot-project\nname: spring-boot-project\nnamespace: kubernetes\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: spring-boot-project\nstrategy:\nrollingUpdate:\nmaxSurge: 1\nmaxUnavailable: 0\ntype: RollingUpdate\ntemplate:\nmetadata:\nlabels:\napp: spring-boot-project\nspec:\ncontainers:\n- env:\n- name: TZ\nvalue: Asia/Shanghai\n- name: LANG\nvalue: C.UTF-8\nimage: hub.gitee.cc/kubernetes/spring-boot-project:jenkins-spring-boot-project-2-e9ddd5d\nimagePullPolicy: IfNotPresent\nlivenessProbe:\nfailureThreshold: 2\ninitialDelaySeconds: 30\nperiodSeconds: 10\nsuccessThreshold: 1\ntcpSocket:\nport: 8761\ntimeoutSeconds: 2\nname: spring-boot-project\nports:\n- containerPort: 8761\nname: web\nprotocol: TCP\nresources:\nlimits:\ncpu: 994m\nmemory: 2170Mi\nrequests:\ncpu: 10m\nmemory: 55Mi\ndnsPolicy: ClusterFirst\nimagePullSecrets:\n- name: harborkey\nrestartPolicy: Always\nsecurityContext: {}\nserviceAccountName: default\n</code></pre> <p>\u5b9a\u4e49\u8be5\u5e94\u7528\u7684Service\u548cIngress\uff1a</p> <p><code>spring-boot-project-svc-ingress.yaml</code></p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\nlabels:\napp: spring-boot-project\nname: spring-boot-project\nnamespace: kubernetes\nspec:\nports:\n- name: web\nport: 8761\nprotocol: TCP\ntargetPort: 8761\nselector:\napp: spring-boot-project\ntype: ClusterIP\n---\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\nname: spring-boot-project\nnamespace: kubernetes\nspec:\ningressClassName: nginx\nrules:\n- host: spring-boot-project.test.com\nhttp:\npaths:\n- backend:\nservice:\nname: spring-boot-project\nport: number: 8761\npath: /\npathType: ImplementationSpecific\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5728\u5b9e\u9645\u4f7f\u7528\u65f6\uff0cJava\u4e00\u822c\u662f\u540e\u53f0\u5e94\u7528\uff0c\u4e0d\u9700\u8981\u4f7f\u7528Ingress\u66b4\u9732\u51fa\u53bb\uff0c\u53ea\u9700\u8981\u914d\u7f6eService\u5373\u53ef\u3002</p> <p>\u5982\u679c\u9700\u8981\u88ab\u96c6\u7fa4\u5916\u90e8\u7684\u7528\u6237\u76f4\u63a5\u8bbf\u95ee\uff0c\u9700\u8981\u914d\u7f6eIngress\uff0c\u901a\u8fc7\u57df\u540d\u53d1\u5e03\u3002</p> <p>\u521b\u5efa\u8be5\u8d44\u6e90\uff1a</p> <pre><code># kubectl create -f deployment.yaml\n# kubectl create -f spring-boot-project-svc-ingress.yaml\nservice/spring-boot-project created\ningress.networking.k8s.io/spring-boot-project created\n</code></pre> <p>\u63d0\u793a</p> <p>\u7531\u4e8e\u5728Harbor\u5df2\u7ecf\u914d\u7f6e\u4e86Kubernetes\u7684\u9879\u76ee\u76ee\u5f55\uff0c\u5728\u6b64\u4e0d\u518d\u91cd\u590d\u521b\u5efa\uff0c\u5982\u679c\u9700\u8981\u5c06\u955c\u50cf\u63a8\u9001\u81f3\u5176\u4ed6\u76ee\u5f55\uff0c\u6309\u7167\u540c\u6837\u7684\u6b65 \u9aa4\u521b\u5efa\u5373\u53ef\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#67-\u521b\u5efajenkins\u4efb\u52a1","title":"6.7 \u521b\u5efaJenkins\u4efb\u52a1","text":"<p>\u5355\u51fb\u9996\u9875\u7684\u521b\u5efa\u4efb\u52a1\uff08Job\uff09\u9009\u9879\uff08\u6216\u8005New Item\uff09\u5e76\u914d\u7f6e\u4efb\u52a1\u4fe1\u606f\uff0c\u8f93\u5165Job\u7684\u540d\u79f0\uff08\u4e00\u822c\u548cGitLab\u7684\u4ed3\u5e93\u540d\u5b57\u4e00\u81f4\uff0c\u4ee5\u4fbf\u4e8e\u533a\u5206\uff09\uff0c\u7c7b\u578b\u4e3aPipeline\uff0c\u6700\u540e\u5355\u51fbOK\u3002</p> <p>)</p> <p>\u5728\u65b0\u9875\u9762\u5355\u51fbPipeline\uff0c\u8f93\u5165Git\u4ed3\u5e93\u5730\u5740\uff0c\u9009\u62e9\u4e4b\u524d\u914d\u7f6e\u7684GitLab \u8d26\u53f7\u5bc6\u7801Key\uff0c\u5206\u652f\u4e3amaster\uff0c\u5355\u51fbSave\u3002</p> <p>)</p> <p>\u7b2c\u4e00\u6b21\u6784\u5efa\u4e5f\u4f1a\u5931\u8d25\uff0c\u7b2c\u4e8c\u6b21\u53ef\u4ee5\u9009\u62e9\u5206\u652f\u6784\u5efa\uff0c\u4e4b\u540e\u5355\u51fbBuild\uff0c\u7136\u540e\u5355\u51fbBuild History\u7684\u8fdb\u5ea6\u6761\uff0c\u5373\u53ef\u67e5\u770b\u6784\u5efa\u65e5\u5fd7\u3002</p> <p>)</p> <p>)</p> <p>\u6784\u5efa\u65e5\u5fd7\u4e0a\u90e8\u5206\u4e3a\u521b\u5efaPod\u7684\u65e5\u5fd7\uff0c\u53ef\u4ee5\u770b\u5230Pod\u4e3aAgent\u6307\u5b9a\u7684Pod\uff0c\u5982\u56fe</p> <p>)</p> <p>\u5982\u679c\u662fJava\u5e94\u7528\uff0c\u53ef\u4ee5\u770b\u5230BUILD SUCCESS\uff0c\u8bf4\u660emvn\u7f16\u8bd1\u5df2\u7ecf\u901a\u8fc7\uff0c\u5982\u56fe )</p> <p>\u7f16\u8bd1\u7ed3\u675f\u540e\uff0c\u53ef\u4ee5\u770b\u5230\u5236\u4f5c\u955c\u50cf\u7684\u65e5\u5fd7\uff0c\u4e4b\u540e\u955c\u50cf\u88ab\u63a8\u9001\u81f3Harbor\uff0c\u6700\u540e\u53d1\u7248\u81f3Kubernetes\u3002 )</p> <p>)</p> <p>)</p> <p>\u51fa\u73b0Finished\uff1aSUCCESS\u8bf4\u660e\u8be5\u6d41\u6c34\u7ebf\u6b63\u5e38\u7ed3\u675f\u3002\u63a5\u4e0b\u6765\u53ef\u4ee5\u67e5\u770bDeployment\u7684\u955c\u50cf\uff1a</p> <pre><code># kubectl get deploy -n kubernetes spring-boot-project -o yaml|grep \"image: \"\nimage: hub.gitee.cc/kubernetes/spring-boot-project:jenkins-spring-boot-project-5-adf694c\n\n# kubectl get pod -n kubernetes\nNAME                                   READY   STATUS    RESTARTS        AGE\nspring-boot-project-65f88c8f6b-l89sl   1/1     Running   1 (7m34s ago)   8m24s\n</code></pre> <p>\u6ce8\u610f \u8be5\u793a\u4f8b\u53ea\u662f\u7528Eureka\u7684\u4ee3\u7801\u4f5c\u4e3a\u6d4b\u8bd5\u5e94\u7528\uff0c\u5982\u679c\u662f\u751f\u4ea7\u73af\u5883\u7684Eureka\uff0c\u6700\u597d\u4f7f\u7528StatefulSet\u521b\u5efaEureka\u96c6\u7fa4\uff0c\u56e0\u4e3aStatefulSet\u4f1a\u6709\u4e00\u4e2a\u56fa\u5b9a\u7684\u6807 \u8bc6 \u7b26 \uff0c \u6b64 \u65f6 \u5728 Eureka \u7684 defaultZone \u914d \u7f6e \u5982 \u4e0b defaultZone:http://eureka-0.eureka:8761/eureka/ \u3001 http://eureka-1.eureka:8761/eureka/\u3001http://eureka-2.eureka:8761/eureka/\uff0c\u5373\u53ef\u5f62\u6210\u96c6\u7fa4\u3002</p> <p>\u5176\u4ed6\u7684Spring Cloud\u6a21\u5757\u53ef\u4ee5\u901a\u8fc7\u8be5\u5730\u5740\u8fdb\u884c\u6ce8\u518c\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#68-webhook\u81ea\u52a8\u89e6\u53d1\u6784\u5efa","title":"6.8 Webhook\u81ea\u52a8\u89e6\u53d1\u6784\u5efa","text":"<p>\u4e4b\u524d\u7684\u6784\u5efa\u90fd\u662f\u624b\u52a8\u9009\u62e9\u5206\u652f\u8fdb\u884c\u6784\u5efa\u7684\uff0c\u5728\u5b9e\u9645\u4f7f\u7528\u65f6\uff0c\u9879\u76ee\u53ef\u80fd\u6709\u5f88\u591a\uff0c\u5982\u679c\u90fd\u662f\u624b\u52a8\u89e6\u53d1\uff0c\u53ef\u80fd\u6bd4\u8f83\u6d88\u8017\u4eba\u529b\u3002</p> <p>\u6240\u4ee5\u63a8\u8350\u6309\u9700\u914d\u7f6e\u81ea\u52a8\u89e6\u53d1\uff0c\u5373\u63d0\u4ea4\u4ee3\u7801\u540e\u81ea\u52a8\u89e6\u53d1Jenkins\u6784\u5efa\u4efb\u52a1\u3002</p> <p>\u672c\u6b21\u7528Java\u9879\u76ee\u8fdb\u884c\u6f14\u793a\u3002\u9996\u5148\u627e\u5230Java\u9879\u76ee\u7684Job\uff0c\u5355\u51fbConfigure\uff0c\u4e4b\u540e\u9009\u62e9Build Triggers\uff0c\u52fe\u9009Build when a change\u2026\uff0c</p> <p>\u8bb0\u5f55webhook URL\uff0c\u4e4b\u540e\u5355\u51fbAdvanced\uff0c\u9009\u62e9Allow all branches to trigger this job\uff0c</p> <p>\u5982\u679c\u4e0d\u60f3\u4efb\u4f55\u5206\u652f\u90fd\u53ef\u4ee5\u89e6\u53d1\u8be5\u6d41\u6c34\u7ebf\uff0c\u53ef\u4ee5\u9009\u62e9Filter\u8fdb\u884c\u6761\u4ef6\u5339\u914d\u3002\u4e4b\u540e\u5355\u51fbGenerate\u751f\u6210Secret token\uff0c\u6700\u540e\u5355\u51fbSave\u5373\u53ef\u3002</p> <p>)</p> <p>)</p> <p>\u63a5\u4e0b\u6765\u914d\u7f6eGitLab\uff0c\u9996\u5148\u5355\u51fbMenu\u2192Admin\u9009\u62e9Settings\u2192Network\uff0c\u4e4b\u540e\u5141\u8bb8\u8bbf\u95ee\u5916\u90e8\u7684\u8bf7\u6c42\u3002 )</p> <p>\u5728Integrations\u914d\u7f6e\u9875\u7684\u76f8\u5e94\u8f93\u5165\u6846\u4e2d\u7c98\u8d34\u4e0a\u4e00\u6b65\u4e2dJenkins\u66b4\u9732\u7684webhook\u53ca\u76f8\u5e94\u7684Secret token\u5982\u4e0b\uff1a</p> <p>)</p> <p>\u6d4b\u8bd5\u6574\u4e2a\u94fe\u8def\u662f\u5426\u901a\u4e86\u3002\u5728GitLab\u4e0a\u6dfb\u52a0\u597d\u8fd9\u4e2awebhook\u540e\uff0c\u53ef\u4ee5\u8df3\u5230\u8868\u5355\u4e0b\u65b9\uff0c\u6709\u4e00\u4e2a\u5df2\u6dfb\u52a0\u7684webhook\u5217\u8868\uff0c\u627e\u5230\u6211\u4eec\u521a\u521a\u521b\u5efa\u7684webbook\u3002\u5355\u51fb\u201cTest\u201d\u6309\u94ae\uff0c\u9009\u62e9\u201cPushevents\u201d\uff0cGitLab\u5c31\u4f1a\u5411\u8be5webhook\u53d1\u9001\u4e00\u4e2aevent\u3002</p> <p>\u6dfb\u52a0\u4e4b\u540e\uff0c\u53ef\u4ee5\u70b9\u51fb\u4e00\u4e0btest\u770b\u770b\u6d41\u7a0b\u662f\u5426\u80fd\u591f\u8d70\u901a\uff0c\u5982\u679c\u8d70\u901a\uff0c\u90a3\u4e48\u6211\u4eec\u4ee5\u540e\u5f00\u53d1\u7684\u65f6\u5019\u76f4\u63a5\u63a8\u9001\u4ee3\u7801\u5373\u53ef\u89e6\u53d1\u6784\u5efa\u3002</p> <p>\u6b63\u5e38\u72b6\u6001\u8fd4\u56de\u5982\u4e0b\uff1a</p> <p>)</p> <p>\u4e5f\u53ef\u4ee5\u901a\u8fc7Blue Ocean\u770b\u5230\u662f\u81ea\u52a8\u89e6\u53d1\u7684stage\u88ab\u6267\u884c\uff0c\u5982\u56fe</p> <p>)</p> <p>\u65b0\u5efaPull Request\u5206\u652f\uff0c\u63d0\u4ea4\u4ee3\u7801\u6d4b\u8bd5CI\u89e6\u53d1\u3002</p> <pre><code># git clone ssh://git@gitlab.runjs.cn:2224/kubernetes/spring-boot-project.git\n# cd spring-boot-project/\n# git checkout -b dev-hu\n# echo \"test=hu\" &gt;&gt; README.md\n# git add .\n# git commit -m \"hujianli test\"\n# git push --set-upstream origin dev-hu\n</code></pre> <p>\u89e6\u53d1\u540e\u624b\u5de5\u6267\u884c\u4e2d\uff0c\u51fa\u73b0\u53ef\u4ee5\u9009\u62e9Pull Request\u7248\u672c\u7684\u4fe1\u606f\u3002</p> <p>)</p> <p>\u4ee5\u4e0a\u5c31\u662f\u901a\u8fc7GitLab\u7684\u4e8b\u4ef6\u89e6\u53d1Jenkins\u4efb\u52a1\uff0c\u5728\u5b9e\u9645\u4f7f\u7528\u65f6\uff0c\u6b64\u529f\u80fd\u975e\u5e38\u5e38\u7528\uff0c\u4e00\u822c\u4f1a\u7528\u4e8e\u5f00\u53d1\u3001\u6d4b\u8bd5\u7b49\u73af\u5883\uff0c\u7701\u53bb\u4e86\u624b\u52a8\u6784\u5efa\u7684\u8fc7\u7a0b\u3002</p> <p>\u800c\u5728UAT\u548c\u751f\u4ea7\u73af\u5883\uff0c\u4e00\u822c\u4e0d\u9700\u8981\u518d\u6b21\u6784\u5efa\uff0c\u800c\u662f\u9009\u62e9\u5176\u4ed6\u73af\u5883\u4ea7\u751f\u7684\u955c\u50cf\u8fdb\u884c\u53d1\u7248\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#69-\u6784\u5efa\u72b6\u6001\u4fe1\u606f\u63a8\u9001\u5230gitlab","title":"6.9 \u6784\u5efa\u72b6\u6001\u4fe1\u606f\u63a8\u9001\u5230GitLab","text":"<p>\u5148\u751f\u6210\u4e00\u4e2a\u8bbf\u95ee\u4ee4\u724c\uff0c\u7528\u4e8e\u5728jenkins\u7684\u7cfb\u7edf\u914d\u7f6e\u53bb\u914d\u7f6e\u8fde\u63a5gitlab\u7684\u9009\u9879 )</p> <p>\u751f\u6210\u4e2a\u4eba\u8bbf\u95ee\u4ee4\u724c\u3002 )</p> <p>\u9996\u5148\u5728jenkins\u4e0a\u521b\u5efa\u4e00\u4e2agitlab api token\u7684\u51ed\u8bc1 )</p> <p>\u9996\u5148\u5728<code>\u7cfb\u7edf\u7ba1\u7406</code>-<code>\u7cfb\u7edf\u914d\u7f6e</code>\u4e2d\u914d\u7f6e\u597d\u8fde\u63a5Gitlab\u7684\u4fe1\u606f\u5982\u4e0b</p> <p>)</p> <p>\u5728pipeline\u7684post\u90e8\u5206\uff0c\u5c06\u6784\u5efa\u7ed3\u679c\u66f4\u65b0\u5230GitLab\u7684\u76f8\u5e94commit\u8bb0\u5f55\u4e0a\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u8fd8\u9700\u8981\u5728**options\u90e8\u5206\u52a0\u5165gitLabConnection\u914d\u7f6e\uff0c\u540c\u65f6\u4f20\u5165\"gitlab\"\u53c2\u6570**\u3002\"gitlab\"\u5c31\u662f<code>Connection name</code>\u7684\u503c\u3002</p> <p>\u6838\u5fc3\u4ee3\u7801</p> <pre><code>pipeline {\n    agent any\n    triggers {\n        gitlab(triggerOnPush: true,\n            triggerOnMergeRequest: true,\n            branchFilterType: \"All\",\n            secretToken: \"t8vcxwuza023ehzcftzr5a74vkpto6xr\")\n    }\n    stages {\n        stage('build') {\n            steps {\n                echo 'Hello World from gitlab trigger'\n            }\n        }\n    }\n    post {\n        failure {\n            updateGitlabCommitStatus name: \"build\", state: \"failed\"\n        }\n        success {\n            updateGitlabCommitStatus name: \"build\", state: \"success\"\n        }\n    }\n    options {\n        gitLabConnection(\"gitlab\")\n    }\n}\n</code></pre> <p>\u63d0\u4ea4\u4ee3\u7801\u540e\uff0c\u9700\u8981\u624b\u52a8\u89e6\u53d1\u4e00\u6b21\u6784\u5efa\uff0cpipeline\u624d\u4f1a\u751f\u6548\u3002</p> <p>)</p> <p>\u53c2\u8003\u6587\u732e</p> <p>jenkins\u8fd4\u56de\u6784\u5efa\u72b6\u6001\u5230gitlab</p> <p>https://www.cnblogs.com/shipment/p/14690649.html</p> <p>https://blog.51cto.com/ygqygq2/2461766</p> <p>https://www.jianshu.com/p/d2af2915cfea</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#7-\u81ea\u52a8\u5316\u6784\u5efavueh5\u524d\u7aef\u5e94\u7528","title":"7. \u81ea\u52a8\u5316\u6784\u5efaVue/H5\u524d\u7aef\u5e94\u7528","text":"<p>\u672c\u8282\u4ecb\u7ecd\u81ea\u52a8\u5316\u6784\u5efaVue/H5\u5e94\u7528\uff0c\u5176\u6784\u5efa\u65b9\u5f0f\u548c\u81ea\u52a8\u5316\u6784\u5efaJava\u57fa\u672c\u76f8\u540c\uff0c\u91cd\u70b9\u662f\u66f4\u6539Deployment\u3001Jenkinsfile\u548cDockerfile\u3002</p> <p>\u540c \u6837 \uff0c \u524d\u7aef\u5e94\u7528\u4e5f\u4e3a\u8bfb\u8005\u51c6\u5907\u4e86\u4e00\u4e2a\u6d4b\u8bd5\u9879\u76ee\uff08 \u9879\u76ee\u5730\u5740\uff1ahttps://gitee.com/dukuan/vue-project.git\uff09\uff0c\u53ef\u4ee5\u6309\u7167\u521b\u5efaJava\u6d4b\u8bd5\u7528\u4f8b\u7684\u65b9\u5f0f\u5bfc \u5165\u524d\u7aef\u9879\u76ee\u5230GitLab\u4e2d\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u4f7f\u7528\u516c\u53f8\u81ea\u5df1\u7684\u9879\u76ee\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#71-\u5b9a\u4e49jenkinsfile","title":"7.1 \u5b9a\u4e49Jenkinsfile","text":"<p>\u5148\u5c06\u955c\u50cf\u4e0a\u4f20\u5230harbor\u79c1\u6709\u4ed3\u5e93</p> <pre><code># docker pull registry.cn-beijing.aliyuncs.com/citools/node:lts\n# docker tag registry.cn-beijing.aliyuncs.com/citools/node:lts hub.gitee.cc/kubernetes/node:lts\n# docker push hub.gitee.cc/kubernetes/node:lts\n</code></pre> <p>Jenkinsfile\u548cJava\u9879\u76ee\u5e76\u65e0\u592a\u5927\u533a\u522b\uff0c\u9700\u8981\u66f4\u6539\u7684\u4f4d\u7f6e\u5982\u4e0b\uff08\u5c55\u793a\u90e8\u5206\u4ee3\u7801\uff09\uff1a</p> <pre><code>pipeline{\n    environment {\n        COMMIT_ID = \"\"\n        HARBOR_ADDRESS = \"hub.gitee.cc\"\n        REGISTRY_DIR = \"kubernetes\"\n        IMAGE_NAME = \"vue-project\"\n        NAMESPACE = \"kubernetes\"\n        TAG = \"\"\n        GITLAB_AUTH = \"gitlab-auth\"\n        HARBOR_AUTH = \"harbor-user-passwd\"\n    }\n  parameters {\n    gitParameter(branch: '', branchFilter: 'origin/(.*)', defaultValue: 'master', description: 'Branch for build and deploy',\n                name: 'BRANCH', quickFilterEnabled: false, selectedValue: 'NONE', sortMode: 'NONE', tagFilter: '*', type: 'PT_BRANCH')\n  }\n\n    options {\n      parallelsAlwaysFailFast()\n      disableResume()\n      quietPeriod(1)\n      preserveStashes(buildCount: 5)\n      timestamps()\n      buildDiscarder(logRotator(numToKeepStr: '100'))\n      timeout(time: 60, unit: 'MINUTES')\n      gitLabConnection(\"gitlab\")\n    }\n\n    agent {\n        kubernetes {\n            cloud 'kubernetes'\n            slaveConnectTimeout 1200\n            workspaceVolume nfsWorkspaceVolume(serverAddress: \"192.168.1.60\", serverPath: \"/QaTest/jenkins-salve\", readOnly: \"false\")\n            yaml '''\napiVersion: v1\nkind: Pod\nmetadata:\n  name: \"jenkins-slave\"\n  namespace: \"kube-ops\"\n  labels:\n    jenkins: \"slave\"\n    jenkins/label: \"jenkins-jnlp\"\nspec:\n  containers:\n  - name: \"jnlp\"\n    image: \"hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11\"\n    imagePullPolicy: \"IfNotPresent\"\n    tty: true\n    resources:\n      limits:\n        cpu: 1000m\n        memory: 2000Mi\n      requests:\n        cpu: 200m\n        memory: 400Mi\n    env:\n    - name: \"DOCKER_HOST\"\n      value: \"tcp://192.168.1.141:2375\"\n    - name: \"JENKINS_AGENT_WORKDIR\"\n      value: \"/home/jenkins/agent\"\n    volumeMounts:\n    - mountPath: \"/root/.kube/config\"\n      name: \"volume-0\"\n      readOnly: false\n      subPath: \"config\"\n    - name: localtime\n      mountPath: /etc/localtime\n\n    - mountPath: \"/home/jenkins/agent\"\n      name: \"workspace-volume\"\n      readOnly: false\n    workingDir: \"/home/jenkins/agent\"\n\n  - name: \"build\"\n    image: \"hub.gitee.cc/kubernetes/node:lts\"\n    imagePullPolicy: \"IfNotPresent\"\n    tty: true\n    volumeMounts:\n      - name: localtime\n        mountPath: /etc/localtime\n    command:\n      - \"cat\"\n    env:\n      - name: \"LANGUAGE\"\n        value: \"en_US:en\"\n      - name: \"LC_ALL\"\n        value: \"en_US.UTF-8\"\n      - name: \"LANG\"\n        value: \"en_US.UTF-8\"\n\n  volumes:\n    - name: localtime\n      hostPath:\n        path: /usr/share/zoneinfo/Asia/Shanghai\n\n    - configMap:\n        name: \"kubeconfig\"\n        optional: false\n      name: \"volume-0\"\n\n    - emptyDir:\n        medium: \"\"\n      name: \"workspace-volume\"\n  restartPolicy: Always\n  hostNetwork: false\n  imagePullSecrets:\n  - name: \"regcred\"\n  # \u56fa\u5b9a\u8282\u70b9\u90e8\u7f72\n  nodeSelector:\n    build: \"true\"\n\n            '''\n        }\n    }\n\n    stages {\n      stage('Pulling Code') {\n        parallel {\n        stage('Pulling Code by Jenkins') {\n          when {\n            expression {\n              env.gitlabBranch == null\n            }\n\n          }\n          steps {\n            git(changelog: true, poll: true, url: 'http://gitlab.runjs.cn:8929/kubernetes/vue-project.git', branch: \"${BRANCH}\", credentialsId: \"${GITLAB_AUTH}\")\n            script {\n              COMMIT_ID = sh(returnStdout: true, script: \"git log -n 1 --pretty=format:'%h'\").trim()\n              TAG = BUILD_TAG + '-' + COMMIT_ID\n              println \"Current branch is ${BRANCH}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}\"\n\n            }\n\n          }\n        }\n        stage('Pulling Code by trigger') {\n          when {\n            expression {\n              env.gitlabBranch != null\n            }\n\n          }\n          steps {\n            git(url: 'http://gitlab.runjs.cn:8929/kubernetes/vue-project.git', branch: env.gitlabBranch, changelog: true, poll: true, credentialsId: \"${GITLAB_AUTH}\")\n            script {\n              COMMIT_ID = sh(returnStdout: true, script: \"git log -n 1 --pretty=format:'%h'\").trim()\n              TAG = BUILD_TAG + '-' + COMMIT_ID\n              println \"Current branch is ${env.gitlabBranch}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}\"\n              }\n            }\n          }\n        }\n      }\n\n    stage('Building') {\n      steps {\n        container(name: 'build') {\n            sh \"\"\"\n              npm install --registry=https://registry.npm.taobao.org\n              npm run build\n            \"\"\"\n        }\n      }\n    }\n\n    stage('Docker build for creating image') {\n      steps {\n        withCredentials([[$class: 'UsernamePasswordMultiBinding',\n        credentialsId: \"${HARBOR_AUTH}\",\n        usernameVariable: 'Harbor_user',\n        passwordVariable: 'Harbor_password']]) {\n            sh \"\"\"#!/bin/bash\n              set -eux\n\n              docker login -u ${Harbor_user} -p ${Harbor_password} ${HARBOR_ADDRESS}\n              docker build --no-cache -t ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG} .\n              docker push ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG}\n              docker rmi -f ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG}\n              \"\"\"\n        }\n      }\n    }\n\n    stage('Deploying to K8s') {\n      steps {\n           sh \"\"\"#!/bin/bash\n           set -ux\n\n           # set\u66f4\u65b0deployment\u955c\u50cf\n           kubectl set image deploy -l app=${IMAGE_NAME} ${IMAGE_NAME}=${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG} -n $NAMESPACE\n           \"\"\"\n      }\n    }\n  }\n      post {\n        failure {\n            updateGitlabCommitStatus name: \"build\", state: \"failed\"\n        }\n        success {\n            updateGitlabCommitStatus name: \"build\", state: \"success\"\n        }\n    }\n}\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5bf9\u4e8e\u4e0d\u540c\u7684\u9879\u76ee\uff0c\u53ea\u662f\u6784\u5efa\u7684\u955c\u50cf\u548c\u6784\u5efa\u547d\u4ee4\u4e0d\u4e00\u81f4\uff0c\u6574\u4e2a\u6d41\u6c34\u7ebf\u7684\u8fc7\u7a0b\u57fa\u672c\u4e00\u81f4\uff0c\u6240\u4ee5\u5728\u5b9a\u4e49\u4e86\u4e00\u4e2aJenkinsfile\u540e\uff0c\u7a0d\u52a0\u4fee\u6539\u5373\u53ef\u5b9e\u73b0 \u5176\u4ed6\u8bed\u8a00\u7684\u81ea\u52a8\u5316\u6784\u5efa\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#72-\u5b9a\u4e49dockerfile","title":"7.2 \u5b9a\u4e49Dockerfile","text":"<p>\u524d\u7aef\u5e94\u7528\u6784\u5efa\u540e\u4e00\u822c\u4f1a\u5728\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u7684dist\u6587\u4ef6\u4e0b\u4ea7\u751fHTML\u6587\u4ef6\uff0c\u53ea\u9700\u8981\u590d\u5236\u5230nginx\u7684\u6839\u76ee\u5f55\u4e0b\u5373\u53ef\uff1a</p> <p><code>Dockerfile</code></p> <pre><code>FROM registry.cn-beijing.aliyuncs.com/dotbalo/nginx:1.15.12\nCOPY dist/* /usr/share/nginx/html/\n</code></pre> <p>Jenkinsfile\u548cDockerfile\u6587\u4ef6\u6dfb\u52a0\u5230\u4ed3\u5e93\u4ee3\u7801\u540c\u7ea7\u76ee\u5f55\u4e0b\uff0c\u5982\u4e0b\u56fe\u6240\u793a</p> <p>)</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#73-\u5b9a\u4e49kubernetes\u8d44\u6e90","title":"7,3 \u5b9a\u4e49Kubernetes\u8d44\u6e90","text":"<p>\u5bf9\u4e8eKubernetes\u7684\u8d44\u6e90\u4e5f\u662f\u7c7b\u4f3c\u7684\uff0c\u53ea\u9700\u8981\u66f4\u6539\u8d44\u6e90\u540d\u79f0\u548c\u7aef\u53e3\u53f7\u5373\u53ef\uff1a</p> <p><code>deployment.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\ncreationTimestamp: null\nlabels:\napp: vue-project\nname: vue-project\nnamespace: kubernetes\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: vue-project\nstrategy:\nrollingUpdate:\nmaxSurge: 1\nmaxUnavailable: 0\ntype: RollingUpdate\ntemplate:\nmetadata:\ncreationTimestamp: null\nlabels:\napp: vue-project\nspec:\ncontainers:\n- env:\n- name: TZ\nvalue: Asia/Shanghai\n- name: LANG\nvalue: C.UTF-8\nimage: nginx\nimagePullPolicy: IfNotPresent\nlivenessProbe:\nfailureThreshold: 2\ninitialDelaySeconds: 30\nperiodSeconds: 10\nsuccessThreshold: 1\ntcpSocket:\nport: 80\ntimeoutSeconds: 2\nname: vue-project\nports:\n- containerPort: 80\nname: web\nprotocol: TCP\nresources:\nlimits:\ncpu: 994m\nmemory: 1170Mi\nrequests:\ncpu: 10m\nmemory: 55Mi\ndnsPolicy: ClusterFirst\nimagePullSecrets:\n- name: harborkey\nrestartPolicy: Always\nserviceAccountName: default\n</code></pre> <p>\u5b9a\u4e49\u8be5\u5e94\u7528\u7684Service\u548cIngress\uff1a</p> <p><code>vue-project-svc-ingress.yaml</code></p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\nlabels:\napp: vue-project\nname: vue-project\nnamespace: kubernetes\nspec:\nports:\n- name: web\nport: 80\nprotocol: TCP\ntargetPort: 80\nselector:\napp: vue-project\nsessionAffinity: None\ntype: ClusterIP\n---\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\nname: vue-project\nnamespace: kubernetes\nspec:\ningressClassName: nginx\nrules:\n- host: vue-project.test.com\nhttp:\npaths:\n- backend:\nservice:\nname: vue-project\nport: number: 80\npath: /\npathType: ImplementationSpecific\n</code></pre> <p>\u521b\u5efa\u8be5\u8d44\u6e90\uff1a</p> <pre><code># kubectl create -f deployment.yaml\n# kubectl create -f vue-project-svc-ingress.yaml\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#74-\u521b\u5efajenkins-job","title":"7.4 \u521b\u5efaJenkins Job","text":"<p>\u521b\u5efaJenkins Job\u548c\u4e0a\u4e00\u5c0f\u8282\u7c7b\u4f3c\uff0c\u5e76\u65e0\u592a\u5927\u533a\u522b\u3002\u9996\u5148\u521b\u5efaPipeline\u7c7b\u578b\u7684Job\uff0c\u540d\u79f0\u4e3avue-project\uff0c\u540c\u6837\u5728Pipeline\u680f\u586b\u5199\u5730\u5740\u3001Key\u548c\u5206\u652f\uff0c\u5982\u56fe</p> <p>)</p> <p>\u540c\u6837\uff0c\u7b2c\u4e00\u6b21\u6784\u5efa\u4e5f\u4f1a\u5931\u8d25\uff0c\u7b2c\u4e8c\u6b21\u53ef\u4ee5\u9009\u62e9\u5206\u652f\u6784\u5efa.\u5f53\u51fa\u73b0SUCCESS\u65f6\uff0c\u8868\u793a\u6784\u5efa\u7ed3\u675f\u3002</p> <p>)</p> <p>\u63a5\u4e0b\u6765\u53ef\u4ee5\u67e5\u770bDeployment\u7684\u955c\u50cf\uff1a</p> <pre><code># kubectl get deploy vue-project -o yaml -n kubernetes|grep \"image:\"\nimage: hub.gitee.cc/kubernetes/vue-project:jenkins-vue-project-4-9256578\n\n# kubectl get pod -n kubernetes\nNAME                          READY   STATUS    RESTARTS   AGE\nvue-project-f56dcdb95-zwbl5   1/1     Running   0          29m\n</code></pre> <p>\u90e8\u7f72\u66f4\u65b0\u955c\u50cf\u5b8c\u6bd5\u4e4b\u540e\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u8bbf\u95ee\u8be5\u57df\u540d\u3002</p> <p>)</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#75-webhook\u81ea\u52a8\u89e6\u53d1","title":"7.5 Webhook\u81ea\u52a8\u89e6\u53d1","text":"<p>\u540c6.8\u8bbe\u7f6e\u76f8\u540c\u3002\u53c2\u8003\u4e0a\u9762\u8bbe\u7f6e\u5185\u5bb9\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#8-\u81ea\u52a8\u5316\u6784\u5efagolang\u9879\u76ee","title":"8. \u81ea\u52a8\u5316\u6784\u5efaGolang\u9879\u76ee","text":"<p>\u524d\u9762\u6f14\u793a\u4e86Java\u548c\u524d\u7aef\u5e94\u7528\u7684\u81ea\u52a8\u5316\uff0c\u63a5\u4e0b\u6765\u6f14\u793a\u5bf9\u4e8eGolang\u7684\u81ea\u52a8\u5316\u6784\u5efa\uff0c\u672c\u793a\u4f8b\u7684\u4ee3\u7801\u5730\u5740\u4e3ahttps://gitee.com/dukuan/go-project.git\u3002</p> <p>\u53ef\u4ee5\u6309\u7167\u521b\u5efaJava\u6d4b\u8bd5\u7528\u4f8b\u7684\u65b9\u5f0f\u5bfc\u5165\u524d\u7aef\u9879\u76ee\u5230GitLab\u4e2d\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u4f7f\u7528\u516c\u53f8\u81ea\u5df1\u7684\u9879\u76ee\u3002</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#81-\u5b9a\u4e49jenkinsfile","title":"8.1 \u5b9a\u4e49Jenkinsfile","text":"<p>\u5148\u5c06\u955c\u50cf\u4e0a\u4f20\u5230harbor\u79c1\u6709\u4ed3\u5e93</p> <pre><code># docker pull registry.cn-beijing.aliyuncs.com/citools/golang:1.15\n# docker tag registry.cn-beijing.aliyuncs.com/citools/golang:1.15 hub.gitee.cc/kubernetes/golang:1.15\n# docker push hub.gitee.cc/kubernetes/golang:1.15\n</code></pre> <p>\u672c\u793a\u4f8b\u7684Jenkinsfile\u548c\u4e4b\u524d\u7684\u6ca1\u6709\u592a\u5927\u533a\u522b\uff0c\u9700\u8981\u66f4\u6539\u7684\u4f4d\u7f6e\u662f\u6784\u5efa\u5bb9\u5668\u7684\u955c\u50cf\u3001\u7f13\u5b58\u76ee\u5f55\u3001Git\u5730\u5740\u548c\u9879\u76ee\u540d\u79f0\uff1a</p> <pre><code>pipeline{\n    environment {\n        COMMIT_ID = \"\"\n        HARBOR_ADDRESS = \"hub.gitee.cc\"\n        REGISTRY_DIR = \"kubernetes\"\n        IMAGE_NAME = \"go-project\"\n        NAMESPACE = \"kubernetes\"\n        TAG = \"\"\n        GITLAB_AUTH = \"gitlab-auth\"\n        HARBOR_AUTH = \"harbor-user-passwd\"\n    }\n  parameters {\n    gitParameter(branch: '', branchFilter: 'origin/(.*)', defaultValue: 'master', description: 'Branch for build and deploy', name: 'BRANCH', quickFilterEnabled: false, selectedValue: 'NONE', sortMode: 'NONE', tagFilter: '*', type: 'PT_BRANCH')\n  }\n\n    options {\n      parallelsAlwaysFailFast()\n      disableResume()\n      quietPeriod(1)\n      preserveStashes(buildCount: 5)\n      timestamps()\n      buildDiscarder(logRotator(numToKeepStr: '100'))\n      timeout(time: 60, unit: 'MINUTES')\n      gitLabConnection(\"gitlab\")\n    }\n\n    agent {\n        kubernetes {\n            cloud 'kubernetes'\n            slaveConnectTimeout 1200\n            workspaceVolume nfsWorkspaceVolume(serverAddress: \"192.168.1.60\", serverPath: \"/QaTest/jenkins-salve\", readOnly: \"false\")\n            yaml '''\napiVersion: v1\nkind: Pod\nmetadata:\n  name: \"jenkins-slave\"\n  namespace: \"kube-ops\"\n  labels:\n    jenkins: \"slave\"\n    jenkins/label: \"jenkins-jnlp\"\nspec:\n  containers:\n  - name: \"jnlp\"\n    image: \"hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11\"\n    imagePullPolicy: \"IfNotPresent\"\n    tty: true\n    resources:\n      limits:\n        cpu: 1000m\n        memory: 2000Mi\n      requests:\n        cpu: 200m\n        memory: 400Mi\n    env:\n    - name: \"DOCKER_HOST\"\n      value: \"tcp://192.168.1.141:2375\"\n    - name: \"JENKINS_AGENT_WORKDIR\"\n      value: \"/home/jenkins/agent\"\n    volumeMounts:\n    - mountPath: \"/root/.kube/config\"\n      name: \"volume-0\"\n      readOnly: false\n      subPath: \"config\"\n    - name: localtime\n      mountPath: /etc/localtime\n\n    - mountPath: \"/home/jenkins/agent\"\n      name: \"workspace-volume\"\n      readOnly: false\n    workingDir: \"/home/jenkins/agent\"\n\n  - name: \"build\"\n    image: \"hub.gitee.cc/kubernetes/golang:1.15\"\n    imagePullPolicy: \"IfNotPresent\"\n    tty: true\n    volumeMounts:\n      - name: localtime\n        mountPath: /etc/localtime\n      - name:  cachedir\n        mountPath: \"/go/pkg/\"\n        readOnly: false\n    command:\n      - \"cat\"\n    env:\n      - name: \"LANGUAGE\"\n        value: \"en_US:en\"\n      - name: \"LC_ALL\"\n        value: \"en_US.UTF-8\"\n      - name: \"LANG\"\n        value: \"en_US.UTF-8\"\n\n  volumes:\n    - name: localtime\n      hostPath:\n        path: /usr/share/zoneinfo/Asia/Shanghai\n\n    - configMap:\n        name: \"kubeconfig\"\n        optional: false\n      name: \"volume-0\"\n    # \u7f13\u5b58\u76ee\u5f55\n    - name: \"cachedir\"\n      hostPath:\n        path: \"/opt/gopkg\"\n\n    - emptyDir:\n        medium: \"\"\n      name: \"workspace-volume\"\n  restartPolicy: Always\n  hostNetwork: false\n  imagePullSecrets:\n  - name: \"regcred\"\n  # \u56fa\u5b9a\u8282\u70b9\u90e8\u7f72\n  nodeSelector:\n    build: \"true\"\n\n            '''\n        }\n    }\n\n    stages {\n      stage('Pulling Code') {\n        parallel {\n        stage('Pulling Code by Jenkins') {\n          when {\n            expression {\n              env.gitlabBranch == null\n            }\n\n          }\n          steps {\n            git(changelog: true, poll: true, url: 'http://gitlab.runjs.cn:8929/kubernetes/go-project.git', branch: \"${BRANCH}\", credentialsId: \"${GITLAB_AUTH}\")\n            script {\n              COMMIT_ID = sh(returnStdout: true, script: \"git log -n 1 --pretty=format:'%h'\").trim()\n              TAG = BUILD_TAG + '-' + COMMIT_ID\n              println \"Current branch is ${BRANCH}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}\"\n\n            }\n\n          }\n        }\n        stage('Pulling Code by trigger') {\n          when {\n            expression {\n              env.gitlabBranch != null\n            }\n\n          }\n          steps {\n            git(url: 'http://gitlab.runjs.cn:8929/kubernetes/go-project.git', branch: env.gitlabBranch, changelog: true, poll: true, credentialsId: \"${GITLAB_AUTH}\")\n            script {\n              COMMIT_ID = sh(returnStdout: true, script: \"git log -n 1 --pretty=format:'%h'\").trim()\n              TAG = BUILD_TAG + '-' + COMMIT_ID\n              println \"Current branch is ${env.gitlabBranch}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}\"\n              }\n            }\n          }\n        }\n      }\n\n    stage('Building') {\n      steps {\n        container(name: 'build') {\n            sh \"\"\"\n               export GO111MODULE=on\n               go env -w GOPROXY=https://goproxy.cn,direct\n               go build\n            \"\"\"\n        }\n      }\n    }\n\n    stage('Docker build for creating image') {\n      steps {\n        withCredentials([[$class: 'UsernamePasswordMultiBinding',\n        credentialsId: \"${HARBOR_AUTH}\",\n        usernameVariable: 'Harbor_user',\n        passwordVariable: 'Harbor_password']]) {\n            sh \"\"\"#!/bin/bash\n              set -eux\n              docker login -u ${Harbor_user} -p ${Harbor_password} ${HARBOR_ADDRESS}\n\n              docker build --no-cache -t ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG} .\n\n              docker push ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG}\n              docker rmi -f ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG}\n              \"\"\"\n        }\n      }\n    }\n\n    stage('Deploying to K8s') {\n      steps {\n           sh \"\"\"#!/bin/bash\n           set -ux\n           kubectl set image deploy -l app=${IMAGE_NAME} ${IMAGE_NAME}=${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG} -n $NAMESPACE\n           \"\"\"\n      }\n    }\n  }\n    post {\n        failure {\n            updateGitlabCommitStatus name: \"build\", state: \"failed\"\n        }\n        success {\n            updateGitlabCommitStatus name: \"build\", state: \"success\"\n        }\n    }\n}\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#82-\u5b9a\u4e49dockerfile","title":"8.2 \u5b9a\u4e49Dockerfile","text":"<p>\u548c\u4e4b\u524d\u4e0d\u4e00\u6837\u7684\u5730\u65b9\u662f\uff0cGolang\u7f16\u8bd1\u540e\u751f\u6210\u7684\u662f\u4e00\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u53ef\u4ee5\u76f4\u63a5\u6267\u884c\uff0c\u6240\u4ee5\u5e95\u5c42\u955c\u50cf\u8bbe\u7f6e\u4e3aalpine\u6216\u8005\u5176\u4ed6\u7684\u5c0f\u955c\u50cf\u5373\u53ef\uff1a</p> <p><code>Dockerfile</code></p> <pre><code>FROM registry.cn-beijing.aliyuncs.com/dotbalo/alpine-glibc:alpine-3.9\n# \u5982\u679c\u5b9a\u4e49\u4e86\u5355\u72ec\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u53ef\u80fd\u9700\u8981\u62f7\u8d1d\u5230\u955c\u50cf\u4e2d\nCOPY conf/  ./conf # \u5305\u540d\u6309\u7167\u5b9e\u9645\u60c5\u51b5\u8fdb\u884c\u4fee\u6539\nCOPY ./go-project ./ EXPOSE 8080\nENTRYPOINT [ \"./go-project\"] # \u542f\u52a8\u8be5\u5e94\u7528\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#83--\u5b9a\u4e49kubernets\u8d44\u6e90","title":"8.3  \u5b9a\u4e49Kubernets\u8d44\u6e90","text":"<p><code>go-project-deployment.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nlabels:\napp: go-project\nname: go-project\nnamespace: kubernetes\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: go-project\ntemplate:\nmetadata:\nlabels:\napp: go-project\nspec:\ncontainers:\n- env:\n- name: TZ\nvalue: Asia/Shanghai\n- name: LANG\nvalue: C.UTF-8\nimage: nginx\nimagePullPolicy: IfNotPresent\nlivenessProbe:\nfailureThreshold: 2\ninitialDelaySeconds: 30\nperiodSeconds: 10\nsuccessThreshold: 1\ntcpSocket:\nport: 8080\ntimeoutSeconds: 2\nname: go-project\nports:\n- containerPort: 8080\nname: web\nprotocol: TCP\nresources:\nlimits:\ncpu: 994m\nmemory: 1170Mi\nrequests:\ncpu: 10m\nmemory: 55Mi\ndnsPolicy: ClusterFirst\nimagePullSecrets:\n- name: harborkey\nrestartPolicy: Always\nsecurityContext: {}\nserviceAccountName: default\n</code></pre> <p><code>go-project-svc-ingress.yaml</code></p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\nlabels:\napp: go-project\nname: go-project\nnamespace: kubernetes\nspec:\nports:\n- name: web\nport: 8080\nprotocol: TCP\ntargetPort: 8080\nselector:\napp: go-project\ntype: ClusterIP\n---\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\nname: go-project\nnamespace: kubernetes\nspec:\ningressClassName: nginx\nrules:\n- host: go-project.test.com\nhttp:\npaths:\n- backend:\nservice:\nname: go-project\nport: number: 8080\npath: /\npathType: ImplementationSpecific\n</code></pre> <p>\u521b\u5efa\u8be5\u8d44\u6e90\uff1a</p> <pre><code># kubectl apply -f go-project-deployment.yaml\ndeployment.apps/go-project created\n\n# kubectl apply -f go-project-svc-ingress.yaml\nservice/go-project created\ningress.networking.k8s.io/go-project created\n\n# kubectl get pod -n kubernetes\nNAME                          READY   STATUS    RESTARTS      AGE\ngo-project-5b47cfcc8f-rbmm8   1/1     Running   1 (19s ago)   72s\n</code></pre>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#84-\u521b\u5efajenkins-job","title":"8.4 \u521b\u5efaJenkins Job","text":"<p>\u521b\u5efaJenkins Job\u548c\u524d\u9762\u4e5f\u6ca1\u6709\u533a\u522b\uff0c\u5728\u6b64\u4e0d\u518d\u91cd\u590d\u6f14\u793a\u3002</p> <p>\u63a5\u4e0b\u6765\u53ef\u4ee5\u67e5\u770bDeployment\u7684\u955c\u50cf\uff1a</p> <pre><code># kubectl get deployment -o yaml -n kubernetes |grep \"image: \"\nimage: hub.gitee.cc/kubernetes/go-project:jenkins-go-project-2-2cd059f\n\n# kubectl get pod -n kubernetes\nNAME                          READY   STATUS    RESTARTS   AGE\ngo-project-6d8f6bddd6-jd5l7   1/1     Running   0          94s\n</code></pre> <p>\u4e4b\u540e\u5373\u53ef\u8bbf\u95ee\u8be5\u5e94\u7528\uff08\u5982\u679c\u662f\u540e\u7aef\u9879\u76ee\uff0c\u5219\u65e0\u987b\u521b\u5efaIngress\u66b4\u9732\u670d\u52a1\uff09</p> <p>)</p> <p>\u4e4b\u540e\u5728\u521b\u5efaPod\u7684\u8282\u70b9\u53ef\u4ee5\u770b\u5230\u7f13\u5b58\u76ee\u5f55\uff1a</p> <pre><code># cd /opt/gopkg/\n[root@k8s-node01 gopkg]# ll\ntotal 0\ndrwxr-xr-x 7 root root 96 Feb 22 15:49 mod\ndrwxr-xr-x 3 root root 28 Feb 22 15:49 sumdb\n</code></pre> <p>\u7f16\u5199\u4ee3\u7801\uff0c\u66f4\u65b0\u4ee3\u7801\u5230gitlab\u4ed3\u5e93\u4e2d\u3002 )</p> <p>\u91cd\u65b0\u89e6\u53d1jenkins pipeline\u3002 )</p> <p>\u67e5\u770b\u4ee3\u7801\u53d1\u5e03\u66f4\u65b0\u72b6\u6001\u3002 )</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#9-uat\u53ca\u751f\u4ea7\u73af\u5883\u6d41\u6c34\u7ebf\u8bbe\u8ba1","title":"9. UAT\u53ca\u751f\u4ea7\u73af\u5883\u6d41\u6c34\u7ebf\u8bbe\u8ba1","text":"<p>\u4e0a\u8ff0\u6f14\u793a\u793a\u4f8b\u90fd\u5305\u542b\u6784\u5efa\u8fc7\u7a0b\uff0c\u4e00\u822c\u4f1a\u7528\u5728\u9996\u6b21\u63d0\u4ea4\u4ee3\u7801\uff0c\u7136\u540e\u6784\u5efa\uff0c\u5e76\u53d1\u5e03\u81f3\u7b2c\u4e00\u4e2a\u9879\u76ee\u7684\u73af\u5883\u4e2d\uff0c\u4e00\u822c\u662f\u5f00\u53d1\u73af\u5883\u6216\u8005\u6d4b\u8bd5\u73af\u5883\u3002\u8fd9\u7c7b\u73af\u5883\u91c7 \u7528\u8fd9\u79cd\u6a21\u5f0f\u6ca1\u6709\u95ee\u9898\uff0c\u56e0\u4e3a\u6784\u5efa\u548c\u4ea7\u751f\u955c\u50cf\u7684\u6b65\u9aa4\u662f\u5fc5\u9700\u7684\u3002</p> <p>\u4f46\u662f\u5728\u5176\u4ed6\u73af\u5883\uff0c\u6bd4\u5982Sit\u3001UAT\u3001\u751f\u4ea7\u73af\u5883\uff0c\u5176\u5b9e\u662f\u6ca1\u6709\u5fc5\u8981\u91cd\u590d\u6784\u5efa\u7684\uff0c\u53ef\u4ee5\u76f4\u63a5\u9009\u62e9\u955c\u50cf\u8fdb\u884c\u53d1\u7248\uff0c\u5f53\u7136\u8fd9\u79cd\u6a21\u5f0f\u548c\u4ee3\u7801\u672c\u8eab\u7684\u8bbe\u8ba1\u6709\u5173\u7cfb\uff0c \u4e5f\u5c31\u662f\u8981\u505a\u5230\u914d\u7f6e\u5206\u79bb\u548c\u6784\u5efa\u4e0e\u4ee3\u7801\u914d\u7f6e\u65e0\u5173\u624d\u884c\u3002</p> <p>\u5982\u679c\u8bfb\u8005\u7684\u9879\u76ee\u7b26\u5408\u6b64\u7c7b\u6761\u4ef6\uff0c\u53ef\u4ee5\u5c06\u7b2c\u4e00\u6b21\u6784\u5efa\u7684\u955c\u50cf\u53d1\u5e03\u5230\u4efb\u610f\u73af\u5883\uff0c\u53ef\u4ee5\u91c7\u7528\u955c\u50cf\u7684\u65b9\u5f0f\u8fdb\u884c\u53d1\u7248\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u8be5\u6d41\u6c34\u7ebf\u8fdb\u884c\u56de\u6eda\u64cd\u4f5c\u3002</p> <p>\u5047\u5982\u6211\u4eec\u6709\u4e00\u4e2ago-project\u7684UAT\u73af\u5883\uff0c\u8be5\u73af\u5883\u7684\u53d1\u7248\u4e0d\u9700\u8981\u6784\u5efa\uff0c\u53ea\u9700\u8981\u9009\u62e9\u6d4b\u8bd5\u73af\u5883\u7684\u955c\u50cf\u5373\u53ef\uff0c\u6b64\u65f6UAT\u73af\u5883\uff08\u9009\u62e9\u955c\u50cf\u53d1\u7248\uff09\u7684Jenkins Job \u914d\u7f6e\u5982\u4e0b\u3002</p> <p>\u521b\u5efa\u4e00\u4e2a\u65b0\u7684Job\uff0c\u540d\u5b57\u4e3ago-project-uat\uff0c\u7c7b\u578b\u4e3aPipeline\uff0c\u5982\u56fe )</p> <p>\u52fe\u9009\u9875\u9762\u4e0a\u7684This project is parameterized\uff08\u53c2\u6570\u5316\u6784\u5efa\uff09\uff0c\u9009\u62e9\u53c2\u6570\u7c7b\u578b\u4e3aImage Tag Parameter\uff08\u9700\u8981\u5b89\u88c5Image Tag\u63d2\u4ef6\uff09\uff0c\u4e4b\u540e\u5b9a\u4e49Name\u4e3a\u53d8\u91cf\u7684\u540d\u79f0\uff0cImage Name\u4e3aHarbor\u7684\u76ee\u5f55\u548c\u955c\u50cf\u540d\u79f0\uff0c\u5982\u56fe</p> <p>)</p> <p>\u6dfb\u52a0Image Tag\u53c2\u6570 )</p> <p>\u914d\u7f6eHarbor\u5730\u5740 )</p> <p>\u4e4b\u540e\u53ef\u4ee5\u5148\u5355\u51fbSave\uff0c\u7136\u540e\u6d4b\u8bd5\u80fd\u5426\u83b7\u53d6\u5230Tag\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u4fdd\u5b58\u540e\u5355\u51fbBuild with Parameters\u3002 )</p> <p>\u4e4b\u540e\u5355\u51fbConfigure\uff0c\u6dfb\u52a0Pipeline\u811a\u672c\uff1a</p> <pre><code>pipeline{\n    environment {\n        HARBOR_ADDRESS = \"hub.gitee.cc\"\n        NAMESPACE = \"kubernetes\"\n        IMAGE_NAME = \"go-project\"\n        TAG = \"\"\n    }\n\n    options {\n      parallelsAlwaysFailFast()\n      disableResume()\n      quietPeriod(1)\n      preserveStashes(buildCount: 5)\n      timestamps()\n      buildDiscarder(logRotator(numToKeepStr: '100'))\n      timeout(time: 60, unit: 'MINUTES')\n    }\n\n    agent {\n        kubernetes {\n            cloud 'kubernetes'\n            slaveConnectTimeout 1200\n            workspaceVolume nfsWorkspaceVolume(serverAddress: \"192.168.1.60\", serverPath: \"/QaTest/jenkins-salve\", readOnly: \"false\")\n            yaml '''\napiVersion: v1\nkind: Pod\nmetadata:\n  name: \"jenkins-slave\"\n  namespace: \"kube-ops\"\n  labels:\n    jenkins: \"slave\"\n    jenkins/label: \"jenkins-jnlp\"\nspec:\n  containers:\n  - name: \"jnlp\"\n    image: \"hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11\"\n    imagePullPolicy: \"IfNotPresent\"\n    tty: true\n    resources:\n      limits:\n        cpu: 1000m\n        memory: 2000Mi\n      requests:\n        cpu: 200m\n        memory: 400Mi\n    env:\n    - name: \"DOCKER_HOST\"\n      value: \"tcp://192.168.1.141:2375\"\n    - name: \"JENKINS_AGENT_WORKDIR\"\n      value: \"/home/jenkins/agent\"\n    volumeMounts:\n    - mountPath: \"/root/.kube/config\"\n      name: \"volume-0\"\n      readOnly: false\n      subPath: \"config\"\n    - name: localtime\n      mountPath: /etc/localtime\n\n    - mountPath: \"/home/jenkins/agent\"\n      name: \"workspace-volume\"\n      readOnly: false\n    workingDir: \"/home/jenkins/agent\"\n\n  volumes:\n    - name: localtime\n      hostPath:\n        path: /usr/share/zoneinfo/Asia/Shanghai\n\n    - configMap:\n        name: \"kubeconfig\"\n        optional: false\n      name: \"volume-0\"\n\n    - emptyDir:\n        medium: \"\"\n      name: \"workspace-volume\"\n  restartPolicy: Always\n  hostNetwork: false\n  imagePullSecrets:\n  - name: \"regcred\"\n  nodeSelector:\n    build: \"true\"\n            '''\n        }\n    }\n\n    stages {\n        stage('Deploying to K8s') {\n          steps {\n            container(name: 'jnlp') {\n               sh \"\"\"#!/bin/bash\n                   set -ux\n                   # \u8be5\u53d8\u91cf\u5373\u4e3a\u524d\u53f0\u9009\u62e9\u7684\u955c\u50cf\n                   echo ${IMAGE_TAG}\n                   kubectl set image deployment -l app=${IMAGE_NAME} ${IMAGE_NAME}=${HARBOR_ADDRESS}/${IMAGE_TAG} -n ${NAMESPACE}\n                   kubectl get pod  -l app=${IMAGE_NAME} -n ${NAMESPACE}\n                   kubectl get deploy/${IMAGE_NAME} -o yaml  -n ${NAMESPACE}|grep \"image: \"\n               \"\"\"\n          }\n        }\n     }\n  }\n}\n</code></pre> <p>\u4fdd\u5b58\u540e\uff0c\u9009\u62e9\u4e00\u4e2a\u955c\u50cf\uff0c\u5355\u51fbBuild\uff0c\u7ed3\u679c\u5982\u4e0b\u56fe\u6240\u793a\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\u662f\u76f4\u63a5\u5c06\u955c\u50cf\u7248\u672c\u66f4\u65b0\u81f3Kubernetes\uff0c\u5e76\u65e0\u6784\u5efa\u8fc7\u7a0b\uff0c\u53ef\u4ee5\u7701\u4e0b\u5f88\u591a\u65f6\u95f4\u3002\u8be5\u6d41\u6c34\u7ebf\u4e5f\u53ef\u4ee5\u9009\u62e9\u4e4b\u524d\u7684\u7248\u672c\u8fdb\u884c\u56de\u6eda\u64cd\u4f5c\u3002</p> <p>\u67e5\u770b\u90e8\u7f72\u8fc7\u7a0b</p> <p>)</p>"},{"location":"Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/#10-\u5c0f\u7ed3","title":"10. \u5c0f\u7ed3","text":"<p>\u672c\u7ae0\u4e3b\u8981\u6f14\u793a\u4e86Java\u3001Vue\u524d\u7aef\u3001Golang\u7684\u81ea\u52a8\u5316\u6784\u5efa\u914d\u7f6e\uff0c\u6f14\u793a\u4e86\u5bb9\u5668\u5316\u4e1a\u52a1\u90e8\u7f72\u7684\u4e0d\u540c\u65b9\u5f0f\uff0c\u5747\u4f7f\u7528Jenkins\u65b0\u7279\u6027\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u8fdb\u884c\u6301\u7eed\u96c6\u6210\u548c \u6301\u7eed\u90e8\u7f72\uff0c\u5728\u5b9e\u9645\u4f7f\u7528\u65f6\u4e0d\u4e00\u5b9a\u975e\u8981\u4f7f\u7528\u6d41\u6c34\u7ebf\u8fdb\u884c\u6784\u5efa\uff0c\u4e5f\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u4e1a\u52a1\u573a\u666f\u9009\u62e9\u5176\u4ed6\u98ce\u683c\u7684\u6784\u5efa\u65b9\u5f0f\u3002</p> <p>\u901a\u8fc7\u591a\u4e2a\u4f8b\u5b50\u53ef\u4ee5\u770b\u51fa\uff0c\u4f7f\u7528\u6d41\u6c34\u7ebf\u8fdb\u884c\u6784\u5efa\u65f6\uff0c\u5927\u81f4\u6d41\u7a0b\u662f\u7c7b\u4f3c\u7684\uff0c\u4e3b\u8981\u662f\u7f16\u8bd1\u65b9\u5f0f\u3001\u57fa\u7840\u955c\u50cf\u548c\u7f16\u8bd1\u547d\u4ee4\u4e0d\u4e00\u6837\uff0c\u53ef\u4ee5\u6309\u7167\u81ea\u5df1\u7684\u4e1a\u52a1\u573a\u666f\u548c \u9700\u6c42\u8fdb\u884c\u4fee\u6539\u3002</p> <p>\u4e3a\u4e86\u4f7fJenkinsfile\u66f4\u52a0\u7075\u6d3b\u548c\u7edf\u4e00\uff0c\u53ef\u4ee5\u5bf9Jenkinsfile\u5b8c\u5168\u53c2\u6570\u5316\uff0c\u5c06Jenkinsfile\u6240\u6709\u53ef\u53d8\u7684\u8d4b\u503c\u90fd\u6539\u4e3a\u53d8\u91cf\uff0c\u7136\u540e\u5728Jenkins\u4e0a\u914d \u7f6e\u5bf9\u5e94\u7684\u53d8\u91cf\u5373\u53ef\uff0c\u8fd9\u6837\u53ef\u4ee5\u4f7fJenkins\u7684\u6784\u5efa\u53d8\u5f97\u66f4\u52a0\u7075\u6d3b\uff0c\u4e5f\u4f7f\u5f97\u540c\u4e00\u4e2aJenkinsfile\u9002\u7528\u4e8e\u6240\u6709\u7684\u9879\u76ee\u3002</p>"},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/","title":"1.\u7b2c\u4e00\u4e2a Shell \u7a0b\u5e8f","text":""},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#1-shell-\u811a\u672c\u7684\u6784\u6210\u53ca\u89c4\u8303","title":"1. Shell \u811a\u672c\u7684\u6784\u6210\u53ca\u89c4\u8303","text":"<p>Shell \u811a\u672c\u6709\u4e00\u4e9b\u7ea6\u5b9a\u4fd7\u6210\u7684\u89c4\u8303\uff0c\u5927\u5bb6\u90fd\u9075\u5faa\u8fd9\u4e9b\u89c4\u5219\uff0c\u7f16\u5199\u51fa\u6765\u7684\u811a\u672c\u66f4\u80fd\u88ab\u5927\u5bb6\u63a5\u53d7\uff0cShell \u811a\u672c\u5176\u5b9e\u4e0d\u80fd\u79f0\u4e3a\u4e00\u95e8\u7f16\u7a0b\u8bed\u8a00\uff0c\u5b83\u66f4\u50cf\u662f\u4e00\u4e2a\u5de5\u5177\uff0c\u7528\u6765\u6742\u7cc5\u4e0d\u540c\u7684\u7a0b\u5e8f\u53ca\u547d\u4ee4\u4f9b\u6211\u4eec\u8c03\u7528\u6765\u5b8c\u6210\u81ea\u5df1\u7684\u9884\u671f\u64cd\u4f5c\u3002</p>"},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#11-\u547d\u540d\u89c4\u8303","title":"1.1 \u547d\u540d\u89c4\u8303","text":"<ul> <li>Shell \u811a\u672c\u5728\u547d\u540d\u65b9\u9762\u6ca1\u6709\u4e25\u683c\u7684\u8981\u6c42\uff0c\u4f46\u662f\u6211\u4eec\u547d\u540d\u9700\u8981\u9075\u5faa\u89c1\u660e\u77e5\u610f\uff0c\u5373\u53ef\u901a\u8fc7 Shell \u811a\u672c\u7684\u540d\u79f0\u77e5\u9053\u5176\u529f\u80fd\u3002</li> <li>\u6587\u4ef6\u540d\u7ea6\u5b9a\u4fd7\u6210\u4ee5.sh \u7ed3\u5c3e\uff0c\u65b9\u4fbf\u8bc6\u522b\u5176\u4e3a Shell \u811a\u672c\u6587\u4ef6\uff1b</li> <li>\u6587\u4ef6\u7edf\u4e00\u547d\u540d\u98ce\u683c\uff0c\u5199 Shell \u4e00\u822c\u7528\u5c0f\u5199\u5b57\u6bcd\u52a0\u4e0b\u5212\u7ebf\uff0c\u4f8b\u5982 <code>install_mysql.sh</code>, \u6211\u4eec\u770b\u5230\u8be5\u540d\u79f0\u5c31\u80fd\u77e5\u9053\u5176\u4e3a\u4e00\u4e2a\u5b89\u88c5 mysql \u7684\u811a\u672c\u6587\u4ef6\u3002</li> </ul>"},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#12-shell-\u811a\u672c\u7ed3\u6784","title":"1.2 Shell \u811a\u672c\u7ed3\u6784","text":"<p>Shell \u811a\u672c\u5728\u5176\u4e2d\u7684\u7b2c\u4e00\u884c\u9700\u8981\u6709\u6307\u660e\u89e3\u91ca\u5668\uff0c\u5728\u4e0a\u9762 CLI Shell \u4e2d\u7684\u90a3\u4e9b\u89e3\u91ca\u5668\uff0c\u90fd\u53ef\u4ee5\u5199\uff0c\u5728\u4ee5<code>./install_mysql.sh</code> \u7684\u65f6\u5019\uff0c\u6b64\u65f6\u5c31\u662f\u5229\u7528\u811a\u672c\u4e2d\u7b2c\u4e00\u884c\u7684\u89e3\u91ca\u5668\u6765\u8fd0\u884c\u811a\u672c\uff0c\u5176\u683c\u5f0f\u4e3a <code>#!Shell\u89e3\u91ca\u5668</code>\uff0c\u4f8b\u5982<code>#!/bin/bash</code>, \u4f46\u662f\u8fd9\u79cd\u65b9\u5f0f\u5b58\u5728\u4e00\u5b9a\u7684\u5c40\u9650\u6027\uff0c\u6211\u4eec\u63a8\u8350\u4f7f\u7528 env \u73af\u5883\u53d8\u91cf\u4e2d\u7684 bash\uff0c\u63a8\u8350\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f<code>#!/usr/bin/env bash</code>\u3002</p>"},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#13-\u7f16\u7801\u7edf\u4e00","title":"1.3 \u7f16\u7801\u7edf\u4e00","text":"<p>\u5728\u7f16\u5199 Shell \u7684\u65f6\u5019\u6211\u4eec\u5c3d\u53ef\u80fd\u4f7f\u7528 UTF-8 \u7f16\u7801\uff0c\u53ef\u4ee5\u652f\u6301\u4e2d\u6587\u53ca\u5927\u591a\u6570\u7b26\u53f7\uff0c\u5728\u5176\u4e2d\u6211\u4eec\u6ce8\u91ca\u4f7f\u7528\u82f1\u6587\uff0c\u4f8b\u5982\u5728\u4e0d\u652f\u6301\u4e2d\u6587\u7684\u670d\u52a1\u5668\u4e0a\uff0c\u811a\u672c\u66f4\u597d\u7684\u652f\u6301\u3002</p>"},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#14-\u4f5c\u8005\u4fe1\u606f","title":"1.4 \u4f5c\u8005\u4fe1\u606f","text":"<p>\u5728\u7f16\u5199 Shell \u811a\u672c\u7684\u65f6\u5019\uff0c\u6211\u4eec\u5e94\u8be5\u5c3d\u53ef\u80fd\u7684\u6307\u5b9a Shell \u7684\u63cf\u8ff0\u4fe1\u606f\uff0c\u4ee5\u53ca\u8be5\u811a\u672c\u7684\u4f5c\u8005\uff0c\u7f16\u5199\u8be5\u811a\u672c\u7684\u65e5\u671f\u53ca\u8054\u7cfb\u65b9\u5f0f\uff0c\u4ee5\u53ca\u811a\u672c\u7684\u7248\u672c\uff0c\u65b9\u4fbf\u540e\u671f\u5176\u4ed6\u4eba\u9605\u8bfb\u53ca\u8054\u7cfb\u3002 \u4f8b\u5982\u5728\u5934\u90e8\u6dfb\u52a0\u5982\u4e0b\u6ce8\u91ca\u4fe1\u606f\uff1a</p> <pre><code>#!/bin/env bash\n# Description: /mybin/myvim scripts\n# Auth: kaliarch\n# Email: kaliarch@163.com\n# Date: 2020-02-15 13:36\n# Version: 1.0\n</code></pre>"},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#2-shell-\u7684\u8fd0\u884c\u65b9\u5f0f","title":"2. Shell \u7684\u8fd0\u884c\u65b9\u5f0f","text":"<p>\u8fd0\u884c\u811a\u672c\u53ef\u4ee5\u5f52\u7eb3\u4e3a\u4e09\u79cd\u65b9\u5f0f\uff0c\u6ce8\u610f\u4e00\u822c\u5728\u8fd0\u884c\u811a\u672c\u7684\u65f6\u5019\u4e3a\u811a\u672c\u6dfb\u52a0 <code>x</code> \u53ef\u6267\u884c\u6743\u9650</p>"},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#21-\u663e\u5f0f\u5236\u5b9a\u89e3\u91ca\u5668\u6267\u884c","title":"2.1 \u663e\u5f0f\u5236\u5b9a\u89e3\u91ca\u5668\u6267\u884c","text":"<pre><code>[root@shell workspace]# ll\ntotal 4\n-rw-r--r-- 1 root root 44 Sep  3 14:16 01-scripts.sh\n[root@shell workspace]# cat 01-scripts.sh #!/bin/env bash\n# Description: /mybin/myvim scripts\n# Auth: kaliarch\n# Email: kaliarch@163.com\n# Date: 2020-02-15 13:36\n# Version: 1.0\necho \"this is my first script\"\ncd /\n[root@shell workspace]# bash 01-scripts.sh this is my first script\n</code></pre> <p>\u5728\u5f53\u524d bash \u73af\u5883\u4e0b\uff0c\u5f53\u524d\u7ec8\u7aef\u767b\u5f55\u7684 Shell \u4e3a\u7236 Shell\uff0c\u6b64\u79cd\u65b9\u5f0f\u4e3a\u5728\u5f53\u524d Shell \u4e0b\u518d\u542f\u52a8\u4e00\u4e2a\u5b50\u8fdb\u7a0b\u6765\u8fd0\u884c Shell \u811a\u672c\u3002</p> <p>Tips: \u6b64\u65b9\u6cd5\u76f4\u63a5\u5728\u7ec8\u7aef\u6307\u5b9a\u89e3\u91ca\u5668\u6765\u6267\u884c\u811a\u672c\uff0c\u6b64\u65f6\u7684\u89e3\u91ca\u5668\u4e3a\u7ec8\u7aef\u6307\u5b9a\u7684\uff0c\u4e0d\u4f7f\u7528\u811a\u672c\u5185\u7b2c\u4e00\u884c\u6307\u5b9a\u7684\u89e3\u91ca\u5668\u6267\u884c\uff0c\u76f4\u63a5\u6307\u5b9a\u89e3\u91ca\u5668\uff0c\u6b64\u65f6\u4e0d\u9700\u8981\u4e3a\u811a\u672c\u6dfb\u52a0\u53ef\u6267\u884c\u6743\u9650\u3002</p>"},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#22-\u76f4\u63a5\u6307\u5b9a\u811a\u672c\u6587\u4ef6\u540d\u79f0","title":"2.2 \u76f4\u63a5\u6307\u5b9a\u811a\u672c\u6587\u4ef6\u540d\u79f0","text":"<pre><code>[root@shell workspace]# ll\ntotal 4\n-rw-r--r-- 1 root root 44 Sep  3 14:16 01-scripts.sh\n[root@shell workspace]# . ./01-scripts.sh\n-bash: ./01-scripts.sh: Permission denied\n[root@shell workspace]# chmod +x 01-scripts.sh [root@shell workspace]# ll\ntotal 4\n-rwxr-xr-x 1 root root 44 Sep  3 14:16 01-scripts.sh\n[root@shell workspace]# . ./01-scripts.sh this is my first script\n[root@shell workspace]# /workspace/01-scripts.sh this is my first script\n</code></pre> <p>\u5229\u7528\u76f4\u63a5\u5728\u7ec8\u7aef\u6307\u5b9a\u811a\u672c\u6587\u4ef6\u540d\u79f0\u65b9\u5f0f\u6267\u884c\uff0c\u6b64\u79cd\u65b9\u5f0f\u9700\u8981\u4e3a\u811a\u672c\u6dfb\u52a0\u53ef\u6267\u884c\u6743\u9650\uff0c\u5728\u5f53\u524d Shell \u6765\u6267\u884c\uff0c\u4e0d\u542f\u52a8\u5b50 Shell\uff0c\u5229\u7528\u6b64\u79cd\u65b9\u5f0f\u6267\u884c\u811a\u672c\u7684\u89e3\u91ca\u5668\u4e3a\u811a\u672c\u5185\u7684\u7b2c\u4e00\u884c\u6307\u5b9a\u7684\u89e3\u91ca\u5668\uff0c\u4f8b\u5982\u6b64\u4f8b\u4e2d\u4e3a<code>#!/bin/bash</code>\uff0c\u5229\u7528<code>.</code> \u547d\u4ee4\u6765\u6267\u884c\u811a\u672c\uff0c\u4e00\u822c\u7528\u5728\u5f53\u524d\u76ee\u5f55\u6ca1\u6709\u5728 PATH \u4e2d\uff0c\u6240\u4ee5\u7b2c\u4e8c\u4e2a<code>./</code> \u662f\u7528\u6765\u8868\u793a\u5f53\u524d\u76ee\u5f55\u7684\u3002</p>"},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#23-source-\u6267\u884c","title":"2.3 source \u6267\u884c","text":"<pre><code>[root@xuel-transfer workspace]# bash 01-scripts.sh\nthis is my first script\n[root@xuel-transfer workspace]# ./01-scripts.sh\nthis is my first script\n[root@xuel-transfer workspace]# source 01-scripts.sh\nthis is my first script\n[root@xuel-transfer /]# pwd\n/\n</code></pre> <p>\u5229\u7528\u6b64\u79cd\u65b9\u5f0f\u4e5f\u53ef\u6267\u884c\u811a\u672c\uff0c\u6b64\u65b9\u5f0f\u5728\u5f53\u524d\u4e0a\u4e0b\u6587\u4e2d\u6267\u884c\u811a\u672c\uff0c\u4e0d\u4f1a\u751f\u6210\u65b0\u7684\u5b50\u8fdb\u7a0b\u3002\u811a\u672c\u6267\u884c\u5b8c\u6bd5\uff0c\u56de\u5230\u5f53\u524d Shell\uff0c\u811a\u672c\u5185\u5982\u679c\u6709 <code>cd \u547d\u4ee4</code>\u811a\u672c\u9000\u51fa\u540e\u4f1a\u5f71\u54cd\u5f53\u524d\u7684\u73af\u5883\u4e0a\u4e0b\u6587\uff0c\u6b64\u79cd\u65b9\u5f0f\u8fd0\u884c Shell\uff0c\u811a\u672c\u4e5f\u53ef\u4ee5\u6ca1\u6709\u53ef\u6267\u884c\u6743\u9650\u3002</p>"},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#3-\u8c03\u8bd5","title":"3. \u8c03\u8bd5","text":"<p>\u5728\u6211\u4eec\u6267\u884c Shell \u811a\u672c\u7684\u65f6\u5019\u4e3a\u6765\u65b9\u4fbf\u6392\u9664\u5f02\u5e38\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528 <code>-x</code> \u6765\u5f00\u542f\u8c03\u8bd5\uff0c\u4f8b\u5982</p> <pre><code>[root@xuel-transfer workspace]# bash -x 01-scripts.sh\n+ echo 'this is my first script'\nthis is my first script\n+ cd /\n</code></pre> <p>\u901a\u8fc7\u4e0a\u9762\u4f8b\u5b50\u53ef\u4ee5\u770b\u51fa + \u540e\u9762\u4e3a\u811a\u672c\u7684\u5185\u5bb9\uff0c\u6ca1\u6709 + \u7684\u4e3a\u811a\u672c\u6267\u884c\u7684\u8f93\u51fa</p> <p>\u540c\u65f6\u6211\u4eec\u4e3a\u4e86\u65b9\u4fbf\u67e5\u770b\u811a\u672c\u6253\u5370\u6b63\u5728\u6267\u884c\u7684\u547d\u4ee4\uff0c\u53ef\u4ee5\u8fd8\u53ef\u4ee5\u5229\u7528 <code>-v</code> \u53c2\u6570\u3002</p>"},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#4-\u5b9e\u4f8b","title":"4. \u5b9e\u4f8b","text":""},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#41-\u7b2c\u4e00\u4e2a-shell-\u9700\u6c42","title":"4.1 \u7b2c\u4e00\u4e2a Shell \u9700\u6c42","text":"<p>\u5728\u6b64\u6211\u4eec\u4e5f\u4e0d\u5199 <code>Hello Shell</code> \u4e86\uff0c\u4e3e\u4e00\u4e2a\u975e\u5e38\u5b9e\u7528\u7684\u4f8b\u5b50\uff0c\u91cc\u9762\u8bbe\u8ba1\u4e00\u4e9b\u8bed\u6cd5\u5728\u540e\u671f\u7684\u6587\u7ae0\u4e2d\u5927\u5bb6\u90fd\u80fd\u5b66\u5230\uff0c\u53ef\u4ee5\u5148\u6309\u7167\u64cd\u4f5c\u6b65\u9aa4\u5b9e\u73b0\u3002 \u7ecf\u8fc7\u4e0a\u9762\u7684\u5b66\u4e60\uff0c\u6211\u4eec\u77e5\u9053\u6211\u4eec\u5728\u5199 Shell \u811a\u672c\u7684\u65f6\u5019\u9700\u6700\u597d\u5199\u4e00\u4e9b\u4f5c\u8005\u7684\u4fe1\u606f\uff0c\u5982\u679c\u6bcf\u6b21\u7f16\u5199\u90fd\u624b\u52a8\u6dfb\u52a0\u4e00\u6b21\u5c31\u5f88\u9ebb\u70e6\uff0c\u5982\u679c\u662f IDE \u4e00\u822c\u5de5\u5177\u90fd\u53ef\u4ee5\u81ea\u5b9a\u4e49\u914d\u7f6e\u6dfb\u52a0\u9996\u90e8 banner\uff0c\u4f46\u662f\u5728 Linux \u7cfb\u7edf\u5185\u90e8\u7f16\u5199\u7b80\u5355 Shell \u6216\u6587\u672c\uff0c\u6211\u4eec\u53ef\u4ee5\u81ea\u5b9a\u4e49\u5c0f\u5de5\u5177\u6765\u5b9e\u73b0\u3002</p>"},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#42-\u601d\u8def","title":"4.2 \u601d\u8def","text":"<p>\u6211\u4eec\u53ef\u4ee5\u4fee\u6539\u65b0\u589e\u4e00\u4e2a\u811a\u672c\u5c06\u5176\u6dfb\u52a0\u8fdb PATH \u4e2d\uff0c\u5982\u679c\u5229\u7528\u6b64\u547d\u4ee4\u6253\u5f00\u5df2\u5b58\u5728\u7684\u6587\u4ef6\uff0c\u5229\u7528 vim \u76f4\u63a5\u6253\u5f00\uff0c\u4e0d\u5bf9\u539f\u5185\u5bb9\u4f5c\u51fa\u66f4\u6539\uff0c\u5982\u679c\u4e4b\u524d\u6587\u4ef6\u672a\u5b58\u5728\uff0c\u5c31\u5728\u6587\u4ef6\u9996\u90e8\u81ea\u52a8\u6dfb\u52a0 banner \u5e76\u7528 vim \u6253\u5f00\u3002</p>"},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#43-\u5b9e\u73b0","title":"4.3 \u5b9e\u73b0","text":"<ul> <li>\u521b\u5efa\u6587\u4ef6   \u9996\u5148\u521b\u5efa\u4e2a\u6587\u4ef6 myvim</li> <li>\u7f16\u5199\u5185\u5bb9</li> </ul> <pre><code>#!/bin/env bash\n# Description: /mybin/myvim scripts\n# Auth: kaliarch\n# Email: kaliarch@163.com\n# function: auto generate banner\n# Date: 2020-02-15 13:36\n# Version: 1.0\n# file not exist\n[ $# -eq 0 ] &amp;&amp; echo \"$0 [file],At least one parameter!\" &amp;&amp; exit 1\n# add banner\nadd_banner() {\ncat &gt; $1 &lt;&lt; EOF\n#!/bin/env bash\n# Description: $0 scripts\n# Auth: $USER\n# Date: $(date +%F\" \"%H:%M)\n# Version: 1.0\nEOF\n}\n# exist file\nfor file in $*;\ndo\nif [ -f ${file} ];then\nvim ${file} &amp;&amp; exit 0\nelse\ntouch ${file} &amp;&amp; add_banner ${file} &amp;&amp; vim ${file} &amp;&amp; exit 0\nfi\ndone\n</code></pre> <ul> <li>\u6dfb\u52a0\u8fdb PATH \u4e2d</li> </ul> <pre><code>[root@devops-server mybin]# chmod +x myvim     # \u6dfb\u52a0\u53ef\u6267\u884c\u6743\u9650\n[root@devops-server mybin]# echo $PATH\n/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin\n[root@devops-server mybin]# echo \"export PATH=\\$PATH:/mybin\" &gt;&gt; /etc/profile       # \u5c06mybin\u6dfb\u52a0\u8fdbPATH\u4e2d\n[root@devops-server mybin]# source /etc/profile\n[root@devops-server mybin]# echo $PATH\n/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin:/mybin\n</code></pre>"},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#44-\u6548\u679c","title":"4.4 \u6548\u679c","text":"<p>\u5229\u7528 myvim \u6765\u7f16\u8f91\u811a\u672c\u53ef\u4ee5\u81ea\u52a8\u751f\u6210 banner\uff0c\u518d\u6b21\u6253\u5f00\u53ef\u4ee5\u7ee7\u7eed\u7f16\u8f91\uff0c\u8fd9\u6837\u5c31\u514d\u53bb\u6765\u6211\u4eec\u6bcf\u6b21\u624b\u52a8\u7f16\u5199 banner \u7684\u9ebb\u70e6\u3002\u6709\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u8fdb\u884c\u5c1d\u8bd5\uff0c\u662f\u4e0d\u662f\u611f\u89c9 Shell \u53ef\u4ee5\u4e3a\u6211\u4eec\u5e26\u6765\u65e0\u7a77\u7684\u4e50\u8da3\u3002</p>"},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#5-\u6ce8\u610f\u4e8b\u9879","title":"5. \u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u518d\u6b21\u6ce8\u610f\u7f16\u5199 Shell \u9700\u8981\u9075\u5b88\u5176\u89c4\u8303\uff0c\u8fd9\u4e9b\u7ea6\u5b9a\u4fd7\u6210\u7684\u89c4\u5219\u80fd\u5728\u65e5\u540e\u7684\u751f\u4ea7\u73af\u5883\u4e2d\u4e3a\u6211\u4eec\u907f\u514d\u5f88\u591a\u4e0d\u5fc5\u8981\u7684\u5751\u3002</li> <li>\u5b66\u4e60 Shell \u9700\u8981\u591a\u52a8\u624b\u5b9e\u8df5\uff0c\u5b9e\u8df5\u51fa\u771f\u7406\uff0c\u591a\u5199\u52e4\u7ec3\uff0c\u9488\u5bf9\u7ed3\u679c\u591a\u601d\u8003\uff0c\u719f\u7ec3\u8fd0\u7528 man \u6307\u4ee4\u6765\u67e5\u770b Shell \u811a\u672c\u4e2d\u7528\u7684\u7684\u547d\u4ee4\u7684\u53c2\u6570\u53ca\u9009\u9879\u3002</li> <li>\u4e3e\u4e00\u53cd\u4e09\uff0c\u9488\u5bf9\u4e00\u4e2a\u811a\u672c\u5982\u4f55\u80fd\u65e0\u72b6\u6001\uff0c\u66f4\u5065\u58ee\uff0c\u66f4\u7075\u6d3b\u6613\u7ef4\u62a4\uff0c\u9700\u8981\u591a\u6b21\u7684\u4fee\u6539\uff0c\u53cd\u590d\u7684\u6267\u884c\u9a8c\u8bc1\uff0c\u9488\u5bf9\u4e0d\u540c\u7684\u5e94\u7528\u573a\u666f\uff0c\u5c06\u6570\u636e\u62bd\u8c61\u4e3a\u53c2\u6570\u8fdb\u884c\u4f20\u9012\uff0c\u53ef\u4ee5\u8fbe\u5230\u662f\u4e8b\u534a\u529f\u500d\u7684\u6548\u679c\u3002</li> </ul>"},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#6-\u7ecf\u9a8c\u5206\u4eab","title":"6. \u7ecf\u9a8c\u5206\u4eab","text":"<p>\u4f8b\u5982\u4e0a\u9762\u7684\u6211\u7684\u7b2c\u4e00\u4e2a Shell \u811a\u672c\u4f8b\u5b50\uff0c\u518d\u6b21\u53ea\u662f\u629b\u7816\u5f15\u7389\u4f5c\u7528\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4e3e\u4e00\u53cd\u4e09\u601d\u8003\u66f4\u591a\u7684\u7528\u5904\uff0c\u4f8b\u5982\uff0c\u53ef\u4ee5\u83b7\u53d6\u5929\u6c14\uff0c\u5229\u7528\u81ea\u5236\u5c0f\u5de5\u5177\u6765\u8fdb\u884c Shell \u4e0b\u5feb\u901f\u7ffb\u8bd1\u7b49\u3002</p> <p></p>"},{"location":"Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/#7-\u5c0f\u7ed3","title":"7. \u5c0f\u7ed3","text":"<p>\u76ee\u524d Shell \u7684\u5185\u5bb9\u975e\u5e38\u591a\uff0c\u5176\u4f5c\u4e3a\u7528\u6237\u548c\u7cfb\u7edf\u5185\u6838\u7684\u6865\u6881\uff0c\u5176\u529f\u80fd\u5f3a\u5927\u4e0d\u8a00\u800c\u55bb\uff0c\u6211\u4eec\u9700\u8981\u5c06\u6709\u9650\u7684\u7cbe\u529b\u653e\u5728\u70ed\u70b9\u77e5\u8bc6\u4e0a\uff0c\u597d\u94a2\u7528\u5728\u5200\u5203\u4e0a\uff0c\u6ce8\u610f\u5b66\u4e60\u65b9\u6cd5\u5b66\u4f1a\u4e3e\u4e00\u53cd\u4e09\uff0c\u8fd9\u6837\u5728\u540e\u671f\u7684 Shell \u5b66\u4e60\u4e2d\u80fd\u591f\u66f4\u52a0\u7684\u5feb\u901f\u9ad8\u6548\u3002</p>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/","title":"10.Shell\u8f93\u5165/\u8f93\u51fa\u91cd\u5b9a\u5411","text":""},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#1-shell-\u91cd\u5b9a\u5411","title":"1. Shell \u91cd\u5b9a\u5411","text":""},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#11-shell-\u91cd\u5b9a\u5411\u662f\u4ec0\u4e48","title":"1.1 Shell \u91cd\u5b9a\u5411\u662f\u4ec0\u4e48","text":"<p>\u6211\u4eec\u5728\u4e4b\u524d\u7ae0\u8282\u6709\u5b66\u4e60 echo/printf \u6765\u5c06\u6211\u4eec\u7684\u9700\u6c42\u8f93\u51fa\uff0c\u6b64\u65f6\u5c31\u662f\u6211\u4eec\u5c06\u7cfb\u7edf\u7684\u8fd4\u56de\u8f93\u51fa\u5230\u6211\u4eec\u6807\u51c6\u7ec8\u7aef\uff0c\u4f7f\u5f97\u6211\u4eec\u80fd\u591f\u770b\u5230\u6b63\u5e38\u7684\u8f93\u51fa\u7684\u7ed3\u679c\uff0cUnix \u547d\u4ee4\u9ed8\u8ba4\u7684\u8f93\u5165\u8bbe\u5907\u5373 <code>stdin</code> \u4e3a\u952e\u76d8\uff0c\u6807\u51c6\u548c\u9519\u8bef\u8bbe\u5907\u5373 <code>stdout</code> \u4e3a\u663e\u793a\u5668\uff0c\u6211\u4eec\u5229\u7528\u91cd\u5b9a\u5411\u53ef\u4ee5\u5c06\u8f93\u5165\u6539\u4e3a\u6587\u4ef6\uff0c\u6216\u8005\u5c06\u8f93\u51fa\u91cd\u65b0\u5b9a\u5411\u5230\u5176\u4ed6\u8bbe\u5907\u6216\u6587\u4ef6\u4e2d\u3002</p>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#12-\u4e3a\u4ec0\u4e48\u8981\u7528\u91cd\u5b9a\u5411","title":"1.2 \u4e3a\u4ec0\u4e48\u8981\u7528\u91cd\u5b9a\u5411","text":"<p>\u6211\u4eec\u77e5\u9053\u4e86\u7cfb\u7edf\u9ed8\u8ba4\u7684\u8f93\u5165\u4e3a\u952e\u76d8\uff0c\u6807\u51c6\u8f93\u51fa\u4e0e\u9519\u8bef\u8f93\u51fa\u4e3a\u663e\u793a\u5668\uff0c\u5f53\u6211\u4eec\u5728\u7f16\u5199 Shell \u7684\u65f6\u5019\u6709\u4e00\u4e9b\u975e\u4ea4\u4e92\u7684\u64cd\u4f5c\uff0c\u4e0d\u80fd\u901a\u8fc7\u952e\u76d8\u8f93\u5165\uff0c\u6216\u663e\u793a\u7684\u7ed3\u679c\u6211\u4eec\u4e0d\u5e0c\u671b\u5728\u663e\u793a\u5668\u663e\u793a\u7684\u65f6\u5019\uff0c\u6b64\u573a\u666f\u5c31\u9700\u8981\u5229\u7528\u8f93\u5165\u8f93\u51fa\u91cd\u5b9a\u5411\u4e86\u3002</p>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#2-shell-\u8f93\u5165\u8f93\u51fa\u91cd\u5b9a\u5411","title":"2. Shell \u8f93\u5165\u8f93\u51fa\u91cd\u5b9a\u5411","text":"<p>Linux Shell \u91cd\u5b9a\u5411\u5206\u4e3a\u4e24\u79cd\uff0c\u987e\u540d\u601d\u4e49\uff0c\u8f93\u5165\u91cd\u5b9a\u5411\u5373\u6539\u53d8\u6807\u51c6\u7684\u9ed8\u8ba4\u7cfb\u7edf\u952e\u76d8\u8f93\u5165\uff0c\u8f93\u51fa\u91cd\u5b9a\u5411\u5373\u6539\u53d8\u9ed8\u8ba4\u7684\u7cfb\u7edf\u663e\u793a\u5668\u8f93\u51fa\u3002</p>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#21-\u6587\u4ef6\u63cf\u8ff0\u7b26","title":"2.1 \u6587\u4ef6\u63cf\u8ff0\u7b26","text":"<p>\u5728 Linux \u4e2d\u4e00\u5207\u7686\u6587\u4ef6\uff0c\u5305\u62ec\u6807\u51c6\u8f93\u5165\u8bbe\u5907\uff08\u952e\u76d8\uff09\u548c\u6807\u51c6\u8f93\u51fa\u8bbe\u5907\uff08\u663e\u793a\u5668\uff09\u5728\u5185\u7684\u6240\u6709\u8ba1\u7b97\u673a\u786c\u4ef6\u90fd\u662f\u6587\u4ef6\u3002\u4e3a\u4e86\u8868\u793a\u548c\u533a\u5206\u5df2\u7ecf\u6253\u5f00\u7684\u6587\u4ef6\uff0cLinux \u4f1a\u7ed9\u6bcf\u4e2a\u6587\u4ef6\u5206\u914d\u4e00\u4e2a ID\uff0c\u8fd9\u4e2a ID \u5c31\u662f\u4e00\u4e2a\u6574\u6570\uff0c\u88ab\u79f0\u4e3a\u6587\u4ef6\u63cf\u8ff0\u7b26\uff08File Descriptor\uff09\u3002</p> <p>\u5982\u4e0b\u662f\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u7c7b\u578b\u53ca\u5176\u5bf9\u5e94\u7684\u8bbe\u5907\u3002</p> \u6587\u4ef6\u63cf\u8ff0\u7b26 \u6587\u4ef6\u540d \u7c7b\u578b \u786c\u4ef6 0 stdin \u6807\u51c6\u8f93\u5165\u6587\u4ef6 \u952e\u76d8 1 stdout \u6807\u51c6\u8f93\u51fa\u6587\u4ef6 \u663e\u793a\u5668 2 stderr \u6807\u51c6\u9519\u8bef\u8f93\u51fa\u6587\u4ef6 \u663e\u793a\u5668 <p>Linux \u7a0b\u5e8f\u5728\u4f60\u6267\u884c\u4efb\u4f55\u5f62\u5f0f\u7684 I/O \u64cd\u4f5c\u65f6\uff0c\u5176\u5b9e\u90fd\u662f\u5728\u5bf9\u4e00\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\u8fdb\u884c\u8bfb\u53d6\u6216\u5199\u5165\uff0c\u4e00\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\u53ea\u662f\u4e00\u4e2a\u6253\u5f00\u7684\u6587\u4ef6\u76f8\u5173\u8054\u7684\u6574\u6570\uff0c\u5728\u5176\u80cc\u540e\u5c31\u662f\u786c\u76d8\u4e0a\u4e00\u4e2a\u666e\u901a\u6587\u4ef6\u6216\u7ba1\u9053\uff0c\u952e\u76d8\uff0c\u663e\u793a\u5668\uff0c\u6216\u662f\u4e00\u4e2a\u7f51\u7edc\u94fe\u63a5\u7b49\u3002</p> <p></p> <p>\u5982\u56fe\u66f4\u4e3a\u5f62\u8c61\u7684\u5c55\u793a\u952e\u76d8\u662f Linux \u7cfb\u7edf\u9ed8\u8ba4\u6807\u51c6\u8f93\u5165\u8bbe\u5907\uff0c\u5f53\u7136\u53ef\u4ee5\u91cd\u5b9a\u5411\u4e3a file\uff0c\u5bf9\u5e94\u7684\u547d\u4ee4\u6267\u884c\u7684\u6807\u51c6\u8f93\u51fa\u4e0e\u6807\u51c6\u9519\u8bef\u8f93\u51fa\u8bbe\u5907\u4e3a\u5c4f\u5e55\uff0c\u4e5f\u53ef\u4ee5\u6839\u636e\u9700\u6c42\u91cd\u5b9a\u5411\u5230\u6587\u4ef6\u3002</p>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#22-\u8f93\u5165\u91cd\u5b9a\u5411","title":"2.2 \u8f93\u5165\u91cd\u5b9a\u5411","text":"<p>\u8f93\u5165\u65b9\u5411\u4e3a\u6570\u636e\u4ece\u90a3\u6d41\u5165\u7a0b\u5e8f\uff0c\u8f93\u5165\u91cd\u5b9a\u5411\u5373\u6539\u53d8\u9ed8\u8ba4\u7684\u7cfb\u7edf\u952e\u76d8\u8f93\u5165\uff0c\u6539\u53d8\u5176\u4ece\u5176\u4ed6\u5bf9\u65b9\u6d41\u5165\u7a0b\u5e8f\u3002</p>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#221-","title":"2.2.1 &lt;","text":"<p>command &lt;file\uff0c\u5c06 file \u6587\u4ef6\u4e2d\u7684\u5185\u5bb9\u4f5c\u4e3a command \u7684\u8f93\u5165\u3002</p> <p>\u683c\u5f0f\uff1a</p> <pre><code> [n]&lt; word </code></pre> <p>\u6ce8\u610f [n] \u4e0e &lt; \u4e4b\u95f4\u6ca1\u6709\u7a7a\u683c\uff0c\u5176\u4e2d\u5c06\u6587\u4ef6\u63cf\u8ff0\u7b26 n \u91cd\u5b9a\u5411\u5230 word \u6307\u4ee3\u7684\u6587\u4ef6\uff08\u4ee5\u53ea\u8bfb\u65b9\u5f0f\u6253\u5f00), \u5982\u679c\u4e0d\u663e\u793a\u6307\u660e n\uff0c\u9ed8\u8ba4\u5c31\u4e3a 0\uff0c\u6807\u51c6\u8f93\u5165\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@xuel-terraform-cvm-0 ~]# cat testfile.txt\ntest content\n[root@xuel-terraform-cvm-0 ~]# cat 0&lt; testfile.txt\ntest content\n[root@xuel-terraform-cvm-0 ~]# cat &lt; testfile.txt\ntest content\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>testfile.txt</code> \u6587\u4ef6\u5185\u5bb9\u4e3a <code>test content</code>\uff0c\u5728\u8f93\u5165\u91cd\u5b9a\u5411\u65f6\uff0c\u6211\u4eec\u5c06\u6587\u4ef6\u63cf\u8ff0\u7b26 0 \u91cd\u5b9a\u5411\u5230 <code>testfile.txt</code>\uff0c\u6240\u4ee5\u5229\u7528\u547d\u4ee4 cat \u67e5\u770b\uff0c\u7ed3\u679c\u5c31\u4e3a\u6587\u4ef6\u7684\u5185\u5bb9\uff0c\u9ed8\u8ba4\u5c31\u662f\u6807\u51c6\u8f93\u5165\uff0c\u6240\u4ee5\u53ef\u4ee5\u4e0d\u5199 0\u3002</p> <pre><code>[root@xuel-terraform-cvm-0 ~]# 0&lt; testfile.txt cat\ntest content\n[root@xuel-terraform-cvm-0 ~]# &lt; testfile.txt cat\ntest content\n</code></pre> <p>\u89e3\u6790\u5668\u89e3\u6790\u5230 \u201c&lt;\u201d \u4ee5\u540e\u4f1a\u5148\u5904\u7406\u91cd\u5b9a\u5411\uff0c\u5c06\u6807\u51c6\u8f93\u5165\u91cd\u5b9a\u5411\u5230 file\uff0c\u4e4b\u540e cat \u518d\u4ece\u6807\u51c6\u8f93\u5165\u8bfb\u53d6\u6307\u4ee4\u7684\u65f6\u5019\uff0c\u7531\u4e8e\u6807\u51c6\u8f93\u5165\u5df2\u7ecf\u91cd\u5b9a\u5411\u5230\u4e86 file \uff0c\u4e8e\u662f cat \u5c31\u4ece file \u4e2d\u8bfb\u53d6\u6307\u4ee4\u4e86\u3002</p>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#222-eof","title":"2.2.2 &lt;&lt;EOF","text":"<p>command &lt;&lt;END\uff0c\u4ece\u6807\u51c6\u8f93\u5165\uff08\u952e\u76d8\uff09\u4e2d\u8bfb\u53d6\u6570\u636e\uff0c\u76f4\u5230\u9047\u89c1\u5206\u754c\u7b26 END \u624d\u505c\u6b62\uff0c\u5206\u754c\u7b26\u53ef\u4ee5\u662f\u81ea\u5b9a\u4e49\u7684\u4efb\u610f\u5b57\u7b26\uff0c\u5728\u6b64\u5efa\u8bae\u4f7f\u7528 EOF\u3002</p> <p>\u8be5\u8f93\u5165\u91cd\u5b9a\u5411\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7528\u4e8e\u6279\u91cf\u6587\u4ef6\u7684\u8f93\u5165\uff0c\u53ef\u4ee5\u7528\u6b64\u6765\u521b\u5efa\u6587\u4ef6\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@xuel-terraform-cvm-0 ~]# cat &gt; file1.txt &lt;&lt;EOF\n&gt; hello shell\n&gt; hello go\n&gt; test file\n&gt; EOF\n[root@xuel-terraform-cvm-0 ~]# cat file1.txt\nhello shell\nhello go\ntest file\n</code></pre> <p>\u5728\u6b64\u5229\u7528\u4e86\u5c06 cat \u7684\u8f93\u51fa\u91cd\u5b9a\u5411\u5230\u6587\u4ef6 <code>file1.txt</code> \u4e2d\uff0c\u4e4b\u540e\u5229\u7528 &lt;&lt;EOF \u6765\u4ece\u6807\u51c6\u8f93\u5165\u4e2d\u8bfb\u53d6\u6570\u636e\uff0c\u76f4\u5230\u9047\u5230\u7ed3\u675f\u6807\u793a EOF \u505c\u6b62\u3002</p> <p>\u4f8b\u5982\u6211\u4eec\u5728\u5b66\u4e60\u6d41\u7a0b\u63a7\u5236\u4e2d\u7684 while \u5faa\u73af\u8bfb\u53d6\u6587\u4ef6\u5c31\u5229\u7528\u4e86\u8f93\u5165\u91cd\u5b9a\u5411\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@xuel-terraform-cvm-0 ~]# cat while.sh\n#!/bin/bash\nFILE=file1.txt\nwhile read str; do\necho $str\ndone &lt;$FILE\n[root@xuel-terraform-cvm-0 ~]# bash while.sh\nhello shell\nhello go\ntest file\n</code></pre> <p>\u5728\u6b64\u5c06\u6587\u4ef6\u7ed1\u5b9a\u5230\u8f93\u5165\u91cd\u5b9a\u5411\u4e0a\uff0c\u5229\u7528 while \u6765\u9010\u884c\u8bfb\u53d6\u6587\u4ef6\u4e2d\u7684\u5185\u5bb9\u3002</p>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#23-\u8f93\u51fa\u91cd\u5b9a\u5411","title":"2.3 \u8f93\u51fa\u91cd\u5b9a\u5411","text":"<p>\u8f93\u51fa\u65b9\u5411\u4e3a\u6570\u636e\u8f93\u51fa\u5230\u90a3\u4e2a\u7ec8\u7aef\uff0c\u8f93\u51fa\u91cd\u5b9a\u5411\u5373\u6539\u53d8\u9ed8\u8ba4\u7684\u663e\u793a\u5668\u8f93\u51fa\uff0c\u6539\u53d8\u5176\u4ece\u5176\u4ed6\u8bbe\u5907\u8f93\u51fa\u3002</p> <p>\u4e00\u822c\u8f93\u51fa\u91cd\u5b9a\u5411\u7684\u5e94\u7528\u573a\u666f\u591a\u4e3a\u5c06\u6807\u51c6\u8f93\u51fa\u6216\u6807\u51c6\u9519\u8bef\u8f93\u51fa\u5206\u522b\u4fdd\u6301\u5230\u4e0d\u540c\u7684\u6587\u4ef6\uff0c\u6216\u8005\u662f\u6211\u4eec\u4e0d\u5173\u5fc3\u8f93\u51fa\u7b49\u60c5\u51b5\u7b49\u3002</p> <p>\u5982\u4e0b\u6574\u7406\u7684\u6807\u51c6\u8f93\u51fa\u91cd\u5b9a\u5411\u4e0e\u6807\u51c6\u9519\u8bef\u8f93\u51fa\u91cd\u5b9a\u5411\uff1a</p>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#231-\u6807\u51c6\u8f93\u51fa\u91cd\u5b9a\u5411","title":"2.3.1 \u6807\u51c6\u8f93\u51fa\u91cd\u5b9a\u5411","text":"<ul> <li>\u8986\u76d6\u65b9\u5f0f</li> </ul> <p>\u8bed\u6cd5\uff1a<code>command &gt;file</code></p> <p>\u6807\u51c6\u8f93\u5165\u91cd\u5b9a\u5411\u8986\u76d6\u65b9\u5f0f\uff0c\u76f4\u63a5\u5c06 command \u547d\u4ee4\u7684\u6807\u51c6\u8f93\u51fa\uff0c\u4ee5\u8986\u76d6\u65b9\u5f0f\u8f93\u51fa\u5230\u6587\u4ef6\u4e2d\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@xuel-terraform-cvm-0 ~]# cat file1.txt\nhello shell\nhello go\ntest file\n[root@xuel-terraform-cvm-0 ~]# echo \"test\" &gt; file1.txt\n[root@xuel-terraform-cvm-0 ~]# cat file1.txt\ntest\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5c06\u6587\u4ef6\u7684\u539f\u59cb\u5185\u5bb9\u5df2\u7ecf\u8986\u76d6\u6389\u4e86\uff0c\u4e5f\u53ef\u4ee5\u7528\u6765\u6e05\u7a7a\u6587\u4ef6\u5185\u5bb9\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@xuel-terraform-cvm-0 ~]# cat file1.txt\ntest\n[root@xuel-terraform-cvm-0 ~]# &gt;file1.txt\n[root@xuel-terraform-cvm-0 ~]# cat file1.txt\n</code></pre> <ul> <li>\u8ffd\u52a0\u65b9\u5f0f</li> </ul> <p>\u8bed\u6cd5\uff1a<code>command &gt;&gt;file</code></p> <p>\u5c06\u6807\u51c6\u7684\u8f93\u51fa\u8ffd\u52a0\u5230\u6587\u4ef6\u4e2d\uff0c\u6ce8\u610f\u8ffd\u52a0\u4e3a\u4e0d\u8986\u76d6\u539f\u59cb\u6587\u4ef6\u5185\u5bb9\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@xuel-terraform-cvm-0 ~]# cat file1.txt\ntest\n[root@xuel-terraform-cvm-0 ~]# echo \"test222\" &gt;&gt; file1.txt\n[root@xuel-terraform-cvm-0 ~]# cat file1.txt\ntest\ntest222\n</code></pre>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#232-\u9519\u8bef\u8f93\u51fa\u91cd\u5b9a\u5411","title":"2.3.2 \u9519\u8bef\u8f93\u51fa\u91cd\u5b9a\u5411","text":"<ul> <li>\u8986\u76d6\u65b9\u5f0f\uff1a</li> </ul> <p>\u8bed\u6cd5\uff1a<code>command 2&gt;file</code></p> <p>\u4e0e\u6807\u51c6\u8f93\u51fa\u91cd\u5b9a\u5411\u4e00\u6837\uff0c\u53ea\u662f\u7ed1\u5b9a\u6807\u51c6\u9519\u8bef\u8f93\u51fa\u6587\u4ef6\u63cf\u8ff0\u7b26 2\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@xuel-terraform-cvm-0 ~]# ls /none\nls: \u65e0\u6cd5\u8bbf\u95ee/none: \u6ca1\u6709\u90a3\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\n[root@xuel-terraform-cvm-0 ~]# ls /none 2&gt; error.txt\n[root@xuel-terraform-cvm-0 ~]# cat error.txt\nls: \u65e0\u6cd5\u8bbf\u95ee/none: \u6ca1\u6709\u90a3\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>ls</code> \u67e5\u770b\u4e00\u4e2a\u4e0d\u5b58\u5728\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u4f1a\u8f93\u51fa\u6807\u51c6\u9519\u8bef\u8f93\u51fa\uff0c\u5c06\u5176\u91cd\u5b9a\u5411\u5230 error.txt \u4e2d\u3002</p> <ul> <li>\u8ffd\u52a0\u65b9\u5f0f:</li> </ul> <p>\u8bed\u6cd5\uff1a<code>command 2&gt;&gt;file</code></p> <p>\u4e0e\u6807\u51c6\u8f93\u51fa\u8ffd\u52a0\u65b9\u5f0f\u4e00\u6837\uff0c\u53ea\u662f\u7ed1\u5b9a\u6807\u51c6\u9519\u8bef\u8f93\u51fa\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@xuel-terraform-cvm-0 ~]# abc 2&gt;&gt;error.txt\n[root@xuel-terraform-cvm-0 ~]# cat error.txt\nls: \u65e0\u6cd5\u8bbf\u95ee/none: \u6ca1\u6709\u90a3\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\n-bash: abc: command not found\n</code></pre> <p>\u6211\u4eec\u4f7f\u7528\u547d\u4ee4 abc\uff0cShell \u63d0\u793a\u6211\u4eec\u6ca1\u6709\u8fd9\u4e2a\u547d\u4ee4\uff0c\u5728\u6b64\u5c31\u5c06\u6807\u51c6\u9519\u8bef\u8f93\u51fa\u4ee5\u8ffd\u52a0\u5f62\u5f0f\u91cd\u5b9a\u5411\u5230\u6587\u4ef6\u4e2d\u3002</p>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#233-\u5168\u90e8\u91cd\u5b9a\u5411","title":"2.3.3 \u5168\u90e8\u91cd\u5b9a\u5411","text":"<p>\u5728\u6211\u4eec\u4f7f\u7528\u8f93\u51fa\u91cd\u5b9a\u5411\u5206\u4e3a\u6807\u51c6\u8f93\u51fa\u4e0e\u9519\u8bef\u8f93\u51fa\uff0c\u5f53\u6211\u4eec\u5e0c\u671b\u5c06\u4e24\u8005\u90fd\u91cd\u5b9a\u5411\u5230\u67d0\u6587\u4ef6\u4f7f\u7528\u53ef\u4ee5\u4f7f\u7528 <code>&amp;&gt;</code>\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@xuel-terraform-cvm-0 ~]# cat totle.txt\nls: \u65e0\u6cd5\u8bbf\u95ee/none: \u6ca1\u6709\u90a3\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\n/tmp:\ncpulimit-0.2\ncvm_init.log\nnet_affinity.log\nnohup.out\nnv_driver_install.log\nnv_gpu_conf.log\nsetRps.log\nv0.2.tar.gz\nvirtio_blk_affinity.log\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u51fa\u65e0\u8bba\u6807\u51c6\u8f93\u51fa\u6216\u9519\u8bef\u8f93\u51fa\u90fd\u91cd\u5b9a\u5411\u5230\u4e86 <code>totle.txt</code> \u6587\u4ef6\u4e2d\u3002</p>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#24-\u7ec4\u5408\u4f7f\u7528","title":"2.4 \u7ec4\u5408\u4f7f\u7528","text":"<p>\u8f93\u5165\u548c\u8f93\u51fa\u4e5f\u662f\u53ef\u4ee5\u7ec4\u5408\u4f7f\u7528\u7684\uff0c\u90a3\u4e48\u8fd9\u4e2a\u7ec4\u5408\u4e3b\u8981\u5e94\u7528\u4e8e\u5728 Shell \u811a\u672c\u5f53\u4e2d\u4ea7\u751f\u65b0\u7684\u914d\u7f6e\u6587\u4ef6\u7684\u573a\u666f\u4e0b\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@xuel-terraform-cvm-0 ~]# cat &gt; file1.txt &lt;&lt;EOF\n&gt; hello shell\n&gt; hello go\n&gt; test file\n&gt; EOF\n[root@xuel-terraform-cvm-0 ~]# cat file1.txt\nhello shell\nhello go\ntest file\n</code></pre> <p>\u5728\u6b64\u5c31\u7ec4\u5408\u6807\u51c6\u8f93\u51fa\u91cd\u5b9a\u5411\u4e0e\u8f93\u5165\u91cd\u5b9a\u5411\u7ec4\u5408\u4f7f\u7528\u3002</p>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#25-\u7a7a\u8bbe\u5907","title":"2.5 \u7a7a\u8bbe\u5907","text":"<p>\u5728 Linux \u7cfb\u7edf\u4e2d\u5b58\u5728\u4e00\u4e2a\u7a7a\u8bbe\u5907\uff0c\u4e5f\u6210\u4e3a\u9ed1\u6d1e\u8bbe\u5907\uff0c\u5176\u4e3a <code>/dev/null</code>\u3002\u5f53\u6211\u4eec\u5c06\u5185\u5bb9\u91cd\u5b9a\u5411\u5230\u5b83\u65f6\u4f1a\u88ab\u4e22\u5f03\uff0c\u5bf9\u5176\u4e5f\u65e0\u6cd5\u8fdb\u884c\u8bfb\u53d6\u5185\u5bb9\u64cd\u4f5c\uff0c\u5229\u7528\u5b83\uff0c\u53ef\u4ee5\u5728\u6211\u4eec\u7f16\u5199 Shell \u4e2d\u80fd\u591f\u8d77\u5230\u7981\u6b62\u5f02\u5e38\u8f93\u51fa\u7684\u529f\u6548\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@xuel-terraform-cvm-0 ~]# ls / /none\nls: \u65e0\u6cd5\u8bbf\u95ee/none: \u6ca1\u6709\u90a3\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\n/:\nbin  boot  data  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  selinux  srv  sys  tmp  usr  var\n[root@xuel-terraform-cvm-0 ~]# ls / /none &gt;/dev/null 2&gt;&amp;1\n[root@xuel-terraform-cvm-0 ~]# ls / /none &amp;&gt;/dev/null\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u5148\u5c06\u6807\u51c6\u8f93\u51fa\u91cd\u5b9a\u5411\u5230 <code>/dev/null</code>\uff0c\u5bf9\u4e8e\u9519\u8bef\u6807\u51c6\u8f93\u51fa\u5168\u90e8\u53c8\u91cd\u5b9a\u5411\u5230\u6807\u51c6\u8f93\u51fa\uff0c\u4ece\u800c\u8fbe\u5230\u4e86\u5c06\u5168\u90e8\u8f93\u51fa\u7981\u6b62\u6389\u3002</p> <p>\u6216\u8005\u6211\u4eec\u4f7f\u7528 <code>&amp;</code> \u5c06\u6807\u51c6\u8f93\u51fa\u4e0e\u6807\u51c6\u9519\u8bef\u8f93\u51fa\u5168\u90e8\u91cd\u5b9a\u5411\u5230 <code>/dev/null</code>\uff0c\u540c\u6837\u80fd\u8fbe\u5230\u7981\u6b62\u8f93\u51fa\u7684\u6548\u679c\u3002</p>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#3-\u5b9e\u4f8b","title":"3. \u5b9e\u4f8b","text":""},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#31-\u9700\u6c42","title":"3.1 \u9700\u6c42","text":"<p>\u7f16\u5199\u4e00\u4e2a\u811a\u672c\uff0c\u83b7\u53d6 Linux \u7cfb\u7edf\u7684 CPU \u548c\u5185\u5b58\u4fe1\u606f\uff0c\u7136\u540e\u8f93\u51fa\u5230\u6587\u4ef6\u4e2d\u3002</p>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#32-\u601d\u8def","title":"3.2 \u601d\u8def","text":"<p>\u53ef\u4ee5\u5229\u7528\u51fd\u6570\u6765\u5206\u522b\u7f16\u5199 CPU \u548c\u5185\u5b58\u4fe1\u606f\uff0c\u6700\u540e\u5229\u7528\u91cd\u5b9a\u5c06\u4fe1\u606f\u8f93\u51fa\u5230\u6587\u4ef6\u4e2d\u3002</p>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#33-\u5b9e\u73b0","title":"3.3 \u5b9e\u73b0","text":"<pre><code>#!/bin/bash\n# Description: sys check\n# Auth: kaliarch\n# Email: kaliarch@163.com\n# function: sys check\n# Date: 2020-03-29 14:00\n# Version: 1.0\n[ $(id -u) -gt 0 ] &amp;&amp; echo \"\u8bf7\u7528root\u7528\u6237\u6267\u884c\u6b64\u811a\u672c\uff01\" &amp;&amp; exit 1\nsysversion=$(rpm -q centos-release|cut -d- -f3)\nline=\"-------------------------------------------------\"\n[ -d logs ] || mkdir logs\n\nsys_check_file=\"logs/$(ip a show dev eth0|grep -w inet|awk '{print $2}'|awk -F '/' '{print $1}')-`date +%Y%m%d`.txt\"\n# \u83b7\u53d6\u7cfb\u7edfcpu\u4fe1\u606f\nfunction get_cpu_info() {\nPhysical_CPUs=$(grep \"physical id\" /proc/cpuinfo| sort | uniq | wc -l)\nVirt_CPUs=$(grep \"processor\" /proc/cpuinfo | wc -l)\nCPU_Kernels=$(grep \"cores\" /proc/cpuinfo|uniq| awk -F ': ' '{print $2}')\nCPU_Type=$(grep \"model name\" /proc/cpuinfo | awk -F ': ' '{print $2}' | sort | uniq)\nCPU_Arch=$(uname -m)\ncat &lt;&lt;EOF | column -t\nCPU\u4fe1\u606f:\n\u7269\u7406CPU\u4e2a\u6570: $Physical_CPUs\n\u903b\u8f91CPU\u4e2a\u6570: $Virt_CPUs\n\u6bcfCPU\u6838\u5fc3\u6570: $CPU_Kernels\nCPU\u578b\u53f7: $CPU_Type\nCPU\u67b6\u6784: $CPU_Arch\nEOF\n}\n# \u83b7\u53d6\u7cfb\u7edf\u5185\u5b58\u4fe1\u606f\nfunction get_mem_info() {\ncheck_mem=$(free -m)\nMemTotal=$(grep MemTotal /proc/meminfo| awk '{print $2}')  #KB\nMemFree=$(grep MemFree /proc/meminfo| awk '{print $2}')    #KB\nlet MemUsed=MemTotal-MemFree\n    MemPercent=$(awk \"BEGIN {if($MemTotal==0){printf 100}else{printf \\\"%.2f\\\",$MemUsed*100/$MemTotal}}\")\nreport_MemTotal=\"$((MemTotal/1024))\"\"MB\"        #\u5185\u5b58\u603b\u5bb9\u91cf(MB)\nreport_MemFree=\"$((MemFree/1024))\"\"MB\"          #\u5185\u5b58\u5269\u4f59(MB)\nreport_MemUsedPercent=\"$(awk \"BEGIN {if($MemTotal==0){printf 100}else{printf \\\"%.2f\\\",$MemUsed*100/$MemTotal}}\")\"\"%\"   #\u5185\u5b58\u4f7f\u7528\u7387%\ncat &lt;&lt;EOF\n\u5185\u5b58\u4fe1\u606f\uff1a\n${check_mem}\nEOF\n}\n# \u5b9a\u4e49\u4e3b\u51fd\u6570\nfunction sys_check() {\nget_cpu_info\n    echo ${line}\nget_mem_info\n    echo ${line}\n}\n# \u6267\u884c\u4e3b\u51fd\u6570\u5c06\u8f93\u51fa\u91cd\u5b9a\u5411\u5230\u6587\u4ef6\u4e2d\nsys_check &gt; ${sys_check_file}\n# \u6267\u884c\u6d4b\u8bd5\n[root@xuel-terraform-cvm-0 ~]# bash sys_check.sh\n[root@xuel-terraform-cvm-0 ~]# cat logs/10.0.1.15-20200329.txt\nCPU\u4fe1\u606f:\n\u7269\u7406CPU\u4e2a\u6570:  1\n\u903b\u8f91CPU\u4e2a\u6570:  1\n\u6bcfCPU\u6838\u5fc3\u6570:  1\nCPU\u578b\u53f7:      Intel(R)  Xeon(R)  CPU  E5-26xx  v4\nCPU\u67b6\u6784:      x86_64\n-------------------------------------------------\n\u5185\u5b58\u4fe1\u606f\uff1a\n             total       used       free     shared    buffers     cached\nMem:           996        920         76          0        191        600\n-/+ buffers/cache:        127        868\nSwap:            0          0          0\n-------------------------------------------------\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5229\u7528\u4e86\u4e24\u4e2a\u51fd\u6570\u6765\u83b7\u53d6\u7cfb\u7edf\u7684\u4fe1\u606f\uff0c\u5c06\u5176\u5229\u7528\u91cd\u5b9a\u5411\u65b9\u5f0f\u8f93\u51fa\u5230\u6587\u4ef6\u4e2d\u3002</p>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#4-\u6ce8\u610f\u4e8b\u9879","title":"4. \u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u4e00\u6761 shell \u547d\u4ee4\uff0c\u90fd\u4f1a\u7ee7\u627f\u5176\u7236\u8fdb\u7a0b\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u56e0\u6b64\u6240\u6709\u7684 shell \u547d\u4ee4\uff0c\u90fd\u4f1a\u9ed8\u8ba4\u6709\u4e09\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\uff1b</li> <li>\u6587\u4ef6\u6240\u6709\u8f93\u5165\u8f93\u51fa\u90fd\u662f\u7531\u8be5\u8fdb\u7a0b\u6240\u6709\u6253\u5f00\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u63a7\u5236\u7684\uff0cLinux \u4e00\u5207\u7686\u6587\u4ef6\uff0c\u56e0\u6b64\u4ed6\u4eec\u7684\u8f93\u5165\u8f93\u51fa\u4e5f\u662f\u7531\u6587\u4ef6\u63cf\u8ff0\u7b26\u63a7\u5236\uff1b</li> <li>\u5728 <code>&lt;</code>\u4e2d\u5206\u754c\u7b26\u53ef\u4ee5\u662f\u81ea\u5b9a\u4e49\u7684\u4efb\u610f\u5b57\u7b26\uff0c\u5728\u6b64\u5efa\u8bae\u4f7f\u7528 EOF\uff1b</li> <li>\u5728\u8fdb\u884c\u6587\u4ef6\u8ffd\u52a0\u7684\u65f6\u5019\u53ef\u4ee5\u4f7f\u7528\u8ffd\u52a0\u65b9\u5f0f\u91cd\u5b9a\u5411\uff0c\u5207\u8bb0\u64cd\u4f5c\u6587\u4ef6\u524d\u5907\u4efd\u8001\u6587\u4ef6\uff0c\u4ee5\u514d\u6587\u4ef6\u5185\u5bb9\u5f02\u5e38\u3002</li> </ul>"},{"location":"Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/#5-\u5c0f\u7ed3","title":"5. \u5c0f\u7ed3","text":"<p>\u5bf9\u4e8e\u91cd\u5b9a\u5411\u7279\u522b\u9002\u7528\u4e8e\u6587\u4ef6\u7684\u64cd\u4f5c\u6216\u8005\u67d0\u4e9b\u4e0d\u5173\u6ce8\u8f93\u51fa\u7ed3\u679c\u7684\u573a\u666f\uff0c\u5728\u672c\u7ae0\u8282\u9700\u8981\u6ce8\u610f\u8986\u76d6\u5f0f\u4e0e\u8ffd\u52a0\u6a21\u5f0f\u7684\u533a\u522b\uff0c\u7075\u6d3b\u914d\u5408\u7a7a\u8bbe\u5907\u5bf9\u7279\u5b9a\u573a\u666f\u8fdb\u884c\u5e94\u7528\uff0c\u7406\u89e3\u4e09\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u767e\u53d8\u4e0d\u79bb\u5176\u4e2d\u7075\u6d3b\u7ec4\u5408\u4f7f\u7528\u3002</p>"},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/","title":"11.Shell \u6b63\u5219\u8868\u8fbe\u5f0f","text":""},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/#1-shell-\u6b63\u5219\u8868\u8fbe\u5f0f\u6982\u8ff0","title":"1 Shell \u6b63\u5219\u8868\u8fbe\u5f0f\u6982\u8ff0","text":""},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/#11-\u6b63\u5219\u8868\u8fbe\u5f0f\u662f\u4ec0\u4e48","title":"1.1 \u6b63\u5219\u8868\u8fbe\u5f0f\u662f\u4ec0\u4e48","text":"<p>\u6b63\u5219\u8868\u8fbe\u5f0f (regular expression) \u662f\u4e00\u4e9b\u5177\u4f53\u6709\u7279\u6b8a\u542b\u4e49\u7684\u7b26\u53f7\uff0c\u7ec4\u5408\u5728\u4e00\u8d77\u7684\u5171\u540c\u63cf\u8ff0\u5b57\u7b26\u6216\u5b57\u7b26\u4e32\u7684\u65b9\u6cd5\uff0c\u901a\u4fd7\u6765\u8bb2\u6b63\u5219\u4e3a\u63cf\u8ff0\u540c\u4e00\u7c7b\u4e8b\u7269\u7684\u89c4\u5219\uff0c\u4f8b\u5982\u6211\u4eec\u751f\u6d3b\u4e2d\u63cf\u8ff0\u53ef\u4ee5\u98de\u884c\u7684\u662f\u4e8b\u7269\uff0c\u5219\u6ee1\u8db3\u8fd9\u6761\u89c4\u5219\u7684\u53ef\u4ee5\u662f\u9e1f\uff0c\u8774\u8776\uff0c\u4e5f\u53ef\u4ee5\u662f\u98de\u673a\u7b49\u3002</p> <p>\u5728 Linux \u7cfb\u7edf\u4e2d\uff0c\u6b63\u5219\u8868\u8fbe\u5f0f\u901a\u5e38\u7528\u6765\u5bf9\u5b57\u7b26\u6216\u5b57\u7b26\u4e32\u6765\u8fdb\u884c\u5904\u7406\uff0c\u5b83\u662f\u7528\u4e8e\u63cf\u8ff0\u5b57\u7b26\u6392\u5217\u6216\u5339\u914d\u6a21\u5f0f\u7684\u4e00\u79cd\u8bed\u8a00\u89c4\u5219\u3002</p>"},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/#12-\u4e3a\u4ec0\u4e48\u8981\u7528\u6b63\u5219\u8868\u8fbe\u5f0f","title":"1.2 \u4e3a\u4ec0\u4e48\u8981\u7528\u6b63\u5219\u8868\u8fbe\u5f0f","text":"<p>\u6211\u4eec\u77e5\u9053\u6b63\u5219\u8868\u8fbe\u5f0f\u662f\u4e00\u4e2a\u63cf\u8ff0\u5b57\u7b26\u6392\u5217\u6216\u6a21\u5f0f\u5339\u914d\u7684\u89c4\u5219\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u5b83\u6765\u5236\u5b9a\u81ea\u5df1\u7684\u89c4\u5219\uff0c\u83b7\u53d6\u5230\u6211\u4eec\u60f3\u8981\u7684\u7ed3\u679c\u7b49\u3002\u5728\u540e\u7eed\u7684 Shell \u4e09\u5251\u5ba2 grep/awk/sed Shell \u7684\u5b66\u4e60\u4e2d\uff0c\u6211\u4eec\u4f1a\u7ed3\u5408\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0e\u8fd9\u4e9b\u547d\u4ee4\u8fdb\u884c\u7ed3\u5408\u4f7f\u7528\uff0c\u6765\u5b9e\u73b0\u66f4\u5f3a\u5927\u7684\u6587\u672c\u5904\u7406\u529f\u80fd\u3002\u6b63\u5219\u8868\u8fbe\u5f0f\u662f\u6211\u4eec Shell \u5b66\u4e60\u7684\u6838\u5fc3\u4e5f\u662f\u96be\u70b9\uff0c\u5728 Linux \u4e2d\u4e00\u5207\u7686\u6587\u4ef6\uff0c\u591a\u6587\u4ef6\u7684\u5904\u7406\u53ef\u4ee5\u8986\u76d6\u6211\u4eec\u65e5\u5e38\u5de5\u4f5c\u7684 90%\uff0c\u6240\u6709\u719f\u7ec3\u638c\u63e1\u6b63\u5219\u8868\u8fbe\u5f0f\u663e\u5f97\u5c24\u4e3a\u91cd\u8981\uff0c\u5728\u4e4b\u540e\u7075\u6d3b\u914d\u5408\u5176\u4ed6\u547d\u4ee4\u53ef\u4ee5\u975e\u5e38\u65b9\u4fbf\u7684\u6ee1\u8db3\u6211\u4eec\u7684\u65e5\u5e38\u5904\u7406\u9700\u6c42\u3002</p>"},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/#2-shell-\u6b63\u5219\u8868\u8fbe\u64cd\u4f5c","title":"2 Shell \u6b63\u5219\u8868\u8fbe\u64cd\u4f5c","text":"<p>\u5728\u5b66\u4e60\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u64cd\u4f5c\u4e4b\u524d\u6211\u4eec\u9700\u8981\u4e86\u89e3\u4e0b POSIX \u53ca\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u5206\u7c7b\u3002</p>"},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/#21-\u9884\u5907\u77e5\u8bc6","title":"2.1 \u9884\u5907\u77e5\u8bc6","text":""},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/#211-posix","title":"2.1.1 POSIX","text":"<p>POSIX \u79f0\u4e3a\uff1aPortable Operating System Interface\uff08\u672b\u5c3e\u589e\u52a0 X \u53ea\u662f\u4e3a\u4e86\u66f4\u6d41\u7545\uff09\u7684\u7f29\u5199\uff0c\u540e\u6765\u88ab IEEE \u91c7\u7eb3\uff0c\u7531\u4e8e\u5728\u65e9\u671f Unix \u7cfb\u7edf\u65f6\u4ee3\u5404\u5382\u5546\u53d1\u5e03\u4e0d\u540c\u7248\u672c\u7684\u64cd\u4f5c\u7cfb\u7edf\uff0c\u5404\u7248\u672c\u4e4b\u95f4\u5b58\u5728\u7740\u4ea7\u54c1\u7684\u5dee\u5f02\uff0c\u4e4b\u540e IEEE \u53d1\u5e03\u4e86\u4e00\u5957 Unix \u548c\u7c7b Unix \u7cfb\u7edf\u5de5\u4f5c\u65b9\u5f0f\u89c4\u8303\uff0c\u81f3\u6b64\u5404\u5e38\u89c1\u9075\u5faa\u6b64\u89c4\u8303\u6765\u8fbe\u5230\u8f6f\u4ef6\u517c\u5bb9\u7684\u6548\u679c\u3002</p>"},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/#212-\u6b63\u5219\u8868\u8fbe\u5f0f\u5206\u7c7b","title":"2.1.2 \u6b63\u5219\u8868\u8fbe\u5f0f\u5206\u7c7b","text":"<p>\u6b63\u5219\u8868\u8fbe\u5f0f\u5e38\u89c1\u7684\u6709\u4e24\u79cd\u5206\u7c7b\uff1a</p> <ul> <li>\u57fa\u672c\u6b63\u5219\u8868\u8fbe\u5f0f\uff1aBasic Regular Expression \u53c8\u53eb Basic RegEx \u7b80\u79f0 BREs\uff0c\u5728\u57fa\u672c\u6b63\u5219\u8868\u8fbe\u5f0f\u4e2d\u4f5c\u7528\u7684\u5143\u5b57\u7b26\u4e3a\uff1a^ \u3001$\u3001 . \u3001[\u3001] \u3001*\u3002</li> <li>\u6269\u5c55\u6b63\u5219\u8868\u8fbe\u5f0f\uff1aExtended Regular Expression \u53c8\u53eb Extended RegEx \u7b80\u79f0 EREs\uff0c\u5176\u4e3a\u5728\u57fa\u672c\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0a\u65b0\u589e\u4e86 (\u3001) \u3001{ \u3001} \u3001?\u3001 + \u3001\u7b49\u5143\u5b57\u7b26\u5143\u5b57\u7b26\uff0c\u4f7f\u5f97\u6b63\u5219\u8868\u8fbe\u5f0f\u66f4\u52a0\u7b80\u6d01\u6613\u7528\u3002</li> </ul>"},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/#213-\u5b57\u7b26","title":"2.1.3 \u5b57\u7b26","text":"<p>\u5728\u5b66\u4e60\u6b63\u5219\u8868\u8fbe\u5f0f\u524d\u9700\u8981\u5148\u5b66\u4e60\u5b57\u7b26\u3002</p> <ul> <li>POSIX \u5b57\u7b26</li> </ul> <p>\u901a\u7528 POSIX \u539f\u5b57\u7b26\u5165\u4e0b\uff1a</p> <pre><code>[:alnum:] \u5b57\u6bcd\u6570\u5b57[a-z A-Z 0-9]\n[:alpha:]   \u5b57\u6bcd[a-z A-Z]\n[:blank:]   \u7a7a\u683c\u6216\u5236\u8868\u952e\n[:cntrl:] \u4efb\u4f55\u63a7\u5236\u5b57\u7b26\n[:digit:] \u6570\u5b57 [0-9]\n[:graph:] \u4efb\u4f55\u53ef\u89c6\u5b57\u7b26\uff08\u65e0\u7a7a\u683c\uff09\n[:lower:] \u5c0f\u5199 [a-z]\n[:print:] \u975e\u63a7\u5236\u5b57\u7b26 [:punct:] \u6807\u70b9\u5b57\u7b26\n[:space:] \u7a7a\u683c\n[:upper:] \u5927\u5199 [A-Z]\n[:xdigit:] \u5341\u516d\u8fdb\u5236\u6570\u5b57 [0-9 a-f A-F]\n</code></pre> <ul> <li>\u7279\u6b8a\u5b57\u7b26</li> </ul> <p>\u5728\u6269\u5c55\u6b63\u5219\u8868\u8fbe\u5f0f\u4e2d\u52a0\u4e0a <code>\\</code> \u5219\u88ab\u8ba4\u4e3a\u5176\u5177\u6709\u7279\u6b8a\u542b\u4e49\uff1a</p> <pre><code>\\w \u5339\u914d\u4efb\u610f\u6570\u5b57\u548c\u5b57\u6bcd\uff0c\u7b49\u6548[a-zA-Z0-9_]\n\\W \u548c\\w\u76f8\u53cd\uff0c\u7b49\u6548[^a-zA-Z0-9_]\n\\b \u5339\u914d\u5b57\u7b26\u4e32\u5f00\u59cb\u6216\u7ed3\u675f\uff0c\u7b49\u6548\\&lt;\u548c\\&gt;\n\\s \u5339\u914d\u4efb\u610f\u7684\u7a7a\u767d\u5b57\u7b26\n\\S \u5339\u914d\u975e\u7a7a\u767d\u5b57\u7b26\n</code></pre>"},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/#214-\u533a\u522b","title":"2.1.4 \u533a\u522b","text":"<ul> <li>\u57fa\u672c\u6b63\u5219\u8868\u8fbe\u5143\u5b57\u7b26\uff1a\u53ea\u6709 ^$.*\uff1b</li> <li>\u6269\u5c55\u6b63\u5219\u8868\u8fbe\u5f0f\u5143\u5b57\u7b26\uff1a^$.*+(){}?|\uff1b</li> <li>\u6269\u5c55\u6b63\u5219\u8868\u8fbe\u5f0f\u5bf9\u4e8e {m,n} \u548c () \u4e0d\u9700\u8981\u518d\u5411\u57fa\u672c\u6b63\u5219\u8868\u8fbe\u5f0f\u9700\u8981 <code>\\</code> \u6765\u8f6c\u8bd1\u3002</li> </ul>"},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/#22-\u6b63\u5219\u8868\u8fbe\u5f0f\u64cd\u4f5c","title":"2.2 \u6b63\u5219\u8868\u8fbe\u5f0f\u64cd\u4f5c","text":"<p>\u5728 Linux \u4e2d\u6b63\u5219\u8868\u8fbe\u5f0f\u7528\u6765\u5904\u7406\u6587\u672c\uff0c\u5728\u6b64\u6211\u4eec\u4f7f\u7528 grep \u5de5\u5177\u5bf9\u6b63\u5219\u8868\u8fbe\u5f0f\u8fdb\u884c\u64cd\u4f5c\uff0cgrep \u4e3a\u6587\u672c\u8fc7\u6ee4\u5de5\u5177\uff0c\u5728 grep \u547d\u4ee4\u4e2d\u9ed8\u8ba4\u4f7f\u7528\u7684\u65f6\u5019\u57fa\u672c\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u53ef\u4ee5\u4f7f\u7528\u9009\u9879 <code>-E</code> \u6765\u5f00\u542f\u6269\u5c55\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u6309\u7167\u6307\u5b9a\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u53d6\u51fa\u6211\u4eec\u9700\u6c42\u7684\u5185\u5bb9\u3002</p>"},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/#221-\u5b57\u7b26\u5339\u914d","title":"2.2.1 \u5b57\u7b26\u5339\u914d","text":"<p>\u5728\u5b57\u7b26\u5339\u914d\u524d\u9700\u8981\u5148\u5b66\u4e60\u3002</p> <ul> <li><code>.</code>: \u5339\u914d\u4efb\u610f\u5355\u4e2a\u5b57\u7b26\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@master reg]# cat test.txt \nshe\nsh\ns1e\n[root@master reg]# grep \"s.e\" test.txt \nshe\ns1e\n</code></pre> <p><code>.</code> \u5339\u914d\u5fc5\u987b\u4e3a\u5b57\u6bcd s \u4e0e e \u4e2d\u6709\u4efb\u610f\u5355\u4e2a\u5b57\u7b26\u3002</p> <ul> <li></li> </ul> <pre><code>[root@master reg]# cat test.txt she\nsh\ns1e\n[root@master reg]# grep \"s[a-z]e\" test.txt she\n[root@master reg]# grep \"s[1-9]e\" test.txt    s1e\n[root@master reg]# grep \"s[[:alnum:]]e\" test.txt      // \u5339\u914d\u5b57\u7b26\u6216\u6570\u5b57  she\ns1e\n[root@master reg]# grep \"s[[:alpha:]]e\" test.txt    she\n[root@master reg]# grep \"s[[:digit:]]e\" test.txt      s1e\n</code></pre> <p>\u4e2d\u62ec\u53f7\u5185\u53ef\u4ee5\u5229\u7528\u5143\u5b57\u7b26\u6765\u8868\u793a\u3002</p> <ul> <li></li> </ul> <pre><code>[root@master reg]# cat test.txt she\nsh\ns1e\n[root@master reg]# grep \"s[^[:digit:]]e\" test.txt    she\n[root@master reg]# grep \"s[^a-z]e\" test.txt          s1e\n</code></pre> <p>\u5982\u4e0a\uff0c\u5339\u914d\u7684\u5143\u5b57\u7b26\u53d6\u53cd\uff0c\u4e5f\u5c31\u662f\u4e0d\u5305\u542b\u5339\u914d\u7684\u5185\u5bb9\u3002</p>"},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/#222-\u6b21\u6570\u5339\u914d","title":"2.2.2 \u6b21\u6570\u5339\u914d","text":"<p>\u6b21\u6570\u5339\u914d\u7528\u5728\u6307\u5b9a\u7684\u5b57\u7b26\u540e\u9762\uff0c\u8868\u793a\u6307\u5b9a\u5339\u914d\u5230\u524d\u9762\u7684\u5b57\u7b26\u51fa\u73b0\u591a\u5c11\u6b21\u3002</p> <ul> <li><code>*</code>: \u5339\u914d\u524d\u9762\u7684\u5b57\u7b26\u4efb\u610f\u6b21\uff080 \u6b21\u83b7\u65e0\u6570\u6b21\uff09\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@master reg]# cat test2.txt ssssh\nsheee\nhell\n[root@master reg]# grep \"s*\" test2.txt ssssh\nsheee\nhell    </code></pre> <p>\u5982\u4e0a\u5339\u914d\u5b57\u7b26 s\uff0c0 \u6b21\u6216\u591a\u6b21\u3002</p> <ul> <li><code>\\?</code>: \u5339\u914d\u524d\u9762\u7684\u5b57\u7b26 0 \u6b21\u6216 1 \u6b21\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@master reg]# cat test2.txt ssssh\nsheee\nhell\n[root@master reg]# grep \"s\\?h\" test2.txt ssssh                       # \u5339\u914d\u6700\u540e\u7684sh\nsheee                       # \u5339\u914dsh\nhell                        # \u5339\u914dh\n[root@master reg]# grep -E \"s?h\" test2.txt  ssssh\nsheee\nhell\n</code></pre> <p>\u5982\u4e0a\u5339\u914d s \u53ef\u4ee5\u5b58\u5728 0 \u6b21\uff0c\u6216\u8005\u5b58\u5728 1 \u6b21\u4e4b\u540e\u9700\u8981\u6709 h \u5b57\u7b26\uff0c\u6ce8\u610f\u5229\u7528\u9009\u9879 <code>-E</code> \u5f00\u542f\u6269\u5c55\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u76f8\u8f83\u4e0e\u57fa\u672c\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0d\u9700\u8981 <code>\\</code>\u3002</p> <ul> <li><code>+</code>: \u5339\u914d\u524d\u9762\u7684\u5b57\u7b26\u81f3\u5c11 1 \u6b21\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@master reg]# cat test2.txt ssssh\nsheee\nhell\n[root@master reg]# grep \"s\\+h\" test2.txt  ssssh                       # \u5339\u914dssssh\nsheee                       # \u5339\u914dsh\n[root@master reg]# grep -E \"s+h\" test2.txt\nssssh\nsheee\n</code></pre> <p>\u5982\u4e0a\u5339\u914d s \u81f3\u5c11\u5b58\u5728 1 \u6b21\u6216\u65e0\u6570\u6b21\u3002</p> <ul> <li><code>\\{m\\,}</code>: \u5339\u914d\u524d\u9762\u7684\u5b57\u7b26\u81f3\u5c11 m \u6b21\uff08\u9ed8\u8ba4\u5de5\u4f5c\u5728\u8d2a\u5a6a\u6a21\u5f0f\u4e0b\uff0c? \u53d6\u6d88\u8d2a\u5a6a\u6a21\u5f0f\uff09\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@master reg]# cat test2.txt ssssh\nsheee\nhell\n[root@master reg]# grep \"s\\{1,\\}\" test2.txt ssssh\nsheee\n[root@master reg]# grep -E \"s{1,}\" test2.txt   ssssh\nsheee\n[root@master reg]# grep \"s\\{2,\\}\" test2.txt  ssssh\n[root@master reg]# grep -E \"s{2,}\" test2.txt   ssssh\n</code></pre> <p>\u5339\u914d\u5b57\u7b26 s\uff0c\u6700\u5c11 1 \u6b21\u3002</p> <ul> <li><code>\\{,n}</code>: \u5339\u914d\u524d\u9762\u7684\u5b57\u7b26\u6700\u591a n \u6b21\uff08\u9ed8\u8ba4\u5de5\u4f5c\u5728\u8d2a\u5a6a\u6a21\u5f0f\u4e0b\uff0c? \u53d6\u6d88\u8d2a\u5a6a\u6a21\u5f0f\uff09\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@master reg]# cat test2.txt ssssh\nsheee\nhell\n[root@master reg]# grep \"s\\{,2\\}\" test2.txt     ssssh\nsheee\nhell\n[root@master reg]# grep -E \"s{,2}\" test2.txt  ssssh\nsheee\nhell\n</code></pre> <p>\u5339\u914d\u5b57\u7b26 s\uff0c\u6700\u591a 2 \u6b21\u3002</p> <ul> <li><code>\\{m,n\\}</code>: \u5339\u914d\u524d\u9762\u7684\u5b57\u7b26\u81f3\u5c11 m \u6b21\uff0c\u81f3\u591a n \u6b21\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@master reg]# cat test2.txt ssssh\nsheee\nhell\n[root@master reg]# grep \"s\\{1,2\\}\" test2.txt    ssssh\nsheee\n[root@master reg]# grep -E \"s{1,2}\" test2.txt ssssh\nsheee\n</code></pre> <p>\u5339\u914d\u5b57\u7b26 s\uff0c1-2 \u6b21\u4e4b\u95f4\u3002</p> <ul> <li><code>.*</code>: \u5339\u914d\u4efb\u610f\u5b57\u7b26\u4efb\u610f\u6b21\u6570\u3002</li> </ul>"},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/#223-\u4f4d\u7f6e\u94c6\u5b9a","title":"2.2.3 \u4f4d\u7f6e\u94c6\u5b9a","text":"<ul> <li><code>^</code>: \u884c\u9996\u951a\u5b9a\uff0c\u7528\u4e8e\u6a21\u5f0f\u6700\u5de6\u8fb9\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@master reg]# cat test2.txt ssssh\nsheee\nhell\n[root@master reg]# grep \"^s\" test2.txt ssssh\nsheee\n</code></pre> <p>\u5339\u914d\u4ee5 s \u5f00\u5934\u7684\u884c\u3002</p> <ul> <li><code>$</code>: \u884c\u5c3e\u951a\u5b9a\uff0c\u7528\u4e8e\u6a21\u5f0f\u6700\u53f3\u8fb9\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@master reg]# cat test2.txt ssssh\nsheee\nhell\n[root@master reg]# grep \"h$\" test2.txt ssssh\n</code></pre> <p>\u5339\u914d\u4ee5 h \u7ed3\u5c3e\u7684\u884c\u3002</p> <ul> <li><code>\\&lt;</code> \u6216 <code>\\b</code>: \u951a\u5b9a\u8bcd\u9996\uff0c\u7528\u4e8e\u5355\u8bcd\u6a21\u5f0f\u5de6\u4fa7\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@master reg]# cat test2.txt go root user\nroot:shell;gousers\nhellorootgouser\n[root@master reg]# grep \"\\&lt;ro\" test2.txt go root user\nroot:shell;gousers\n[root@master reg]# grep \"\\bro\" test2.txt         go root user\nroot:shell;gousers\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6b64\u523b\u5339\u914d\u662f\u4ee5\u5355\u8bcd\u6a21\u5f0f\uff0c\u6ca1\u6709\u5339\u914d helloroot\u3002</p> <ul> <li><code>\\&gt;</code> \u6216 <code>\\b</code>: \u951a\u5b9a\u8bcd\u5c3e\uff0c\u7528\u4e8e\u5355\u8bcd\u6a21\u5f0f\u53f3\u4fa7\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@master reg]# grep \"gouser\\b\" test2.txt hellorootgouser\n[root@master reg]# grep \"gouser\\&gt;\" test2.txt  hellorootgouser\n</code></pre>"},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/#224-\u5206\u7ec4\u5f15\u7528","title":"2.2.4 \u5206\u7ec4\u5f15\u7528","text":"<ul> <li><code>()</code> \u5206\u7ec4\uff1a\u5c06\u4e00\u4e2a\u6216\u591a\u4e2a\u5b57\u7b26\u5f53\u6210\u4e00\u4e2a\u6574\u4f53\u6765\u8fdb\u884c\u540e\u7eed\u5904\u7406\uff1b</li> <li><code>1\u2026\u6570\u5b57</code>\u5f15\u7528\uff1a\u4ece\u5de6\u4fa7\u8d77\uff0c\u5f15\u7528\u7b2c\u4e00\u4e2a\u5de6\u62ec\u53f7\u4ee5\u53ca\u4e0e\u4e4b\u5339\u914d\u53f3\u62ec\u53f7\u4e4b\u95f4\u7684\u6a21\u5f0f\u6240\u5339\u914d\u5230\u7684\u5b57\u7b26\uff0c\u540e\u5411\u5f15\u7528\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>grep -E \"(root).*\\1\" /etc/passwd\n</code></pre> <p>\u5229\u7528 () \u5c06 root \u5f15\u7528\u8d77\u6765\uff0c\u540e\u9762\u5229\u7528\u6570\u5b57 1 \u5f15\u7528\u3002</p>"},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/#3-\u5b9e\u4f8b","title":"3 \u5b9e\u4f8b","text":"<pre><code>1.\u663e\u793a/etc/init.d/functions\u6587\u4ef6\u4e2d\u4ee5\u5927\u5c0fs\u5f00\u5934\u7684\u884c\ngrep '^[Pp]' /etc/init.d/functions\n\n2.\u663e\u793a/etc/passwd\u6587\u4ef6\u4e2d\u4ee5/bin/bash\u7ed3\u5c3e\u7684\u884c\ngrep \"/bin/bash$\" /etc/passwd\n\n3.\u663e\u793a/etc/passwd\u6587\u4ef6\u4e2dID\u53f7\u6700\u5927\u7528\u6237\u7684\u7528\u6237\u540d\nsort -t: -k3 -n /etc/passwd |tail -1 |cut -d: -f1\n\n4.\u5982\u679croot\u7528\u6237\u5b58\u5728,\u663e\u793a\u5176\u9ed8\u8ba4\u7684shell\u7a0b\u5e8f\nid root &amp;&amp; grep '^\\&lt;root\\&gt;' /etc/passwd |awk -F: '{print $NF}'\n5.\u627e\u51fa/etc/passwd\u4e2d\u7684\u4e24\u4f4d\u6216\u4e09\u4f4d\u6570\ngrep -o \"[0-9]\\{2,3\\}\" /etc/passwd\n\n6.\u663e\u793a/etc/rc.d/rc.sysinit\u6587\u4ef6\u4e2d,\u81f3\u5c11\u4ee5\u4e00\u4e2a\u7a7a\u767d\u5b57\u7b26\u5f00\u5934\u7684\u4e14\u540e\u9762\u5b58\u975e\u7a7a\u767d\u5b57\u7b26\u7684\u884c:\ngrep '^[[:space:]]\\+[^[:space:]]' /etc/rc.d/rc.sysinit\n\n7.\u627e\u51fa\"netstat -tan\"\u547d\u4ee4\u7684\u7ed3\u679c\u4ee5\"LISTEN\"\u540e\u8ddf0,1\u6216\u591a\u4e2a\u7a7a\u767d\u5b57\u7b26\u7ed3\u5c3e\u7684\u884c\nnetstat -tan|grep 'LISTEN[[:space:]]*$'\n8.\u5982\u679croot\u7528\u6237\u767b\u5f55\u4e86\u7cfb\u7edf,\u5c31\u663e\u793aroot\u7528\u6237\u5728\u7ebf,\u5426\u5219\u8bf4\u660e\u672a\u767b\u5f55\nw |grep '^\\&lt;root\\&gt;'&gt;/dev/null &amp;&amp; echo \"root\u5728\u7ebf\"|| echo \"root\u672a\u767b\u5f55\"\n9.\u627e\u51fa/etc/rc.d/init.d/functions\u6587\u4ef6\u4e2d\u67d0\u5355\u8bcd\u540e\u9762\u8ddf\u4e00\u5bf9\u5c0f\u62ec\u53f7\u7684\u884c\ngrep '[[:alpha:]]*()' /etc/rc.d/init.d/functions\n\n10.\u4f7f\u7528echo\u8f93\u51fa\u4e00\u4e2a\u8def\u5f84,\u4f7f\u7528egrep\u53d6\u51fa\u57fa\u540d\necho /tmp/tmp1/vmstat.8.gz |grep -E  -o '[^/]+/?$'|cut -d/ -f1\n\n11.\u5339\u914dPPID\u5f00\u5934\uff0c\u884c\u4e2d\u53c8\u518d\u6b21\u51fa\u73b0PPID\u7684\u5185\u5bb9\u3002/etc/init.d/functions\ngrep -E \"(PPID).*\\1\" /etc/init.d/functions\n\n12.\u5229\u7528awk\u627e\u51fa/etc/ssh/sshd_config\u5185\u51fa\u8fc7\u7a7a\u884c\u4e0e\u4ee5#\u5f00\u5934\u7684\u884c\ngrep -v -E '^#|^$' /etc/ssh/sshd_config\n</code></pre>"},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/#4-\u6ce8\u610f\u4e8b\u9879","title":"4 \u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u6b63\u5219\u8868\u8fbe\u5f0f\u4e2d\u57fa\u672c\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0e\u6269\u5c55\u6b63\u5219\u8868\u8fbe\u5f0f\u914d\u5408\u5176\u5b83\u64cd\u4f5c\uff0c\u80fd\u591f\u5343\u53d8\u4e07\u5316\uff0c\u975e\u5e38\u7075\u6d3b\uff0c\u6839\u636e\u4e0d\u540c\u573a\u666f\u53ef\u4ee5\u8fdb\u884c\u6b63\u5411\u5339\u914d\u548c\u53cd\u5411\u5339\u914d\uff1b</li> <li>\u6b63\u5219\u8868\u8fbe\u5f0f\u914d\u5408\u547d\u4ee4\u901a\u5e38\u4e3a\u4e09\u5251\u5ba2 grep/awk/sed \u7b49\uff0c\u540e\u671f\u7075\u6d3b\u8fdb\u884c\u7ec4\u5408\u8fbe\u5230\u4e8b\u534a\u529f\u500d\u7684\u6548\u679c\uff1b</li> <li>\u6211\u4eec\u5728\u6587\u672c\u6a21\u5f0f\u5339\u914d\u7684\u65f6\u5019\u53ef\u4ee5\u8003\u8651\u4f7f\u7528\u6269\u5c55\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u4ece\u800c\u907f\u514d\u4f7f\u7528\u8fc7\u591a\u7684\u8f6c\u4e49\u5b57\u7b26\u3002</li> </ul>"},{"location":"Linux/shell/11.Shell%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/#5-\u5c0f\u7ed3","title":"5 \u5c0f\u7ed3","text":"<p>\u6b63\u5219\u8868\u8fbe\u5f0f\u53ef\u8c13 Shell \u4e2d\u7684\u7cbe\u534e\uff0c\u5176\u5b9e\u5728\u5176\u4ed6\u8bed\u8a00\u4e2d\u4e5f\u5f88\u901a\u7528\uff0c\u9700\u8981\u8fdb\u884c\u52e4\u52a0\u7ec3\u4e60\u624d\u80fd\u8fbe\u5230\u719f\u7ec3\u638c\u63e1\uff0c\u6ce8\u610f\u533a\u5206\u57fa\u672c\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0e\u6269\u5c55\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u8bed\u6cd5\u533a\u522b\uff0c\u914d\u5408\u5176\u4ed6\u5de5\u5177\u7075\u6d3b\u8fd0\u7528\u3002\u5728\u4e0d\u540c\u573a\u666f\u53ef\u4ee5\u5229\u7528\u547d\u4ee4\u9009\u9879\u914d\u5408\u4f7f\u7528\uff0c\u5728\u540e\u671f Shell \u811a\u672c\u4e09\u5251\u5ba2\u4e2d\u4e5f\u4f1a\u9891\u7e41\u51fa\u73b0\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u653b\u514b\u6b63\u5219\u8868\u8fbe\u5f0f\u8fd9\u4e2a\u96be\u5173\uff0cShell \u811a\u672c\u7f16\u7a0b\u5c31\u5df2\u7ecf\u4e8b\u534a\u529f\u500d\u3002</p> <ol> <li> <p>\u5339\u914d\u6307\u5b9a\u8303\u56f4\u5916\u7684\u4efb\u610f\u5355\u4e2a\u5b57\u7b26\uff0c\u4f8b\u5982\uff1a\u00a0\u21a9</p> </li> </ol>"},{"location":"Linux/shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/","title":"12.Shell \u4e09\u5251\u5ba2\u4e4bgrep","text":""},{"location":"Linux/shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/#1-grep\u6982\u8ff0","title":"1 grep\u6982\u8ff0","text":""},{"location":"Linux/shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/#11-grep\u662f\u4ec0\u4e48","title":"1.1 grep\u662f\u4ec0\u4e48","text":"<p>\u5728\u6211\u4eec\u65e5\u5e38Linux\u8fd0\u7ef4\u8fc7\u7a0b\u4e2d\uff0c\u6700\u591a\u7684\u5c31\u662f\u5bf9Linux\u6587\u4ef6\u8fdb\u884c\u5904\u7406\uff0cgrep\uff08global search regular expression(RE) and print out the line\uff09\u4f5c\u4e3a\u4e00\u6b3e\u975e\u5e38\u65b9\u4fbf\u4e14\u5f3a\u5927\u7684\u6587\u672c\u641c\u7d22\u5de5\u5177\uff0c\u5176\u80fd\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u641c\u7d22\u6587\u672c\uff0c\u5e76\u628a\u5339\u914d\u7684\u884c\u6253\u5370\u51fa\u6765\uff0c\u5176\u4f7f\u7528\u5bf9\u8c61\u4e3aLinux\u7cfb\u7edf\u7684\u6240\u6709\u7528\u6237\uff0c\u4f7f\u5f97\u6211\u4eec\u65e5\u5e38\u64cd\u4f5c\u66f4\u52a0\u65b9\u4fbf\u7b80\u5355\u3002</p>"},{"location":"Linux/shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/#12-\u4e3a\u4ec0\u4e48\u8981\u7528grep","title":"1.2 \u4e3a\u4ec0\u4e48\u8981\u7528grep","text":"<p>\u5728Linux\u7cfb\u7edf\u4e2d\u4e00\u5207\u7686\u6587\u4ef6\uff0c\u6211\u4eec\u65e5\u5e38\u7684\u5de5\u4f5c\u5c31\u662f\u4e0e\u6587\u4ef6\u6253\u4ea4\u9053\uff0c\u80fd\u591f\u8fd0\u7528grep\u8fd9\u6b3e\u6587\u4ef6\u641c\u7d22\u5de5\u5177\uff0c\u53ef\u4ee5\u5927\u5927\u63d0\u4f9b\u6211\u4eec\u7684\u5de5\u4f5c\u6548\u7387\uff0c\u6211\u4eec\u4e0a\u8282\u8bfe\u5b66\u4e60\u4e86\u6b63\u5219\u8868\u8fbe\u5f0f\uff0cgrep\u914d\u5408\u6b63\u5219\u8868\u8fbe\u5f0f\u80fd\u591f\u4f5c\u51fa1+1\u5927\u4e8e2\u7684\u6548\u679c\uff0c\u7075\u6d3b\u4f7f\u7528\u4f7f\u5f97\u6211\u4eec\u7684\u5de5\u4f5c\u66f4\u52a0\u9ad8\u6548\u5feb\u6377\u3002</p>"},{"location":"Linux/shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/#2-grep\u8be6\u89e3","title":"2 grep\u8be6\u89e3","text":""},{"location":"Linux/shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/#21-grep\u5206\u7c7b","title":"2.1 grep\u5206\u7c7b","text":"<p>Unix \u7684 grep \u5bb6\u65cf\u5305\u62ec grep\u3001egrep \u548c fgrep\u3002egrep \u548c fgrep \u7684\u547d\u4ee4\u53ea\u8ddf grep \u6709\u5f88\u5c0f\u4e0d\u540c\u3002</p> <ul> <li>egrep \u662f grep \u7684\u6269\u5c55\uff0c\u5176\u652f\u6301\u66f4\u591a re\u5143\u5b57\u7b26\uff0c\u548c\u6269\u5c55\u6b63\u5219\u8868\u8fbe\u5f0f\u7b49\u3002</li> <li>fgrep \u5c31\u662f fixed grep \u6216 fast grep\uff0c\u5b83\u4eec\u628a\u6240\u6709\u7684\u5b57\u6bcd\u90fd\u770b\u4f5c\u5355\u8bcd\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u6b63\u5219\u8868\u8fbe\u5f0f\u4e2d\u7684\u5143\u5b57\u7b26\u8868\u793a\u5176\u81ea\u8eab\u7684\u5b57\u9762\u610f\u4e49\uff0c\u4e0d\u518d\u7279\u6b8a\u3002</li> <li>linux \u4f7f\u7528 GNU \u7248\u672c\u7684 grep\u3002\u5b83\u529f\u80fd\u66f4\u5f3a\uff0c\u53ef\u4ee5\u901a\u8fc7-G\u3001-E\u3001-F\u547d\u4ee4\u884c\u9009\u9879\u6765\u4f7f\u7528 egrep \u548c fgrep \u7684\u529f\u80fd\u3002</li> </ul>"},{"location":"Linux/shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/#22-grep-\u5de5\u4f5c\u65b9\u5f0f","title":"2.2 grep \u5de5\u4f5c\u65b9\u5f0f","text":"<p>grep \u7684\u5de5\u4f5c\u65b9\u5f0f\u4e3a\u5c06\u4e00\u4e2a\u6216\u591a\u4e2a\u6587\u4ef6\u4e2d\u641c\u7d22\u5b57\u7b26\u4e32\u6a21\u7248\u3002\u5982\u679c\u6a21\u7248\u5305\u62ec\u7a7a\u683c\uff0c\u5219\u5fc5\u987b\u88ab\u5f15\u7528\uff0c\u6a21\u677f\u540e\u7684\u6240\u6709\u5b57\u7b26\u4e32\u88ab\u770b\u4f5c\u6587\u4ef6\u540d\u3002\u641c\u7d22\u7684\u7ed3\u679c\u88ab\u9001\u5230\u5c4f\u5e55\uff0c\u4e0d\u5f71\u54cd\u539f\u6587\u4ef6\u5185\u5bb9\u3002</p> <p>grep \u547d\u4ee4\u7ed3\u675f\u540e\u901a\u8fc7\u4e00\u4e2a\u72b6\u6001\u503c\u6765\u8bf4\u660e\u641c\u7d22\u72b6\u6001\uff0c\u5982\u679c\u4e3a0\u5219\u610f\u5473\u641c\u7d22\u6210\u529f\uff0c\u53cd\u4e4b\u5219\u4e3a\u5931\u8d25\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u5176\u5bf9\u6587\u4ef6\u81ea\u52a8\u5316\u5904\u7406\u3002</p>"},{"location":"Linux/shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/#23-grep-\u8bed\u6cd5","title":"2.3 grep \u8bed\u6cd5","text":"<pre><code>grep [OPTION]... PATTERN [FILE]\n</code></pre> <p>\u5176\u4e2d<code>OPTION</code>\u6709\u5f88\u591a\u65b9\u5f0f\uff0c\u4f8b\u5982-A3\u8868\u793a\u663e\u793a\u7b26\u5408\u8303\u672c\u6837\u5f0f\u7684\u90a3\u4e00\u884c\u4e4b\u5916\uff0c\u5e76\u663e\u793a\u8be5\u884c\u4e4b\u540e\u76843\u884c\u5185\u5bb9\u3002</p> <p><code>PATTERN</code>\u8868\u793a\uff1a\u5339\u914d\u7684\u6a21\u5f0f\uff0c\u901a\u5e38\u4e3a\u4e00\u4e2a\u8868\u8fbe\u5f0f\u3002</p> <p><code>FilE</code>\u4e3a\u5177\u4f53\u7684\u9700\u8981\u5904\u7406\u7684\u95ee\u9898\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u4e3a\u6807\u51c6\u8f93\u5165\u3002</p>"},{"location":"Linux/shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/#23-\u53c2\u6570\u8be6\u89e3","title":"2.3 \u53c2\u6570\u8be6\u89e3","text":"<p>\u5728\u4e0a\u4e00\u8282\u4e2d\u6211\u4eec\u8be6\u7ec6\u8bb2\u89e3\u4e86\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u5b83\u5c31\u53ef\u4ee5\u7528\u5728 grep \u547d\u4ee4\u7684<code>PATTERN</code> \u5b57\u6bb5\u4e2d,\u4f7f\u5f97grep\u66f4\u52a0\u5f3a\u5927\uff0c\u672c\u7ae0\u8282\u6211\u4eec\u7740\u91cd\u6765\u8bb2\u89e3 grep \u547d\u4ee4\u7684<code>OPTION</code>\u3002</p> <p>\u4e0d\u52a0\u53c2\u6570\uff0c\u5339\u914d /etc/passwd \u6587\u4ef6\u4e2d\u7684 root \u884c\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master grep]# grep \"root\" /etc/passwd\nroot:x:0:0:root:/root:/bin/bash\noperator:x:11:0:operator:/root:/sbin/nologin\n</code></pre> <ul> <li>-A\uff1a\u663e\u793a\u6a21\u5f0f\u5339\u914d\u540e\u7684\u51e0\u884c</li> </ul> <p>\u67e5\u627e /etc/passwd \u6587\u4ef6\u4e2d\u4ee5 root \u5f00\u5934\u7684\u540e\u4e24\u884c\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master grep]# grep -A2 \"^root\" /etc/passwd\nroot:x:0:0:root:/root:/bin/bash\nbin:x:1:1:bin:/bin:/sbin/nologin\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\n</code></pre> <ul> <li>-B\uff1a\u663e\u793a\u6a21\u5f0f\u5339\u914d\u884c\u7684\u524d\u51e0\u884c</li> </ul> <p>\u67e5\u627e /etc/passwd \u6587\u4ef6\u4e2d\u4ee5 bin \u5f00\u5934\u7684\u524d\u4e00\u884c\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master grep]# grep -B1 \"^bin\" /etc/passwd\nroot:x:0:0:root:/root:/bin/bash\nbin:x:1:1:bin:/bin:/sbin/nologin\n</code></pre> <ul> <li>-C\uff1a\u663e\u793a\u6a21\u5f0f\u5339\u914d\u7684\u524d\u540e\u5404\u51e0\u884c</li> </ul> <p>\u67e5\u627e /etc/passwd \u6587\u4ef6\u4e2d\u4ee5 ftp \u5f00\u5934\u7684\u524d\u540e\u5404 2 \u884c\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master grep]# grep -C2 \"^ftp\" /etc/passwd     operator:x:11:0:operator:/root:/sbin/nologin\ngames:x:12:100:games:/usr/games:/sbin/nologin\nftp:x:14:50:FTP User:/var/ftp:/sbin/nologin\nnobody:x:99:99:Nobody:/:/sbin/nologin\nsystemd-network:x:192:192:systemd Network Management:/:/sbin/nologin\n</code></pre> <ul> <li>-i\uff1a\u5ffd\u7565\u5927\u5c0f\u5199\u5339\u914d</li> </ul> <p>\u5339\u914d /etc/passwd \u5305\u542b\"Nobody\"\u7684\u884c\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master grep]# grep -i \"Nobody\" /etc/passwd\nnobody:x:99:99:Nobody:/:/sbin/nologin\nnfsnobody:x:65534:65534:Anonymous NFS User:/var/lib/nfs:/sbin/nologin\n</code></pre> <ul> <li>-o \uff1a\u53ea\u663e\u793a\u5339\u914d\u5230\u7684\u5b57\u7b26\u4e32</li> </ul> <p>\u5339\u914d\u51fa /etc/passwd \u6587\u4ef6\u4e2d\u5b57\u7b26\u4e32\u957f\u5ea6\u6700\u5c11 10 \u4f4d\u7684\u5b57\u7b26 \uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master grep]# grep -o \"[[:alnum:]]\\{10,\\}\" /etc/passwd\nManagement\nKubernetes\n</code></pre> <ul> <li>-n\uff1a\u8f93\u51fa\u5339\u914d\u5230\u7684\u884c\u7684\u884c\u53f7</li> </ul> <p>\u5339\u914d\u51fa /etc/passwd \u6587\u4ef6\u4e2d\u5305\u542b root \u7684\u5b57\u7b26\u4e32\u7684\u884c\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master grep]# grep -n \"root\" /etc/passwd\n1:root:x:0:0:root:/root:/bin/bash\n10:operator:x:11:0:operator:/root:/sbin/nologin\n</code></pre> <ul> <li>-v\uff1a\u53cd\u5411\u9009\u62e9\uff0c\u5373\u663e\u793a\u9664\u8fc7 \u5339\u914d'\u641c\u5bfb\u5b57\u7b26\u4e32' \u5185\u5bb9\u7684\u90a3\u4e00\u884c</li> </ul> <p>\u5339\u914d\u51fa /etc/passwd \u4e2d\u4e0d\u5305\u542b bash \u7684\u884c\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master grep]# grep -v \"nologin\" /etc/passwd    root:x:0:0:root:/root:/bin/bash\nsync:x:5:0:sync:/sbin:/bin/sync\nshutdown:x:6:0:shutdown:/sbin:/sbin/shutdown\nhalt:x:7:0:halt:/sbin:/sbin/halt\n</code></pre> <ul> <li>-c :\u8ba1\u7b97\u627e\u5230 '\u641c\u5bfb\u5b57\u7b26\u4e32' \u7684\u6b21\u6570</li> </ul> <p>\u8ba1\u7b97 /etc/passwd \u6587\u4ef6\u4e2d root \u5b57\u7b26\u4e32\u51fa\u73b0\u7684\u6b21\u6570\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master grep]# grep -c \"root\" /etc/passwd\n2\n</code></pre> <ul> <li>-E: \u5f00\u542f\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u76f8\u5f53\u4e8e\u4f7f\u7528\u547d\u4ee4<code>egrep</code></li> </ul> <p>\u67e5\u627e /etc/passwd \u6587\u4ef6\u4e2d\u5305\u542b\u4e09\u4f4d\u6570\u5b57\u7684\u884c\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master grep]# grep -E \"[[:digit:]]{3}\" /etc/passwd\ngames:x:12:100:games:/usr/games:/sbin/nologin\nsystemd-network:x:192:192:systemd Network Management:/:/sbin/nologin\npolkitd:x:999:997:User for polkitd:/:/sbin/nologin\nceph:x:167:167:Ceph daemons:/var/lib/ceph:/sbin/nologin\nkube:x:998:996:Kubernetes user:/home/kube:/sbin/nologin\netcd:x:997:993:Etcd user:/var/lib/etcd:/bin/nologin\ngluster:x:996:992:GlusterFS daemons:/run/gluster:/sbin/nologin\nnfsnobody:x:65534:65534:Anonymous NFS User:/var/lib/nfs:/sbin/nologin\nchrony:x:995:991::/var/lib/chrony:/sbin/nologin\nredis:x:994:990:Redis Database Server:/var/lib/redis:/sbin/nologin\n</code></pre>"},{"location":"Linux/shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/#3-\u5b9e\u4f8b","title":"3 \u5b9e\u4f8b","text":""},{"location":"Linux/shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/#31-\u9700\u6c42","title":"3.1 \u9700\u6c42","text":"<p>\u7f16\u5199\u4e00\u4e2a\u811a\u672c\uff0c\u83b7\u53d6Linux\u7cfb\u7edf\u7684\u670d\u52a1\u4fe1\u606f\uff0c\u5c06\u7ed3\u679c\u4fdd\u5b58\u5230\u6587\u4ef6\u4e2d\u3002</p>"},{"location":"Linux/shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/#32-\u601d\u8def","title":"3.2 \u601d\u8def","text":"<p>\u53ef\u4ee5\u5229\u7528\u51fd\u6570\u6765\u7f16\u5199\u83b7\u53d6Linux\u670d\u52a1\u76f8\u5173\u4fe1\u606f\uff0c\u6700\u540e\u5229\u7528\u91cd\u5b9a\u5411\u5c06\u4fe1\u606f\u8f93\u51fa\u5230\u6587\u4ef6\u4e2d\u3002</p>"},{"location":"Linux/shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/#33-\u5b9e\u73b0","title":"3.3 \u5b9e\u73b0","text":"<pre><code>#!/bin/bash\n# Description: service check\n# Auth: kaliarch\n# Email: kaliarch@163.com\n# function: sys check\n# Date: 2020-04-11 14:00\n# Version: 1.0\n[ $(id -u) -gt 0 ] &amp;&amp; echo \"\u8bf7\u7528root\u7528\u6237\u6267\u884c\u6b64\u811a\u672c\uff01\" &amp;&amp; exit 1\nsysversion=$(rpm -q centos-release|cut -d- -f3)\nline=\"-------------------------------------------------\"\n[ -d logs ] || mkdir logs\nservice_check_file=\"logs/service-`date +%Y%m%d`.txt\"\n# \u83b7\u53d6\u670d\u52a1\u4fe1\u606f\nfunction get_service_info() {\nport_listen=$(netstat -lntup|grep -v \"Active Internet\")\nkernel_config=$(sysctl -p 2&gt;/dev/null)\nif [ ${sysversion} -gt 6 ];then\nservice_config=$(systemctl list-unit-files --type=service --state=enabled|grep \"enabled\")\nrun_service=$(systemctl list-units --type=service --state=running |grep \".service\")\nelse\nservice_config=$(/sbin/chkconfig | grep -E \":on|:\u542f\u7528\" |column -t)\nrun_service=$(/sbin/service --status-all|grep -E \"running\")\nfi\ncat &lt;&lt;EOF\n\u670d\u52a1\u542f\u52a8\u914d\u7f6e:\n${service_config}\n${line}\n\u8fd0\u884c\u7684\u670d\u52a1:\n${run_service}\n${line}\n\u76d1\u542c\u7aef\u53e3:\n${port_listen}\n${line}\n\u5185\u6838\u53c2\u8003\u914d\u7f6e:\n${kernel_config}\nEOF\n}\nfunction sys_check() {\nget_service_info\necho ${line}\n}\n# \u6267\u884c\u4e3b\u51fd\u6570\u5c06\u8f93\u51fa\u91cd\u5b9a\u5411\u5230\u6587\u4ef6\u4e2d\nsys_check &gt; ${sys_check_file}\n# \u6267\u884c\u6d4b\u8bd5\n[root@xuel-terraform-cvm-0 ~]# bash sys_check.sh\n[root@xuel-terraform-cvm-0 ~]# cat logs/10.0.1.15-20200329.txt\n[root@master grep]# cat logs/service-20200411.txt \u670d\u52a1\u542f\u52a8\u914d\u7f6e:\nauditd.service                              enabled\nautovt@.service                             enabled\nceph-mon@.service                           enabled\nceph-osd@.service                           enabled\nchronyd.service                             enabled\ncrond.service                               enabled\ndbus-org.freedesktop.NetworkManager.service enabled\ndbus-org.freedesktop.nm-dispatcher.service  enabled\ndocker.service                              enabled\netcd.service                                enabled\ngapd.service                                enabled\ngetty@.service                              enabled\nirqbalance.service                          enabled\nkdump.service                               enabled\nkubelet.service                             enabled\nmicrocode.service                           enabled\nNetworkManager-dispatcher.service           enabled\nNetworkManager.service                      enabled\npostfix.service                             enabled\nrpcbind.service                             enabled\nrsyslog.service                             enabled\nsmarteye-server-agent.service               enabled\nsshd.service                                enabled\nsystemd-readahead-collect.service           enabled\nsystemd-readahead-drop.service              enabled\nsystemd-readahead-replay.service            enabled\ntuned.service                               enabled\n-------------------------------------------------\n\u8fd0\u884c\u7684\u670d\u52a1:\nauditd.service                loaded active running Security Auditing Service\nceph-mon@master.service       loaded active running Ceph cluster monitor daemon\nceph-osd@0.service            loaded active running Ceph object storage daemon\nchronyd.service               loaded active running NTP client/server\ncrond.service                 loaded active running Command Scheduler\ndbus.service                  loaded active running D-Bus System Message Bus\ndocker.service                loaded active running Docker Application Container Engine\netcd.service                  loaded active running etcd docker wrapper\ngapd.service                  loaded active running guest agent for pitrix\ngetty@tty1.service            loaded active running Getty on tty1\ngssproxy.service              loaded active running GSSAPI Proxy Daemon\nirqbalance.service            loaded active running irqbalance daemon\nkubelet.service               loaded active running Kubernetes Kubelet Server\nNetworkManager.service        loaded active running Network Manager\npolkit.service                loaded active running Authorization Manager\npostfix.service               loaded active running Postfix Mail Transport Agent\nrpcbind.service               loaded active running RPC bind service\nrsyslog.service               loaded active running System Logging Service\nsmarteye-server-agent.service loaded active running The Smarteye Monitoring of server\nsshd.service                  loaded active running OpenSSH server daemon\nsystemd-journald.service      loaded active running Journal Service\nsystemd-logind.service        loaded active running Login Service\nsystemd-udevd.service         loaded active running udev Kernel Device Manager\ntuned.service                 loaded active running Dynamic System Tuning Daemon\n-------------------------------------------------\n\u76d1\u542c\u7aef\u53e3:\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    tcp        0      0 127.0.0.1:9099          0.0.0.0:*               LISTEN      10444/calico-node   tcp        0      0 172.16.60.2:2379        0.0.0.0:*               LISTEN      1321/etcd            tcp6       0      0 :::9353                 :::*                    LISTEN      2058/node-cache     udp        0      0 0.0.0.0:37811           0.0.0.0:*                           610/dhclient        udp        0      0 169.254.25.10:53        0.0.0.0:*                           2058/node-cache     udp        0      0 0.0.0.0:68              0.0.0.0:*                           610/dhclient        udp        0      0 0.0.0.0:111             0.0.0.0:*                           1/systemd           udp        0      0 0.0.0.0:123             0.0.0.0:*                           530/chronyd         udp        0      0 127.0.0.1:323           0.0.0.0:*                           530/chronyd         udp        0      0 0.0.0.0:703             0.0.0.0:*                           535/rpcbind         udp6       0      0 :::35267                :::*                                610/dhclient        udp6       0      0 :::111                  :::*                                1/systemd           udp6       0      0 ::1:323                 :::*                                530/chronyd         udp6       0      0 :::703                  :::*                                535/rpcbind         -------------------------------------------------\n\u5185\u6838\u53c2\u8003\u914d\u7f6e:\nnet.ipv4.ip_forward = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.ipv4.ip_local_reserved_ports = 30000-32767\nnet.bridge.bridge-nf-call-arptables = 1\n-------------------------------------------------\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5229\u7528\u4e86\u4e00\u4e2a\u51fd\u6570\u6765\u83b7\u53d6\u7cfb\u7edf\u7684\u4fe1\u606f\uff0c\u4e3b\u51fd\u6570\u5c06\u8f93\u51fa\u5229\u7528\u91cd\u5b9a\u5411\u65b9\u5f0f\u4fdd\u5b58\u5230\u6587\u4ef6\u4e2d\u3002</p>"},{"location":"Linux/shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/#4-\u6ce8\u610f\u4e8b\u9879","title":"4 \u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>grep\u5bf9\u4e8e\u6587\u4ef6\u641c\u7d22\u6548\u7387\u975e\u5e38\u9ad8\uff0c\u5176\u4e0d\u4f1a\u5bf9\u6e90\u6587\u4ef6\u4f5c\u51fa\u4fee\u6539\uff1b</li> <li>\u9ed8\u8ba4Linux\u7cfb\u7edfgrep\u53ef\u4ee5\u4f7f\u7528\u53c2\u6570-E\uff0c-F\u6765\u4f7f\u7528egrep/fgrep\uff1b</li> <li>\u5bf9\u4e8e\u590d\u6742\u7684\u6761\u4ef6\u53ef\u4ee5\u5229\u7528grep\u914d\u5408\u7ba1\u9053\u591a\u5339\u914d\u6765\u8fbe\u5230\u76ee\u7684\u3002</li> </ul>"},{"location":"Linux/shell/12.Shell%20%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/#5-\u5c0f\u7ed3","title":"5 \u5c0f\u7ed3","text":"<p>grep\u547d\u4ee4\u662fLinux\u7cfb\u7edf\u975e\u5e38\u5f3a\u5927\u7684\u6587\u672c\u641c\u7d22\u5de5\u5177\uff0c\u53ef\u4ee5\u914d\u5408\u6b63\u5219\u8868\u8fbe\u5f0f\u53ca\u5176\u4e30\u5bcc\u7684\u9009\u9879\u6765\u7075\u6d3b\u5904\u7406\uff0c\u540c\u65f6\u5bf9\u4e8e\u590d\u6742\u7684\u6587\u4ef6\u641c\u7d22\uff0c\u53ef\u4ee5\u914d\u5408\u7ba1\u9053\u591a\u6b21\u5339\u914d\u6765\u8fbe\u5230\u641c\u7d22\u7684\u76ee\u7684\uff0c\u7279\u6b8a\u60c5\u51b5\u4e0b\u53ef\u4ee5\u5229\u7528\u9009\u9879-E\uff0c\u5f00\u542f\u6b63\u5219\u8868\u8fbe\u5f0f\u6765\u63d0\u4f9b\u5f3a\u5927\u7684\u6a21\u5f0f\u5339\u914d\u5904\u7406\u3002</p>"},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/","title":"13.Shell\u4e09\u5251\u5ba2\u4e4bsed","text":""},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#1-sed\u6982\u8ff0","title":"1 Sed\u6982\u8ff0","text":""},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#11-sed\u662f\u4ec0\u4e48","title":"1.1 Sed\u662f\u4ec0\u4e48","text":"<p>Sed\u5168\u540d\u4e3aStream EDitor\uff0c\u987e\u540d\u601d\u4e49\u662f\u5bf9\u6570\u636e\u6d41\u8fdb\u884c\u7f16\u8f91\u64cd\u4f5c\u7684\u4e00\u4e2a\u547d\u4ee4\uff0c\u5b83\u80fd\u591f\u904d\u5386\u6587\u4ef6\u6216\u6587\u4ef6\u6d41\uff0c\u5bf9\u8bfb\u5165\u7684\u8f93\u5165\u6d41\u53ef\u4ee5\u5c06\u5176\u5148\u5b58\u50a8\u5728\u6a21\u5f0f\u7a7a\u95f4\u4e2d\uff0c\u5e76\u5c06\u884c\u53f7\u8bb0\u5f55\u5728\u5185\u5b58\u4e2d\uff0c\u5229\u7528\u6a21\u5f0f\u7a7a\u95f4\u4e2d\u7684\u4e00\u7cfb\u5217\u6307\u5b9a\u547d\u4ee4\u5bf9\u5176\u8fdb\u884c\u64cd\u4f5c\uff0c\u5f85\u64cd\u4f5c\u5b8c\u6210\u540e\u4ece\u6a21\u5f0f\u7a7a\u95f4\u8f93\u51fa\u5230stdout\uff0c\u7c7b\u4f3c\u4e8e\u5728\u4e00\u4e2a\u7ba1\u9053\u5728\u5176\u4e2d\u5bf9\u6570\u636e\u8fdb\u884c\u52a0\u5de5\uff0c\u5b8c\u6210\u540e\u4ece\u53e6\u4e00\u5934\u8f93\u51fa\uff0c\u63a5\u7740\u8bfb\u53d6\u4e0b\u4e00\u884c\uff0c\u91cd\u590d\u5f80\u8fd4\uff0c\u76f4\u81f3\u5c06\u6240\u6709\u6807\u51c6\u8f93\u5165\u8bfb\u53d6\u5904\u7406\u5b8c\u6210\u3002</p>"},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#12-\u4e3a\u4ec0\u4e48\u7528sed","title":"1.2 \u4e3a\u4ec0\u4e48\u7528Sed","text":"<p>Sed\u76f8\u8f83\u4e8egrep/awk\uff0c\u5176\u4e3b\u8981\u529f\u80fd\u4e3a\u5bf9\u6587\u4ef6\u8fdb\u884c\u4fee\u6539\u5904\u7406\uff0c\u53ef\u4ee5\u5bf9\u6587\u4ef6\u6216\u6807\u51c6\u8f93\u5165\u6570\u636e\u6d41\u8fdb\u884c\u589e\u5220\u6539\u67e5\u7b49\u64cd\u4f5c\uff0c\u5c24\u5176\u9002\u7528\u4e8e\u5927\u6587\u4ef6\u6216\u6709\u89c4\u5f8b\u7684\u6587\u4ef6\uff0c\u5229\u7528\u6b64\u5de5\u5177\uff0c\u80fd\u591f\u5e2e\u52a9\u6211\u4eec\u5feb\u6377\u7684\u5728\u7f16\u5199Shell\u811a\u672c\u4e2d\u5f97\u5fc3\u5e94\u624b\u7684\u5bf9\u6587\u4ef6\u8fdb\u884c\u64cd\u4f5c\u3002</p>"},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#2-sed\u7684\u9002\u7528\u573a\u666f","title":"2 Sed\u7684\u9002\u7528\u573a\u666f","text":"<ul> <li> <p>\u8d85\u5927\u6587\u4ef6\u5904\u7406\uff1b</p> </li> <li> <p>\u6709\u89c4\u5f8b\u7684\u6587\u672c\uff0c\u4f8b\u5982\u683c\u5f0f\u5316\u540e\u7684\u65e5\u5fd7\u6587\u4ef6\u7b49\uff1b</p> </li> <li>\u5bf9\u6587\u4ef6\u8fdb\u884c\u6279\u91cf\u589e\u52a0\uff0c\u66ff\u6362\u7b49\u3002</li> </ul>"},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#3-sed\u7684\u5904\u7406\u6a21\u5f0f","title":"3 Sed\u7684\u5904\u7406\u6a21\u5f0f","text":"<p>Sed\u5bf9\u8f93\u5165\u7684\u4e00\u884c\u6570\u636e\u8fdb\u884c\u5904\u7406\u7684\u6a21\u5f0f\uff0c\u5bf9\u6574\u4e2a\u6587\u4ef6\u8fdb\u884c\u91cd\u590d\u6267\u884c\u6b64\u6a21\u5f0f\u5904\u7406\uff0c\u5728\u6b64\u8bf4\u660e\u5bf9\u8f93\u5165\u7684\u4e00\u884c\u6570\u636e\u5904\u7406\u7684\u5185\u5728\u673a\u5236\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <ol> <li> <p>\u9996\u5148\u8bfb\u5165\u6587\u4ef6\u6d41\u7684\u4e00\u884c\u5230\u6a21\u5f0f\u7a7a\u95f4\uff1b</p> </li> <li> <p>\u5728\u6a21\u5f0f\u7a7a\u95f4\u5185\uff0c\u5bf9\u5185\u5bb9\u8fdb\u884c\u6a21\u5f0f\u5339\u914d\u5904\u7406\uff1b</p> </li> <li> <p>\u8f93\u51fa\u5904\u7406\u540e\u7684\u6570\u636e\u5185\u5bb9\uff1b</p> </li> <li> <p>\u6e05\u7a7a\u5f53\u524d\u6a21\u5f0f\u7a7a\u95f4\uff1b</p> </li> <li> <p>\u8bfb\u53d6\u7b2c\u4e8c\u884c\u8f93\u5165\u6d41\u5230\u6a21\u5f0f\u7a7a\u95f4\uff1b</p> </li> <li>\u53c8\u5f00\u59cb\u5bf9\u6a21\u5f0f\u7a7a\u95f4\u5185\u7684\u4e0b\u4e00\u884c\u8f93\u5165\u6570\u636e\u8fdb\u884c\u5904\u7406\u3002</li> </ol>"},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#4-\u8bed\u6cd5\u8be6\u89e3","title":"4 \u8bed\u6cd5\u8be6\u89e3","text":"<p>sed\u8bed\u6cd5\u683c\u5f0f\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <pre><code>sed [option] 'address command' [file \u2026]\n</code></pre> <p>sed\u7684\u8bed\u6cd5\u683c\u5f0f\u4e3b\u8981\u5206\u4e3a\u56db\u4e2a\u5b57\u6bb5\uff0coptions\u9009\u9879\uff0c\u5f15\u53f7\u5185\u6709\u5730\u5740\u5b9a\u754c/\u547d\u4ee4\uff0c\u4ee5\u53ca\u8981\u5904\u7406\u7684\u6587\u4ef6\uff0c\u63a5\u4e0b\u6765\u8ba9\u6211\u4eec\u8be6\u7ec6\u8bb2\u89e3\u6bcf\u4e00\u4e2a\u8bed\u6cd5\u5b57\u6bb5\uff0c\u66f4\u5168\u9762\u7684\u8ba4\u8bc6sed\u8fd9\u4e2a\u811a\u672c\u5229\u5668\u3002</p>"},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#41-options","title":"4.1 options\uff1a","text":"<p>\u9009\u9879\u4e3a\u53ef\u9009\uff0c\u5229\u7528\u5b83\u6765\u4e3ased\u6307\u5b9a\u4e00\u4e9b\u5904\u7406\u65b9\u5f0f\uff0c\u4e3b\u8981\u7684\u6709\u5982\u4e0b\uff1a</p> <ul> <li>-n:\u9759\u9ed8\u6a21\u5f0f\uff0c\u6211\u4eec\u77e5\u9053sed\u9ed8\u8ba4\u5904\u7406\u5b8c\u6a21\u5f0f\u7a7a\u95f4\u540e\u5c06\u5185\u5bb9\u8f93\u51fa\u5230\u6807\u51c6\u8f93\u51fa\uff0c\u5229\u7528\u8fd9\u4e2a\u8fd9\u4e2a\u53c2\u6570\u4ec5\u663e\u793ascript\u5904\u7406\u540e\u7684\u7ed3\u679c\uff0c\u4e0d\u518d\u9ed8\u8ba4\u663e\u793a\u6a21\u5f0f\u7a7a\u95f4\u4e2d\u7684\u5185\u5bb9\uff0c\u4f8b\u5982\uff1a\u6253\u5370/etc/passwd\u7684\u5730\u4e09\u884c</li> </ul> <pre><code>[root@shell workspace]# sed -n '3p' /etc/passwd\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\n</code></pre> <p>\u5728\u6b64\u76f4\u63a5\u6307\u5b9a\u5730\u5740\u5b9a\u754c3\uff0c\u7136\u540ecommand\u4e3ap\u6253\u5370\u8f93\u51fa\uff0c\u7531\u4e8e\u4e0d\u60f3\u8f93\u51fa/etc/passwd\u7684\u5168\u90e8\u5185\u5bb9\uff0c\u56e0\u6b64\u6dfb\u52a0\u4e86-n\u9009\u9879\u3002</p> <pre><code>* -e:&lt;script&gt;\u6216--expression=&lt;script&gt; \u4ee5\u9009\u9879\u4e2d\u6307\u5b9a\u7684script\u6765\u5904\u7406\u8f93\u5165\u7684\u6587\u672c\u6587\u4ef6\uff0c\u53ef\u4ee5\u540c\u65f6\u6267\u884c\u591a\u4e2a\u811a\u672c\uff1b\n* -f:\u5bf9\u5236\u5b9a\u7684\u6587\u4ef6\u76f4\u63a5\u8fdb\u884csed\u7684command\u64cd\u4f5c\uff1b\n* -i:\u76f4\u63a5\u4fee\u6539\u539f\u6587\u4ef6\uff0c\u6211\u4eec\u90fd\u77e5\u9053sed\u9ed8\u8ba4\u4e0d\u5bf9\u6587\u4ef6\u8fdb\u884c\u4fee\u6539\uff0c\u53ea\u662f\u8bfb\u5165\u4e00\u884c\u5230\u6a21\u5f0f\u7a7a\u95f4\u4e2d\uff0c\u5904\u7406\u5b8c\u6210\u540e\u8f93\u51fa\uff0c\u6b64\u53c2\u6570\u4e3a\u4e5f\u76f4\u63a5\u4fee\u6539\u4e86\u6e90\u6587\u4ef6\uff1b\n* -r:\u652f\u6301\u6269\u5c55\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u800c\u4e0d\u662f\u4f7f\u7528\u9ed8\u8ba4\u7684\u57fa\u7840\u6b63\u5219\u8868\u8fbe\u5f0f\u3002\u7c7b\u6bd4grep\u547d\u4ee4\u7684egrep\uff0c\u66f4\u52a0\u5feb\u6377\u7b80\u6d01\u7684\u4f7f\u7528\u6269\u5c55\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u56e0\u4e3a\u6709\u4e9b\u5143\u5b57\u7b26\u4e0d\u7528\u518d\u4f7f\u7528\u53cd\u659c\u7ebf\"\\\\\"\u4e86\u3002\n</code></pre>"},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#42-address","title":"4.2 address:","text":"<p>\u5730\u5740\u5b9a\u754c\u7528\u6765\u6307\u5b9a\u8bfb\u5165\u6587\u4ef6\u7684\u8fb9\u754c\u6216\u6b65\u957f\u3002</p> <ul> <li><code>startline\uff0cendline</code>\uff1a\u6307\u5b9a\u8bfb\u5165\u6587\u4ef6\u7684\u5f00\u59cb\u884c\u4e8e\u7ed3\u675f\u884c\u53f7\u3002</li> <li><code>/regexp/</code>:\u5229\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\u5230\u7684\u884c\u8fdb\u884c\u5904\u7406\uff0c\u4f8b\u5982\uff1a\u6253\u5370/etc/passwd\u4ece\u4ee5root\u5f00\u59cb\u5230sync\u7ed3\u675f\u7684\u5185\u5bb9</li> </ul> <pre><code>[root@shell workspace]# sed -n '/^root/,/^sync/p' /etc/passwd\nroot:x:0:0:root:/root:/bin/bash\nbin:x:1:1:bin:/bin:/sbin/nologin\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\nadm:x:3:4:adm:/var/adm:/sbin/nologin\nlp:x:4:7:lp:/var/spool/lpd:/sbin/nologin\nsync:x:5:0:sync:/sbin:/bin/sync\n</code></pre> <p>\u5728\u6b64\u5229\u7528\u4e86\u5339\u914d\u5143\u5b57\u7b26<code>^</code>\u7528\u6765\u5339\u914d\u884c\u9996\uff0c\u6b64\u5185\u5bb9\u5728\u6b63\u5219\u8868\u8fbe\u5f0f\u4e2d\u5df2\u7ecf\u8fdb\u884c\u4e86\u8be6\u7ec6\u89e3\u91ca\u3002</p> <ul> <li><code>/pattern1/,/pattern2/</code>:\u7b2c\u4e00\u6b21\u88abpattern1\u5339\u914d\u5230\u7684\u884c\u5f00\u59cb\uff0c\u76f4\u5230\u88abpattern2\u5339\u914d\u5230\u7684\u884c\u7ed3\u675f\uff0c\u4f8b\u5982\uff1a\u6253\u5370/etc/passwd\u7684\u7b2c\u56db\u884c\u5230\u7b2c\u4e03\u884c\u7684\u5185\u5bb9</li> </ul> <pre><code>[root@shell workspace]# sed -n '3,7p' /etc/passwd\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\nadm:x:3:4:adm:/var/adm:/sbin/nologin\nlp:x:4:7:lp:/var/spool/lpd:/sbin/nologin\nsync:x:5:0:sync:/sbin:/bin/sync\nshutdown:x:6:0:shutdown:/sbin:/sbin/shutdown\n</code></pre> <ul> <li><code>linenuber</code>:\u76f4\u63a5\u6307\u5b9a\u884c\u53f7\uff0c\u9700\u8981\u5904\u7406\u54ea\u4e00\u884c\u3002</li> <li><code>startline\uff0c+n</code>:\u4ece\u90a3\u4e00\u884c\u5f00\u59cb\uff0c\u5f80\u540en\u884c\u7ed3\u675f\uff0c\u4f8b\u5982\uff1a\u6253\u5370/etc/passwd\u7684\u4ece\u7b2c\u4e09\u884c\u5f00\u59cb\u5f80\u540e\u76842\u884c\u7684\u5185\u5bb9</li> </ul> <pre><code>[root@shell workspace]# sed -n \"3,+2p\" /etc/passwd\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\nadm:x:3:4:adm:/var/adm:/sbin/nologin\nlp:x:4:7:lp:/var/spool/lpd:/sbin/nologin\n</code></pre> <ul> <li><code>startline~step</code>:\u6307\u5b9a\u6b65\u957f\uff0c\u6bcf\u9694step\u6b65\u8fdb\u884c\u5904\u7406\uff0c\u5e38\u7528\u5728\u5947\u5076\u6570\u5904\u7406\uff0c\u4f8b\u5982\uff1a\u6253\u5370\u5947\u6570\u884c</li> </ul> <pre><code>seq 10 |sed -n '1~2p'\n</code></pre> <p>seq\u6765\u8f93\u51fa\u4ee5\u6570\u5b57\u4e3a\u5185\u5bb9\u768410\u884c\uff0c\u7136\u540e\u5229\u7528<code>~2</code>\u4f5c\u4e3a\u6b65\u957f\u6253\u5370\u8f93\u51fa\u3002</p>"},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#43-command","title":"4.3 command\uff1a","text":"<p>\u5177\u4f53\u5bf9\u6307\u5b9a\u7684\u6587\u4ef6\u8fdb\u884c\u600e\u6837\u7684\u5904\u7406\uff0c\u4f8b\u5982\u5bf9\u6a21\u5f0f\u7a7a\u95f4\u5185\u7684\u5185\u5bb9\u8fdb\u884c\u589e\u5220\u6539\u67e5\u5177\u4f53\u7684\u64cd\u4f5c\u3002</p>"},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#431-\u589e","title":"4.3.1 \u589e","text":"<ul> <li>i\uff1ainsert\uff0c\u5728\u5236\u5b9a\u6216\u5339\u914d\u5230\u7684\u884c\u524d\u9762\u6dfb\u52a0\u65b0\u884c\u5185\u5bb9\u4e3astring\uff0c<code>i\\string</code>\uff0c \u4e3a/etc/passwd \u4e2d\u7684\u7b2c\u4e00\u884c\u524d\u9762\u6dfb\u52a0\u4e00\u884c\u5185\u5bb9\u4e3a\"####\"\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@shell workspace]# sed '1i####' /etc/passwd\n####\nroot:x:0:0:root:/root:/bin/bash\nbin:x:1:1:bin:/bin:/sbin/nologin\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\n.....\n</code></pre> <ul> <li>a\uff1aappend\uff0c\u5728\u6307\u5b9a\u6216\u5339\u914d\u5230\u7684\u884c\u540e\u9762\u8ffd\u52a0\u65b0\u884c\uff0c\u5185\u5bb9\u4e3astring\uff0c<code>a\\string</code>\u3002 \u4e3a/etc/passwd\u7684\u7b2c\u4e00\u884c\u540e\u9762\u6dfb\u52a0\u5185\u5bb9\"aaa\"\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@shell workspace]# sed '1a###' /etc/passwd\nroot:x:0:0:root:/root:/bin/bash\n###\nbin:x:1:1:bin:/bin:/sbin/nologin\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\nadm:x:3:4:adm:/var/adm:/sbin/nologin\n</code></pre>"},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#432-\u5220","title":"4.3.2 \u5220","text":"<ul> <li>d\uff1adelete\uff0c\u5220\u9664\u7b26\u5408\u5730\u5740\u5b9a\u754c\u6761\u4ef6\u7684\u7684\u884c</li> </ul> <p>\u5220\u9664/etc/inittab\u6587\u4ef6\u4e2d\u6ce8\u91ca\u884c\uff0c\u4f8b\u5982\uff1a</p> <pre><code>sed '/^#/d' /etc/inittab\n</code></pre> <p>\u76f4\u63a5\u5229\u7528\u5143\u5b57\u7b26\u5339\u914d\u94c6\u5b9a\u4ee5<code>#</code>\u5f00\u5934\u7684\u884c\u8fdb\u884c\u5220\u9664\u64cd\u4f5c\uff0c\u6ce8\u610f\u6b64\u5904\u6ca1\u6709\u76f4\u63a5\u4fee\u6539\u6587\u4ef6\uff0c\u5982\u679c\u6dfb\u52a0<code>-i</code>\u9009\u9879\uff0c\u5219\u76f4\u63a5\u5bf9\u6e90\u6587\u4ef6\u8fdb\u884c\u4fee\u6539\uff0c\u4e00\u822c\u9700\u8981\u5148\u5907\u4efd\uff0c\u7136\u540e\u64cd\u4f5c\u4ee5\u514d\u8bef\u64cd\u4f5c\u539f\u59cb\u6587\u4ef6\u3002</p>"},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#433-\u6539","title":"4.3.3 \u6539","text":"<ul> <li>s\uff1a<code>s/pattern/string/\u4fee\u9970\u7b26</code>: \u67e5\u627e\u5e76\u66ff\u6362\uff0c\u9ed8\u8ba4\u53ea\u66ff\u6362\u6bcf\u884c\u4e2d\u7b2c\u4e00\u6b21\u88ab\u6a21\u5f0f\u5339\u914d\u5230\u7684\u5b57\u7b26\u4e32 \uff0c\u5982\u679c\u4fee\u9970\u7b26\u4e3ag,\u5219\u4e3a\u5168\u90e8\u66ff\u6362\u3002 \u66ff\u6362/etc/passwd\u4e2d\u7684root\u4e3a\u5927\u5199\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@shell workspace]# sed 's/root/ROOT/g' /etc/passwd\nROOT:x:0:0:ROOT:/ROOT:/bin/bash\nbin:x:1:1:bin:/bin:/sbin/nologin\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\n...\n</code></pre> <p>\u66ff\u6362/etc/inittab\u6587\u4ef6\u4e2d\"id:3:initdefault:\"\u4e00\u884c\u4e2d\u7684\u6570\u5b57\u4e3a5\uff0c\u4f8b\u5982\uff1a</p> <pre><code>sed 's/id:[0-9]/id:5/g' /etc/inittab\n</code></pre> <p>\u5728\u6b64\u5229\u7528\u5143\u5b57\u7b26\u5339\u914d[0-9]\u7684\u4e00\u4e2a\u6570\u5b57\u8fdb\u884c\u66ff\u6362\u4e3a<code>id:5</code>\u3002</p>"},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#434-\u67e5","title":"4.3.4 \u67e5","text":"<ul> <li>p\uff1aprint\uff0c\u9ed8\u8ba4sed\u5bf9\u6a21\u5f0f\u7a7a\u95f4\u5185\u7684\u5904\u7406\u5b8c\u6bd5\u540e\uff0c\u5c06\u8f93\u51fa\u7684\u7ed3\u679c\u8f93\u51fa\u5728\u6807\u51c6\u8f93\u51fa\uff0c\u6dfb\u52a0p\u547d\u4ee4\uff0c\u76f8\u5f53\u4e8e\u8f93\u51fa\u4e86\u539f\u6587\uff0c\u53c8\u4e00\u6b21\u8f93\u51fa\u4e86\u6a21\u5f0f\u5339\u914d\u5904\u7406\u540e\u7684\u5185\u5bb9\u3002</li> </ul> <p>\u6253\u5370/etc/passwd\u7684\u7b2c\u4e09\u884c\uff0c\u6307\u5b9a\u884c\u53f7\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@shell workspace]# sed -n '3p' /etc/passwd\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\n</code></pre> <p>\u5728\u6b64\u76f4\u63a5\u6307\u5b9a\u5730\u5740\u5b9a\u754c3\uff0c\u7136\u540ecommand\u4e3ap\u6253\u5370\u8f93\u51fa\uff0c\u7531\u4e8e\u4e0d\u60f3\u8f93\u51fa/etc/passwd\u7684\u5168\u90e8\u5185\u5bb9\uff0c\u56e0\u6b64\u6dfb\u52a0\u4e86-n\u9009\u9879\u3002</p>"},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#5-\u5b9e\u4f8b","title":"5 \u5b9e\u4f8b","text":""},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#51-\u9700\u6c42","title":"5.1 \u9700\u6c42","text":"<p>\u76ee\u524d\u817e\u8baf\u4e91\u670d\u52a1\u5668Ubuntu\u7248\u672c\u7528\u6237\u4e3aubuntu\u7528\u6237\uff0c\u73b0\u53c81000\u53f0\u670d\u52a1\u5668\u9700\u8981\u53bb\u5f00\u542froot\u8fdc\u7a0b\u767b\u5f55\u3002</p>"},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#52-\u601d\u8def","title":"5.2 \u601d\u8def","text":"<p>\u5f00\u542fubuntu\u670d\u52a1\u5668\u7684\u8fdc\u7a0b\u767b\u5f55\u5373\u4fee\u6539\u5176\u7684/etc/ssh/sshd_config \u6587\u4ef6\u7684prohibit-password\u4e3ayes\u5373\u53ef\uff0c\u91cd\u542fsshd\u670d\u52a1\u5373\u53ef\uff0c\u5229\u7528\u811a\u672c\u903b\u8f91\u5904\u7406\u3002</p>"},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#53-\u5b9e\u73b0","title":"5.3 \u5b9e\u73b0","text":"<p>\u6838\u5fc3\u5229\u7528sed\u4ee3\u7801\uff1a</p> <pre><code>if [ ${ostype} == 'Ubuntu' ];then\nsed -i 's/prohibit-password/yes/g' /etc/ssh/sshd_config\n# \u91cd\u542fssh\u670d\u52a1\nservice sshd restart\n[ $? -eq 0] &amp;&amp; echo \"${OSTYPE} sshd \u5f00\u542f\u6210\u529f\" &gt;&gt;${LOG_FILE}\nfi\n</code></pre>"},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#6-\u6ce8\u610f\u4e8b\u9879","title":"6 \u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>sed\u4e2d\u5229\u7528\u4e8e\u6b63\u5219\u8868\u8fbe\u5f0f\u914d\u5408\u53ef\u4ee5\u5f97\u52301+1\u5927\u4e8e\u4e8c\u7684\u6548\u679c\uff0c\u914d\u5408\u4f7f\u7528\u529f\u80fd\u66f4\u52a0\u4e30\u5bcc\u5f3a\u5927\uff1b</li> <li>sed\u5e38\u7528\u4e8e\u4fee\u6539\u6587\u4ef6\uff0c\u5982\u679c\u4e3a\u67e5\u8be2\u6587\u4ef6\u53ef\u4ee5\u5229\u7528grep\uff0c\u56e0\u4e3agrep\u68c0\u7d22\u6587\u4ef6\u6548\u7387\u6700\u9ad8\uff0c\u5982\u679c\u4e3a\u683c\u5f0f\u5316\u8f93\u51fa\u5efa\u8bae\u4f7f\u7528awk\uff1b</li> <li>sed\u5728\u4fee\u6539\u6587\u4ef6\u7684\u65f6\u5019\u5c3d\u53ef\u80fd\u5148\u4e0d\u8981\u6dfb\u52a0<code>-i</code> options\uff0c\u4ee5\u514d\u5c06\u6e90\u59cb\u6587\u4ef6\u4fee\u6539\u5f02\u5e38\u96be\u4ee5\u6062\u590d\u3002</li> </ul>"},{"location":"Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/#7-\u5c0f\u7ed3","title":"7 \u5c0f\u7ed3","text":"<p>sed\u7684\u529f\u80fd\u975e\u5e38\u5f3a\u5927\uff0c\u5b83\u662f\u6211\u4eecshell\u7f16\u7a0b\u4e2d\u5bf9\u6587\u4ef6\u4fee\u6539\u4e0d\u53ef\u6216\u7f3a\u7684\u5229\u5668\uff0c\u914d\u5408\u6b63\u5219\u8868\u8fbe\u5f0f\u5e38\u7528\u6765\u6279\u91cf\u4fee\u6539\u5927\u6587\u4ef6\uff0c\u6216\u6709\u4e00\u5b9a\u683c\u5f0f\u89c4\u5f8b\u7684\u6587\u4ef6\uff0c\u5176\u8fd8\u6709\u5f88\u591a\u9ad8\u7ea7\u529f\u80fd\u3002\u5982\u679c\u5b66\u6709\u4f59\u529b\u5efa\u8bae\u53bbman\u624b\u518c\u8be6\u7ec6\u5b66\u4e60\u67e5\u770b\uff0c\u5728\u5229\u7528sed\u5de5\u5177\u7684\u65f6\u5019\u9700\u8981\u65f6\u523b\u8111\u6d77\u4e2d\u7262\u8bb0\u6c42\u8bed\u6cd5\u683c\u5f0f\uff0c\u4e07\u53d8\u4e0d\u79bb\u5176\u5b97\uff0c\u9075\u5faa\u8bed\u6cd5\u4e3e\u4e00\u53cd\u4e09\u80fd\u591f\u8fbe\u5230\u5b66\u751f\u4e8b\u534a\u529f\u500d\u7684\u6548\u679c\u3002</p>"},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/","title":"14.Shell\u4e09\u5251\u5ba2\u4e4bawk","text":""},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/#1-awk\u6982\u8ff0","title":"1 awk\u6982\u8ff0","text":""},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/#11-awk\u662f\u4ec0\u4e48","title":"1.1 awk\u662f\u4ec0\u4e48","text":"<p>awk\u4e0d\u540c\u4e8egrep\u7684\u6587\u672c\u641c\u7d22\u4e0esed\u5de5\u5177\u7684\u6587\u672c\u5904\u7406\uff0c\u5b83\u66f4\u504f\u5411\u4e8e\u5bf9\u6587\u672c\u7684\u683c\u5f0f\u5316\u5904\u7406\u8f93\u51fa\uff0c\u5b83\u4e0d\u4ec5\u4ec5\u662f\u4e00\u5757\u5de5\u5177\uff0c\u4e5f\u662f\u4e00\u95e8\u89e3\u91ca\u5f62\u8bed\u8a00\uff0c\u5176\u540d\u5b57\u6765\u6e90\u4e8e\u5b83\u7684\u4e09\u4f4d\u4f5c\u8005\u7684\u59d3\u6c0f\uff1aAlfred Aho\uff0c Peter Weinberger \u548c Brian Kernighan\uff0c\u5728\u6587\u672c\u5904\u7406\u9886\u529f\u80fd\u975e\u5e38\u5f3a\u5927\uff0c\u662f\u4e00\u6b3eLinux\u670d\u52a1\u5668\u6587\u672c\u62a5\u544a\u751f\u6210\u5668\u548c\u683c\u5f0f\u5316\u6587\u672c\u8f93\u51fa\u5de5\u5177\u3002</p>"},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/#12-\u4e3a\u4ec0\u4e48\u7528awk","title":"1.2 \u4e3a\u4ec0\u4e48\u7528awk","text":"<p>\u6211\u4eec\u65e5\u5e38\u5de5\u4f5c\u4e2d\u6709\u5f88\u591a\u9700\u8981\u683c\u5f0f\u5316\u6253\u5370\u8f93\u51fa\u7684\u9700\u6c42\uff0c\u66f4\u591a\u7684\u662f\u5173\u6ce8\u5217\u64cd\u4f5c\u65f6\u5c31\u53ef\u4ee5\u5229\u7528awk\u5de5\u5177\u6765\u8fdb\u884c\u5904\u7406\u3002awk\u9664\u4e86\u662f\u5de5\u5177\u4e5f\u540c\u6837\u662f\u4e00\u95e8\u8bed\u8a00\uff0c\u5176\u5141\u8bb8\u7528\u6237\u521b\u5efa\u7b80\u77ed\u7684\u7a0b\u5e8f\u6765\u5904\u7406\u81ea\u5df1\u7684\u9700\u6c42\uff0c\u8fd9\u4e9b\u7a0b\u5e8f\u8bfb\u53d6\u8f93\u5165\u6587\u4ef6\u3001\u4e3a\u6570\u636e\u6392\u5e8f\u3001\u5904\u7406\u6570\u636e\u3001\u5bf9\u8f93\u5165\u6267\u884c\u8ba1\u7b97\u4ee5\u53ca\u751f\u6210\u62a5\u8868\u7b49\u3002\u529f\u80fd\u975e\u5e38\u7684\u5f3a\u5927\uff0c\u76f8\u4fe1\u5728\u638c\u63e1\u4e86awk\uff0c\u65e5\u5e38\u8fd0\u7ef4\u5de5\u4f5c\u66f4\u52a0\u65b9\u4fbf\u9ad8\u6548\u7b80\u5355\u3002</p>"},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/#2-awk\u7684\u9002\u7528\u573a\u666f","title":"2 awk\u7684\u9002\u7528\u573a\u666f","text":"<ul> <li>\u8d85\u5927\u6587\u4ef6\u5904\u7406\uff1b</li> <li>\u8f93\u51fa\u683c\u5f0f\u5316\u7684\u6587\u672c\u62a5\u8868\uff1b</li> <li>\u6267\u884c\u7b97\u6570\u8fd0\u7b97\uff1b</li> <li>\u6267\u884c\u5b57\u7b26\u4e32\u64cd\u4f5c\u7b49\u3002</li> </ul>"},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/#3-awk\u7684\u5904\u7406\u6a21\u5f0f","title":"3 awk\u7684\u5904\u7406\u6a21\u5f0f","text":"<p>\u4e00\u822c\u662f\u904d\u5386\u4e00\u4e2a\u6587\u4ef6\u4e2d\u7684\u6bcf\u4e00\u884c\uff0c\u7136\u540e\u5206\u522b\u5bf9\u6587\u4ef6\u7684\u6bcf\u4e00\u884c\u8fdb\u884c\u5904\u7406\u3002</p> <p>awk\u5bf9\u8f93\u5165\u7684\u4e00\u884c\u6570\u636e\u8fdb\u884c\u5904\u7406\u7684\u6a21\u5f0f\uff0c\u5bf9\u6574\u4e2a\u6587\u4ef6\u8fdb\u884c\u91cd\u590d\u6267\u884c\u6b64\u6a21\u5f0f\u5904\u7406\uff0c\u5728\u6b64\u8bf4\u660e\u5bf9\u8f93\u5165\u7684\u4e00\u884c\u6570\u636e\u5904\u7406\u7684\u5185\u5728\u673a\u5236\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u5904\u7406\u8fc7\u7a0b\u4e0d\u65ad\u91cd\u590d\uff0c\u76f4\u5230\u5230\u8fbe\u6587\u4ef6\u7ed3\u5c3e\u3002</p> <ol> <li>\u9996\u5148\u8bfb\u5165\u6587\u4ef6\u6d41\u7684\u4e00\u884c\u5230\u6a21\u5f0f\u7a7a\u95f4\uff1b</li> <li>\u5728\u6a21\u5f0f\u7a7a\u95f4\u5185\uff0c\u5bf9\u5185\u5bb9\u8fdb\u884c\u6a21\u5f0f\u5339\u914d\u5904\u7406\uff1b</li> <li>\u7136\u540e\u8f93\u51fa\u5904\u7406\u540e\u7684\u6570\u636e\u5185\u5bb9\uff1b</li> <li>\u6e05\u7a7a\u5f53\u524d\u6a21\u5f0f\u7a7a\u95f4\uff1b</li> <li>\u8bfb\u53d6\u7b2c\u4e8c\u884c\u8f93\u5165\u6d41\u5230\u6a21\u5f0f\u7a7a\u95f4\uff1b</li> <li>\u53c8\u5f00\u59cb\u5bf9\u6a21\u5f0f\u7a7a\u95f4\u5185\u7684\u7b2c\u4e8c\u884c\u8f93\u5165\u6570\u636e\u8fdb\u884c\u5904\u7406\u3002</li> </ol> <p>\u603b\u4f53\u53ef\u4ee5\u5206\u4e3a\u4ee5\u4e0b\u4e09\u90e8\uff1a</p> <ul> <li> <p>\u8bfb( Read )\uff1aAWK \u4ece\u8f93\u5165\u6d41\uff08\u6587\u4ef6\u3001\u7ba1\u9053\u6216\u8005\u6807\u51c6\u8f93\u5165\uff09\u4e2d\u8bfb\u5165\u4e00\u884c\u7136\u540e\u5c06\u5176\u5b58\u5165\u5185\u5b58\u4e2d\u3002</p> </li> <li> <p>\u6267\u884c(Execute)\uff1a\u5bf9\u4e8e\u6bcf\u4e00\u884c\u8f93\u5165\uff0c\u6240\u6709\u7684 AWK \u547d\u4ee4\u6309\u987a\u6267\u884c\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cAWK \u547d\u4ee4\u662f\u9488\u5bf9\u4e8e\u6bcf\u4e00\u884c\u8f93\u5165\uff0c\u4f46\u662f\u6211\u4eec\u53ef\u4ee5\u5c06\u5176\u9650\u5236\u5728\u6307\u5b9a\u7684\u6a21\u5f0f\u4e2d\u3002</p> </li> <li>\u91cd\u590d\uff08Repeate\uff09\uff1a\u4e00\u76f4\u91cd\u590d\u4e0a\u8ff0\u4e24\u4e2a\u8fc7\u7a0b\u76f4\u5230\u6587\u4ef6\u7ed3\u675f\u3002</li> </ul>"},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/#4-\u8bed\u6cd5\u53ca\u7ed3\u6784","title":"4 \u8bed\u6cd5\u53ca\u7ed3\u6784","text":""},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/#41-\u8bed\u6cd5","title":"4.1 \u8bed\u6cd5","text":"<p>Awk\u8bed\u6cd5\u683c\u5f0f\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <pre><code>awk [options] 'PATTERN {action}' file1,file2\n</code></pre> <p>awk\u7684\u8bed\u6cd5\u683c\u5f0f\u4e3b\u8981\u5206\u4e3a\u56db\u4e2a\u5b57\u6bb5\uff0coptions\u9009\u9879\uff0c\u5f15\u53f7\u5185\u6709\u6a21\u5757\u4e0e\u52a8\u4f5c\uff0c\u4ee5\u53ca\u8981\u5904\u7406\u7684\u6587\u4ef6\uff0c\u63a5\u4e0b\u6765\u8ba9\u6211\u4eec\u8be6\u7ec6\u8bb2\u89e3\u6bcf\u4e00\u4e2a\u8bed\u6cd5\u5b57\u6bb5\uff0c\u66f4\u5168\u9762\u7684\u8ba4\u8bc6awk\u8fd9\u4e2a\u811a\u672c\u5229\u5668\u3002</p>"},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/#42-\u7a0b\u5e8f\u7ed3\u6784","title":"4.2 \u7a0b\u5e8f\u7ed3\u6784","text":"<p>awk\u5728\u5f15\u53f7\u5185\u6709\u4e00\u5b9a\u7684\u7a0b\u5e8f\u7ed3\u6784\uff0c\u4e3b\u8981\u4e3a\u4ee5\u4e0b\uff1a</p> <ul> <li>\u5f00\u59cb\u5757\uff08BEGIN BLOCK\uff09\uff1a</li> </ul> <pre><code>\u8bed\u6cd5\uff1a\nBEGIN{awk-commands}\n\u5f00\u59cb\u5757\u5c31\u662fawk\u7a0b\u5e8f\u542f\u52a8\u65f6\u6267\u884c\u7684\u4ee3\u7801\u90e8\u5206\uff08\u5728\u5904\u7406\u8f93\u5165\u6d41\u4e4b\u524d\u6267\u884c\uff09\uff0c\u5e76\u4e14\u5728\u6574\u4e2a\u8fc7\u7a0b\u4e2d\u53ea\u6267\u884c\u4e00\u6b21\uff1b\n\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5728\u5f00\u59cb\u5757\u4e2d\u521d\u59cb\u5316\u4e00\u4e9b\u53d8\u91cf\u3002BEGIN\u662fawk\u7684\u5173\u952e\u5b57\uff0c\u56e0\u6b64\u5fc5\u987b\u8981\u5927\u5199\u3002\u3010\u6ce8\uff1a\u5f00\u59cb\u5757\u90e8\u5206\u662f\u53ef\u9009\uff0c\u5373\u4f60\u7684awk\u7a0b\u5e8f\u53ef\u4ee5\u6ca1\u6709\u5f00\u59cb\u5757\u90e8\u5206\u3011\n</code></pre> <ul> <li>\u4e3b\u4f53\u5757\uff08Body Block\uff09\uff1a</li> </ul> <pre><code>\u8bed\u6cd5\uff1a\n/pattern/{awk-commands}\n\u9488\u5bf9\u6bcf\u4e00\u4e2a\u8f93\u5165\u7684\u884c\u90fd\u4f1a\u6267\u884c\u4e00\u6b21\u4e3b\u4f53\u90e8\u5206\u7684\u547d\u4ee4\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5bf9\u4e8e\u8f93\u5165\u7684\u6bcf\u4e00\u884c\uff0cawk\u90fd\u4f1a\u6267\u884c\u4e3b\u4f53\u90e8\u5206\u7684\u547d\u4ee4\uff0c\u4f46\u662f\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528/pattern/\u9650\u5236\u5176\u5728\u6307\u5b9a\u6a21\u5f0f\u4e0b\u3002\n</code></pre> <ul> <li>\u7ed3\u675f\u5757\uff08END BLOCK\uff09\uff1a</li> </ul> <pre><code>\u8bed\u6cd5\uff1a\nEND{awk-commands}\n\u7ed3\u675f\u5757\u662fawk\u7a0b\u5e8f\u7ed3\u675f\u65f6\u6267\u884c\u7684\u4ee3\u7801\uff08\u5728\u5904\u7406\u5b8c\u8f93\u5165\u6d41\u4e4b\u540e\u6267\u884c\uff09\uff0cEND\u4e5f\u662fawk\u7684\u5173\u952e\u5b57\uff0c\u5fc5\u987b\u5927\u5199\uff0c\u4e0e\u5f00\u59cb\u5757\u7c7b\u4f3c\uff0c\u7ed3\u675f\u5757\u4e5f\u662f\u53ef\u9009\u7684\u3002\n</code></pre>"},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/#43-awk\u547d\u4ee4\u8be6\u89e3","title":"4.3 awk\u547d\u4ee4\u8be6\u89e3","text":""},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/#431-awk-\u8f93\u51fa","title":"4.3.1 awk \u8f93\u51fa","text":"<ul> <li>awk print\u8f93\u51fa\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>print item1,item2...\n</code></pre> <p>1.\u5404\u5b57\u6bb5\u4e4b\u95f4\u9017\u53f7\u9694\u5f00\uff0c\u8f93\u51fa\u65f6\u4ee5\u7a7a\u767d\u5b57\u7b26\u5206\u5272\uff1b</p> <p>2.\u8f93\u51fa\u7684\u5b57\u6bb5\u53ef\u4ee5\u4e3a\u5b57\u7b26\u4e32\u6216\u6570\u503c\uff0c\u5f53\u524d\u8bb0\u5f55\u7684\u5b57\u6bb5\uff08\u5982$1\uff09\u3001\u53d8\u91cf\u6216awk\u7684\u8868\u8fbe\u5f0f\uff1b\u6570\u503c\u5148\u4f1a\u8f6c\u6362\u6210\u5b57\u7b26\u4e32\u7136\u540e\u8f93\u51fa;</p> <p>3.print\u547d\u4ee4\u540e\u9762\u7684item\u53ef\u4ee5\u7701\u7565\uff0c\u6b64\u65f6\u5176\u529f\u80fd\u76f8\u5f53\u4e8e<code>print $0</code>,\u5982\u679c\u60f3\u8f93\u51fa\u7a7a\u767d\uff0c\u53ef\u4ee5\u4f7f\u7528<code>print \"\"</code>;</p> <p>\u4f8b\u5982\uff1a</p> <p><pre><code>[root@master ~]# awk -F: '{print $1,$NF}' /etc/passwd|column -t\nroot             /bin/bash\nbin              /sbin/nologin\ndaemon           /sbin/nologin\nadm              /sbin/nologin\nlp               /sbin/nologin\nsync             /bin/sync\n</code></pre> * awk printf\u8f93\u51fa</p> <p>printf\u547d\u4ee4\u7684\u4f7f\u7528\u683c\u5f0f\uff1a</p> <pre><code>printf &lt;format&gt; item1,item2...\n</code></pre> <p>\u8981\u70b9\uff1a</p> <p>1.\u5176\u4e0eprint\u547d\u4ee4\u6700\u5927\u533a\u522b,printf \u9700\u8981\u6307\u5b9aformat,format\u5fc5\u987b\u7ed9\u51fa\uff1b</p> <p>2.format\u7528\u4e8e\u6307\u5b9a\u540e\u9762\u7684\u6bcf\u4e2aitem\u8f93\u51fa\u683c\u5f0f\uff1b</p> <p>3.printf \u8bed\u53e5\u4e0d\u4f1a\u81ea\u52a8\u6253\u5370\u6362\u884c\u5b57\u7b26<code>\\n</code>\u3002</p> <p>format\u683c\u5f0f\u7684\u6307\u793a\u7b26\u90fd\u4ee5%\u5f00\u5934\uff0c\u540e\u8ddf\u4e00\u4e2a\u5b57\u7b26:</p> <pre><code>%c:\u663e\u793aascall\u7801\n%d:%i:\u5341\u8fdb\u5236\u6574\u6570\n%e\uff0c%E\uff1a\u79d1\u5b66\u8ba1\u6570\u6cd5\n%f:\u6d6e\u70b9\u6570\n%s\uff1a\u5b57\u7b26\u4e32\n%u\uff1a\u65e0\u7b26\u53f7\u6574\u6570\n%%\uff1a\u663e\u793a%\u81ea\u8eab\n\u4fee\u9970\u7b26\uff1a\n#[.#]:\u7b2c\u4e00\u4e2a#\u63a7\u5236\u663e\u793a\u7684\u5bbd\u5ea6\uff1a\u7b2c\u4e8c\u4e2a#\u8868\u793a\u5c0f\u6570\u70b9\u540e\u7684\u7cbe\u5ea6\uff1a\n%3.1f\n-:\u5de6\u5bf9\u9f50\n+\uff1a\u663e\u793a\u6570\u7ec4\u7b26\u53f7\n</code></pre> <p>\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# awk -F: '{printf \"Username:%-15s   ,Uid:%d\\n\",$1,$3}' /etc/passwd\nUsername:root              ,Uid:0\nUsername:bin               ,Uid:1\nUsername:daemon            ,Uid:2\nUsername:adm               ,Uid:3\nUsername:lp                ,Uid:4\nUsername:sync              ,Uid:5\nUsername:shutdown          ,Uid:6\n</code></pre>"},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/#432-awk\u53d8\u91cf","title":"4.3.2 awk\u53d8\u91cf","text":"<ul> <li> <p>awk\u5185\u7f6e\u53d8\u91cf\u4e4b\u8bb0\u5f55\u53d8\u91cf\uff1a</p> <ul> <li>IFS:input field separator\uff0c\u8f93\u5165\u5b57\u6bb5\u5206\u9694\u7b26\uff08\u9ed8\u8ba4\u7a7a\u767d\uff09</li> <li>OFS:output field separator\uff0c\u8f93\u51fa\u5b57\u6bb5\u5206\u9694\u7b26</li> <li> <p>RS:Record separator:\u8f93\u5165\u6587\u672c\u6362\u884c\u7b26\uff08\u9ed8\u8ba4\u56de\u8f66\uff09</p> </li> <li> <p>ORS:\u8f93\u51fa\u6587\u672c\u6362\u884c\u7b26</p> </li> </ul> </li> <li> <p>awk\u5185\u7f6e\u53d8\u91cf\u4e4b\u6570\u636e\u53d8\u91cf</p> <ul> <li>NR:the number of input records,awk\u547d\u4ee4\u6240\u5904\u7406\u7684\u6587\u4ef6\u7684\u884c\u6570\uff0c\u5982\u679c\u6709\u591a\u4e2a\u6587\u4ef6\uff0c\u8fd9\u4e2a\u6570\u76ee\u4f1a\u5c06\u5904\u7406\u7684\u591a\u4e2a\u6587\u4ef6\u8ba1\u6570</li> <li>NF:number of field,\u5f53\u524d\u8bb0\u5f55\u7684field\u4e2a\u6570</li> </ul> <pre><code>{print NF},{print $NF}\n</code></pre> <ul> <li> <p>ARGV:\u6570\u7ec4\uff0c\u4fdd\u5b58\u547d\u4ee4\u884c\u672c\u8eab\u8fd9\u4e2a\u5b57\u7b26\u4e32</p> </li> <li> <p>ARGC\uff1aawk\u547d\u4ee4\u7684\u53c2\u6570\u4e2a\u6570</p> </li> <li> <p>FILENAME:awk\u547d\u4ee4\u5904\u7406\u7684\u6587\u4ef6\u540d\u79f0</p> </li> <li> <p>ENVIRON\uff1a\u5f53\u524dshell\u73af\u5883\u53d8\u91cf\u53ca\u5176\u503c\u7684\u5173\u8054\u6570\u7ec4 <pre><code>awk 'BEGIN{print ENVIRON[\"PATH\"]}'\n</code></pre></p> </li> </ul> </li> <li> <p>\u81ea\u5b9a\u4e49\u53d8\u91cf     <code>-v var=value</code></p> <p>\u53d8\u91cf\u540d\u533a\u5206\u5927\u5c0f\u5199\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]#  awk -v test=\"abc\" 'BEGIN{print test}'\nabc\n[root@master ~]# awk 'BEGIN{var=\"name\";print var}'\nname\n</code></pre> </li> <li> <p>\u7b97\u672f\u8fd0\u7b97</p> <ul> <li>+,-,*,/,^,%\u3002\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@master ~]# awk 'BEGIN{a=5;b=3;print \"a + b =\",a+b}'\na + b = 8\n</code></pre> </li> <li> <p>\u5b57\u7b26\u4e32\u64cd\u4f5c</p> <ul> <li>\u65e0\u7b26\u53f7\u64cd\u4f5c\u7b26\uff0c\u8868\u793a\u5b57\u7b26\u4e32\u8fde\u63a5\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@master ~]# awk 'BEGIN { str1=\"Hello,\"; str2=\"World\"; str3 = str1 str2; print str3 }'\nHello,World\n</code></pre> </li> <li> <p>\u8d4b\u503c\u64cd\u4f5c\u7b26\uff1a</p> <ul> <li>=\uff0c+=\uff0c-=\uff0c*=\uff0c/=\uff0c%=\uff0c^=\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@master ~]# awk 'BEGIN{a=5;b=6;if(a == b) print \"a == b\";else print \"a!=b\"}' a!=b\n[root@master ~]# awk -F: '{sum+=$3}END{print sum}' /etc/passwd\n72349\n</code></pre> </li> <li> <p>\u6bd4\u8f83\u64cd\u4f5c\u7b26\uff1a</p> <ul> <li>&gt;,&gt;=,&lt;,&lt;=,!=,==</li> </ul> </li> <li> <p>\u6a21\u5f0f\u5339\u914d\u7b26\uff1a</p> <ul> <li>~:\u662f\u5426\u5339\u914d</li> <li>!~:\u662f\u5426\u4e0d\u5339\u914d</li> </ul> <p>\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# awk -F: '$1~\"root\"{print $0}' /etc/passwd\nroot:x:0:0:root:/root:/bin/bash\n</code></pre> </li> <li> <p>\u903b\u8f91\u64cd\u4f5c\u7b26\uff1a</p> <ul> <li>&amp;&amp; \u3001 || \u3001 \uff01\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@master ~]# awk 'BEGIN{a=6;if(a &gt; 0 &amp;&amp; a &lt;= 6) print \"true\";else print \"false\"}'\ntrue\n</code></pre> </li> <li> <p>\u51fd\u6570\u8c03\u7528\uff1a</p> <ul> <li>function_name(argu1,augu2)</li> </ul> </li> <li> <p>\u6761\u4ef6\u8868\u8fbe\u5f0f(\u4e09\u5143\u8fd0\u7b97):</p> <ul> <li>selection\uff1fif-true-expresssion\uff1aif-false-expression</li> </ul> <pre><code>[root@master ~]# awk -F: '{$3&gt;=100?usertype=\"common user\":usertype=\"sysadmin\";printf \"%15s:%s\\n\",$1,usertype}' /etc/passwd\nroot:sysadmin\nbin:sysadmin\ndaemon:sysadmin\nadm:sysadmin\nlp:sysadmin\nsync:sysadmin\nshutdown:sysadmin\nhalt:sysadmin\n</code></pre> </li> </ul>"},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/#433-\u64cd\u4f5c\u7b26","title":"4.3.3 \u64cd\u4f5c\u7b26","text":""},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/#434-pattern","title":"4.3.4 Pattern","text":"<ul> <li>empty:\u7a7a\u6a21\u5f0f\uff0c\u5339\u914d\u6bcf\u4e00\u884c</li> <li> <p>/regular expression/:\u4ec5\u5904\u7406\u80fd\u88ab\u6b64\u5904\u6a21\u5f0f\u5339\u914d\u5230\u7684\u884c\uff0c\u4f8b\u5982\uff1b <pre><code>[root@master ~]# awk -F: '$NF==\"/bin/bash\"{printf \"%15s,%s\\n\",$NF,$1}' /etc/passwd\n/bin/bash,root\n</code></pre></p> </li> <li> <p>relational expression\uff1a\u5173\u7cfb\u8868\u8fbe\u5f0f\uff0c\u7ed3\u679c\u4e3a\u201c\u771f\u201d\u6709\u201c\u5047\u201d\uff0c\u7ed3\u679c\u4e3a\u201c\u771f\u201d\u624d\u4f1a\u88ab\u5904\u7406\u3002</p> </li> </ul> <p>Tips\uff1a\u4f7f\u7528\u6a21\u5f0f\u9700\u8981\u4f7f\u7528\u53cc\u659c\u7ebf\u62ec\u8d77\u6765\uff0c\u771f\uff1a\u7ed3\u679c\u4e3a\u975e0\u503c\uff0c\u975e\u7a7a\u5b57\u7b26\u4e32\u3002</p> <pre><code>[root@master ~]# awk -F: '$3&gt;100{print $1,$3}' /etc/passwd\nsystemd-network 192\npolkitd 999\nceph 167\nkube 998\netcd 997\ngluster 996\nnfsnobody 65534\nchrony 995\nredis 994\n</code></pre> <p><pre><code>awk -F: '$NF==\"/bin/bash\"{printf \"%15s,%s\\n\",$NF,$1}' /etc/passwd\n</code></pre> <pre><code>awk -F: '$NF~/bash$/{printf \"%15s,%s\\n\",$NF,$1}' /etc/passwd\n</code></pre> <pre><code>df -Th|awk '/^\\/dev/{print}'\n</code></pre></p> <ul> <li> <p>line ranges\uff1a\u884c\u8303\u56f4\uff0c\u5236\u5b9astartline\uff0cendline\u3002</p> <pre><code>[root@master ~]# awk -F: '/10/,/20/{print $1}' /etc/passwd\ngames\nftp\nnobody\nsystemd-network\ndbus\npolkitd\npostfix\nsshd\nceph\nkube\netcd\ngluster\nrpc\n</code></pre> </li> <li> <p>BEGIN/END\u6a21\u5f0f</p> <ul> <li>BEGIN{}\uff1a\u4ec5\u5728\u5f00\u59cb\u5904\u7406\u6587\u672c\u4e4b\u524d\u6267\u884c\u4e00\u6b21</li> <li>END{}\uff1a\u4ec5\u5728\u6587\u672c\u5904\u7406\u5b8c\u6210\u4e4b\u540e\u6267\u884c\u4e00\u6b21</li> </ul> </li> </ul> <pre><code>    [root@master ~]# awk -F: 'BEGIN{print \"username     uid\\n--------------------\"}{printf \"%-15s:%d\\n\",$1,$3}END{print \"-----------------\\nend\"}' /etc/passwd\nusername     uid\n--------------------\nroot           :0\nbin            :1\ndaemon         :2\nadm            :3\nlp             :4\nrpc            :32\nrpcuser        :29\nnfsnobody      :65534\nchrony         :995\nredis          :994\n-----------------\nend\n</code></pre>"},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/#435-\u63a7\u5236\u8bed\u53e5","title":"4.3.5 \u63a7\u5236\u8bed\u53e5","text":"<ul> <li>if(condition) {statements}\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@master ~]# awk -F: '{if($3&gt;100) print $1,$3}' /etc/passwd\nsystemd-network 192\npolkitd 999\nceph 167\nkube 998\netcd 997\ngluster 996\nnfsnobody 65534\nchrony 995\nredis 994\n</code></pre> <ul> <li>if(condition) {statments} [else {statments}]\uff0c\u4f8b\u5982\uff1a</li> </ul> <pre><code>[root@master ~]# awk -F: '{if($3&gt;100) {printf \"Common user:%-15s\\n\",$1} else {printf \"sysadmin user:%-15s\\n\",$1}}' /etc/passwd\nsysadmin user:root           sysadmin user:bin            sysadmin user:daemon         sysadmin user:adm            sysadmin user:lp             sysadmin user:sync           sysadmin user:shutdown       sysadmin user:halt           sysadmin user:mail           sysadmin user:operator       sysadmin user:games          </code></pre>"},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/#5-\u5b9e\u4f8b","title":"5 \u5b9e\u4f8b","text":"<pre><code>1.\u7edf\u8ba1/etc/fstab\u6587\u4ef6\u4e2d\u6bcf\u4e2a\u5355\u8bcd\u51fa\u73b0\u7684\u6b21\u6570\uff0c\u5e76\u6309\u4ece\u5927\u5230\u5c0f\u6392\u5e8f\nawk '{for(i=1;i&lt;=NF;i++){words[$i]++}}END{for(key in words)print key,words[key]}' /etc/fstab|sort -k2 -nr\nawk '{ips[$1]++}END{for(i in ips) print i,ips[i]}' access_nginx.log |column -t|sort -k2 -nr\n2.\u7edf\u8ba1/etc/fstab\u6bcf\u4e2a\u6587\u4ef6\u7cfb\u7edf\u7c7b\u578b\u51fa\u73b0\u7684\u6b21\u6570\nawk '!/^#/&amp;&amp;!/^$/{dev[$3]++}END{for(i in dev) print i,dev[i]}' /etc/fstab\n3.ping\u4e00\u4e2a\u57df\u540d\uff0c\u8f93\u51faping\u6b64\u523b\u7684\u65f6\u95f4\nping baidu.com|awk '{print $0\" \"strftime(\"%Y-%m-%d %H:%M:%S\")}'\n4.\u5229\u7528netstat\u76d1\u63a7\u670d\u52a1\u662f\u5426\u6b63\u5e38\u76d1\u542c\nnetstat -lntup|awk 'NR&gt;2{if($4 ~/.*:22/) print $0\"yes\";exit 0}'\n5.\u7edf\u8ba1web\u670d\u52a1\u5668\u65e5\u5fd7\u72b6\u6001\u7801\nawk '$9~\"[0-9]\"{stat[$9]++}END{for(i in stat) print i,stat[i]}' access_log\n</code></pre>"},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/#6-\u6ce8\u610f\u4e8b\u9879","title":"6 \u6ce8\u610f\u4e8b\u9879","text":"<ul> <li> <p><code>awk</code>\u540c<code>sed</code>\u547d\u4ee4\u7c7b\u4f3c\uff0c\u53ea\u4e0d\u8fc7<code>sed</code>\u64c5\u957f\u53d6\u884c\uff0c<code>awk</code>\u547d\u4ee4\u64c5\u957f\u53d6\u5217\uff0cawk\u662f\u5bf9\u6587\u672c\u8fdb\u884c\u683c\u5f0f\u5316\u8f93\u51fa\uff0csed\u66f4\u503e\u5411\u4e8e\u5bf9\u6587\u4ef6\u8fdb\u884c\u4fee\u6539\u3002</p> </li> <li> <p>\u5bf9\u4e8e\u8bfb\u5165\u7684\u6587\u4ef6\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u9700\u6c42\u5bf9IFS/OFS\u5bf9\u8f93\u5165\u548c\u8f93\u51fa\u8fdb\u884c\u4fee\u6539\u3002</p> </li> <li> <p>awk\u975e\u5e38\u7684\u5f3a\u5927\uff0c\u4f46\u662f\u4e5f\u662f\u4e09\u5251\u5ba2\u4e2d\u6700\u96be\u7684\u4e00\u4e2a\uff0c\u5176\u4f5c\u4e3a\u4e00\u95e8\u5355\u72ec\u7684\u8bed\u8a00\uff0c\u6211\u4eec\u5728Shell\u7f16\u7a0b\u4e2d\u5b66\u4e60\u5e38\u7528\u7684\u547d\u4ee4\u53ca\u8bed\u6cd5\u5c31\u5df2\u7ecf\u8db3\u591f\u6211\u4eec\u4f7f\u7528\u3002</p> </li> </ul>"},{"location":"Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/#7-\u5c0f\u7ed3","title":"7 \u5c0f\u7ed3","text":"<p>\u672c\u7ae0\u8282\u6211\u4eec\u7cfb\u7edf\u6027\u7684\u5b66\u4e60\u4e86awk\u7684\u8bed\u6cd5\u7ed3\u6784\u53ca\u5904\u7406\u6a21\u5f0f\uff0c\u5176\u76f8\u8f83\u4e8e\u5176\u4ed6\u6587\u672c\u5904\u7406\u5de5\u5177\uff0c\u66f4\u9002\u5408\u5bf9\u6587\u672c\u8fdb\u884c\u683c\u5f0f\u5316\u8f93\u51fa\uff0c\u6211\u4eec\u9700\u8981\u5728\u5408\u9002\u7684\u5730\u65b9\u4f7f\u7528\uff0c\u5176\u4f5c\u4e3aLinux\u7cfb\u7edf\u4e0a\u4e00\u4e2a\u975e\u5e38\u5f3a\u5927\u7684\u6587\u672c\u683c\u5f0f\u8f93\u51fa\u5de5\u5177\uff0c\u4e5f\u662f\u4e00\u95e8\u8bed\u8a00\uff0c\u540e\u671f\u9700\u8981\u5728\u5b9e\u8df5\u5de5\u4f5c\u4e2d\u66f4\u591a\u7684\u7075\u6d3b\u8fd0\u7528\uff0c\u4f7f\u5f97\u811a\u672c\u7f16\u5199\u66f4\u52a0\u65b9\u4fbf\u3002</p>"},{"location":"Linux/shell/15.Shell%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/","title":"15.Shell\u5e38\u7528\u5de5\u5177","text":"<p>Linux\u4e2d\u6709\u5f88\u591a\u975e\u5e38\u5b9e\u7528\u7684\u5de5\u5177\u6216\u547d\u4ee4\uff0c\u7075\u6d3b\u8fd0\u7528\u8fd9\u4e9b\u5de5\u5177\uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u5728Shell\u7f16\u7a0b\u4e2d\u5316\u7e41\u4e3a\u7b80\uff0c\u5982\u864e\u6dfb\u7ffc\u3002\u53ef\u80fd\u4e00\u4e2a\u5de5\u5177\u6216\u547d\u4ee4\u5c31\u80fd\u8ba9\u539f\u672c\u8d1f\u8d23\u7684\u95ee\u9898\u5feb\u901f\u89e3\u51b3\uff0c\u672c\u7ae0\u8282\u6211\u4eec\u6765\u4e00\u8d77\u4e30\u5bcc\u6211\u4eec\u7684\u5de5\u5177\u5e93\uff0c\u65e5\u5e38\u53ef\u4ee5\u591a\u79ef\u7d2f\u603b\u7ed3\uff0c\u5e2e\u52a9\u6211\u4eec\u66f4\u597d\u7684\u7f16\u5199Shell\u3002</p>"},{"location":"Linux/shell/15.Shell%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/#1-sort","title":"1. sort","text":"<p>\u7b80\u4ecb\uff1a\u987e\u540d\u601d\u4e49\uff0c\u5c31\u662f\u7528\u6765\u6392\u5e8f\u7684\u5de5\u5177\uff0c\u5728\u6211\u4eec\u65e5\u5e38\u5de5\u4f5c\u4e2d\u5bf9\u4e8e\u91cd\u590d\u5217\u7684\u591a\u884c\u8f93\u51fa\uff0c\u5982\u679c\u60f3\u8981\u5bf9\u5185\u5bb9\u6309\u7167\u7279\u5b9a\u89c4\u5219\u6392\u5e8f\uff0c\u6b64\u65f6\u5c31\u7528\u5230\u4e86sort\u5de5\u5177\u3002</p> <p>\u539f\u7406\uff1asort \u5c06\u6587\u4ef6\u7684\u6bcf\u4e00\u884c\u4f5c\u4e3a\u4e00\u4e2a\u5355\u4f4d\uff0c\u76f8\u4e92\u6bd4\u8f83\uff0c\u6bd4\u8f83\u539f\u5219\u9ed8\u8ba4\u60c5\u51b5\u662f\u4ece\u9996\u5b57\u7b26\u5411\u540e\uff0c\u4f9d\u6b21\u6309 ASCII \u7801\u503c\u8fdb\u884c\u6bd4\u8f83\uff0c \u540e\u5c06\u4ed6\u4eec\u6309\u5347\u5e8f\u8f93\u51fa\u3002</p> <p>\u8bed\u6cd5\uff1a<code>sort [OPTION]... [FILE]\u2026</code></p> <p>\u9009\u9879\u8bf4\u660e\uff1a</p> <ul> <li>-t\uff1a\u6307\u5b9a\u4ee5\u4ec0\u4e48\u4f5c\u4e3a\u5217\u5206\u5272</li> <li>-k\uff1a\u7528\u6765\u5236\u5b9a\u5229\u7528\u90a3\u5217\u8fdb\u884c\u6392\u5e8f\uff0c\u901a\u5e38<code>-t</code>\u4e8e<code>-k</code>\u914d\u5408\u4f7f\u7528</li> <li>-r\uff1a\u5c06\u6587\u672c\u6587\u4ef6\u964d\u5e8f\u8f93\u51fa</li> <li>-n\uff1a\u4ee5\u6570\u7ec4\u6765\u8fdb\u884c\u751f\u5e8f\u6392\u5e8f</li> <li>-f\uff1a\u5ffd\u7565\u5927\u5c0f\u5199\u5b57\u6bcd</li> <li>-u\uff1a\u53d6\u6d88\u91cd\u590d\u7684\u884c</li> </ul> <p>\u5728\u6b64\u6211\u4eec\u4e0d\u5168\u90e8\u5c55\u5f00\u8d77\u6240\u6709\u9009\u9879\uff0c\u53ea\u6839\u636e\u65e5\u5e38\u7ecf\u9a8c\u7ed3\u5408\u5b9e\u9645\u6848\u4f8b\u5217\u4e3e\u6700\u5e38\u7528\u7684\u9009\u9879\u8fdb\u884c\u8bf4\u660e\u3002</p> <p>\u5b9e\u4f8b\uff1a</p> <ul> <li>\u5bf9/etc/passwd\u4e2d\u4ee5uid\u4ece\u5927\u5230\u5c0f\u6392\u5e8f</li> </ul> <pre><code>[root@10-234-1-235 ~]# sort -t: -k3 -n -r /etc/passwd\nsaslauth:x:499:76:Saslauthd user:/var/empty/saslauth:/sbin/nologin\ngitlab-www:x:498:497::/var/opt/gitlab/nginx:/bin/false\ngit:x:497:496::/var/opt/gitlab:/bin/sh\ngitlab-redis:x:496:495::/var/opt/gitlab/redis:/bin/false\ngitlab-psql:x:495:494::/var/opt/gitlab/postgresql:/bin/sh\ngitlab-prometheus:x:494:493::/var/opt/gitlab/prometheus:/bin/sh\nmongod:x:493:492:mongod:/var/lib/mongo:/bin/false\nnobody:x:99:99:Nobody:/:/sbin/nologin\npostfix:x:89:89::/var/spool/postfix:/sbin/nologin\ndbus:x:81:81:System message bus:/:/sbin/nologin\nsshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin\nvcsa:x:69:69:virtual console memory owner:/dev:/sbin/nologin\napache:x:48:48:Apache:/var/www:/sbin/nologin\nftp:x:14:50:FTP User:/var/ftp:/sbin/nologin\ngopher:x:13:30:gopher:/var/gopher:/sbin/nologin\ngames:x:12:100:games:/usr/games:/sbin/nologin\noperator:x:11:0:operator:/root:/sbin/nologin\nuucp:x:10:14:uucp:/var/spool/uucp:/sbin/nologin\nmail:x:8:12:mail:/var/spool/mail:/sbin/nologin\nhalt:x:7:0:halt:/sbin:/sbin/halt\nshutdown:x:6:0:shutdown:/sbin:/sbin/shutdown\nsync:x:5:0:sync:/sbin:/bin/sync\nlp:x:4:7:lp:/var/spool/lpd:/sbin/nologin\nadm:x:3:4:adm:/var/adm:/sbin/nologin\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\nbin:x:1:1:bin:/bin:/sbin/nologin\nroot:x:0:0:root:/root:/bin/bash\n</code></pre> <p>\u901a\u8fc7\u4e0a\u4f8b\u53ef\u4ee5\u770b\u5230\uff0c\u5229\u7528<code>-t</code>\u9009\u9879\u6307\u5b9a/etc/passwd\u6587\u4ef6\u4e2d\uff0c\u4ee5<code>:</code>\u4f5c\u4e3a\u5217\u8fdb\u884c\u5206\u5272\uff0c\u6307\u5b9auid\u7684\u5217\u4e3a<code>k3</code>\uff0c-n\u4ee5\u6570\u5b57\u8fdb\u884c\u6392\u5e8f\uff0c<code>-r</code>\u4e3a\u5012\u5e8f\u6392\u5e8f\u8f93\u51fa\u3002</p>"},{"location":"Linux/shell/15.Shell%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/#2-uniq","title":"2. uniq","text":"<p>\u7b80\u4ecb\uff1a\u5bf9\u4e8e\u4e00\u4e9b\u91cd\u590d\u8f93\u51fa\u7684\u884c\u8fdb\u884c\u53bb\u91cd\u3002</p> <p>\u8bed\u6cd5\uff1a<code>uniq [OPTION]... [INPUT [OUTPUT]]</code></p> <p>\u9009\u9879\u8bf4\u660e\uff1a</p> <ul> <li> <p>-c\uff1a \u6253\u5370\u51fa\u73b0\u7684\u6b21\u6570\uff0c\u53ea\u80fd\u7edf\u8ba1\u76f8\u90bb\u7684\u3002</p> </li> <li> <p>-d\uff1a \u53ea\u6253\u5370\u91cd\u590d\u884c\u3002</p> </li> <li> <p>-u\uff1a \u53ea\u6253\u5370\u4e0d\u91cd\u590d\u884c\u3002</p> </li> <li> <p>-D\uff1a \u53ea\u6253\u5370\u91cd\u590d\u884c\uff0c\u5e76\u4e14\u628a\u6240\u6709\u91cd\u590d\u884c\u6253\u5370\u51fa\u6765\u3002</p> </li> </ul> <p>\u5b9e\u4f8b\uff1a</p> <ul> <li>\u5bf9/etc/passwd\u4e2d\u4ee5<code>:</code>\uff0c\u5bf9\u6700\u540e\u4e00\u5217\u6c42\u51fa\u73b0\u7684\u6b21\u6570</li> </ul> <pre><code>[root@master ~]# awk -F\":\" '{print $NF}' /etc/passwd\n/bin/bash\n/sbin/nologin\n/sbin/nologin\n/sbin/nologin\n/sbin/nologin\n/bin/sync\n/sbin/shutdown\n/sbin/halt\n/sbin/nologin\n/sbin/nologin\n/sbin/nologin\n/sbin/nologin\n/sbin/nologin\n/sbin/nologin\n/sbin/nologin\n/sbin/nologin\n/sbin/nologin\n/sbin/nologin\n/sbin/nologin\n/sbin/nologin\n/bin/nologin\n/sbin/nologin\n/sbin/nologin\n/sbin/nologin\n/sbin/nologin\n/sbin/nologin\n/sbin/nologin\n[root@master ~]# awk -F\":\" '{print $NF}' /etc/passwd |sort |uniq -c |sort -nr\n22 /sbin/nologin\n1 /sbin/shutdown\n1 /sbin/halt\n1 /bin/sync\n1 /bin/nologin\n1 /bin/bash\n</code></pre> <p>\u5148\u5229\u7528awk\u6253\u5370\u51fa\u6700\u540e\u4e00\u5217\u5185\u5bb9\uff0c\u4e4b\u540e\u5229\u7528sort \u6765\u8fdb\u884c\u6392\u5e8f\uff0c\u5c06\u76f8\u540c\u7684\u5b57\u7b26\u89c4\u5728\u4e00\u8d77\u8f93\u51fa\uff0c\u6700\u540e\u5bf9\u76f8\u540c\u7684\u884c\u8fdb\u884c\u53bb\u91cd\uff0c\u5f97\u51fa\u6bcf\u79cd\u4e0d\u540c\u7c7b\u578bshell\u51fa\u73b0\u7684\u6b21\u6570\uff0c\u6700\u540e\u5bf9\u6570\u5b66\u4ece\u5927\u5230\u5c0f\u6392\u5e8f\u3002</p>"},{"location":"Linux/shell/15.Shell%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/#3-find","title":"3. find","text":"<p>\u7b80\u4ecb\uff1a\u987e\u540d\u601d\u4e49\uff0c\u5c31\u662f\u7528\u6765\u5728\u7cfb\u7edf\u4e2d\u67e5\u627e\u6587\u4ef6\u7684\u5de5\u5177\uff0c\u53ef\u4ee5\u6307\u5b9a\u4e00\u4e2a\u57fa\u7840\u8d77\u59cb\u76ee\u5f55\uff0c\u6839\u636e\u4e0d\u540c\u7684\u9009\u9879\u67e5\u627e\u4e0d\u540c\u7684\u6587\u4ef6\u3002</p> <p>\u8bed\u6cd5\uff1a<code>find   path   -option   [   -print ]   [ -exec   -ok   command ]   {} \\;</code></p> <p>\u539f\u7406\uff1afind \u6839\u636eoption\u5728\u6307\u5b9a\u7684\u7cfb\u7edf\u8def\u5f84\u4e2d\u67e5\u627e\u6587\u4ef6\uff0c\u5982\u679c\u67e5\u627e\u5230\u4e0e\u5bf9\u5e94\u7684exec\u547d\u4ee4\uff0c\u5219\u6267\u884c\u5bf9\u5e94\u7684command\u3002</p> <p>-print\uff1a find \u547d\u4ee4\u5c06\u5339\u914d\u7684\u6587\u4ef6\u8f93\u51fa\u5230\u6807\u51c6\u8f93\u51fa\uff1b -exec\uff1a find \u547d\u4ee4\u5bf9\u5339\u914d\u7684\u6587\u4ef6\u6267\u884c\u8be5\u53c2\u6570\u6240\u7ed9\u51fa\u7684 shell \u547d\u4ee4\u3002\u76f8\u5e94\u547d\u4ee4\u7684\u5f62\u5f0f\u4e3a 'command' {} \\;\uff0c\u6ce8\u610f {} \u548c \\\uff1b\u4e4b\u95f4\u7684\u7a7a\u683c\uff1b -ok\uff1a \u548c - exec \u7684\u4f5c\u7528\u76f8\u540c\uff0c\u53ea\u4e0d\u8fc7\u4ee5\u4e00\u79cd\u66f4\u4e3a\u5b89\u5168\u7684\u6a21\u5f0f\u6765\u6267\u884c\u8be5\u53c2\u6570\u6240\u7ed9\u51fa\u7684 shell \u547d\u4ee4\uff0c\u5728\u6267\u884c\u6bcf\u4e00\u4e2a\u547d\u4ee4\u4e4b\u524d\uff0c\u90fd\u4f1a\u7ed9\u51fa\u63d0\u793a\uff0c\u8ba9\u7528\u6237\u6765\u786e\u5b9a\u662f\u5426\u6267\u884c\uff1b</p> <p>\u9009\u9879\u8bf4\u660e\uff1a</p> <pre><code>- -name   filename               #\u67e5\u627e\u540d\u4e3a filename \u7684\u6587\u4ef6\n- -perm                          #\u6309\u6267\u884c\u6743\u9650\u6765\u67e5\u627e\n- -user    username              #\u6309\u6587\u4ef6\u5c5e\u4e3b\u6765\u67e5\u627e\n- -group groupname               #\u6309\u7ec4\u6765\u67e5\u627e\n- -mtime   -n +n                 #\u6309\u6587\u4ef6\u66f4\u6539\u65f6\u95f4\u6765\u67e5\u627e\u6587\u4ef6\uff0c-n \u6307 n \u5929\u4ee5\u5185\uff0c+n \u6307 n \u5929\u4ee5\u524d\n- -atime    -n +n                #\u6309\u6587\u4ef6\u8bbf\u95ee\u65f6\u95f4\u6765\u67e5 GIN: 0px\"&gt;\n- -ctime    -n +n                #\u6309\u6587\u4ef6\u521b\u5efa\u65f6\u95f4\u6765\u67e5\u627e\u6587\u4ef6\uff0c-n \u6307 n \u5929\u4ee5\u5185\uff0c+n \u6307 n \u5929\u4ee5\u524d\n- -type    b/d/c/p/l/f           #\u67e5\u662f\u5757\u8bbe\u5907\u3001\u76ee\u5f55\u3001\u5b57\u7b26\u8bbe\u5907\u3001\u7ba1\u9053\u3001\u7b26\u53f7\u94fe\u63a5\u3001\u666e\u901a\u6587\u4ef6\n- -size      n [c]               #\u67e5\u957f\u5ea6\u4e3a n \u5757 [\u6216 n \u5b57\u8282] \u7684\u6587\u4ef6\n- -depth                         #\u4f7f\u67e5\u627e\u5728\u8fdb\u5165\u5b50\u76ee\u5f55\u524d\u5148\u884c\u67e5\u627e\u5b8c\u672c\u76ee\u5f55\n- -prune\u3000\u3000                      #\u901a\u5e38\u548c -path \u4e00\u8d77\u4f7f\u7528\uff0c\u7528\u4e8e\u5c06\u7279\u5b9a\u76ee\u5f55\u6392\u9664\u5728\u641c\u7d22\u6761\u4ef6\u4e4b\u5916\u3002\u8fc7\u6ee4\u6761\u4ef6\u5199\u5728\u5176\u4ed6\u6761\u4ef6\u524d\u9762\u3002\n</code></pre> <p>\u5728\u6b64\u6211\u4eec\u5bf9\u547d\u4ee4\u652f\u6301\u7684\u9009\u9879\u5168\u90e8\u5c55\u5f00\u8be6\u89e3\uff0c\u6839\u636e\u65e5\u5e38\u7ecf\u9a8c\u7ed3\u5408\u5b9e\u9645\u6848\u4f8b\u5217\u4e3e\u6700\u5e38\u7528\u7684\u9009\u9879\u8fdb\u884c\u8bf4\u660e\uff1a</p> <p>\u5b9e\u4f8b:</p> <ul> <li>\u5728\u5f53\u524d\u76ee\u5f55\u5bfb\u627e\u6587\u4ef6\u540d\u79f0\u4ee5<code>.txt</code>\u7ed3\u5c3e\u7684\u6587\u4ef6\u5e76\u6253\u5370\u51fa\u6765</li> </ul> <pre><code>[root@master ~]# find   ~   -name   \"*.txt\"   -print /root/kubesphere-all-advanced-2.0.2/scripts/os/requirements.txt\n/root/kubesphere-all-advanced-2.0.2/kubesphere/roles/storages/NFS-Server/files/nfs-server-provisioner/templates/NOTES.txt\n/root/kubesphere-all-advanced-2.0.2/kubesphere/roles/ks-devops/jenkins/files/jenkins/jenkins-update-center/templates/NOTES.txt\n/root/kubesphere-all-advanced-2.0.2/kubesphere/roles/ks-devops/harbor/files/harbor/harbor/templates/NOTES.txt\n/root/kubesphere-all-advanced-2.0.2/kubesphere/roles/metrics-server/files/metrics-server/templates/NOTES.txt\n/root/kubesphere-all-advanced-2.0.2/kubesphere/roles/openpitrix/files/openpitrix/kubernetes/password.txt\n</code></pre> <ul> <li>\u67e5\u627e/usr/bin\u76ee\u5f55\u4e0b\u5927\u4e8e10M\u7684\u6587\u4ef6</li> </ul> <pre><code>[root@master ~]# find /usr/bin -size +10000k -exec ls -ld {} \\; -rwxr-xr-x. 1 root root 13606800 Jul 10  2018 /usr/bin/ceph-dencoder\n-rwxr-xr-x. 1 root root 15863688 Jul 10  2018 /usr/bin/ceph-objectstore-tool\n-rwxr-xr-x. 1 root root 15589080 Jul 10  2018 /usr/bin/ceph-osd\n-rwxr-xr-x. 1 root root 33073928 Feb 10  2019 /usr/bin/docker\n-rwxr-xr-x. 1 root root 38088856 Feb 10  2019 /usr/bin/docker-containerd\n-rwxr-xr-x. 1 root root 68608416 Feb 10  2019 /usr/bin/dockerd\n-rwxr-xr-x. 1 root root 20895160 Feb 10  2019 /usr/bin/docker-containerd-ctr\n-rwxr-xr-x. 1 root root 10785264 Jul 10  2018 /usr/bin/ceph-mon\n</code></pre> <ul> <li>\u67e5\u627e\u5f53\u524d\u76ee\u5f55\u4e0b\u6743\u9650\u4e3a777\u7684\u6587\u4ef6</li> </ul> <pre><code>[root@master ~]# find . -perm 777 -print   ./.helm/repository/cache/local-index.yaml\n./kubesphere-all-v2.1.0/k8s/extra_playbooks/inventory\n./kubesphere-all-v2.1.0/k8s/extra_playbooks/roles\n./kubesphere-all-v2.1.0/k8s/contrib/terraform/openstack/hosts\n</code></pre>"},{"location":"Linux/shell/15.Shell%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/#4-date","title":"4. date","text":"<p>\u5728\u6211\u4eec\u7f16\u5199Shell\u7684\u65f6\u5019\u7ecf\u5e38\u9047\u5230\u9700\u8981\u8bb0\u5f55\u65e5\u5fd7\u7684\u60c5\u51b5\uff0c\u5728\u8bb0\u5f55\u65e5\u5fd7\u7684\u65f6\u5019\u9700\u8981\u6253\u4e0a\u65f6\u95f4\u6233\uff0c\u4ee5\u4fbf\u540e\u671f\u67e5\u770b\u90a3\u4e2a\u65f6\u95f4\u8282\u70b9\u8fd0\u884c\u6267\u884c\u7684\u64cd\u4f5c\uff0c\u6b64\u65f6\u5c31\u9700\u8981\u7528\u5230date\u547d\u4ee4</p> <p>\u7b80\u4ecb\uff1adate \u53ef\u4ee5\u7528\u6765\u663e\u793a\u6216\u8bbe\u5b9a\u7cfb\u7edf\u7684\u65e5\u671f\u4e0e\u65f6\u95f4\u3002</p> <p>\u9009\u9879\uff1a</p> <pre><code>-d&lt;\u5b57\u7b26\u4e32&gt;\uff1a\u663e\u793a\u5b57\u7b26\u4e32\u6240\u6307\u7684\u65e5\u671f\u4e0e\u65f6\u95f4\u3002\u5b57\u7b26\u4e32\u524d\u540e\u5fc5\u987b\u52a0\u4e0a\u53cc\u5f15\u53f7\uff1b -s&lt;\u5b57\u7b26\u4e32&gt;\uff1a\u6839\u636e\u5b57\u7b26\u4e32\u6765\u8bbe\u7f6e\u65e5\u671f\u4e0e\u65f6\u95f4\u3002\u5b57\u7b26\u4e32\u524d\u540e\u5fc5\u987b\u52a0\u4e0a\u53cc\u5f15\u53f7\uff1b -u\uff1a\u663e\u793aGMT\uff1b </code></pre> <p>\u65f6\u95f4\u683c\u5f0f\uff1a</p> <pre><code>%Y -- \u5e74\u4efd\n%m -- \u6708\u4efd\n%d -- \u5f53\u6708\u7b2c\u51e0\u5929\n%t -- Tab \u8df3\u683c\n%H -- \u5c0f\u65f6\uff0c24 \u5c0f\u65f6\u683c\u5f0f (0~23)\n%I -- \u5c0f\u65f6\uff0c12 \u5c0f\u65f6\u683c\u5f0f (0~12)\n%M -- \u5206\u949f (00~59)\n%S -- \u79d2 (00~59)\n%j -- \u4eca\u5e74\u4e2d\u7684\u7b2c\u51e0\u5929\n%Z -- \u4ee5\u5b57\u7b26\u4e32\u5f62\u5f0f\u8f93\u51fa\u5f53\u524d\u65f6\u533a\n%z -- \u4ee5\u6570\u5b57\u5f62\u5f0f\u8f93\u51fa\u5f53\u524d\u65f6\u533a\n%F --  \u6587\u4ef6\u65f6\u95f4\u683c\u5f0f same as % Y-% m-% d\n%T -- 24 \u5c0f\u65f6\u5236\u65f6\u95f4\u8868\u793a (hh:mm:ss)\n</code></pre> <ul> <li>\u5b9e\u4f8b</li> </ul> <p>\u8ba1\u7b97\u4e00\u4e2a\u547d\u4ee4\u6267\u884c\u6240\u9700\u8981\u7684\u8017\u65f6</p> <pre><code>#!/bin/bash \nstart=$(date +%s) echo \"$(date +%F\" \"%T) \u5f00\u59cb\u6267\u884c\u547d\u4ee4\"\nsleep 5\necho \"$(date +%F\" \"%T) \u6267\u884c\u547d\u4ee4\u5b8c\u6210\"\nend=$(date +%s) difference=$(( end - start )) echo \"\u6267\u884c\u547d\u4ee4\u603b\u8017\u65f6:$difference seconds.\"\n[root@master ~]# bash time.sh \n2020-04-19 10:19:58 \u5f00\u59cb\u6267\u884c\u547d\u4ee4\n2020-04-19 10:20:03 \u6267\u884c\u547d\u4ee4\u5b8c\u6210\n\u6267\u884c\u547d\u4ee4\u603b\u8017\u65f6:5 seconds.\n</code></pre>"},{"location":"Linux/shell/15.Shell%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/#5-xargs","title":"5. xargs","text":"<p>\u7b80\u4ecb\uff1axargs \u5168\u79f0\u662f transform arguments\uff0c\u610f\u4e3a\u8f6c\u6362\u53c2\u6570\uff0c\u5b83\u5c06\u6807\u51c6\u8f93\u5165\u8f6c\u6362\u4e3a\u547d\u4ee4\u884c\u53c2\u6570\u3002\u56e0\u4e3a linux \u547d\u4ee4\u884c\u4e2d\u7ecf\u5e38\u8981\u4f7f\u7528\u5230\u7ba1\u9053\u7b26\u8fde\u63a5\u4e0d\u540c\u7684\u547d\u4ee4\uff0c\u4f46\u662f\u6709\u4e9b\u547d\u4ee4\u4e0d\u652f\u6301\u6807\u51c6\u8f93\u5165\uff0c\u6b64\u65f6\u5c31\u9700\u8981\u4f7f\u7528 xargs \u5c06\u6807\u51c6\u8f93\u5165\u8f6c\u6362\u4e3a\u53c2\u6570\uff0c</p> <p>\u8bed\u6cd5\uff1a<code>stdin_input | xargs [option] cmd</code></p> <p>\u539f\u7406\uff1axargs \u4e00\u822c\u662f\u901a\u8fc7\u7ba1\u9053\u7b26\u63a5\u53d7\u6807\u51c6\u8f93\u5165\u5e76\u5c06\u5176\u8f6c\u6362\u4e3a\u547d\u4ee4\u884c\u53c2\u6570\u4f20\u9012\u7ed9 cmd\u3002</p> <p>\u5b9e\u4f8b\uff1a</p> <ul> <li>\u5c06\u6807\u51c6\u8f93\u5165\u8f6c\u6362\u6210\u547d\u4ee4\u884c\u53c2\u6570</li> </ul> <pre><code>[root@master ~]# seq 1 6\n1\n2\n3\n4\n5\n6\n[root@master ~]# seq 1 6 |xargs -n 2\n1 2\n3 4\n5 6\n</code></pre> <ul> <li>\u5220\u9664\u65e5\u5fd7\u6587\u4ef6</li> </ul> <pre><code>ls *.log |xargs rm -r   f {} </code></pre> <ul> <li>\u67e5\u627e/home/data\u4e0b\u6743\u9650\u4e3a644\u7684\u6587\u4ef6\u4fee\u6539\u6743\u9650\u4e3a600</li> </ul> <pre><code>find /home/data -perm 644 | xargs chmod 600 </code></pre> <ul> <li>\u67e5\u627ejpg\u6587\u4ef6\u5e76\u6253\u5305</li> </ul> <pre><code>find / -name *.jpg -type f -print | xargs tar -cvzf images.tar.gz\n</code></pre>"},{"location":"Linux/shell/15.Shell%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/#6-\u5b9e\u4f8b","title":"6. \u5b9e\u4f8b","text":""},{"location":"Linux/shell/15.Shell%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/#61-\u9700\u6c42","title":"6.1 \u9700\u6c42","text":"<p>\u6211\u4eec\u7ecf\u5e38\u5728Linux\u7cfb\u7edf\u64cd\u4f5c\u64cd\u4f5c\u6587\u4ef6\uff0c\u4fd7\u8bdd\u8bf4\u5e38\u5728\u6cb3\u8fb9\u8d70\uff0c\u54ea\u6709\u4e0d\u6e7f\u978b\uff0c\u4e00\u4e0d\u5c0f\u5fc3\u5220\u9664\u91cd\u8981\u6587\u4ef6\u662f\u975e\u5e38\u5371\u9669\u7684\u3002\u6211\u4eec\u53ef\u4ee5\u5229\u7528Shell\u811a\u672c\u6765\u5236\u4f5c\u4e00\u4e2a\u7c7b\u4f3c\u4e8eWindows\u4e0b\u7684\u56de\u6536\u7ad9\uff0c\u914d\u5408\u5b9a\u65f6\u4efb\u52a1\uff0c\u5b9a\u671f\u6e05\u7406\u8fd9\u4e2a\u56de\u6536\u7ad9\u4e2d\u7684\u5185\u5bb9\uff0c\u4ece\u800c\u8fbe\u5230\u7f13\u51b2\u53ca\u89c4\u907f\u5371\u9669\u64cd\u4f5c\u3002</p>"},{"location":"Linux/shell/15.Shell%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/#62-\u601d\u8def","title":"6.2 \u601d\u8def","text":"<ul> <li>\u901a\u8fc7 alias rm \u6765\u5c06\u5220\u9664\u7684\u6587\u4ef6\uff0c\u79fb\u52a8\u6587\u4ef6\u5230\u4e00\u4e2a\u56de\u6536\u7ad9\u76ee\u5f55;</li> <li>\u5b9a\u671f\u7684\u5728\u7cfb\u7edf\u78c1\u76d8\u5141\u8bb8\u53ef\u63a7\u7684\u4f7f\u7528\u7387\u60c5\u51b5\u4e0b\uff0c\u5bf9\u56de\u6536\u7ad9\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u8fdb\u884c\u5220\u9664\u3002</li> </ul>"},{"location":"Linux/shell/15.Shell%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/#63-\u5b9e\u73b0","title":"6.3 \u5b9e\u73b0","text":"<pre><code>#!/bin/bash\n# function:\u81ea\u5b9a\u4e49rm\u547d\u4ee4\uff0c\u6bcf\u5929\u665a\u4e0a\u5b9a\u65f6\u6e05\u7406\n# \u6307\u5b9a\u53d8\u91cf\nCMD_SCRIPTS=$HOME/.rm_scripts.sh\nTRASH_DIR=$HOME/.TRASH_DIR\nCRON_FILE=/var/spool/cron/root\nBASHRC=$HOME/.bashrc\n\n[ ! -d ${TRASH_DIR} ] &amp;&amp; mkdir -p ${TRASH_DIR}\ncat &gt; $CMD_SCRIPTS &lt;&lt;EOF\nPARA_CNT=\\$#\nTRASH_DIR=$TRASH_DIR\nfor i in \\$*; do\n     DATE=\\$(date +%F%T)\n     fileName=\\$(basename \\$i)\n     mv \\$i \\$TRASH_DIR/\\$fileName.\\$DATE\ndone\nEOF\nsed -i \"s@$(grep 'alias rm=' $BASHRC)@alias rm='bash ${CMD_SCRIPTS}'@g\" $BASHRC\nsource $HOME/.bashrc\n\n# \u5236\u4f5c\u5b9a\u65f6\u6e05\u7406\u4efb\u52a1\necho \"0 0 * * * rm -rf $TRASH_DIR/*\" &gt;&gt; $CRON_FILE\necho \"\u5220\u9664\u76ee\u5f55:$TRASH_DIR\"\necho \"\u5220\u9664\u811a\u672c:$CMD_SCRIPTS\"\necho \"\u8bf7\u6267\u884c:source $BASHRC \u6765\u52a0\u8f7d\u6587\u4ef6\u6216\u9000\u51fa\u5f53\u524dshell\u91cd\u65b0\u767b\u5f55\"\n</code></pre> <p>\u5bf9\u9632\u6cbb\u8bef\u5220\u9664\u811a\u672c\u8fdb\u884c\u7cfb\u7edf\u6d4b\u8bd5\u3002</p> <pre><code>[root@10-234-1-235 ~]# bash custom_rm.sh \u5220\u9664\u76ee\u5f55:/root/.TRASH_DIR\n\u5220\u9664\u811a\u672c:/root/.rm_scripts.sh\n\u8bf7\u6267\u884c:source /root/.bashrc \u6765\u52a0\u8f7d\u6587\u4ef6\u6216\u9000\u51fa\u5f53\u524dshell\u91cd\u65b0\u767b\u5f55\n[root@10-234-1-235 ~]# rm testdir/\n[root@10-234-1-235 ~]# rm wget-log [root@10-234-1-235 ~]# ls -la .TRASH_DIR/\ntotal 16\ndrwxr-xr-x.  3 root root 4096 Apr 18 20:11 .\ndr-xr-x---. 13 root root 4096 Apr 18 20:11 ..\ndrwxr-xr-x.  2 root root 4096 Apr 18 20:10 testdir.2020-04-1820:11:37\n-rw-r--r--.  1 root root    0 Jan  9 21:59 wget-log.2020-04-1820:11:40\n# \u67e5\u770b\u5b9a\u65f6\u4efb\u52a1\n[root@10-234-1-235 ~]# crontab -l\n0 0 * * * rm -rf /root/.TRASH_DIR/*\n</code></pre>"},{"location":"Linux/shell/15.Shell%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/#7-\u5c0f\u7ed3","title":"7. \u5c0f\u7ed3","text":"<p>Shell\u7f16\u7a0b\u5c31\u662f\u5229\u7528\u5de5\u5177\u52a0\u6570\u636e\u7ed3\u6784\u6d41\u7a0b\u63a7\u5236\u5b9e\u73b0\u4e00\u7ec4\u64cd\u4f5c\uff0c\u6240\u4ee5\u638c\u63e1\u66f4\u591a\u5e38\u7528\u7684\u5de5\u5177\u6216\u547d\u4ee4\u975e\u5e38\u5229\u4e8e\u6211\u4eec\u7f16\u5199Shell\u811a\u672c\uff0c\u5e73\u65f6\u53ef\u4ee5\u591a\u5c1d\u8bd5\u5229\u7528\u5404\u79cd\u547d\u4ee4\u6216\u5de5\u5177\uff0c\u5e76\u5728Shell\u4e2d\u719f\u7ec3\u8fd0\u7528\u5b83\u4eec\uff0c\u52e4\u7ec3\u5e76\u53cd\u601d\u603b\u7ed3\uff0c\u5f52\u7eb3\u6574\u7406\uff0c\u65e5\u79ef\u6708\u7d2f\u5c31\u4f1a\u5f62\u6210\u81ea\u5df1\u5f3a\u5927\u7684\u5de5\u5177\u5e93\u3002</p>"},{"location":"Linux/shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/","title":"16.Shell\u5b9e\u6218\u9879\u76ee","text":""},{"location":"Linux/shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/#1-\u7cfb\u7edf\u5de1\u68c0","title":"1. \u7cfb\u7edf\u5de1\u68c0","text":""},{"location":"Linux/shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/#11-\u9700\u6c42","title":"1.1 \u9700\u6c42","text":"<p>\u9700\u8981\u5bf9Linux\u670d\u52a1\u5668\uff0c\u5de1\u68c0\u7cfb\u7edf/\u670d\u52a1/\u7aef\u53e3\u5404\u6307\u6807\u53ca\u53c2\u6570\uff0c\u7f16\u5199\u7cfb\u7edf\u5feb\u901f\u68c0\u67e5\u811a\u672c\uff0c\u8f93\u51fa\u7cfb\u7edf\u4fe1\u606f\u5230\u811a\u672c\u8fd0\u884c\u7684 logs \u76ee\u5f55\u4e0b\u3002</p>"},{"location":"Linux/shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/#12-\u601d\u8def","title":"1.2 \u601d\u8def","text":"<p>\u901a\u5e38\u7cfb\u7edf\u7684\u72b6\u6001\u90fd\u5728/proc/\u76ee\u5f55\u4e0b\uff0c\u5bf9\u6587\u4ef6\u4e2d\u7684\u5173\u6ce8\u7cfb\u7edf\u6307\u6807\u6570\u5b57\u8fdb\u884c\u8fc7\u6ee4\u5904\u7406\uff0c\u5f97\u5230\u7cfb\u7edf\u72b6\u6001\uff0c\u5176\u4e2d\u6d89\u53ca\u6570\u7ec4\u7684\u9700\u8981\u8ba1\u7b97\uff0c\u53ef\u4ee5\u5229\u7528\u51fd\u6570\uff0c\u5bf9\u6bcf\u4e00\u4e2a\u9700\u8981\u5de1\u68c0\u7684\u7ed3\u679c\u5229\u7528\u5355\u72ec\u4e00\u4e2a\u51fd\u6570\u7f16\u5199\uff0c\u6700\u540e\u5229\u7528main\u51fd\u6570\u8c03\u7528\u5176\u4ed6\u51fd\u6570\u5f97\u51fa\u6700\u7ec8\u7ed3\u679c\u3002</p>"},{"location":"Linux/shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/#13-\u5b9e\u73b0","title":"1.3 \u5b9e\u73b0","text":"<p>\u6838\u5fc3\u5229\u7528sed\u4ee3\u7801\uff1a</p> <pre><code>#!/bin/bash\n# auth:kaliarch\n# func:sys info check\n# version:v1.0\n# sys:centos6.x/7.x\n[ $(id -u) -gt 0 ] &amp;&amp; echo \"\u8bf7\u7528root\u7528\u6237\u6267\u884c\u6b64\u811a\u672c\uff01\" &amp;&amp; exit 1\nsysversion=$(rpm -q centos-release|cut -d- -f3)\nline=\"-------------------------------------------------\"\n[ -d logs ] || mkdir logs\nsys_check_file=\"logs/$(ip a show dev eth0|grep -w inet|awk '{print $2}'|awk -F '/' '{print $1}')-`date +%Y%m%d`.txt\"\n# \u83b7\u53d6\u7cfb\u7edfcpu\u4fe1\u606f\nfunction get_cpu_info() {\nPhysical_CPUs=$(grep \"physical id\" /proc/cpuinfo| sort | uniq | wc -l)\nVirt_CPUs=$(grep \"processor\" /proc/cpuinfo | wc -l)\nCPU_Kernels=$(grep \"cores\" /proc/cpuinfo|uniq| awk -F ': ' '{print $2}')\nCPU_Type=$(grep \"model name\" /proc/cpuinfo | awk -F ': ' '{print $2}' | sort | uniq)\nCPU_Arch=$(uname -m)\ncat &lt;&lt;EOF | column -t CPU\u4fe1\u606f:\n\u7269\u7406CPU\u4e2a\u6570: $Physical_CPUs\n\u903b\u8f91CPU\u4e2a\u6570: $Virt_CPUs\n\u6bcfCPU\u6838\u5fc3\u6570: $CPU_Kernels\nCPU\u578b\u53f7: $CPU_Type\nCPU\u67b6\u6784: $CPU_Arch\nEOF\n}\n# \u83b7\u53d6\u7cfb\u7edf\u5185\u5b58\u4fe1\u606f\nfunction get_mem_info() {\ncheck_mem=$(free -m)\nMemTotal=$(grep MemTotal /proc/meminfo| awk '{print $2}')  #KB\nMemFree=$(grep MemFree /proc/meminfo| awk '{print $2}')    #KB\nlet MemUsed=MemTotal-MemFree\nMemPercent=$(awk \"BEGIN {if($MemTotal==0){printf 100}else{printf \\\"%.2f\\\",$MemUsed*100/$MemTotal}}\")\nreport_MemTotal=\"$((MemTotal/1024))\"\"MB\"        #\u5185\u5b58\u603b\u5bb9\u91cf(MB)\nreport_MemFree=\"$((MemFree/1024))\"\"MB\"          #\u5185\u5b58\u5269\u4f59(MB)\nreport_MemUsedPercent=\"$(awk \"BEGIN {if($MemTotal==0){printf 100}else{printf \\\"%.2f\\\",$MemUsed*100/$MemTotal}}\")\"\"%\"   #\u5185\u5b58\u4f7f\u7528\u7387%\ncat &lt;&lt;EOF\n\u5185\u5b58\u4fe1\u606f\uff1a\n${check_mem}\nEOF\n}\n# \u83b7\u53d6\u7cfb\u7edf\u7f51\u7edc\u4fe1\u606f\nfunction get_net_info() {\npri_ipadd=$(ip a show dev eth0|grep -w inet|awk '{print $2}'|awk -F '/' '{print $1}')\npub_ipadd=$(curl ifconfig.me -s)\ngateway=$(ip route | grep default | awk '{print $3}')\nmac_info=$(ip link| egrep -v \"lo\"|grep link|awk '{print $2}')\ndns_config=$(egrep -v \"^$|^#\" /etc/resolv.conf)\nroute_info=$(route -n)\ncat &lt;&lt;EOF | column -t IP\u4fe1\u606f:\n\u7cfb\u7edf\u516c\u7f51\u5730\u5740: ${pub_ipadd}\n\u7cfb\u7edf\u79c1\u7f51\u5730\u5740: ${pri_ipadd}\n\u7f51\u5173\u5730\u5740: ${gateway}\nMAC\u5730\u5740: ${mac_info}\n\u8def\u7531\u4fe1\u606f:\n${route_info}\nDNS \u4fe1\u606f:\n${dns_config}\nEOF\n}\n# \u83b7\u53d6\u7cfb\u7edf\u78c1\u76d8\u4fe1\u606f\nfunction get_disk_info() {\ndisk_info=$(fdisk -l|grep \"Disk /dev\"|cut -d, -f1)\ndisk_use=$(df -hTP|awk '$2!=\"tmpfs\"{print}')\ndisk_inode=$(df -hiP|awk '$1!=\"tmpfs\"{print}')\ncat &lt;&lt;EOF\n\u78c1\u76d8\u4fe1\u606f:\n${disk_info}\n\u78c1\u76d8\u4f7f\u7528:\n${disk_use}\ninode\u4fe1\u606f:\n${disk_inode}\nEOF\n}\n# \u83b7\u53d6\u7cfb\u7edf\u4fe1\u606f\nfunction get_systatus_info() {\nsys_os=$(uname -o)\nsys_release=$(cat /etc/redhat-release)\nsys_kernel=$(uname -r)\nsys_hostname=$(hostname)\nsys_selinux=$(getenforce)\nsys_lang=$(echo $LANG)\nsys_lastreboot=$(who -b | awk '{print $3,$4}')\nsys_runtime=$(uptime |awk '{print  $3,$4}'|cut -d, -f1)\nsys_time=$(date)\nsys_load=$(uptime |cut -d: -f5)\ncat &lt;&lt;EOF | column -t \u7cfb\u7edf\u4fe1\u606f:\n\u7cfb\u7edf: ${sys_os}\n\u53d1\u884c\u7248\u672c:   ${sys_release}\n\u7cfb\u7edf\u5185\u6838:   ${sys_kernel}\n\u4e3b\u673a\u540d:    ${sys_hostname}\nselinux\u72b6\u6001:  ${sys_selinux}\n\u7cfb\u7edf\u8bed\u8a00:   ${sys_lang}\n\u7cfb\u7edf\u5f53\u524d\u65f6\u95f4: ${sys_time}\n\u7cfb\u7edf\u6700\u540e\u91cd\u542f\u65f6\u95f4:   ${sys_lastreboot}\n\u7cfb\u7edf\u8fd0\u884c\u65f6\u95f4: ${sys_runtime}\n\u7cfb\u7edf\u8d1f\u8f7d:   ${sys_load}\nEOF\n}\n# \u83b7\u53d6\u670d\u52a1\u4fe1\u606f\nfunction get_service_info() {\nport_listen=$(netstat -lntup|grep -v \"Active Internet\")\nkernel_config=$(sysctl -p 2&gt;/dev/null)\nif [ ${sysversion} -gt 6 ];then\nservice_config=$(systemctl list-unit-files --type=service --state=enabled|grep \"enabled\")\nrun_service=$(systemctl list-units --type=service --state=running |grep \".service\")\nelse\nservice_config=$(/sbin/chkconfig | grep -E \":on|:\u542f\u7528\" |column -t)\nrun_service=$(/sbin/service --status-all|grep -E \"running\")\nfi\ncat &lt;&lt;EOF\n\u670d\u52a1\u542f\u52a8\u914d\u7f6e:\n${service_config}\n${line}\n\u8fd0\u884c\u7684\u670d\u52a1:\n${run_service}\n${line}\n\u76d1\u542c\u7aef\u53e3:\n${port_listen}\n${line}\n\u5185\u6838\u53c2\u8003\u914d\u7f6e:\n${kernel_config}\nEOF\n}\nfunction get_sys_user() {\nlogin_user=$(awk -F: '{if ($NF==\"/bin/bash\") print $0}' /etc/passwd)\nssh_config=$(egrep -v \"^#|^$\" /etc/ssh/sshd_config)\nsudo_config=$(egrep -v \"^#|^$\" /etc/sudoers |grep -v \"^Defaults\")\nhost_config=$(egrep -v \"^#|^$\" /etc/hosts)\ncrond_config=$(for cronuser in /var/spool/cron/* ;do ls ${cronuser} 2&gt;/dev/null|cut -d/ -f5;egrep -v \"^$|^#\" ${cronuser} 2&gt;/dev/null;echo \"\";done)\ncat &lt;&lt;EOF\n\u7cfb\u7edf\u767b\u5f55\u7528\u6237:\n${login_user}\n${line}\nssh \u914d\u7f6e\u4fe1\u606f:\n${ssh_config}\n${line}\nsudo \u914d\u7f6e\u7528\u6237:\n${sudo_config}\n${line}\n\u5b9a\u65f6\u4efb\u52a1\u914d\u7f6e:\n${crond_config}\n${line}\nhosts \u4fe1\u606f:\n${host_config}\nEOF\n}\nfunction process_top_info() {\n    top_title=$(top -b n1|head -7|tail -1)\n    cpu_top10=$(top b -n1 | head -17 | tail -10)\n    mem_top10=$(top -b n1|head -17|tail -10|sort -k10 -r)\ncat &lt;&lt;EOF\nCPU\u5360\u7528top10:\n${top_title}\n${cpu_top10}\n\u5185\u5b58\u5360\u7528top10:\n${top_title}\n${mem_top10}\nEOF\n}\nfunction sys_check() {\n    get_cpu_info\n    echo ${line}\n    get_mem_info\n    echo ${line}\n    get_net_info\n    echo ${line}\n    get_disk_info\n    echo ${line}\n    get_systatus_info\n    echo ${line}\n    get_service_info\n    echo ${line}\n    get_sys_user\n    echo ${line}\n    process_top_info\n}\nsys_check &gt; ${sys_check_file}\n</code></pre>"},{"location":"Linux/shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/#14-\u6d4b\u8bd5","title":"1.4 \u6d4b\u8bd5","text":"<pre><code>[root@master workspace]# bash sys_check.sh [root@master workspace]# ls\nlogs  sys_check.sh\n[root@master workspace]# cat logs/172.16.60.2-20200419.txt CPU\u4fe1\u606f:\n\u7269\u7406CPU\u4e2a\u6570:  4\n\u903b\u8f91CPU\u4e2a\u6570:  4\n\u6bcfCPU\u6838\u5fc3\u6570:  1\nCPU\u578b\u53f7:      QEMU    Virtual  CPU\nCPU\u67b6\u6784:      x86_64\n-------------------------------------------------\n\u5185\u5b58\u4fe1\u606f\uff1a\ntotal        used        free      shared  buff/cache   available\nMem:          16047       12536         179         885        3331        2007\nSwap:             0           0           0\n-------------------------------------------------\nIP\u4fe1\u606f:\n\u7cfb\u7edf\u516c\u7f51\u5730\u5740:      4x.xxx.xxx.18\n\u7cfb\u7edf\u79c1\u7f51\u5730\u5740:      172.16.60.2\n\u7f51\u5173\u5730\u5740:          172.16.60.1\nMAC\u5730\u5740:           52:54:73:7b:c9:11\n\u8def\u7531\u4fe1\u606f:\nKernel             IP                 routing          table\nDestination        Gateway            Genmask          Flags  Metric  Ref  Use  Iface\n0.0.0.0            172.16.60.1        0.0.0.0          UG     100     0    0    eth0\n10.233.88.192      172.16.60.5        255.255.255.192  UG     0       0    0    tunl0\n172.16.60.0        0.0.0.0            255.255.255.0    U      100     0    0    eth0\n172.17.0.0         0.0.0.0            255.255.0.0      U      0       0    0    docker0\nDNS                \u4fe1\u606f:\nnameserver         10.17.50.3\nnameserver         1.2.4.8\n-------------------------------------------------\n\u78c1\u76d8\u4fe1\u606f:\nDisk /dev/vda: 21.5 GB\nDisk /dev/vdb: 8589 MB\n\u78c1\u76d8\u4f7f\u7528:\nFilesystem     Type      Size  Used Avail Use% Mounted on\n/dev/vda1      ext4       20G  5.0G   14G  27% /\ndevtmpfs       devtmpfs  7.9G     0  7.9G   0% /dev\n/dev/vdc       ext4      197G   46G  142G  25% /data\n/dev/vdd       xfs       500G   53G  448G  11% /var/local/osd0\ninode\u4fe1\u606f:\nFilesystem     Inodes IUsed IFree IUse% Mounted on\n/dev/vda1        1.3M   54K  1.2M    5% /\ndevtmpfs         2.0M   398  2.0M    1% /dev\n/dev/vdc          13M  1.3M   12M   11% /data\n/dev/vdd         250M   14K  250M    1% /var/local/osd0\noverlay           13M  1.3M   12M   11% 2c99089efbac12ffc5d7a8f6ccf99d95ab3c1674b441205a61829ebe635/merged\n\u7cfb\u7edf:              GNU/Linux\n\u53d1\u884c\u7248\u672c:          CentOS                 Linux  release  7.4.1708  (Core)\n\u7cfb\u7edf\u5185\u6838:          3.10.0-693.el7.x86_64\n\u4e3b\u673a\u540d:            master\nselinux\u72b6\u6001:       Permissive\n\u7cfb\u7edf\u8bed\u8a00:          en_US.UTF-8\n\u7cfb\u7edf\u5f53\u524d\u65f6\u95f4:      Sun                    Apr    19       12:34:35  CST     2020\n\u7cfb\u7edf\u6700\u540e\u91cd\u542f\u65f6\u95f4:  2020-03-18             16:15\n\u7cfb\u7edf\u8fd0\u884c\u65f6\u95f4:      31                     days\n\u7cfb\u7edf\u8d1f\u8f7d:          1.55,                  1.73,  1.95\n-------------------------------------------------\n\u670d\u52a1\u542f\u52a8\u914d\u7f6e:\nauditd.service                              enabled\nautovt@.service                             enabled\nceph-mon@.service                           enabled\netcd.service                                enabled\ngapd.service                                enabled\ngetty@.service                              enabled\nirqbalance.service                          enabled\nkdump.service                               enabled\nkubelet.service                             enabled\nmicrocode.service                           enabled\nNetworkManager-dispatcher.service           enabled\nNetworkManager.service                      enabled\npostfix.service                             enabled\nrpcbind.service                             enabled\nrsyslog.service                             enabled\nsmarteye-server-agent.service               enabled\nsshd.service                                enabled\nsystemd-readahead-collect.service           enabled\nsystemd-readahead-drop.service              enabled\nsystemd-readahead-replay.service            enabled\ntuned.service                               enabled\n-------------------------------------------------\n\u8fd0\u884c\u7684\u670d\u52a1:\nauditd.service                loaded active running Security Auditing Service\nceph-mon@master.service       loaded active running Ceph cluster monitor daemon\nceph-osd@0.service            loaded active running Ceph object storage daemon\nchronyd.service               loaded active running NTP client/server\ncrond.service                 loaded active running Command Scheduler\ndbus.service                  loaded active running D-Bus System Message Bus\ndocker.service                loaded active running Docker Application Container Engine\netcd.service                  loaded active running etcd docker wrapper\ngapd.service                  loaded active running guest agent for pitrix\ngetty@tty1.service            loaded active running Getty on tty1\ngssproxy.service              loaded active running GSSAPI Proxy Daemon\nirqbalance.service            loaded active running irqbalance daemon\nkubelet.service               loaded active running Kubernetes Kubelet Server\nNetworkManager.service        loaded active running Network Manager\npolkit.service                loaded active running Authorization Manager\npostfix.service               loaded active running Postfix Mail Transport Agent\nrpcbind.service               loaded active running RPC bind service\nrsyslog.service               loaded active running System Logging Service\nsmarteye-server-agent.service loaded active running The Smarteye Monitoring of server\nsshd.service                  loaded active running OpenSSH server daemon\nsystemd-journald.service      loaded active running Journal Service\nsystemd-logind.service        loaded active running Login Service\nsystemd-udevd.service         loaded active running udev Kernel Device Manager\ntuned.service                 loaded active running Dynamic System Tuning Daemon\n-------------------------------------------------\n\u76d1\u542c\u7aef\u53e3:\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    tcp        0      0 127.0.0.1:9099          0.0.0.0:*               LISTEN      10444/calico-node   tcp        0      0 172.16.60.2:2379        0.0.0.0:*               LISTEN      1321/etcd           tcp        0      0 127.0.0.1:2379          0.0.0.0:*               LISTEN      1321/etcd           tcp        0      0 172.16.60.2:9100        0.0.0.0:*               LISTEN      2868/./kube-rbac-pr tcp        0      0 127.0.0.1:9100          0.0.0.0:*               LISTEN      2314/node_exporter  tcp        0      0 172.16.60.2:2380        0.0.0.0:*               LISTEN      1321/etcd           tcp        0      0 172.16.60.2:10255       0.0.0.0:*               LISTEN      1222/kubelet        tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      1/systemd           tcp        0      0 0.0.0.0:6800            0.0.0.0:*               LISTEN      850/ceph-osd        tcp        0      0 0.0.0.0:6801            0.0.0.0:*               LISTEN      850/ceph-osd        tcp        0      0 0.0.0.0:6802            0.0.0.0:*               LISTEN      850/ceph-osd        tcp        0      0 0.0.0.0:179             0.0.0.0:*               LISTEN      10755/bird          tcp        0      0 0.0.0.0:6803            0.0.0.0:*               LISTEN      850/ceph-osd        tcp        0      0 169.254.25.10:53        0.0.0.0:*               LISTEN      2058/node-cache     tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      552/sshd            tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      786/master          tcp        0      0 127.0.0.1:40416         0.0.0.0:*               LISTEN      1222/kubelet        tcp        0      0 172.16.60.2:6789        0.0.0.0:*               LISTEN      661/ceph-mon        tcp        0      0 169.254.25.10:9254      0.0.0.0:*               LISTEN      2058/node-cache     tcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      1222/kubelet        tcp        0      0 127.0.0.1:10249         0.0.0.0:*               LISTEN      2854/kube-proxy     tcp        0      0 172.16.60.2:10250       0.0.0.0:*               LISTEN      1222/kubelet        tcp6       0      0 :::10251                :::*                    LISTEN      12358/kube-schedule tcp6       0      0 :::6443                 :::*                    LISTEN      1929/kube-apiserver tcp6       0      0 :::10252                :::*                    LISTEN      12366/kube-controll udp6       0      0 :::111                  :::*                                1/systemd           udp6       0      0 ::1:323                 :::*                                530/chronyd         udp6       0      0 :::703                  :::*                                535/rpcbind         -------------------------------------------------\n\u5185\u6838\u53c2\u8003\u914d\u7f6e:\nnet.ipv4.ip_forward = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.ipv4.ip_local_reserved_ports = 30000-32767\nnet.bridge.bridge-nf-call-arptables = 1\n-------------------------------------------------\n\u7cfb\u7edf\u767b\u5f55\u7528\u6237:\nroot:x:0:0:root:/root:/bin/bash\n-------------------------------------------------\nssh \u914d\u7f6e\u4fe1\u606f:\nHostKey /etc/ssh/ssh_host_rsa_key\nHostKey /etc/ssh/ssh_host_ecdsa_key\nHostKey /etc/ssh/ssh_host_ed25519_key\nSyslogFacility AUTHPRIV\nAuthorizedKeysFile      .ssh/authorized_keys\nPasswordAuthentication yes\nChallengeResponseAuthentication no\nGSSAPIAuthentication no\nGSSAPICleanupCredentials no\nUsePAM yes\nX11Forwarding yes\nAcceptEnv LANG LC_CTYPE LC_NUMERIC LC_TIME LC_COLLATE LC_MONETARY LC_MESSAGES\nAcceptEnv LC_PAPER LC_NAME LC_ADDRESS LC_TELEPHONE LC_MEASUREMENT\nAcceptEnv LC_IDENTIFICATION LC_ALL LANGUAGE\nAcceptEnv XMODIFIERS\nSubsystem       sftp    /usr/libexec/openssh/sftp-server\nPermitRootLogin yes\nPermitEmptyPasswords no\nUseDNS no\n-------------------------------------------------\nsudo \u914d\u7f6e\u7528\u6237:\nroot    ALL=(ALL)       ALL\n%wheel  ALL=(ALL)       ALL\n-------------------------------------------------\n\u5b9a\u65f6\u4efb\u52a1\u914d\u7f6e:\nroot\n@weekly /usr/bin/docker system prune -f\n*/30 * * * * /opt/etcd_back/etcd_backup.sh\n-------------------------------------------------\nhosts \u4fe1\u606f:\n127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1 localhost6 localhost6.localdomain6 localhost6.localdomain\n172.16.60.2 master\n172.16.60.3 node01\n172.16.60.4 node02\n172.16.60.5 node03\n172.16.60.2 master.cluster.local master\n172.16.60.3 node01.cluster.local node01\n172.16.60.4 node02.cluster.local node02\n172.16.60.5 node03.cluster.local node03\n172.16.60.2  harbor.devops.kubesphere.local\n172.16.60.2  gitlab.devops.kubesphere.local\n-------------------------------------------------\nCPU\u5360\u7528top10:\nPID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND\n1222 root      20   0 1401200 142324  19560 S  11.8  0.9   6197:32 kubelet\n7119 root      20   0  144632  16016   4840 S   5.9  0.1 263:45.19 coredns\n9761 1001      20   0  133952  19360   3444 S   5.9  0.1 589:46.42 jaeger-operator\n12366 root      20   0  821212 130924  21304 S   5.9  0.8  20:30.77 kube-controller\n15129 root      20   0  169104  39880   6176 S   5.9  0.2 212:52.15 mixs\n15251 root      20   0  157848   2148   1408 R   5.9  0.0   0:00.02 top\n19934 root      20   0 10.074g  26564   4612 S   5.9  0.2 342:47.40 etcd\n1 root      20   0  194876   6912   2996 S   0.0  0.0   7:21.74 systemd\n2 root      20   0       0      0      0 S   0.0  0.0   0:09.02 kthreadd\n3 root      20   0       0      0      0 S   0.0  0.0  20:13.67 ksoftirqd/0\n\u5185\u5b58\u5360\u7528top10:\nPID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND\n1929 root      20   0 1667544 832556  23912 S  11.8  5.1   5571:22 kube-apiserver\n12967 root      20   0  9.914g 6.834g   1580 S   5.9 43.6   3672:00 java\n28651 polkitd   20   0 4161568 217472   2180 S   5.9  1.3 185:46.09 java\n1321 root      20   0 10.188g 170880  18380 S  11.8  1.0   2154:47 etcd\n12366 root      20   0  821212 130924  21304 S   5.9  0.8  20:30.78 kube-controller\n661 ceph      20   0  463516  67048   4476 S   5.9  0.4 280:35.51 ceph-mon\n17654 root      20   0  167812  11044   2808 S   5.9  0.1   9:13.12 envoy\n1 root      20   0  194876   6912   2996 S   0.0  0.0   7:21.74 systemd\n15255 root      20   0  157848   2152   1408 R  11.8  0.0   0:00.03 top\n14093 polkitd   20   0  288608   6848   4208 S   5.9  0.0   0:00.02 postgres\n</code></pre>"},{"location":"Linux/shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/#2-elk\u5b89\u88c5","title":"2 ELK\u5b89\u88c5","text":""},{"location":"Linux/shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/#21-\u9700\u6c42","title":"2.1 \u9700\u6c42","text":"<p>\u5bf9\u4e8e\u8f6f\u4ef6\u5b89\u88c5\uff0c\u901a\u5e38\u4eba\u5de5\u64cd\u4f5c\u4e0d\u4ec5\u7e41\u7410\u8017\u65f6\uff0c\u4e14\u6613\u51fa\u9519\uff0c\u53ef\u4ee5\u7528\u7f16\u5199Shell\u6765\u5b8c\u6210\uff0c\u540e\u671f\u5982\u679c\u6709\u91cd\u590d\u9700\u6c42\uff0c\u53ef\u4ee5\u4e00\u52b3\u6c38\u9038\uff0c\u5b89\u88c5\u4e0d\u6613\u51fa\u9519\u4e14\u63d0\u5347\u6548\u7387\uff0cELK\u4e3a\u5f00\u6e90\u65e5\u5fd7\u7cfb\u7edf \u7531 Elasticsearch\u3001Logstash \u548c Kibana \u4e09\u90e8\u5206\u7ec4\u4ef6\u7ec4\u6210\u3002</p>"},{"location":"Linux/shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/#22-\u601d\u8def","title":"2.2 \u601d\u8def","text":"<p>\u53ef\u4ee5\u9488\u5bf9\u9700\u8981\u6309\u7167\u7684\u5404\u670d\u52a1\u5355\u72ec\u7f16\u5199\u811a\u672c\u6765\u8fdb\u884c\u6309\u7167\uff0c\u5176\u4e2d\u5229\u7528\u4e86\u7cfb\u7edf\u5185\u7684\u5f88\u591a\u547d\u4ee4\uff0c\u4e5f\u5305\u542b\u6587\u4ef6\u7684\u64cd\u4f5c\u7b49\uff0c\u5728\u6b64\u521a\u597d\u56de\u987e\u6211\u4eec\u4e4b\u524d\u5b66\u4e60\u7684\u5185\u5bb9\u3002</p>"},{"location":"Linux/shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/#23-\u5b9e\u73b0","title":"2.3 \u5b9e\u73b0","text":"<pre><code>#!/bin/bash\n#mail:xuel@anchnet.com\n#data:2020/4/10\n#AutoInstall ELK scripts\n#Software:elasticsearch-5.4.1/logstash-5.4.1/filebeat-5.4.1/kibana-5.4.1\nclear\necho \"##########################################\"\necho \"#       Auto Install ELK.               ##\"\necho \"#       Press Ctrl + C to cancel        ##\"\necho \"#       Any key to continue             ##\"\necho \"##########################################\"\nread -p # \u5b9a\u4e49\u53d8\u91cf\nsoftware_dir=\"/usr/local/software\"\nelasticsearch_url=\"https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.4.1.tar.gz\"\nkibana_url=\"https://artifacts.elastic.co/downloads/kibana/kibana-5.4.1-linux-x86_64.tar.gz\"\nlogstash_url=\"https://artifacts.elastic.co/downloads/logstash/logstash-5.4.1.tar.gz\"\nfilebeat_url=\"https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-5.4.1-linux-x86_64.tar.gz\"\nsys_version=`cat /etc/redhat-release |awk '{print $4}'|cut -d. -f1`\nIP=`ip addr|grep \"inet \"|grep -v 127.0.0.1|awk '{print $2}'|cut -d/ -f1`\njvm_conf=\"/usr/local/elasticsearch/config/jvm.options\"\nsys_mem=`free -m|grep Mem:|awk '{print $2}'|awk '{sum+=$1} END {print sum/1024}'|cut -d. -f1`\n#wget software\nwget_fun() {\nif [ ! -d ${software_dir} ];then\nmkdir -p ${software_dir} &amp;&amp; cd ${software_dir}\nelse\ncd ${software_dir}\nfi\nfor software in $elasticsearch_url $kibana_url $logstash_url $filebeat_url\ndo\nwget -c $software\ndone\nclear\n}\n#initial system:install java wget;set hostname;disable firewalld\ninit_sys() {\n[ -f /etc/init.d/functions ] &amp;&amp; . /etc/init.d/functions\n[ \"${sys_version}\" != \"7\" ] &amp;&amp; echo \"Error:This Scripts Support Centos7.xx\" &amp;&amp; exit 1\n[ $(id -u) != \"0\" ] &amp;&amp; echo \"Error: You must be root to run this script\" &amp;&amp; exit 1\nsed -i \"s/SELINUX=enforcing/SELINUX=disabled/\"  /etc/selinux/config\nsetenforce 0\nyum install -y java-1.8.0-openjdk wget net-tools\nhostnamectl set-hostname elk-server          systemctl stop firewalld\ncat &gt;&gt;/etc/security/limits.conf&lt;&lt;EOF\n* soft nofile 65536 \n* hard nofile 65536 \n* soft nproc 65536 \n* hard nproc 65536\nEOF\n}\n#install elasticsearch\ninstall_elasticsearch() {\ncd $software_dir\ntar zxf elasticsearch-5.4.1.tar.gz\nmv elasticsearch-5.4.1 /usr/local/elasticsearch\nmkdir -p /usr/local/elasticsearch/data /usr/local/elasticsearch/logs\nuseradd elasticsearch\nchown -R elasticsearch:elasticsearch /usr/local/elasticsearch\necho \"vm.max_map_count = 655360\" &gt;&gt;/etc/sysctl.conf &amp;&amp; sysctl -p\nif [ ${sys_mem} -eq 0 ];then\nsed -i \"s#`grep \"^-Xmx\" ${jvm_conf}`#\"-Xmx512m\"#g\" ${jvm_conf}\nsed -i \"s#`grep \"^-Xms\" ${jvm_conf}`#\"-Xms512m\"#g\" ${jvm_conf}\nelse\nsed -i \"s#`grep \"^-Xmx\" ${jvm_conf}`#\"-Xmx${sys_mem}g\"#g\" ${jvm_conf}\nsed -i \"s#`grep \"^-Xms\" ${jvm_conf}`#\"-Xms${sys_mem}g\"#g\" ${jvm_conf}\nfi\ncat &gt;&gt;/usr/local/elasticsearch/config/elasticsearch.yml&lt;&lt;EOF\ncluster.name: my-application\nnode.name: elk-server\npath.data: /usr/local/elasticsearch/data\npath.logs: /usr/local/elasticsearch/logs\nnetwork.host: 127.0.0.1\nhttp.port: 9200\ndiscovery.zen.ping.unicast.hosts: [\"elk-server\"]\nEOF\nsu - elasticsearch -c \"nohup /usr/local/elasticsearch/bin/elasticsearch &amp;\"\n}\n#install logstash\ninstall_logstash() {\ncd $software_dir\ntar -zxf logstash-5.4.1.tar.gz\nmv logstash-5.4.1 /usr/local/logstash\ncat&gt;/usr/local/logstash/config/01-syslog.conf&lt;&lt;EOF\ninput {\n    beats {\n        port =&gt; \"5044\"\n        }\n    }\noutput {\n    elasticsearch {\n        hosts =&gt; \"127.0.0.1:9200\"\n    }\n    stdout { codec =&gt; rubydebug }\n}\nEOF\nnohup /usr/local/logstash/bin/logstash -f /usr/local/logstash/config/01-syslog.conf &amp; &gt;/dev/null\n}\n#install filebeat\ninstall_filebeat() {\ncd $software_dir\ntar -zxf filebeat-5.4.1-linux-x86_64.tar.gz\nmv filebeat-5.4.1-linux-x86_64 /usr/local/filebeat\ncat &gt;/usr/local/filebeat/filebeat.yml&lt;&lt;EOF\nfilebeat.prospectors:\n- input_type: log\n  paths:\n    - /var/log/*.log\noutput.logstash:\n  hosts: [\"127.0.0.1:5044\"]\nEOF\ncd /usr/local/filebeat/\nnohup /usr/local/filebeat/filebeat &amp; &gt;/dev/null\n}\n#install kibana\ninstall_kibana() {\ncd $software_dir\ntar -zxf kibana-5.4.1-linux-x86_64.tar.gz\nmv kibana-5.4.1-linux-x86_64 /usr/local/kibana\ncat &gt;&gt; /usr/local/kibana/config/kibana.yml &lt;&lt;EOF\nserver.port: 5601\nserver.host: \"0.0.0.0\"\nelasticsearch.url: \"http://127.0.0.1:9200\"\nEOF\nnohup /usr/local/kibana/bin/kibana &amp; &gt;/dev/null\n}\ncheck() {\nport=$1\nprogram=$2\ncheck_port=`netstat -lntup|grep ${port}|wc -l`\ncheck_program=`ps -ef|grep ${program}|grep -v grep|wc -l`\nif [ $check_port -gt 0 ] &amp;&amp; [ $check_program -gt 0 ];then\naction \"${program} run is ok!\" /bin/true\nelse\naction \"${program} run is error!\" /bin/false\nfi\n}\nmain() {\ninit_sys\nwget_fun\ninstall_elasticsearch\ninstall_filebeat\ninstall_logstash\ninstall_kibana\necho -e \"\\033[32m Checking Elasticsearch...\\033[0m\"\nsleep 20\ncheck :9200 \"elasticsearch\"\necho -e \"\\033[32m Checking Logstash...\\033[0m\"\nsleep 2\ncheck \":9600\" \"logstash\"\necho -e \"\\033[32m Checking Kibana...\\033[0m\"\nsleep 2\ncheck \":5601\" \"kibana\"\naction \"ELK install is success!\" /bin/true\necho \"url:http://$IP:5601\"\n}\nmain\n</code></pre>"},{"location":"Linux/shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/#24-\u6d4b\u8bd5","title":"2.4 \u6d4b\u8bd5","text":"<p>\u5b89\u88c5\u5b8c\u6210\u8bbf\u95eehttp://IP:5601\u5373\u53ef\uff0c\u6ce8\u610fIP\u5730\u5740\u4e3a\u6309\u7167ELK\u7684\u670d\u52a1\u5668IP\u5730\u5740\u3002</p> <p></p>"},{"location":"Linux/shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/#3-\u5c0f\u7ed3","title":"3. \u5c0f\u7ed3","text":"<p>\u672c\u7ae0\u8282\u6211\u4eec\u7b80\u5355\u7684\u5217\u4e3e\u4e86\u4e24\u4e2a\u5177\u4f53\u5b9e\u4f8b\uff0c\u6765\u5b9e\u6218Shell\u811a\u672c\u7f16\u5199\u5904\u7406\u5177\u4f53\u95ee\u9898\uff0c\u81f3\u6b64\u5c31\u7ed3\u675f\u4e86Shell\u7684\u5168\u90e8\u7ae0\u8282\uff0c\u5728\u6b64\u5e0c\u671b\u672c\u6587\u53ef\u4ee5\u5e26\u7ed9\u5927\u5bb6Shell\u5b66\u4e60\u7684\u4e00\u4e9b\u601d\u8def\u8fc7\u65b9\u6cd5\u3002</p> <p>\u5b66\u4e60Shell\u9700\u8981\u591a\u52a8\u624b\u5b9e\u8df5\uff0c\u5728\u65e5\u5e38\u7f16\u5199\u4e2d\u4e3e\u4e00\u53cd\u4e09\uff0c\u9488\u5bf9\u4e00\u4e2a\u811a\u672c\u5982\u4f55\u80fd\u65e0\u72b6\u6001\uff0c\u66f4\u5065\u58ee\uff0c\u66f4\u7075\u6d3b\u6613\u7ef4\u62a4\uff0c\u9700\u8981\u591a\u6b21\u7684\u4fee\u6539\uff0c\u53cd\u590d\u7684\u6267\u884c\u9a8c\u8bc1\uff0c\u9488\u5bf9\u4e0d\u540c\u7684\u5e94\u7528\u573a\u666f\uff0c\u5c06\u6570\u636e\u62bd\u8c61\u4e3a\u53c2\u6570\u8fdb\u884c\u4f20\u9012\uff0c\u53ef\u4ee5\u8fbe\u5230\u662f\u4e8b\u534a\u529f\u500d\u7684\u6548\u679c\u3002\u6ce8\u610f\u5c06\u6709\u9650\u7684\u7cbe\u529b\u653e\u5728\u70ed\u70b9\u77e5\u8bc6\u4e0a\uff0c\u5176\u4ed6\u5de5\u5177\u6216\u547d\u4ee4\u7684\u5e38\u7528\u9009\u9879\u6216\u53c2\u6570\u7262\u8bb0\u5373\u53ef\uff0c\u5176\u4ed6\u4e0d\u5e38\u7528\u9009\u9879\u4e0d\u5efa\u8bae\u6b7b\u8bb0\u786c\u80cc\uff0c\u6d3b\u7528<code>\u2014help</code>\u6216<code>man</code>\u624b\u518c\u67e5\u770b\uff0c\u8fd9\u6837\u5728\u540e\u671f\u7684 Shell \u7f16\u5199\u4e2d\u80fd\u591f\u66f4\u52a0\u7684\u5feb\u901f\u9ad8\u6548\u3002</p>"},{"location":"Linux/shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/#4-\u94fe\u63a5","title":"4. \u94fe\u63a5","text":"<ul> <li>https://github.com/fengyuhetao/shell</li> <li>https://github.com/daily-scripts/shell-scripts</li> </ul>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/","title":"2.Shell \u53d8\u91cf","text":""},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#1-shell-\u53d8\u91cf\u6982\u8ff0","title":"1. Shell \u53d8\u91cf\u6982\u8ff0","text":"<p>\u53d8\u91cf\u662f\u4efb\u4f55\u7a0b\u5e8f\u6216\u811a\u672c\u7684\u91cd\u8981\u7ec4\u6210\u90e8\u5206\uff0c\u53d8\u91cf\u4e3a\u7a0b\u5e8f\u6216\u811a\u672c\u8bbf\u95ee\u5185\u5b58\u4e2d\u7684\u53ef\u4fee\u6539\u7684\u4e00\u5757\u6570\u636e\u63d0\u4f9b\u4e86\u7b80\u5355\u7684\u65b9\u5f0f\u3002</p> <p>Linux Shell \u4e2d\u7684\u53d8\u91cf\u53ef\u4ee5\u88ab\u6307\u5b9a\u4e3a\u4efb\u610f\u7684\u6570\u636e\u7c7b\u578b\uff0c\u6bd4\u5982\u6587\u672c\u5b57\u7b26\u4e32\u6216\u8005\u6570\u503c\u3002\u4f60\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539 Shell \u4e2d\u7684\u53d8\u91cf\u6765\u6539\u53d8 Shell \u7684\u6837\u5f0f\u3002</p> <p>\u63a5\u4e0b\u6765\u5c31\u8ba9\u6211\u4eec\u6765\u4e86\u89e3\u548c\u5b66\u4e60\u4e00\u4e0b Shell \u4e2d\u7684\u53d8\u91cf\u5427\u3002</p>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#11-shell-\u53d8\u91cf\u662f\u4ec0\u4e48","title":"1.1 Shell \u53d8\u91cf\u662f\u4ec0\u4e48","text":"<p>Shell \u53d8\u91cf\u662f\u4ec0\u4e48\u5462\uff0c\u987e\u540d\u601d\u4e49\uff0c\u5c31\u662f\u53ef\u4ee5\u53d8\u5316\u7684\u91cf\uff0c\u5982\u679c\u6709\u7f16\u7a0b\u57fa\u7840\u7684\u8bfb\u8005\u77e5\u9053\u4efb\u4f55\u7a0b\u5e8f\u4e2d\u90fd\u6709\u53d8\u91cf\uff0c\u4ece\u6211\u4eec\u5c0f\u65f6\u5019\u505a\u6570\u5b66\u9898\uff0c\u5b9a\u4e49\u7684 x \u53d8\u91cf\uff0c\u6700\u7ec8\u7ed9\u5b9a\u503c\uff0c\u7528\u503c\u66ff\u6362 x \u53d8\u91cf\uff0c\u8fd9\u5c31\u662f\u6211\u4eec\u6700\u521d\u63a5\u89e6\u7684\u53d8\u91cf\uff0c\u5b83\u548c\u6211\u4eec\u5728 Shell \u4e2d\u63a5\u89e6\u7684\u53d8\u91cf\u672c\u8d28\u4e0a\u662f\u4e00\u81f4\u7684\u3002</p> <p>\u53d8\u91cf\u5728 Shell \u4e2d\u662f\u5b58\u50a8\u8ba1\u7b97\u5668\u5185\u5b58\u7684\u5355\u5143\uff0c\u5176\u4e2d\u5b58\u653e\u7684\u503c\u53ef\u4ee5\u6539\u53d8\uff0c\u5f53\u6211\u4eec\u5728\u7f16\u5199 Shell \u811a\u672c\u4e2d\uff0c\u5982\u679c\u4e00\u4e9b\u7ecf\u5e38\u7528\u7684\u5b57\u7b26\u4e32\u6216\u6570\u5b57\u6211\u4eec\u5c31\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2a\u53d8\u91cf\uff0c\u5c06\u5177\u4f53\u7684\u503c\u8d4b\u7ed9\u8fd9\u4e2a\u53d8\u91cf\uff0c\u7136\u540e\u5728\u5177\u4f53\u7684\u51fd\u6570\u6216\u811a\u672c\u4e2d\u5f15\u7528\u8fd9\u4e2a\u53d8\u91cf\uff0c\u5c31\u76f8\u5f53\u4e8e\u62ff\u5230\u4e86\u8fd9\u4e2a\u503c\u3002</p>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#12-\u4e3a\u4ec0\u4e48\u8981\u7528\u53d8\u91cf","title":"1.2 \u4e3a\u4ec0\u4e48\u8981\u7528\u53d8\u91cf","text":"<p>\u6211\u4eec\u5927\u6982\u4e86\u89e3\u4e86 Shell \u53d8\u91cf\u662f\u4ec0\u4e48\uff0c\u90a3\u4e48\u4e3a\u4ec0\u4e48\u5728 Shell \u811a\u672c\u4e2d\u9700\u8981\u53d8\u91cf\u5462\uff1f</p> <p>\u4f8b\u5982\u5728\u4e00\u4e2a Shell \u811a\u672c\u4e2d\uff0c\u6211\u4eec\u9700\u8981\u6307\u5b9a\u4e00\u4e2a\u76ee\u5f55\uff0c\u811a\u672c\u5185\u591a\u5904\u8c03\u7528\u4e86\u8fd9\u4e2a\u76ee\u5f55\u540d\u79f0\uff0c\u73b0\u5728\u6211\u4eec\u6709\u4e2a\u9700\u6c42\u76ee\u5f55\u540d\u79f0\u6539\u53d8\u4e86\uff0c\u6211\u4eec\u8be5\u600e\u4e48\u529e\u5462\uff0c\u5728\u811a\u672c\u4e2d\u6bcf\u4e2a\u4f7f\u7528\u8be5\u76ee\u5f55\u7684\u5730\u65b9\u90fd\u9700\u8981\u6539\u6210\u65b0\u7684\u76ee\u5f55\u540d\u79f0\uff0c\u6709\u6ca1\u6709\u7b80\u5355\u7684\u65b9\u6cd5\u53ea\u9700\u8981\u6539\u4e00\u5904\u5730\u65b9\u5462\uff0c\u8fd9\u65f6\u5019\u5c31\u7528\u5230\u4e86\u6211\u4eec\u7684\u53d8\u91cf\uff0c\u5728\u811a\u672c\u7684\u5168\u5c40\u5b9a\u4e49\u4e00\u4e2a\u53d8\u91cf\u4f8b\u5982 <code>BASE_DIR</code>\uff0c\u7136\u540e\u5c06\u76ee\u5f55\u8d4b\u503c\u7ed9\u8fd9\u4e2a\u53d8\u91cf\uff0c\u5728\u5177\u4f53\u5f15\u7528\u7684\u65f6\u5019\u5229\u7528\u8fd9\u4e2a\u76ee\u5f55\u7684\u53d8\u91cf\u540d\u79f0\uff0c\u4e0b\u6b21\u9700\u8981\u6211\u4eec\u6539\uff0c\u53ea\u7528\u6539\u6700\u524d\u9762\u8fd9\u4e2a\u53d8\u91cf\u5373\u53ef\u3002</p> <p>\u56e0\u6b64\u6211\u4eec\u4f7f\u7528\u53d8\u91cf\u5c31\u662f\u4e3a\u65b9\u4fbf\uff0c\u540c\u65f6\u4e5f\u4f7f\u5f97\u6211\u4eec\u7684\u811a\u672c\u66f4\u5177\u7075\u6d3b\u6027\u6269\u5c55\u6027\u4e0e\u540e\u671f\u7684\u53ef\u7ef4\u62a4\u6027\u3002</p>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#2-shell-\u53d8\u91cf\u57fa\u672c\u64cd\u4f5c","title":"2. Shell \u53d8\u91cf\u57fa\u672c\u64cd\u4f5c","text":"<p>\u6211\u4eec\u77e5\u9053\u4e86 Shell \u4e2d\u53d8\u91cf\u662f\u4ec0\u4e48\u4ee5\u53ca\u5176\u5728 Shell \u7f16\u5199\u4e2d\u7684\u91cd\u8981\u6027\uff0c\u90a3\u4e48\u8ba9\u6211\u4eec\u5148\u6765\u5b66\u4e60 Shell \u53d8\u91cf\u7684\u57fa\u672c\u64cd\u4f5c\u3002</p>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#21-\u53d8\u91cf\u7684\u5b9a\u4e49","title":"2.1 \u53d8\u91cf\u7684\u5b9a\u4e49","text":"<p>\u5728\u4f7f\u7528 Shell \u53d8\u91cf\u524d\uff0c\u9700\u8981\u5148\u5b9a\u4e49\u53d8\u91cf\uff0c\u5b9a\u4e49\u53d8\u91cf\u7684\u65b9\u5f0f\u6709\u4e09\u79cd\uff1a</p>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#211-\u76f4\u63a5\u8d4b\u503c","title":"2.1.1 \u76f4\u63a5\u8d4b\u503c","text":"<p>\u987e\u540d\u601d\u4e49\u5c31\u662f\u76f4\u63a5\u5c06\u4e00\u4e2a\u503c\u8d4b\u503c\u7ed9\u4e00\u4e2a\u53d8\u91cf\u540d\u79f0\uff0c\u8fd9\u79cd\u9700\u8981\u6ce8\u610f\u503c\u4e2d\u4e0d\u80fd\u5305\u542b\u7a7a\u767d\u5b57\u7b26</p> <p>\u4f8b\u5982\uff1a\u6b63\u786e\u7684\u76f4\u63a5\u8d4b\u503c\u53d8\u91cf\uff1a<code>DIR=/tmp</code>\uff0c\u5176\u4e2d <code>DIR</code> \u4e3a\u53d8\u91cf\u540d\uff0c<code>/tmp</code> \u4e3a\u503c</p> <p>\u9519\u8bef\u7684\u76f4\u63a5\u8d4b\u503c\uff1a<code>STRING=hello Shell</code>\uff0c\u5176\u4e2d <code>STRINNG</code> \u4e3a\u53d8\u91cf\u540d\uff0c<code>hello Shell</code> \u4e3a\u503c\uff0c\u5176\u4e2d\u503c\u5305\u542b\u4e86\u7a7a\u767d\u5b57\u7b26\uff0c\u8fd9\u79cd\u8d4b\u503c\u53d8\u91cf\u5c31\u662f\u9519\u8bef\u7684\u3002</p>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#212-\u5355\u5f15\u53f7\u8d4b\u503c","title":"2.1.2 \u5355\u5f15\u53f7\u8d4b\u503c","text":"<p>\u5982\u679c\u503c\u4e2d\u4e3a\u666e\u901a\u5b57\u7b26\uff0c\u90a3\u4e48\u5355\u5f15\u53f7\u8d4b\u503c\u4e0e\u53cc\u5f15\u53f7\u8d4b\u503c\u6ca1\u6709\u533a\u522b\uff0c\u5176\u53ef\u4ee5\u5305\u542b\u7a7a\u767d\u5b57\u7b26\uff0c\u4f46\u662f\u5982\u679c\u5176\u4e2d\u5305\u542b\u4e86\u53d8\u91cf\u7684\u4f7f\u7528\uff0c\u90a3\u4e48\u5355\u5f15\u53f7\u8d4b\u503c\u65b9\u5f0f\u4e3a\u5355\u5f15\u53f7\u91cc\u9762\u7684\u5185\u5bb9\u662f\u4ec0\u4e48\u5c31\u8f93\u51fa\u4ec0\u4e48\uff0c\u6b64\u79cd\u8d4b\u503c\u65b9\u5f0f\u9002\u7528\u4e8e\u4e0d\u5e0c\u671b\u89e3\u6790\u53d8\u91cf\u7684\u573a\u666f\uff0c\u4ec5\u663e\u793a\u7eaf\u5b57\u7b26\u4e32\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# echo $PATH\n/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin\n[root@master ~]# DIR='$PATH'\n[root@master ~]# echo $DIR\n$PATH\n[root@master ~]# DATE='$(date)'\n[root@master ~]# echo $DATE\n$(date)\n</code></pre> <p><code>PATH</code> \u4e3a linux \u7cfb\u7edf\u5185\u7f6e\u7684\u4e00\u4e2a\u73af\u5883\u53d8\u91cf\uff0cDIR \u4e3a\u6211\u4eec\u5b9a\u4e49\u7684\u53d8\u91cf\uff0c\u503c\u4e3a\u5355\u5f15\u53f7\u5f15\u8d77\u6765\u7684 <code>$PATH</code>\uff0c\u67e5\u770b\u5176\u5185\u5bb9\u4e5f\u4e3a <code>$PATH</code>\uff0c\u540c\u7406\u5bf9\u4e8e\u6267\u884c <code>date</code> \u547d\u4ee4\u3002</p>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#213-\u53cc\u5f15\u53f7\u8d4b\u503c","title":"2.1.3 \u53cc\u5f15\u53f7\u8d4b\u503c","text":"<p>\u4e0e\u5355\u5f15\u53f7\u8d4b\u503c\u4e00\u6837\uff0c\u5176\u4e5f\u53ef\u4ee5\u5305\u542b\u7a7a\u767d\u5b57\u7b26\uff0c\u4f46\u662f\u4e0e\u5355\u5f15\u53f7\u8d4b\u503c\u4e0d\u540c\u7684\u662f\uff0c\u53cc\u5f15\u53f7\u8d4b\u503c\u53ef\u4ee5\u89e3\u6790\u5f15\u53f7\u5185\u7684\u53d8\u91cf\u6216\u6267\u884c\u547d\u4ee4\uff0c\u5373\u4e0d\u662f\u5c06\u53cc\u5f15\u53f7\u4e2d\u7684\u53d8\u91cf\u540d\u548c\u547d\u4ee4\u539f\u6837\u8f93\u51fa\uff0c\u800c\u662f\u89e3\u6790\u5176\u4e2d\u53d8\u91cf\u7684\u5185\u5bb9\uff0c\u7136\u540e\u8fdb\u884c\u8f93\u51fa\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# echo $PATH\n/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin\n[root@master ~]# DIR=\"$PATH\"\n[root@master ~]# echo $DIR\n/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin\n[root@master ~]# DATE=\"$(date)\" [root@master ~]# echo $DATE    Sun Mar 8 22:13:57 CST 2020\n</code></pre> <p>\u53ef\u4ee5\u901a\u8fc7\u4e0e\u5355\u5f15\u53f7\u793a\u4f8b\u5bf9\u7167\u67e5\u770b\uff0c\u53cc\u5f15\u53f7\u8d4b\u503c\u89e3\u6790\u4e86 <code>PATH</code> \u53d8\u91cf\u7684\u503c\u7136\u540e\u8f93\u51fa\uff0c\u540c\u7406\u5bf9\u4e8e\u6267\u884c\u547d\u4ee4 <code>date</code>\u3002</p>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#22-\u53d8\u91cf\u7684\u4f7f\u7528","title":"2.2 \u53d8\u91cf\u7684\u4f7f\u7528","text":"<p>\u6211\u4eec\u77e5\u9053\u4e86\u53d8\u91cf\u7684\u5b9a\u4e49\u65b9\u5f0f\uff0c\u90a3\u4e48\u8be5\u5982\u4f55\u4f7f\u7528\u53d8\u91cf\u5462\uff1f\u4f7f\u7528\u53d8\u91cf\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5728\u5b9a\u4e49\u7684\u53d8\u91cf\u540d\u524d\u9762\u6dfb\u52a0 <code>$</code> \u5373\u53ef\u4f7f\u7528\u5b9a\u4e49\u7684\u53d8\u91cf</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# DIR=/tmp\n[root@master ~]# echo $DIR\n/tmp\n</code></pre> <p>\u5728\u4f7f\u7528\u53d8\u91cf\u4e2d\u6709\u4e00\u79cd\u7279\u6b8a\u60c5\u51b5\uff0c\u9700\u8981\u6211\u4eec\u624b\u52a8\u6307\u5b9a\u53d8\u91cf\u7684\u8fb9\u754c\u662f\u4ec0\u4e48\uff0c\u6b64\u65f6\u5c31\u9700\u8981\u4f7f\u7528\u5230 <code>{}</code>\u3002</p> <pre><code>[root@master ~]# STRING=\"hello Shell\"\n[root@master ~]# echo \"test $STRINGtest\"\ntest [root@master ~]# echo \"test ${STRING}test\"\ntest hello Shelltest\n</code></pre> <p>\u901a\u8fc7\u793a\u4f8b\u6211\u4eec\u80fd\u591f\u770b\u51fa\uff0c\u4e0d\u4f7f\u7528 <code>{}</code> \u5f15\u8d77\u6765\u53d8\u91cf\uff0c\u5982\u679c\u53d8\u91cf\u540d\u540e\u9762\u7ee7\u7eed\u6709\u5b57\u7b26\uff0cShell \u65e0\u6cd5\u5224\u65ad\u6211\u4eec\u7684\u53d8\u91cf\u8fb9\u754c\u5728\u54ea\u91cc\uff0c\u6211\u4eec\u63a8\u8350\u5728\u4f7f\u7528\u53d8\u91cf\u7684\u65f6\u5019\u90fd\u5e26\u4e0a <code>{}</code> \u51cf\u5c11\u51fa\u9519\u7684\u6982\u7387\uff0c\u5e76\u4e14\u65b9\u4fbf\u6211\u4eec\u4eba\u4e3a\u8bc6\u522b\u53d8\u91cf\u7684\u8fb9\u754c\u3002</p>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#23-\u53d8\u91cf\u7684\u66f4\u65b0","title":"2.3 \u53d8\u91cf\u7684\u66f4\u65b0","text":"<p>\u6211\u4eec\u5df2\u7ecf\u5b9a\u4e49\u4e86\u53d8\u91cf\uff0c\u5982\u679c\u5bf9\u53d8\u91cf\u8fdb\u884c\u66f4\u65b0\u4fee\u6539\u5462\uff0c\u66f4\u65b0\u4fee\u6539\u53d8\u91cf\u91cd\u65b0\u8d4b\u503c\u5373\u53ef</p> <p>\u4f8b\u5982:</p> <pre><code>[root@master ~]# DIR=/tmp\n[root@master ~]# echo $DIR\n/tmp\n[root@master ~]# DIR=/root\n[root@master ~]# echo $DIR\n/root\n</code></pre> <p>\u53e6\u5916\u5728\u53d8\u91cf\u4e2d\u5b58\u5728\u53ea\u8bfb\u53d8\u91cf\uff0c\u987e\u540d\u601d\u4e49\u5176\u4e3a\u5b9a\u4e49\u597d\u540e\uff0c\u53ea\u80fd\u53ea\u8bfb\uff0c\u4e0d\u80fd\u5bf9\u5176\u8fdb\u884c\u4fee\u6539\uff0c\u4f7f\u7528 readonly \u547d\u4ee4\u53ef\u4ee5\u5c06\u53d8\u91cf\u5b9a\u4e49\u4e3a\u53ea\u8bfb\u53d8\u91cf</p> <pre><code>[root@master ~]# readonly STRING=\"Shell\"\n[root@master ~]# echo ${STRING}\nShell\n[root@master ~]# STRING=\"test\"\n-bash: STRING: readonly variable\n[root@master ~]# echo ${STRING}\nShell\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u4f7f\u7528 readonly \u5b9a\u4e49\u53d8\u91cf\u540e\uff0c\u5bf9\u53d8\u91cf\u8fdb\u884c\u4fee\u6539\u65f6\u5019\u62a5\u9519\uff0c\u53ea\u8bfb\u53d8\u91cf\u65e0\u6cd5\u8fdb\u884c\u4fee\u6539\u3002</p>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#24-\u53d8\u91cf\u7684\u5220\u9664","title":"2.4 \u53d8\u91cf\u7684\u5220\u9664","text":"<p>\u53d8\u91cf\u7684\u5220\u9664\u4f7f\u7528 unset\uff0c\u5220\u9664\u540e\u5c31\u6d88\u9664\u4e86\u5b9a\u4e49\u7684\u53d8\u91cf\uff0c\u53d8\u91cf\u88ab\u5220\u9664\u540e\u4e0d\u80fd\u518d\u6b21\u4f7f\u7528\uff1bunset \u547d\u4ee4\u4e0d\u80fd\u5220\u9664\u53ea\u8bfb\u53d8\u91cf\u3002</p> <p>\u4f8b\u5982</p> <pre><code>[root@master ~]# DIR=/tmp [root@master ~]# echo \"dir is ${DIR}\"            dir is /tmp\n[root@master ~]# unset DIR\n[root@master ~]# echo \"dir is ${DIR}\" dir is\n</code></pre>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#3-shell-\u53d8\u91cf\u89c4\u8303","title":"3. Shell \u53d8\u91cf\u89c4\u8303","text":"<p>\u4e0e\u5176\u4ed6\u8bed\u8a00\u4e00\u6837\uff0cShell \u4e2d\u53d8\u91cf\u4e5f\u9700\u8981\u9075\u5faa\u4e00\u5b9a\u7684\u89c4\u8303\uff0c</p>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#31-\u547d\u540d\u89c4\u8303","title":"3.1 \u547d\u540d\u89c4\u8303","text":"<ul> <li>\u53d8\u91cf\u547d\u540d\u53ea\u80fd\u4f7f\u7528\u82f1\u6587\u5b57\u6bcd\uff0c\u6570\u5b57\u548c\u4e0b\u5212\u7ebf\uff0c\u9996\u5b57\u6bcd\u4e0d\u80fd\u4ee5\u6570\u5b57\u5f00\u5934</li> <li>\u4f8b\u5982<ul> <li>\u6b63\u5e38\u53d8\u91cf\uff1a<code>BASE_DIR</code>,<code>File_Name</code>,<code>AEG3</code>,<code>_DIR</code> \u7b49\u90fd\u662f\u6b63\u5e38\u7684\u53d8\u91cf</li> <li>\u65e0\u6548\u53d8\u91cf\uff1a<code>1file</code>,<code>#dir</code></li> </ul> </li> <li>\u53d8\u91cf\u540d\u4e2d\u95f4\u4e0d\u80fd\u4f7f\u7528\u7a7a\u683c\u6216\u6807\u70b9\u7b26\u53f7</li> <li>\u4f8b\u5982\uff1a<code>DIR FILE</code>\uff0c<code>DIR?FILE</code> \u5c31\u4e3a\u65e0\u6548\u53d8\u91cf\uff0c</li> <li>\u53d8\u91cf\u547d\u540d\u4e0d\u80fd\u4f7f\u7528 base \u91cc\u9762\u7684\u5173\u952e\u5b57\uff08help \u6765\u67e5\u770b\u5173\u952e\u5b57\uff09</li> <li>Shell \u53d8\u91cf\u5927\u5c0f\u5199\u654f\u611f\uff0c\u4e5f\u5c31\u662f\u5b9a\u4e49\u4e3a\u5927\u5199\u7684\u53d8\u91cf\u540d\uff0c\u5f15\u7528\u7684\u65f6\u5019\u5fc5\u987b\u5b8c\u5168\u4e00\u81f4\u3002</li> <li>\u4f8b\u5982:<code>DIRNAME</code> \u548c <code>dirname</code> \u5c31\u662f\u4e24\u4e2a\u4e0d\u540c\u7684\u53d8\u91cf</li> </ul>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#32-\u8d4b\u503c\u89c4\u8303","title":"3.2 \u8d4b\u503c\u89c4\u8303","text":"<ul> <li> <p>\u53d8\u91cf\u4e0e\u503c\u76f4\u63a5\u4f7f\u7528 \"=\" \u8fde\u63a5\uff0c\u7b49\u53f7\u4e24\u8fb9\u4e0d\u80fd\u5b58\u5728\u7a7a\u767d\u5b57\u7b26</p> </li> <li> <p>\u4f8b\u5982\uff1a <code>dirname = \"/tmp\"</code> \u6539\u8d4b\u503c\u65b9\u6cd5\u5c31\u662f\u9519\u8bef\u7684</p> </li> <li> <p>\u5982\u679c\u503c\u4e2d\u6709\u7a7a\u767d\u5b57\u7b26\uff0c\u4f7f\u7528\u5355\u5f15\u53f7\u6216\u53cc\u5f15\u53f7\u5f15\u8d77\u6765\uff0c\u53cc\u5f15\u53f7\u5bf9\u4e8e\u5176\u4e2d\u5f15\u7528\u7684\u503c\u5c06\u4f1a\u6839\u636e\u5176\u5185\u5bb9\u8f6c\u5316\uff0c\u5355\u5f15\u53f7\u5185\u7684\u7279\u6b8a\u5b57\u7b26\u5219\u4e00\u5f8b\u5f53\u5b57\u7b26\u4e32\u8fdb\u884c\u5904\u7406\u3002</p> </li> <li> <p>\u4f8b\u5982\uff1a<code>DIRNAME=\"$PATH\"</code> \u7684\u503c\u4e3a\u7cfb\u7edf PATH \u5b9e\u9645\u7684\u53ef\u6267\u884c\u6587\u4ef6\u8def\u5f84\uff0c<code>DIRNAME='$PATH'</code> \u7684\u503c\u4e3a $PATH \u7684\u5b57\u7b26\u4e32\u3002</p> </li> <li> <p>\u53ef\u7528 <code>\\</code> \u6765\u8f6c\u8bd1\u53d8\u91cf\uff0c\u8ba9\u5176\u53d8\u4e3a\u4e00\u822c\u5b57\u7b26\u3002</p> </li> <li> <p>\u4f8b\u5982\uff1a<code>DIRNAME=\\$PATH</code> \u7684\u503c\u4e3a $PATH \u7684\u5b57\u7b26\u4e32\u3002</p> </li> <li> <p>\u5982\u679c\u53d8\u91cf\u7684\u503c\u4e3a\u6307\u4ee4\uff0c\u53ef\u7528\u4f7f\u7528\u53cd\u6487\u53f7\uff0c\u6216 $() \u6765\u65f6\u5f15\u7528\u3002</p> </li> <li> <p>\u4f8b\u5982\uff1a\u4e0b\u9762\u4e24\u4e2a\u662f\u4e00\u6837\u7684</p> </li> <li> <p><code>bash   DATE=`date`   DATE=$(date)</code></p> </li> <li> <p>\u5728\u811a\u672c\u4e2d\u5b9a\u4e49\u666e\u901a\u5b57\u7b26\u4e32\u53d8\u91cf\u65f6\uff0c\u5e94\u5c3d\u91cf\u628a\u53d8\u91cf\u7684\u5185\u5bb9\u7528\u53cc\u5f15\u53f7\u62ec\u8d77\u6765\uff1b</p> </li> <li> <p>\u4f8b\u5982\uff1a<code>DIRNAME=\"/tmp\"</code></p> </li> <li> <p>\u5355\u7eaf\u6570\u5b57\u7684\u53d8\u91cf\u5185\u5bb9\u53ef\u4ee5\u4e0d\u52a0\u5f15\u53f7\uff1b</p> </li> <li> <p>\u4f8b\u5982\uff1a<code>NUM=10</code></p> </li> </ul>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#4-\u53d8\u91cf\u7684\u5206\u7c7b","title":"4. \u53d8\u91cf\u7684\u5206\u7c7b","text":"<p>Shell \u7684\u53d8\u91cf\u6709\u4e09\u79cd\u5206\u7c7b\uff0c\u6bcf\u79cd\u90fd\u6709\u5176\u4e0d\u540c\u7684\u4f5c\u7528\u8303\u56f4</p>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#41-\u5c40\u90e8\u53d8\u91cf","title":"4.1 \u5c40\u90e8\u53d8\u91cf","text":"<p>\u5c40\u90e8\u53d8\u91cf\uff0c\u6545\u540d\u601d\u4e49\u5176\u53ea\u5728 Shell \u811a\u672c\u4e2d\u5b9a\u4e49\u7684\u53d8\u91cf\uff0c\u6216\u5728 Shell \u811a\u672c\u51fd\u6570\u4e2d\u5b9a\u4e49\u7684\u53d8\u91cf\uff0c\u53ea\u80fd\u5728 Shell \u811a\u672c\u4e2d\u4f7f\u7528\uff0c\u6216\u53ea\u80fd\u5728 Shell \u811a\u672c\u51fd\u6570\u4e2d\u4f7f\u7528</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>[root@master Shell]# cat local_var.sh #!/bin/bash\nDIR=/tmp\necho \"dir is ${DIR}\"\n[root@master Shell]# bash local_var.sh dir is /tmp\n[root@master Shell]# echo \"dir is ${DIR}\"\ndir is </code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u51fa\u5728\u811a\u672c\u5185\u90e8\u5b9a\u4e49\u7684\u53d8\u91cf <code>DIR</code> \u53ea\u5728 <code>local_var</code> \u811a\u672c\u5185\u53ef\u4ee5\u4f7f\u7528\uff0c\u5728\u5168\u5c40\u4e0b\u6ca1\u6709\u6b64\u53d8\u91cf\uff0c\u540e\u671f\u6211\u4eec\u5b66\u5230\u51fd\u6570\u518d\u6765\u8bf4\u660e\u51fd\u6570\u4e2d\u7684\u5c40\u90e8\u53d8\u91cf\u3002</p>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#42-\u73af\u5883\u53d8\u91cf","title":"4.2 \u73af\u5883\u53d8\u91cf","text":"<p>\u73af\u5883\u53d8\u91cf\u4e3a\u5f53\u524d Shell \u4e2d\u5b9a\u4e49\u7684\u4e34\u65f6\u53d8\u91cf\uff0c\u5728\u5f53\u524d Shell \u5b9a\u4e49\u7684\u53d8\u91cf\u53ef\u4ee5\u4f20\u9012\u7ed9\u5b50 Shell\uff0c\u6ca1\u6709\u7236\u5b50\u5173\u7cfb\u7684 Shell \u4e0d\u80fd\u4f7f\u7528\u6b64\u53d8\u91cf\uff0c\u5f53\u7136\u53ef\u4ee5\u5229\u7528 <code>export</code> \u5c06\u5f53\u524d Shell \u7684\u53d8\u91cf\u4f20\u9012\u7ed9\u5176\u4ed6\u7ec8\u7aef\u7684 Shell \u4e2d\u3002</p> <p>\u5f53\u524d Shell \u4e3a\u7236 Shell\uff0c\u5728\u5176\u4e0a\u8fd0\u884c <code>bash</code> \u5c31\u53ef\u4ee5\u8fdb\u5165\u5230\u5b50 Shell \u4e2d\uff0c\u8ba9\u6211\u4eec\u6765\u770b\u793a\u4f8b</p> <pre><code># \u5728\u5f53\u524dShell\u4e2d\u5b9a\u4e49\u53d8\u91cfSTR\n[root@master Shell]# STR=\"Shell\"                        [root@master Shell]# echo \"hello ${STR}\"\nhello Shell\n# \u8fd0\u884c\u547d\u4ee4bash\u8fdb\u5165\u5b50Shell\n[root@master Shell]# bash\n# \u5728\u5b50Shell\u4e2d\u67e5\u770b\u6ca1\u6709\u53d8STR\n[root@master Shell]# echo \"hello ${STR}\"\nhello # \u9000\u51fa\u5b50Shell\u4f1a\u5230\u7236Shell\n[root@master Shell]# exit\nexit\n# \u5229\u7528export\u5bfc\u5165\u73af\u5883\u53d8\u91cf\n[root@master Shell]# export STR=\"Shell\"\n# \u5728\u6b64\u8fdb\u5165\u5b50Shell\n[root@master Shell]# bash\n# \u67e5\u770b\u5b50Shell\u4e2d\u5df2\u7ecf\u6709\u4e86\u53d8\u91cfSTR\n[root@master Shell]# echo \"hello ${STR}\"\nhello Shell\n</code></pre> <p>\u73af\u5883\u53d8\u91cf\u4e3a\u4e34\u65f6\u7684\uff0c\u5728\u6211\u4eec\u542f\u52a8\u7ec8\u7aef\u7684\u65f6\u5019\uff0c\u7cfb\u7edf\u4f1a\u4ece\u7279\u5b9a\u7684\u6587\u4ef6\u4e2d\u52a0\u8f7d\u4e00\u7cfb\u5217\u73af\u5883\u53d8\u91cf\u3002</p> <p>\u7cfb\u7edf\u4e2d\u8fd8\u6709\u4e00\u4e9b\u7cfb\u7edf\u5185\u7f6e\u7684\u53d8\u91cf\uff0c\u4f8b\u5982 <code>PATH</code>\uff0c<code>USER</code> \u7b49\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u547d\u4ee4 env \u6216 export \u6765\u67e5\u770b\u5f53\u524d Shell \u7684\u73af\u5883\u53d8\u91cf\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master Shell]# env\nXDG_SESSION_ID=1276\nHOSTNAME=master\nSELINUX_ROLE_REQUESTED=\nShell=/bin/bash\nTERM=xterm\nHISTSIZE=1000\nSSH_CLIENT=61.150.11.174 55929 22\nSELINUX_USE_CURRENT_RANGE=\nSSH_TTY=/dev/pts/0\nUSER=root\n...\n# \u67e5\u770b\u5f53\u524dShell\n[root@master Shell]# echo $Shell\n/bin/bash\n# \u67e5\u770b\u53ef\u6267\u884c\u547d\u4ee4\u7684\u8def\u5f84\n[root@master Shell]# echo $PATH\n/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin\n# \u67e5\u770b\u5f53\u524d\u767b\u5f55\u7cfb\u7edf\u7528\u6237\n[root@master Shell]# echo $USER\nroot\n</code></pre> <p>linux \u7cfb\u7edf\u7684\u4e00\u4e9b\u5185\u7f6e\u53c2\u6570</p> <pre><code>$Shell      \u9ed8\u8ba4 Shel\n$HOME       \u5f53\u524d\u7528\u6237\u5bb6\u76ee\u5f55\n$IFS        \u5185\u90e8\u5b57\u6bb5\u5206\u9694\u7b26\n$LANG       \u9ed8\u8ba4\u8bed\n$PATH       \u9ed8\u8ba4\u53ef\u6267\u884c\u7a0b\u5e8f\u8def\u5f84\n$PWD        \u5f53\u524d\u76ee\u5f55\n$UID        \u5f53\u524d\u7528\u6237 ID\n$USER       \u5f53\u524d\u7528\u6237\n$HISTSIZE   \u5386\u53f2\u547d\u4ee4\u5927\u5c0f\uff0c\u53ef\u901a\u8fc7 HISTTIMEFORMAT \u53d8\u91cf\u8bbe\u7f6e\u547d\u4ee4\u6267\u884c\u65f6\u95f4\n$RANDOM     \u968f\u673a\u751f\u6210\u4e00\u4e2a 0 \u81f3 32767 \u7684\u6574\u6570\n$HOSTNAME   \u4e3b\u673a\u540d\n</code></pre>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#43-\u5168\u5c40\u53d8\u91cf","title":"4.3 \u5168\u5c40\u53d8\u91cf","text":"<p>\u5168\u5c40\u53d8\u91cf\u4e3a\u5728\u5f53\u524d Shell \u8fdb\u7a0b\u4e2d\u8fd0\u884c\u7684\u811a\u672c\u90fd\u53ef\u4ee5\u4f7f\u7528\u8be5\u53d8\u91cf\uff0c\u5728 Shell \u4e2d\u9ed8\u8ba4\u5b9a\u4e49\u7684\u53d8\u91cf\u5c31\u662f\u5168\u5c40\u53d8\u91cf\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master Shell]# cat global_var1.sh #!/bin/bash\necho \"${STR1}\"              # \u67e5\u770bSTR1\u53d8\u91cf\u7684\u5185\u5bb9\nSTR2=\"sh\"                           # \u5b9a\u4e49STR2\u53d8\u91cf\u7684\u503c\u4e3ash\n[root@master Shell]# cat global_var2.sh #!/bin/bash\necho \"${STR2}\"              # \u67e5\u770bSTR2\u53d8\u91cf\u7684\u5185\u5bb9\n[root@master Shell]# STR1=\"Shell\"                    [root@master Shell]# . ./global_var1.sh Shell\n[root@master Shell]# . ./global_var2.sh sh\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u51fa\u5229\u7528<code>.</code> \u6765\u8fd0\u884c Shell \u811a\u672c\uff0c\u662f\u5728\u5f53\u524d\u7528\u6237\u767b\u5f55\u7684 Shell \u7ec8\u7aef\u4e2d\u8fd0\u884c\uff0c\u5176\u53d8\u91cf\u662f\u5728\u5f53\u524d Shell \u8fdb\u7a0b\u4e2d\u53ef\u4ee5\u5171\u4eab\u7684\u3002</p>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#5-\u5b9e\u4f8b","title":"5. \u5b9e\u4f8b","text":"<p>\u6211\u4eec\u901a\u8fc7\u7b80\u5355\u7f16\u5199\u4e00\u4e2a\u83b7\u53d6\u5f53\u524d\u7528\u6237\u767b\u5f55\u4fe1\u606f\u7684\u811a\u672c\uff0c\u6765\u5c55\u793a\u76ee\u524d\u767b\u5f55\u7528\u6237\u7684\u4fe1\u606f</p> <pre><code>[root@master Shell_var]# cat login_info.sh  #!/bin/bash\n# Description: login info scripts\n# Auth: kaliarch\n# Email: kaliarch@163.com\n# function: show user info\n# Date: 2020-03-08 13:36\n# Version: 1.0\necho \"\u5f53\u524d\u767b\u5f55\u7cfb\u7edf\u7528\u4e3a:  ${USER}\"\necho \"\u5f53\u524d\u767b\u5f55\u7cfb\u7edf\u65f6\u95f4:  $(date +\"%Y-%m-%d %H:%M:%S\")\"\necho \"\u5f53\u524d\u767b\u5f55\u7cfb\u7edfShell: ${Shell}\"\necho \"\u5f53\u524d\u7528\u6237\u5bb6\u76ee\u5f55\u4e3a:  ${HOME}\"\n# \u8fd0\u884c\u811a\u672c\u67e5\u770b\u5185\u5bb9\n[root@master Shell_var]# bash login_info.sh \u5f53\u524d\u767b\u5f55\u7cfb\u7edf\u7528\u4e3a:  root\n\u5f53\u524d\u767b\u5f55\u7cfb\u7edf\u65f6\u95f4:  2020-03-08 12:16:04\n\u5f53\u524d\u767b\u5f55\u7cfb\u7edfShell: /bin/bash\n\u5f53\u524d\u7528\u6237\u5bb6\u76ee\u5f55\u4e3a:  /root\n</code></pre>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#6-\u6ce8\u610f\u4e8b\u9879","title":"6. \u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u5728\u5f15\u7528\u53d8\u91cf\u662f\u6211\u4eec\u9075\u5b88\u89c4\u8303\uff0c\u5e26\u4e0a <code>{}</code>\uff0c\u53ef\u4ee5\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u9ebb\u70e6\u548c\u5751\uff1b</li> <li>\u547d\u540d\u53d8\u91cf\u89c1\u540d\u77e5\u610f\uff0c\u5f62\u6210\u6709\u81ea\u5df1\u4e00\u5957\u7684\u547d\u540d\u89c4\u8303\uff1b</li> <li>\u5b66\u4e60 Shell \u9700\u8981\u591a\u52a8\u624b\u5b9e\u8df5\uff0c\u5c06\u53d8\u91cf\u7684\u4e09\u79cd\u7c7b\u578b\u901a\u8fc7\u5b9e\u8df5\u771f\u6b63\u7406\u89e3\uff0c\u540e\u671f\u5728\u7f16\u5199 Shell \u7684\u65f6\u5019\u53ef\u4ee5\u7075\u6d3b\u8fd0\u7528\u3002</li> </ul>"},{"location":"Linux/shell/2.Shell%E5%8F%98%E9%87%8F/#7-\u5c0f\u7ed3","title":"7. \u5c0f\u7ed3","text":"<p>\u53d8\u91cf\u5728\u6211\u4eec Shell \u7f16\u7a0b\u4e2d\u7684\u6709\u8fd9\u72ec\u7279\u7684\u5730\u4f4d\uff0c\u5176\u5c06\u6211\u4eec\u7684\u4e00\u4e9b\u6570\u636e\u901a\u8fc7\u4e00\u6b21\u6027\u7684\u8d4b\u503c\uff0c\u5927\u5927\u589e\u5f3a\u4e86\u811a\u672c\u7684\u7075\u6d3b\u6027\u4e0e\u540e\u671f\u53ef\u7ef4\u62a4\u6027\u3002\u6211\u4eec\u9700\u8981\u901a\u8fc7\u672c\u7ae0\u8282\u5145\u5206\u7406\u89e3 Shell \u7684\u57fa\u672c\u64cd\u4f5c\u53ca\u5176\u79cd\u7c7b\uff0c\u5728\u7f16\u5199 Shell \u4e2d\u7075\u6d3b\u8fd0\u7528\uff0c\u9075\u5faa\u5b9a\u4e49\u53ca\u4f7f\u7528\u89c4\u8303\uff0c\u53ef\u4ee5\u4f7f\u5f97\u6211\u4eec\u7f16\u5199\u7684 Shell \u66f4\u52a0\u53cb\u597d\u53ca\u5065\u58ee\u3002</p>"},{"location":"Linux/shell/3.Shell%E5%8F%82%E6%95%B0/","title":"3.Shell \u53c2\u6570","text":""},{"location":"Linux/shell/3.Shell%E5%8F%82%E6%95%B0/#1-shell-\u53c2\u6570\u6982\u8ff0","title":"1. Shell \u53c2\u6570\u6982\u8ff0","text":"<p>\u5728 Shell \u811a\u672c\u7f16\u5199\u4e2d\uff0c\u6211\u4eec\u4e3a\u4e86\u4f7f\u5f97\u7a0b\u5e8f\u7075\u6d3b\u548c\u65e0\u72b6\u6001\uff0c\u6709\u4e9b\u53d8\u91cf\u6211\u4eec\u4e0d\u4fbf\u4e8e\u5728\u811a\u672c\u4e2d\u5199\u6b7b\uff0c\u9700\u8981\u8fd0\u7528\u5916\u90e8\u53c2\u6570\u4f20\u9012\u8fdb\u53bb\uff0c\u6bcf\u6b21\u4f20\u9012\u7684\u4e1c\u897f\u4e0d\u4e00\u6837\uff0c\u5f97\u5230\u7684\u7ed3\u679c\u4e5f\u4e0d\u5c3d\u76f8\u540c\uff0c\u53c2\u6570\u662f\u4e0e\u53d8\u91cf\u76f8\u8f85\u76f8\u6210\u7684\uff0c\u5c06\u53c2\u6570\u4f20\u9012\u8fdb Shell \u811a\u672c\u4e2d\uff0c\u4e5f\u5c31\u6210\u4e86\u53d8\u91cf\uff0c\u53c2\u6570\u7684\u4f7f\u7528\u4f7f\u5f97\u6211\u4eec\u7684\u811a\u672c\u66f4\u52a0\u7684\u7075\u6d3b\u548c\u53ef\u6269\u5c55\uff0c\u540c\u6837\u4e5f\u66f4\u6613\u7ef4\u62a4\u3002</p>"},{"location":"Linux/shell/3.Shell%E5%8F%82%E6%95%B0/#11-shell-\u53c2\u6570\u662f\u4ec0\u4e48","title":"1.1 Shell \u53c2\u6570\u662f\u4ec0\u4e48","text":"<p>Shell \u53c2\u6570\u662f\u6211\u4eec\u5728\u811a\u672c\u6587\u4ef6\u5916\u90e8\u4f20\u5165\u7684\u4e00\u7cfb\u5217\u53c2\u6570\uff0c\u6216\u662f\u5728 Shell \u811a\u672c\u4e2d\u7ed9\u51fd\u6570\u4f20\u9012\u7684\u53c2\u6570\uff0c\u5176\u5b9e\u8d28\u4e5f\u5c31\u662f\u4e0a\u4e00\u8282\u6211\u4eec\u5b66\u4e60\u7684\u53d8\u91cf\uff0c\u5176\u4e0e\u53d8\u91cf\u76f8\u8f85\u76f8\u6210\uff0c\u5171\u540c\u7ec4\u6210 Shell \u811a\u672c\u7684\u4e00\u90e8\u5206\u3002</p>"},{"location":"Linux/shell/3.Shell%E5%8F%82%E6%95%B0/#12-\u4e3a\u4ec0\u4e48\u8981\u7528\u53c2\u6570","title":"1.2 \u4e3a\u4ec0\u4e48\u8981\u7528\u53c2\u6570","text":"<p>\u6211\u4eec\u5728\u53d8\u91cf\u4e00\u8282\u77e5\u9053\u4e86\u4e3a\u4ec0\u4e48\u5229\u7528\u53d8\u91cf\uff0c\u5728\u6b64\u539f\u56e0\u4e0e\u53d8\u91cf\u7c7b\u4f3c\uff0c\u53c2\u6570\u7684\u4f7f\u7528\u4f7f\u5f97\u6211\u4eec\u7684 Shell \u811a\u672c\u66f4\u52a0\u7075\u6d3b\uff0c\u4e0d\u9700\u8981\u5728\u811a\u672c\u4e2d\u5199\u6b7b\u4e00\u4e9b\u540d\u79f0\uff0c\u6839\u636e\u7528\u6237\u7684\u8f93\u51fa\u5b8c\u6210\u7279\u5b9a\u7684\u529f\u80fd\uff0c\u4f8b\u5982\u7f16\u5199\u811a\u672c\u8ba1\u7b97 100 \u5185\u6570\u5b57\u7684\u548c\uff0c\u4f46\u662f\u5982\u679c\u4e3a\u4eec\u60f3\u8ba1\u7b97 1000 \u5462\uff1f100000 \u5462\uff1f\u6bcf\u6b21\u90fd\u9700\u8981\u4fee\u6539\u811a\u672c\u4e48\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u53c2\u6570\u4f20\u9012\u8fdb\u8ba1\u7b97\u811a\u672c\u4e2d\uff0c\u8fd9\u6837\u9700\u8981\u8ba1\u7b97\u591a\u5c11\u5c31\u53c8\u6211\u4eec\u81ea\u5df1\u63a7\u5236\uff0c\u8fd9\u6837\u7684\u811a\u672c\u4e5f\u66f4\u52a0\u7075\u6d3b\uff0c\u53c2\u6570\u8d4b\u4e88\u811a\u672c\u66f4\u5f3a\u5927\u7684\u529f\u80fd\u3002</p>"},{"location":"Linux/shell/3.Shell%E5%8F%82%E6%95%B0/#2-shell-\u53c2\u6570\u5206\u7c7b","title":"2. Shell \u53c2\u6570\u5206\u7c7b","text":"<p>\u6211\u4eec\u77e5\u9053\u4e86 Shell \u4e2d\u53c2\u6570\u662f\u4ec0\u4e48\uff0c\u6765\u770b\u4e00\u4e0b Shell \u811a\u672c\u4e2d\u53c2\u6570\u7684\u5206\u7c7b\u3002</p>"},{"location":"Linux/shell/3.Shell%E5%8F%82%E6%95%B0/#21-\u4f4d\u7f6e\u53c2\u6570","title":"2.1 \u4f4d\u7f6e\u53c2\u6570","text":"<p>\u4f4d\u7f6e\u53c2\u6570\u987e\u540d\u601d\u4e49\uff0c\u5c31\u662f\u4f20\u9012\u7ed9\u811a\u672c\u53c2\u6570\u7684\u4f4d\u7f6e\uff0c\u4f8b\u5982\u7ed9\u4e00\u4e2a\u811a\u672c\u4f20\u9012\u4e00\u4e2a\u53c2\u6570\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 Shell \u811a\u672c\u5185\u90e8\u83b7\u53d6\u4f20\u5165\u7684\u4f4d\u7f6e\u53c2\u6570\uff0c\u83b7\u53d6\u53c2\u6570\u7684\u683c\u5f0f\u4e3a\uff1a<code>$n</code>\u3002n \u4ee3\u8868\u4e00\u4e2a\u6570\u5b57\u3002\u4f8b\u5982\u4f20\u9012\u7ed9\u811a\u672c\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u5c31\u4e3a <code>$1</code>\uff0c\u7b2c 2 \u4e2a\u53c2\u6570\u5c31\u4e3a <code>$2</code>, \u4ee5\u6b64\u7c7b\u63a8\u2026\u2026\uff0c\u5176\u4e2d <code>$0</code> \u4e3a\u8be5\u811a\u672c\u7684\u540d\u79f0\u3002</p> <p>\u5728\u6211\u4eec\u8bb2\u89e3\u53d8\u91cf\u7684\u65f6\u5019\uff0c\u53d8\u91cf\u7684\u4e00\u6761\u89c4\u8303\u5c31\u662f\u540d\u5b57\u4e0d\u80fd\u4ee5\u6570\u5b57\u5f00\u5934\uff0c\u5728\u6b64\u5c31\u662f\u4e3a\u4e86\u907f\u514d\u4e0e Shell \u7684\u4f4d\u7f6e\u53c2\u6570\u76f8\u540c\u5f15\u53d1\u5f02\u5e38\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>[root@master Shell_args]# cat args1.sh #!/bin/bash\necho \"\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a: $1\"\necho \"\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a: $2\"\necho \"\u811a\u672c\u540d\u79f0\u4e3a: $0\"\n[root@master Shell_args]# bash args1.sh Shell linux\n\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a: Shell\n\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a: linux\n\u811a\u672c\u540d\u79f0\u4e3a: args1.sh\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4f20\u9012\u7ed9 <code>args1.sh</code> \u811a\u672c\u4e24\u4e2a\u4f4d\u7f6e\u53c2\u6570\uff0c\u7b2c\u4e00\u4e2a\u4e3a <code>python</code>, \u7b2c\u4e8c\u4e2a\u4e3a <code>go</code>, \u811a\u672c\u540d\u79f0\u4e3a <code>args1.sh</code></p>"},{"location":"Linux/shell/3.Shell%E5%8F%82%E6%95%B0/#22-\u7279\u6b8a\u53c2\u6570","title":"2.2 \u7279\u6b8a\u53c2\u6570","text":"<p>\u5728 Shell \u4e2d\u4e5f\u5b58\u5728\u7279\u6b8a\u542b\u4e49\u7684\u53c2\u6570\u5982\u4e0b\u8868\uff1a</p> \u53d8\u91cf \u542b\u4e49 $# \u4f20\u9012\u7ed9\u811a\u672c\u6216\u51fd\u6570\u7684\u53c2\u6570\u4e2a\u6570\u603b\u548c $* \u4f20\u9012\u7ed9\u811a\u672c\u6216\u51fd\u6570\u7684\u6240\u6709\u53c2\u6570\uff0c\u5f53\u88ab\u53cc\u5f15\u53f7 <code>\" \"</code> \u5305\u542b\u65f6\uff0c\u6240\u6709\u7684\u4f4d\u7f6e\u53c2\u6570\u88ab\u770b\u505a\u4e00\u4e2a\u5b57\u7b26\u4e32 $@ \u4f20\u9012\u7ed9\u811a\u672c\u6216\u51fd\u6570\u7684\u6240\u6709\u53c2\u6570\uff0c\u5f53\u88ab\u53cc\u5f15\u53f7 <code>\" \"</code> \u5305\u542b\u65f6\uff0c\u6bcf\u4e2a\u4f4d\u7f6e\u53c2\u6570\u88ab\u770b\u505a\u72ec\u7acb\u7684\u5b57\u7b26\u4e32 $? \u4e0a\u4e2a\u547d\u4ee4\u7684\u9000\u51fa\u72b6\u6001\uff0c\u6216\u51fd\u6570\u7684\u8fd4\u56de\u503c\uff0c0 \u4e3a\u6267\u884c\u6210\u529f\uff0c\u975e 0 \u5219\u4e3a\u6267\u884c\u5931\u8d25 $$ \u5f53\u524d Shell \u8fdb\u7a0b ID\u3002\u5bf9\u4e8e Shell \u811a\u672c\uff0c\u5c31\u662f\u8fd9\u4e9b\u811a\u672c\u6240\u5728\u7684\u8fdb\u7a0b ID\u3002 <p>\u793a\u4f8b\uff1a</p> <pre><code>[root@master Shell_args]# cat args2.sh                 \n#!/bin/bash\necho \"\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a: $1\"\necho \"\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a: $2\"\necho \"\u811a\u672c\u540d\u79f0\u4e3a: $0\"\necho \"\u811a\u672c\u63a5\u53d7\u53c2\u6570\u603b\u6570\u4e3a: $#\"\ncurl -I baidu.com\necho \"\u8fd0\u884c\u547d\u4ee4\u7684\u72b6\u6001\u4e3a:$?\"\necho \"\u811a\u672c\u7684ID\u4e3a:$$\"\necho \"\\$*\u7684\u7ed3\u679c\u4e3a:$*\"\necho \"\\$@\u7684\u7ed3\u679c\u4e3a:$@\"\nfor i in \"$*\";\ndo\necho $i\ndone\nfor j in \"$@\";\ndo echo $j\ndone\n# \u8fd0\u884c\u811a\u672c\u6765\u8fdb\u884c\u6d4b\u8bd5\n[root@master Shell_args]# bash args2.sh go python Shell\n\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a: go\n\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a: python\n\u811a\u672c\u540d\u79f0\u4e3a: args2.sh\n\u811a\u672c\u63a5\u53d7\u53c2\u6570\u603b\u6570\u4e3a: 3\nHTTP/1.1 200 OK\nDate: Sun, 08 Mar 2020 07:32:22 GMT\nServer: Apache\nLast-Modified: Tue, 12 Jan 2010 13:48:00 GMT\nETag: \"51-47cf7e6ee8400\"\nAccept-Ranges: bytes\nContent-Length: 81\nCache-Control: max-age=86400\nExpires: Mon, 09 Mar 2020 07:32:22 GMT\nConnection: Keep-Alive\nContent-Type: text/html\n\n\u8fd0\u884c\u547d\u4ee4\u7684\u72b6\u6001\u4e3a:0\n\u811a\u672c\u7684ID\u4e3a:23333\n$*\u7684\u7ed3\u679c\u4e3a:go python Shell\n$@\u7684\u7ed3\u679c\u4e3a:go python Shell\ngo python Shell\ngo\npython\nShell\n</code></pre> <p>\u6211\u4eec\u80fd\u591f\u901a\u8fc7\u4e0a\u8ff0\u4f8b\u5b50\u770b\u51fa\uff0c\u8fd0\u884c <code>curl -I baidu.com</code> \u7684\u8f93\u51fa\u4e3a 0\uff0c\u5373\u4e3a\u547d\u4ee4\u8fd0\u884c\u6b63\u5e38\uff0c\u83b7\u53d6\u5230\u4e86\u6b63\u5e38\u7684\u8fd4\u56de\u503c\uff1b</p> <p><code>$@</code>\u4e0e <code>$*</code> \u770b\u4e0a\u53bb\u5f88\u50cf\uff0c\u90fd\u662f\u4f20\u9012\u7ed9\u811a\u672c\u6216\u51fd\u6570\u7684\u6240\u6709\u53c2\u6570\uff1b</p> <p><code>$*</code> \u5f53\u88ab\u53cc\u5f15\u53f7 <code>\" \"</code> \u5305\u542b\u65f6\uff0c\u6240\u6709\u7684\u4f4d\u7f6e\u53c2\u6570\u88ab\u770b\u505a\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u6211\u4eec\u7528 for \u5faa\u73af\u904d\u5386\u7684\u65f6\u5019\u53ef\u4ee5\u770b\u5230\u8f93\u51fa\u4e3a\u4e00\u884c\uff1b</p> <p><code>$@</code>\u5f53\u88ab\u53cc\u5f15\u53f7 <code>\" \"</code> \u5305\u542b\u65f6\uff0c\u6bcf\u4e2a\u4f4d\u7f6e\u53c2\u6570\u88ab\u770b\u505a\u72ec\u7acb\u7684\u5b57\u7b26\u4e32\uff0c\u6211\u4eec\u7528 for \u5faa\u73af\u904d\u5386\u7684\u65f6\u5019\u53ef\u4ee5\u770b\u5230\u4e3a\u6bcf\u4e2a\u5b57\u7b26\u4e32\u8f93\u51fa\u4e3a\u5355\u72ec\u7684\u4e00\u884c\u3002</p>"},{"location":"Linux/shell/3.Shell%E5%8F%82%E6%95%B0/#3-shell-\u53c2\u6570\u7684\u4f7f\u7528","title":"3. Shell \u53c2\u6570\u7684\u4f7f\u7528","text":""},{"location":"Linux/shell/3.Shell%E5%8F%82%E6%95%B0/#31-\u811a\u672c\u4f20\u9012","title":"3.1 \u811a\u672c\u4f20\u9012","text":"<p>\u811a\u672c\u4f20\u9012\u53c2\u6570\uff0c\u5c31\u662f\u5728\u8fd0\u884c\u811a\u672c\u7684\u65f6\u5019\u901a\u8fc7\u4f4d\u7f6e\u53c2\u6570\u4f20\u9012\u8fdb\u811a\u672c\u5185\uff0c\u6bcf\u4e2a\u53c2\u6570\u5229\u7528\u4e00\u4e2a\u7a7a\u683c\u6765\u8fdb\u884c\u5206\u5272\uff0c\u5982\u679c\u4f20\u9012\u7684\u53c2\u6570\u672c\u8eab\u5c31\u6709\u7a7a\u683c\uff0c\u5219\u53ef\u4ee5\u5229\u7528 <code>\"\"</code> \u6765\u5f15\u8d77\u6765\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u6574\u4f53\u4f20\u9012\uff0c\u5728\u811a\u672c\u5185\u901a\u8fc7 <code>$n</code> \u6765\u83b7\u53d6\u3002</p> <pre><code>[root@master Shell_args]# cat args1.sh #!/bin/bash\necho \"\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a: $1\"\necho \"\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a: $2\"\necho \"\u811a\u672c\u540d\u79f0\u4e3a: $0\"\n[root@master Shell_args]# bash args1.sh go \"python Shell java\"\n\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a: go\n\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a: python Shell java\n\u811a\u672c\u540d\u79f0\u4e3a: args1.sh\n</code></pre> <p>\u4f8b\u5982\u6211\u4eec\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a\u4e00\u4e2a\u5e26\u6709\u7a7a\u683c\u7684\u591a\u4e2a\u5b57\u7b26\u4e32\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u53cc\u5f15\u53f7\u5f15\u8d77\u6765\u4f5c\u4e3a\u4e00\u4e2a\u4f4d\u7f6e\u53c2\u6570\u8fdb\u884c\u4f20\u5165\u3002</p>"},{"location":"Linux/shell/3.Shell%E5%8F%82%E6%95%B0/#32-\u51fd\u6570\u4f20\u9012","title":"3.2 \u51fd\u6570\u4f20\u9012","text":"<p>\u987e\u540d\u601d\u4e49\uff0c\u53c2\u6570\u4f20\u9012\u5c31\u662f\u5728\u51fd\u6570\u5916\u90e8\u8fdb\u884c\u53c2\u6570\u7684\u4f20\u5165\uff0c\u7531\u4e8e\u51fd\u6570\u90e8\u5206\u5728\u540e\u7eed\u6709\u4e13\u95e8\u7ae0\u8282\u8be6\u89e3\uff0c\u5728\u6b64\u6211\u4eec\u5c31\u4ee5\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\u8fdb\u884c\u8bf4\u660e\u3002\u51fd\u6570\u4f20\u9012\u4e0e\u811a\u672c\u4f20\u9012\u975e\u5e38\u7c7b\u4f3c\uff0c\u53ea\u662f\u5728\u8c03\u7528\u51fd\u6570\u7684\u65f6\u5019\u8fdb\u884c\u4f20\u9012\u4f4d\u7f6e\u53c2\u6570\u5373\u53ef\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master Shell_args]# cat args_fun.sh #!/bin/bash\n# \u51fd\u6570\u5b9a\u4e49\nfunction show_args() {\necho \"\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a: $1\"\necho \"\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a: $2\"\necho \"\u811a\u672c\u540d\u79f0\u4e3a: $0\"\n}\n# \u51fd\u6570\u8c03\u7528\nshow_args go Shell\n[root@master Shell_args]# bash args_fun.sh \u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a: go\n\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a: Shell\n\u811a\u672c\u540d\u79f0\u4e3a: args_fun.sh\n</code></pre> <p>\u5728\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6ca1\u6709\u901a\u8fc7\u5728\u811a\u672c\u5916\u90e8\u8fdb\u884c\u53c2\u6570\u4f20\u9012\uff0c\u800c\u662f\u5728\u8c03\u7528 <code>show_args</code> \u51fd\u6570\u7684\u65f6\u5019\u4f20\u5165\u6765\u4e24\u4e2a\u53c2\u6570\u3002</p>"},{"location":"Linux/shell/3.Shell%E5%8F%82%E6%95%B0/#4-\u5b9e\u4f8b","title":"4. \u5b9e\u4f8b","text":""},{"location":"Linux/shell/3.Shell%E5%8F%82%E6%95%B0/#41-\u9700\u6c42","title":"4.1 \u9700\u6c42","text":"<p>\u6211\u4eec\u6765\u505a\u4e00\u4e2a\u5185\u7f51\u6279\u91cf\u626b\u63cf\u53ef\u7528 IP \u811a\u672c\uff0c\u7528\u6765\u5224\u65ad\u67d0\u4e00\u4e2a\u7f51\u6bb5\u4e2d\u7684\u7f51\u7edc\u53ef\u8fbe\u6027\u3002</p>"},{"location":"Linux/shell/3.Shell%E5%8F%82%E6%95%B0/#42-\u601d\u8def","title":"4.2 \u601d\u8def","text":"<p>\u53ef\u4ee5\u5229\u7528 <code>ping</code> \u547d\u4ee4\u6765\u68c0\u6d4b\u53ef\u4ee5 ping \u901a\u7684 IP\uff0c\u5c06\u8fd4\u56de\u6b63\u5e38\u7684\u5185\u5165\u8bb0\u5f55\u5728 <code>success.log</code> \u4e2d\uff0c\u5931\u8d25\u7684\u5185\u5bb9\u8bb0\u5f55\u5728 <code>fail.log</code> \u4e2d\u3002</p> <p>\u4f20\u9012\u4e24\u4e2a\u53c2\u6570\uff0c\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a\u7f51\u7edc\u524d\u7f00\uff0c\u4f8b\u5982 <code>192.168.0.</code>\uff0c\u7136\u540e\u5728\u811a\u672c\u5185\u90e8\u5faa\u73af <code>1-255</code> \u6765\u68c0\u6d4b\u3002</p> <p>\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a ping \u5305\u7684\u4e2a\u6570\uff0c\u5982\u679c\u5305\u592a\u591a\uff0c\u65f6\u95f4\u82b1\u8d39\u592a\u957f\uff0c\u592a\u77ed\u6709\u53ef\u80fd\u9020\u6210\u8bef\u5224\uff0c\u5728\u6b64\u6211\u4eec\u5efa\u8bae\u4f7f\u7528 2 \u4e2a\u5305\u6765\u5224\u65ad\u3002</p>"},{"location":"Linux/shell/3.Shell%E5%8F%82%E6%95%B0/#43-\u5b9e\u73b0","title":"4.3 \u5b9e\u73b0","text":"<pre><code>[root@master Shell_args]# cat ping.sh #!/bin/bash\n# Description: net check scripts\n# Auth: kaliarch\n# Email: kaliarch@163.com\n# function: net check\n# Date: 2020-03-08 14:00\n# Version: 1.0\n# \u65e5\u5fd7\u76ee\u5f55\nLOG_DIR=\"/tmp/netlog/\"\n# \u5982\u679c\u65e5\u5fd7\u76ee\u5f55\u4e0d\u5b58\u5728\u5219\u521b\u5efa\n[ ! -d ${LOG_DIR} ] &amp;&amp; mkdir -p ${LOG_DIR}\n# \u5b9a\u4e49\u6210\u529f\u4e0e\u5931\u8d25\u65e5\u5fd7\u6587\u4ef6\nSUCCESS_LOGFILE=\"success.log\"\nFAIL_LOGFILE=\"fail.log\"\n# \u7f51\u7edc\u524d\u7f00\nNET_PREFIX=$1\n# \u68c0\u6d4b\u5305\u6570\u91cf\nPACKAGE_NUM=$2\nfor num in `seq 1 255`;\ndo\n# \u8fdb\u884cping\u68c0\u6d4b\necho \"check ${NET_PREFIX}${num}...\"\nping -c ${PACKAGE_NUM} ${NET_PREFIX}${num} &amp;&gt;/dev/null\n# \u5982\u679c\u8fd4\u56de\u6b63\u5e38\u5219\u8bb0\u5f55\u53ef\u4ee5ping\u901a\u7684ip\u5230successlog\u4e2d\n[ $? -eq 0 ] &amp;&amp; echo ${NET_PREFIX}${num} &gt;&gt; ${LOG_DIR}${SUCCESS_LOGFILE} || echo ${NET_PREFIX}${num} &gt;&gt; ${LOG_DIR}${SUCCESS_LOGFILE}\ndone\n# \u6d4b\u8bd5\n[root@master Shell_args]# bash ping.sh 172.16.60. 2\ncheck 172.16.60.1...\ncheck 172.16.60.2...\ncheck 172.16.60.3...\ncheck 172.16.60.4...\ncheck 172.16.60.5...\ncheck 172.16.60.6...\n</code></pre> <p>\u5f53\u811a\u672c\u8fd0\u884c\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u5728 <code>/tmp/netlog/</code> \u76ee\u5f55\u4e0b\u67e5\u770b\u6210\u529f\u4e0e\u5931\u8d25\u7684 IP \u4fe1\u606f\u3002</p>"},{"location":"Linux/shell/3.Shell%E5%8F%82%E6%95%B0/#5-\u6ce8\u610f\u4e8b\u9879","title":"5. \u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u9700\u8981\u5728\u5b9e\u6218\u4e2d\u7406\u89e3\u53c2\u6570\u7684\u7279\u6b8a\u7528\u5904\uff0c\u5728\u7f16\u5199\u811a\u672c\u4e2d\u5c3d\u53ef\u80fd\u591a\u7528\u53c2\u6570\uff0c\u4f7f\u5f97\u811a\u672c\u65e0\u72b6\u6001\uff1b</li> <li>\u9700\u8981\u7406\u89e3 <code>$@</code>\u4e8e <code>$*</code> \u4e24\u4e2a\u7684\u4e0d\u540c\u4e4b\u5904\uff0c\u5728\u4f7f\u7528\u5faa\u73af\u7684\u65f6\u5019\u9700\u8981\u683c\u5916\u6ce8\u610f\uff1b</li> <li>\u5728\u5229\u7528\u4f4d\u7f6e\u53c2\u6570\u4f20\u5165\u811a\u672c\u7684\u65f6\u5019\uff0c\u6700\u597d\u5229\u7528\u53d8\u91cf\u53bb\u63a5\u6536\u4f20\u9012\u7684\u5916\u90e8\u4f4d\u7f6e\u53c2\u6570\uff0c\u4fbf\u4e8e\u6211\u4eec\u5728\u811a\u672c\u5185\u8bc6\u522b\u53c2\u6570\u7684\u5177\u4f53\u542b\u4e49\u3002</li> </ul>"},{"location":"Linux/shell/3.Shell%E5%8F%82%E6%95%B0/#6-\u5c0f\u7ed3","title":"6. \u5c0f\u7ed3","text":"<p>\u53c2\u6570\u4e0e\u53d8\u91cf\u662f\u76f8\u8f85\u76f8\u6210\u7684\uff0c\u5c06\u53d8\u91cf\u4f20\u9012\u8fdb\u811a\u672c\u6216\u51fd\u6570\u5c31\u4e3a\u53c2\u6570\uff0c\u811a\u672c\u4e0e\u53d8\u91cf\u914d\u5408\u4f7f\u5f97\u6211\u4eec\u7684\u811a\u672c\u66f4\u52a0\u901a\u7528\uff0c\u9002\u5e94\u66f4\u5e7f\u7684\u9700\u6c42\u3002\u9700\u8981\u7262\u8bb0\u7279\u6b8a\u53c2\u6570\u7684\u5f62\u5f0f\uff0c\u5728\u540e\u671f\u7684 Shell \u7f16\u7a0b\u4e2d\uff0c\u8fd9\u4e9b\u53c2\u6570\u662f\u811a\u672c\u7f16\u7a0b\u7684\u57fa\u77f3\uff0c\u53ea\u6709\u57fa\u7840\u7262\u9760\uff0c\u540e\u7eed\u7684\u4f7f\u7528\u624d\u4f1a\u5f97\u5fc3\u5e94\u624b\uff0c\u5bf9\u4e0a\u8ff0\u7684\u4f8b\u5b50\u53ef\u4ee5\u4e3e\u4e00\u53cd\u4e09\uff0c\u4f8b\u5982\u63a2\u6d4b\u67d0\u4e00\u4e2a IP \u7684\u6240\u6709\u7aef\u53e3\u662f\u5426\u5f00\u653e\u7b49\uff0c\u5728\u5b9e\u9645\u5e94\u7528\u573a\u666f\u4e2d\u719f\u6089\u5404\u79cd\u53c2\u6570\u7684\u7528\u6cd5\u3002</p>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/","title":"4.Shell\u6570\u7ec4","text":""},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#4shell-\u6570\u7ec4","title":"4.Shell \u6570\u7ec4","text":""},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#1-shell-\u6570\u7ec4\u6982\u8ff0","title":"1. Shell \u6570\u7ec4\u6982\u8ff0","text":"<p>\u6211\u4eec\u5b66\u4e60\u4e86\u53d8\u91cf\uff0c\u77e5\u9053\u4e86\u53d8\u91cf\u4e3a\u5b58\u50a8\u5355\u4e2a\u5143\u7d20\u7684\u6700\u5c0f\u5355\u5143\uff0c\u672c\u8282\u6211\u4eec\u6765\u5b66\u4e60\u6570\u7ec4\u6765\u5b58\u653e\u591a\u4e2a\u5143\u7d20\u7684\u96c6\u5408\u3002</p>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#11-shell-\u6570\u7ec4\u662f\u4ec0\u4e48","title":"1.1 Shell \u6570\u7ec4\u662f\u4ec0\u4e48","text":"<p>\u987e\u540d\u601d\u4e49\uff0c\u6570\u7ec4\u5c31\u662f\u4e00\u7cfb\u5217\u6570\u636e\u7684\u96c6\u5408\uff0c\u8fd9\u4e2a\u6570\u636e\u5c31\u662f\u6211\u4eec\u4e4b\u524d\u5b66\u4e60\u7684\u5b58\u50a8\u5355\u4e2a\u5143\u7d20\u7684\u6700\u5c0f\u5355\u5143\u53d8\u91cf\uff0c\u4e5f\u5c31\u662f\u8bf4\u5c06\u4e00\u4e9b\u5217\u7684\u5143\u7d20\u6574\u5408\u5230\u4e00\u4e2a\u96c6\u5408\u5185\uff0c\u8fd9\u4e2a\u96c6\u5408\u7684\u540d\u79f0\u5c31\u53eb\u6570\u7ec4\u3002\u5f53\u7136\u4e0e\u5176\u4ed6\u8bed\u8a00\u4e00\u6837\uff0c\u6570\u7ec4\u5177\u5907\u51e0\u4e2a\u6761\u4ef6\uff0c\u5728 Shell \u4e2d\u6570\u7ec4\u4ec5\u652f\u6301\u4e00\u7ef4\u6570\u7ec4\uff0c\u6570\u7ec4\u5143\u7d20\u7684\u4e0b\u6807\u4ece 0 \u5f00\u59cb\uff0c\u6570\u7ec4\u5143\u7d20\u6ca1\u6709\u6700\u5927\u9650\u5236\u7b49\u3002</p>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#12-\u4e3a\u4ec0\u4e48\u8981\u7528\u6570\u7ec4","title":"1.2 \u4e3a\u4ec0\u4e48\u8981\u7528\u6570\u7ec4","text":"<p>\u4e0e\u53d8\u91cf\u7c7b\u4f3c\uff0c\u5f53\u6211\u4eec\u64cd\u4f5c\u6279\u91cf\u6570\u636e\u7684\u65f6\u5019\uff0c\u4e00\u4e2a\u4e00\u4e2a\u53d8\u91cf\u64cd\u4f5c\u975e\u5e38\u4e0d\u4fbf\uff0c\u6b64\u65f6\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u6570\u7ec4\u96c6\u5408\uff0c\u5bf9\u6574\u4e2a\u6570\u7ec4\u96c6\u5408\u8fdb\u884c\u904d\u5386\u6216\u5176\u4ed6\u64cd\u4f5c\uff0c\u6700\u7ec8\u5b9e\u73b0\u6279\u91cf\u7684\u6548\u679c\uff0c\u6570\u7ec4\u4f7f\u5f97\u6211\u4eec\u7684\u811a\u672c\u66f4\u5177\u6269\u5c55\u6027\u3002</p>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#13-\u53d8\u91cf\u4e0e\u6570\u7ec4\u7684\u5dee\u5f02","title":"1.3 \u53d8\u91cf\u4e0e\u6570\u7ec4\u7684\u5dee\u5f02","text":"<p>\u53d8\u91cf\u662f\u5b58\u50a8\u5355\u4e2a\u6570\u636e\u7684\u5355\u5143\uff0c\u5176\u5728\u5185\u5b58\u4e2d\u662f\u968f\u673a\u5b58\u50a8\u7684\uff0c\u6570\u7ec4\u662f\u5b58\u50a8\u4e00\u7cfb\u5217\u6570\u636e\u7684\u96c6\u5408\uff0c\u662f\u4e8b\u5148\u5728\u5185\u5b58\u4e2d\u5f00\u8f9f\u8fde\u7eed\u7684\u4e00\u7cfb\u5217\u7a7a\u95f4\uff0c\u4e4b\u540e\u5c06\u6570\u7ec4\u5143\u7d20\u6709\u5e8f\u7684\u5b58\u50a8\u5728\u5176\u4e2d\u3002</p>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#2-\u6570\u7ec4\u7684\u57fa\u672c\u4f7f\u7528","title":"2. \u6570\u7ec4\u7684\u57fa\u672c\u4f7f\u7528","text":""},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#21-\u6570\u7ec4\u7684\u5b9a\u4e49","title":"2.1 \u6570\u7ec4\u7684\u5b9a\u4e49","text":"<p>\u6570\u7ec4\u7684\u5b9a\u4e49\u6709\u4e24\u79cd\u65b9\u5f0f\uff0c\u53ef\u5206\u4e3a\u76f4\u63a5\u5b9a\u4e49\u548c\u5355\u5143\u7d20\u5b9a\u4e49\u3002</p>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#211-\u76f4\u63a5\u5b9a\u4e49","title":"2.1.1 \u76f4\u63a5\u5b9a\u4e49","text":"<p>\u6570\u7ec4\u7c7b\u4f3c\u4e8e\u53d8\u91cf\u5b9a\u4e49\uff0c\u53ea\u4e0d\u8fc7\u5c06\u91cc\u9762\u7684\u503c\u7528\u5c0f\u62ec\u53f7\u62ec\u8d77\u6765\uff0c\u5176\u4e2d\u6bcf\u4e2a\u5143\u7d20\u4f7f\u7528\u7a7a\u683c\u5206\u5272\u3002Shell \u662f\u5f31\u7c7b\u578b\u7684\uff0c\u6570\u7ec4\u4e2d\u5143\u7d20\u7684\u7c7b\u578b\u53ef\u4ee5\u4e0d\u4e00\u6837\uff0c\u4f8b\u5982\u5176\u4e2d\u53ef\u4ee5\u5305\u542b\u6570\u5b57\u4e0e\u5b57\u7b26\u4e32\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>ARG1=(1 2 3 \"hello Shell\")\n</code></pre> <p><code>ARG1</code> \u4e3a\u6570\u7ec4\u540d\u79f0\uff0c\u5176\u503c\u524d\u4e09\u4e2a\u4e3a\u6570\u5b57\uff0c\u6700\u540e\u4e00\u4e2a\u4e3a\u5b57\u7b26\u4e32\u3002</p>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#212-\u5355\u5143\u7d20\u5b9a\u4e49","title":"2.1.2 \u5355\u5143\u7d20\u5b9a\u4e49","text":"<p>Shell \u4e2d\u6570\u7ec4\u4e0b\u6807\u4ece 0 \u5f00\u59cb\uff0c\u5229\u7528\u5355\u4e2a\u5143\u7d20\u6765\u5b9a\u4e49\u6570\u7ec4\u3002</p> <p>\u4f8b\u5982:</p> <pre><code>[root@master scripts]# ARG2[0]=1\n[root@master scripts]# ARG2[1]=2\n[root@master scripts]# ARG2[2]=3\n[root@master scripts]# ARG2[3]=\"hello Shell\" </code></pre>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#22-\u5143\u7d20\u83b7\u53d6","title":"2.2 \u5143\u7d20\u83b7\u53d6","text":""},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#221-\u83b7\u53d6\u5355\u4e2a\u5143\u7d20","title":"2.2.1 \u83b7\u53d6\u5355\u4e2a\u5143\u7d20","text":"<p>\u4e0e\u53d8\u91cf\u7684\u5f15\u7528\u4e00\u6837\uff0c\u6570\u7ec4\u53ef\u4ee5\u83b7\u53d6\u5355\u4e2a\u4f4d\u7f6e\u7684\u5143\u7d20\uff0c\u5229\u7528 <code>${ARG[num]}</code>\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>[root@master scripts]# echo ${ARG1[0]}          //\u83b7\u53d6AEG1\u6570\u7ec4\u4e2d\u7b2c\u4e00\u4e2a\u5143\u7d20\n1\n[root@master scripts]# echo ${ARG1[3]}          //\u83b7\u53d6AEG1\u6570\u7ec4\u4e2d\u7b2c\u56db\u4e2a\u5143\u7d20\nhello Shell\n</code></pre>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#222-\u83b7\u53d6\u5168\u90e8\u5143\u7d20","title":"2.2.2 \u83b7\u53d6\u5168\u90e8\u5143\u7d20","text":"<ul> <li>\u83b7\u53d6\u6570\u7ec4\u503c</li> </ul> <p>\u83b7\u53d6\u6570\u7ec4\u5168\u90e8\u5143\u7d20\u4f7f\u7528 <code>${ARG[*]}</code> \u6216 <code>${ARG[@]}</code>\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>[root@master scripts]# echo ${ARG1[@]}\n1 2 3 hello Shell\n[root@master scripts]# echo ${ARG1[*]}\n1 2 3 hello Shell\n</code></pre> <ul> <li>\u83b7\u53d6\u6570\u7ec4\u4e0b\u6807</li> </ul> <p>\u83b7\u53d6\u6570\u7ec4\u5168\u90e8\u4e0b\u6807\u4f7f\u7528 <code>${!ARG[*]}</code> \u6216 <code>${!ARG[@]}</code>\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# echo ${!ARG1[@]}\n0 1 2 3\n[root@master ~]# echo ${!ARG1[*]}\n0 1 2 3\n</code></pre>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#223-\u83b7\u53d6\u6570\u7ec4\u957f\u5ea6","title":"2.2.3 \u83b7\u53d6\u6570\u7ec4\u957f\u5ea6","text":"<ul> <li>\u83b7\u53d6\u6574\u4e2a\u6570\u7ec4\u957f\u5ea6</li> </ul> <p>\u6570\u7ec4\u957f\u5ea6\u53ca\u6570\u7ec4\u4e2d\u5143\u7d20\u7684\u4e2a\u6570\uff0c\u53ef\u4ee5\u5229\u7528 <code>${#ARG[*]}</code> \u6216 <code>${#ARG[@]}</code>\uff0c\u6211\u4eec\u53d1\u73b0\u5176\u5b9e\u5c31\u662f\u5728\u83b7\u53d6\u6570\u7ec4\u5168\u90e8\u5143\u7d20\u524d\u6dfb\u52a0<code>#</code>\u6765\u83b7\u53d6\u6570\u7ec4\u4e2a\u6570\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>[root@master scripts]# echo ${#ARG1[*]}\n4\n[root@master scripts]# echo ${#ARG1[@]}\n4\n</code></pre> <ul> <li>\u83b7\u53d6\u5355\u4e2a\u5143\u7d20\u7684\u957f\u5ea6</li> </ul> <p>\u5bf9\u4e8e\u6570\u7ec4\u4e2d\u7684\u67d0\u4e2a\u5143\u6211\u4eec\u4e5f\u53ef\u4ee5\u8fdb\u884c\u957f\u5ea6\u7684\u83b7\u53d6\uff0c\u53ef\u4ee5\u5229\u7528 <code>${#ARG1[num]}</code>\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>[root@master scripts]# echo ${ARG1[@]} 100 2 3 hello Shell 10\n[root@master scripts]# echo ${ARG1[3]}      //\u83b7\u53d6\u7b2c\u56db\u4e2a\u5143\u7d20\u5185\u5bb9\u4e3a\uff1ahello Shell\nhello Shell\n[root@master scripts]# echo ${#ARG1[3]}     //\u83b7\u53d6\u56db\u4e2a\u5143\u7d20\u957f\u5ea6\u4e3a11\n11\n</code></pre>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#224-\u6570\u7ec4\u5143\u7d20\u7684\u4fee\u6539","title":"2.2.4 \u6570\u7ec4\u5143\u7d20\u7684\u4fee\u6539","text":"<p>\u6570\u7ec4\u53ef\u4ee5\u8fdb\u884c\u4e00\u4e9b\u5217\u5bf9\u5176\u5143\u7d20\u7684\u64cd\u4f5c\u3002</p> <ul> <li>\u4fee\u6539</li> </ul> <p>\u5bf9\u6570\u7ec4\u5143\u7d20\u7684\u4fee\u6539\uff0c\u76f4\u63a5\u5bf9\u5355\u4e2a\u5143\u7d20\u4fee\u6539\u5373\u53ef\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master scripts]# AEG1[0]=100\n[root@master scripts]# echo ${ARG1[@]}\n100 2 3 hello Shell\n</code></pre> <ul> <li>\u589e\u52a0</li> </ul> <p>\u5bf9\u6570\u7ec4\u5143\u7d20\u7684\u589e\u52a0\uff0c\u548c\u5bf9\u4fee\u6539\u4e00\u81f4\uff0c\u76f4\u63a5\u5bf9\u5355\u4e2a\u4f4d\u7f6e\u5143\u7d20\u589e\u52a0\u5373\u53ef\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master scripts]# ARG1[10]=10\n[root@master scripts]# echo ${ARG1[@]}\n100 2 3 hello Shell 10\n[root@master scripts]# echo ${#ARG1[@]}\n5\n</code></pre> <p>Tips\uff1a\u5728\u6b64\u6211\u4eec\u53d1\u73b0\u5143\u7d20\u4e4b\u524d\u6709 4 \u4e2a\u5143\u7d20\uff0c\u6211\u4eec\u5c06\u4e0b\u6807 10 \u7684\u5143\u7d20\u8d4b\u503c\u4e3a 10\uff0c\u6570\u7ec4\u662f\u6309\u7167\u4ece\u524d\u5f80\u540e\u987a\u5e8f\u8d4b\u503c\u7684\u3002</p> <ul> <li>\u5220\u9664</li> </ul> <p>\u5220\u9664\u6570\u7ec4\u53ef\u4ee5\u4f7f\u7528 unset\uff0c<code>unset ARG1[num]</code> \u53ef\u4ee5\u5220\u9664\u5bf9\u5e94\u4e0b\u6807\u7684\u6570\u7ec4\u5143\u7d20\uff0c\u5982\u679c\u4e0d\u5e26\u4e0b\u6807\u5219\u5220\u9664\u6570\u7ec4\u7684\u5168\u90e8\u5143\u7d20\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master scripts]# echo ${ARG1[@]} 100 3 hello Shell 10\n[root@master scripts]# unset ARG1[0]            //\u5220\u9664\u4e0b\u6807\u4e3a0\u7684\u5143\u7d20\n[root@master scripts]# echo ${ARG1[@]}\n3 hello Shell 10\n[root@master scripts]# unset ARG1           //\u5220\u9664\u6574\u4e2a\u6570\u7ec4\u5143\u7d20\n[root@master scripts]# echo ${ARG1[@]}\n</code></pre>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#225-\u6570\u7ec4\u7684\u5207\u7247","title":"2.2.5 \u6570\u7ec4\u7684\u5207\u7247","text":"<p>\u548c\u5176\u4ed6\u8bed\u8a00\u4e00\u6837\uff0c\u53ef\u4ee5\u5bf9\u6570\u7ec4\u8fdb\u884c\u5207\u7247\u4e5f\u79f0\u622a\u53d6\u64cd\u4f5c\u3002\u53ef\u4ee5\u901a\u8fc7 <code>${AEG1[@\u6216*]:\u8d77\u59cb\u4f4d\u7f6e\uff1a\u957f\u5ea6}</code> \u5bf9\u539f\u6570\u7ec4\u8fdb\u884c\u5207\u7247\uff0c\u8fd4\u56de\u7684\u4e3a\u5b57\u7b26\u4e32\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master scripts]# echo ${ARG1[@]}\n1 2 3 hello Shell\n[root@master scripts]# echo ${ARG1[@]:0:2}              //\u4ece\u7b2c1\u4e2a\u5143\u7d20\u5f80\u540e2\u4e2a\u5143\u7d20\u8fdb\u884c\u5207\u7247\n1 2\n</code></pre>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#226-\u6570\u7ec4\u7684\u66ff\u6362","title":"2.2.6 \u6570\u7ec4\u7684\u66ff\u6362","text":"<p>\u53ef\u4ee5\u66ff\u6362\u6570\u7ec4\u4e2d\u7684\u67d0\u4e00\u4e2a\u5143\u7d20\uff0c\u4f8b\u5982\u6211\u4eec\u5c06 <code>ARG1</code> \u6570\u7ec4\u4e2d\u7684\u7b2c 1 \u4e2a\u5143\u7d20\u66ff\u6362\u4e3a 110\u3002</p> <pre><code>[root@master scripts]# echo ${ARG1[@]}\n1 2 3 hello Shell\n[root@master scripts]# echo ${ARG1[@]/1/110}\n110 2 3 hello Shell\n</code></pre>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#3-shell-\u6570\u7ec4\u5206\u7c7b","title":"3. Shell \u6570\u7ec4\u5206\u7c7b","text":"<p>\u6211\u4eec\u77e5\u9053\u4e86 Shell \u4e2d\u6570\u7ec4\u7684\u57fa\u672c\u64cd\u4f5c\uff0c\u6765\u770b\u4e00\u4e0b\u6570\u7ec4\u7684\u5206\u7c7b\u3002</p>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#31-\u666e\u901a\u6570\u7ec4","title":"3.1 \u666e\u901a\u6570\u7ec4","text":"<p>\u666e\u901a\u6570\u7ec4\u5c31\u662f\u6211\u4eec\u4e0a\u9762\u4ee5\u6570\u5b57\u4e3a\u4e0b\u6807\u7684\u6570\u7ec4\uff0c\u4e0a\u8ff0\u7684\u4f8b\u5b50\u90fd\u4e3a\u666e\u901a\u6570\u7ec4\u3002</p>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#32-\u5173\u8054\u6570\u7ec4","title":"3.2 \u5173\u8054\u6570\u7ec4","text":"<p>\u5173\u8054\u6570\u7ec4\u662f\u53ef\u4ee5\u7528\u5b57\u7b26\u4e32\u5f53\u4f5c\u6570\u7ec4\u4e0b\u6807\u7684\u4e00\u7c7b\u6570\u7ec4\uff0c\u5728\u4f7f\u7528\u5173\u8054\u6570\u7ec4\u524d\uff0c\u5fc5\u987b\u5148\u4f7f\u7528 <code>declare -A</code> \u58f0\u660e\u5b83\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# declare -A ARGFILE                         //\u5b9a\u4e49\u7ba1\u7406\u6570\u7ec4\n[root@master ~]# ARGFILE=([name1]=Shell [name2]=linux [name3]=arg)      //\u5173\u8054\u6570\u7ec4\u5143\u7d20\u8d4b\u503c\n[root@master ~]# echo ${ARGFILE[@]}                         //\u67e5\u770b\u6240\u6709\u5143\u7d20\narg linux Shell\n[root@master ~]# echo ${ARGFILE[name1]}                 //\u67e5\u770b\u7d22\u5f15\u4e3aname1\u7684\u5143\u7d20\u503c\nShell\n</code></pre> <p>\u5f53\u7136\u4e5f\u53ef\u4ee5\u5bf9\u5355\u4e2a\u5143\u7d20\u8fdb\u884c\u8d4b\u503c\u64cd\u4f5c\uff0c \u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5173\u8054\u6570\u7ec4\u5c31\u6ca1\u6709\u6392\u5e8f\u4e86\uff0c\u7c7b\u4f3c\u4e8e\u5176\u4ed6\u8bed\u8a00\u4e2d\u7684\u5b57\u5178\uff0ckey \u503c\u4e5f\u662f\u5b57\u7b26\u4e32\u5f62\u5f0f\u3002</p> <pre><code>[root@master ~]# declare -A ARGLIST\n[root@master ~]# ARGLIST[n1]=1\n[root@master ~]# ARGLIST[n2]=2\n[root@master ~]# ARGLIST[n3]=\"hello Shell\" [root@master ~]# echo ${ARGLIST[@]}                 //\u83b7\u53d6\u5173\u8054\u6570\u7ec4\u7684\u6240\u6709\u503c\n2 hello Shell 1\n[root@master ~]# echo ${#ARGLIST[@]}                //\u83b7\u53d6\u5173\u8054\u6570\u7ec4\u7684\u5143\u7d20\u4e2a\u6570\n3\n[root@master ~]# echo ${!ARGLIST[@]}                //\u83b7\u53d6\u5173\u8054\u6570\u7ec4\u7684\u4e0b\u6807\nn2 n3 n1\n</code></pre>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#4-\u5b9e\u4f8b","title":"4. \u5b9e\u4f8b","text":""},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#41-\u9700\u6c42","title":"4.1 \u9700\u6c42","text":"<p>\u6211\u4eec\u60f3\u5229\u7528\u6570\u7ec4\u7edf\u8ba1 linux \u670d\u52a1\u5668\u7684\u6bcf 5 \u5206\u949f\u7684\u7f51\u7edc\u94fe\u63a5\u60c5\u51b5\uff0c\u67e5\u770b\u5904\u4e8e\u5404\u4e2a\u65f6\u95f4\u6bb5\u7684\u670d\u52a1\u5668 TCP \u94fe\u63a5\u7684\u60c5\u51b5\u3002</p>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#42-\u601d\u8def","title":"4.2 \u601d\u8def","text":"<p>\u53ef\u4ee5\u5229\u7528 <code>netstat -ant</code> \u547d\u4ee4\u6765\u67e5\u770b\u7f51\u7edc\u94fe\u63a5\u60c5\u51b5\uff0c\u4f46\u662f\u8f93\u51fa\u7684\u5185\u5bb9\u6211\u4eec\u53ea\u5173\u5fc3\u6700\u540e\u4e00\u5217\u7684\u72b6\u6001\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u5229\u7528 awk \u6765\u6253\u5370\u4ece\u7b2c\u4e8c\u884c\u5f00\u59cb\u5230\u6700\u540e\u4e00\u5217\u72b6\u6001\uff0c\u7531\u4e8e awk \u547d\u4ee4\u5728\u540e\u7eed\u6211\u4eec\u4f1a\u8be6\u89e3\uff0c\u5728\u6b64\u4ec5\u4f5c\u4e3a\u5de5\u5177\u4f7f\u7528\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# netstat -ant|awk 'NR&gt;2 {print $NF}'\nLISTEN\nLISTEN\nESTABLISHED\nTIME_WAIT\n</code></pre> <p>\u6253\u5370\u51fa\u6765\u7684\u5c31\u662f\u6700\u540e\u4e00\u5217\u7684\u72b6\u6001\uff0c\u6211\u4eec\u5c06\u5176\u5185\u5bb9\u4f5c\u4e3a\u6570\u7ec4\u7684\u4e0b\u6807\uff0c\u503c\u4e3a\u5176\u51fa\u73b0\u7684\u6b21\u6570\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u7edf\u8ba1 TCP \u94fe\u63a5\u5230\u72b6\u6001\uff0c\u914d\u5408\u5b9a\u65f6\u4efb\u52a1\u6765\u5b9a\u65f6\u7edf\u8ba1\u670d\u52a1\u5668\u7684 tcp \u94fe\u63a5\u72b6\u6001\u3002</p>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#43-\u5b9e\u73b0","title":"4.3 \u5b9e\u73b0","text":"<pre><code>[root@master Shell_args]# cat tcp_status.sh #!/bin/bash\n# Description: check tcp status\n# Auth: kaliarch\n# Email: kaliarch@163.com\n# function: net check\n# Date: 2020-03-14 14:00\n# Version: 1.0\n# \u65e5\u5fd7\u76ee\u5f55\nLOG_FILE=\"/tmp/tcp_status.log\"\n# \u5b9a\u4e49\u7ba1\u7406\u6570\u7ec4\ndeclare -A TCP_STATUS\n# \u5bf9\u6570\u7ec4\u8fdb\u884c\u5185\u5bb9\u8d4b\u503c\n# \u5229\u7528netstat\u547d\u4ee4\u6765\u8fc7\u6ee4\u51fa\u5173\u7cfb\u7684\u4e00\u5217\u6570\u636e\nfor status in $(netstat -ant|awk 'NR&gt;2 {print $NF}')\ndo\n# \u5bf9\u72b6\u6001\u76f8\u540c\u72b6\u6001\u7684TCP\u8fdb\u884c\u6570\u503c\u7d2f\u52a0\nlet TCP_STATUS[${status}]++\ndone\n# \u5c06\u7edf\u8ba1\u5b8c\u6210\u7684TCP\u94fe\u63a5\u72b6\u6001\u53ca\u6570\u636e\u8bb0\u5f55\u5230\u65e5\u5fd7\u4e2d\nfor i in ${!TCP_STATUS[@]}\ndo echo \"$(date +%F\" \"%H:%m)  \u670d\u52a1\u5668\u7684TCP\u72b6\u6001\u4e3a: ${i} \u7684\u6570\u91cf\u4e3a: ${TCP_STATUS[${i}]}\" &gt;&gt; ${LOG_FILE}\ndone\n# \u6d4b\u8bd5\n[root@master ~]# bash tcp_status.sh [root@master ~]# cat /tmp/tcp_status.log 2020-03-14 15:03  \u670d\u52a1\u5668\u7684TCP\u72b6\u6001\u4e3a: TIME_WAIT \u7684\u6570\u91cf\u4e3a: 138\n2020-03-14 15:03  \u670d\u52a1\u5668\u7684TCP\u72b6\u6001\u4e3a: ESTABLISHED \u7684\u6570\u91cf\u4e3a: 501\n2020-03-14 15:03  \u670d\u52a1\u5668\u7684TCP\u72b6\u6001\u4e3a: LISTEN \u7684\u6570\u91cf\u4e3a: 59\n</code></pre> <p>\u67e5\u770b\u6211\u4eec\u5355\u72ec\u8fd0\u884c\u811a\u672c\u5df2\u7ecf\u6210\u529f\uff0c\u53ef\u4ee5\u5c06\u8fd9\u4e2a\u811a\u672c\u52a0\u5165 crontab \u4e2d\uff0c\u6765\u5b9a\u65f6\u6267\u884c\uff0c\u540e\u671f\u5c31\u53ef\u4ee5\u901a\u8fc7\u65e5\u5fd7\u6765\u67e5\u770b\u5f53\u65f6\u670d\u52a1\u5668\u7684\u72b6\u6001\u4e86\u3002</p>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#5-\u6ce8\u610f\u4e8b\u9879","title":"5. \u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u9700\u8981\u5728\u5b9e\u6218\u4e2d\u7406\u89e3\u6570\u7ec4\u7684\u5177\u4f53\u7528\u9014\uff0c\u5c24\u5176\u6ce8\u610f\u5173\u8054\u6570\u7ec4\u7684\u7075\u6d3b\u8fd0\u7528\uff1b</li> <li>\u9700\u8981\u7406\u89e3\u6570\u7ec4\u7684\u5168\u90e8\u5143\u7d20\uff0c\u5143\u7d20\u4e0b\u6807\u4ee5\u53ca\u5143\u7d20\u7684\u5207\u7247\u548c\u66ff\u6362\uff0c\u5177\u4f53\u573a\u666f\u914d\u5408\u4f7f\u7528\uff1b</li> <li>\u6570\u7ec4\u4e00\u822c\u7528\u6765\u7edf\u8ba1\u6279\u91cf\u7684\u5185\u5bb9\uff0c\u4f8b\u5982\u6279\u91cf\u6587\u4ef6\u7684\u8ba1\u7b97\u7b49\uff0c\u914d\u5408\u5176\u4ed6\u547d\u4ee4\u4f7f\u7528\u3002</li> </ul>"},{"location":"Linux/shell/4.Shell%E6%95%B0%E7%BB%84/#6-\u5c0f\u7ed3","title":"6. \u5c0f\u7ed3","text":"<p>\u6570\u7ec4\u53ef\u8c13\u4e3a\u6211\u4eec\u5728 Shell \u7f16\u7a0b\u4e2d\u63d0\u4f9b\u4e86\u96c6\u5408\u7c7b\u578b\u6570\u636e\u5b58\u50a8\u7684\u65b9\u6848\uff0c\u5bf9\u4e8e\u6279\u91cf\u6570\u636e\u7684\u64cd\u4f5c\uff0c\u6570\u7ec4\u529f\u4e0d\u53ef\u6ca1\u3002\u5728\u5177\u4f53\u7684\u5b9e\u8df5\u4e2d\u6839\u636e\u6570\u636e\u7279\u5f81\uff0c\u660e\u786e\u9700\u6c42\u662f\u5229\u7528\u6570\u5b57\u4f5c\u4e3a\u4e0b\u6807\u7684\u6570\u7ec4\uff0c\u8fd8\u662f\u4f7f\u7528\u5173\u8054\u6570\u7ec4\uff0c\u6700\u540e\u5728\u5b9e\u8df5\u4e2d\u7075\u6d3b\u8fd0\u7528\u6570\u7ec4\u7684\u6574\u4f53\u957f\u5ea6\uff0c\u5207\u7247\uff0c\u66ff\u6362\u7b49\u64cd\u4f5c\uff0c\u914d\u5408\u5176\u4ed6\u547d\u4ee4\u5b9e\u73b0\u5177\u4f53\u4e1a\u52a1\u9700\u6c42\u3002</p>"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/","title":"5.Shell \u8fd0\u7b97\u7b26","text":""},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#1-shell-\u8fd0\u7b97\u7b26\u6982\u8ff0","title":"1. Shell \u8fd0\u7b97\u7b26\u6982\u8ff0","text":""},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#11-shell-\u8fd0\u7b97\u7b26\u662f\u4ec0\u4e48","title":"1.1 Shell \u8fd0\u7b97\u7b26\u662f\u4ec0\u4e48","text":"<p>\u4e0e\u5176\u4ed6\u8bed\u8a00\u4e00\u6837\uff0cShell \u4e5f\u6709\u8fd0\u7b97\u7b26\uff0c\u5728 Shell \u4e2d\u5176\u6839\u636e\u7c7b\u578b\u4e0d\u540c\u4e5f\u6709\u4e0d\u5c11\u8fd0\u7b97\u7b26\u5206\u7c7b\uff0c\u90a3\u4e48\u4ec0\u4e48\u662f\u8fd0\u7b97\u7b26\u5462\uff1f\u4f8b\u5982\u5927\u5bb6\u90fd\u77e5\u9053\u5728\u7b97\u672f\u8fd0\u7b97\u4e2d\u7684\u52a0\u51cf\u4e58\u9664\uff0c<code>+</code> \u5c31\u662f\u6211\u4eec Shell \u4e2d\u7684\u7b97\u672f\u8fd0\u7b97\u7b26\u7684\u4e00\u79cd\uff0c\u5f53\u7136\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u7684\u529f\u80fd\u5404\u5f02\u7684\u8fd0\u7b97\u7b26\uff0c\u4f5c\u4e3a\u6761\u4ef6\u5224\u65ad\u4e0e\u7b97\u672f\u64cd\u4f5c\u7b49\u91cd\u8981\u529f\u80fd\uff0c\u6784\u6210\u4e86 Shell \u4e2d\u7684\u57fa\u672c\u5143\u7d20\u3002</p>"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#12-\u4e3a\u4ec0\u4e48\u8981\u7528\u8fd0\u7b97\u7b26","title":"1.2 \u4e3a\u4ec0\u4e48\u8981\u7528\u8fd0\u7b97\u7b26","text":"<p>\u5f53\u6211\u4eec\u5bf9\u6570\u503c\u8fdb\u884c\u7b97\u672f\u8fd0\u7b97\uff0c\u5f53\u6211\u4eec\u9700\u8981\u5bf9\u6587\u4ef6\u8fdb\u884c\u5224\u65ad\uff0c\u5f53\u6211\u4eec\u9700\u8981\u591a\u903b\u8f91\u8fdb\u884c\u5224\u65ad\u7684\u65f6\u5019\uff0c\u8fd9\u4e9b\u60c5\u51b5\u90fd\u9700\u8981\u4f7f\u7528\u4e0d\u540c\u7c7b\u578b\u7684\u8fd0\u7b97\u7b26\uff0c\u4f7f\u5f97\u6211\u4eec\u811a\u672c\u66f4\u4e3a\u7075\u6d3b\u4fbf\u6377\u3002</p>"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#2-shell-\u8fd0\u7b97\u7b26\u5206\u7c7b","title":"2. Shell \u8fd0\u7b97\u7b26\u5206\u7c7b","text":"<p>\u6211\u4eec\u77e5\u9053\u4e86 shell \u4e2d\u8fd0\u7b97\u7b26\u662f\u4ec0\u4e48\u53ca\u5176\u529f\u80fd\uff0c\u63a5\u4e0b\u6765\u8ba9\u6211\u4eec\u770b\u4e00\u4e0b Shell \u811a\u672c\u8fd0\u7b97\u7b26\u7684\u5206\u7c7b\u53ca\u6bcf\u79cd\u8fd0\u7b97\u7b26\u7684\u57fa\u672c\u64cd\u4f5c\u3002</p>"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#21-\u7b97\u672f\u8fd0\u7b97\u7b26","title":"2.1 \u7b97\u672f\u8fd0\u7b97\u7b26","text":"<p>\u7b97\u672f\u8fd0\u7b97\u7b26\u987e\u540d\u601d\u4e49\uff0c\u5176\u5c31\u662f\u8fdb\u884c\u52a0\u51cf\u4e58\u9664\u6570\u503c\u8fd0\u7b97\uff0c\u5728 shell \u4e2d\uff0cbash \u4e0d\u652f\u6301\u539f\u751f\u7684\u6570\u5b66\u8fd0\u7b97\uff0c\u9700\u8981\u5229\u7528\u7b2c\u4e09\u65b9\u5de5\u5177\u6765\u5982 <code>let</code>\uff0c<code>expr</code> \u7b49\u6765\u5b9e\u73b0\u3002</p> \u8fd0\u7b97\u7b26 \u8bf4\u660e \u4e3e\u4f8b + \u52a0\u6cd5 <code>expr $a + $b</code> \u7ed3\u679c\u4e3a 30\u3002 - \u51cf\u6cd5 <code>expr $a - $b</code> \u7ed3\u679c\u4e3a -10\u3002 * \u4e58\u6cd5 <code>expr $a \\* $b</code> \u7ed3\u679c\u4e3a 200\u3002 / \u9664\u6cd5 <code>expr $b / $a</code> \u7ed3\u679c\u4e3a 2\u3002 % \u53d6\u4f59 <code>expr $b % $a</code> \u7ed3\u679c\u4e3a 0\u3002 = \u8d4b\u503c a=$b \u5c06\u628a\u53d8\u91cf b \u7684\u503c\u8d4b\u7ed9 a\u3002 == \u76f8\u7b49 \u7528\u4e8e\u6bd4\u8f83\u4e24\u4e2a\u6570\u5b57\uff0c\u76f8\u540c\u5219\u8fd4\u56de true\u3002 [$a == $b] \u8fd4\u56de false\u3002 != \u4e0d\u76f8\u7b49 \u7528\u4e8e\u6bd4\u8f83\u4e24\u4e2a\u6570\u5b57\uff0c\u4e0d\u76f8\u540c\u5219\u8fd4\u56de true\u3002 [$a != $b] \u8fd4\u56de true\u3002"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#211-let","title":"2.1.1 let","text":"<p>\u53ef\u4ee5\u5229\u7528 <code>let</code> \u5bf9\u6570\u503c\u8fdb\u884c\u8fd0\u7b97\uff0c<code>let C=$A+$B</code>, \u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# A=1\n[root@master ~]# B=2\n[root@master ~]# let C=${A}+${B}\n[root@master ~]# echo $C\n3\n</code></pre> <p>\u6ce8\u610f\uff1a<code>let</code> \u8fd0\u7b97\u540e\u9700\u8981\u5c06\u5176\u8d4b\u503c\u7ed9\u4e00\u4e2a\u53d8\u91cf\u3002</p>"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#212-expr","title":"2.1.2 expr","text":"<p>\u53ef\u4ee5\u5229\u7528 <code>expr</code> \u5bf9\u6570\u7ec4\u8fdb\u884c\u8fd0\u7b97\uff0c<code>C=$(expr $A+$B)</code>\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# C=`expr $A + $B`\n[root@master ~]# echo $C\n3\n</code></pre> <p>\u6ce8\u610f <code>+</code> \u53f7\u4e24\u8fb9\u9700\u8981\u6709\u7a7a\u683c\uff0c\u4e0d\u7136\u4f1a\u5c06\u5176\u5f53\u4f5c\u5b57\u7b26\u4e32\u8fde\u63a5</p>"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#213-","title":"2.1.3 []","text":"<p>\u53ef\u4ee5\u5229\u7528 <code>[]</code> \u6765\u5bf9\u6570\u503c\u8fdb\u884c\u8fd0\u7b97\uff0c<code>C=[A+B]</code>\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# C=$[$A+$B]\n[root@master ~]# echo $C\n3\n</code></pre>"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#214-","title":"2.1.4 (())","text":"<p>\u5229\u7528 <code>(())</code> \u6765\u5bf9\u6570\u503c\u8fdb\u884c\u8fd0\u7b97\uff0c<code>C=$(($A+$B))</code>\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# C=$(($A+$B))\n[root@master ~]# echo $C\n3\n</code></pre>"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#22-\u5173\u7cfb\u8fd0\u7b97\u7b26","title":"2.2 \u5173\u7cfb\u8fd0\u7b97\u7b26","text":"<p>\u4e86\u89e3\u4e86\u7b97\u672f\u8fd0\u7b97\uff0c\u63a5\u4e0b\u6765\u8ba9\u6211\u4eec\u5b66\u4e60\u5173\u7cfb\u8fd0\u7b97\u3002</p> \u6bd4\u8f83\u7b26 \u63cf\u8ff0 \u793a\u4f8b -eq\uff0cequal \u7b49\u4e8e [1 -eq 1] \u4e3a true -ne\uff0cnot equal \u4e0d\u7b49\u4e8e [ 1 -ne 1 \u4e3a false -gt\uff0cgreater than \u5927\u4e8e [2 -gt 1] \u4e3a true -lt\uff0clesser than \u5c0f\u4e8e [2 -lt 1] \u4e3a false -ge\uff0cgreater or equal \u5927\u4e8e\u6216\u7b49\u4e8e [2 -ge 1] \u4e3a true -le\uff0clesser or equal \u5c0f\u4e8e\u6216\u7b49\u4e8e [2 -le 1] \u4e3a false <p>\u5173\u7cfb\u8fd0\u7b97\u987e\u540d\u601d\u4e49\u5c31\u662f\u6bd4\u8f83\u6570\u5b57\u7684\u5927\u5c0f\uff0c\u6ce8\u610f\u5173\u7cfb\u8fd0\u7b97\u7b26\u4f5c\u7528\u7684\u4e3a\u6570\u5b57\uff0c\u4e0d\u80fd\u7528\u5176\u6765\u6bd4\u8f83\u5b57\u7b26\u4e32\u3002</p> <pre><code>#!/bin/bash\nnum1=1\nnum2=2\necho \"num1 \u4e3a\uff1a${num1}\"\necho \"num2 \u4e3a\uff1a${num2}\"\nif [ $num1 -eq $num2 ]\nthen\necho \"$num1 -eq $num2 : num1 \u7b49\u4e8e num2\"\nelse\necho \"$num1 -eq $num2: num1 \u4e0d\u7b49\u4e8e num2\"\nfi\nif [ $num1 -ne $num2 ]\nthen\necho \"$num1 -ne $num2: num1 \u4e0d\u7b49\u4e8e num2\"\nelse\necho \"$num1 -ne $num2 : num1 \u7b49\u4e8e num2\"\nfi\nif [ $num1 -gt $num2 ]\nthen\necho \"$num1 -gt $num2: num1 \u5927\u4e8e num2\"\nelse\necho \"$num1 -gt $num2: num1 \u4e0d\u5927\u4e8e num2\"\nfi\nif [ $num1 -lt $num2 ]\nthen\necho \"$num1 -lt $num2: num1 \u5c0f\u4e8e num2\"\nelse\necho \"$num1 -lt $num2: num1 \u4e0d\u5c0f\u4e8e num2\"\nfi\nif [ $num1 -ge $num2 ]\nthen\necho \"$num1 -ge $num2: num1 \u5927\u4e8e\u6216\u7b49\u4e8e num2\"\nelse\necho \"$num1 -ge $num2: num1 \u5c0f\u4e8e num2\"\nfi\nif [ $num1 -le $num2 ]\nthen\necho \"$num1 -le $num2: num1 \u5c0f\u4e8e\u6216\u7b49\u4e8e num2\"\nelse\necho \"$num1 -le $num2: num1 \u5927\u4e8e num2\"\nfi\n</code></pre> <p>\u8fd0\u884c\u7ed3\u679c\u4e3a\uff1a</p> <pre><code>num1 \u4e3a\uff1a1\nnum2 \u4e3a\uff1a2\n1 -eq 2: num1 \u4e0d\u7b49\u4e8e num2\n1 -ne 2: num1 \u4e0d\u7b49\u4e8e num2\n1 -gt 2: num1 \u4e0d\u5927\u4e8e num2\n1 -lt 2: num1 \u5c0f\u4e8e num2\n1 -ge 2: num1 \u5c0f\u4e8e num2\n1 -le 2: num1 \u5c0f\u4e8e\u6216\u7b49\u4e8e num2\n</code></pre>"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#23-\u5e03\u5c14\u8fd0\u7b97\u7b26","title":"2.3 \u5e03\u5c14\u8fd0\u7b97\u7b26","text":"<p>\u5e03\u5c14\u8fd0\u7b97\u7b26\u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u8bf4\u7684\u4e0e\u6216\u975e</p> \u8fd0\u7b97\u7b26 \u8bf4\u660e \u4e3e\u4f8b -a \u4e0e\u8fd0\u7b97\uff0c\u4e24\u4e2a\u8868\u8fbe\u5f0f\u90fd\u4e3a true \u624d\u8fd4\u56de true\u3002 [1 -lt 2 -a 10 -gt 2] \u8fd4\u56de true\u3002 -o \u6216\u8fd0\u7b97\uff0c\u6709\u4e00\u4e2a\u8868\u8fbe\u5f0f\u4e3a true \u5219\u8fd4\u56de true\u3002 [1 -lt 2 -o 2 -gt 10] \u8fd4\u56de true\u3002 ! \u975e\u8fd0\u7b97\uff0c\u8868\u8fbe\u5f0f\u4e3a true \u5219\u8fd4\u56de false\uff0c\u5426\u5219\u8fd4\u56de true\u3002 [! false] \u8fd4\u56de true\u3002 <p>\u4f8b\u5982\uff1a</p> <pre><code>#!/bin/bash\nnum1=10\nnum2=20\necho \"num1 \u4e3a\uff1a ${num1}\"\necho \"num2 \u4e3a\uff1a ${num2}\"\nif [ $num1 -lt 40 -a $num2 -gt 15 ];then\necho \"$num1 \u5c0f\u4e8e 40 \u4e14 $num2 \u5927\u4e8e 15 : \u8fd4\u56de true\"\nelse\necho \"$num1 \u5c0f\u4e8e 40 \u4e14 $num2 \u5927\u4e8e 15 : \u8fd4\u56de fnum1lse\"\nfi\necho \"\u6216\u8fd0\u7b97\"\nif [ $num1 -lt 40 -o $num2 -gt 40 ];then\necho \"$num1 \u5c0f\u4e8e 40 \u6216 $num2 \u5927\u4e8e 40 : \u8fd4\u56de true\"\nelse\necho \"$num1 \u5c0f\u4e8e 40 \u6216 $num2 \u5927\u4e8e 40 : \u8fd4\u56de fnum1lse\"\nfi\necho \"\u975e\u8fd0\u7b97\"\nif [ $num1 != $num2 ];then\necho \"$num1 != $num2 : num1 \u4e0d\u7b49\u4e8e num2\"\nelse\necho \"$num1 != $num2: num1 \u7b49\u4e8e num2\"\nfi\n</code></pre> <p>\u8fd4\u56de\u7ed3\u679c\u4e3a\uff1a</p> <pre><code>num1 \u4e3a\uff1a 10\nnum2 \u4e3a\uff1a 20\n10 \u5c0f\u4e8e 40 \u4e14 20 \u5927\u4e8e 15 : \u8fd4\u56de true\n\u6216\u8fd0\u7b97\n10 \u5c0f\u4e8e 40 \u6216 20 \u5927\u4e8e 40 : \u8fd4\u56de true\n\u975e\u8fd0\u7b97\n10 != 20 : num1 \u4e0d\u7b49\u4e8e num2\n[root@master scripts]# vim 2.sh [root@master scripts]# bash 2.sh num1 \u4e3a\uff1a 10\nnum2 \u4e3a\uff1a 20\n10 \u5c0f\u4e8e 40 \u4e14 20 \u5927\u4e8e 15 : \u8fd4\u56de true\n\u6216\u8fd0\u7b97\n10 \u5c0f\u4e8e 40 \u6216 20 \u5927\u4e8e 40 : \u8fd4\u56de true\n\u975e\u8fd0\u7b97\n10 != 20 : num1 \u4e0d\u7b49\u4e8e num2        </code></pre>"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#24-\u903b\u8f91\u8fd0\u7b97\u7b26","title":"2.4 \u903b\u8f91\u8fd0\u7b97\u7b26","text":"<p>\u903b\u8f91\u8fd0\u7b97\u7b26\u4e3a\uff0c\u4ee5\u4e0b\u4ecb\u7ecd Shell \u7684\u903b\u8f91\u8fd0\u7b97\u7b26\uff0c\u5047\u5b9a\u53d8\u91cf A \u4e3a 1\uff0c\u53d8\u91cf b \u4e3a 2\uff1a</p> \u8fd0\u7b97\u7b26 \u8bf4\u660e \u4e3e\u4f8b &amp;&amp; \u903b\u8f91\u7684 AND <code>[[ $A -lt 10 &amp;&amp; $B -gt 100 ]] \u8fd4\u56de false</code> || \u903b\u8f91\u7684 OR <code>[[ $A -lt 10 || $B -gt 100 ]] \u8fd4\u56de true</code> <p>\u4f8b\u5982\uff1a</p> <pre><code>#!/bin/bash\nnum1=1\nnum2=2\necho \"num1 \u4e3a:${num1}\"\necho \"num2 \u4e3a:${num2}\"\nif [[ $num1 -lt 5 &amp;&amp; $num2 -gt 5 ]];then\necho \"\u8fd4\u56de true\"\nelse\necho \"\u8fd4\u56de false\"\nfi\nif [[ $num1 -lt 5 || $num2 -gt 5 ]];then\necho \"\u8fd4\u56de true\"\nelse\necho \"\u8fd4\u56de false\"\nfi\n</code></pre> <p>\u8fd4\u56de\uff1a</p> <pre><code>num1 \u4e3a:1\nnum2 \u4e3a:2\n\u8fd4\u56de false\n\u8fd4\u56de true\n</code></pre>"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#25-\u5b57\u7b26\u4e32\u8fd0\u7b97\u7b26","title":"2.5 \u5b57\u7b26\u4e32\u8fd0\u7b97\u7b26","text":"<p>\u5bf9\u4e8e\u5b57\u7b26\u4e32\u8fdb\u884c\u4e00\u4e9b\u5224\u65ad\u64cd\u4f5c\uff0c\u5047\u5b9a\u53d8\u91cf a \u4e3a \u201clinux\u201d\uff0c\u53d8\u91cf b \u4e3a \u201cshell\u201d\uff1a</p> \u8fd0\u7b97\u7b26 \u8bf4\u660e \u4e3e\u4f8b = \u68c0\u6d4b\u4e24\u4e2a\u5b57\u7b26\u4e32\u662f\u5426\u76f8\u7b49\uff0c\u76f8\u7b49\u8fd4\u56de true\u3002 [$a = $b] \u8fd4\u56de false\u3002 != \u68c0\u6d4b\u4e24\u4e2a\u5b57\u7b26\u4e32\u662f\u5426\u76f8\u7b49\uff0c\u4e0d\u76f8\u7b49\u8fd4\u56de true\u3002 [$a != $b] \u8fd4\u56de true\u3002 -z \u68c0\u6d4b\u5b57\u7b26\u4e32\u957f\u5ea6\u662f\u5426\u4e3a 0\uff0c\u4e3a 0 \u8fd4\u56de true\u3002 [-z $a] \u8fd4\u56de false\u3002 -n \u68c0\u6d4b\u5b57\u7b26\u4e32\u957f\u5ea6\u662f\u5426\u4e3a 0\uff0c\u4e0d\u4e3a 0 \u8fd4\u56de true\u3002 [-n \u201c$a\u201d ] \u8fd4\u56de true\u3002 $ \u68c0\u6d4b\u5b57\u7b26\u4e32\u662f\u5426\u4e3a\u7a7a\uff0c\u4e0d\u4e3a\u7a7a\u8fd4\u56de true\u3002 [$a] \u8fd4\u56de true\u3002 <p>\u4f8b\u5982\uff1a</p> <pre><code>#!/bin/bash\nstr1=\"linux\"\nstr2=\"shell\"\necho \"str1 \u4e3a\uff1a${str1}\"\necho \"str2 \u4e3a\uff1a${str2}\"\nif [ $str1 = $str2 ];then\necho \"$str1 = $str2 : str1 \u7b49\u4e8e str2\"\nelse\necho \"$str1 = $str2: str1 \u4e0d\u7b49\u4e8e str2\"\nfi\nif [ $str1 != $str2 ];then\necho \"$str1 != $str2 : str1 \u4e0d\u7b49\u4e8e str2\"\nelse\necho \"$str1 != $str2: str1 \u7b49\u4e8e str2\"\nfi\nif [ -z $str1 ];then\necho \"-z $str1 : \u5b57\u7b26\u4e32\u957f\u5ea6\u4e3a 0\"\nelse\necho \"-z $str1 : \u5b57\u7b26\u4e32\u957f\u5ea6\u4e0d\u4e3a 0\"\nfi\nif [ -n \"$str1\" ];then\necho \"-n $str1 : \u5b57\u7b26\u4e32\u957f\u5ea6\u4e0d\u4e3a 0\"\nelse\necho \"-n $str1 : \u5b57\u7b26\u4e32\u957f\u5ea6\u4e3a 0\"\nfi\nif [ ${str1} ];then\necho \"str1 : \u5b57\u7b26\u4e32\u4e0d\u4e3a\u7a7a\"\nelse\necho \"str1 : \u5b57\u7b26\u4e32\u4e3a\u7a7a\"\nfi\n</code></pre> <p>\u8fd4\u56de\u4e3a\uff1a</p> <pre><code>str1 \u4e3a\uff1alinux\nstr2 \u4e3a\uff1ashell\nlinux = shell: str1 \u4e0d\u7b49\u4e8e str2\nlinux != shell : str1 \u4e0d\u7b49\u4e8e str2\n-z linux : \u5b57\u7b26\u4e32\u957f\u5ea6\u4e0d\u4e3a 0\n-n linux : \u5b57\u7b26\u4e32\u957f\u5ea6\u4e0d\u4e3a 0\nstr1 : \u5b57\u7b26\u4e32\u4e0d\u4e3a\u7a7a   </code></pre>"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#26-\u6587\u4ef6\u6d4b\u8bd5\u8fd0\u7b97\u7b26","title":"2.6 \u6587\u4ef6\u6d4b\u8bd5\u8fd0\u7b97\u7b26","text":"<p>\u6587\u4ef6\u6d4b\u8bd5\u5728\u6211\u4eec\u7f16\u5199 shell \u4e2d\u4e0e\u6587\u4ef6\u64cd\u4f5c\u975e\u5e38\u5e38\u7528\uff0c\u719f\u7ec3\u638c\u63e1\u6587\u4ef6\u64cd\u4f5c\u53ef\u4ee5\u5728\u540e\u7eed\u7684 shell \u7f16\u5199\u4e2d\u5f97\u5fc3\u5e94\u624b\uff0c\u4f8b\u5982 file \u53d8\u91cf\u4e3a:</p> \u64cd\u4f5c\u7b26 \u8bf4\u660e \u4e3e\u4f8b -d file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u662f\u76ee\u5f55\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-d $file] \u8fd4\u56de false\u3002 -f file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u662f\u666e\u901a\u6587\u4ef6\uff08\u65e2\u4e0d\u662f\u76ee\u5f55\uff0c\u4e5f\u4e0d\u662f\u8bbe\u5907\u6587\u4ef6\uff09\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-f $file] \u8fd4\u56de true\u3002 -c file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u662f\u5b57\u7b26\u8bbe\u5907\u6587\u4ef6\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-c $file] \u8fd4\u56de false\u3002 -b file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u662f\u5757\u8bbe\u5907\u6587\u4ef6\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-b $file] \u8fd4\u56de false\u3002 -g file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u8bbe\u7f6e\u4e86 SGID \u4f4d\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-g $file] \u8fd4\u56de false\u3002 -u file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u8bbe\u7f6e\u4e86 SUID \u4f4d\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-u $file] \u8fd4\u56de false\u3002 -k file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u8bbe\u7f6e\u4e86\u7c98\u7740\u4f4d (Sticky Bit)\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-k $file] \u8fd4\u56de false\u3002 -p file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u662f\u6709\u540d\u7ba1\u9053\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-p $file] \u8fd4\u56de false\u3002 -r file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u53ef\u8bfb\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-r $file] \u8fd4\u56de true\u3002 -w file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u53ef\u5199\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-w $file] \u8fd4\u56de true\u3002 -x file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u53ef\u6267\u884c\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-x $file] \u8fd4\u56de true\u3002 -s file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u4e3a\u7a7a\uff08\u6587\u4ef6\u5927\u5c0f\u662f\u5426\u5927\u4e8e 0\uff09\uff0c\u4e0d\u4e3a\u7a7a\u8fd4\u56de true\u3002 [-s $file] \u8fd4\u56de true\u3002 -e file \u68c0\u6d4b\u6587\u4ef6\uff08\u5305\u62ec\u76ee\u5f55\uff09\u662f\u5426\u5b58\u5728\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-e $file] \u8fd4\u56de true\u3002 <p>\u4f8b\u5982\uff1a</p> <pre><code>#!/bin/bash\nTEST_FILE=\"/etc/fstab\"\necho \"\u68c0\u6d4b\u7684\u6587\u4ef6\u4e3a:${TEST_FILE}\"\necho \"\u6587\u4ef6\u4fe1\u606f\u4e3a:$(ls -l ${TEST_FILE})\"\nif [ -r $TEST_FILE ]\nthen\necho \"\u6587\u4ef6\u53ef\u8bfb\"\nelse\necho \"\u6587\u4ef6\u4e0d\u53ef\u8bfb\"\nfi\nif [ -w $TEST_FILE ]\nthen\necho \"\u6587\u4ef6\u53ef\u5199\"\nelse\necho \"\u6587\u4ef6\u4e0d\u53ef\u5199\"\nfi\nif [ -x $TEST_FILE ]\nthen\necho \"\u6587\u4ef6\u53ef\u6267\u884c\"\nelse\necho \"\u6587\u4ef6\u4e0d\u53ef\u6267\u884c\"\nfi\nif [ -f $TEST_FILE ]\nthen\necho \"\u6587\u4ef6\u4e3a\u666e\u901a\u6587\u4ef6\"\nelse\necho \"\u6587\u4ef6\u4e3a\u7279\u6b8a\u6587\u4ef6\"\nfi\nif [ -d $TEST_FILE ]\nthen\necho \"\u6587\u4ef6\u662f\u4e2a\u76ee\u5f55\"\nelse\necho \"\u6587\u4ef6\u4e0d\u662f\u4e2a\u76ee\u5f55\"\nfi\nif [ -s $TEST_FILE ]\nthen\necho \"\u6587\u4ef6\u4e0d\u4e3a\u7a7a\"\nelse\necho \"\u6587\u4ef6\u4e3a\u7a7a\"\nfi\nif [ -e $TEST_FILE ]\nthen\necho \"\u6587\u4ef6\u5b58\u5728\"\nelse\necho \"\u6587\u4ef6\u4e0d\u5b58\u5728\"\nfi\n</code></pre> <p>\u8fd4\u56de\u4e3a\uff1a</p> <pre><code>\u68c0\u6d4b\u7684\u6587\u4ef6\u4e3a:/etc/fstab\n\u6587\u4ef6\u4fe1\u606f\u4e3a:-rw-r--r--. 1 root root 500 Jan 17 14:23 /etc/fstab\n\u6587\u4ef6\u53ef\u8bfb\n\u6587\u4ef6\u53ef\u5199\n\u6587\u4ef6\u4e0d\u53ef\u6267\u884c\n\u6587\u4ef6\u4e3a\u666e\u901a\u6587\u4ef6\n\u6587\u4ef6\u4e0d\u662f\u4e2a\u76ee\u5f55\n\u6587\u4ef6\u4e0d\u4e3a\u7a7a\n\u6587\u4ef6\u5b58\u5728\n</code></pre>"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#3-\u5b9e\u4f8b","title":"3. \u5b9e\u4f8b","text":""},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#31-\u9700\u6c42","title":"3.1 \u9700\u6c42","text":"<p>\u7f16\u5199\u4e00\u4e2a\u811a\u672c\uff0c\u4f20\u5165\u4e00\u4e2a linux \u6587\u4ef6\u7cfb\u7edf\u7684\u8def\u5f84\uff0c\u5224\u65ad\u5176\u4e0b\u9762\u6587\u4ef6\u53ca\u76ee\u5f55\u7684\u6570\u91cf\u3002</p>"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#32-\u601d\u8def","title":"3.2 \u601d\u8def","text":"<p>\u53ef\u4ee5\u5229\u7528\u6587\u4ef6\u6d4b\u8bd5\u8fd0\u7b97\u7b26\u6765\u5224\u65ad\u8f93\u51fa\u7684\u76ee\u5f55\u662f\u5426\u6b63\u786e\uff0c\u4e4b\u540e\u5229\u7528\u7b97\u672f\u8fd0\u7b97\u7b26\u914d\u5408\u6570\u7ec4\u5bf9\u6587\u4ef6\u6216\u76ee\u5f55\u8fdb\u884c\u7edf\u8ba1\u3002</p>"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#33-\u5b9e\u73b0","title":"3.3 \u5b9e\u73b0","text":"<pre><code>#!/bin/bash\n# Description: count file scripts\n# Auth: kaliarch\n# Email: kaliarch@163.com\n# function: count file\n# Date: 2020-03-08 14:00\n# Version: 1.0\n# \u5224\u65ad\u8f93\u5165\u53c2\u6570\n[ $# -ne 1 ] &amp;&amp; echo \"\u8f93\u5165\u53c2\u6570\u9519\u8bef\uff0c${0} check_dir\" &amp;&amp; exit 1\n# \u5224\u65ad\u8f93\u5165\u7684\u662f\u5426\u4e3a\u5b58\u5728\u7684\u76ee\u5f55,\u4e0d\u5b58\u5728\u5219\u9000\u51fa\nCHECK_DIR=$1\n[ ! -d ${CHECK_DIR} ] &amp;&amp; echo \"\u68c0\u6d4b\u7cfb\u7edf\u4e0d\u5b58\u5728\u76ee\u5f55\uff1a${CHECK_DIR}, \u8bf7\u8f93\u5165\u6b63\u786e\u7684\u76ee\u5f55\" &amp;&amp; exit 1\n# \u5bf9\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u8fdb\u884c\u7edf\u8ba1\nDIR_NUM=0\nFILE_NUM=0\nOTHER_NUM=0\nfor item in ${CHECK_DIR}/*\ndo\nif [ -d ${item} ];then\n# \u5982\u679c\u4e3a\u76ee\u5f55\uff0c\u5219\u76ee\u5f55\u603b\u6570\u52a0\u4e00\nDIR_NUM=$((${DIR_NUM}+1))\nelif [ -f ${item} ];then\nFILE_NUM=$((${FILE_NUM}+1))\nelse\nOTHER_NUM=$((${OTHER_NUM}+1))\nfi\ndone\necho \"\u68c0\u6d4b\u76ee\u5f55\u4e3a\uff1a${CHECK_DIR}\"\necho \"\u6587\u4ef6\u7c7b\u578b\u6570\u91cf\u4e3a\uff1a${FILE_NUM}\"\necho \"\u76ee\u5f55\u7c7b\u578b\u6570\u91cf\u4e3a\uff1a${DIR_NUM}\"\necho \"\u5176\u4ed6\u7c7b\u578b\u6570\u91cf\u4e3a\uff1a${OTHER_NUM}\"\n[root@master scripts]# bash count_file.sh \n\u8f93\u5165\u53c2\u6570\u9519\u8bef\uff0ccount_file.sh check_dir\n[root@master scripts]# bash count_file.sh aaaa\n\u68c0\u6d4b\u7cfb\u7edf\u4e0d\u5b58\u5728\u76ee\u5f55\uff1aaaaa, \u8bf7\u8f93\u5165\u6b63\u786e\u7684\u76ee\u5f55\n[root@master scripts]# bash count_file.sh /tmptmptmp\n\u68c0\u6d4b\u7cfb\u7edf\u4e0d\u5b58\u5728\u76ee\u5f55\uff1a/tmptmptmp, \u8bf7\u8f93\u5165\u6b63\u786e\u7684\u76ee\u5f55\n[root@master scripts]# bash count_file.sh /\n\u68c0\u6d4b\u76ee\u5f55\u4e3a\uff1a/\n\u6587\u4ef6\u7c7b\u578b\u6570\u91cf\u4e3a\uff1a0\n\u76ee\u5f55\u7c7b\u578b\u6570\u91cf\u4e3a\uff1a23\n\u5176\u4ed6\u7c7b\u578b\u6570\u91cf\u4e3a\uff1a0\n[root@master scripts]# bash count_file.sh /root\n\u68c0\u6d4b\u76ee\u5f55\u4e3a\uff1a/root\n\u6587\u4ef6\u7c7b\u578b\u6570\u91cf\u4e3a\uff1a8\n\u76ee\u5f55\u7c7b\u578b\u6570\u91cf\u4e3a\uff1a5\n\u5176\u4ed6\u7c7b\u578b\u6570\u91cf\u4e3a\uff1a0\n[root@master scripts]# bash count_file.sh /dev/\n\u68c0\u6d4b\u76ee\u5f55\u4e3a\uff1a/dev/\n\u6587\u4ef6\u7c7b\u578b\u6570\u91cf\u4e3a\uff1a1\n\u76ee\u5f55\u7c7b\u578b\u6570\u91cf\u4e3a\uff1a19\n\u5176\u4ed6\u7c7b\u578b\u6570\u91cf\u4e3a\uff1a139\n</code></pre> <p>\u5f53\u6211\u4eec\u4e0d\u8f93\u5165\u4efb\u4f55\u53c2\u6570\u7684\u65f6\u5019\uff0c\u63d0\u793a\u9700\u8981\u8f93\u5165\u4e00\u4e2a\u8def\u5f84\u53c2\u6570\uff0c\u8f93\u5165\u4e86\u6587\u4ef6\u540d\u79f0\u6216\u4e0d\u5b58\u5728\u7684\u8def\u5f84\u65f6\uff0c\u6587\u4ef6\u6d4b\u8bd5\u8fd0\u7b97\u7b26\u5224\u65ad\u8f93\u5165\u5f02\u5e38\uff0c\u4e0d\u662f\u4e00\u4e2a\u6709\u6548\u7684\u6587\u4ef6\u76ee\u5f55\u3002</p> <p>\u5f53\u6211\u4eec\u8f93\u5165\u6b63\u5e38\u7684\u76ee\u5f55\u65f6\uff0c\u5373\u53ef\u83b7\u5f97\u6b63\u786e\u7684\u76ee\u5f55\u6216\u6587\u4ef6\u6570\u3002</p>"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#4-\u6ce8\u610f\u4e8b\u9879","title":"4. \u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u5bf9\u4e8e\u7b97\u672f\u8fd0\u7b97\uff0c\u5927\u5bb6\u53ef\u4ee5\u6839\u636e\u5177\u4f53\u573a\u666f\u548c\u73af\u5883\u6765\u9009\u62e9\uff0c\u4f8b\u5982\u7cfb\u7edf\u5185\u6ca1\u6709\u8ba1\u7b97\u5de5\u5177\u7b49\uff0c\u53ef\u4ee5\u4f18\u5148\u9009\u62e9 <code>[]</code> \u548c <code>(())</code> \u6765\u8fdb\u884c\uff0c\u4e5f\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u559c\u597d\u9009\u62e9\u3002</li> <li>\u5bf9\u4e8e\u5173\u7cfb\u8fd0\u7b97\uff0c\u6bd4\u8f83\u7684\u6570\u5b57\uff0c\u4e0d\u662f\u5b57\u7b26\u4e32\uff0c\u4e00\u5b9a\u8981\u7262\u8bb0\u8fd9\u4e2a\u6ce8\u610f\u70b9\uff0c\u5bf9\u4e8e\u5b57\u7b26\u4e32\u5224\u65ad\u53ef\u4ee5\u7528\u5b57\u7b26\u4e32\u8fd0\u7b97\u7b26\u3002</li> <li>\u5bf9\u4e8e\u5e03\u5c14\u8fd0\u7b97\u548c\u903b\u8f91\u8fd0\u7b97\u5176\u5b9e\u662f\u4e00\u4e2a\u4e1c\u897f\uff0c\u53ea\u4e0d\u8fc7\u5e03\u5c14\u8fd0\u7b97\u7b26\u6709\u4e00\u4e2a\u975e\u8fd0\u7b97\uff0c\u53ef\u4ee5\u8fdb\u884c\u7075\u6d3b\u8fd0\u7528\u3002</li> <li>\u6587\u4ef6\u6d4b\u8bd5\u7b26\u5e38\u7528\u4e0e\u5224\u65ad linux \u7cfb\u7edf\u6587\u4ef6\u7684\u64cd\u4f5c\uff0c\u5728\u540e\u671f shell \u7f16\u7a0b\u53ef\u8c13\u4e3e\u8db3\u8f7b\u91cd\uff0c\u7262\u8bb0\u6bcf\u4e2a\u6587\u4ef6\u8fd0\u7b97\u7b26\u4f1a\u4f7f\u5f97\u540e\u671f\u7f16\u7a0b\u5f97\u5fc3\u5e94\u624b\u3002</li> </ul>"},{"location":"Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/#5-\u5c0f\u7ed3","title":"5. \u5c0f\u7ed3","text":"<p>\u8fd0\u7b97\u7b26\u53ef\u8c13 Shell \u811a\u672c\u7684\u7075\u9b42\uff0c\u540e\u671f\u6211\u4eec\u7684\u5faa\u73af\u548c\u5224\u65ad\u91cc\u9762\u7684\u6761\u4ef6\u90fd\u662f\u8fd9\u4e9b\u8fd0\u7b97\u7b26\u6784\u6210\uff0c\u5b83\u662f\u6d41\u7a0b\u6846\u67b6\u7684\u57fa\u7840\uff0c\u719f\u7ec3\u638c\u63e1\u8fd0\u7b97\u7b26\u7684\u5206\u7c7b\u53ca\u6bcf\u4e2a\u7684\u7528\u6cd5\uff0c\u901a\u8fc7\u52a8\u624b\u5b9e\u8df5\u533a\u5206\u5176\u7279\u5f81\uff0c\u4e3e\u4e00\u53cd\u4e09\u7075\u6d3b\u8fd0\u7528\u3002</p>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/","title":"6.Shell echo/printf \u547d\u4ee4","text":""},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#1-shell-\u663e\u793a\u547d\u4ee4","title":"1. Shell \u663e\u793a\u547d\u4ee4","text":""},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#11-shell-\u663e\u793a\u547d\u4ee4","title":"1.1 Shell \u663e\u793a\u547d\u4ee4","text":"<p>\u4e0e\u5176\u4ed6\u8bed\u8a00\u4e00\u6837\uff0cShell \u4e5f\u6709\u5b57\u7b26\u4e32\u7684\u8f93\u51fa\u53ca\u683c\u5f0f\u5316\u5b57\u7b26\u7684\u9700\u6c42\uff0c\u5728\u672c\u7ae0\u8282\u6211\u4eec\u7740\u91cd\u8bb2\u89e3 Shell \u4e2d\u7684 echo \u4e0e printf \u547d\u4ee4\uff0c\u7075\u6d3b\u8fd0\u7528\u8fd9\u4e24\u4e2a\u547d\u4ee4\uff0c\u57fa\u672c\u4e0a\u5c31\u80fd\u6ee1\u8db3\u6211\u4eec\u5728 Shell \u7f16\u5199\u4e2d\u7684\u5927\u591a\u6570\u663e\u793a\u8f93\u51fa\u53ca\u683c\u5f0f\u5316\u5b57\u7b26\u4e32\u7684\u9700\u6c42\u3002</p>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#12-\u4e3a\u4ec0\u4e48\u8981\u7528\u663e\u793a\u547d\u4ee4","title":"1.2 \u4e3a\u4ec0\u4e48\u8981\u7528\u663e\u793a\u547d\u4ee4","text":"<p>\u5728\u6211\u4eec\u7f16\u5199 Shell \u811a\u672c\u7684\u65f6\u5019\u9700\u8981\u4e3a\u7528\u6237\u63d0\u4f9b\u4fe1\u606f\u63d0\u793a\u4ee5\u53ca\u4ea4\u4e92\u5f0f\u663e\u793a\uff0c\u4e5f\u5b58\u5728\u9700\u8981\u8bb0\u5f55\u811a\u672c\u7684\u6267\u884c\u65e5\u5fd7\u7b49\uff0c\u6b64\u65f6\u90fd\u9700\u8981\u6211\u4eec\u6765\u6839\u636e\u4e0d\u540c\u7684\u573a\u666f\uff0c\u5229\u7528 Shell \u7684\u663e\u793a\u547d\u4ee4\u4e5f\u79f0\u8f93\u51fa\u547d\u4ee4\u6765\u6ee1\u8db3\u6211\u4eec\u7684\u9700\u6c42\u3002</p>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#2-shell-\u663e\u793a-echo-\u547d\u4ee4\u64cd\u4f5c","title":"2. Shell \u663e\u793a echo \u547d\u4ee4\u64cd\u4f5c","text":"<p>\u6211\u4eec\u660e\u786e\u4e86 Shell \u663e\u793a\u547d\u4ee4\u7684\u542b\u4e49\u53ca\u4f5c\u7528\uff0c\u9996\u9009\u8ba9\u6211\u4eec\u6765\u770b echo \u547d\u4ee4\u53ca\u57fa\u672c\u64cd\u4f5c\u3002</p>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#21-echo-\u8bed\u6cd5","title":"2.1 echo \u8bed\u6cd5","text":"<p>echo \u547d\u4ee4\u8bed\u6cd5\u975e\u5e38\u7b80\u5355\uff1a<code>echo [option] [arguments]</code>\uff0c\u5176\u4e2d\u6839\u636e <code>option</code> \u7684\u4e0d\u540c\uff0c\u8d4b\u4e88\u4e86 echo \u5f88\u591a\u5f3a\u5927\u7684\u529f\u80fd\u3002</p>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#22-echo-\u5e38\u7528\u64cd\u4f5c","title":"2.2 echo \u5e38\u7528\u64cd\u4f5c","text":""},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#221-\u6253\u5370\u666e\u901a\u5b57\u7b26\u4e32","title":"2.2.1 \u6253\u5370\u666e\u901a\u5b57\u7b26\u4e32","text":"<p>\u901a\u5e38\u9ed8\u8ba4\u4e0d\u5e26\u53c2\u6570\u5c31\u662f\u5904\u7406\u6253\u5370\u666e\u901a\u5b57\u7b26\u4e32\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# echo \"hello shell\"\nhello shell\n</code></pre>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#222-\u4e0d\u6362\u884c\u8f93\u51fa","title":"2.2.2 \u4e0d\u6362\u884c\u8f93\u51fa","text":"<p>\u9ed8\u8ba4 echo \u8f93\u51fa\u666e\u901a\u5b57\u7b26\u4e32\u4e3a\u81ea\u52a8\u6362\u884c\u7684\uff0c\u5982\u679c\u4e0d\u60f3\u8f93\u51fa\u81ea\u52a8\u6362\u884c\uff0c\u53ef\u4ee5\u6dfb\u52a0\u9009\u9879 <code>-n</code>\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# echo -n \"hello shell\"\nhello shell[root@master ~]# </code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6b64\u65f6\u8f93\u51fa\u5c31\u4e0d\u81ea\u52a8\u6362\u884c\uff0c\u8be5\u9700\u6c42\u53ef\u4ee5\u5728\u6211\u4eec\u5199\u6587\u4ef6\u7684\u65f6\u5019\u4f7f\u7528\u3002</p>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#223-\u8f93\u51fa\u53d8\u91cf","title":"2.2.3 \u8f93\u51fa\u53d8\u91cf","text":"<p>\u5728\u6211\u4eec\u524d\u9762\u8bb2\u89e3\u53d8\u91cf\u7684\u65f6\u5019\uff0c\u6709\u63d0\u5230\u8fc7\u5728\u5f15\u7528\u53d8\u91cf\u7684\u65f6\u5019\u53ef\u4ee5\u5229\u7528 <code>echo</code> \u547d\u4ee4\uff0c\u4f46\u662f\u6b64\u65f6\u9700\u8981\u6211\u4eec\u6ce8\u610f\u5355\u5f15\u53f7\u4e0e\u53cc\u5f15\u53f7\u7684\u533a\u522b\u3002</p> <ul> <li>\u5355\u5f15\u53f7</li> </ul> <p>\u5355\u5f15\u53f7\u4e3a\u5c06\u53d8\u91cf\u540d\u539f\u6837\u8f93\u51fa\uff0c\u4e0d\u5f15\u7528\u5176\u7684\u503c\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# STR1=\"hello shell\"\n[root@master ~]# echo '${STR1}'\n${STR1}\n</code></pre> <ul> <li>\u53cc\u5f15\u53f7</li> </ul> <p>\u53cc\u5f15\u53f7\u4e3a\u5f15\u7528\u53d8\u91cf\u7684\u503c\u8fdb\u884c\u8f93\u51fa\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# echo \"${STR1}\"\nhello shell\n[root@master ~]# echo ${STR1}\nhello shell\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u5728\u7ec8\u7aef\u5982\u679c\u4e0d\u663e\u5f0f\u4e66\u5199\u5f15\u53f7\uff0c\u9ed8\u8ba4\u5c31\u4e3a\u53cc\u5f15\u53f7\uff0c\u4e5f\u5c31\u662f\u5f15\u7528\u6211\u4eec\u53d8\u91cf\u7684\u503c\uff0c\u4f46\u662f\u6211\u4eec\u5728\u7f16\u5199 Shell \u811a\u672c\u7684\u65f6\u5019\u5c3d\u53ef\u80fd\u5730\u663e\u793a\u5199\u4e0a\u5f15\u53f7\uff0c\u8fd9\u6837\u53ef\u4ee5\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u5f02\u5e38\u53d1\u751f\u3002</p>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#224--e-\u8f6c\u4e49","title":"2.2.4 -e \u8f6c\u4e49","text":"<p><code>echo</code> \u547d\u4ee4\u4f7f\u7528 <code>-e</code> \u9009\u9879\u53ef\u4ee5\u5f00\u542f\u8f6c\u4e49\uff0c\u5904\u7406\u7279\u6b8a\u5b57\u7b26\u3002</p> <ul> <li><code>\\n</code>: \u6362\u884c\u7b26\u53f7</li> </ul> <pre><code>[root@master ~]# echo -e \"hello\\nshell\" hello\nshell\n</code></pre> <ul> <li><code>\\t</code>: \u5236\u8868\u7b26\uff0c\u4e5f\u5c31\u662f\u6309\u6211\u4eec\u7684 tab \u952e</li> </ul> <pre><code>[root@master ~]# echo -e \"hello\\tshell\" hello   shell\n</code></pre> <ul> <li><code>\\r</code>: \u56de\u8f66\u952e\uff0cRETURN</li> </ul> <pre><code>[root@master ~]# echo -e \"hello\\r\"    hello       </code></pre> <ul> <li><code>\\a</code>: \u4ece\u7cfb\u7edf\u5587\u53ed\u9001\u51fa\u94c3\u58f0\uff0cALERT</li> </ul> <pre><code>    [root@master ~]# echo -e \"\\a\"\n</code></pre> <ul> <li><code>\\\\</code>\uff1a\u663e\u793a\u53cd\u659c\u7ebf\u672c\u8eab</li> </ul> <pre><code>[root@master ~]# echo -e \"hello \\\\ shell\"\nhello \\ shell\n</code></pre> <ul> <li><code>\\f</code>:FORMFEED\uff0c\u6362\u9875\u5b57\u7b26</li> </ul> <pre><code>[root@master ~]# echo -e \"hello\\fshell\" hello\nshell\n</code></pre> <ul> <li><code>\\E</code>:ESCAPE\uff0c\u8df3\u8131\u952e</li> </ul> <pre><code>[root@master ~]# echo -e \"hello \\Eshell\"\nhello hell\n</code></pre>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#225-\u6587\u4ef6\u64cd\u4f5c","title":"2.2.5 \u6587\u4ef6\u64cd\u4f5c","text":"<ul> <li>\u521b\u5efa\u6587\u4ef6</li> </ul> <p>\u53ef\u4ee5\u5229\u7528 echo \u547d\u4ee4\u6765\u521b\u5efa\u6587\u4ef6\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# ls test.sh\nls: cannot access test.sh: No such file or directory\n[root@master ~]# echo \"hello shell\" &gt;test.sh\n[root@master ~]# cat test.sh hello shell\n[root@master ~]#\n</code></pre> <p>\u5982\u679c\u9700\u8981\u5728\u4e00\u4e2a\u6587\u4ef6\u4e2d\u5199\u5165\u7b80\u5355\u5185\u5bb9\uff0c\u4e0d\u7528\u521b\u5efa\u6587\u4ef6\u7136\u540e\u6253\u5f00\uff0c\u53ef\u4ee5\u76f4\u63a5\u5229\u7528 echo \u547d\u4ee4\u5c06\u5185\u5bb9\u8f93\u5165\u5230\u6587\u4ef6\u4e2d\uff0c\u6587\u4ef6\u4f1a\u81ea\u52a8\u521b\u5efa\u3002</p> <ul> <li>\u6e05\u7a7a\u6587\u4ef6</li> </ul> <p>\u53ef\u4ee5\u5229\u7528 echo \u6765\u6e05\u7a7a\u6587\u4ef6\u5185\u5bb9\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master ~]# cat test.sh hello shell\n[root@master ~]# echo &gt;test.sh [root@master ~]# cat test.sh </code></pre>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#226-\u611f\u53f9\u53f7","title":"2.2.6 \u611f\u53f9\u53f7","text":"<p>\u5728 echo \u4e2d\uff0c\u5982\u679c\u4f7f\u7528\u53cc\u5f15\u53f7\u5176\u4e2d\u5e26\u6709 <code>!</code> \u5219\u4f1a\u629b\u51fa\u5f02\u5e38\uff0c\u8fd9\u662f\u56e0\u4e3a\u9ed8\u8ba4 Shell \u5f00\u542f\u4e86\u611f\u53f9\u53f7\u5f15\u7528\u5185\u5b58\u4e2d\u7684\u5386\u53f2\u547d\u4ee4\uff0c\u53ef\u4ee5\u5229\u7528 <code>set +H</code> \u8fdb\u884c\u5173\u95ed\uff0c\u5982\u679c\u4e0d\u5173\u95ed\u8be5\u8bbe\u7f6e\u8fd8\u60f3\u4f7f\u7528\u611f\u53f9\u53f7\uff0c\u53ef\u4ee5\u4f7f\u7528\u5355\u5f15\u53f7\u3002</p> <pre><code>[root@master ~]# echo \"hello !\"\n-bash: !\": event not found\n[root@master ~]# echo 'hello !'\nhello !\n</code></pre>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#227-\u989c\u8272\u8f93\u51fa","title":"2.2.7 \u989c\u8272\u8f93\u51fa","text":"<p>\u5728 Shell \u4e2d\u6211\u4eec\u6709\u65f6\u5019\u9700\u8981\u4e0e\u7528\u6237\u8fdb\u884c\u4ea4\u4e92\u5f0f\u64cd\u4f5c\uff0c\u5982\u679c\u8f93\u51fa\u7684\u5185\u5bb9\u6709\u989c\u8272\uff0c\u5bf9\u4e8e\u7528\u6237\u8bc6\u522b\u66f4\u4e3a\u660e\u663e\u3002Shell \u4e2d echo \u53ef\u4ee5\u5bf9\u5b57\u4f53\u989c\u8272 / \u80cc\u666f / \u663e\u793a\u65b9\u5f0f\u8fdb\u884c\u63a7\u5236\uff0c\u5982\u4e0b\u8868\uff1a</p> \u5b57\u4f53\u989c\u8272 \u5b57\u4f53\u80cc\u666f\u989c\u8272 \u663e\u793a\u65b9\u5f0f 30\uff1a\u9ed1 40\uff1a\u9ed1 31\uff1a\u7ea2 41\uff1a\u6df1\u7ea2 0\uff1a\u7ec8\u7aef\u9ed8\u8ba4\u8bbe\u7f6e 32\uff1a\u7eff 42\uff1a\u7eff 1\uff1a\u9ad8\u4eae\u663e\u793a 33\uff1a\u9ec4 43\uff1a\u9ec4\u8272 4\uff1a\u4e0b\u5212\u7ebf 34\uff1a\u84dd\u8272 44\uff1a\u84dd\u8272 5\uff1a\u95ea\u70c1 35\uff1a\u7d2b\u8272 45\uff1a\u7d2b\u8272 7\uff1a\u53cd\u767d\u663e\u793a 36\uff1a\u6df1\u7eff 46\uff1a\u6df1\u7eff 8\uff1a\u9690\u85cf 37\uff1a\u767d\u8272 47\uff1a\u767d\u8272 \u683c\u5f0f\uff1a \\033[1;31;40m # 1 \u662f\u663e\u793a\u65b9\u5f0f\uff0c\u53ef\u9009\u300231 \u662f\u5b57\u4f53\u989c\u8272\u300240m \u662f\u5b57\u4f53\u80cc\u666f\u989c\u8272\u3002 \\033[0m # \u6062\u590d\u7ec8\u7aef\u9ed8\u8ba4\u989c\u8272\uff0c\u5373\u53d6\u6d88\u989c\u8272\u8bbe\u7f6e\u3002 <ul> <li>\u663e\u793a\u65b9\u5f0f</li> </ul> <pre><code>for i in {1..8};do echo -e \"\\033[$i;31;40m hello shell \\033[0m\";done\n</code></pre> <ul> <li>\u5b57\u4f53\u989c\u8272</li> </ul> <pre><code>for i in {30..37};do echo -e \"\\033[$i;40m hello shell \\033[0m\";done\n</code></pre> <ul> <li>\u80cc\u666f\u989c\u8272</li> </ul> <pre><code>for i in {40..47};do echo -e \"\\033[47;${i}m hello shell \\033[0m\";done\n</code></pre>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#3-shell-\u4e2d-printf-\u547d\u4ee4\u64cd\u4f5c","title":"3. Shell \u4e2d printf \u547d\u4ee4\u64cd\u4f5c","text":"<p>\u6211\u4eec\u5b66\u4e60\u4e86 echo \u547d\u4ee4\uff0c\u5b83\u901a\u5e38\u7528\u4e8e\u5904\u7406\u5e38\u89c4\u7684\u9700\u6c42\uff0c\u8fd8\u6709\u4e00\u4e9b\u66f4\u9ad8\u7ea7\u7684\u9700\u6c42\uff0c\u4f8b\u5982\u6211\u4eec\u5e0c\u671b\u8f93\u51fa\u5185\u5bb9\u6307\u5b9a\u5b57\u7b26\u7684\u5bbd\u5ea6\uff0c\u5de6\u53f3\u5bf9\u9f50\uff0c\u683c\u5f0f\u5c0f\u6570\u8f93\u51fa\u7b49\uff0c\u6b64\u573a\u666f\u4e0b\u9700\u8981\u5229\u7528 <code>printf</code> \u547d\u4ee4\u8fdb\u884c\u5904\u7406\u3002</p>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#31-printf-\u8bed\u6cd5","title":"3.1 printf \u8bed\u6cd5","text":"<p>printf \u529f\u80fd\u4e3a\u683c\u5f0f\u5316\u6253\u5370\u6570\u636e\uff0c\u8bed\u6cd5\u4e3a\uff1a<code>printf format-string [arguments]</code>\u3002</p> <ul> <li>format-string: \u4e3a\u683c\u5f0f\u63a7\u5236\u5b57\u7b26\u4e32\uff1b</li> <li>arguments: \u4e3a\u53c2\u6570\u5217\u8868\u3002</li> </ul>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#32-printf-\u6ce8\u610f\u70b9","title":"3.2 printf \u6ce8\u610f\u70b9","text":"<p>\u5176\u5f15\u7528 C \u8bed\u8a00\u4e2d\u7684 <code>printf</code> \u547d\u4ee4\uff0c\u4f46 \u4e5f\u6709\u4e00\u4e9b\u533a\u522b\uff0c\u9700\u8981\u6ce8\u610f\uff1a</p> <ul> <li>printf \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u672b\u5c3e\u4e0d\u52a0\u6362\u884c\u7b26\u53f7\uff0c\u6240\u4ee5\u5982\u679c\u9700\u8981\u6362\u884c\uff0c\u9700\u8981\u663e\u793a\u624b\u52a8\u6dfb\u52a0 <code>\\n</code>;</li> <li>printf \u4e3a\u683c\u5f0f\u5316\u8f93\u51fa\u4e0d\u5bf9\u5185\u5bb9\u505a\u6539\u53d8\u64cd\u4f5c\uff0c\u5c24\u5176\u5728\u6d6e\u70b9\u6570\u8f93\u51fa\u7684\u65f6\u5019\uff0c\u5bf9\u5176\u7ed3\u679c\u4e0d\u8fdb\u884c\u6539\u53d8\uff0c\u8fd9\u662f\u73b0\u5b9e\u7ed3\u679c\u6709\u5dee\u5f02\uff1b</li> <li>\u5728 printf \u4e2d\u5e74 arguments \u4e3a\u53c2\u6570\u5217\u8868\uff0c\u4f8b\u5982\u5b57\u7b26\u4e32\u6216\u8005\u53d8\u91cf\uff0c\u5efa\u8bae\u4e2a\u6570\u4e0e format-string \u8981\u6c42\u7684\u6570\u91cf\u76f8\u540c\uff1b</li> <li>printf \u4e0d\u7528\u52a0\u62ec\u53f7\uff0carguments \u4f7f\u7528\u7a7a\u683c\u5206\u9694\uff0c\u4e0d\u7528\u9017\u53f7\u3002</li> </ul>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#33-printf-\u5e38\u7528\u64cd\u4f5c","title":"3.3 printf \u5e38\u7528\u64cd\u4f5c","text":""},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#331-\u6253\u5370\u666e\u901a\u5b57\u7b26\u4e32","title":"3.3.1 \u6253\u5370\u666e\u901a\u5b57\u7b26\u4e32","text":"<pre><code>[root@master ~]# printf \"hello shell\"\nhello shell[root@master ~]# printf \"hello shell\\n\"\nhello shell\n</code></pre> <p>\u5982\u679c\u9700\u8981\u6362\u884c\uff0c\u9700\u8981\u624b\u52a8\u663e\u5f0f\u6dfb\u52a0 <code>\\n</code>\u3002</p>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#332-\u683c\u5f0f\u5b57\u7b26\u4e32","title":"3.3.2 \u683c\u5f0f\u5b57\u7b26\u4e32","text":"<p>\u5728\u638c\u63e1 printf \u524d\u9700\u8981\u5148\u4e86\u89e3 <code>format-string</code>\uff0c\u5176\u5bf9\u5e94\u7740\u4e0d\u540c\u7684\u542b\u4e49\uff0c\u5728\u6b64\u6211\u4eec\u4ecb\u7ecd\u6700\u5e38\u7528\u7684\u683c\u5f0f\u5b57\u7b26\u4e32\u3002</p> <ul> <li><code>%s</code></li> </ul> <p>\u5b57\u7b26\u4e32\u683c\u5f0f\u5316\uff0c\u5176\u4e2d <code>%s</code> \u5c31\u662f\u5f15\u7528\u540e\u9762\u7684\u5b57\u7b26 <code>shell</code></p> <pre><code>[root@master ~]# printf \"hello %s\\n\" shell\nhello shell\n</code></pre> <ul> <li><code>%d</code></li> </ul> <p>\u5341\u8fdb\u5236\u6574\u6570</p> <pre><code>[root@master ~]# printf \"age: %d\\n\" 20      age: 20\n</code></pre> <ul> <li>\u5de6\u5bf9\u9f50</li> </ul> <p>printf \u53ef\u4ee5\u4f7f\u5f97\u5de6\u5bf9\u9f50\uff0c\u4f8b\u5982 <code>%-10s</code> \u6307\u4e00\u4e2a\u5bbd\u5ea6\u4e3a 10 \u4e2a\u5b57\u7b26\uff0c\u5de6\u5bf9\u9f50\u5229\u7528 <code>-</code> \u8868\u793a\uff0c\u4efb\u4f55\u5b57\u7b26\u90fd\u4f1a\u88ab\u663e\u793a\u5728 10 \u4e2a\u5b57\u7b26\u5bbd\u7684\u5b57\u7b26\u5185\uff0c\u5982\u679c\u4e0d\u8db3\u5219\u81ea\u52a8\u4ee5\u7a7a\u683c\u586b\u5145\uff0c\u8d85\u8fc7\u4e5f\u4f1a\u5c06\u5185\u5bb9\u5168\u90e8\u663e\u793a\u51fa\u6765\u3002</p> <pre><code>[root@master ~]# printf \"hello %-10s%s\\n\" shell \u3002      hello shell     \u3002\n</code></pre> <ul> <li>\u53f3\u8fb9\u5bf9\u9f50</li> </ul> <p>\u53f3\u5bf9\u9f50\u5229\u7528 <code>+</code> \u8868\u793a\uff0c<code>%+10.2f</code> \u6307\u683c\u5f0f\u5316\u4e3a\u5c0f\u6570\uff0c\u5176\u4e2d 10 \u8868\u793a 4 \u4e2a\u5b57\u7b26\u5bbd\u5ea6\uff0c.2 \u6307\u4fdd\u7559 2 \u4f4d\u5c0f\u6570\u3002</p> <pre><code>[root@master ~]# printf \"hello %+10s%s\\n\" shell \u3002 hello      shell\u3002\n[root@master ~]# printf \"hello %+10.2f %s\\n\" 3.1415 \u3002   hello      +3.14 \u3002\n</code></pre> <ul> <li>\u5176\u4ed6</li> </ul> <p>\u5f53\u7136\u4e00\u4e9b\u5176\u4ed6\u683c\u5f0f\u5316\u5b57\u7b26\uff0c\u5728\u6b64\u4e3e\u4f8b\u6700\u5e38\u7528\u7684\uff0c\u5176\u4ed6\u7684\u53ef\u53c2\u8003\u5982\u4e0b\uff1a</p> <pre><code>%c ASCII\u5b57\u7b26.\u663e\u793a\u76f8\u5bf9\u5e94\u53c2\u6570\u7684\u7b2c\u4e00\u4e2a\u5b57\u7b26\n%d,%i \u5341\u8fdb\u5236\u6574\u6570\uff08\u5e38\u7528\uff09\n%e \u6d6e\u70b9\u683c\u5f0f([-d].precisione [+-dd])\n%E \u6d6e\u70b9\u683c\u5f0f([-d].precisionE [+-dd])\n%g %e\u6216%f\u8f6c\u6362,\u770b\u54ea\u4e00\u4e2a\u8f83\u77ed,\u5219\u5220\u9664\u7ed3\u5c3e\u7684\u96f6\n%G %E\u6216%f\u8f6c\u6362,\u770b\u54ea\u4e00\u4e2a\u8f83\u77ed,\u5219\u5220\u9664\u7ed3\u5c3e\u7684\u96f6\n%s \u5b57\u7b26\u4e32\uff08\u5e38\u7528\uff09\n%u \u4e0d\u5e26\u6b63\u8d1f\u53f7\u7684\u5341\u8fdb\u5236\u503c\n%x \u4e0d\u5e26\u6b63\u8d1f\u53f7\u7684\u5341\u516d\u8fdb\u5236.\u4f7f\u7528a\u81f3f\u8868\u793a10\u81f315\n%% \u5b57\u9762\u610f\u4e49\u7684%\n%X \u4e0d\u5e26\u6b63\u8d1f\u53f7\u7684\u5341\u516d\u8fdb\u5236.\u4f7f\u7528A\u81f3F\u8868\u793a10\u81f315\n</code></pre>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#333-\u5176\u4ed6","title":"3.3.3 \u5176\u4ed6","text":"<ul> <li>\u5355\u53cc\u5f15\u53f7</li> </ul> <p>\u5728 printf \u4e2d\uff0c\u5355\u53cc\u5f15\u53f7\u90fd\u4e00\u81f4\u3002</p> <pre><code>[root@master ~]# printf \"hello %s\\n\" shell\nhello shell\n[root@master ~]# printf 'hello %s\\n' shell hello shell\n</code></pre> <ul> <li>\u683c\u5f0f\u53ea\u6307\u5b9a\u4e86\u4e00\u4e2a\u53c2\u6570\uff0c\u4f46\u591a\u51fa\u7684\u53c2\u6570\u4ecd\u7136\u4f1a\u6309\u7167\u8be5\u683c\u5f0f\u8f93\u51fa\uff0cformat-string \u88ab\u91cd\u7528\u8fdb\u884c\u591a\u884c\u8f93\u51fa</li> </ul> <pre><code>[root@master ~]# printf 'hello %s\\n' shell python go\nhello shell\nhello python\nhello go\n[root@master ~]# printf \"%s %s %s %s\\n\" a b c d e f g h i j\na b c d\ne f g h\ni j  </code></pre> <ul> <li>\u5982\u679c\u6ca1\u6709 arguments\uff0c\u90a3\u4e48\u5219\u5bf9\u5e94\u4f7f\u7528\u9ed8\u8ba4\u503c\u8868\u793a\uff0c % s \u7528 NULL \u4ee3\u66ff\uff0c% d \u7528 0 \u4ee3\u66ff</li> </ul> <pre><code>[root@master ~]# printf \"%s default  %d \\n\" default  0 </code></pre>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#334-printf-\u8f6c\u4e49","title":"3.3.4 printf \u8f6c\u4e49","text":"<p>printf \u7684\u8f6c\u4e49\u4e0e echo \u4e2d\u7684\u4e00\u81f4\uff0c\u53ef\u53c2\u8003 echo \u4e2d\u7684\u8f6c\u4e49\u3002</p>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#4-\u5b9e\u4f8b","title":"4. \u5b9e\u4f8b","text":""},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#41-\u9700\u6c42","title":"4.1 \u9700\u6c42","text":"<p>\u4f8b\u5982\u7ed9\u51fa\u5982\u4e0b nginx \u7684\u8bbf\u95ee\u65e5\u5fd7\uff0c\u9700\u8981\u5bf9\u5176\u8fdb\u884c\u5206\u6790\u5e76\u4e14\u8f93\u51fa\u4e0d\u540c\u7684\u72b6\u6001\u5417\uff0c\u5229\u7528\u989c\u8272\u4e0d\u540c\u8fdb\u884c\u533a\u5206\u4e0d\u540c\u7684\u72b6\u6001\u7801\u3002</p> <pre><code>112.65.61.117 - - [05/Nov/2019:17:10:54 +0800] \"GET /js/chunk-2eca3a5a.2f1d5ea3.js HTTP/1.1\" 200 5276 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36 QBCore/4.0.1278.400 QQBrowser/9.0.2524.400 Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2875.116 Safari/537.36 NetType/WIFI MicroMessenger/7.0.5 WindowsWechat\" \"-\"\n112.65.61.117 - - [05/Nov/2019:17:10:54 +0800] \"GET /js/chunk-91d36e6e.a1444c20.js HTTP/1.1\" 200 12674 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36 QBCore/4.0.1278.400 QQBrowser/9.0.2524.400 Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2875.116 Safari/537.36 NetType/WIFI MicroMessenger/7.0.5 WindowsWechat\" \"-\"\n112.65.61.117 - - [05/Nov/2019:17:10:54 +0800] \"GET /js/chunk-vendors.3a6c246c.js HTTP/1.1\" 404  260490 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36 QBCore/4.0.1278.400 QQBrowser/9.0.2524.400 Mozilla/5.0 (Windows NT 6.1; WOW64) Apessenger/7.0.5(0x17000523) NetType/4G Language/zh_CN\" \"-\"\n223.104.189.205 - - [05/Nov/2019:17:10:54 +0800] \"GET /js/app.ec4e6290.js HTTP/1.1\" 200 11149 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 12_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.5(0x17000523) NetType/4G Language/zh_CN\" \"-\"\n223.104.189.205 - - [05/Nov/2019:17:10:55 +0800] \"GET /js/chunk-vendors.3a6c246c.js HTTP/1.1\" 200 260482 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 12_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.5(0x17000523) NetType/4G Language/zh_CN\" \"-\"\n223.104.189.205 - - [05/Nov/2019:17:10:55 +0800] \"GET /api/2 HTTP/1.1\" 500 502 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 12_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.5(0x17000523) NetType/4G Language/zh_CN\" \"-\"\n223.104.189.205 - - [05/Nov/2019:17:10:55 +0800] \"GET /js/chunk-2eca3a5a.2f1d5ea3.js HTTP/1.1\" 200 5276 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 12_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.5(0x17000523) NetType/4G Language/zh_CN\" \"-\"\n223.104.189.205 - - [05/Nov/2019:17:10:55 +0800] \"GET /css/chunk-91d36e6e.a5cb4df4.css HTTP/1.1\" 200 1133 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 12_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.5(0x17000523) NetType/4G Language/zh_CN\" \"-\"\n223.104.189.205 - - [05/Nov/2019:17:10:55 +0800] \"GET /js/chunk-03341f87.78501520.js HTTP/1.1\" 200 1059 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 12_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.5(0x17000523) NetType/4G Language/zh_CN\" \"-\"\n223.104.189.205 - - [05/Nov/2019:17:10:55 +0800] \"GET /js/chunk-91d36e6e.a1444c20.js HTTP/1.1\" 200 12674 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 12_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.5(0x17000523) NetType/4G Language/zh_CN\" \"-\"\n223.104.189.205 - - [05/Nov/2019:17:10:56 +0800] \"GET /api/1 HTTP/1.1\" 500 39193 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 12_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.5(0x17000523) NetType/4G Language/zh_CN\" \"-\"\n223.104.189.205 - - [05/Nov/2019:17:10:56 +0800] \"GET /img/download.f4b65200.png HTTP/1.1\" 200 7737 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 12_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.5(0x17000523) NetType/4G Language/zh_CN\" \"-\"\n223.104.189.205 - - [05/Nov/2019:17:10:57 +0800] \"GET /img/background.fc2d80f1.png HTTP/1.1\" 200 57711 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 12_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.5(0x17000523) NetType/4G Language/zh_CN\" \"-\"\n223.104.189.205 - - [05/Nov/2019:17:10:57 +0800] \"GET /img/peitu.a89ef99f.svg HTTP/1.1\" 301 106569 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 12_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.5(0x17000523) NetType/4G Language/zh_CN\" \"-\"\n223.104.189.205 - - [05/Nov/2019:17:10:57 +0800] \"GET /fonts/element-icons.535877f5.woff HTTP/1.1\" 200 28200 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 12_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.5(0x17000523) NetType/4G Language/zh_CN\" \"-\"\n112.65.61.117 - - [05/Nov/2019:17:10:59 +0800] \"GET /img/download.f4b65200.png HTTP/1.1\" 200 7737 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36 QBCore/4.0.1278.400 QQBrowser/9.0.2524.400 Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2875.116 Safari/537.36 NetType/WIFI MicroMessenger/7.0.5 WindowsWechat\" \"-\"\n112.65.61.117 - - [05/Nov/2019:17:10:59 +0800] \"GET /img/scan.d3d981fc.png HTTP/1.1\" 404 39193 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36 QBCore/4.0.1278.400 QQBrowser/9.0.2524.400 Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2875.116 Safari/537.36 NetType/WIFI MicroMessenger/7.0.5 WindowsWechat\" \"-\"\n112.65.61.117 - - [05/Nov/2019:17:10:59 +0800] \"GET /img/background.fc2d80f1.png HTTP/1.1\" 200 57711 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36 QBCore/4.0.1278.400 QQBrowser/9.0.2524.400 Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2875.116 Safari/537.36 NetType/WIFI MicroMessenger/7.0.5 WindowsWechat\" \"-\"\n112.65.61.117 - - [05/Nov/2019:17:11:00 +0800] \"GET /img/peitu.a89ef99f.svg HTTP/1.1\" 200 106569 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36 QBCore/4.0.1278.400 QQBrowser/9.0.2524.400 Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2875.116 Safari/537.36 NetType/WIFI MicroMessenger/7.0.5 WindowsWechat\" \"-\"\n14.106.162.188 - - [05/Nov/2019:17:14:40 +0800] \"GET /index HTTP/1.1\" 200 535 \"-\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 12_4_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.8(0x17000820) NetType/4G Language/zh_CN\" \"-\"\n14.106.162.188 - - [05/Nov/2019:17:14:40 +0800] \"GET /css/app.7d918353.css HTTP/1.1\" 200 1290 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 12_4_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.8(0x17000820) NetType/4G Language/zh_CN\" \"-\"\n14.106.162.188 - - [05/Nov/2019:17:14:40 +0800] \"GET /js/app.ec4e6290.js HTTP/1.1\" 404 11149 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (iPhone; CPU iPhone OS 12_4_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/7.0.8(0x17000820) NetType/4G Language/zh_CN\" \"-\"\n</code></pre>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#42-\u601d\u8def","title":"4.2 \u601d\u8def","text":"<p>\u53ef\u4ee5\u5229\u7528\u4e0a\u8282\u8bfe\u7684\u6570\u7ec4\u8fdb\u884c\u72b6\u6001\u5b58\u50a8\uff0c\u4e4b\u540e\u5229\u7528\u7edf\u8ba1\u6bcf\u4e2a\u72b6\u6001\u7684\u6570\u91cf\u6765\u5229\u7528 echo \u989c\u8272\u8fdb\u884c\u533a\u5206\u663e\u793a\u3002</p>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#43-\u5b9e\u73b0","title":"4.3 \u5b9e\u73b0","text":"<ul> <li>\u5c06 nginx \u8bbf\u95ee\u65e5\u5fd7\u6587\u4ef6\u5b58\u50a8\u4e3a nginx.log\uff0c\u53ef\u4ee5\u5229\u7528 cat \u547d\u4ee4\u6765\u521b\u5efa\u6587\u4ef6</li> </ul> <pre><code>cat &gt; nginx.log &lt;&lt;EOF\n112.65.61.117 - - [05/Nov/2019:17:10:54 +0800] \"GET /js/chunk-2eca3a5a.2f1d5ea3.js HTTP/1.1\" 200 5276 \"https://smartsds.tools.anchnet.com/index\" \"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36 QBCore/4.0.1278.400 QQBrowser/9.0.2524.400 Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2875.116 Safari/537.36 NetType/WIFI MicroMessenger/7.0.5 WindowsWechat\" \"-\"\n...\nEOF\n</code></pre> <ul> <li>\u7f16\u5199\u4ee3\u7801\uff0c\u5176\u4e2d\u4e3a\u4eec\u5229\u7528 cut \u5bf9 nginx \u65e5\u5fd7\u6587\u4ef6\u8fdb\u884c\u5206\u5272\uff0c\u72b6\u6001\u7801\u7684\u5217\u5c3e\u7b2c\u4e5d\u5217\u3002</li> </ul> <pre><code>#!/bin/bash\n# Description: nginx status\n# Auth: kaliarch\n# Email: kaliarch@163.com\n# function: nginx status check\n# Date: 2020-03-21 14:00\n# Version: 1.0\n# \u5bf9\u8f93\u5165\u7684nginx\u65e5\u5fd7\u6587\u4ef6\u8fdb\u884c\u5224\u65ad\nNGINX_LOG=$1\n# \u5b9a\u4e49\u7ba1\u7406\u6570\u7ec4\ndeclare -A HTTP_STATUS\n# \u5bf9\u6570\u7ec4\u8fdb\u884c\u5185\u5bb9\u8d4b\u503c\n# \u5229\u7528netstat\u547d\u4ee4\u6765\u8fc7\u6ee4\u51fa\u5173\u7cfb\u7684\u4e00\u5217\u6570\u636e\nfor status in $(cat ${NGINX_LOG} |cut -d\" \" -f9)\ndo\n# \u5bf9\u72b6\u6001\u76f8\u540c\u72b6\u6001\u7684HTTP\u8fdb\u884c\u6570\u503c\u7d2f\u52a0\nlet HTTP_STATUS[${status}]++\ndone\n# \u5c06\u7edf\u8ba1\u5b8c\u6210\u7684TCP\u94fe\u63a5\u72b6\u6001\u53ca\u6570\u636e\u8bb0\u5f55\u5230\u65e5\u5fd7\u4e2d\nfor i in ${!HTTP_STATUS[@]}\ndo if [ ${i} -eq 404 ];then\necho -e \"\\033[34;40m\u6587\u4ef6${NGINX_LOG}\u4e2d\u72b6\u6001\u7801\u4e3a${i}\u7684\u6570\u91cf\u4e3a${HTTP_STATUS[${i}]} \\033[0m\"\nelif [ ${i} -eq 500 ];then\necho -e \"\\033[31;40m\u6587\u4ef6${NGINX_LOG}\u4e2d\u72b6\u6001\u7801\u4e3a${i}\u7684\u6570\u91cf\u4e3a${HTTP_STATUS[${i}]} \\033[0m\"\nelif [ ${i} -eq 200 ];then\necho -e \"\\033[32;40m\u6587\u4ef6${NGINX_LOG}\u4e2d\u72b6\u6001\u7801\u4e3a${i}\u7684\u6570\u91cf\u4e3a${HTTP_STATUS[${i}]} \\033[0m\"\nelse\necho -e \"\\033[36;40m\u6587\u4ef6${NGINX_LOG}\u4e2d\u72b6\u6001\u7801\u4e3a${i}\u7684\u6570\u91cf\u4e3a${HTTP_STATUS[${i}]} \\033[0m\"\nfi\ndone\n</code></pre> <ul> <li>\u6267\u884c\u7ed3\u679c</li> </ul> <pre><code>[root@master shell_echo]# bash nginx_status.sh nginx.log \n\u6587\u4ef6nginx.log\u4e2d\u72b6\u6001\u7801\u4e3a200\u7684\u6570\u91cf\u4e3a17 \u6587\u4ef6nginx.log\u4e2d\u72b6\u6001\u7801\u4e3a301\u7684\u6570\u91cf\u4e3a1 \u6587\u4ef6nginx.log\u4e2d\u72b6\u6001\u7801\u4e3a404\u7684\u6570\u91cf\u4e3a2 \u6587\u4ef6nginx.log\u4e2d\u72b6\u6001\u7801\u4e3a500\u7684\u6570\u91cf\u4e3a2 </code></pre>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#5-\u6ce8\u610f\u4e8b\u9879","title":"5. \u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u5728 echo \u53d8\u91cf\u5f15\u7528\u65f6\uff0c\u6211\u4eec\u63a8\u8350\u52e4\u7528\u5f15\u53f7\uff0c\u5355\u5f15\u53f7\u4e3a\u539f\u6837\u8f93\u51fa\u5b57\u7b26\u4e32\uff0c\u53cc\u5f15\u53f7\u4e3a\u8f93\u51fa\u53d8\u91cf\u7684\u503c\uff1b</li> <li>printf \u7531 POSIX \u6807\u51c6\u6240\u5b9a\u4e49\uff0c\u56e0\u6b64\u4f7f\u7528 printf \u7684\u811a\u672c\u6bd4\u4f7f\u7528 echo \u79fb\u690d\u66f4\u597d\uff0c\u5982\u679c\u540e\u671f\u8003\u8651\u5e73\u53f0\u79fb\u690d\u95ee\u9898\uff0c\u5efa\u8bae\u4f7f\u7528 <code>printf</code>\u3002</li> </ul>"},{"location":"Linux/shell/6.Shell%20echo_printf%E5%91%BD%E4%BB%A4/#6-\u5c0f\u7ed3","title":"6. \u5c0f\u7ed3","text":"<p>\u5728 shell \u4e2d\u6211\u4eec\u53ef\u4ee5\u5229\u7528 echo \u6765\u8bb0\u5f55\u7a0b\u5e8f\u7684\u65e5\u5fd7\uff0c\u6216\u5bf9\u6587\u4ef6\u8fdb\u884c\u65b0\u589e\u5185\u5bb9\u8f93\u5165\uff0c\u6216\u5229\u7528\u5176\u8fdb\u884c\u989c\u8272\u6253\u5370\uff0c\u53ef\u4ee5\u8f93\u51fa\u5e26\u6709\u989c\u8272\u7684\u6f02\u4eae\u63d0\u793a\u3002\u5728\u8bbe\u8ba1\u591a\u5e73\u53f0\u79fb\u690d\u6027\u95ee\u9898\u7684\u65f6\u5019\uff0c\u4e3a\u4eec\u53ef\u4ee5\u4f18\u5148\u8003\u8651 <code>printf</code>\uff0c\u5bf9\u4e8e\u6570\u7ec4\u663e\u53ef\u4ee5\u4f7f\u7528 <code>printf</code> \u6765\u5b8c\u6210\uff0c\u7075\u6d3b\u8fd0\u7528\u663e\u793a\u4f7f\u5f97\u811a\u672c\u7f16\u5199\u66f4\u4e3a\u65b9\u4fbf\u7075\u6d3b\u3002</p>"},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/","title":"7.Shell test \u547d\u4ee4","text":""},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#1-shell-test-\u547d\u4ee4\u6982\u8ff0","title":"1. Shell test \u547d\u4ee4\u6982\u8ff0","text":""},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#11-shell-test-\u547d\u4ee4\u7b80\u4ecb","title":"1.1 Shell test \u547d\u4ee4\u7b80\u4ecb","text":"<p>\u5728\u6211\u4eec\u4e4b\u524d\u7ae0\u8282\u5b66\u4e60\u4e86 Shell \u7684\u8fd0\u7b97\u7b26\uff0c\u5176\u4e2d\u5927\u591a\u6570\u8fd0\u7b97\u90fd\u53ef\u4ee5\u7ed3\u5408 <code>test</code> \u547d\u4ee4\u6765\u5b8c\u6210\u6d4b\u8bd5\u4e0e\u6bd4\u8f83\u64cd\u4f5c\uff0c<code>test</code> \u547d\u4ee4\u914d\u5408\u5404\u64cd\u4f5c\u7b26\u53f7\uff0c\u4e0d\u4ec5\u53ef\u4ee5\u5b8c\u6210\u6d4b\u8bd5\u903b\u8f91\u8868\u8fbe\u5f0f\uff0c\u8fd8\u53ef\u4ee5\u8fdb\u884c\u6587\u4ef6\uff0c\u6570\u5b57\uff0c\u5b57\u7b26\u4e32\u7684\u6bd4\u8f83\u3002\u672c\u6587\u662f\u4e00\u4e9b\u5e38\u89c1\u7528\u6cd5\u7684\u5f52\u7eb3\u603b\u7ed3\u3002</p>"},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#12-\u4e3a\u4ec0\u4e48\u8981\u7528-test-\u547d\u4ee4","title":"1.2 \u4e3a\u4ec0\u4e48\u8981\u7528 test \u547d\u4ee4","text":"<p>\u5728 Shell \u4e2d\u6bcf\u4e2a\u547d\u4ee4\u90fd\u6709\u5176\u5e94\u7528\u573a\u666f\uff0ctest \u547d\u4ee4\u4e5f\u4e0d\u4f8b\u5916\uff0c\u5176\u5e94\u7528\u573a\u666f\u51e0\u4e4e\u904d\u5e03\u6211\u4eec\u6574\u4e2a Shell \u811a\u672c\u7684\u751f\u547d\u5468\u671f\uff0c\u57fa\u672c\u4e0a Shell \u811a\u672c\u91cc\u9762\u90fd\u4f1a\u6709\u5176\u8eab\u5f71\u3002</p> <p>\u5f53\u6211\u4eec\u5bf9\u6570\u503c\u8fdb\u884c\u7b97\u672f\u8fd0\u7b97\uff0c\u5f53\u6211\u4eec\u9700\u8981\u5bf9\u6587\u4ef6\u8fdb\u884c\u5224\u65ad\uff0c\u5f53\u6211\u4eec\u9700\u8981\u5bf9\u903b\u8f91\u6216\u5b57\u7b26\u4e32\u8fdb\u884c\u5224\u65ad\u7684\u65f6\u5019\uff0c\u8fd9\u4e9b\u60c5\u51b5\u90fd\u9700\u8981\u4f7f\u7528 test \u547d\u4ee4\u6765\u914d\u5408\u8fd0\u7b97\u7b26\u8fdb\u884c\u64cd\u4f5c\u3002</p>"},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#2-shell-test-\u547d\u4ee4\u7b80\u4ecb","title":"2. Shell test \u547d\u4ee4\u7b80\u4ecb","text":""},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#21-\u72b6\u6001\u8fd4\u56de\u503c","title":"2.1 \u72b6\u6001\u8fd4\u56de\u503c","text":"<p>\u5728\u6211\u4eec\u5b66\u4e60 test \u547d\u4ee4\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u77e5\u9053\u5728 Linux \u4e2d\u6267\u884c\u547d\u4ee4\u8fd4\u56de 0 \u4e3a\u6b63\u5e38\uff0c\u8fd4\u56de\u975e 0 \u8868\u793a\u5f02\u5e38\uff0c\u53ef\u4ee5\u5229\u7528 <code>$?</code> \u6765\u83b7\u53d6\u8fd4\u56de\u503c\u3002\u5728\u4e0b\u9762\u7684 test \u64cd\u4f5c\u4e2d\u6211\u4eec\u5c31\u4f1a\u8fd0\u7528\u6b64\u7279\u6027\u6765\u8fdb\u884c\u6d4b\u8bd5\u6bd4\u8f83\u3002</p>"},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#22-test-\u547d\u4ee4\u7b80\u4ecb","title":"2.2 test \u547d\u4ee4\u7b80\u4ecb","text":"<ul> <li>test \u547d\u4ee4</li> </ul> <p>test \u4e3a Shell \u5185\u7f6e\u547d\u4ee4\uff0c\u5176\u901a\u5e38\u9700\u8981\u4e0e if \u8bed\u53e5\u4e00\u5757\u4f7f\u7528\u3002</p> <ul> <li>\u8bed\u6cd5\u683c\u5f0f</li> </ul> <p>\u8bed\u6cd5\u683c\u5f0f\u4e3a <code>test expression</code>, \u5f53 test \u5224\u65ad expression \u4e3a\u6210\u7acb\u65f6\uff0c\u8fd4\u56de\u72b6\u6001\u4e3a 0\uff0c\u5426\u5219\u4e3a\u975e 0 \u503c\u3002</p> <p>test \u547d\u4ee4\u8fd8\u53ef\u4ee5\u7b80\u5199\u4e3a <code>[ ]</code>, \u9700\u8981\u5728\u4e24\u8fb9\u4e2d\u62ec\u53f7\u4e0e expression \u662f\u6709\u4e00\u4e2a\u7a7a\u683c\uff0c\u8fd9\u4e2a\u7a7a\u683c\u662f\u5fc5\u987b\u7684\uff0c\u5426\u5219\u4f1a\u5bfc\u81f4\u8bed\u6cd5\u9519\u8bef\u3002<code>[]</code> \u7684\u5199\u6cd5\u66f4\u52a0\u7b80\u6d01\uff0c\u6bd4 test \u4f7f\u7528\u9891\u7387\u66f4\u9ad8\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u6765\u770b\u793a\u4f8b\uff1a</p> <pre><code>[root@master shell_test]# cat test1.sh #!/bin/bash\n// \u4f7f\u7528\u4e2d\u62ec\u53f7\nif test 10 -ne 1;then\necho \"true\"\nelse\necho \"false\"\nfi\n[root@master shell_test]# bash test1.sh true\n[root@master shell_test]# cat test2.sh #!/bin/bash\n// \u4f7f\u7528test\nif [ 10 -eq 1 ];then\necho \"true\"\nelse\necho \"false\"\nfi\n[root@master shell_test]# bash test2.sh true\n</code></pre>"},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#3-test-\u547d\u4ee4\u64cd\u4f5c","title":"3. test \u547d\u4ee4\u64cd\u4f5c","text":"<p>test \u547d\u4ee4\u64cd\u4f5c\u4e3b\u8981\u914d\u5408\u6bd4\u8f83\u8fd0\u7b97\u7b26\u8fdb\u884c\uff0c\u53ef\u5927\u4f53\u5206\u4e3a\u6587\u4ef6\u5224\u65ad / \u6570\u7ec4\u6bd4\u8f83 / \u5b57\u7b26\u4e32\u5224\u65ad / \u903b\u8f91\u8fd0\u7b97\u7b49\u3002</p>"},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#31-\u6570\u503c\u6bd4\u8f83","title":"3.1 \u6570\u503c\u6bd4\u8f83","text":"<p>\u6570\u7ec4\u6bd4\u8f83\u5176\u5b9e\u5c31\u662f test \u547d\u4ee4\u914d\u5408\u5173\u7cfb\u8fd0\u7b97\u7b26\u8fdb\u884c\u6570\u5b57\u6bd4\u8f83\u3002</p> \u6bd4\u8f83\u7b26 \u63cf\u8ff0 \u793a\u4f8b -eq\uff0cequal \u7b49\u4e8e [1 -eq 1] \u4e3a true -ne\uff0cnot equal \u4e0d\u7b49\u4e8e [ 1 -ne 1 \u4e3a false -gt\uff0cgreater than \u5927\u4e8e [2 -gt 1] \u4e3a true -lt\uff0clesser than \u5c0f\u4e8e [2 -lt 1] \u4e3a false -ge\uff0cgreater or equal \u5927\u4e8e\u6216\u7b49\u4e8e [2 -ge 1] \u4e3a true -le\uff0clesser or equal \u5c0f\u4e8e\u6216\u7b49\u4e8e [2 -le 1] \u4e3a false <p>\u5173\u7cfb\u8fd0\u7b97\u987e\u540d\u601d\u4e49\u5c31\u662f\u6bd4\u8f83\u6570\u5b57\u7684\u5927\u5c0f\uff0c\u6ce8\u610f\u5173\u7cfb\u8fd0\u7b97\u7b26\u4f5c\u7528\u7684\u5bf9\u8c61\u4e3a\u6570\u5b57\u3002</p> <pre><code>#!/bin/bash\nnum1=1\nnum2=2\necho \"num1 \u4e3a\uff1a${num1}\"\necho \"num2 \u4e3a\uff1a${num2}\"\nif [ $num1 -eq $num2 ]\nthen\necho \"$num1 -eq $num2 : num1 \u7b49\u4e8e num2\"\nelse\necho \"$num1 -eq $num2: num1 \u4e0d\u7b49\u4e8e num2\"\nfi\nif [ $num1 -ne $num2 ]\nthen\necho \"$num1 -ne $num2: num1 \u4e0d\u7b49\u4e8e num2\"\nelse\necho \"$num1 -ne $num2 : num1 \u7b49\u4e8e num2\"\nfi\nif [ $num1 -gt $num2 ]\nthen\necho \"$num1 -gt $num2: num1 \u5927\u4e8e num2\"\nelse\necho \"$num1 -gt $num2: num1 \u4e0d\u5927\u4e8e num2\"\nfi\nif [ $num1 -lt $num2 ]\nthen\necho \"$num1 -lt $num2: num1 \u5c0f\u4e8e num2\"\nelse\necho \"$num1 -lt $num2: num1 \u4e0d\u5c0f\u4e8e num2\"\nfi\nif [ $num1 -ge $num2 ]\nthen\necho \"$num1 -ge $num2: num1 \u5927\u4e8e\u6216\u7b49\u4e8e num2\"\nelse\necho \"$num1 -ge $num2: num1 \u5c0f\u4e8e num2\"\nfi\nif [ $num1 -le $num2 ]\nthen\necho \"$num1 -le $num2: num1 \u5c0f\u4e8e\u6216\u7b49\u4e8e num2\"\nelse\necho \"$num1 -le $num2: num1 \u5927\u4e8e num2\"\nfi\n</code></pre> <p>\u8fd0\u884c\u7ed3\u679c\u4e3a\uff1a</p> <pre><code>num1 \u4e3a\uff1a1\nnum2 \u4e3a\uff1a2\n1 -eq 2: num1 \u4e0d\u7b49\u4e8e num2\n1 -ne 2: num1 \u4e0d\u7b49\u4e8e num2\n1 -gt 2: num1 \u4e0d\u5927\u4e8e num2\n1 -lt 2: num1 \u5c0f\u4e8e num2\n1 -ge 2: num1 \u5c0f\u4e8e num2\n1 -le 2: num1 \u5c0f\u4e8e\u6216\u7b49\u4e8e num\n</code></pre>"},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#32-\u6587\u4ef6\u5224\u65ad","title":"3.2 \u6587\u4ef6\u5224\u65ad","text":"<p>\u5728\u672c\u7ae0\u8282\u7531\u4e8e test \u547d\u4ee4\u4e0e\u8fd0\u7b97\u7b26\u914d\u5408\u4f7f\u7528\uff0c\u4e0e\u4e4b\u524d\u8fd0\u7b97\u7b26\u7ae0\u8282\u6709\u91cd\u590d\uff0c\u6211\u4eec\u5728\u6b64\u6e29\u6545\u77e5\u65b0\uff0c\u7740\u624b test \u547d\u4ee4\u6765\u5b66\u4e60\u6587\u4ef6\u5224\u65ad\u3002</p> <p>\u6587\u4ef6\u6d4b\u8bd5\u5728\u6211\u4eec\u7f16\u5199 Shell \u4e2d\u4e0e\u6587\u4ef6\u64cd\u4f5c\u975e\u5e38\u5e38\u7528\uff0c\u719f\u7ec3\u638c\u63e1\u6587\u4ef6\u64cd\u4f5c\u53ef\u4ee5\u5728\u540e\u7eed\u7684 Shell \u7f16\u5199\u4e2d\u5f97\u5fc3\u5e94\u624b\uff0c\u4f8b\u5982 file \u53d8\u91cf\u4e3a:</p> \u64cd\u4f5c\u7b26 \u8bf4\u660e \u4e3e\u4f8b -d file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u662f\u76ee\u5f55\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-d $file] \u8fd4\u56de false\u3002 -f file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u662f\u666e\u901a\u6587\u4ef6\uff08\u65e2\u4e0d\u662f\u76ee\u5f55\uff0c\u4e5f\u4e0d\u662f\u8bbe\u5907\u6587\u4ef6\uff09\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-f $file] \u8fd4\u56de true\u3002 -c file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u662f\u5b57\u7b26\u8bbe\u5907\u6587\u4ef6\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-c $file] \u8fd4\u56de false\u3002 -b file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u662f\u5757\u8bbe\u5907\u6587\u4ef6\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-b $file] \u8fd4\u56de false\u3002 -g file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u8bbe\u7f6e\u4e86 SGID \u4f4d\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-g $file] \u8fd4\u56de false\u3002 -u file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u8bbe\u7f6e\u4e86 SUID \u4f4d\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-u $file] \u8fd4\u56de false\u3002 -k file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u8bbe\u7f6e\u4e86\u7c98\u7740\u4f4d (Sticky Bit)\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-k $file] \u8fd4\u56de false\u3002 -p file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u662f\u6709\u540d\u7ba1\u9053\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-p $file] \u8fd4\u56de false\u3002 -r file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u53ef\u8bfb\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-r $file] \u8fd4\u56de true\u3002 -w file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u53ef\u5199\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-w $file] \u8fd4\u56de true\u3002 -x file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u53ef\u6267\u884c\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-x $file] \u8fd4\u56de true\u3002 -s file \u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u4e3a\u7a7a\uff08\u6587\u4ef6\u5927\u5c0f\u662f\u5426\u5927\u4e8e 0\uff09\uff0c\u4e0d\u4e3a\u7a7a\u8fd4\u56de true\u3002 [-s $file] \u8fd4\u56de true\u3002 -e file \u68c0\u6d4b\u6587\u4ef6\uff08\u5305\u62ec\u76ee\u5f55\uff09\u662f\u5426\u5b58\u5728\uff0c\u5982\u679c\u662f\uff0c\u5219\u8fd4\u56de true\u3002 [-e $file] \u8fd4\u56de true\u3002 <p>\u4f8b\u5982\uff1a</p> <pre><code>#!/bin/bash\nTEST_FILE=\"/etc/fstab\"\necho \"\u68c0\u6d4b\u7684\u6587\u4ef6\u4e3a:${TEST_FILE}\"\necho \"\u6587\u4ef6\u4fe1\u606f\u4e3a:$(ls -l ${TEST_FILE})\"\nif [ -r $TEST_FILE ]\nthen\necho \"\u6587\u4ef6\u53ef\u8bfb\"\nelse\necho \"\u6587\u4ef6\u4e0d\u53ef\u8bfb\"\nfi\nif [ -w $TEST_FILE ]\nthen\necho \"\u6587\u4ef6\u53ef\u5199\"\nelse\necho \"\u6587\u4ef6\u4e0d\u53ef\u5199\"\nfi\nif [ -x $TEST_FILE ]\nthen\necho \"\u6587\u4ef6\u53ef\u6267\u884c\"\nelse\necho \"\u6587\u4ef6\u4e0d\u53ef\u6267\u884c\"\nfi\nif [ -f $TEST_FILE ]\nthen\necho \"\u6587\u4ef6\u4e3a\u666e\u901a\u6587\u4ef6\"\nelse\necho \"\u6587\u4ef6\u4e3a\u7279\u6b8a\u6587\u4ef6\"\nfi\nif [ -d $TEST_FILE ]\nthen\necho \"\u6587\u4ef6\u662f\u4e2a\u76ee\u5f55\"\nelse\necho \"\u6587\u4ef6\u4e0d\u662f\u4e2a\u76ee\u5f55\"\nfi\nif [ -s $TEST_FILE ]\nthen\necho \"\u6587\u4ef6\u4e0d\u4e3a\u7a7a\"\nelse\necho \"\u6587\u4ef6\u4e3a\u7a7a\"\nfi\nif [ -e $TEST_FILE ]\nthen\necho \"\u6587\u4ef6\u5b58\u5728\"\nelse\necho \"\u6587\u4ef6\u4e0d\u5b58\u5728\"\nfi\n</code></pre> <p>\u8fd4\u56de\u4e3a\uff1a</p> <pre><code>\u68c0\u6d4b\u7684\u6587\u4ef6\u4e3a:/etc/fstab\n\u6587\u4ef6\u4fe1\u606f\u4e3a:-rw-r--r--. 1 root root 500 Jan 17 14:23 /etc/fstab\n\u6587\u4ef6\u53ef\u8bfb\n\u6587\u4ef6\u53ef\u5199\n\u6587\u4ef6\u4e0d\u53ef\u6267\u884c\n\u6587\u4ef6\u4e3a\u666e\u901a\u6587\u4ef6\n\u6587\u4ef6\u4e0d\u662f\u4e2a\u76ee\u5f55\n\u6587\u4ef6\u4e0d\u4e3a\u7a7a\n\u6587\u4ef6\u5b58\u5728\n</code></pre>"},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#33-\u5b57\u7b26\u4e32\u5224\u65ad","title":"3.3 \u5b57\u7b26\u4e32\u5224\u65ad","text":"<p>\u5bf9\u4e8e\u5b57\u7b26\u4e32\u5224\u65ad\u4e0e\u6570\u5b57\u5bf9\u6bd4\uff0c\u5176\u4f5c\u7528\u7684\u5bf9\u8c61\u4e0d\u540c\u9700\u8981\u683c\u5916\u6ce8\u610f\uff0c\u5229\u7528 test \u547d\u4ee4\u5bf9\u4e8e\u5b57\u7b26\u4e32\u8fdb\u884c\u4e00\u4e9b\u5224\u65ad\u64cd\u4f5c\uff0c\u5047\u5b9a\u53d8\u91cf a \u4e3a \u201clinux\u201d\uff0c\u53d8\u91cf b \u4e3a \u201cshell\u201d\uff1a</p> \u8fd0\u7b97\u7b26 \u8bf4\u660e \u4e3e\u4f8b \u2260= \u68c0\u6d4b\u4e24\u4e2a\u5b57\u7b26\u4e32\u662f\u5426\u76f8\u7b49\uff0c\u5176\u4e2d = \u548c == \u662f\u76f8\u540c\u7684\uff0c\u76f8\u7b49\u8fd4\u56de true\u3002 [$a = $b] \u8fd4\u56de false\u3002 != \u68c0\u6d4b\u4e24\u4e2a\u5b57\u7b26\u4e32\u662f\u5426\u76f8\u7b49\uff0c\u4e0d\u76f8\u7b49\u8fd4\u56de true\u3002 [$a != $b] \u8fd4\u56de true\u3002 -z \u68c0\u6d4b\u5b57\u7b26\u4e32\u957f\u5ea6\u662f\u5426\u4e3a 0\uff0c\u4e3a 0 \u8fd4\u56de true\u3002 [-z $a] \u8fd4\u56de false\u3002 -n \u68c0\u6d4b\u5b57\u7b26\u4e32\u957f\u5ea6\u662f\u5426\u4e3a 0\uff0c\u4e0d\u4e3a 0 \u8fd4\u56de true\u3002 [-n \u201c$a\u201d ] \u8fd4\u56de true\u3002 <p>\u4f8b\u5982\uff1a</p> <pre><code>#!/bin/bash\nstr1=\"linux\"\nstr2=\"shell\"\necho \"str1 \u4e3a\uff1a${str1}\"\necho \"str2 \u4e3a\uff1a${str2}\"\nif [ $str1 = $str2 ];then\necho \"$str1 = $str2 : str1 \u7b49\u4e8e str2\"\nelse\necho \"$str1 = $str2: str1 \u4e0d\u7b49\u4e8e str2\"\nfi\nif [ $str1 != $str2 ];then\necho \"$str1 != $str2 : str1 \u4e0d\u7b49\u4e8e str2\"\nelse\necho \"$str1 != $str2: str1 \u7b49\u4e8e str2\"\nfi\nif [ -z $str1 ];then\necho \"-z $str1 : \u5b57\u7b26\u4e32\u957f\u5ea6\u4e3a 0\"\nelse\necho \"-z $str1 : \u5b57\u7b26\u4e32\u957f\u5ea6\u4e0d\u4e3a 0\"\nfi\nif [ -n \"$str1\" ];then\necho \"-n $str1 : \u5b57\u7b26\u4e32\u957f\u5ea6\u4e0d\u4e3a 0\"\nelse\necho \"-n $str1 : \u5b57\u7b26\u4e32\u957f\u5ea6\u4e3a 0\"\nfi\nif [ ${str1} ];then\necho \"str1 : \u5b57\u7b26\u4e32\u4e0d\u4e3a\u7a7a\"\nelse\necho \"str1 : \u5b57\u7b26\u4e32\u4e3a\u7a7a\"\nfi\n</code></pre> <p>\u8fd4\u56de\u4e3a\uff1a</p> <pre><code>str1 \u4e3a\uff1alinux\nstr2 \u4e3a\uff1ashell\nlinux = shell: str1 \u4e0d\u7b49\u4e8e str2\nlinux != shell : str1 \u4e0d\u7b49\u4e8e str2\n-z linux : \u5b57\u7b26\u4e32\u957f\u5ea6\u4e0d\u4e3a 0\n-n linux : \u5b57\u7b26\u4e32\u957f\u5ea6\u4e0d\u4e3a 0\nstr1 : \u5b57\u7b26\u4e32\u4e0d\u4e3a\u7a7a   </code></pre>"},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#34-\u903b\u8f91\u8fd0\u7b97","title":"3.4 \u903b\u8f91\u8fd0\u7b97","text":"<p>\u5229\u7528 test \u547d\u4ee4\u53ef\u4ee5\u8fdb\u884c\u903b\u8f91\u5224\u65ad\uff0c\u4ee5\u4e0b\u4ecb\u7ecd Shell \u7684\u903b\u8f91\u8fd0\u7b97\u7b26\uff0c\u5047\u5b9a\u53d8\u91cf A \u4e3a 1\uff0c\u53d8\u91cf b \u4e3a 2\uff1a</p> <p>\u5982\u679c\u9700\u8981\u5728\u4e00\u4e2a test \u4e2d\u6267\u884c\u591a\u4e2a\u5224\u65ad\uff0c\u9700\u8981\u4f7f\u7528 <code>[[]]</code>, test \u662f Shell \u5185\u7f6e\u5173\u952e\u5b57\uff0c\u4e0d\u662f\u547d\u4ee4\uff0c\u514d\u9664\u51fd\u6570\u4f20\u9012\u8fc7\u7a0b\uff0c\u56e0\u6b64\u66f4\u52a0\u5efa\u8bae\u4f7f\u7528 <code>[[]]</code>\u3002\u53cc\u4e2d\u62ec\u53f7\u6709\u4e00\u4e0b\u6ce8\u610f\u4e8b\u9879\uff1a</p> <ul> <li>\u4e0d\u9700\u8981\u628a\u53d8\u91cf\u540d\u7528\u53cc\u5f15\u53f7 <code>\"\"</code> \u5305\u56f4\u8d77\u6765\uff0c\u5373\u4f7f\u53d8\u91cf\u662f\u7a7a\u503c\uff0c\u4e5f\u4e0d\u4f1a\u51fa\u9519\uff1b</li> <li>\u4e0d\u9700\u8981\u3001\u4e5f\u4e0d\u80fd\u5bf9 &gt;\u3001&lt; \u8fdb\u884c\u8f6c\u4e49\uff0c\u8f6c\u4e49\u540e\u4f1a\u51fa\u9519\uff1b</li> <li>\u5176\u652f\u6301\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u7ec4\u5408\u903b\u8f91\u53ef\u4ee5\u4e0d\u4f7f\u7528 test \u7684 - a,-o \u800c\u4f7f\u7528 &amp;&amp; ||\u3002</li> </ul> <p>\u4e0e\u903b\u8f91\u8fd0\u7b97\u7b26\u53f7\u5bf9\u5e94\u7684 <code>&amp;&amp;</code> \u53ef\u4ee5\u4f7f\u7528 <code>-a</code>\uff0c<code>||</code> \u53ef\u4ee5\u4f7f\u7528 <code>-o</code> \u6765\u66ff\u6362\u3002</p> \u8fd0\u7b97\u7b26 \u8bf4\u660e \u4e3e\u4f8b &amp;&amp; \u903b\u8f91\u7684 AND <code>[[ $A -lt 10 &amp;&amp; $B -gt 100 ]] \u8fd4\u56de false</code> || \u903b\u8f91\u7684 OR <code>[[ $A -lt 10 || $B -gt 100 ]] \u8fd4\u56de true</code> <p>\u4f8b\u5982:</p> <pre><code>#!/bin/bash\nnum1=1\nnum2=2\necho \"num1 \u4e3a:${num1}\"\necho \"num2 \u4e3a:${num2}\"\nif [[ $num1 -lt 5 &amp;&amp; $num2 -gt 5 ]];then\necho \"\u8fd4\u56de true\"\nelse\necho \"\u8fd4\u56de false\"\nfi\nif [[ $num1 -lt 5 || $num2 -gt 5 ]];then\necho \"\u8fd4\u56de true\"\nelse\necho \"\u8fd4\u56de false\"\nfi\nif [ $num1 -lt 5 ] &amp;&amp; [ $num2 -gt 5 ];then\necho \"\u8fd4\u56de true\"\nelse\necho \"\u8fd4\u56de false\"\nfi\nif [ $num1 -lt 5 ] || [ $num2 -gt 5 ];then\necho \"\u8fd4\u56de true\"\nelse\necho \"\u8fd4\u56de false\"\nfi\nif [ $num1 -lt 5  -a  $num2 -gt 5 ];then\necho \"\u8fd4\u56de true\"\nelse\necho \"\u8fd4\u56de false\"\nfi\nif [ $num1 -lt 5 -o  $num2 -gt 5 ];then\necho \"\u8fd4\u56de true\"\nelse\necho \"\u8fd4\u56de false\"\nfi\n</code></pre> <p>\u8fd4\u56de\uff1a</p> <pre><code>num1 \u4e3a:1\nnum2 \u4e3a:2\n\u8fd4\u56de false\n\u8fd4\u56de true\n\u8fd4\u56de false\n\u8fd4\u56de true\n\u8fd4\u56de false\n\u8fd4\u56de true\n</code></pre>"},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#4-\u5b9e\u4f8b","title":"4. \u5b9e\u4f8b","text":""},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#41-\u9700\u6c42","title":"4.1 \u9700\u6c42","text":"<p>\u7f16\u5199\u4e00\u4e2a\u811a\u672c\uff0c\u53ef\u4ee5\u4f20\u5165\u4efb\u610f\u591a\u4e2a\u6570\u503c\uff0c\u8981\u6c42\u8f93\u5165\u7684\u6570\u5b57\u5927\u4e8e\u7b49\u4e8e 0\uff0c\u811a\u672c\u6267\u884c\u8f93\u51fa\u6700\u5c0f\u7684\u548c\u6700\u5927\u7684\u6570\u5b57\u3002</p>"},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#42-\u601d\u8def","title":"4.2 \u601d\u8def","text":"<p>\u53ef\u4ee5\u5229\u7528\u6587\u4ef6\u6d4b\u8bd5\u8fd0\u7b97\u7b26\u6765\u5224\u65ad\u8f93\u51fa\u7684\u76ee\u5f55\u662f\u5426\u6b63\u786e\uff0c\u4e4b\u540e\u5229\u7528\u7b97\u672f\u8fd0\u7b97\u7b26\u914d\u5408\u6570\u7ec4\u5bf9\u6587\u4ef6\u6216\u76ee\u5f55\u8fdb\u884c\u7edf\u8ba1\u3002</p>"},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#43-\u5b9e\u73b0","title":"4.3 \u5b9e\u73b0","text":"<pre><code>#!/bin/bash\n# Description: count file scripts\n# Auth: kaliarch\n# Email: kaliarch@163.com\n# function: count file\n# Date: 2020-03-21 14:00\n# Version: 1.0\n# \u5224\u65ad\u8f93\u5165\u81f3\u5c11\u4e00\u4e2a\u53c2\u6570\n[ $# -le 1 ] &amp;&amp; echo \"\u8f93\u5165\u53c2\u6570\u9519\u8bef\uff0c\u81f3\u5c11\u8f93\u5165\u4e00\u4e2a\u6570\u5b57\" &amp;&amp; exit 1\nfor num in $*;\ndo\n# \u5224\u65ad\u8f93\u5165\u7684\u90fd\u4e3a\u6570\u5b57\u4e14\u8f93\u5165\u6570\u5b57\u5927\u4e8e\u7b49\u4e8e0\n[ \"${num}\" -ge 0 ] 2&gt;/dev/null\n[ $? -ne 0 ] &amp;&amp; echo \"\u8f93\u5165\u7684${num}\u4e0d\u7b26\u5408\u53c2\u6570\u89c4\u8303\" &amp;&amp; exit 1\ndone\n# \u5bf9\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u8fdb\u884c\u7edf\u8ba1\nMIN_NUM=$1\nMAX_NUM=$1\nfor num in $*;\ndo\nif [    ${num} -gt ${MAX_NUM}   ];then\nMAX_NUM=${num}\nelif [ ${num} -lt ${MIN_NUM} ];then\nMIN_NUM=${num}\nelse\necho -e \"\"\nfi\ndone\necho \"\u8f93\u5165\u7684\u53c2\u6570\u603b\u5171\u4e3a\uff1a$#\"\necho \"\u8f93\u5165\u7684\u6570\u5b57\u4e3a\uff1a$*\"\necho \"\u5176\u4e2d\u6700\u5927\u7684\u6570\u5b57\u4e3a\uff1a${MAX_NUM}\"\necho \"\u5176\u4e2d\u6700\u5c0f\u7684\u6570\u5b57\u4e3a\uff1a${MIN_NUM}\"\n</code></pre>"},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#44-\u6d4b\u8bd5","title":"4.4 \u6d4b\u8bd5","text":"<p>\u5f53\u6211\u4eec\u4e0d\u8f93\u5165\u4efb\u4f55\u53c2\u6570\uff0c\u6216\u8f93\u5165\u5355\u4e2a\u53c2\u6570\u7684\u65f6\u5019\uff0c\u63d0\u793a\u8f93\u5165\u53c2\u6570\u9519\u8bef\uff0c\u81f3\u5c11\u8f93\u5165\u4e00\u4e2a\u6570\u5b57\uff1b</p> <p>\u5982\u679c\u8f93\u5165\u6709\u5305\u542b\u5b57\u7b26\u4e32\uff0c\u5219\u63d0\u793a\u53c2\u6570\u4e0d\u89c4\u8303\uff1b</p> <p>\u5f53\u8f93\u5165\u4e00\u4e9b\u5217\u6570\u5b57\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u5f97\u5230\u6b63\u786e\u7684\u7ed3\u679c\u3002</p> <pre><code>[root@master shell_test]# bash num_check.sh \u8f93\u5165\u53c2\u6570\u9519\u8bef\uff0c\u81f3\u5c11\u8f93\u5165\u4e00\u4e2a\u6570\u5b57\n[root@master shell_test]# bash num_check.sh 1\n\u8f93\u5165\u53c2\u6570\u9519\u8bef\uff0c\u81f3\u5c11\u8f93\u5165\u4e00\u4e2a\u6570\u5b57\n[root@master shell_test]# bash num_check.sh 1 \"hell\"\n\u8f93\u5165\u7684hell\u4e0d\u7b26\u5408\u53c2\u6570\u89c4\u8303\n[root@master shell_test]# bash num_check.sh 12 13 32 435 0\n\u8f93\u5165\u7684\u53c2\u6570\u603b\u5171\u4e3a\uff1a5\n\u8f93\u5165\u7684\u6570\u5b57\u4e3a\uff1a12 13 32 435 0\n\u5176\u4e2d\u6700\u5927\u7684\u6570\u5b57\u4e3a\uff1a435\n\u5176\u4e2d\u6700\u5c0f\u7684\u6570\u5b57\u4e3a\uff1a\n</code></pre>"},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#4-\u6ce8\u610f\u4e8b\u9879","title":"4. \u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u5bf9\u4e8e\u5173\u7cfb\u8fd0\u7b97\uff0ctest \u547d\u4ee4\u6bd4\u8f83\u7684\u5bf9\u8c61\u4e3a\u6570\u5b57\uff0c\u4e0d\u662f\u5b57\u7b26\u4e32\uff0c\u4e00\u5b9a\u8981\u7262\u8bb0\u8fd9\u4e2a\u6ce8\u610f\u70b9\uff1b</li> <li>\u5bf9\u4e8e\u5b57\u7b26\u4e32\u5224\u65ad\uff0ctest \u547d\u4ee4\u4f5c\u7528\u7684\u4e3a\u5b57\u7b26\u4e32\uff0c\u5982\u679c\u60f3\u6bd4\u8f83\u6570\u5b57\uff0c\u53ef\u4ee5\u5229\u7528\u53cc\u5f15\u53f7\u5f15\u8d77\u6765\u901a\u8fc7\u5b57\u7b26\u4e32\u5224\u65ad\u3002</li> </ul>"},{"location":"Linux/shell/7.Shell%20test%E5%91%BD%E4%BB%A4/#5-\u5c0f\u7ed3","title":"5. \u5c0f\u7ed3","text":"<p>\u5728\u672c\u7ae0\u8282\u7531\u4e8e test \u547d\u4ee4\u4e0e\u8fd0\u7b97\u7b26\u914d\u5408\u4f7f\u7528\uff0c\u4e0e\u4e4b\u524d\u8fd0\u7b97\u7b26\u7ae0\u8282\u6709\u91cd\u590d\uff0c\u5728\u6b64\u6e29\u6545\u77e5\u65b0\uff0c\u901a\u8fc7\u793a\u4f8b\u6765\u66f4\u52a0\u719f\u6089 test \u547d\u4ee4\u53ca\u76f8\u5173\u8fd0\u7b97\u7b26\uff0c\u5176\u662f\u540e\u671f Shell \u811a\u672c\u7f16\u5199\u7684\u6d41\u7a0b\u6846\u67b6\uff0c\u719f\u7ec3\u638c\u63e1 test \u547d\u4ee4\u7684\u6570\u503c\uff0c\u6587\u4ef6\uff0c\u5b57\u7b26\u4e32\u4e0e\u903b\u8f91\u8fd0\u7b97\uff0c\u4f7f\u5f97\u6211\u4eec\u7f16\u5199 Shell \u811a\u672c\u66f4\u52a0\u5f97\u5fc3\u5e94\u624b\u3002</p>"},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/","title":"8.Shell \u6d41\u7a0b\u63a7\u5236","text":""},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#1-\u6d41\u7a0b\u63a7\u5236\u6982\u8ff0","title":"1. \u6d41\u7a0b\u63a7\u5236\u6982\u8ff0","text":""},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#11-\u6d41\u7a0b\u63a7\u5236\u7b80\u4ecb","title":"1.1 \u6d41\u7a0b\u63a7\u5236\u7b80\u4ecb","text":"<p>Shell \u811a\u672c\u9ed8\u8ba4\u4ece\u4e0a\u5230\u4e0b\u987a\u5e8f\u6267\u884c\uff0c\u5728\u7a0b\u5e8f\u8fd0\u884c\u4e2d\uff0c\u4f1a\u9047\u5230\u5f88\u591a\u79cd\u60c5\u51b5\uff0c\u5bf9\u5e94\u4e0d\u540c\u60c5\u51b5\u6267\u884c\u5bf9\u5e94\u7684\u64cd\u4f5c\uff0c\u4f8b\u5982\u5bf9\u4e8e\u4e00\u6279\u6570\u636e\u9700\u8981\u8fdb\u884c\u6267\u884c\u91cd\u590d\u5de5\u4f5c\uff0c\u8fd9\u4e9b\u90fd\u9700\u8981\u6211\u4eec\u4f7f\u7528\u7279\u5b9a\u7684\u6d41\u7a0b\u63a7\u5236\u8bed\u53e5\u6765\u5b9e\u73b0\uff0c\u6211\u4eec\u60f3\u8981\u7a0b\u5e8f\u5b8c\u6210\u9884\u5b9a\u7684\u64cd\u4f5c\uff0c\u5c31\u9700\u8981\u719f\u7ec3\u638c\u63e1\u6d41\u7a0b\u63a7\u5236\u8bed\u53e5\uff0c\u4e0d\u540c\u7684\u6d41\u7a0b\u63a7\u5236\u8bed\u53e5\u6709\u4e0d\u540c\u7684\u9002\u5e94\u573a\u666f\u3002</p>"},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#12-\u4e3a\u4ec0\u4e48\u8981\u7528\u6d41\u7a0b\u63a7\u5236","title":"1.2 \u4e3a\u4ec0\u4e48\u8981\u7528\u6d41\u7a0b\u63a7\u5236","text":"<p>\u6d41\u7a0b\u63a7\u5236\u662f\u6bcf\u79cd\u7f16\u7a0b\u8bed\u8a00\u63a7\u5236\u903b\u8f91\u8d70\u5411\u548c\u6267\u884c\u6b21\u5e8f\u7684\u91cd\u8981\u7ec4\u6210\u90e8\u5206\uff0c\u6d41\u7a0b\u63a7\u5236\u53ef\u4ee5\u8bf4\u662f\u4e00\u95e8\u8bed\u8a00\u7684 \u201c\u7ecf\u8109\u201d\uff0c\u5176\u63a7\u5236\u7740\u7a0b\u5e8f\u7684\u8fd0\u884c\u8d70\u5411\uff0c\u6240\u4ee5\u719f\u7ec3\u638c\u63e1\u6d41\u7a0b\u63a7\u5236\u8bed\u53e5\u624d\u80fd\u66f4\u597d\u7684\u63a7\u5236\u6574\u4e2a\u811a\u672c\u7684\u8fd0\u884c\u7ed3\u679c\uff0c\u6765\u5b8c\u6210\u6211\u4eec\u7684\u9700\u6c42\u3002</p>"},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#2-shell-\u6d41\u7a0b\u63a7\u5236\u64cd\u4f5c","title":"2. Shell \u6d41\u7a0b\u63a7\u5236\u64cd\u4f5c","text":""},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#21-\u6761\u4ef6\u8bed\u53e5","title":"2.1 \u6761\u4ef6\u8bed\u53e5","text":"<p>\u987e\u540d\u601d\u4e49\uff0c\u5c31\u662f\u6ee1\u8db3\u7279\u5b9a\u6761\u4ef6\u6267\u884c\u5bf9\u5e94\u64cd\u4f5c\uff0c\u6309\u7167\u987a\u5e8f\u4ece\u4e0a\u5230\u4e0b\uff0c\u6761\u4ef6\u8bed\u53e5 if \u901a\u5e38\u9700\u8981\u4e0e test \u547d\u4ee4\u914d\u5408\u4f7f\u7528\uff0c\u5f53\u6ee1\u8db3\u6761\u4ef6\u5219\u6267\u884c <code>then</code> \u540e\u7684 command\uff0c\u5426\u5219\u7ee7\u7eed\u5f80\u4e0b\u8fd0\u884c\u6267\u884c\u5bf9\u5e94\u7684 command\uff0c\u6761\u4ef6\u8bed\u53e5 if \u662f Shell \u7f16\u7a0b\u4e2d\u6700\u57fa\u7840\u7684\u6761\u4ef6\u5224\u65ad\u6d41\u7a0b\u8bed\u53e5\u3002</p>"},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#211-\u5355\u5206\u652f-if-\u8bed\u53e5","title":"2.1.1 \u5355\u5206\u652f if \u8bed\u53e5","text":"<p>\u987e\u540d\u601d\u4e49\u5c31\u662f\u53ea\u6709\u4e00\u4e2a if \u8bed\u53e5\u5757\u5305\u542b\u7684\u8bed\u53e5\uff0ccondition \u4e3a\u6b63\u786e\u5219\u6267\u884c then \u5185\u7684\u547d\u4ee4\uff0c\u8bed\u6cd5\uff1a</p> <pre><code>if condition\nthen\ncommand1 command2\n    ...\n    commandN fi\n</code></pre> <p>\u5bf9\u4e8e sshd \u8fdb\u7a0b\u662f\u5426\u5b58\u5728\uff0c\u53ef\u4ee5\u4f7f\u7528\u5355\u5206\u652f if \u8bed\u53e5\u6765\u5224\u65ad\uff0c\u4f8b\u5982\uff1a</p> <pre><code>if [ $(ps -ef |grep /usr/sbin/sshd|grep -v grep|wc -l) -eq 1 ];then echo \"sshd server exist\"\nfi\n</code></pre>"},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#212-\u53cc\u5206\u652f-if-\u8bed\u53e5","title":"2.1.2 \u53cc\u5206\u652f if \u8bed\u53e5","text":"<p>\u591a\u5206\u652f if \u8bed\u53e5\u5b58\u5728 else \u60c5\u51b5\uff0c\u8bed\u6cd5\uff1a</p> <pre><code>if condition\nthen\ncommand1 command2\n    ...\n    commandN\nelse\ncommand\nfi\n</code></pre> <p>\u7edf\u4e00\u5224\u65ad sshd \u670d\u52a1\uff0c\u53ef\u4ee5\u5728 else \u4e2d\u8fdb\u884c\u4e00\u4e9b\u5217\u64cd\u4f5c\uff0c\u4f8b\u5982\uff1a</p> <pre><code>if [ $(ps -ef |grep /usr/sbin/sshd|grep -v grep|wc -l) -eq 1 ];then echo \"sshd server exist\"\nelse\nservice sshd start &amp;&amp; echo \"\u542f\u52a8sshd\u670d\u52a1\"\nfi\n</code></pre>"},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#213-\u591a\u5206\u949f-if-\u8bed\u53e5","title":"2.1.3 \u591a\u5206\u949f if \u8bed\u53e5","text":"<p>\u987e\u540d\u601d\u4e49\u6709\u591a\u4e2a if \u6761\u4ef6\uff0c\u5728\u6b64\u5229\u7528 elif \u6765\u8868\u793a\uff0c\u6ce8\u610f\u6700\u540e\u6709\u4e00\u4e2a else \u7ed3\u5c3e\u3002</p> <pre><code>if condition1;then\ncommand1\nelif condition2;then command2\n    ...\n...\nelif conditionN,then\n        commandN\nelse\ncommand\nfi\n</code></pre> <p>\u6211\u4eec\u7684 linux \u7cfb\u7edf\u6709\u591a\u4e2a\u7248\u672c\uff0c\u53ef\u4ee5\u5229\u7528\u591a\u5206\u652f if \u8bed\u53e5\u6765\u8fdb\u884c\u5224\u65ad\uff0c\u4f8b\u5982\uff1a</p> <pre><code>#! /bin/bash\nsys_version=$(rpm -q centos-release|cut -d- -f3)\nif [ $sys_version -eq 6 ];then\necho \"sysversion is $sys_version\"\nelif [ $sys_version -eq 7 ];then\necho \"sysversion is $sys_version\"\nelse\necho \"sysversion is ${sys_version}\"\nfi\n</code></pre>"},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#22-\u5faa\u73af\u8bed\u53e5","title":"2.2 \u5faa\u73af\u8bed\u53e5","text":"<p>\u5bf9\u4e8e\u4e00\u6279\u6570\u636e\uff0c\u6211\u4eec\u9700\u8981\u5bf9\u5176\u91cd\u590d\u8fdb\u884c\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u5c31\u9700\u8981\u5229\u7528\u5faa\u73af\u8bed\u53e5\u6765\u64cd\u4f5c\u3002</p>"},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#221-for-\u5faa\u73af","title":"2.2.1 for \u5faa\u73af","text":"<p>for \u5faa\u73af\u8bed\u53e5\u901a\u5e38\u5e94\u7528\u5728\u53ef\u9884\u4f30\u6570\u91cf\u7684\u4e00\u6279\u5bf9\u8c61\u64cd\u4f5c\u4e2d\uff0c\u9ed8\u8ba4 for \u5faa\u73af\u7684\u53d6\u503c\u5217\u8868\u662f\u4ee5 <code>$IFS</code> \u5206\u5272\uff0c\u9ed8\u8ba4 <code>$IFS</code> \u4e3a\u7a7a\u767d\u7b26\uff0c\u5982\u679c\u6211\u4eec\u6709\u5176\u4ed6\u9700\u6c42\u53ef\u4ee5\u66f4\u6539\uff0c\u8bed\u6cd5\u4e3a\uff1a</p> <pre><code>for var in item1 item2 ... itemN\ndo\ncommand1\n    command2\n    ...\n    commandN\ndone\n</code></pre> <p>\u901a\u8fc7 for \u5faa\u73af\u6bcf\u6b21\u904d\u5386\u4e00\u4e2a\u540e\u9762\u8ddf\u7684\u5bf9\u8c61\uff0c\u5728 <code>do\u2026done</code> \u64cd\u4f5c\u5757\u4e2d\u5bf9\u5bf9\u8c61\u8fdb\u884c\u4e00\u4e9b\u5217\u64cd\u4f5c\u3002</p> <p>\u4f8b\u5982\u6211\u4eec\u6765\u6c42\u548c 1-10 \u7684\u548c\uff1a</p> <pre><code>SUM=0\nfor num in $(seq 1 10)\ndo\nlet SUM=${SUM}+${num}\ndone\necho \"1-10\u7684\u548c\u4e3a\uff1a${SUM}\"\n</code></pre> <p>\u5f53\u7136\u5728 for \u5faa\u73af\u8bed\u53e5\u91cc\u9762\u4e5f\u53ef\u4ee5\u914d\u5408 if \u6761\u4ef6\u5224\u65ad\u6216\u5176\u4ed6\u6d41\u7a0b\u63a7\u5236\u8bed\u53e5\u8fdb\u884c\u64cd\u4f5c\u3002</p> <p>\u5728\u6b64\u6211\u4eec\u4e3e\u4f8b\u4fee\u6539 <code>$IFS</code> \u7684\u5e94\u7528\u573a\u666f\uff0c\u9996\u9009\u5907\u4efd\u9ed8\u8ba4\u5f53\u524d\u7684 <code>$IFS</code>\uff0c\u4e4b\u540e\u4e3a\u5176\u8d4b\u503c\u65b0\u7684 <code>$IFS</code> \u4e3a<code>:</code>\uff0c\u5728\u5bf9 /etc/passwd \u8fdb\u884c\u64cd\u4f5c\u5b8c\u6210\u540e\uff0c\u6062\u590d\u4e4b\u524d\u7684 <code>$IFS</code>, \u5728\u6b64\u6211\u4eec\u5c31\u5229\u7528\u6539\u53d8 <code>$IFS</code> \u5bf9 /etc/passwd \u7684\u5355\u4e2a\u5b57\u6bb5\u8fdb\u884c\u4e86\u53d8\u91cf\u64cd\u4f5c\u3002</p> <pre><code>#!/bin/bash\nOLD_IFS=$IFS\nIFS=\":\"\nfor i in $(head -1 /etc/passwd); do\necho $i\ndone\nIFS=${OLD_IFS}\n[root@xuel-terraform-cvm-0 ~]# bash 1.sh\nroot\nx\n0\n0\nroot\n/root\n/bin/bash\n[root@xuel-terraform-cvm-0 ~]# cat /etc/passwd |head -1\nroot:x:0:0:root:/root:/bin/bash\n</code></pre> <p>for \u5faa\u73af\u5982\u679c\u6761\u4ef6\u6c38\u8fdc\u6ee1\u8db3\u5219\uff0c\u4e00\u76f4\u6267\u884c\u5185\u90e8\u7684\u547d\u4ee4\u3002</p> <pre><code>for (( ; ; ))\n</code></pre>"},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#222-while-\u5faa\u73af","title":"2.2.2 while \u5faa\u73af","text":"<p>while \u5faa\u73af\u540c\u6837\u4e3a\u5faa\u73af\uff0c\u4e0e for \u5faa\u73af\u529f\u80fd\u4e00\u6837\uff0c\u5229\u7528 for \u5faa\u73af\u7684\u8bed\u53e5\u540c\u6837\u4e5f\u53ef\u4ee5\u4f7f\u7528 while \u5faa\u73af\u5b8c\u6210\uff0c\u4f46\u662f while \u5faa\u73af\u901a\u5e38\u7528\u4e8e\u5904\u7406\u672a\u77e5\u6570\u91cf\u5bf9\u8c61\u7684\u64cd\u4f5c\uff0c\u8bed\u6cd5\uff1a</p> <pre><code>while \u6761\u4ef6\u8868\u8fbe\u5f0f:do\n    command\ndone\n</code></pre> <p>while \u901a\u5e38\u4e0e test \u8bed\u53e5\u914d\u5408\u4f7f\u7528\uff0c\u5982\u679c\u6761\u4ef6\u8868\u8fbe\u5f0f\u6210\u7acb\uff0c\u5219\u4e00\u76f4\u6267\u884c\u3002</p> <p>\u4f8b\u5982\u6c42\u548c\u6253\u5370 1-5 \u4e2a\u6570\uff1a</p> <pre><code>#!/bin/bash\nN=0\nwhile [ $N -lt 5 ]; do\nlet N++\n  echo $N\ndone\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u5229\u7528 read \u8bfb\u5165\u6587\u4ef6\uff0c\u4f8b\u5982\u6211\u4eec\u6765\u8bfb\u5165\u4e00\u4e2a\u5199\u6709 ip \u6216\u57df\u540d\u5217\u8868\u7684\u6587\u4ef6\uff0c\u6765\u5224\u65ad\u8be5\u6587\u4ef6\u5185\u7684\u57df\u540d\u6216 IP \u7f51\u7edc\u662f\u5426\u53ef\u8fbe\u3002</p> <pre><code>#!/bin/bash\n#function:check url\nfilename=urllist.txt\nfor url in $(cat $filename)\ndo\nstatus=`curl -I --connect-timeout 5 $url -s|awk '/HTTP/{print $2}'`\nif [[ $status == \"200\" ]];then\necho \"Url:$url is ok!   status is $status\"\nelse\necho \"Url:$url is error! status is $status\"\nfi\ndone\n</code></pre> <p>\u7f16\u5199 <code>urllist.txt</code>\u3002</p> <pre><code>[root@xuel-terraform-cvm-0 ~]# cat urllist.txt\nbaidu.com\n114.114.114.114\n[root@xuel-terraform-cvm-0 ~]# bash urlcheck.sh\nUrl:baidu.com is ok!   status is 200\nUrl:114.114.114.114 is error! status is\n</code></pre> <p>\u5982\u679c while \u7684\u5224\u65ad\u6761\u4ef6\u4e3a\u6c38\u8fdc\u4e3a true\uff0c\u5219\u79f0\u4e3a\u65e0\u9650\u5faa\u73af\uff0c\u4f1a\u4e00\u76f4\u6267\u884c\u5185\u90e8\u7684\u64cd\u4f5c\uff0c\u4f8b\u5982\uff1a</p> <pre><code>while :\ndo\ncommand\ndone\n\u6216\u8005\nwhile true\ndo\ncommand\ndone\n</code></pre>"},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#223-until-\u5faa\u73af","title":"2.2.3 until \u5faa\u73af","text":"<p>until \u5faa\u73af\u4e0e while \u5faa\u73af\u521a\u597d\u76f8\u53cd\uff0c\u5176\u4e5f\u6709\u4e00\u5b9a\u7684\u5e94\u7528\u573a\u666f\uff0c\u5176\u4e3a\u6761\u4ef6\u8868\u8fbe\u5f0f\u4e3a true \u65f6\u505c\u6b62\uff0c\u5426\u5219\u4e00\u76f4\u8fd0\u884c\uff0c\u8bed\u6cd5\uff1a</p> <pre><code>until \u6761\u4ef6\u8868\u8fbe\u5f0f\ndo\ncommand\ndone\n</code></pre> <p>\u4f8b\u5982\u6211\u4eec\u4f7f\u7528 until \u6765\u6253\u5370 1-5 \u6570\u5b57\uff1a</p> <pre><code>NUM=0\nuntil [ ${NUM} -ge 5 ]\ndo let NUM++\n    echo $NUM\ndone\n</code></pre>"},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#224-break-\u4e0e-continue","title":"2.2.4 break \u4e0e continue","text":"<p>\u4e0e\u4e0a\u9762\u4e09\u4e2a\u5faa\u73af\u8bed\u53e5\u4e0d\u540c\u7684\u662f\uff0cbreak \u4e3a\u8df3\u51fa\u5faa\u73af\uff0ccontinue \u5219\u4e3a\u4e0d\u6267\u884c\u4e0b\u4e00\u6b21\u64cd\u4f5c\uff0c\u76f4\u63a5\u8df3\u5230\u4e0b\u4e00\u6b21\u5faa\u73af\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u6765\u5229\u7528 break \u6765\u8df3\u51fa\u7ec8\u6b62\u5faa\u73af\u3002</p> <ul> <li>break</li> </ul> <pre><code>#!/bin/bash\nN=0\nwhile true; do\nlet N++\n    if [ $N -eq 5 ]; then\nbreak\nfi\necho $N\ndone\n</code></pre> <ul> <li>continue</li> </ul> <pre><code>#!/bin/bash\nN=0\nwhile [ $N -lt 5 ]; do\nlet N++\n    if [ $N -eq 3 ]; then\ncontinue\nfi\necho $N\ndone\n</code></pre> <p>\u5229\u7528 continue \u6765\u8df3\u8fc7\u7279\u5b9a\u7684\u6761\u4ef6\u64cd\u4f5c\u3002</p>"},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#23-\u9009\u62e9\u8bed\u53e5","title":"2.3 \u9009\u62e9\u8bed\u53e5","text":""},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#231-case-\u8bed\u53e5","title":"2.3.1 case \u8bed\u53e5","text":"<p>\u9009\u62e9\u8bed\u53e5 case \u53ef\u4ee5\u5728\u7279\u5b9a\u7684\u51e0\u4e2a\u6761\u4ef6\u4e2d\u9009\u62e9\u67d0\u4e00\u4e2a\u8fdb\u884c\u6267\u884c\uff0c\u5176\u4ed6 case \u53ef\u4ee5\u5229\u7528 if \u591a\u5206\u652f\u6765\u66ff\u4ee3\u3002</p> <pre><code>case \u6a21\u5f0f\u540d    in\n\u6a21\u5f0f 1)\n\u547d\u4ee4\n        ;;\n\u6a21\u5f0f 2)\n\u547d\u4ee4\n        ;;\n*)\n\u4e0d\u7b26\u5408\u4ee5\u4e0a\u6a21\u5f0f\u6267\u884c\u7684\u547d\u4ee4\nesac\n</code></pre> <p>\u4f8b\u5982\u6211\u4eec\u670d\u52a1\u7684\u542f\u52a8\u64cd\u4f5c\u811a\u672c\u5c31\u662f\u5229\u7528 case \u8bed\u53e5\u6765\uff0c\u5f53\u7528\u6237\u7684\u8f93\u5165\u4e0e\u6a21\u5f0f\u540d\u76f8\u5339\u914d\u5219\u6267\u884c\u5bf9\u5e94\u7684\u547d\u4ee4\u3002</p> <pre><code>#!/bin/bash\ncase $1 in\nstart)\necho \"start.\"   ;;\nstop)\necho \"stop.\"\n;;\nrestart)\necho \"restart.\"\n;;\n*)\necho \"Usage: $0 {start|stop|restart}\"\nesac\n</code></pre>"},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#3-\u5b9e\u4f8b","title":"3. \u5b9e\u4f8b","text":""},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#31-\u9700\u6c42","title":"3.1 \u9700\u6c42","text":"<p>\u7f16\u5199\u4e00\u4e2a\u811a\u672c\uff0c\u6765\u5bf9\u5f53\u524d\u7cfb\u7edf <code>PATH</code> \u76ee\u5f55\u4e0b\u7684\u4e8c\u8fdb\u5236\u6267\u884c\u6587\u4ef6\u8fdb\u884c\uff0c\u6216\u8005\u5bf9\u6307\u5b9a\u5168\u76d8\u8fdb\u884c md5 \u626b\u63cf\uff0c\u540e\u671f\u53ef\u4ee5\u914d\u5408\u5b9a\u65f6\u4efb\u52a1\u6765\u76d1\u63a7\u6587\u4ef6\u662f\u5426\u53d8\u5316\uff0c\u7528\u4e8e\u6587\u4ef6\u6743\u9650\u53ca\u5185\u5bb9\u7684\u7ba1\u63a7\u3002</p>"},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#32-\u601d\u8def","title":"3.2 \u601d\u8def","text":"<p>\u6587\u4ef6\u626b\u63cf\u53ef\u4ee5\u4f7f\u7528 md5sum \u5de5\u5177\u6267\u884c\uff0c\u5bf9\u76ee\u5f55\u904d\u5386\u9700\u8981\u4f7f\u7528 for \u5faa\u73af\uff0c\u73b0\u5728\u6267\u884c\u65b9\u5f0f\u53ef\u4ee5\u4f7f\u7528 case \u6765\u64cd\u4f5c\uff0c\u5176\u4e2d\u4e00\u4e9b\u64cd\u4f5c\u4f1a\u6d89\u53ca\u5230 sed \u7684\u547d\u4ee4\uff0c\u540e\u671f\u6211\u4eec\u4f1a\u9488\u5bf9\u8fd9\u4e9b\u547d\u4ee4\u8fdb\u884c\u5355\u72ec\u7ae0\u8282\u8be6\u7ec6\u8bb2\u89e3\uff0c\u5728\u672c\u9700\u6c42\u6848\u4f8b\u4e2d\u7740\u91cd\u601d\u8003 Shell \u4e2d\u6d41\u7a0b\u63a7\u5236\u7684\u4f5c\u7528\u3002</p>"},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#33-\u5b9e\u73b0","title":"3.3 \u5b9e\u73b0","text":"<ul> <li>\u5177\u4f53\u5b9e\u73b0 shell \u811a\u672c</li> </ul> <pre><code>#!/bin/bash\n# Description: count file scripts\n# Auth: kaliarch\n# Email: kaliarch@163.com\n# function: count file\n# Date: 2020-03-28 14:00\n# Version: 1.0\n# \u5b9a\u4e49\u6587\u4ef6\u626b\u63cf\u76ee\u5f55\nSCAN_DIR=`echo $PATH |sed 's/:/ /g'`\nSCAN_CMD=`which md5sum`\nSCAN_FILE_FAIL=\"/tmp/scan_$(date +%F%H%m)_fall.txt\"\nSCAN_FILE_BIN=\"/tmp/scan_$(date +%F%H%m)_bin.txt\"\nscan_fall_disk() {\necho \"\u6b63\u5728\u5168\u76d8\u626b\u63cf\uff0c\u8bf7\u7a0d\u7b49\uff01\u6587\u4ef6\u8def\u5f84:$SCAN_FILE_FALL\"\nfind / -type f ! -path \"/proc/*\" -exec $SCAN_CMD \\{\\} \\;&gt;&gt; $SCAN_FILE_FAIL 2&gt;/dev/null\n    echo \"\u626b\u63cf\u5b8c\u6210,\u53ef\u5229\u7528\u4ee5\u4e0b\u547d\u4ee4\u540e\u671f\u5bf9\u6587\u4ef6\u8fdb\u884c\u6821\u9a8c\"\necho \"$SCAN_CMD -c $SCAN_FILE_FAIL |grep -v 'OK$'\"\n}\nscan_bin() {\necho \"\u6b63\u5728\u626b\u63cf$PATH\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u8bf7\u7a0d\u7b49\uff0c\u6587\u4ef6\u8def\u5f84\uff1a$SCAN_FILE_BIN\"\nfor file in $SCAN_DIR\ndo\nfind $file -type f -exec $SCAN_CMD \\{\\} \\;&gt;&gt; $SCAN_FILE_BIN 2&gt;/dev/null\n    done\necho \"\u626b\u63cf\u5b8c\u6210,\u53ef\u5229\u7528\u4ee5\u4e0b\u547d\u4ee4\u540e\u671f\u5bf9\u6587\u4ef6\u8fdb\u884c\u6821\u9a8c\"\necho \"$SCAN_CMD -c $SCAN_FILE_BIN |grep -v 'OK$'\"\n}\nclear\necho \"##########################################\"\necho \"#                                        #\"\necho \"#        \u5229\u7528md5sum\u5bf9\u6587\u4ef6\u8fdb\u884c\u6821\u9a8c        #\"\necho \"#                                        #\"\necho \"##########################################\"\necho \"1: \u5168\u76d8\u626b\u63cf\"\necho \"2: bin path\u626b\u63cf\"\necho \"3: EXIT\"\n# \u9009\u62e9\u626b\u63cf\u65b9\u5f0f\nread -p \"Please input your choice:\" method\ncase $method in 1)\nscan_fall_disk;;\n2)\nscan_bin;;\n3)\necho \"you choce channel!\" &amp;&amp; exit 1;;\n*)\necho \"input Error! Place input{1|2|3}\" &amp;&amp; exit 0;;\nesac\n</code></pre> <ul> <li>\u6d4b\u8bd5</li> </ul> <pre><code>[root@xuel-terraform-cvm-0 ~]# bash file_scan.sh\n##########################################\n#                                        #\n#        \u5229\u7528md5sum\u5bf9\u6587\u4ef6\u8fdb\u884c\u6821\u9a8c        #\n#                                        #\n##########################################\n1: \u5168\u76d8\u626b\u63cf\n2: bin path\u626b\u63cf\n3: EXIT\nPlease input your choice:2\n\u6b63\u5728\u626b\u63cf/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u8bf7\u7a0d\u7b49\uff0c\u6587\u4ef6\u8def\u5f84\uff1a/tmp/scan_2020-03-271703_bin.txt\n\u626b\u63cf\u5b8c\u6210,\u53ef\u5229\u7528\u4ee5\u4e0b\u547d\u4ee4\u540e\u671f\u5bf9\u6587\u4ef6\u8fdb\u884c\u6821\u9a8c\n/usr/bin/md5sum -c /tmp/scan_2020-03-271703_bin.txt |grep -v 'OK$'\n[root@xuel-terraform-cvm-0 ~]# /usr/bin/md5sum -c /tmp/scan_2020-03-271703_bin.txt |grep -v 'OK$'\n/sbin/mii-tool: \u786e\u5b9a\n/sbin/wipefs: \u786e\u5b9a\n/sbin/blkdiscard: \u786e\u5b9a\n/sbin/rtmon: \u786e\u5b9a\n/sbin/shutdown: \u786e\u5b9a\n/sbin/aureport: \u786e\u5b9a\n/sbin/plymouthd: \u786e\u5b9a\n/sbin/udevd: \u786e\u5b9a\n/sbin/lvmetad: \u786e\u5b9a\n/sbin/e2undo: \u786e\u5b9a\n...\n</code></pre> <p>\u5f53\u6211\u4eec\u8f93\u5165\u6570\u5b57 2 \u7684\u65f6\u5019\u5373\u5bf9 bin \u8def\u5f84\u6267\u884c\u626b\u63cf\uff0c\u626b\u63cf\u5b8c\u6210\u540e\u4f1a\u751f\u6210\u5bf9\u5e94\u7684\u626b\u63cf\u6587\u4ef6\uff0c\u53ef\u4ee5\u6267\u884c <code>/usr/bin/md5sum -c /tmp/scan_2020-03-271703_bin.txt |grep -v 'OK$'</code> \u6765\u8fdb\u884c\u540e\u671f\u6587\u4ef6\u6821\u9a8c\u3002</p> <pre><code>[root@xuel-terraform-cvm-0 ~]# bash file_scan.sh\n##########################################\n#                                        #\n#        \u5229\u7528md5sum\u5bf9\u6587\u4ef6\u8fdb\u884c\u6821\u9a8c           #\n#                                        #\n##########################################\n1: \u5168\u76d8\u626b\u63cf\n2: bin path\u626b\u63cf\n3: EXIT\nPlease input your choice:3\nyou choce channel!\n</code></pre> <p>\u5f53\u8f93\u5165 3 \u7a0b\u5e8f\u9000\u51fa\uff0c\u5728\u6b64\u5c31\u662f\u4f7f\u7528 case \u6765\u5b8c\u6210\u3002</p> <pre><code>[root@xuel-terraform-cvm-0 ~]# bash file_scan.sh\n##########################################\n#                                        #\n#        \u5229\u7528md5sum\u5bf9\u6587\u4ef6\u8fdb\u884c\u6821\u9a8c             #\n#                                        #\n##########################################\n1: \u5168\u76d8\u626b\u63cf\n2: bin path\u626b\u63cf\n3: EXIT\nPlease input your choice:1\n\u6b63\u5728\u5168\u76d8\u626b\u63cf\uff0c\u8bf7\u7a0d\u7b49\uff01\u6587\u4ef6\u8def\u5f84:\n\u626b\u63cf\u5b8c\u6210,\u53ef\u5229\u7528\u4ee5\u4e0b\u547d\u4ee4\u540e\u671f\u5bf9\u6587\u4ef6\u8fdb\u884c\u6821\u9a8c\n/usr/bin/md5sum -c /tmp/scan_2020-03-271703_fall.txt |grep -v 'OK$'\n[root@xuel-terraform-cvm-0 ~]# /usr/bin/md5sum -c /tmp/scan_2020-03-271703_fall.txt |grep -v 'OK$' |more\n/sys/devices/platform/uevent: \u786e\u5b9a\n/sys/devices/platform/power/control: \u786e\u5b9a\n/sys/devices/platform/power/wakeup: \u786e\u5b9a\n/sys/devices/platform/pcspkr/uevent: \u786e\u5b9a\n/sys/devices/platform/pcspkr/modalias: \u786e\u5b9a\n/sys/devices/platform/pcspkr/power/control: \u786e\u5b9a\n/sys/devices/platform/pcspkr/power/wakeup: \u786e\u5b9a\n/sys/devices/platform/platform-framebuffer.0/uevent: \u786e\u5b9a\n/sys/devices/platform/platform-framebuffer.0/modalias: \u786e\u5b9a\n/sys/devices/platform/platform-framebuffer.0/power/control: \u786e\u5b9a\n/sys/devices/platform/platform-framebuffer.0/power/wakeup: \u786e\u5b9a\n/sys/devices/platform/serial8250/uevent: \u786e\u5b9a\n/sys/devices/platform/serial8250/modalias: \u786e\u5b9a\n/sys/devices/platform/serial8250/power/control: \u786e\u5b9a\n/sys/devices/platform/serial8250/power/wakeup: \u786e\u5b9a\n/sys/devices/platform/serial8250/tty/ttyS1/uevent: \u786e\u5b9a\n/sys/devices/platform/serial8250/tty/ttyS1/dev: \u786e\u5b9a\n/sys/devices/platform/serial8250/tty/ttyS1/power/cont\n</code></pre>"},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#4-\u6ce8\u610f\u4e8b\u9879","title":"4. \u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u5bf9\u4e8e\u6761\u4ef6\u8bed\u53e5\u4e2d\u7684\u591a\u5206\u652f if \u8bed\u53e5\uff0c\u7ed3\u5c3e\u80af\u5b9a\u662f\u6709\u4e00\u4e2a else \u6765\u5b8c\u6210\uff0c\u9700\u8981\u6ce8\u610f\u6b64\u70b9\uff1b</li> <li>\u5728\u7f16\u5199\u6d41\u7a0b\u63a7\u5236\u65f6\u5019\uff0c\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u4e60\u60ef\u5bf9\u4e8e <code>command</code> \u4e2d\u7684\u64cd\u4f5c\u8fdb\u884c\u7f29\u8fdb\uff0c\u53ef\u4ee5\u4e3a\u51e0\u4e2a\u7a7a\u683c\uff0c\u4e5f\u53ef\u4ee5\u4e3a\u4e00\u4e2a tab \u952e\uff0c\u5efa\u8bae\u4f7f\u7528\u4e00\u4e2a\u5236\u8868\u7b26\uff1b</li> <li>\u6d41\u7a0b\u63a7\u5236\u8bed\u53e5\u53ef\u4ee5\u76f8\u4e92\u5d4c\u5957\uff0c\u4f8b\u5982 for \u5faa\u73af\u4e2d\u53ef\u4ee5\u6709 if \u6761\u4ef6\u5224\u65ad\uff0cif \u6dfb\u52a0\u5224\u65ad\u4e2d\u4e5f\u53ef\u4ee5\u6dfb\u52a0 for \u5faa\u73af\u7b49\uff0c\u6839\u636e\u9700\u6c42\u5177\u4f53\u7075\u6d3b\u8fd0\u7528\uff1b</li> <li>case \u8bed\u53e5\u4e0e if \u591a\u5206\u652f\u8bed\u53e5\u4e00\u6837\uff0c\u4e0d\u540c\u70b9\u5728\u4e0e case \u8bed\u53e5\u53ea\u80fd\u5224\u65ad\u4e00\u79cd\u6761\u4ef6\u5173\u7cfb\uff0c\u800c if \u591a\u5206\u652f\u53ef\u4ee5\u5bf9\u591a\u79cd\u6761\u4ef6\u8fdb\u884c\u5224\u65ad\u3002</li> </ul>"},{"location":"Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/#5-\u5c0f\u7ed3","title":"5. \u5c0f\u7ed3","text":"<p>\u6d41\u7a0b\u63a7\u5236\u8bed\u53e5\u662f\u6211\u4eec Shell \u7f16\u5199\u7684\u7ecf\u7edc\uff0c\u5229\u7528\u5b83\u6765\u63a7\u5236\u7a0b\u5e8f\u7684\u8d70\u5411\uff0c\u9700\u8981\u6211\u4eec\u80fd\u719f\u7ec3\u638c\u63e1\u6700\u5e38\u7528\u7684\u6d41\u7a0b\u63a7\u5236\u8bed\u53e5\uff0c\u5e76\u77e5\u9053\u5176\u5bf9\u5e94\u7684\u9002\u5e94\u573a\u666f\uff0c\u7075\u6d3b\u914d\u5408\u4f7f\u7528\u3002</p>"},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/","title":"8.Shell \u51fd\u6570","text":""},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#1-shell-\u51fd\u6570\u6982\u8ff0","title":"1. Shell \u51fd\u6570\u6982\u8ff0","text":""},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#11-shell-\u51fd\u6570\u7b80\u4ecb","title":"1.1 Shell \u51fd\u6570\u7b80\u4ecb","text":"<p>Shell \u548c\u5176\u4ed6\u8bed\u8a00\u4e00\u6837\uff0c\u4e5f\u6709\u51fd\u6570\uff0c\u5176\u672c\u8d28\u5c31\u662f\u4e00\u6bb5\u53ef\u4ee5\u590d\u7528\u7684\u4ee3\u7801\u3002\u5c06\u6570\u636e\u8fdb\u884c\u62bd\u79bb\u5904\u7406\uff0c\u4f20\u9012\u4e0d\u540c\u7684\u503c\u8f93\u51fa\u4e0d\u540c\u7684\u7ed3\u679c\uff0c\u5728\u6307\u5b9a\u7684\u5730\u65b9\u8fdb\u884c\u8c03\u7528\u5373\u53ef\u3002</p>"},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#12-\u4e3a\u4ec0\u4e48\u8981\u7528\u51fd\u6570","title":"1.2 \u4e3a\u4ec0\u4e48\u8981\u7528\u51fd\u6570","text":"<p>\u5982\u679c\u6211\u4eec\u8981\u91cd\u590d\u6267\u884c\u4e00\u6279\u76f8\u540c\u7684\u64cd\u4f5c\uff0c\u4e0d\u60f3\u91cd\u590d\u53bb\u5199\uff0c\u53ef\u4ee5\u5c06\u8fd9\u4e00\u7cfb\u5217\u64cd\u4f5c\u62bd\u8c61\u4e3a\u4e00\u4e2a\u51fd\u6570\uff0c\u540e\u671f\u53ef\u4ee5\u5229\u7528\u53d8\u91cf\u4f20\u503c\u8c03\u8be5\u51fd\u6570\uff0c\u4ece\u800c\u5927\u5927\u51cf\u5c11\u91cd\u590d\u6027\u52b3\u52a8\uff0c\u63d0\u5347\u6548\u7387\u51cf\u5c11\u4ee3\u7801\u91cf\uff0c\u4f7f\u5f97 Shell \u811a\u672c\u66f4\u52a0\u7684\u7075\u6d3b\u548c\u901a\u7528\u3002</p>"},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#2-shell-\u51fd\u6570\u64cd\u4f5c","title":"2. Shell \u51fd\u6570\u64cd\u4f5c","text":""},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#21-\u51fd\u6570\u8bed\u6cd5","title":"2.1 \u51fd\u6570\u8bed\u6cd5","text":""},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#211-\u6807\u51c6\u8bed\u6cd5","title":"2.1.1 \u6807\u51c6\u8bed\u6cd5","text":"<pre><code>function fnname() { statements\n    return value\n}\n</code></pre> <p>\u5bf9\u5404\u4e2a\u90e8\u5206\u7684\u8bf4\u660e\uff1a</p> <ul> <li><code>function</code> \u662f Shell \u4e2d\u7684\u5173\u952e\u5b57\uff0c\u4e13\u95e8\u7528\u6765\u5b9a\u4e49\u51fd\u6570\uff1b</li> <li><code>fname</code> \u662f\u51fd\u6570\u540d\uff1b</li> <li><code>statements</code> \u662f\u51fd\u6570\u8981\u6267\u884c\u7684\u4ee3\u7801\uff0c\u4e5f\u5c31\u662f\u4e00\u7ec4\u8bed\u53e5\uff1b</li> <li><code>return value</code> \u8868\u793a\u51fd\u6570\u7684\u8fd4\u56de\u503c\uff0c\u5176\u4e2d return \u662f Shell \u5173\u952e\u5b57\uff0c\u4e13\u95e8\u7528\u5728\u51fd\u6570\u4e2d\u8fd4\u56de\u4e00\u4e2a\u503c\uff0c\u8fd9\u4e00\u90e8\u5206\u53ef\u4ee5\u5199\u4e5f\u53ef\u4ee5\u4e0d\u5199\u3002</li> </ul> <p>\u7531\u5927\u62ec\u53f7\u5305\u56f4\u7684\u90e8\u5206\u79f0\u4e3a\u51fd\u6570\u4f53\uff0c\u8c03\u7528\u4e00\u4e2a\u51fd\u6570\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u6267\u884c\u51fd\u6570\u4f53\u4e2d\u7684\u4ee3\u7801\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>function checkuser() { echo \"\u5f53\u524d\u7528\u6237\u4e3a:$USER\"\nreturn 0\n}\n</code></pre> <p>\u5982\u4e0a\u5c31\u5b9a\u4e49\u4e86\u4e00\u4e2a <code>checkuser</code> \u51fd\u6570\uff0c\u5176\u8f93\u51fa\u5f53\u524d\u767b\u5f55\u7cfb\u7edf\u7684\u7528\u6237\u540d\uff0c\u8fd4\u56de\u503c\u4e3a 0\u3002</p>"},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#212-\u7b80\u5316\u8bed\u6cd5","title":"2.1.2 \u7b80\u5316\u8bed\u6cd5","text":"<ul> <li>\u51fd\u6570\u540d\u540e\u65e0\u62ec\u53f7</li> </ul> <pre><code>#\u7b80\u5316\u5199\u6cd51\nfunction fname{ statements\n    return n\n}\n</code></pre> <ul> <li>\u51fd\u6570\u4e0d\u5199 function</li> </ul> <pre><code>#\u7b80\u5316\u5199\u6cd52\uff1a\nfname() {\nstatements\n    return n\n}\n</code></pre> <p>\u4e0a\u8ff0\u4e24\u79cd\u5b9a\u4e49\u51fd\u6570\u7684\u65b9\u6cd5\u90fd\u53ef\u4ee5\uff0c\u4f46\u662f\u8fd8\u662f\u5efa\u8bae\u5728\u7f16\u5199 Shell \u7684\u65f6\u5019\uff0c\u4e5f\u4e0d\u5dee\u6d6a\u8d39\u8fd9\u70b9\u65f6\u95f4\uff0c\u5efa\u8bae\u5927\u5bb6\u90fd\u7528\u5b8c\u6574\u51fd\u6570\u5b9a\u4e49\uff0c\u5199 function \u5173\u952e\u5b57\uff0c\u5728\u4e3a\u51fd\u6570\u5b9a\u4e49\u5e26\u4e0a ()\uff0c\u8fd9\u6837\u66f4\u52a0\u89c4\u8303\uff0c\u800c\u4e14\u4fbf\u4e8e\u522b\u4eba\u9605\u8bfb\u4fee\u6539\u4f60\u7684\u811a\u672c\u3002</p> <p>Tips\uff1a\u5728\u51fd\u6570\u5b9a\u4e49\u4e2d\u9700\u8981\u51fd\u6570\u540d\u79f0\u540e\u53ef\u4ee5\u6709\u591a\u4e2a\u7a7a\u683c\uff0c\u62ec\u53f7\u5185\u4e5f\u53ef\u4ee5\u6709\u591a\u4e2a\u7a7a\u683c\uff0c\u5982\u679c\u51fd\u6570\u4f53\u5199\u5728\u4e00\u884c\uff0c\u9700\u8981\u5728\u8bed\u53e5\u672b\u5c3e\u52a0\u4e0a <code>;</code>\u3002</p>"},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#22-\u51fd\u6570\u8c03\u7528","title":"2.2 \u51fd\u6570\u8c03\u7528","text":"<p>\u5f53\u51fd\u6570\u5b9a\u4e49\u597d\u4e86\uff0c\u5728\u9700\u8981\u4f7f\u7528\u51fd\u6570\u7684\u5730\u65b9\uff0c\u8c03\u7528\u5176\u51fd\u6570\u540d\u79f0\u5373\u53ef\uff0c\u6ce8\u610f\u51fd\u6570\u8c03\u7528\u9700\u8981\u5728\u51fd\u6570\u5b9a\u4e49\u4e4b\u540e\u3002</p>"},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#221-\u65e0\u53c2\u6570\u8c03\u7528","title":"2.2.1 \u65e0\u53c2\u6570\u8c03\u7528","text":"<p>\u5f53\u51fd\u6570\u6ca1\u6709\u53c2\u6570\u7684\u65f6\u5019\uff0c\u8c03\u7528\u975e\u5e38\u7b80\u5355\uff0c\u76f4\u63a5\u5199\u51fd\u6570\u540d\u79f0\u5373\u53ef\uff0c\u8c03\u7528\u51fd\u6570\u5c31\u662f\u5728\u7279\u5b9a\u5730\u65b9\u6267\u884c\u51fd\u6570\u4f53\u5185\u7684\u64cd\u4f5c\u3002</p> <pre><code>// \u5b9a\u4e49\u51fd\u6570\nfunction fnname() { statements\n    return value\n}\n// \u8c03\u7528\u51fd\u6570\nfname\n</code></pre>"},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#222-\u4f20\u9012\u53c2\u6570\u8c03\u7528","title":"2.2.2 \u4f20\u9012\u53c2\u6570\u8c03\u7528","text":"<ul> <li>\u8bed\u6cd5</li> </ul> <p>\u6211\u4eec\u4e4b\u524d\u5728\u53d8\u91cf\u4e00\u7ae0\u8282\u4ecb\u7ecd\u4e86 Shell \u811a\u672c\u7684\u53c2\u6570\uff0c\u77e5\u9053\u4e86\u53c2\u6570\u7684\u91cd\u8981\u6027\u8d28\u53ca\u5176\u5404\u79cd\u7c7b\u7279\u5f81\uff0c\u4e0e Shell \u811a\u672c\u4f20\u9012\u53c2\u6570\u4e00\u6837\uff0c\u51fd\u6570\u4e5f\u53ef\u4ee5\u4f20\u9012\u53c2\u6570\uff0c\u4f8b\u5982\uff1a</p> <pre><code>// \u5b9a\u4e49\u51fd\u6570\nfunction fnname() { statements\n    return value\n}\n// \u8c03\u7528\u51fd\u6570\nfname param1 param2 param3\n</code></pre> <p>\u5982\u4e0a\u6240\u793a\uff0c\u5728\u8c03\u7528\u51fd\u6570 <code>fname</code> \u7684\u65f6\u5019\uff0c\u6211\u4eec\u4f20\u9012\u4e86\u4e09\u4e2a\u53c2\u6570\uff0c\u53c2\u6570\u4e4b\u95f4\u5229\u7528\u7a7a\u683c\u5206\u5272\uff0c\u548c Shell \u811a\u672c\u4f20\u9012\u53c2\u6570\u4e00\u6837\uff0c\u4f46\u9700\u8981\u6ce8\u610f Shell \u811a\u672c\u4e2d\uff0c\u51fd\u6570\u5728\u5b9a\u4e49\u65f6\u5019\u4e0d\u80fd\u6307\u5b9a\u53c2\u6570\uff0c\u5728\u8c03\u7528\u7684\u65f6\u5019\u4f20\u9012\u53c2\u6570\u5373\u53ef\uff0c\u5e76\u4e14\u5728\u8c03\u7528\u51fd\u6570\u65f6\u4f20\u9012\u4ec0\u4e48\u53c2\u6570\u51fd\u6570\u5c31\u63a5\u53d7\u4ec0\u4e48\u53c2\u6570\u3002</p>"},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#23-\u51fd\u6570\u53c2\u6570","title":"2.3 \u51fd\u6570\u53c2\u6570","text":"<p>\u4e0a\u8ff0\u6211\u4eec\u4e86\u89e3\u4e86\u51fd\u6570\u7684\u5b9a\u4e49\uff0c\u5728\u5176\u4e2d\u65e0\u53c2\u51fd\u6570\u8c03\u7528\u5373\u8c03\u7528\u51fd\u6570\u540d\u5373\u53ef\uff0c\u5bf9\u4e8e\u6709\u53c2\u51fd\u6570\uff0c\u9700\u8981\u4f20\u9012\u4e00\u5b9a\u7684\u53c2\u6570\u6765\u6267\u884c\u5bf9\u5e94\u7684\u64cd\u4f5c\uff0c\u51fd\u6570\u7684\u53c2\u6570\u548c\u811a\u672c\u7684\u53c2\u6570\u7c7b\u578b\u53ca\u7528\u6cd5\u4e00\u81f4\uff0c\u5728\u6b64\u6211\u4eec\u7b80\u5355\u56de\u987e\u4e0b\uff0c\u770b\u53c2\u6570\u5728\u51fd\u6570\u4e2d\u90fd\u6709\u54ea\u4e9b\u5206\u7c7b\uff0c\u53ca\u8be5\u5982\u4f55\u4f7f\u7528\u3002</p>"},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#231-\u4f4d\u7f6e\u53c2\u6570","title":"2.3.1 \u4f4d\u7f6e\u53c2\u6570","text":"<p>\u4f4d\u7f6e\u53c2\u6570\u987e\u540d\u601d\u4e49\uff0c\u5c31\u662f\u4f20\u9012\u7ed9\u51fd\u6570\u53c2\u6570\u7684\u4f4d\u7f6e\uff0c\u4f8b\u5982\u7ed9\u4e00\u4e2a\u51fd\u6570\u4f20\u9012\u4e00\u4e2a\u53c2\u6570\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u6267\u884c Shell \u811a\u672c\u83b7\u53d6\u5bf9\u5e94\u4f4d\u7f6e\u7684\u53c2\u6570\uff0c\u83b7\u53d6\u53c2\u6570\u7684\u683c\u5f0f\u4e3a\uff1a$n\u3002n \u4ee3\u8868\u4e00\u4e2a\u6570\u5b57\uff0c\u5728\u6b64\u9700\u8981\u6ce8\u610f\u4e0e\u811a\u672c\u4f20\u9012\u53c2\u6570\u4e0d\u4e00\u6837\uff0c<code>$0</code> \u4e3a\u4f9d\u65e7\u4e3a\u811a\u672c\u7684\u540d\u79f0\uff0c\u5728\u51fd\u6570\u53c2\u6570\u4f20\u9012\u4e2d\uff0c\u4f8b\u5982\u4f20\u9012\u7ed9\u51fd\u6570\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u83b7\u53d6\u5c31\u4e3a <code>$1</code>\uff0c\u7b2c 2 \u4e2a\u53c2\u6570\u5c31\u4e3a <code>$2</code>, \u4ee5\u6b64\u7c7b\u63a8\u2026\u2026\uff0c\u9700\u8981\u5176 <code>$0</code> \u4e3a\u8be5\u51fd\u6570\u7684\u540d\u79f0\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>[root@master func]# cat f1.sh #!/bin/bash\nfunction f1() {\necho \"\u51fd\u6570\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a: ${1}\"\necho \"\u51fd\u6570\u7684\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a: ${2}\"\necho \"\u51fd\u6570\u7684\u7b2c\u4e09\u4e2a\u53c2\u6570\u4e3a: ${3}\"\n}\n# \u8c03\u7528\u51fd\u6570\nf1 shell linux python go\n[root@master func]# bash f1.sh \u51fd\u6570\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a: shell\n\u51fd\u6570\u7684\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a: linux\n\u51fd\u6570\u7684\u7b2c\u4e09\u4e2a\u53c2\u6570\u4e3a: python\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4f20\u9012\u7ed9 <code>f1</code> \u51fd\u6570\u5171 4 \u4e2a\u4f4d\u7f6e\u53c2\u6570\uff0c\u5728\u7ed3\u679c\u8f93\u51fa\u4e2d\u53ef\u4ee5\u770b\u5230\u7531\u4e8e\u51fd\u6570\u4f53\u5185\u90e8\u53ea\u5bf9\u4e09\u4e2a\u53c2\u6570\u8fdb\u884c\u4e86\u5904\u7406\uff0c\u540e\u7eed\u7684\u53c2\u6570\u4e5f\u5c31\u4e0d\u518d\u5904\u7406\u4e86\u3002</p>"},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#232-\u7279\u6b8a\u53c2\u6570","title":"2.3.2 \u7279\u6b8a\u53c2\u6570","text":"<p>\u5728 Shell \u4e2d\u4e5f\u5b58\u5728\u7279\u6b8a\u542b\u4e49\u7684\u53c2\u6570\u5982\u4e0b\u8868\uff1a</p> \u53d8\u91cf \u542b\u4e49 $# \u4f20\u9012\u7ed9\u51fd\u6570\u7684\u53c2\u6570\u4e2a\u6570\u603b\u548c $* \u4f20\u9012\u7ed9\u811a\u672c\u6216\u51fd\u6570\u7684\u6240\u6709\u53c2\u6570\uff0c\u5f53\u88ab\u53cc\u5f15\u53f7 <code>\" \"</code> \u5305\u542b\u65f6\uff0c\u6240\u6709\u7684\u4f4d\u7f6e\u53c2\u6570\u88ab\u770b\u505a\u4e00\u4e2a\u5b57\u7b26\u4e32 $@ \u4f20\u9012\u7ed9\u811a\u672c\u6216\u51fd\u6570\u7684\u6240\u6709\u53c2\u6570\uff0c\u5f53\u88ab\u53cc\u5f15\u53f7 <code>\" \"</code> \u5305\u542b\u65f6\uff0c\u6bcf\u4e2a\u4f4d\u7f6e\u53c2\u6570\u88ab\u770b\u505a\u72ec\u7acb\u7684\u5b57\u7b26\u4e32 $? <code>$?</code> \u8868\u793a\u51fd\u6570\u7684\u9000\u51fa\u72b6\u6001\uff0c\u8fd4\u56de\u4e3a 0 \u4e3a\u6267\u884c\u6210\u529f\uff0c\u975e 0 \u5219\u4e3a\u6267\u884c\u5931\u8d25 <p>\u793a\u4f8b\uff1a</p> <pre><code>[root@master func]# cat f1.sh #!/bin/bash\nfunction fsum() {\necho \"\u51fd\u6570\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a: ${1}\"\necho \"\u51fd\u6570\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a: ${2}\"\necho \"\u51fd\u6570\u7b2c\u4e09\u4e2a\u53c2\u6570\u4e3a: ${3}\"\necho \"\u51fd\u6570\u7684\u53c2\u6570\u603b\u6570\u4e3a: ${#}\"\necho \"\u51fd\u6570\u7684\u53c2\u6570\u603b\u6570\u4e3a: ${@}\"\nlocal sum=0\nfor num in ${@};\ndo\nlet sum=${sum}+${num}\ndone\necho \"\u8ba1\u7b97\u7684\u603b\u548c\u4e3a: ${sum}\"\nreturn 0\n}\n# \u8c03\u7528\u51fd\u6570\nfsum 10 20 1 2\necho $?\n[root@master func]# bash f1.sh \u51fd\u6570\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a: 10\n\u51fd\u6570\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a: 20\n\u51fd\u6570\u7b2c\u4e09\u4e2a\u53c2\u6570\u4e3a: 1\n\u51fd\u6570\u7684\u53c2\u6570\u603b\u6570\u4e3a: 4\n\u51fd\u6570\u7684\u53c2\u6570\u603b\u6570\u4e3a: 10 20 1 2\n\u8ba1\u7b97\u7684\u603b\u548c\u4e3a: 33\n0\n</code></pre> <p>\u5982\u4e0a\u53ef\u4ee5\u770b\u5230\u7279\u6b8a\u53c2\u6570\u4e0e Shell \u811a\u672c\u4f20\u9012\u53c2\u6570\u4e00\u6837\u3002</p> <p>Tips\uff1a\u5c40\u90e8\u53d8\u91cf\u9700\u8981\u7279\u522b\u58f0\u660e\u5728\u51fd\u6570\u5185\u90e8\u5229\u7528 <code>local</code> \u5173\u952e\u5b57\u6765\u58f0\u660e\u3002</p>"},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#24-\u51fd\u6570\u8fd4\u56de\u503c","title":"2.4 \u51fd\u6570\u8fd4\u56de\u503c","text":"<p>\u51fd\u6570\u8fd4\u56de\u503c\u5229\u7528 <code>$?</code> \u6765\u63a5\u6536\uff0c\u5728\u4e0a\u8ff0\u793a\u4f8b\u4e2d\u6211\u4eec\u5c06\u8ba1\u7b97\u7684\u7ed3\u679c\u5229\u7528 echo \u547d\u4ee4\u6253\u5370\u51fa\u6765\uff0c\u5982\u679c\u6211\u4eec\u5728\u540e\u7eed\u7684\u811a\u672c\u4e2d\u9700\u8981\u5229\u7528\u6b64\u51fd\u6570\u7ed3\u7b97\u7684\u7ed3\u679c\uff0c\u5c31\u9700\u8981\u5f97\u5230\u8fd9\u4e2a\u8fd4\u56de\u503c\uff0c\u6b64\u523b\u5c31\u9700\u8981\u5c06\u8ba1\u7b97\u7684\u7ed3\u679c\u4e0d\u4ec5\u4ec5\u662f\u6253\u5370\u800c\u662f\u8fd4\u56de\u4e86\uff0c\u51fd\u6570\u4e2d\u8fd4\u56de\u5229\u7528 <code>return</code> \u5173\u952e\u5b57\uff0c\u5728\u51fd\u6570\u8c03\u7528\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5229\u7528 <code>$?</code> \u6765\u63a5\u53d7\u51fd\u6570\u7684\u8fd4\u56de\u503c\uff0c\u4f8b\u5982\u5c06\u6211\u4eec\u4e0a\u9762\u7684\u793a\u4f8b\u6539\u9020\u6210\u8fd4\u56de\u7ed3\u6784\u7684\u51fd\u6570\u3002</p> <p>\u6ce8\u610f\uff1ashell \u51fd\u6570\u7684\u8fd4\u56de\u503c\uff0c\u53ea\u80fd\u662f\u6574\u5f62\uff0c\u5e76\u4e14\u5728 0-257 \u4e4b\u95f4\uff0c\u4e0d\u80fd\u662f\u5b57\u7b26\u4e32\u6216\u5176\u4ed6\u5f62\u5f0f\u3002\u5e76\u4e14\u5728\u8c03\u7528\u65b9\u6cd5\u548c\u53d6\u5f97\u8fd4\u56de\u503c\u4e4b\u95f4\uff0c\u4e0d\u80fd\u6709\u4efb\u4f55\u64cd\u4f5c\uff0c\u4e0d\u7136\u53d6\u4e0d\u5230 return \u7684\u503c\u3002</p> <pre><code>[root@master func]# cat f1.sh #!/bin/bash\nfunction fsum() {\necho \"\u51fd\u6570\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a: ${1}\"\necho \"\u51fd\u6570\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a: ${2}\"\necho \"\u51fd\u6570\u7b2c\u4e09\u4e2a\u53c2\u6570\u4e3a: ${3}\"\necho \"\u51fd\u6570\u7684\u53c2\u6570\u603b\u6570\u4e3a: ${#}\"\necho \"\u51fd\u6570\u7684\u53c2\u6570\u603b\u6570\u4e3a: ${@}\"\nlocal sum=0\nfor num in ${@};\ndo\nlet sum=${sum}+${num}\ndone\nreturn $sum\n}\nfsum 10 20 1 2\necho $?\n[root@master func]# bash f1.sh \u51fd\u6570\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a: 10\n\u51fd\u6570\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a: 20\n\u51fd\u6570\u7b2c\u4e09\u4e2a\u53c2\u6570\u4e3a: 1\n\u51fd\u6570\u7684\u53c2\u6570\u603b\u6570\u4e3a: 4\n\u51fd\u6570\u7684\u53c2\u6570\u603b\u6570\u4e3a: 10 20 1 2\n33\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u5c06\u5728\u51fd\u6570\u5185\u90e8\u8ba1\u7b97\u7684\u6570\u7ec4\u4e4b\u548c\uff0c\u5229\u7528 return \u4f5c\u4e3a\u8fd4\u56de\uff0c\u6b64\u523b\u5728\u51fd\u6570\u8c03\u7528\u7684\u65f6\u5019\uff0c\u5229\u7528 <code>$?</code> \u5c31\u53ef\u4ee5\u62ff\u5230\u51fd\u6570\u8fd4\u56de\u7684\u503c\u8fdb\u4e00\u6b65\u5904\u7406\u3002</p>"},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#25-\u9012\u5f52\u51fd\u6570","title":"2.5 \u9012\u5f52\u51fd\u6570","text":"<p>Shell \u652f\u6301\u9012\u5f52\u51fd\u6570\uff0c\u9012\u5f52\u51fd\u6570\u4e5f\u5c31\u662f\u81ea\u5df1\u8c03\u7528\u81ea\u5df1\uff0c\u5373\u5728\u51fd\u6570\u4f53\u5185\u90e8\u53c8\u4e00\u6b21\u8c03\u7528\u51fd\u6570\u81ea\u5df1\uff0c\u4f8b\u5982\uff1a</p> <pre><code>[root@master func]# cat recursion.sh #!/bin/bash\nfunction myecho() {\necho \"$(date)\"\nsleep 1\nmyecho inner\n}\nmyecho\n[root@master func]# bash recursion.sh Sat Mar 28 13:14:38 CST 2020\nSat Mar 28 13:14:39 CST 2020\nSat Mar 28 13:14:40 CST 2020\nSat Mar 28 13:14:41 CST 2020\nSat Mar 28 13:14:42 CST 2020\n...\n</code></pre> <p>\u5982\u4e0a\u5c31\u662f\u4e00\u4e2a\u9012\u5f52\u51fd\u6570\uff0c\u5728\u51fd\u6570\u4f53\u5185\u90e8\u53c8\u8c03\u7528\u4e86\u51fd\u6570 <code>myecho</code>\uff0c\u5728\u6267\u884c\u7684\u65f6\u5019\u5c31\u4f1a\u9677\u5165\u65e0\u9650\u5faa\u73af\u3002</p>"},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#3-\u5b9e\u4f8b","title":"3. \u5b9e\u4f8b","text":""},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#31-\u9700\u6c42","title":"3.1 \u9700\u6c42","text":"<p>\u7cfb\u7edf\u7ecf\u5e38\u5728\u6267\u884c\u5b9a\u65f6\u811a\u672c\u671f\u95f4\u4f1a\u5c06 Linux \u7cfb\u7edf CPU \u5229\u7528\u7387\u8dd1\u6ee1\uff0c\u5bfc\u81f4\u5176\u4ed6\u670d\u52a1\u53d7\u5230\u5f71\u54cd\uff0c\u6545\u67e5\u9605\u8d44\u6599\u53d1\u73b0\u6709\u5927\u795e\u5199\u7684 CPU \u5229\u7528\u7387\u9650\u5236\u7a0b\u5e8f\u3002 \u5730\u5740\uff1aCPU Usage Limiter for Linux</p> <p>\u5229\u7528\u6b64\u5de5\u5177\u53ef\u4ee5\uff0c\u914d\u5408\u5b9a\u65f6\u4efb\u52a1\u653e\u7f6e\u5728\u670d\u52a1\u5668\u4e0a\uff0c\u8fbe\u5230\u9650\u5236\u7a0b\u5e8f CPU \u60c5\u51b5\uff0c\u53ef\u6839\u636e\u81ea\u5df1\u7cfb\u7edf CPU \u6838\u5fc3\u6570\u8fdb\u884c\u53c2\u6570\u914d\u7f6e\uff0c\u4f1a\u8bb0\u5f55 CPU \u8d85\u8fc7\u9600\u503c\u7684\u65e5\u5fd7\uff0c\u53ef\u4f9b\u540e\u671f\u8fdb\u884c\u67e5\u770b\u5206\u6790\u3002</p>"},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#32-\u601d\u8def","title":"3.2 \u601d\u8def","text":"<p>\u5229\u7528\u51fd\u6570\u7f16\u5199\u5b89\u88c5 cpulimit \u5de5\u5177\u7684\u51fd\u6570\uff0c\u5982\u679c\u7cfb\u7edf\u4e0d\u5b58\u5728\u8be5\u547d\u4ee4\u5219\u5b89\u88c5\u5e76\u6267\u884c CPU \u9650\u5236\uff0c\u5982\u679c\u5b58\u5728\u5219\u6267\u884c cpulimit \u51fd\u6570\u5bf9\u8d85\u8fc7\u6307\u5b9a CPU \u7684\u8fdb\u7a0b\u8fdb\u884c\u9650\u5236\uff0c\u6700\u540e\u6267\u884c\u603b\u4f53 main \u51fd\u6570\u3002</p>"},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#33-\u5b9e\u73b0","title":"3.3 \u5b9e\u73b0","text":"<ul> <li>\u5b9e\u73b0\u811a\u672c</li> </ul> <pre><code>#!/bin/bash\n# Description: count file scripts\n# Auth: kaliarch\n# Email: kaliarch@163.com\n# function: count file\n# Date: 2020-03-29 14:00\n# Version: 1.0\n[ $(id -u) -gt 0 ] &amp;&amp; exit 1\n# cpu\u4f7f\u7528\u8d85\u8fc7\u767e\u5206\u4e4b\u591a\u5c11\u8fdb\u884c\u9650\u5236\nPEC_CPU=80\n# \u9650\u5236\u8fdb\u7a0b\u4f7f\u7528\u767e\u5206\u4e4b\u591a\u5c11,\u5982\u679c\u7a0b\u5e8f\u4e3a\u591a\u7ebf\u7a0b\uff0c\u5355\u4e2acpu\u9650\u5236\u4e3a85\uff0c\u5982\u679c\u4e3a\u591a\u6838\u5fc3\uff0c\u5c31\u9700\u8981\u6309\u7167\u6bd4\u4f8b\u5199\uff0c\u4f8b\u5982cpu\u4e3a2c\uff0c\u50cf\u9650\u5236\u591a\u7ebf\u7a0b\u5360\u6bd480%\uff0c\u5c31\u5199170\nLIMIT_CPU=85\n# \u65e5\u5fd7\nLOG_DIR=/var/log/cpulimit/\n# \u8d85\u8fc7\u9600\u503c\u8fdb\u7a0bpid\nPIDARG=$(ps -aux |awk -v CPU=${PEC_CPU} '{if($3 &gt; CPU) print $2}')\n# \u5b89\u88c5cpulimit \u51fd\u6570\ninstall_cpulimit() {\n[ ! -d /tmp ] &amp;&amp; mkdir /tmp || cd /tmp\nwget -c https://github.com/opsengine/cpulimit/archive/v0.2.tar.gz\ntar -zxf v0.2.tar.gz\ncd cpulimit-0.2 &amp;&amp; make\n[ $? -eq 0 ] &amp;&amp; cp src/cpulimit /usr/bin/\n}\n# \u6267\u884ccpulimit\ndo_cpulimit() {\n[ ! -d ${LOG_DIR} ] &amp;&amp; mkdir -p ${LOG_DIR}\nfor i in ${PIDARG};\ndo\nCPULIMITCMD=$(which cpulimit)\nMSG=$(ps -aux |awk -v pid=$i '{if($2 == pid) print $0}')\necho ${MSG}\n[ ! -d /tmp ] &amp;&amp; mkdir /tmp || cd /tmp\nnohup ${CPULIMITCMD} -p $i -l ${LIMIT_CPU} &amp;\necho \"$(date) -- ${MSG}\" &gt;&gt; ${LOG_DIR}$(date +%F).log\ndone\n}\n# \u4e3b\u51fd\u6570\nmain() {\nhash cpulimit\nif [ $? -eq 0 ];then\n# \u8c03\u7528\u51fd\u6570\ndo_cpulimit\nelse\ninstall_cpulimit &amp;&amp; do_cpulimit\nfi\n}\nmain\n</code></pre> <ul> <li>\u6d4b\u8bd5</li> </ul> <p>\u9700\u7f16\u5199 CPU \u538b\u529b\u6d4b\u8bd5 python \u811a\u672c\uff0c\u540e\u671f\u53ef\u4ee5\u653e\u5165\u8ba1\u5212\u4efb\u52a1\u6765\u76d1\u63a7\u5e76\u9650\u5236 CPU \u4f7f\u7528\u7387\u3002</p> <pre><code>#!/bin/env python\nimport math\nimport random\n\na=10000\nb=10000\nc=10000\nsum=0\nfor i in range(0,a):\n    for j in range(0,b):\n        randomfloat=random.uniform(1,10)\nrandompow=random.uniform(1,10)\nsum+=math.pow(randomfloat, randompow)\nprint \"sum is %s\" % sum\n</code></pre> <p>\u5f53\u6211\u4eec\u6267\u884c python \u7684 CPU \u538b\u529b\u6d4b\u8bd5\u811a\u672c\u540e\uff0c\u53d1\u73b0\u5355\u6838\u670d\u52a1 CPU \u8dd1\u5230\u4e86 100%\u3002</p> <p></p> <p>\u4e4b\u540e\u8fd0\u884c\u6211\u4eec\u7684 CPU \u9650\u5236\u811a\u672c\uff0c\u53ef\u4ee5\u770b\u5230 CPU \u88ab\u6210\u529f\u9650\u5236\u3002</p> <p></p> <p>\u5728\u6b64\u6848\u4f8b\u4e2d\uff0c\u6211\u4eec\u7740\u91cd\u6765\u770b Shell \u51fd\u6570\uff0c\u5728\u5b9e\u4f8b\u4e2d\u6211\u4eec\u7f16\u5199\u4e86\u5b89\u88c5\u4e0e\u6267\u884c CPU \u9650\u5236\u4e24\u4e2a\u51fd\u6570\uff0c\u6700\u540e\u7f16\u5199\u4e3b\u51fd\u6570\uff0c\u5728\u4e3b\u51fd\u6570\u4e2d\u8c03\u7528\u5176\u4ed6\u51fd\u6570\uff0c\u914d\u5408\u5b9a\u65f6\u4efb\u52a1\u5c31\u80fd\u8fbe\u5230\u9650\u5236\u67d0\u8fdb\u7a0b\u7684 CPU\u3002</p>"},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#4-\u6ce8\u610f\u4e8b\u9879","title":"4. \u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u51fd\u6570\u5b9a\u4e49\u5efa\u8bae\u4f7f\u7528\u7b80\u660e\u77e5\u610f\u5e76\u9700\u8981\u6709\u4e00\u5b9a\u539f\u5219\uff0c\u4e0d\u4ec5\u4e3a\u4e86\u7f8e\u89c2\u66f4\u662f\u4e3a\u4e86\u89c4\u8303\uff0c\u4f7f\u5f97\u5176\u4ed6\u4eba\u66f4\u597d\u7406\u89e3\u4e0e\u9605\u8bfb\u4f60\u7684 Shell \u811a\u672c\uff0c\u589e\u5f3a\u811a\u672c\u53ef\u7ef4\u62a4\u6027\uff1b</li> <li>\u5bf9\u4e8e\u51fd\u6570\u8c03\u7528\uff0c\u5fc5\u987b\u5728\u51fd\u6570\u5b9a\u4e49\u4e4b\u540e\uff0cShell \u8fd0\u884c\u4e3a\u987a\u5e8f\u8fd0\u884c\uff0c\u6ca1\u6709\u5b9a\u4e49\u51fd\u6570\u5219\u8c03\u7528\u51fd\u6570\u4f1a\u6709\u5f02\u5e38\uff1b</li> <li>\u51fd\u6570\u5b9a\u4e49\u4e0d\u80fd\u6307\u5b9a\u53c2\u6570\uff0c\u5728\u8c03\u7528\u7684\u65f6\u5019\u4f20\u9012\u53c2\u6570\u5373\u53ef\uff0c\u5e76\u4e14\u8c03\u7528\u51fd\u6570\u4f20\u9012\u4ec0\u4e48\u53c2\u6570\uff0c\u51fd\u6570\u5c31\u63a5\u53d7\u4ec0\u4e48\u53c2\u6570\uff1b</li> <li>\u51fd\u6570\u4f20\u9012\u53c2\u6570\u4e0e Shell \u811a\u672c\u4f20\u9012\u53c2\u6570\u7684\u7c7b\u578b\u53ca\u7528\u6cd5\u4e00\u81f4\uff0c\u5728\u6b64\u53ef\u4ee5\u878d\u4f1a\u8d2f\u901a\uff0c\u5bf9\u6bd4\u7406\u89e3\u8bb0\u5fc6\uff1b</li> <li>shell \u51fd\u6570\u7684\u8fd4\u56de\u503c\uff0c\u53ea\u80fd\u662f\u6574\u5f62\uff0c\u5e76\u4e14\u5728 0-257 \u4e4b\u95f4\uff0c\u4e0d\u80fd\u4e3a\u5b57\u7b26\u4e32\u6216\u5176\u4ed6\u5f62\u5f0f\u3002</li> </ul>"},{"location":"Linux/shell/9.Shell%E5%87%BD%E6%95%B0/#5-\u5c0f\u7ed3","title":"5. \u5c0f\u7ed3","text":"<p>\u6211\u4eec\u7f16\u5199 Shell \u5c31\u662f\u4e3a\u4e86\u5b9e\u73b0\u7b80\u5316\u64cd\u4f5c\uff0c\u901a\u5e38\u5c06\u6570\u636e\u548c\u7a0b\u5e8f\u5206\u79bb\uff0c\u6211\u4eec\u5c06\u4e00\u7ec4\u5b9e\u73b0\u5177\u4f53\u4e1a\u52a1\u7684\u903b\u8f91\u7f16\u5199\u4e3a\u4e00\u4e2a\u51fd\u6570\uff0c\u4e5f\u53ef\u4ee5\u79f0\u4e3a\u4e00\u6bb5\u4ee3\u7801\u5757\uff0c\u5c06\u5176\u6a21\u5757\u5316\uff0c\u8d4b\u4e88\u51fd\u6570\u540d\u79f0\uff0c\u5229\u7528\u51fd\u6570\u53ef\u4ee5\u8fbe\u5230\u4ee3\u7801\u590d\u7528\uff0c\u4f7f\u5f97\u6570\u636e\u4e0e\u903b\u8f91\u5206\u79bb\uff0c\u811a\u672c\u66f4\u52a0\u4fbf\u4e8e\u7ef4\u62a4\u548c\u7ba1\u7406\u3002</p>"},{"location":"Linux/shell/Shell%E7%AE%80%E4%BB%8B/","title":"Shell \u6559\u7a0b\u6982\u8ff0","text":""},{"location":"Linux/shell/Shell%E7%AE%80%E4%BB%8B/#1-shell-\u6982\u8ff0","title":"1. Shell \u6982\u8ff0","text":""},{"location":"Linux/shell/Shell%E7%AE%80%E4%BB%8B/#11-shell-\u662f\u4ec0\u4e48","title":"1.1 Shell \u662f\u4ec0\u4e48","text":"<p>\u6211\u4eec\u8981\u7cfb\u7edf\u6027\u7684\u5b66\u4e60 Shell \u811a\u672c\uff0c\u9996\u5148\u9700\u8981\u77e5\u9053\u4ec0\u4e48\u662f Shell\uff0cShell \u7ffb\u8bd1\u8fc7\u6765\u4e3a\u58f3\uff0c\u4f8b\u5982\u5927\u5bb6\u5e38\u89c1\u7684\u58f3\u724c\u77f3\u6cb9\u7684\u56fe\u6807\u4e0a\u9762\u7684\u8d1d\u58f3\uff0c\u987e\u540d\u601d\u4e49\u5176\u5c31\u662f\u4e00\u4e2a\u5957\u5728\u64cd\u4f5c\u7cfb\u7edf\u5916\u5c42\u7684\u58f3\uff0c\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u4e0e\u8fd9\u5c42\u58f3\u7684\u4ea4\u4e92\uff0c\u5c06\u81ea\u5df1\u7684\u9700\u6c42\u5229\u7528\u8fd9\u5c42 Shell \u6765\u6267\u884c\u6765\u5b9e\u73b0\u5bf9\u670d\u52a1\u5668\u7684\u64cd\u4f5c\u3002\u6211\u4eec\u53ef\u4ee5\u8ba4\u4e3a Shell \u662f\u5c06\u7528\u6237\u7684\u547d\u4ee4\u89e3\u6790\u4e3a\u5185\u6838\u53ef\u4ee5\u6267\u884c\u7684\u547d\u4ee4\uff0c\u8d77\u5230\u547d\u4ee4\u89e3\u91ca\u7684\u4f5c\u7528\uff0c\u662f\u7528\u6237\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u76f4\u63a5\u7684\u4e00\u4e2a\u6865\u6881\u7ebd\u5e26\u3002</p> <p></p>"},{"location":"Linux/shell/Shell%E7%AE%80%E4%BB%8B/#12-\u4e3a\u4ec0\u4e48\u8981\u7528-shell","title":"1.2 \u4e3a\u4ec0\u4e48\u8981\u7528 Shell","text":"<p>\u6211\u4eec\u60f3\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u4e3a\u6211\u4eec\u5e72\u4e00\u4ef6\u4e8b\u60c5\uff0c\u6211\u4eec\u4e0d\u9700\u8981\u53bb\u4e86\u89e3\u5185\u5728\u7684\u5185\u6838\u6307\u4ee4\uff0c\u800c\u662f\u53ea\u9700\u8981\u4e86\u89e3\u53ef\u4ee5\u64cd\u4f5c\u7cfb\u7edf\u7684 Shell \u547d\u4ee4\u5373\u53ef\uff0cShell \u4e3a\u6211\u4eec\u5c4f\u853d\u6765\u64cd\u4f5c\u7cfb\u7edf\u4f4e\u5c42\u7684\u7ec6\u8282\uff0c\u4e5f\u5904\u4e8e\u5b89\u5168\u6027\u8003\u8651\uff0c\u4e0d\u80fd\u8ba9\u7528\u6237\u968f\u4fbf\u7684\u8fdb\u884c\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u7684\u64cd\u4f5c\uff0c\u901a\u4fd7\u6765\u8bf4\uff0cshell \u5c31\u662f\u8ba9\u7528\u6237\u66f4\u7b80\u5355\u7684\u64cd\u4f5c\u8ba1\u7b97\u673a\u3002</p>"},{"location":"Linux/shell/Shell%E7%AE%80%E4%BB%8B/#13-shell-\u811a\u672c\u662f\u4ec0\u4e48","title":"1.3 Shell \u811a\u672c\u662f\u4ec0\u4e48","text":"<p>\u6211\u4eec\u77e5\u9053\u4e86 Shell \u662f\u4e00\u4e2a\u7528\u6237\u4e0e Linux \u7cfb\u7edf\u5185\u6838\u7684\u901a\u8baf\u7684\u6865\u6881\u540e\uff0c\u90a3\u4e48 Shell \u811a\u672c\u662f\u4ec0\u4e48\u5462\uff1f</p> <p>Shell \u811a\u672c\u5c31\u662f\u64cd\u4f5c Shell \u7684\u6307\u4ee4\u96c6\u5408\u7f16\u5199\u6210\u7684\u4e00\u6bb5\u5b9e\u73b0\u76ee\u7684\u9700\u6c42\u7684\u4ee3\u7801\uff0c\u4e5f\u4e3a\u4e00\u79cd\u7ba1\u7406 Linux \u7cfb\u7edf\u7684\u811a\u672c\u8bed\u8a00\uff0c\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u7684\u5c06\u5176\u7406\u89e3\u4e3a\uff0cLinux \u7684\u5404\u79cd\u6307\u4ee4\u52a0\u4e0a\u4e00\u4e9b\u6d41\u7a0b\u63a7\u5236\u548c\u6570\u636e\u7684\u96c6\u5408\uff0c\u56e0\u4e3a\u5b83\u8fd8\u6709\u4e0d\u5c11\u7684\u8bed\u6cd5\u53ca\u683c\u5f0f\uff0c\u540e\u9762\u6211\u4eec\u6765\u901a\u8fc7\u5b66\u4e60\uff0c\u8be6\u7ec6\u5256\u6790\u5176\u5185\u5728\u7cbe\u9ad3\u3002</p>"},{"location":"Linux/shell/Shell%E7%AE%80%E4%BB%8B/#14-\u5e02\u573a\u4f4d\u7f6e","title":"1.4 \u5e02\u573a\u4f4d\u7f6e","text":"<p>\u76ee\u524d Shell \u811a\u672c\u7531\u4e8e\u5176\u4f5c\u4e3a\u76f4\u63a5\u4e0e Linux \u7cfb\u7edf\u4ea4\u4e92\uff0c\u5728\u6279\u91cf / \u5b9a\u65f6\u4efb\u52a1\u4e2d\u6709\u7740\u72ec\u7279\u65e0\u53ef\u53d6\u4ee3\u7684\u4f5c\u7528\uff0c\u4e0d\u7ba1\u662f\u8fd0\u7ef4\u4eba\u5458\u8fd8\u662f\u5f00\u53d1\u4eba\u5458\u6570\u91cf\u638c\u63e1 Shell \u811a\u672c\uff0c\u90fd\u4f1a\u7ed9\u65e5\u540e\u7684\u5de5\u4f5c\u4ee3\u7406\u975e\u5e38\u5927\u7684\u4fbf\u5229\uff0cShell \u4f5c\u4e3a\u4e00\u79cd\u811a\u672c\u8bed\u8a00\uff0c\u7f16\u5199\u5b8c\u6e90\u7801\u540e\u4e0d\u7528\u7f16\u8bd1\uff0c\u76f4\u63a5\u8fd0\u884c\u6e90\u7801\u5373\u53ef\uff0c\u662f\u5b9e\u73b0 Linux/UNIX \u7cfb\u7edf\u7ba1\u7406\u53ca\u81ea\u52a8\u5316\u8fd0\u7ef4\u6240\u5fc5\u5907\u7684\u91cd\u8981\u5de5\u5177\uff0c \u53ea\u6709\u719f\u7ec3\u638c\u63e1 Shell \u624d\u80fd\u63d0\u5347\u8fd0\u7ef4\u4eba\u5458\u7684\u5de5\u4f5c\u6548\u7387\uff0c\u9002\u5e94\u66f0\u76ca\u590d\u6742\u7684\u5de5\u4f5c\u73af\u5883\uff0c\u51cf\u5c11\u4e0d\u5fc5\u8981\u7684\u91cd\u590d\u5de5\u4f5c\uff0c\u4ece\u800c\u4e3a\u4e2a\u4eba\u7684\u804c\u573a\u53d1\u5c55\u5960\u5b9a\u8f83\u597d\u7684\u57fa\u7840\u3002</p>"},{"location":"Linux/shell/Shell%E7%AE%80%E4%BB%8B/#2-shell-\u5206\u7c7b","title":"2. Shell \u5206\u7c7b","text":"<p>\u6211\u4eec\u77e5\u9053\u4e0e Linux \u5185\u6838\u6211\u4eec\u6253\u4ea4\u9053\u7684\u90fd\u6709\u4ec0\u4e48\u5462\uff1f\u901a\u5e38\u6709\u4e24\u79cd\u65b9\u5f0f\uff0c\u5373\u56fe\u5f62\u754c\u9762 \uff08GUI Shell\uff09\u548c\u7ec8\u7aef\u547d\u4ee4\u884c \uff08CLI Shell\uff09\u3002</p>"},{"location":"Linux/shell/Shell%E7%AE%80%E4%BB%8B/#21-gui-shell","title":"2.1 GUI Shell","text":"<p>\u5982\u679c\u6211\u4eec\u4e0d\u719f\u6089 Linux \u547d\u4ee4\uff0c\u6211\u4eec\u901a\u8fc7 VNC \u767b\u5f55\u5230 Linux \u7cfb\u7edf\u540e\uff0c\u5229\u7528\u9f20\u6807\u53bb\u53cc\u51fb\u6587\u4ef6\u5939\u8fdb\u5165\u76ee\u5f55\uff0c\u6216\u65b0\u5efa\u6587\u4ef6\u5939\uff0c\u7f16\u8f91\u6587\u4ef6\uff0c\u5b89\u88c5 rpm \u5305\u7b49\uff0c\u8fd9\u4e9b\u64cd\u4f5c\u90fd\u662f\u5229\u7528 GUI Shell \u4e0e Linux \u7cfb\u7edf\u5185\u6838\u901a\u8baf\uff0c\u5b83\u4e3a\u6211\u4eec\u6784\u9020\u4e86\u4e00\u5957\u7c7b\u4f3c Windows \u7684\u754c\u9762\u4f18\u5316\u7684\u684c\u9762\u73af\u5883\uff0c\u76ee\u524d\u7684\u684c\u9762\u73af\u5883\u4f8b\u5982 Gnome/KDE \u7b49\uff0c\u6b64\u7c7b\u4e3a GUI Shell\u3002</p>"},{"location":"Linux/shell/Shell%E7%AE%80%E4%BB%8B/#22-cli-shell","title":"2.2 CLI Shell","text":"<p>Linux \u4f5c\u4e3a\u670d\u52a1\u5668\u7aef\uff0c\u8fd0\u884c\u684c\u9762\u73af\u5883\u975e\u5e38\u6d88\u8017\u8d44\u6e90\uff0c\u56e0\u6b64 CLI Shell \u624d\u662f\u6211\u4eec\u672c\u6b21\u7684\u91cd\u70b9\uff0c\u5176\u6839\u636e\u4e0d\u540c\u7684\u7cfb\u7edf\u6709\u5f88\u591a\u79cd\u7c7b\uff0c \u4f8b\u5982\u6211\u4eec\u6700\u5e38\u7528\u7684\u4e3b\u6d41\u7248\u672c\u7684 Linux \u7cfb\u7edf CentOS/RHEL \u7684\u9ed8\u8ba4 Shell \u4e3a <code>bash</code>\uff0c\u5f53\u7136\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u7684 Shell\uff0c\u4e3a\u4ec0\u4e48\u6709\u8fd9\u4e48\u591a\u7c7b\u578b\u7684 Shell \u5185\uff0c\u56e0\u4e3a\u5bf9\u4e8e\u4e0d\u540c\u7684\u64cd\u4f5c\u7cfb\u7edf\u7c7b\u578b\uff0c\u5176\u5185\u6838\u90fd\u96be\u514d\u5b58\u5728\u5dee\u5f02\uff0c\u56e0\u6b64\u4e0e\u5185\u6838\u4ea4\u4e92\u7684 Shell \u4e5f\u5c31\u5206\u6765\u4e0d\u5c11\u79cd\u7c7b\uff0c\u76ee\u524d\u5728 Linux \u7cfb\u7edf\u4e0a\u4e3b\u6d41\u7684 CLI Shell \u90fd\u4e3a Bash\uff0c\u662f\u8bb8\u591a Linux \u53d1\u884c\u7248\u9ed8\u8ba4\u7684 Shell\u3002\u8fd8\u6709\u8bb8\u591a Unix \u4e0a Shell\u3002\u6211\u4eec\u53ef\u4ee5\u5728 Linux \u7cfb\u7edf\u4e0a <code>cat /etc/shells</code> \u6765\u67e5\u770b\u672c\u7248\u672c\u652f\u6301\u7684\u5404 Shell \u7c7b\u578b\uff0c\u540c\u65f6\u53ef\u4ee5\u5229\u7528\u547d\u4ee4 <code>echo $SHELL</code> \u6765\u67e5\u770b\u5f53\u524d\u73af\u5883\u4e2d\u7684\u9ed8\u8ba4 Shell\uff0c\u4e0d\u540c\u7684 Shell \u90fd\u6709\u5176\u5404\u81ea\u7684\u7279\u70b9\uff0c\u76ee\u524d\u4e3b\u6d41\u7684 Shell \u7c7b\u578b\u5982\u4e0b\uff1a</p> <ul> <li>Bourne Again Shell\uff08/bin/bash\uff09\uff1a\u5176\u4e3a\u76ee\u524d\u4e3b\u6d41 Linux \u53d1\u884c\u7248\u9ed8\u8ba4\u7684 Shell\uff0c\u5176\u4e5f\u662f Bourne shell \u6700\u65e9\u7684\u53d1\u578b\u5e76\u514d\u8d39\u7684\u7248\u672c\uff0c\u7528\u6237\u53ef\u4ee5\u5229\u7528\u5176 help \u547d\u4ee4\u6765\u67e5\u770b\u51e0\u4e4e Shell \u7684\u6240\u7528\u529f\u80fd\u3002</li> <li>Bourne Shell\uff08/usr/bin/sh \u6216 /bin/sh\uff09\uff1a\u662f\u4e00\u4e2a\u5feb\u6377\u65b9\u5f0f\uff0c\u540e\u5df2\u7ecf\u88ab /bin/bash \u6240\u53d6\u4ee3\u3002</li> <li>C Shell\uff08/usr/bin/csh\uff09\uff1a\u7b80\u5355\u9ad8\u6548\uff0c\u5176\u4f7f\u7528\u7c7b\u4f3c C \u8bed\u8a00\u7684\u8bed\u6cd5\uff0c\u540e\u5df2\u88ab tcsh \u53d6\u4ee3\u3002</li> <li>K Shell\uff08/usr/bin/ksh\uff09\uff1aKorn shell \u7684\u8bed\u6cd5\u4e0e Bourne shell \u76f8\u540c\uff0c\u540c\u65f6\u5177\u5907\u4e86 C shell \u7684\u6613\u7528\u7279\u70b9\uff0c\u8bb8\u591a\u5b89\u88c5\u811a\u672c\u90fd\u4f7f\u7528 ksh\u3002</li> </ul>"},{"location":"Linux/shell/Shell%E7%AE%80%E4%BB%8B/#3-\u5e94\u7528\u573a\u666f","title":"3. \u5e94\u7528\u573a\u666f","text":"<ul> <li>\u5e94\u7528\u5b89\u88c5\uff1a\u6211\u4eec\u90fd\u77e5\u9053\u5728 Linux \u670d\u52a1\u5668\u7ecf\u5e38\u9700\u8981\u6211\u4eec\u5b89\u88c5\u7f6e\u4e00\u4e9b\u8f6f\u4ef6\u6216\u914d\u7f6e\u73af\u5883\uff0c\u4eba\u624b\u5de5\u7684\u4e00\u6761\u547d\u540d\u4e00\u6761\u547d\u4ee4\u6267\u884c\uff0c\u5f88\u5bb9\u6613\u51fa\u73b0\u9519\u8bef\uff0c\u800c\u4e14\u5982\u679c\u6210\u767e\u4e0a\u5343\u53f0\u670d\u52a1\u5668\uff0c\u90a3\u4e48\u6b64\u573a\u666f\u4e0b Shell \u811a\u672c\u5c31\u975e\u5e38\u9002\u5408\uff0c\u7f16\u5199\u4e00\u4e2a\u5e94\u7528\u5b89\u88c5\u914d\u7f6e\u811a\u672c\uff0c\u540e\u671f\u53ef\u4ee5\u91cd\u590d\u4f7f\u7528\uff0c\u4e14\u4e0d\u5bb9\u6613\u51fa\u9519\uff0cShell \u811a\u672c\u9002\u7528\u4e8e\u91cd\u590d\u6027\u7684\u5de5\u4f5c\u3002</li> <li>\u5b9a\u65f6\u4efb\u52a1\uff1a\u4f8b\u5982\u6211\u4eec\u9700\u8981\u6bcf\u5206\u4e0a\u62a5\u670d\u52a1\u5668\u7684\u5404\u9879\u6027\u80fd\u6307\u6807\u5230\u76d1\u63a7\u670d\u52a1\u7aef\uff0c\u6b64\u65f6\u53ef\u4ee5\u5199\u4e00\u4e2a\u91c7\u96c6\u7cfb\u7edf\u5404\u9879\u6307\u6807\u7684\u811a\u672c\uff0c\u7136\u540e\u914d\u5408\u5b9a\u65f6\u4efb\u52a1\u6765\u6bcf\u5206\u949f\u6267\u884c\u6307\u6807\u6570\u636e\u4e0a\u62a5\uff0cShell \u811a\u672c\u975e\u5e38\u9002\u7528\u4e8e\u5468\u671f\u6027\u7684\u5de5\u4f5c\u3002</li> <li>\u5e94\u7528\u64cd\u4f5c\uff1a\u4f8b\u5982\u6211\u4eec\u81ea\u5df1\u5199\u7684\u5e94\u7528\uff0c\u53ef\u4ee5\u4e3a\u5176\u7f16\u5199\u542f\u52a8 / \u505c\u6b62 / \u91cd\u542f\u7b49\u64cd\u4f5c\u7684\u811a\u672c\uff0c\u5c06\u811a\u672c\u6dfb\u52a0\u8fdb\u7cfb\u7edf\u73af\u5883\u4e2d\uff0c\u540e\u671f\u5f88\u65b9\u4fbf\u8fdb\u884c\u670d\u52a1\u7ba1\u7406\u3002</li> <li>\u5907\u4efd\u6062\u590d\uff1a\u53ef\u4ee5\u5229\u7528\u811a\u672c\u6765\u8fdb\u884c\u7f51\u7ad9\u6587\u4ef6\u6216\u6570\u636e\u5e93\u7684\u5f02\u5730\u5907\u4efd\uff0c\u4ee5\u53ca\u6062\u590d\u5230\u6d4b\u8bd5\u73af\u5883\u8fdb\u884c\u9a8c\u8bc1\u7b49\u3002</li> <li>CI/CD: Shell \u811a\u672c\u9002\u7528\u4e0e DevOPS \u4e2d\u7684\u5728\u670d\u52a1\u5668\u4e2d\u6301\u7eed\u96c6\u6210\u6301\u7eed\u90e8\u7f72\u7684 pipeline \u6d41\u7a0b\u4e2d\uff0c\u9002\u7528\u4e8e\u5e94\u7528\u53d1\u5e03\u6700\u540e\u4e00\u516c\u91cc\u914d\u7f6e\u3002</li> <li>\u5176\u4ed6\uff1a\u5f53\u7136 Shell \u8fd8\u53ef\u4ee5\u505a\u4e00\u4e9b\u5176\u4ed6\u5de5\u4f5c\uff0c\u6bd4\u5982\u8fd0\u7b97 / \u751f\u6210\u62a5\u8868\uff0c\u751a\u81f3\u6709\u5927\u4f6c\u7528 Shell \u7f16\u5199\u6e38\u620f\u7b49\uff0c\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u6765\u5229\u7528\u597d Shell \u811a\u672c\u6765\u4e3a\u81ea\u5df1\u670d\u52a1\u3002</li> </ul>"},{"location":"Linux/shell/Shell%E7%AE%80%E4%BB%8B/#4-\u5b66\u4e60\u524d\u63d0","title":"4. \u5b66\u4e60\u524d\u63d0","text":"<p>\u5b66\u4e60 Shell \u811a\u672c\u975e\u5e38\u7b80\u5355\uff0c\u9700\u8981\u6709\u4e00\u53f0 Linux \u7cfb\u7edf\uff0c\u7cfb\u7edf\u7c7b\u578b\u53ef\u4ee5\u662f CentOS/RedHat \u6216 Ubuntu\uff0c\u7531\u4e8e\u4e0d\u540c\u7684\u7cfb\u7edf\u4f7f\u7528\u7684 Shell \u7c7b\u578b\u53ef\u80fd\u5b58\u5728\u5f02\u5e38\uff0c\u5efa\u8bae\u4f7f\u7528 CentOS 7 \u7cfb\u7edf\u6765\u5b66\u4e60\u672c\u793a\u4f8b\u3002</p>"},{"location":"Linux/shell/Shell%E7%AE%80%E4%BB%8B/#5-\u94fe\u63a5","title":"5. \u94fe\u63a5","text":"<ul> <li>https://github.com/fengyuhetao/shell</li> <li>https://github.com/daily-scripts/shell-scripts</li> </ul>"},{"location":"Linux/system/Linux%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/","title":"Linux\u5185\u6838\u5f15\u5bfc\u8be6\u89e3","text":""},{"location":"Linux/system/Linux%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/#linux-\u5185\u6838\u5f15\u5bfc","title":"Linux \u5185\u6838\u5f15\u5bfc","text":""},{"location":"Linux/system/Linux%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/#\u4e00-\u6982\u8ff0","title":"\u4e00 \u6982\u8ff0","text":"<p>\u5185\u6838\u5f15\u5bfc\u9009\u9879\u5927\u4f53\u4e0a\u53ef\u4ee5\u5206\u4e3a\u4e24\u7c7b\uff1a\u4e00\u7c7b\u4e0e\u8bbe\u5907\u65e0\u5173\u3001\u53e6\u4e00\u7c7b\u4e0e\u8bbe\u5907\u6709\u5173\u3002\u4e0e\u8bbe\u5907\u6709\u5173\u7684\u5f15\u5bfc\u9009\u9879\u591a\u5982\u725b\u6bdb\uff0c\u9700\u8981\u4f60\u81ea\u5df1\u9605\u8bfb\u5185\u6838\u4e2d\u7684\u76f8\u5e94\u9a71\u52a8\u7a0b\u5e8f\u6e90\u7801\u4ee5\u83b7\u53d6\u5176\u80fd\u591f\u63a5\u53d7\u7684\u5f15\u5bfc\u9009\u9879\u3002\u6bd4\u5982\uff0c\u5982\u679c\u4f60\u60f3\u77e5\u9053\u53ef\u4ee5\u5411 AHA1542 SCSI \u9a71\u52a8\u7a0b\u5e8f\u4f20\u9012\u54ea\u4e9b\u5f15\u5bfc\u9009\u9879\uff0c\u90a3\u4e48\u5c31\u67e5\u770b drivers/scsi/aha1542.c \u6587\u4ef6\uff0c\u4e00\u822c\u5728\u524d\u9762 100 \u884c\u6ce8\u91ca\u91cc\u5c31\u53ef\u4ee5\u627e\u5230\u6240\u63a5\u53d7\u7684\u5f15\u5bfc\u9009\u9879\u8bf4\u660e\u3002\u5927\u591a\u6570\u9009\u9879\u662f\u901a\u8fc7\"__setup()\"\u51fd\u6570\u8bbe\u7f6e\u7684\uff0c\u5c11\u90e8\u5206\u662f\u901a\u8fc7\"early_param()\"\u6216\"module_param()\"\u6216\"module_param_named()\"\u4e4b\u7c7b\u7684\u51fd\u6570\u8bbe\u7f6e\u7684\uff0c\u9017\u53f7\u524d\u7684\u90e8\u5206\u5c31\u662f\u5f15\u5bfc\u9009\u9879\u7684\u540d\u79f0\uff0c\u540e\u9762\u7684\u90e8\u5206\u5c31\u662f\u5904\u7406\u8fd9\u4e9b\u9009\u9879\u7684\u51fd\u6570\u540d\u3002</p> <p>[\u63d0\u793a]\u4f60\u53ef\u4ee5\u5728\u6e90\u7801\u6811\u7684\u6839\u76ee\u5f55\u4e0b\u8bd5\u4e00\u8bd5\u4e0b\u9762\u51e0\u4e2a\u547d\u4ee4\uff1a</p> <pre><code>grep -r '\\b__setup *(' *\ngrep -r '\\bearly_param *(' *\ngrep -r '\\bmodule_param *(' *\ngrep -r '\\bmodule_param_named *(' *\n</code></pre> <p>\u683c\u5f0f\u4e0a\uff0c\u591a\u4e2a\u9009\u9879\u4e4b\u95f4\u7528\u7a7a\u683c\u5206\u5272\uff0c\u9009\u9879\u503c\u662f\u4e00\u4e2a\u9017\u53f7\u5206\u5272\u7684\u5217\u8868\uff0c\u5e76\u4e14\u9009\u9879\u503c\u4e2d\u4e0d\u80fd\u5305\u542b\u7a7a\u767d\u3002</p> <pre><code>\u6b63\u786e\uff1aether=9,0x300,0xd0000,0xd4000,eth0  root=/dev/sda2\n\u9519\u8bef\uff1aether = 9, 0x300, 0xd0000, 0xd4000, eth0  root = /dev/sda2\n</code></pre> <p>\u6ce8\u610f\uff0c\u6240\u6709\u5f15\u5bfc\u9009\u9879\u90fd\u662f\u5927\u5c0f\u5199\u654f\u611f\u7684\uff01</p> <p>\u5728\u5185\u6838\u8fd0\u884c\u8d77\u6765\u4e4b\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7 cat /proc/cmdline \u547d\u4ee4\u67e5\u770b\u5f53\u521d\u4f7f\u7528\u7684\u5f15\u5bfc\u9009\u9879\u4ee5\u53ca\u76f8\u5e94\u7684\u503c\u3002</p>"},{"location":"Linux/system/Linux%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/#\u4e8c-\u5185\u6838\u6a21\u5757","title":"\u4e8c \u5185\u6838\u6a21\u5757","text":"<p>\u5bf9\u4e8e\u6a21\u5757\u800c\u8a00\uff0c\u5f15\u5bfc\u9009\u9879\u53ea\u80fd\u7528\u4e8e\u76f4\u63a5\u7f16\u8bd1\u5230\u6838\u5fc3\u4e2d\u7684\u6a21\u5757\uff0c\u683c\u5f0f\u662f\"\u6a21\u5757\u540d.\u9009\u9879=\u503c\"\uff0c\u6bd4\u5982\"usbcore.blinkenlights=1\"\u3002\u52a8\u6001\u52a0\u8f7d\u7684\u6a21\u5757\u5219\u53ef\u4ee5\u5728 modprobe \u547d\u4ee4\u884c\u4e0a\u6307\u5b9a\u76f8\u5e94\u7684\u9009\u9879\u503c\uff0c\u6bd4\u5982\"modprobe usbcore blinkenlights=1\"\u3002</p> <p>\u53ef\u4ee5\u4f7f\u7528\"modinfo -p ${modulename}\"\u547d\u4ee4\u663e\u793a\u53ef\u52a0\u8f7d\u6a21\u5757\u7684\u6240\u6709\u53ef\u7528\u9009\u9879\u3002\u5df2\u7ecf\u52a0\u8f7d\u5230\u5185\u6838\u4e2d\u7684\u6a21\u5757\u4f1a\u5728 /sys/module/${modulename}/parameters/ \u4e2d\u663e\u793a\u51fa\u5176\u9009\u9879\uff0c\u5e76\u4e14\u67d0\u4e9b\u9009\u9879\u7684\u503c\u8fd8\u53ef\u4ee5\u5728\u8fd0\u884c\u65f6\u901a\u8fc7\"echo -n \u200b${value} &gt; /sys/module/\u200b${modulename}/parameters/${parm}\"\u8fdb\u884c\u4fee\u6539\u3002</p>"},{"location":"Linux/system/Linux%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/#\u4e09-\u5185\u6838\u5982\u4f55\u5904\u7406\u5f15\u5bfc\u9879","title":"\u4e09 \u5185\u6838\u5982\u4f55\u5904\u7406\u5f15\u5bfc\u9879","text":"<p>\u7edd\u5927\u90e8\u5206\u7684\u5185\u6838\u5f15\u5bfc\u9009\u9879\u7684\u683c\u5f0f\u5982\u4e0b(\u6bcf\u4e2a\u9009\u9879\u7684\u503c\u5217\u8868\u4e2d\u6700\u591a\u53ea\u80fd\u6709\u5341\u9879)\uff1a</p> <pre><code>name[=value_1][,value_2]...[,value_10]\n</code></pre> <p>\u5982\u679c\"name\"\u4e0d\u80fd\u88ab\u8bc6\u522b\u5e76\u4e14\u6ee1\u8db3\"name=value\"\u7684\u683c\u5f0f\uff0c\u90a3\u4e48\u5c06\u88ab\u89e3\u8bd1\u4e3a\u4e00\u4e2a\u73af\u5883\u53d8\u91cf(\u6bd4\u5982\"TERM=linux\"\u6216\"BOOT_IMAGE=vmlinuz.bak\")\uff0c\u5426\u5219\u5c06\u88ab\u539f\u5c01\u4e0d\u52a8\u7684\u4f20\u9012\u7ed9 init \u7a0b\u5e8f(\u6bd4\u5982\"single\")\u3002</p> <p>\u5185\u6838\u53ef\u4ee5\u63a5\u53d7\u7684\u9009\u9879\u4e2a\u6570\u6ca1\u6709\u9650\u5236\uff0c\u4f46\u662f\u6574\u4e2a\u547d\u4ee4\u884c\u7684\u603b\u957f\u5ea6(\u9009\u9879/\u503c/\u7a7a\u683c\u5168\u90e8\u5305\u542b\u5728\u5185)\u5374\u662f\u6709\u9650\u5236\u7684\uff0c\u5b9a\u4e49\u5728 include/asm/setup.h \u4e2d\u7684 COMMAND_LINE_SIZE \u5b8f\u4e2d(\u5bf9\u4e8eX86_64\u800c\u8a00\u662f2048)\u3002</p>"},{"location":"Linux/system/Linux%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/#\u56db-\u5185\u6838\u5f15\u5bfc\u9009\u9879\u7cbe\u9009","title":"\u56db \u5185\u6838\u5f15\u5bfc\u9009\u9879\u7cbe\u9009","text":"<p>\u7531\u4e8e\u5f15\u5bfc\u9009\u9879\u591a\u5982\u725b\u6bdb\uff0c\u672c\u6587\u4e0d\u53ef\u80fd\u6d89\u53ca\u5168\u90e8\uff0c\u56e0\u6b64\u672c\u6587\u53ea\u57fa\u4e8e X86_64 \u5e73\u53f0\u4ee5\u53ca Linux-3.13.2 \u7cbe\u9009\u4e86\u4e00\u4e9b\u4e0e\u8bbe\u5907\u65e0\u5173\u7684\u5f15\u5bfc\u9009\u9879\u4ee5\u53ca\u5c11\u90e8\u5206\u4e0e\u8bbe\u5907\u6709\u5173\u7684\u5f15\u5bfc\u9009\u9879\uff0c\u8fc7\u65f6\u7684\u9009\u9879\u3001\u975ex86\u5e73\u53f0\u9009\u9879\u3001\u4e0e\u8bbe\u5907\u6709\u5173\u7684\u9009\u9879\uff0c\u57fa\u672c\u4e0a\u90fd\u88ab\u5ffd\u7565\u4e86\u3002</p> <p>[\u63d0\u793a]\u5185\u6838\u6e90\u7801\u6811\u4e0b\u7684 Documentation/admin-guide/kernel-parameters.txt \u548c Documentation/x86/x86_64/boot-options.rst \u6587\u4ef6\u5217\u51fa\u4e86\u6240\u6709\u53ef\u7528\u7684\u5f15\u5bfc\u9009\u9879\uff0c\u5e76\u4f5c\u4e86\u7b80\u8981\u8bf4\u660e\u3002</p> <p>\u7531\u4e8e\u5f15\u5bfc\u9009\u9879\u591a\u5982\u725b\u6bdb\uff0c\u672c\u6587\u4e0d\u53ef\u80fd\u6d89\u53ca\u5168\u90e8\uff0c\u56e0\u6b64\u672c\u6587\u53ea\u57fa\u4e8e X86_64 \u5e73\u53f0\u4ee5\u53ca Linux-3.13.2 \u7cbe\u9009\u4e86\u4e00\u4e9b\u4e0e\u8bbe\u5907\u65e0\u5173\u7684\u5f15\u5bfc\u9009\u9879\u4ee5\u53ca\u5c11\u90e8\u5206\u4e0e\u8bbe\u5907\u6709\u5173\u7684\u5f15\u5bfc\u9009\u9879\uff0c\u8fc7\u65f6\u7684\u9009\u9879\u3001\u975ex86\u5e73\u53f0\u9009\u9879\u3001\u4e0e\u8bbe\u5907\u6709\u5173\u7684\u9009\u9879\uff0c\u57fa\u672c\u4e0a\u90fd\u88ab\u5ffd\u7565\u4e86\u3002</p> <p>[\u63d0\u793a]\u5185\u6838\u6e90\u7801\u6811\u4e0b\u7684 Documentation/admin-guide/kernel-parameters.txt \u548c Documentation/x86/x86_64/boot-options.rst \u6587\u4ef6\u5217\u51fa\u4e86\u6240\u6709\u53ef\u7528\u7684\u5f15\u5bfc\u9009\u9879\uff0c\u5e76\u4f5c\u4e86\u7b80\u8981\u8bf4\u660e\u3002</p>"},{"location":"Linux/system/Linux%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/#41-\u6807\u8bb0\u8bf4\u660e","title":"4.1 \u6807\u8bb0\u8bf4\u660e","text":"<p>\u5e76\u4e0d\u662f\u6240\u6709\u7684\u9009\u9879\u90fd\u662f\u6c38\u8fdc\u53ef\u7528\u7684\uff0c\u53ea\u6709\u5728\u7279\u5b9a\u7684\u6a21\u5757\u5b58\u5728\u5e76\u4e14\u76f8\u5e94\u7684\u786c\u4ef6\u4e5f\u5b58\u5728\u7684\u60c5\u51b5\u4e0b\u624d\u53ef\u7528\u3002\u5f15\u5bfc\u9009\u9879\u4e0a\u9762\u7684\u65b9\u62ec\u53f7\u8bf4\u660e\u4e86\u5176\u4f9d\u8d56\u5173\u7cfb\uff0c\u5176\u4e2d\u4f7f\u7528\u7684\u6807\u8bb0\u89e3\u91ca\u5982\u4e0b\uff1a</p> <pre><code>ACPI     \u5f00\u542f\u4e86\u9ad8\u7ea7\u914d\u7f6e\u4e0e\u7535\u6e90\u63a5\u53e3(CONFIG_ACPI)\u652f\u6301\nAGP      \u5f00\u542f\u4e86AGP(CONFIG_AGP)\u652f\u6301\nAPIC     \u5f00\u542f\u4e86\u9ad8\u7ea7\u53ef\u7f16\u7a0b\u4e2d\u65ad\u63a7\u5236\u5668\u652f\u6301(2000\u5e74\u4ee5\u540e\u7684CPU\u90fd\u652f\u6301)\nAPPARMOR \u5f00\u542f\u4e86AppArmor(CONFIG_SECURITY_APPARMOR)\u652f\u6301\nDRM      \u5f00\u542f\u4e86Direct Rendering Manager(CONFIG_DRM)\u652f\u6301\nEFI      \u5f00\u542f\u4e86EFI\u5206\u533a(CONFIG_EFI_PARTITION)\u652f\u6301\nEVM      \u5f00\u542f\u4e86Extended Verification Module(CONFIG_EVM)\u652f\u6301\nFB       \u5f00\u542f\u4e86\u5e27\u7f13\u51b2\u8bbe\u5907(CONFIG_FB)\u652f\u6301\nHIBERNATION  \u5f00\u542f\u4e86\"\u4f11\u7720\u5230\u786c\u76d8\"(CONFIG_HIBERNATION)\u652f\u6301\nHPET_MMAP    \u5141\u8bb8\u5bf9HPET\u5bc4\u5b58\u5668\u8fdb\u884c\u6620\u5c04(CONFIG_HPET_MMAP)\nHW       \u5b58\u5728\u76f8\u5e94\u7684\u786c\u4ef6\u8bbe\u5907\nIOMMU    \u5f00\u542f\u4e86IOMMU(CONFIG_IOMMU_SUPPORT)\u652f\u6301\nIOSCHED  \u5f00\u542f\u4e86\u591a\u4e2a\u4e0d\u540c\u7684I/O\u8c03\u5ea6\u7a0b\u5e8f(CONFIG_IOSCHED_*)\nIPV6     \u5f00\u542f\u4e86IPv6(CONFIG_IPV6)\u652f\u6301\nIP_PNP   \u5f00\u542f\u4e86\u81ea\u52a8\u83b7\u53d6IP\u7684\u534f\u8bae(DHCP,BOOTP,RARP)\u652f\u6301\nIP_VS_FTP    \u5f00\u542f\u4e86IPVS FTP\u534f\u8bae\u8fde\u63a5\u8ffd\u8e2a(CONFIG_IP_VS_FTP)\u652f\u6301\nKVM      \u5f00\u542f\u4e86KVM(CONFIG_KVM_*)\u652f\u6301\nLIBATA   \u5f00\u542f\u4e86libata(CONFIG_ATA)\u9a71\u52a8\u652f\u6301\nLOOP     \u5f00\u542f\u4e86\u56de\u73af\u8bbe\u5907(CONFIG_BLK_DEV_LOOP)\u652f\u6301\nMCE      \u5f00\u542f\u4e86Machine Check Exception(CONFIG_X86_MCE)\u652f\u6301\nMOUSE    \u5f00\u542f\u4e86\u9f20\u6807(CONFIG_INPUT_MOUSEDEV)\u652f\u6301\nMSI      \u5f00\u542f\u4e86PCI MSI(CONFIG_PCI_MSI)\u652f\u6301\nNET      \u5f00\u542f\u4e86\u7f51\u7edc\u652f\u6301\nNETFILTER    \u5f00\u542f\u4e86Netfilter(CONFIG_NETFILTER)\u652f\u6301\nNFS      \u5f00\u542f\u4e86NFS(\u7f51\u7edc\u6587\u4ef6\u7cfb\u7edf)\u652f\u6301\nNUMA     \u5f00\u542f\u4e86NUMA(CONFIG_NUMA)\u652f\u6301\nPCI      \u5f00\u542f\u4e86PCI\u603b\u7ebf(CONFIG_PCI)\u652f\u6301\nPCIE     \u5f00\u542f\u4e86PCI-Express(CONFIG_PCIEPORTBUS)\u652f\u6301\nPNP      \u5f00\u542f\u4e86\u5373\u63d2\u5373\u7528(CONFIG_PNP)\u652f\u6301\nPV_OPS   \u5185\u6838\u672c\u8eab\u662f\u534a\u865a\u62df\u5316\u7684(paravirtualized)\nRAID     \u5f00\u542f\u4e86\u8f6fRAID(CONFIG_BLK_DEV_MD)\u652f\u6301\nSECURITY \u5f00\u542f\u4e86\u591a\u4e2a\u4e0d\u540c\u7684\u5b89\u5168\u6a21\u578b(CONFIG_SECURITY)\nSELINUX  \u5f00\u542f\u4e86SELinux(CONFIG_SECURITY_SELINUX)\u652f\u6301\nSLUB     \u5f00\u542f\u4e86SLUB\u5185\u5b58\u5206\u914d\u7ba1\u7406\u5668(CONFIG_SLUB)\nSMP      \u5f00\u542f\u4e86\u5bf9\u79f0\u591a\u5904\u7406\u5668(CONFIG_SMP)\u652f\u6301\nTPM      \u5f00\u542f\u4e86\u53ef\u4fe1\u8d56\u5e73\u53f0\u6a21\u5757(CONFIG_TCG_TPM)\u652f\u6301\nUMS      \u5f00\u542f\u4e86USB\u5927\u5bb9\u91cf\u5b58\u50a8\u8bbe\u5907(CONFIG_USB_STORAGE)\u652f\u6301\nUSB      \u5f00\u542f\u4e86USB(CONFIG_USB_SUPPORT)\u652f\u6301\nUSBHID   \u5f00\u542f\u4e86USB HID(CONFIG_USB_HID)\u652f\u6301\nVMMIO    \u5f00\u542f\u4e86\u4f7f\u7528\u5185\u5b58\u6620\u5c04\u673a\u5236\u7684virtio\u8bbe\u5907\u9a71\u52a8(CONFIG_VIRTIO_MMIO)\nVT       \u5f00\u542f\u4e86\u865a\u62df\u7ec8\u7aef(CONFIG_VT)\u652f\u6301\n</code></pre> <p>\u6b64\u5916\uff0c\u4e0b\u9762\u7684\u6807\u8bb0\u5728\u542b\u4e49\u4e0a\u4e0e\u4e0a\u9762\u7684\u6709\u6240\u4e0d\u540c\uff1a</p> <pre><code>BUGS    \u7528\u4e8e\u89e3\u51b3\u67d0\u4e9b\u7279\u5b9a\u786c\u4ef6\u7684\u7f3a\u9677\nKNL     \u662f\u4e00\u4e2a\u5185\u6838\u542f\u52a8\u9009\u9879\nBOOT    \u662f\u4e00\u4e2a\u5f15\u5bfc\u7a0b\u5e8f\u9009\u9879\n</code></pre> <p>\u6807\u8bb0\u4e3a\"BOOT\"\u7684\u9009\u9879\u5b9e\u9645\u4e0a\u7531\u5f15\u5bfc\u7a0b\u5e8f(\u4f8b\u5982GRUB)\u4f7f\u7528\uff0c\u5bf9\u5185\u6838\u672c\u8eab\u6ca1\u6709\u76f4\u63a5\u7684\u610f\u4e49\u3002\u5982\u679c\u6ca1\u6709\u7279\u522b\u7684\u9700\u6c42\uff0c\u8bf7\u4e0d\u8981\u4fee\u6539\u6b64\u7c7b\u9009\u9879\u7684\u8bed\u6cd5\uff0c\u66f4\u591a\u4fe1\u606f\u8bf7\u9605\u8bfb Documentation/x86/boot.txt \u6587\u6863\u3002</p> <p>\u8bf4\u660e\uff1a\u4e0b\u6587\u4e2d\u7684 [KMG] \u540e\u7f00\u8868\u793a 210, 220, 230 \u7684\u542b\u4e49\u3002</p>"},{"location":"Linux/system/Linux%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/#42-\u63a7\u5236\u53f0\u4e0e\u7ec8\u7aef","title":"4.2 \u63a7\u5236\u53f0\u4e0e\u7ec8\u7aef","text":"<ul> <li>[KNL]   console=\u8bbe\u5907\u53ca\u9009\u9879</li> </ul> <p>\u8bbe\u7f6e\u8f93\u51fa\u63a7\u5236\u53f0\u4f7f\u7528\u7684\u8bbe\u5907\u53ca\u9009\u9879\u3002\u4f8b\u5982\uff1attyN \u8868\u793a\u4f7f\u7528\u7b2cN\u4e2a\u865a\u62df\u63a7\u5236\u53f0\u3002\u5176\u5b83\u7528\u6cd5\u4e3b\u8981\u9488\u5bf9\u5d4c\u5165\u5f0f\u73af\u5883(Documentation/serial-console.txt)\u3002</p> <ul> <li>[KNL]   consoleblank=\u79d2\u6570</li> </ul> <p>\u63a7\u5236\u53f0\u591a\u957f\u65f6\u95f4\u65e0\u64cd\u4f5c\u540e\u9ed1\u5c4f\uff0c\u9ed8\u8ba4\u503c\u662f600\u79d2\uff0c\u8bbe\u4e3a0\u8868\u793a\u7981\u6b62\u9ed1\u5c4f\u3002</p> <ul> <li>[HW]   no_console_suspend</li> </ul> <p>\u6c38\u8fdc\u4e5f\u4e0d\u8981\u5c06\u63a7\u5236\u53f0\u8fdb\u5165\u4f11\u7720\u72b6\u6001\u3002\u56e0\u4e3a\u5f53\u63a7\u5236\u53f0\u8fdb\u5165\u4f11\u7720\u4e4b\u540e\uff0c\u6240\u6709\u5185\u6838\u7684\u6d88\u606f\u5c31\u90fd\u770b\u4e0d\u89c1\u4e86(\u5305\u62ec\u4e32\u53e3\u4e0eVGA)\u3002\u5f00\u542f\u6b64\u9009\u9879\u6709\u52a9\u4e8e\u8c03\u8bd5\u7cfb\u7edf\u5728\u4f11\u7720/\u5524\u9192\u4e2d\u53d1\u751f\u7684\u6545\u969c\u3002</p> <ul> <li>[VT]   vt.default_utf8={0|1}</li> </ul> <p>\u662f\u5426\u5c06\u6240\u6709TTY\u90fd\u9ed8\u8ba4\u8bbe\u7f6e\u4e3aUTF-8\u6a21\u5f0f\u3002\u9ed8\u8ba4\u503c\"1\"\u8868\u793a\u5c06\u6240\u6709\u65b0\u6253\u5f00\u7684\u7ec8\u7aef\u90fd\u8bbe\u7f6e\u4e3aUTF-8\u6a21\u5f0f\u3002</p>"},{"location":"Linux/system/Linux%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/#43-\u65e5\u5fd7\u4e0e\u8c03\u8bd5","title":"4.3 \u65e5\u5fd7\u4e0e\u8c03\u8bd5","text":"<ul> <li>earlyprintk=\u8bbe\u5907[,keep]</li> </ul> <p>\u4f7f\u7528\u54ea\u4e2a\u8bbe\u5907\u663e\u793a\u65e9\u671f\u7684\u5f15\u5bfc\u4fe1\u606f\uff0c\u4e3b\u8981\u7528\u4e8e\u8c03\u8bd5\u786c\u4ef6\u6545\u969c\u3002\u6b64\u9009\u9879\u9ed8\u8ba4\u5e76\u672a\u5f00\u542f\uff0c\u56e0\u4e3a\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\u5e76\u4e0d\u80fd\u6b63\u5e38\u5de5\u4f5c\u3002 \u5728\u4f20\u7edf\u7684\u63a7\u5236\u53f0\u521d\u59cb\u5316\u4e4b\u524d\uff0c\u5728\u54ea\u4e2a\u8bbe\u5907\u4e0a\u663e\u793a\u5185\u6838\u65e5\u5fd7\u4fe1\u606f\u3002\u4e0d\u4f7f\u7528\u6b64\u9009\u9879\uff0c\u90a3\u4e48\u4f60\u5c06\u6c38\u8fdc\u6ca1\u673a\u4f1a\u770b\u89c1\u8fd9\u4e9b\u4fe1\u606f\u3002 \u5728\u5c3e\u90e8\u52a0\u4e0a\",keep\"\u9009\u9879\u8868\u793a\u5728\u771f\u6b63\u7684\u5185\u6838\u63a7\u5236\u53f0\u521d\u59cb\u5316\u5e76\u63a5\u7ba1\u7cfb\u7edf\u540e\uff0c\u4e0d\u4f1a\u62b9\u6389\u672c\u9009\u9879\u6d88\u606f\u7684\u663e\u793a\u3002 earlyprintk=vga \u8868\u793a\u5728VGA\u4e0a\u663e\u793a\u5185\u6838\u65e5\u5fd7\u4fe1\u606f\uff0c\u8fd9\u662f\u6700\u5e38\u7528\u7684\u9009\u9879\uff0c\u4f46\u4e0d\u80fd\u7528\u4e8eEFI\u73af\u5883\u3002 earlyprintk=efi v3.13\u65b0\u589e\uff0c\u8868\u793a\u5c06\u9519\u8bef\u65e5\u5fd7\u5199\u5165EFI framebuffer\uff0c\u4e13\u7528\u4e8eEFI\u73af\u5883\u3002 earlyprintk=xen \u4ec5\u53ef\u7528\u4e8eXEN\u7684\u534a\u865a\u62df\u5316\u5ba2\u6237\u673a\u3002</p> <ul> <li>loglevel={0|1|2|3|4|5|6|7}</li> </ul> <p>\u8bbe\u7f6e\u5185\u6838\u65e5\u5fd7\u7684\u7ea7\u522b\uff0c\u6240\u6709\u5c0f\u4e8e\u8be5\u6570\u5b57\u7684\u5185\u6838\u4fe1\u606f(\u5177\u6709\u66f4\u9ad8\u4f18\u5148\u7ea7\u7684\u4fe1\u606f)\u90fd\u5c06\u5728\u63a7\u5236\u53f0\u4e0a\u663e\u793a\u51fa\u6765\u3002\u8fd9\u4e2a\u7ea7\u522b\u53ef\u4ee5\u4f7f\u7528 klogd \u7a0b\u5e8f\u6216\u8005\u4fee\u6539 /proc/sys/kernel/printk \u6587\u4ef6\u8fdb\u884c\u8c03\u6574\u3002\u53d6\u503c\u8303\u56f4\u662f\"0\"(\u4e0d\u663e\u793a\u4efb\u4f55\u4fe1\u606f)\u5230\"7\"(\u663e\u793a\u6240\u6709\u7ea7\u522b\u7684\u4fe1\u606f)\u3002\u5efa\u8bae\u81f3\u5c11\u8bbe\u4e3a\"4\"(WARNING)\u3002[\u63d0\u793a]\u7ea7\u522b\"7\"\u8981\u6c42\u7f16\u8bd1\u65f6\u52a0\u5165\u4e86\u8c03\u8bd5\u652f\u6301\u3002</p> <ul> <li>[KNL]   ignore_loglevel</li> </ul> <p>\u5ffd\u7565\u5185\u6838\u65e5\u5fd7\u7b49\u7ea7\u7684\u8bbe\u7f6e\uff0c\u5411\u63a7\u5236\u53f0\u8f93\u51fa\u6240\u6709\u5185\u6838\u6d88\u606f\u3002\u4ec5\u7528\u4e8e\u8c03\u8bd5\u76ee\u7684\u3002</p> <ul> <li>[KNL]   debug</li> </ul> <p>\u5c06\u5f15\u5bfc\u8fc7\u7a0b\u4e2d\u7684\u6240\u6709\u8c03\u8bd5\u4fe1\u606f\u90fd\u663e\u793a\u5728\u63a7\u5236\u53f0\u4e0a\u3002\u76f8\u5f53\u4e8e\u8bbe\u7f6e\"loglevel=7\"(DEBUG)\u3002</p> <ul> <li>[KNL]   quiet</li> </ul> <p>\u9759\u9ed8\u6a21\u5f0f\u3002\u76f8\u5f53\u4e8e\u8bbe\u7f6e\"loglevel=4\"(WARNING)\u3002</p> <ul> <li>log_buf_len=n[KMG]</li> </ul> <p>\u5185\u6838\u65e5\u5fd7\u7f13\u51b2\u533a\u7684\u5927\u5c0f\u3002\"n\"\u5fc5\u987b\u662f2\u7684\u6574\u6570\u500d(\u5426\u5219\u4f1a\u88ab\u81ea\u52a8\u4e0a\u8c03\u5230\u6700\u63a5\u8fd1\u76842\u7684\u6574\u6570\u500d)\u3002\u8be5\u503c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5185\u6838\u914d\u7f6e\u9009\u9879CONFIG_LOG_BUF_SHIFT\u6765\u8bbe\u7f6e\u3002</p> <ul> <li>[KNL]   initcall_debug</li> </ul> <p>\u8ddf\u8e2a\u6240\u6709\u5185\u6838\u521d\u59cb\u5316\u8fc7\u7a0b\u4e2d\u8c03\u7528\u7684\u51fd\u6570\u3002\u6709\u52a9\u4e8e\u8bca\u65ad\u5185\u6838\u5728\u542f\u52a8\u8fc7\u7a0b\u4e2d\u6b7b\u5728\u4e86\u90a3\u4e2a\u51fd\u6570\u4e0a\u9762\u3002</p> <ul> <li>kstack=N</li> </ul> <p>\u5728\u5185\u6838\u5f02\u5e38(oops)\u65f6\uff0c\u5e94\u8be5\u6253\u5370\u51fa\u5185\u6838\u6808\u4e2d\u591a\u5c11\u4e2a\u5b57(word)\u5230\u5f02\u5e38\u8f6c\u50a8\u4e2d\u3002\u4ec5\u4f9b\u8c03\u8bd5\u4f7f\u7528\u3002</p> <ul> <li>[KNL]   kmemleak={on|off}</li> </ul> <p>\u662f\u5426\u5f00\u542f\u68c0\u6d4b\u5185\u6838\u5185\u5b58\u6cc4\u6f0f\u7684\u529f\u80fd(CONFIG_DEBUG_KMEMLEAK)\uff0c\u9ed8\u8ba4\u4e3a\"on\"\uff0c\u4ec5\u4f9b\u8c03\u8bd5\u4f7f\u7528\u3002 \u68c0\u6d4b\u65b9\u6cd5\u7c7b\u4f3c\u4e8e\u8ddf\u8e2a\u5185\u5b58\u6536\u96c6\u5668\uff0c\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0b\u6bcf10\u5206\u949f(\u9ed8\u8ba4\u503c)\u626b\u63cf\u5185\u5b58\uff0c\u5e76\u6253\u5370\u53d1\u73b0\u65b0\u7684\u672a\u5f15\u7528\u7684\u5bf9\u8c61\u7684\u6570\u91cf\u3002</p> <ul> <li>[KNL]   memtest=\u6574\u6570</li> </ul> <p>\u8bbe\u7f6e\u5185\u5b58\u6d4b\u8bd5(CONFIG_MEMTEST)\u7684\u8f6e\u6570\u3002\"0\"\u8868\u793a\u7981\u6b62\u6d4b\u8bd5\u3002\u4ec5\u5728\u4f60\u786e\u5b9e\u77e5\u9053\u8fd9\u662f\u4ec0\u4e48\u4e1c\u897f\u5e76\u4e14\u786e\u5b9e\u9700\u8981\u7684\u65f6\u5019\u518d\u5f00\u542f\u3002</p> <ul> <li>norandmaps</li> </ul> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5185\u6838\u4f1a\u968f\u673a\u5316\u7a0b\u5e8f\u7684\u542f\u52a8\u5730\u5740\uff0c\u4e5f\u5c31\u662f\u6bcf\u4e00\u6b21\u5206\u914d\u7ed9\u7a0b\u5e8f\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u90fd\u4e0d\u4e00\u6837\uff0c\u4e3b\u8981\u76ee\u7684\u662f\u4e3a\u4e86\u9632\u6b62\u7f13\u51b2\u533a\u6ea2\u51fa\u653b\u51fb\u3002\u4f46\u662f\u8fd9\u4e5f\u7ed9\u7a0b\u5e8f\u8c03\u8bd5\u589e\u52a0\u4e86\u9ebb\u70e6\uff0c\u6b64\u9009\u9879(\u76f8\u5f53\u4e8e\"echo 0 &gt; /proc/sys/kernel/randomize_va_space\")\u7684\u76ee\u7684\u5c31\u662f\u7981\u7528\u8be5\u529f\u80fd\u4ee5\u65b9\u4fbf\u8c03\u8bd5\u3002</p> <ul> <li>[PNP]   pnp.debug=1</li> </ul> <p>\u5f00\u542fPNP\u8c03\u8bd5\u4fe1\u606f(\u9700\u8981\u5185\u6838\u5df2\u5f00\u542fCONFIG_PNP_DEBUG_MESSAGES\u9009\u9879)\uff0c\u4ec5\u7528\u4e8e\u8c03\u8bd5\u76ee\u7684\u3002\u4e5f\u53ef\u5728\u8fd0\u884c\u65f6\u901a\u8fc7 /sys/module/pnp/parameters/debug \u6765\u63a7\u5236\u3002</p> <ul> <li>show_msr=CPU\u6570</li> </ul> <p>\u663e\u793a\u542f\u52a8\u65f6\u7531BIOS\u521d\u59cb\u5316\u7684MSR(Model-Specific Register)\u5bc4\u5b58\u5668\u8bbe\u7f6e\u3002CPU\u6570\u8bbe\u4e3a\"1\"\u8868\u793a\u4ec5\u663e\u793a\"boot CPU\"\u7684\u8bbe\u7f6e\u3002</p> <ul> <li>printk.time={0|1}</li> </ul> <p>\u662f\u5426\u5728\u6bcf\u4e00\u884cprintk\u8f93\u51fa\u524d\u90fd\u52a0\u4e0a\u65f6\u95f4\u6233\uff0c\u4ec5\u4f9b\u8c03\u8bd5\u4f7f\u7528\u3002\u9ed8\u8ba4\u503c\u662f\"0\"(\u4e0d\u6dfb\u52a0)</p> <ul> <li>boot_delay=\u6beb\u79d2\u6570</li> </ul> <p>\u5728\u542f\u52a8\u8fc7\u7a0b\u4e2d\uff0c\u4e3a\u6bcf\u4e00\u4e2aprintk\u52a8\u4f5c\u5ef6\u8fdf\u6307\u5b9a\u7684\u6beb\u79d2\u6570\uff0c\u53d6\u503c\u8303\u56f4\u662f0-10000\uff0c\u8d85\u51fa\u8fd9\u4e2a\u8303\u56f4\u5c06\u7b49\u4ef7\u4e8e\"0\"(\u65e0\u5ef6\u8fdf)\u3002\u4ec5\u7528\u4e8e\u8c03\u8bd5\u76ee\u7684\u3002</p> <ul> <li>pause_on_oops=\u79d2\u6570</li> </ul> <p>\u5f53\u5185\u6838\u53d1\u751f\u5f02\u5e38\u65f6\uff0c\u6302\u8d77\u6240\u6709CPU\u7684\u65f6\u95f4\u3002\u5f53\u5f02\u5e38\u4fe1\u606f\u592a\u591a\uff0c\u5c4f\u5e55\u6301\u7eed\u6eda\u52a8\u65f6\uff0c\u8fd9\u4e2a\u9009\u9879\u5c31\u5f88\u6709\u7528\u5904\u4e86\u3002\u4e3b\u8981\u7528\u4e8e\u8c03\u8bd5\u76ee\u7684\u3002</p>"},{"location":"Linux/system/Linux%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/#44-\u5f02\u5e38\u68c0\u6d4b\u4e0e\u5904\u7406","title":"4.4 \u5f02\u5e38\u68c0\u6d4b\u4e0e\u5904\u7406","text":"<ul> <li>[MCE] mce=off</li> </ul> <p>\u5f7b\u5e95\u7981\u7528MCE(CONFIG_X86_MCE)</p> <ul> <li>[MCE] mce=dont_log_ce</li> </ul> <p>\u4e0d\u4e3a\u5df2\u7ea0\u6b63\u9519\u8bef(corrected error)\u8bb0\u5f55\u65e5\u5fd7\u3002</p> <ul> <li>[MCE] mce=\u5bb9\u9519\u7ea7\u522b[,\u8d85\u65f6]</li> </ul> <p>\u5bb9\u9519\u7ea7\u522b(\u8fd8\u53ef\u901a\u8fc7sysfs\u8bbe\u7f6e)\uff1a 0 \u5728\u51fa\u73b0\u672a\u80fd\u7ea0\u6b63\u7684\u9519\u8bef\u65f6panic\uff0c\u8bb0\u5f55\u6240\u6709\u5df2\u7ea0\u6b63\u7684\u9519\u8bef 1(\u9ed8\u8ba4\u503c) \u5728\u51fa\u73b0\u672a\u80fd\u7ea0\u6b63\u7684\u9519\u8bef\u65f6panic\u6216SIGBUS\uff0c\u8bb0\u5f55\u6240\u6709\u5df2\u7ea0\u6b63\u7684\u9519\u8bef 2 \u5728\u51fa\u73b0\u672a\u80fd\u7ea0\u6b63\u7684\u9519\u8bef\u65f6SIGBUS\u6216\u8bb0\u5f55\u65e5\u5fd7\uff0c\u8bb0\u5f55\u6240\u6709\u5df2\u7ea0\u6b63\u7684\u9519\u8bef 3 \u4ece\u4e0dpanic\u6216SIGBUS\uff0c\u8bb0\u5f55\u6240\u6709\u65e5\u5fd7\u3002\u4ec5\u7528\u4e8e\u8c03\u8bd5\u76ee\u7684\u3002 \u8d85\u65f6(\u5355\u4f4d\u662f\u5fae\u79d2[\u767e\u4e07\u5206\u4e4b\u4e00\u79d2])\uff1a\u5728machine check\u65f6\u7b49\u5f85\u5176\u5b83CPU\u7684\u65f6\u957f\uff0c\"0\"\u8868\u793a\u4e0d\u7b49\u5f85\u3002</p> <ul> <li>[ACPI] erst_disable</li> </ul> <p>\u7981\u7528ERST(Error Record Serialization Table)\u652f\u6301\u3002\u4e3b\u8981\u7528\u4e8e\u89e3\u51b3\u67d0\u4e9b\u6709\u7f3a\u9677\u7684BIOS\u5bfc\u81f4\u7684ERST\u6545\u969c\u3002</p> <ul> <li>[ACPI] hest_disable</li> </ul> <p>\u7981\u7528HEST(Hardware Error Source Table)\u652f\u6301\u3002\u4e3b\u8981\u7528\u4e8e\u89e3\u51b3\u67d0\u4e9b\u6709\u7f3a\u9677\u7684BIOS\u5bfc\u81f4\u7684HEST\u6545\u969c\u3002</p> <ul> <li>[KNL] nosoftlockup</li> </ul> <p>\u7981\u6b62\u5185\u6838\u8fdb\u884c\u8f6f\u6b7b\u9501\u68c0\u6d4b</p> <ul> <li>[KNL] softlockup_panic={0|1}</li> </ul> <p>\u662f\u5426\u5728\u68c0\u6d4b\u5230\u8f6f\u6b7b\u9501(soft-lockup)\u7684\u65f6\u5019\u8ba9\u5185\u6838panic\uff0c\u5176\u9ed8\u8ba4\u503c\u7531 CONFIG_BOOTPARAM_SOFTLOCKUP_PANIC_VALUE \u786e\u5b9a</p> <ul> <li>[KNL] nowatchdog</li> </ul> <p>\u7981\u6b62\u786c\u6b7b\u9501\u68c0\u6d4b(NMI watchdog)</p> <ul> <li>[KNL,BUGS] nmi_watchdog={0|panic|nopanic}</li> </ul> <p>\u914d\u7f6enmi_watchdog(\u4e0d\u53ef\u5c4f\u853d\u4e2d\u65ad\u770b\u95e8\u72d7)\u3002\u66f4\u591a\u4fe1\u606f\u53ef\u67e5\u770b\"lockup-watchdogs.txt\"\u6587\u6863\u3002 0 \u8868\u793a\u5173\u95ed\u770b\u95e8\u72d7\uff1b panic \u8868\u793a\u51fa\u73b0\u770b\u95e8\u72d7\u8d85\u65f6(\u957f\u65f6\u95f4\u6ca1\u5582\u72d7)\u7684\u65f6\u5019\u89e6\u53d1\u5185\u6838\u9519\u8bef\uff0c\u901a\u5e38\u548c\"panic=\"\u914d\u5408\u4f7f\u7528\uff0c\u4ee5\u5b9e\u73b0\u5728\u7cfb\u7edf\u51fa\u73b0\u9501\u6b7b\u7684\u65f6\u5019\u81ea\u52a8\u91cd\u542f\u3002 nopanic \u6b63\u597d\u76f8\u53cd\uff0c\u8868\u793a\u5373\u4f7f\u51fa\u73b0\u770b\u95e8\u72d7\u8d85\u65f6(\u957f\u65f6\u95f4\u6ca1\u5582\u72d7)\uff0c\u4e5f\u4e0d\u89e6\u53d1\u5185\u6838\u9519\u8bef\u3002</p> <ul> <li>unknown_nmi_panic</li> </ul> <p>\u5728\u6536\u5230\u672a\u77e5\u7684NMI(\u4e0d\u53ef\u5c4f\u853d\u4e2d\u65ad)\u65f6\u76f4\u63a5panic</p> <ul> <li>oops=panic</li> </ul> <p>\u5728\u5185\u6838oops\u65f6\u76f4\u63a5panic(\u800c\u9ed8\u8ba4\u662f\u4ec5\u4ec5\u6740\u6b7boops\u8fdb\u7a0b[\u8fd9\u6837\u505a\u4f1a\u6709\u5f88\u5c0f\u7684\u6982\u7387\u5bfc\u81f4\u6b7b\u9501])\uff0c\u800c\u4e14\u8fd9\u540c\u6837\u4e5f\u4f1a\u5bfc\u81f4\u5728\u53d1\u751fMCE(CONFIG_X86_MCE)\u65f6\u76f4\u63a5panic\u3002\u4e3b\u8981\u76ee\u7684\u662f\u548c\"panic=\"\u9009\u9879\u8fde\u7528\u4ee5\u5b9e\u73b0\u81ea\u52a8\u91cd\u542f\u3002</p> <ul> <li>[KNL] panic=\u79d2\u6570</li> </ul> <p>\u5185\u6838\u5728\u9047\u5230panic\u65f6\u7b49\u5f85\u91cd\u542f\u7684\u884c\u4e3a\uff1a</p> <p>\u79d2\u6570&gt;0 \u7b49\u5f85\u6307\u5b9a\u7684\u79d2\u6570\u540e\u91cd\u542f </p> <p>\u79d2\u6570=0(\u9ed8\u8ba4\u503c) \u53ea\u662f\u7b80\u5355\u7684\u6302\u8d77\uff0c\u800c\u6c38\u4e0d\u91cd\u542f </p> <p>\u79d2\u6570&lt;0 \u7acb\u5373\u91cd\u542f</p> <p>## 4.5 \u65f6\u949f(Timer)</p> <p>\u65f6\u949f(Timer)\u7684\u529f\u80fd\u6709\u4e24\u4e2a\uff1a(1)\u5b9a\u65f6\u89e6\u53d1\u4e2d\u65ad\uff1b(2)\u7ef4\u62a4\u548c\u8bfb\u53d6\u5f53\u524d\u65f6\u95f4\u3002x86_64\u5e73\u53f0\u5e38\u89c1\u7684\u65f6\u949f\u786c\u4ef6\u6709\u4ee5\u4e0b\u8fd9\u4e9b\uff1a   RTC(Real Time Clock) \u5b9e\u65f6\u65f6\u949f\u7684\u72ec\u7279\u4e4b\u5904\u5728\u4e8e\uff0cRTC\u662f\u4e3b\u677f\u4e0a\u4e00\u5757\u7535\u6c60\u4f9b\u7535\u7684CMOS\u82af\u7247(\u7cbe\u5ea6\u4e00\u822c\u53ea\u5230\u79d2\u7ea7)\uff0cRTC(Clock)\u5410\u51fa\u6765\u7684\u662f\"\u65f6\u523b\"(\u4f8b\u5982\"2014-2-22 23:38:44\")\uff0c\u800c\u5176\u4ed6\u786c\u4ef6\u65f6\u949f(Timer)\u5410\u51fa\u6765\u7684\u662f\"\u65f6\u957f\"(\u6211\u8d70\u8fc7\u4e86XX\u4e2a\u5468\u671f\uff0c\u6309\u7167\u6211\u7684\u9891\u7387\uff0c\u5e94\u8be5\u662f10\u79d2\u949f)\u3002   PIT(Programmable Interval Timer) PIT\u662f\u6700\u53e4\u8001\u7684\u65f6\u949f\u6e90\uff0c\u4ea7\u751f\u5468\u671f\u6027\u7684\u65f6\u949f\u4e2d\u65ad(IRQ0)\uff0c\u7cbe\u5ea6\u5728100-1000Hz\uff0c\u73b0\u5728\u57fa\u672c\u5df2\u7ecf\u88abHPET\u53d6\u4ee3\u3002   APIC Timer \u8fd9\u662fPIT\u9488\u5bf9\u591aCPU\u73af\u5883\u7684\u5347\u7ea7\uff0c\u6bcf\u4e2aCPU\u4e0a\u90fd\u6709\u4e00\u4e2aAPIC Timer(\u800cPIT\u5219\u662f\u6240\u6709CPU\u5171\u4eab\u7684)\uff0c\u4f46\u662f\u5b83\u7ecf\u5e38\u6709BUG\u4e14\u7cbe\u5ea6\u4e5f\u4e0d\u9ad8(3MHz\u5de6\u53f3)\uff0c\u6240\u5b9e\u9645\u5f88\u5c11\u4f7f\u7528\u3002   ACPI Timer(Power Management Timer) \u5b83\u552f\u4e00\u7684\u529f\u80fd\u5c31\u662f\u4e3a\u6bcf\u4e2a\u65f6\u949f\u5468\u671f\u63d0\u4f9b\u4e00\u4e2a\u65f6\u95f4\u6233\uff0c\u7528\u4e8e\u63d0\u4f9b\u4e0e\u5904\u7406\u5668\u901f\u5ea6\u65e0\u5173\u7684\u53ef\u9760\u65f6\u95f4\u6233\u3002\u4f46\u5176\u7cbe\u5ea6\u5e76\u4e0d\u9ad8(3.579545MHz)\u3002   HPET(High Precision Event Timer) HPET\u63d0\u4f9b\u4e86\u66f4\u9ad8\u7684\u7cbe\u5ea6(14.31818MHz)\u4ee5\u53ca\u66f4\u5bbd\u7684\u8ba1\u6570\u5668(64\u4f4d)\u3002HPET\u53ef\u4ee5\u66ff\u4ee3\u524d\u8ff0\u9664RTC\u4e4b\u5916\u7684\u6240\u6709\u65f6\u949f\u786c\u4ef6(Timer)\uff0c\u56e0\u4e3a\u5b83\u65e2\u80fd\u5b9a\u65f6\u89e6\u53d1\u4e2d\u65ad\uff0c\u53c8\u80fd\u7ef4\u62a4\u548c\u8bfb\u53d6\u5f53\u524d\u65f6\u95f4\u3002\u4e00\u4e2aHPET\u5305\u542b\u4e86\u4e00\u4e2a\u56fa\u5b9a\u9891\u7387\u7684\u6570\u503c\u9012\u589e\u7684\u8ba1\u6570\u5668\u4ee5\u53ca3-32\u4e2a\u72ec\u7acb\u8ba1\u6570\u5668\uff0c\u6bcf\u4e2a\u8ba1\u6570\u5668\u53c8\u5305\u542b\u4e86\u4e00\u4e2a\u6bd4\u8f83\u5668\u548c\u4e00\u4e2a\u5bc4\u5b58\u5668\uff0c\u5f53\u4e24\u8005\u6570\u503c\u76f8\u7b49\u65f6\u5c31\u4f1a\u89e6\u53d1\u4e2d\u65ad\u3002HPET\u7684\u51fa\u73b0\u5c06\u5141\u8bb8\u5220\u9664\u82af\u7247\u7ec4\u4e2d\u7684\u4e00\u4e9b\u5197\u4f59\u7684\u65e7\u5f0f\u786c\u4ef6\u30022006\u5e74\u4e4b\u540e\u7684\u4e3b\u677f\u57fa\u672c\u90fd\u5df2\u652f\u6301HPET\u3002   TSC(Time Stamp Counter) TSC\u662f\u4f4d\u4e8eCPU\u91cc\u9762\u7684\u4e00\u4e2a64\u4f4d\u5bc4\u5b58\u5668\uff0c\u4e0e\u4f20\u7edf\u7684\u5468\u671f\u6027\u65f6\u949f\u4e0d\u540c\uff0cTSC\u5e76\u4e0d\u89e6\u53d1\u4e2d\u65ad\uff0c\u5b83\u662f\u4ee5\u8ba1\u6570\u5668\u5f62\u5f0f\u5b58\u5728\u7684\u5355\u6b65\u9012\u589e\u6027\u65f6\u949f\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5468\u671f\u6027\u65f6\u949f\u662f\u901a\u8fc7\u5468\u671f\u6027\u89e6\u53d1\u4e2d\u65ad\u8fbe\u5230\u8ba1\u65f6\u76ee\u7684\uff0c\u5982\u5fc3\u8df3\u4e00\u822c\u3002\u800c\u5355\u6b65\u9012\u589e\u65f6\u949f\u5219\u4e0d\u53d1\u9001\u4e2d\u65ad\uff0c\u53d6\u800c\u4ee3\u4e4b\u7684\u662f\u7531\u8f6f\u4ef6\u81ea\u5df1\u5728\u9700\u8981\u7684\u65f6\u5019\u53bb\u4e3b\u52a8\u8bfb\u53d6TSC\u5bc4\u5b58\u5668\u7684\u503c\u6765\u83b7\u5f97\u65f6\u95f4\u3002TSC\u7684\u7cbe\u5ea6(\u7eb3\u79d2\u7ea7)\u8fdc\u8d85HPET\u5e76\u4e14\u901f\u5ea6\u66f4\u5feb\uff0c\u4f46\u4ec5\u80fd\u5728\u8f83\u65b0\u7684CPU(Sandy Bridge\u4e4b\u540e)\u4e0a\u4f7f\u7528\u3002</p> <ul> <li>[HW,ACPI]   acpi_skip_timer_override</li> </ul> <p>\u7528\u4e8e\u89e3\u51b3\u67d0\u4e9b\u6709\u7f3a\u9677\u7684Nvidia nForce2 BIOS\u4e2d\u7684\u8ba1\u65f6\u5668\u8986\u76d6\u95ee\u9898(\u4f8b\u5982\u5f00\u542fACPI\u540e\u9891\u7e41\u6b7b\u673a\u6216\u65f6\u949f\u6545\u969c)\u3002</p> <ul> <li>[HW,ACPI]   acpi_use_timer_override</li> </ul> <p>\u7528\u4e8e\u89e3\u51b3\u67d0\u4e9b\u6709\u7f3a\u9677\u7684Nvidia nForce5 BIOS\u4e2d\u7684\u8ba1\u65f6\u5668\u8986\u76d6\u95ee\u9898(\u4f8b\u5982\u5f00\u542fACPI\u540e\u9891\u7e41\u6b7b\u673a\u6216\u65f6\u949f\u6545\u969c)\u3002</p> <ul> <li>[APIC]   no_timer_check</li> </ul> <p>\u7981\u6b62\u8fd0\u884c\u5185\u6838\u4e2d\u65f6\u949fIRQ\u6e90\u7f3a\u9677\u68c0\u6d4b\u4ee3\u7801\u3002\u4e3b\u8981\u7528\u4e8e\u89e3\u51b3\u67d0\u4e9bAMD\u5e73\u53f0\u7684CPU\u5360\u7528\u8fc7\u9ad8\u4ee5\u53ca\u65f6\u949f\u8fc7\u5feb\u7684\u6545\u969c\u3002</p> <ul> <li>pmtmr=\u5341\u516d\u8fdb\u5236\u7aef\u53e3\u53f7</li> </ul> <p>\u624b\u52a8\u6307\u5b9apmtimer(CONFIG_X86_PM_TIMER)\u7684I/O\u7aef\u53e3(16\u8fdb\u5236\u503c)\uff0c\u4f8b\u5982\uff1apmtmr=0x508</p> <ul> <li>acpi_pm_good</li> </ul> <p>\u8df3\u8fc7pmtimer(CONFIG_X86_PM_TIMER)\u7684bug\u68c0\u6d4b\uff0c\u5f3a\u5236\u5185\u6838\u8ba4\u4e3a\u8fd9\u53f0\u673a\u5668\u7684pmtimer\u6ca1\u6709\u6bdb\u75c5\u3002\u7528\u4e8e\u89e3\u51b3\u67d0\u4e9b\u6709\u7f3a\u9677\u7684BIOS\u5bfc\u81f4\u7684\u6545\u969c\u3002</p> <ul> <li>[APIC]   apicpmtimer</li> </ul> <p>\u4f7f\u7528pmtimer(CONFIG_X86_PM_TIMER)\u6765\u6821\u51c6APIC timer\u3002\u6b64\u9009\u9879\u9690\u542b\u4e86\"apicmaintimer\"\u3002\u7528\u4e8ePIT timer\u5f7b\u5e95\u574f\u6389\u7684\u573a\u5408\u3002</p> <ul> <li>[APIC]   apicmaintimer   noapicmaintimer</li> </ul> <p>apicmaintimer \u5c06APIC timer\u7528\u4e8e\u8ba1\u65f6(\u800c\u4e0d\u662fPIT/HPET\u4e2d\u65ad)\u3002\u8fd9\u4e3b\u8981\u7528\u4e8ePIT/HPET\u4e2d\u65ad\u4e0d\u53ef\u9760\u7684\u573a\u5408\u3002 noapicmaintimer \u4e0d\u5c06APIC timer\u7528\u4e8e\u8ba1\u65f6(\u800c\u662f\u4f7f\u7528PIT/HPET\u4e2d\u65ad)\u3002\u8fd9\u662f\u9ed8\u8ba4\u503c\u3002\u4f46\u6709\u65f6\u5019\u4f9d\u7136\u9700\u8981\u660e\u786e\u6307\u5b9a\u3002</p> <ul> <li>[APIC]   lapic_timer_c2_ok</li> </ul> <p>\u6309\u7167ACPI\u89c4\u8303\u7684\u8981\u6c42\uff0clocal APIC Timer \u4e0d\u80fd\u5728C2\u4f11\u7720\u72b6\u6001\u4e0b\u5173\u95ed\uff0c\u4f46\u53ef\u4ee5\u5728C3\u4f11\u7720\u72b6\u6001\u4e0b\u5173\u95ed\u3002\u4f46\u67d0\u4e9bBIOS(\u4e3b\u8981\u662fAMD\u5e73\u53f0)\u4f1a\u5728\u5411\u64cd\u4f5c\u7cfb\u7edf\u62a5\u544aCPU\u8fdb\u5165C2\u4f11\u7720\u72b6\u6001\u65f6\uff0c\u5b9e\u9645\u8fdb\u5165C3\u4f11\u7720\u72b6\u6001\u3002\u56e0\u6b64\uff0c\u5185\u6838\u9ed8\u8ba4\u91c7\u53d6\u4e86\u4fdd\u5b88\u7684\u5047\u5b9a\uff1a\u8ba4\u4e3a local APIC Timer \u5728C2/C3\u72b6\u6001\u65f6\u7686\u5904\u4e8e\u5173\u95ed\u72b6\u6001\u3002\u5982\u679c\u4f60\u786e\u5b9a\u4f60\u7684BIOS\u6ca1\u6709\u8fd9\u4e2a\u95ee\u9898\uff0c\u90a3\u4e48\u53ef\u4ee5\u4f7f\u7528\u6b64\u9009\u9879\u660e\u786e\u544a\u8bc9\u5185\u6838\uff0c\u5373\u4f7fCPU\u5728C2\u4f11\u7720\u72b6\u6001\uff0clocal APIC Timer \u4e5f\u4f9d\u7136\u53ef\u7528\u3002</p> <ul> <li>[APIC]   noapictimer</li> </ul> <p>\u7981\u7528CPU Local APIC Timer</p> <p>enable_timer_pin_1 disable_timer_pin_1</p> <p>\u5f00\u542f/\u5173\u95edAPIC\u5b9a\u65f6\u5668\u7684PIN1\uff0c\u5185\u6838\u5c06\u5c3d\u53ef\u80fd\u81ea\u52a8\u63a2\u6d4b\u6b63\u786e\u7684\u503c\u3002\u4f46\u6709\u65f6\u9700\u8981\u624b\u52a8\u6307\u5b9a\u4ee5\u89e3\u51b3\u67d0\u4e9b\u6709\u7f3a\u9677\u7684ATI\u82af\u7247\u7ec4\u6545\u969c\u3002</p> <ul> <li>clocksource={jiffies|acpi_pm|hpet|tsc}</li> </ul> <p>\u5f3a\u5236\u4f7f\u7528\u6307\u5b9a\u7684\u65f6\u949f\u6e90\uff0c\u4ee5\u4ee3\u66ff\u5185\u6838\u9ed8\u8ba4\u7684\u65f6\u949f\u6e90\u3002 jiffies \u6700\u5dee\u7684\u65f6\u949f\u6e90\uff0c\u53ea\u80fd\u4f5c\u4e3a\u6700\u540e\u7684\u9009\u62e9\u3002 acpi_pm [ACPI]\u7b26\u5408ACPI\u89c4\u8303\u7684\u4e3b\u677f\u90fd\u63d0\u4f9b\u7684\u786c\u4ef6\u65f6\u949f\u6e90(CONFIG_X86_PM_TIMER)\uff0c\u63d0\u4f9b3.579545MHz\u56fa\u5b9a\u9891\u7387\uff0c\u8fd9\u662f\u4f20\u7edf\u7684\u786c\u4ef6\u65f6\u949f\u53d1\u751f\u5668\u3002 hpet \u4e00\u79cd\u53d6\u4ee3\u4f20\u7edf\"acpi_pm\"\u7684\u9ad8\u7cbe\u5ea6\u786c\u4ef6\u65f6\u949f\u6e90(CONFIG_HPET)\uff0c\u63d0\u4f9b14.31818MHz\u56fa\u5b9a\u9891\u7387\u30022007\u5e74\u4ee5\u540e\u7684\u82af\u7247\u7ec4\u4e00\u822c\u90fd\u652f\u6301\u3002 tsc TSC(Time Stamp Counter)\u7684\u4e3b\u4f53\u662f\u4f4d\u4e8eCPU\u91cc\u9762\u7684\u4e00\u4e2a64\u4f4dTSC\u5bc4\u5b58\u5668\uff0c\u4e0e\u4f20\u7edf\u7684\u4ee5\u4e2d\u65ad\u5f62\u5f0f\u5b58\u5728\u7684\u5468\u671f\u6027\u65f6\u949f\u4e0d\u540c\uff0cTSC\u662f\u4ee5\u8ba1\u6570\u5668\u5f62\u5f0f\u5b58\u5728\u7684\u5355\u6b65\u9012\u589e\u6027\u65f6\u949f\uff0c\u4e24\u8005\u7684\u533a\u522b\u5728\u4e8e\uff0c\u5468\u671f\u6027\u65f6\u949f\u662f\u901a\u8fc7\u5468\u671f\u6027\u89e6\u53d1\u4e2d\u65ad\u8fbe\u5230\u8ba1\u65f6\u76ee\u7684\uff0c\u5982\u5fc3\u8df3\u4e00\u822c\u3002\u800c\u5355\u6b65\u9012\u589e\u65f6\u949f\u5219\u4e0d\u53d1\u9001\u4e2d\u65ad\uff0c\u53d6\u800c\u4ee3\u4e4b\u7684\u662f\u7531\u8f6f\u4ef6\u81ea\u5df1\u5728\u9700\u8981\u7684\u65f6\u5019\u53bb\u4e3b\u52a8\u8bfb\u53d6TSC\u5bc4\u5b58\u5668\u7684\u503c\u6765\u83b7\u5f97\u65f6\u95f4\u3002TSC\u7684\u7cbe\u5ea6\u66f4\u9ad8\u5e76\u4e14\u901f\u5ea6\u66f4\u5feb\uff0c\u4f46\u4ec5\u80fd\u5728\u8f83\u65b0\u7684CPU(Sandy Bridge\u4e4b\u540e)\u4e0a\u4f7f\u7528\u3002</p> <ul> <li>[KNL]   highres={\"on\"|\"off\"}</li> </ul> <p>\u542f\u7528(\u9ed8\u8ba4\u503c)\u8fd8\u662f\u7981\u7528\u9ad8\u7cbe\u5ea6\u5b9a\u65f6\u5668\u6a21\u5f0f\u3002\u4e3b\u8981\u7528\u4e8e\u5173\u95ed\u4e3b\u677f\u4e0a\u6709\u6545\u969c\u7684\u9ad8\u7cbe\u5ea6\u65f6\u949f\u6e90\u3002</p> <ul> <li>nohpet</li> </ul> <p>\u7981\u7528HPET timer(CONFIG_HPET)</p> <ul> <li>[HPET_MMAP]   hpet_mmap</li> </ul> <p>v3.13\u65b0\u589e\uff0c\u9ed8\u8ba4\u5141\u8bb8\u5bf9HPET\u5bc4\u5b58\u5668\u8fdb\u884c\u6620\u5c04\uff0c\u76f8\u5f53\u4e8e\u5f00\u542f\u4e86\u5185\u6838CONFIG_HPET_MMAP_DEFAULT\u9009\u9879\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u67d0\u4e9b\u5305\u542bHPET\u786c\u4ef6\u5bc4\u5b58\u5668\u7684\u9875\u4e2d\u540c\u65f6\u8fd8\u542b\u6709\u5176\u4ed6\u4e0d\u8be5\u66b4\u9732\u7ed9\u7528\u6237\u7684\u4fe1\u606f\u3002</p> <ul> <li>notsc   tsc=reliable   tsc=noirqtime</li> </ul> <p>\u8bbe\u7f6eTSC\u65f6\u949f\u6e90\u7684\u5c5e\u6027\u3002 notsc \u8868\u793a\u4e0d\u5c06TSC\u7528\u4f5c\"wall time\"\u65f6\u949f\u6e90\uff0c\u4e3b\u8981\u7528\u4e8e\u4e0d\u80fd\u5728\u591a\u4e2aCPU\u4e4b\u95f4\u4fdd\u6301\u6b63\u786e\u540c\u6b65\u7684SMP\u7cfb\u7edf\u3002 tsc=reliable \u8868\u793aTSC\u65f6\u949f\u6e90\u662f\u7edd\u5bf9\u7a33\u5b9a\u7684\uff0c\u5173\u95ed\u542f\u52a8\u65f6\u548c\u8fd0\u884c\u65f6\u7684\u7a33\u5b9a\u6027\u68c0\u67e5\u3002\u7528\u4e8e\u5728\u67d0\u4e9b\u8001\u65e7\u786c\u4ef6/\u865a\u62df\u5316\u73af\u5883\u4f7f\u7528TSC\u65f6\u949f\u6e90\u3002 tsc=noirqtime \u4e0d\u5c06TSC\u7528\u4e8e\u7edf\u8ba1\u8fdb\u7a0bIRQ\u65f6\u95f4\u3002\u4e3b\u8981\u7528\u4e8e\u5728RDTSC\u901f\u5ea6\u8f83\u6162\u7684CPU\u4e0a\u7981\u6b62\u5185\u6838\u7684CONFIG_IRQ_TIME_ACCOUNTING\u529f\u80fd\u3002 \u5173\u4e8e\"TSC\u65f6\u949f\u6e90\"\uff0c\u8be6\u89c1\"clocksource=\"\u9009\u9879\u7684\u8bf4\u660e\u3002</p>"},{"location":"Linux/system/Linux%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/#46-\u4e2d\u65ad","title":"4.6 \u4e2d\u65ad","text":"<p>\u5e38\u89c1\u7684\u4e2d\u65ad\u63a7\u5236\u5668\u6709\u4e24\u79cd\uff1a\u4f20\u7edf\u76848259A\u548c\u65b0\u5f0f\u7684APIC\uff0c\u524d\u8005\u4e5f\u88ab\u79f0\u4e3a\"PIC\"\u30028259A\u53ea\u9002\u5408\u5355CPU\u7684\u573a\u5408\uff0c\u800cAPIC\u5219\u80fd\u591f\u628a\u4e2d\u65ad\u4f20\u9012\u7ed9\u7cfb\u7edf\u4e2d\u7684\u6bcf\u4e2aCPU\uff0c\u4ece\u800c\u5145\u5206\u6316\u6398SMP\u4f53\u7cfb\u7ed3\u6784\u7684\u5e76\u884c\u6027\u3002\u6240\u4ee58259A\u5df2\u7ecf\u88ab\u6dd8\u6c70\u4e86\u3002APIC\u7cfb\u7edf\u75313\u90e8\u5206\u7ec4\u6210\uff1aAPIC\u603b\u7ebf(\u524d\u7aef\u603b\u7ebf)\u3001IO-APIC(\u5357\u6865)\u3001\u672c\u5730APIC(CPU)\u3002\u6bcf\u4e2aCPU\u4e2d\u96c6\u6210\u4e86\u4e00\u4e2a\u672c\u5730APIC\uff0c\u8d1f\u8d23\u4f20\u9012\u4e2d\u65ad\u4fe1\u53f7\u5230\u5904\u7406\u5668\u3002\u800cIO-APIC\u662f\u7cfb\u7edf\u82af\u7247\u7ec4\u4e2d\u4e00\u90e8\u5206\uff0c\u8d1f\u8d23\u6536\u96c6\u6765\u81eaI/O\u8bbe\u5907\u7684\u4e2d\u65ad\u4fe1\u53f7\u5e76\u53d1\u9001\u5230\u672c\u5730APIC\u3002APIC\u603b\u7ebf\u5219\u662f\u8fde\u63a5IO-APIC\u548c\u5404\u4e2a\u672c\u5730APIC\u7684\u6865\u6881\u3002</p> <p>\u5e38\u89c1\u7684\u4e2d\u65ad\u63a7\u5236\u5668\u6709\u4e24\u79cd\uff1a\u4f20\u7edf\u76848259A\u548c\u65b0\u5f0f\u7684APIC\uff0c\u524d\u8005\u4e5f\u88ab\u79f0\u4e3a\"PIC\"\u30028259A\u53ea\u9002\u5408\u5355CPU\u7684\u573a\u5408\uff0c\u800cAPIC\u5219\u80fd\u591f\u628a\u4e2d\u65ad\u4f20\u9012\u7ed9\u7cfb\u7edf\u4e2d\u7684\u6bcf\u4e2aCPU\uff0c\u4ece\u800c\u5145\u5206\u6316\u6398SMP\u4f53\u7cfb\u7ed3\u6784\u7684\u5e76\u884c\u6027\u3002\u6240\u4ee58259A\u5df2\u7ecf\u88ab\u6dd8\u6c70\u4e86\u3002APIC\u7cfb\u7edf\u75313\u90e8\u5206\u7ec4\u6210\uff1aAPIC\u603b\u7ebf(\u524d\u7aef\u603b\u7ebf)\u3001IO-APIC(\u5357\u6865)\u3001\u672c\u5730APIC(CPU)\u3002\u6bcf\u4e2aCPU\u4e2d\u96c6\u6210\u4e86\u4e00\u4e2a\u672c\u5730APIC\uff0c\u8d1f\u8d23\u4f20\u9012\u4e2d\u65ad\u4fe1\u53f7\u5230\u5904\u7406\u5668\u3002\u800cIO-APIC\u662f\u7cfb\u7edf\u82af\u7247\u7ec4\u4e2d\u4e00\u90e8\u5206\uff0c\u8d1f\u8d23\u6536\u96c6\u6765\u81eaI/O\u8bbe\u5907\u7684\u4e2d\u65ad\u4fe1\u53f7\u5e76\u53d1\u9001\u5230\u672c\u5730APIC\u3002APIC\u603b\u7ebf\u5219\u662f\u8fde\u63a5IO-APIC\u548c\u5404\u4e2a\u672c\u5730APIC\u7684\u6865\u6881\u3002</p> <ul> <li>[SMP,APIC] noapic</li> </ul> <p>\u7981\u6b62\u4f7f\u7528IO-APIC(\u8f93\u5165\u8f93\u51fa\u9ad8\u7ea7\u53ef\u7f16\u7a0b\u8f93\u5165\u63a7\u5236\u5668)\uff0c\u4e3b\u8981\u7528\u4e8e\u89e3\u51b3\u67d0\u4e9b\u6709\u7f3a\u9677\u7684BIOS\u5bfc\u81f4\u7684APIC\u6545\u969c\u3002</p> <ul> <li>[APIC] nolapic disableapic</li> </ul> <p>\u7981\u6b62\u4f7f\u7528local APIC\u3002\u4e3b\u8981\u7528\u4e8e\u89e3\u51b3\u67d0\u4e9b\u6709\u7f3a\u9677\u7684BIOS\u5bfc\u81f4\u7684APIC\u6545\u969c\u3002\"nolapic\"\u662f\u4e3a\u4e86\u4fdd\u6301\u4f20\u7edf\u4e60\u60ef\u7684\u517c\u5bb9\u5199\u6cd5\uff0c\u4e0e\"disableapic\"\u7684\u542b\u4e49\u76f8\u540c\u3002</p> <ul> <li>[APIC] nox2apic</li> </ul> <p>\u5173\u95edx2APIC\u652f\u6301(CONFIG_X86_X2APIC)</p> <ul> <li>[APIC] x2apic_phys</li> </ul> <p>\u5728\u652f\u6301x2apic\u7684\u5e73\u53f0\u4e0a\u4f7f\u7528physical\u6a21\u5f0f\u4ee3\u66ff\u9ed8\u8ba4\u7684cluster\u6a21\u5f0f\u3002</p> <ul> <li>[KNL] threadirqs</li> </ul> <p>\u5f3a\u5236\u7ebf\u7a0b\u5316\u6240\u6709\u7684\u4e2d\u65ad\u5904\u7406\u5668(\u660e\u786e\u6807\u8bb0\u4e3aIRQF_NO_THREAD\u7684\u9664\u5916)</p> <ul> <li>[SMP,APIC] pirq=</li> </ul> <p>\u624b\u52a8\u6307\u5b9amp-table\u7684\u8bbe\u7f6e\u3002\u6b64\u9009\u9879\u4ec5\u5bf9\u67d0\u4e9b\u6709\u7f3a\u9677\u7684\u3001\u5177\u5907\u591a\u4e2aIO-APIC\u7684\u9ad8\u7aef\u4e3b\u677f\u6709\u610f\u4e49\u3002\u8be6\u89c1Documentation/x86/i386/IO-APIC.txt\u6587\u6863</p> <ul> <li>[HW] irqfixup</li> </ul> <p>\u7528\u4e8e\u4fee\u590d\u7b80\u5355\u7684\u4e2d\u65ad\u95ee\u9898\uff1a\u5f53\u4e00\u4e2a\u4e2d\u65ad\u6ca1\u6709\u88ab\u5904\u7406\u65f6\u641c\u7d22\u6240\u6709\u53ef\u7528\u7684\u4e2d\u65ad\u5904\u7406\u5668\u3002\u7528\u4e8e\u89e3\u51b3\u67d0\u4e9b\u7b80\u5355\u7684\u56fa\u4ef6\u7f3a\u9677\u3002</p> <ul> <li>[HW] irqpoll</li> </ul> <p>\u7528\u4e8e\u4fee\u590d\u9ad8\u7ea7\u7684\u4e2d\u65ad\u95ee\u9898\uff1a\u5f53\u4e00\u4e2a\u4e2d\u65ad\u6ca1\u6709\u88ab\u5904\u7406\u65f6\u641c\u7d22\u6240\u6709\u53ef\u7528\u7684\u4e2d\u65ad\u5904\u7406\u5668\uff0c\u5e76\u4e14\u5bf9\u6bcf\u4e2a\u65f6\u949f\u4e2d\u65ad\u90fd\u8fdb\u884c\u641c\u7d22\u3002\u7528\u4e8e\u89e3\u51b3\u67d0\u4e9b\u4e25\u91cd\u7684\u56fa\u4ef6\u7f3a\u9677\u3002</p>"},{"location":"Linux/system/Linux%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/#47-acpi","title":"4.7 ACPI","text":"<p>\u9ad8\u7ea7\u914d\u7f6e\u4e0e\u7535\u6e90\u7ba1\u7406\u63a5\u53e3(Advanced Configuration and Power Interface)\u662f\u63d0\u4f9b\u64cd\u4f5c\u7cfb\u7edf\u4e0e\u5e94\u7528\u7a0b\u5e8f\u7ba1\u7406\u6240\u6709\u7535\u6e90\u7ba1\u7406\u63a5\u53e3\uff0c\u5305\u62ec\u4e86\u5404\u79cd\u8f6f\u4ef6\u548c\u786c\u4ef6\u65b9\u9762\u7684\u89c4\u8303\u30022004\u5e74\u63a8\u51fa3.0\u89c4\u8303\uff1b2009\u5e74\u63a8\u51fa4.0\u89c4\u8303\uff1b2011\u5e74\u63a8\u51fa5.0\u89c4\u8303\u30022013\u5e74\u4e4b\u540e\u65b0\u7684ACPI\u89c4\u683c\u5c06\u7531UEFI\u8bba\u575b\u5236\u5b9a\u3002ACPI\u53ef\u4ee5\u5b9e\u73b0\u7684\u529f\u80fd\u5305\u62ec\uff1a\u7535\u6e90\u7ba1\u7406\uff1b\u6027\u80fd\u7ba1\u7406\uff1b\u914d\u7f6e\u4e0e\u5373\u63d2\u5373\u7528\uff1b\u7cfb\u7edf\u4e8b\u4ef6\uff1b\u6e29\u5ea6\u7ba1\u7406\uff1b\u7535\u6c60\u7ba1\u7406\uff1bSMBus\u63a7\u5236\u5668\uff1b\u5d4c\u5165\u5f0f\u63a7\u5236\u5668\u3002</p> <ul> <li>[HW,ACPI] acpi={force|off|noirq|strict|rsdt|nocmcff|copy_dsdt}</li> </ul> <p>ACPI\u7684\u603b\u5f00\u5173\u3002 force \u8868\u793a\u5f3a\u5236\u542f\u7528ACPI(\u5373\u4f7fBIOS\u4e2d\u5df2\u5173\u95ed)\uff1b off \u8868\u793a\u5f3a\u5236\u7981\u7528ACPI(\u5373\u4f7fBIOS\u4e2d\u5df2\u5f00\u542f)\uff1b noirq \u8868\u793a\u4e0d\u8981\u5c06ACPI\u7528\u4e8eIRQ\u8def\u7531\uff1b strict \u8868\u793a\u4e25\u683c\u8981\u6c42\u7cfb\u7edf\u9075\u5faaACPI\u89c4\u683c(\u964d\u4f4e\u517c\u5bb9\u6027)\uff1b rsdt \u8868\u793a\u4f7f\u7528\u8001\u65e7\u7684RSDT(Root System Description Table)\u4ee3\u66ff\u8f83\u65b0\u7684XSDT(Extended System Description Table)\uff1b copy_dsdt \u8868\u793a\u5c06DSDT(Differentiated System Description Table)\u590d\u5236\u5230\u5185\u5b58\u4e2d\u3002 \u66f4\u591a\u4fe1\u606f\u53ef\u53c2\u8003Documentation/power/runtime_pm.txt\u4ee5\u53ca\"pci=noacpi\"\u3002</p> <ul> <li>[HW,ACPI] acpi_backlight={vendor|video}</li> </ul> <p>\u9009\u62e9\u5c4f\u5e55\u80cc\u5149\u4eae\u5ea6\u8c03\u8282\u9a71\u52a8\u3002 video(\u9ed8\u8ba4\u503c)\u8868\u793a\u4f7f\u7528\u901a\u7528\u7684ACPI video.ko\u9a71\u52a8(CONFIG_ACPI_VIDEO)\uff0c\u8be5\u9a71\u52a8\u4ec5\u53ef\u7528\u4e8e\u96c6\u6210\u663e\u5361\u3002 vendor\u8868\u793a\u4f7f\u7528\u5382\u5546\u7279\u5b9a\u7684ACPI\u9a71\u52a8(thinkpad_acpi,sony_acpi\u7b49)\u3002 \u8be6\u89c1Documentation/acpi/video_extension.txt\u6587\u6863\u3002</p> <ul> <li>[HW,ACPI] acpi_os_name=\"\u5b57\u7b26\u4e32\"</li> </ul> <p>\u544a\u8bc9ACPI BIOS\u64cd\u4f5c\u7cfb\u7edf\u7684\u540d\u79f0\u3002 \u5e38\u7528\u4e8e\u54c4\u9a97\u6709\u7f3a\u9677\u7684BIOS\uff0c\u8ba9\u5176\u4ee5\u4e3a\u8fd0\u884c\u7684\u662fWindows\u7cfb\u7edf\u800c\u4e0d\u662fLinux\u7cfb\u7edf\u3002 \"Linux\" = Linux \"Microsoft Windows\" = Windows 98 \"Windows 2000\" = Windows 2000 \"Windows 2001\" = Windows XP \"Windows 2001 SP2\" = Windows XP SP2 \"Windows 2001.1\" = Windows Server 2003 \"Windows 2001.1 SP1\" = Windows Server 2003 SP1 \"Windows 2006\" = Windows Vista \"Windows 2006 SP1\" = Windows Vista SP1 \"Windows 2006.1\" = Windows Server 2008 \"Windows 2009\" = Windows 7 / Windows Server 2008 R2 \"Windows 2012\" = Windows 8 / Windows Server 2012 \"Windows 2013\" = Windows 8.1 / Windows Server 2012 R2</p> <ul> <li>[HW,ACPI] acpi_osi=\"\u5b57\u7b26\u4e32\"</li> </ul> <p>\u5bf9\u4e8e\u8f83\u65b0\u7684\u5185\u6838(Linux-2.6.23\u4e4b\u540e)\u800c\u8a00\uff0c\u5f53BIOS\u8be2\u95ee\u5185\u6838\uff1a\"\u4f60\u662fLinux\u5417?\"\uff0c\u5185\u6838\u90fd\u4f1a\u56de\u7b54\"No\"\uff0c\u4f46\u5386\u53f2\u4e0a(Linux-2.6.22\u53ca\u66f4\u65e9\u7248\u672c)\u5185\u6838\u4f1a\u5982\u5b9e\u56de\u7b54\"Yes\"\uff0c\u7ed3\u679c\u9020\u6210\u5f88\u591aBIOS\u517c\u5bb9\u6027\u95ee\u9898(\u4e3b\u8981\u662f\u7535\u6e90\u7ba1\u7406\u65b9\u9762)\u3002\u5177\u4f53\u6545\u4e8b\u7684\u7ec6\u8282\u8bf7\u5230\u5185\u6838\u6e90\u7801\u6587\u4ef6drivers/acpi/osl.c\u4e2d\u641c\u7d22\"The story of _OSI(Linux)\"\u6ce8\u91ca\u3002 \u6b64\u9009\u9879\u7528\u4e8e\u4fee\u6539\u5185\u6838\u4e2d\u7684\u64cd\u4f5c\u7cfb\u7edf\u63a5\u53e3\u5b57\u7b26\u4e32(_OSI string)\u5217\u8868\u9ed8\u8ba4\u503c\uff0c\u8fd9\u6837\u5f53BIOS\u5411\u5185\u6838\u8be2\u95ee\uff1a\"\u4f60\u662fxxx\u5417?\"\u7684\u65f6\u5019\uff0c\u5185\u6838\u5c31\u53ef\u4ee5\u6839\u636e\u4fee\u6539\u540e\u7684\u5217\u8868\u4e2d\u662f\u5426\u5b58\u5728\"xxx\"\u56de\u7b54\"Yes\"\u6216\"No\"\u4e86\uff0c\u4e3b\u8981\u7528\u4e8e\u89e3\u51b3BIOS\u517c\u5bb9\u6027\u95ee\u9898\u5bfc\u81f4\u7684\u6545\u969c(\u4f8b\u5982\u5c4f\u5e55\u4eae\u5ea6\u8c03\u6574)\u3002 acpi_osi=\"Linux\"\u8868\u793a\u6dfb\u52a0\"Linux\"\uff1b acpi_osi=\"!Linux\"\u8868\u793a\u5220\u9664\"Linux\"\uff1b acpi_osi=!* \u8868\u793a\u5220\u9664\u6240\u6709\u5b57\u7b26\u4e32(v3.13\u65b0\u589e)\uff0c\u53ef\u4ee5\u548c\u591a\u4e2aacpi_osi=\"Linux\"\u683c\u5f0f\u8054\u5408\u4f7f\u7528\uff1b acpi_osi=! \u8868\u793a\u5220\u9664\u6240\u6709\u5185\u7f6e\u7684\u5b57\u7b26\u4e32(v3.13\u65b0\u589e)\uff0c\u53ef\u4ee5\u548c\u591a\u4e2aacpi_osi=\"Linux\"\u683c\u5f0f\u8054\u5408\u4f7f\u7528\uff1b acpi_osi= \u8868\u793a\u7981\u7528\u6240\u6709\u5b57\u7b26\u4e32\uff0c\u4ec5\u53ef\u5355\u72ec\u4f7f\u7528(\u4e0d\u80fd\u8054\u5408\u4f7f\u7528)\u3002</p> <ul> <li>[HW,ACPI] acpi_serialize</li> </ul> <p>\u5f3a\u5236\u5185\u6838\u4ee5\u4e32\u884c\u65b9\u5f0f\u6267\u884cAML(ACPI Machine Language)\u5b57\u8282\u7801\u3002\u7528\u4e8e\u89e3\u51b3\u67d0\u4e9b\u6709\u7f3a\u9677\u7684BIOS\u5bfc\u81f4\u7684\u6545\u969c\u3002</p> <ul> <li>[ACPI] acpi_enforce_resources={strict|lax|no}</li> </ul> <p>\u68c0\u67e5\u9a71\u52a8\u7a0b\u5e8f\u548cACPI\u64cd\u4f5c\u533a\u57df(SystemIO,SystemMemory)\u4e4b\u95f4\u8d44\u6e90\u51b2\u7a81\u7684\u65b9\u5f0f\u3002 strict(\u9ed8\u8ba4\u503c)\u7981\u6b62\u4efb\u4f55\u9a71\u52a8\u7a0b\u5e8f\u8bbf\u95ee\u5df2\u88abACPI\u58f0\u660e\u4e3a\"\u53d7\u4fdd\u62a4\"\u7684\u64cd\u4f5c\u533a\u57df\uff0c\u8fd9\u662f\u6700\u5b89\u5168\u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u4ece\u6839\u672c\u4e0a\u907f\u514d\u51b2\u7a81\u3002 lax\u5141\u8bb8\u9a71\u52a8\u7a0b\u5e8f\u8bbf\u95ee\u5df2\u88abACPI\u58f0\u660e\u7684\u4fdd\u62a4\u533a\u57df(\u4f46\u4f1a\u663e\u793a\u4e00\u4e2a\u8b66\u544a)\u3002\u8fd9\u53ef\u80fd\u4f1a\u9020\u6210\u51b2\u7a81\uff0c\u4f46\u662f\u53ef\u4ee5\u517c\u5bb9\u67d0\u4e9b\u8001\u65e7\u4e14\u8111\u6b8b\u7684\u9a71\u52a8\u7a0b\u5e8f(\u4f8b\u5982\u67d0\u4e9b\u786c\u4ef6\u76d1\u63a7\u9a71\u52a8)\u3002 no\u8868\u793a\u6839\u672c\u4e0d\u58f0\u660e\u4efb\u4f55ACPI\u4fdd\u62a4\u533a\u57df\uff0c\u4e5f\u5c31\u662f\u5b8c\u5168\u5141\u8bb8\u4efb\u610f\u9a71\u52a8\u7a0b\u5e8f\u8bbf\u95eeACPI\u64cd\u4f5c\u533a\u57df\u3002</p> <ul> <li>[ACPI] pnpacpi=off</li> </ul> <p>\u7981\u7528ACPI\u7684\u5373\u63d2\u5373\u7528\u529f\u80fd\uff0c\u8f6c\u800c\u4f7f\u7528\u53e4\u8463\u7684PNPBIOS\u6765\u4ee3\u66ff\u3002</p>"},{"location":"Linux/system/Linux%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/#48-\u4f11\u7720\u4e0e\u5524\u9192","title":"4.8 \u4f11\u7720\u4e0e\u5524\u9192","text":"<ul> <li>[HW,ACPI]   acpi_sleep={s3_bios,s3_mode,s3_beep,s4_nohwsig,old_ordering,nonvs,sci_force_enable}</li> </ul> <p>ACPI\u4f11\u7720\u9009\u9879\u3002 (1)s3_bios\u548cs3_mode\u4e0e\u663e\u5361\u6709\u5173\u3002\u8ba1\u7b97\u673a\u4eceS3\u72b6\u6001(\u6302\u8d77\u5230\u5185\u5b58)\u6062\u590d\u65f6\uff0c\u786c\u4ef6\u9700\u8981\u88ab\u6b63\u786e\u7684\u521d\u59cb\u5316\u3002\u8fd9\u5bf9\u5927\u591a\u6570\u786c\u4ef6\u90fd\u4e0d\u662f\u95ee\u9898\uff0c\u4f46\u56e0\u4e3a\u663e\u5361\u662f\u7531BIOS\u521d\u59cb\u5316\u7684\uff0c\u5185\u6838\u65e0\u6cd5\u83b7\u53d6\u5fc5\u8981\u7684\u6062\u590d\u4fe1\u606f(\u4ec5\u5b58\u5728\u4e8eBIOS\u4e2d\uff0c\u5185\u6838\u65e0\u6cd5\u8bfb\u53d6)\uff0c\u6240\u4ee5\u8fd9\u91cc\u5c31\u63d0\u4f9b\u4e86\u4e24\u4e2a\u9009\u9879\uff0c\u4ee5\u5141\u8bb8\u5185\u6838\u901a\u8fc7\u4e24\u79cd\u4e0d\u540c\u7684\u65b9\u5f0f\u6765\u6062\u590d\u663e\u5361\uff0c\u66f4\u591a\u7ec6\u8282\u8bf7\u53c2\u8003Documentation/power/video.txt\u6587\u6863\u3002 (2)s3_beep\u4e3b\u8981\u7528\u4e8e\u8c03\u8bd5\uff0c\u5b83\u8ba9PC\u5587\u53ed\u5728\u5185\u6838\u7684\u5b9e\u6a21\u5f0f\u5165\u53e3\u70b9\u88ab\u8c03\u7528\u65f6\u53d1\u51fa\u54cd\u58f0\u3002 (3)s4_nohwsig\u7528\u4e8e\u5173\u95edACPI\u786c\u4ef6\u7b7e\u540d\u529f\u80fd\uff0c\u67d0\u4e9b\u6709\u7f3a\u9677\u7684BIOS\u4f1a\u56e0\u4e3a\u8fd9\u4e2a\u539f\u56e0\u5bfc\u81f4\u4eceS4\u72b6\u6001(\u6302\u8d77\u5230\u786c\u76d8)\u5524\u9192\u65f6\u5931\u8d25\u3002 (4)old_ordering\u7528\u4e8e\u517c\u5bb9\u53e4\u8463\u7ea7\u7684ACPI 1.0 BIOS (5)nonvs\u8868\u793a\u963b\u6b62\u5185\u6838\u5728\u6302\u8d77/\u5524\u9192\u8fc7\u7a0b\u4e2d\u4fdd\u5b58/\u6062\u590dACPI NVS\u5185\u5b58\u4fe1\u606f\uff0c\u4e3b\u8981\u7528\u4e8e\u89e3\u51b3\u67d0\u4e9b\u6709\u7f3a\u9677\u7684BIOS\u5bfc\u81f4\u7684\u6302\u8d77/\u5524\u9192\u6545\u969c\u3002 (6)sci_force_enable\u8868\u793a\u7531\u5185\u6838\u76f4\u63a5\u8bbe\u7f6eSCI_EN(ACPI\u6a21\u5f0f\u5f00\u5173)\u7684\u72b6\u6001\uff0c\u4e3b\u8981\u7528\u4e8e\u89e3\u51b3\u67d0\u4e9b\u6709\u7f3a\u9677\u7684BIOS\u5bfc\u81f4\u7684\u4eceS1/S3\u72b6\u6001\u5524\u9192\u65f6\u7684\u6545\u969c\u3002</p> <ul> <li>[HIBERNATION]   noresume</li> </ul> <p>\u7981\u7528\u5185\u6838\u7684\u4f11\u7720\u5230\u786c\u76d8\u529f\u80fd(CONFIG_HIBERNATION)\uff0c\u4e5f\u5c31\u662f\u4e0d\u4ece\u5148\u524d\u7684\u4f11\u7720\u72b6\u6001\u4e2d\u6062\u590d(\u5373\u4f7f\u8be5\u72b6\u6001\u5df2\u7ecf\u88ab\u4fdd\u5b58\u5728\u4e86\u786c\u76d8\u7684swap\u5206\u533a\u4e0a)\uff0c\u5e76\u4e14\u6e05\u695a\u5148\u524d\u5df2\u7ecf\u4fdd\u5b58\u7684\u4f11\u7720\u72b6\u6001(\u5982\u679c\u6709\u7684\u8bdd)\u3002</p> <ul> <li>[HIBERNATION]   hibernate={noresume|nocompress}</li> </ul> <p>\u8bbe\u7f6e\u4f11\u7720/\u5524\u9192\u5c5e\u6027\uff1a noresume \u8868\u793a\u7981\u7528\u5524\u9192\uff0c\u4e5f\u5c31\u662f\u5728\u542f\u52a8\u8fc7\u7a0b\u4e2d\u65e0\u89c6\u4efb\u4f55\u5df2\u7ecf\u5b58\u5728\u7684\u4f11\u7720\u955c\u50cf\uff0c\u5b8c\u5168\u91cd\u65b0\u542f\u52a8\u3002 nocompress \u8868\u793a\u7981\u6b62\u5bf9\u4f11\u7720\u955c\u50cf\u8fdb\u884c\u538b\u7f29/\u89e3\u538b\u3002</p> <ul> <li>[HIBERNATION]   resume={ /dev/swap | PARTUUID=uuid | major:minor | hex }</li> </ul> <p>\u544a\u8bc9\u5185\u6838\u88ab\u6302\u8d77\u7684\u5185\u5b58\u955c\u50cf\u5b58\u653e\u5728\u90a3\u4e2a\u78c1\u76d8\u5206\u533a(\u9ed8\u8ba4\u503c\u662fCONFIG_PM_STD_PARTITION)\u3002 \u5047\u5b9a\u5185\u5b58\u955c\u50cf\u5b58\u653e\u5728\"/dev/sdc15\"\u5206\u533a\u4e0a\uff0c\u8be5\u5206\u533a\u7684 UUID=0123456789ABCDEF \uff0c\u5176\u4e3b\u8bbe\u5907\u53f7\u662f\"8\"\uff0c\u6b21\u8bbe\u5907\u53f7\u662f\"47\"\uff0c\u90a3\u4e48\u8fd94\u79cd\u8868\u793a\u6cd5\u5e94\u8be5\u5206\u522b\u8fd9\u6837\u8868\u793a\uff1a resume=/dev/sdc15 (\u8fd9\u662f\u5185\u6838\u8bbe\u5907\u540d\u79f0\uff0c\u6709\u53ef\u80fd\u4e0e\u7528\u6237\u7a7a\u95f4\u7684\u8bbe\u5907\u540d\u79f0\u4e0d\u540c) resume=PARTUUID=0123456789ABCDEF resume=08:47 resume=082F</p> <ul> <li>[HIBERNATION]   resume_offset=\u6574\u6570</li> </ul> <p>\u6307\u5b9aswap header\u6240\u5728\u4f4d\u7f6e\u7684\u504f\u79fb\u91cf(\u5355\u4f4d\u662fPAGE_SIZE)\uff0c\u504f\u79fb\u91cf\u7684\u8ba1\u7b97\u57fa\u51c6\u70b9\u662f\"resume=\"\u5206\u533a\u7684\u8d77\u70b9\u3002 \u4ec5\u5728\u4f7f\u7528swap\u6587\u4ef6(\u800c\u4e0d\u662f\u5206\u533a)\u7684\u65f6\u5019\u624d\u9700\u8981\u6b64\u9009\u9879\u3002\u8be6\u89c1Documentation/power/swsusp-and-swap-files.txt\u6587\u6863</p> <ul> <li>[HIBERNATION]   resumedelay=\u79d2\u6570</li> </ul> <p>\u5728\u8bfb\u53d6resume\u6587\u4ef6(\u8bbe\u5907)\u4e4b\u524d\u5ef6\u8fdf\u7684\u79d2\u6570\uff0c\u4e3b\u8981\u7528\u4e8e\u7b49\u5f85\u90a3\u4e9b\u53cd\u5e94\u901f\u5ea6\u8f83\u6162\u7684\u5f02\u6b65\u68c0\u6d4b\u7684\u8bbe\u5907\u5c31\u7eea(\u4f8b\u5982USB/MMC)\u3002</p> <ul> <li>[HIBERNATION]   resumewait</li> </ul> <p>\u5728resume\u8bbe\u5907\u6ca1\u6709\u5c31\u7eea\u4e4b\u524d\u65e0\u9650\u7b49\u5f85\uff0c\u4e3b\u8981\u7528\u4e8e\u7b49\u5f85\u90a3\u4e9b\u53cd\u5e94\u901f\u5ea6\u8f83\u6162\u7684\u5f02\u6b65\u68c0\u6d4b\u7684\u8bbe\u5907\u5c31\u7eea(\u4f8b\u5982USB/MMC)\u3002</p>"},{"location":"Linux/system/Linux%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/#49-\u6e29\u5ea6\u63a7\u5236","title":"4.9 \u6e29\u5ea6\u63a7\u5236","text":"<ul> <li>[HW,ACPI]   thermal.act=\u6444\u6c0f\u5ea6</li> </ul> <p>-1 \u7981\u7528\u6240\u6709\"\u4e3b\u52a8\u6563\u70ed\"\u6807\u5fd7\u70b9(active trip point) \u6b63\u6574\u6570 \u5f3a\u5236\u8bbe\u7f6e\u6240\u6709\u7684\u6700\u4f4e\"\u4e3b\u52a8\u6563\u70ed\"\u6807\u5fd7\u70b9\u7684\u6e29\u5ea6\u503c\uff0c\u5355\u4f4d\u662f\u6444\u6c0f\u5ea6\u3002 \u8be6\u89c1Documentation/thermal/sysfs-api.txt\u6587\u6863\u3002</p> <ul> <li>[HW,ACPI]   thermal.psv=\u6444\u6c0f\u5ea6</li> </ul> <p>-1 \u7981\u7528\u6240\u6709\"\u88ab\u52a8\u6563\u70ed\"\u6807\u5fd7\u70b9(passive trip point) \u6b63\u6574\u6570 \u5f3a\u5236\u8bbe\u7f6e\u6240\u6709\u7684\"\u88ab\u52a8\u6563\u70ed\"\u6807\u5fd7\u70b9\u7684\u6e29\u5ea6\u503c\uff0c\u5355\u4f4d\u662f\u6444\u6c0f\u5ea6\u3002 \u8be6\u89c1Documentation/thermal/sysfs-api.txt\u6587\u6863\u3002</p> <ul> <li>[HW,ACPI]   thermal.crt=\u6444\u6c0f\u5ea6</li> </ul> <p>-1 \u7981\u7528\u6240\u6709\"\u7d27\u6025\"\u6807\u5fd7\u70b9(critical trip point) \u6b63\u6574\u6570 \u5f3a\u5236\u8bbe\u7f6e\u6240\u6709\u7684\"\u7d27\u6025\"\u6807\u5fd7\u70b9\u7684\u6e29\u5ea6\u503c\uff0c\u5355\u4f4d\u662f\u6444\u6c0f\u5ea6\u3002 \u8be6\u89c1Documentation/thermal/sysfs-api.txt\u6587\u6863\u3002</p> <ul> <li>[HW,ACPI]   thermal.nocrt=1</li> </ul> <p>\u7981\u6b62\u5728ACPI\u70ed\u533a(thermal zone)\u6e29\u5ea6\u8fbe\u5230\"\u7d27\u6025\"\u6807\u5fd7\u70b9\u65f6\u91c7\u53d6\u4efb\u4f55\u52a8\u4f5c\u3002</p> <ul> <li>[HW,ACPI]   thermal.off=1</li> </ul> <p>\u5f7b\u5e95\u5173\u95edACPI\u70ed\u91cf\u63a7\u5236(CONFIG_ACPI_THERMAL)</p> <ul> <li>[HW,ACPI]   thermal.tzp=\u6574\u6570</li> </ul> <p>\u8bbe\u7f6eACPI\u70ed\u533a(thermal zone)\u7684\u8f6e\u8be2\u901f\u5ea6\uff1a 0(\u9ed8\u8ba4\u503c) \u4e0d\u8f6e\u8be2 \u6b63\u6574\u6570 \u8f6e\u8be2\u95f4\u9694\uff0c\u5355\u4f4d\u662f\u5341\u5206\u4e4b\u4e00\u79d2\u3002</p>"},{"location":"Linux/system/Linux%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/#410-cpu\u8282\u80fd","title":"4.10 CPU\u8282\u80fd","text":"<ul> <li>[KNL] nohz={on|off}</li> </ul> <p>\u542f\u7528/\u7981\u7528\u5185\u6838\u7684dynamic ticks\u7279\u6027\u3002\u9ed8\u8ba4\u503c\u662f\"on\"\u3002</p> <ul> <li>[KNL,BOOT] nohz_full=CPU\u5217\u8868</li> </ul> <p>\u5728\u5185\u6838\"CONFIG_NO_HZ_FULL=y\"\u7684\u524d\u63d0\u4e0b\uff0c\u6307\u5b9a\u54ea\u4e9bCPU\u6838\u5fc3\u53ef\u4ee5\u8fdb\u5165\u5b8c\u5168\u65e0\u6ef4\u7b54\u72b6\u6001\u3002 \"CPU\u5217\u8868\"\u662f\u4e00\u4e2a\u9017\u53f7\u5206\u9694\u7684CPU\u7f16\u53f7(\u4ece0\u5f00\u59cb\u8ba1\u6570)\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\"-\"\u754c\u5b9a\u4e00\u4e2a\u8303\u56f4\u3002\u4f8b\u5982\"0,2,4-7\"\u7b49\u4ef7\u4e8e\"0,2,4,5,6,7\" \u6ce8\u610f\"boot CPU\"(\u901a\u5e38\u90fd\u662f\"0\"\u53f7CPU)\u4f1a\u65e0\u6761\u4ef6\u7684\u4ece\u5217\u8868\u4e2d\u5254\u9664\u3002(2)\u8fd9\u91cc\u5217\u51fa\u7684CPU\u7f16\u53f7\u5fc5\u987b\u4e5f\u8981\u540c\u65f6\u5217\u8fdb\"rcu_nocbs=...\"\u9009\u9879\u4e2d\u3002</p> <ul> <li>[HW,ACPI] processor.nocst</li> </ul> <p>\u4e0d\u4f7f\u7528_CST\u65b9\u6cd5\u68c0\u6d4bC-states\uff0c\u800c\u662f\u7528\u8001\u65e7\u7684FADT\u65b9\u6cd5\u68c0\u6d4b\u3002</p> <ul> <li>[HW,ACPI] processor.max_cstate={0|1|2|3|4|5|6|7|8|9}</li> </ul> <p>\u65e0\u89c6ACPI\u8868\u62a5\u544a\u7684\u503c\uff0c\u5f3a\u5236\u6307\u5b9aCPU\u7684\u6700\u5927C-state\u503c(\u5fc5\u987b\u662f\u4e00\u4e2a\u6709\u6548\u503c)\uff1aC0\u4e3a\u6b63\u5e38\u72b6\u6001\uff0c\u5176\u4ed6\u5219\u4e3a\u4e0d\u540c\u7684\u7701\u7535\u6a21\u5f0f(\u6570\u5b57\u8d8a\u5927\u8868\u793aCPU\u4f11\u7720\u7684\u7a0b\u5ea6\u8d8a\u6df1/\u8d8a\u7701\u7535)\u3002\"9\"\u8868\u793a\u65e0\u89c6\u6240\u6709\u7684DMI\u9ed1\u540d\u5355\u9650\u5236\u3002</p> <ul> <li>[KNL,HW,ACPI] intel_idle.max_cstate=[0|\u6b63\u6574\u6570]</li> </ul> <p>\u8bbe\u7f6eintel_idle\u9a71\u52a8(CONFIG_INTEL_IDLE)\u5141\u8bb8\u4f7f\u7528\u7684\u6700\u5927C-state\u6df1\u5ea6\u3002\"0\"\u8868\u793a\u7981\u7528intel_idle\u9a71\u52a8\uff0c\u8f6c\u800c\u4f7f\u7528\u901a\u7528\u7684acpi_idle\u9a71\u52a8(CONFIG_CPU_IDLE)</p> <ul> <li>idle=poll idle=halt idle=nomwait</li> </ul> <p>\u5bf9CPU\u8fdb\u5165\u4f11\u7720\u72b6\u6001\u7684\u989d\u5916\u8bbe\u7f6e\u3002 poll \u4ece\u6839\u672c\u4e0a\u7981\u7528\u4f11\u7720\u529f\u80fd(\u4e5f\u5c31\u662f\u7981\u6b62\u8fdb\u5165C-states\u72b6\u6001)\uff0c\u53ef\u4ee5\u7565\u5fae\u63d0\u5347\u4e00\u4e9bCPU\u6027\u80fd\uff0c\u4f46\u662f\u5374\u9700\u8981\u591a\u6d88\u8017\u8bb8\u591a\u7535\u529b\uff0c\u5f97\u4e0d\u507f\u5931\u3002\u4e0d\u63a8\u8350\u4f7f\u7528\u3002 halt \u8868\u793a\u76f4\u63a5\u4f7f\u7528HALT\u6307\u4ee4\u8ba9CPU\u8fdb\u5165C1/C1E\u4f11\u7720\u72b6\u6001\uff0c\u4f46\u662f\u4e0d\u518d\u7ee7\u7eed\u8fdb\u5165C2/C3\u4ee5\u53ca\u66f4\u6df1\u7684\u4f11\u7720\u72b6\u6001\u3002\u6b64\u9009\u9879\u517c\u5bb9\u6027\u6700\u597d\uff0c\u5524\u9192\u901f\u5ea6\u4e5f\u6700\u5feb\u3002\u4f46\u662f\u7535\u529b\u6d88\u8017\u5e76\u4e0d\u6700\u4f4e\u3002 nomwait \u8868\u793a\u8fdb\u5165\u4f11\u7720\u72b6\u6001\u65f6\u7981\u6b62\u4f7f\u7528CPU\u7684MWAIT\u6307\u4ee4\u3002MWAIT\u662f\u4e13\u7528\u4e8eIntel\u8d85\u7ebf\u7a0b\u6280\u672f\u7684\u7ebf\u7a0b\u540c\u6b65\u6307\u4ee4\uff0c\u6709\u52a9\u4e8e\u63d0\u5347CPU\u7684\u8d85\u7ebf\u7a0b\u6548\u80fd\uff0c\u4f46\u5bf9\u4e8e\u4e0d\u5177\u5907\u8d85\u7ebf\u7a0b\u6280\u672f\u7684CPU\u6ca1\u6709\u610f\u4e49\u3002 [\u63d0\u793a]\u53ef\u4ee5\u540c\u65f6\u4f7f\u7528halt\u548cnomwait\uff0c\u4e5f\u5c31\u662f\"idle=halt idle=nomwait\"(\u4f46\u4e0d\u662f\uff1aidle=halt,nomwait)</p> <ul> <li>intel_pstate=disable</li> </ul> <p>\u7981\u7528 Intel CPU \u7684 P-state \u9a71\u52a8(CONFIG_X86_INTEL_PSTATE)\uff0c\u4e5f\u5c31\u662fIntel CPU\u4e13\u7528\u7684\u9891\u7387\u8c03\u8282\u5668\u9a71\u52a8</p>"},{"location":"Linux/system/Linux%E5%86%85%E6%A0%B8%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/#\u53c2\u8003\u94fe\u63a5","title":"\u53c2\u8003\u94fe\u63a5","text":"<ul> <li>http://www.jinbuguo.com/kernel/boot_parameters.html</li> <li>https://www.kernel.org/doc/html/latest/admin-guide/kernel-parameters.html</li> </ul>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/","title":"Linux \u7cfb\u7edf\u5b89\u5168\u52a0\u56fa\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#\u524d\u8a00","title":"\u524d\u8a00","text":"<p>\u5f53\u4e91\u8ba1\u7b97\u91cd\u6784IT\u4ea7\u4e1a\u7684\u540c\u65f6\uff0c\u4e5f\u8d4b\u4e88\u4e86\u4f01\u4e1a\u5d2d\u65b0\u7684\u589e\u957f\u673a\u9047\u3002\u901a\u8fc7\u5145\u5206\u5229\u7528\u4e91\u8ba1\u7b97\u7684\u80fd\u529b\uff0c\u4f01\u4e1a\u53ef\u4ee5\u91ca\u653e\u66f4\u591a\u7cbe\u529b\u4e13\u6ce8\u4e8e\u81ea\u5df1\u7684\u4e1a\u52a1\u3002\u4e91\u8ba1\u7b97\u6781\u5927\u5730\u964d\u4f4e\u4e86\u4f01\u4e1a\u7684\u6570\u5b57\u5316\u8f6c\u578b\u6210\u672c\uff0c\u91ca\u653e\u66f4\u591a\u6548\u80fd\u8fdb\u884c\u4e1a\u52a1\u521b\u65b0\uff0c\u4e91\u8ba1\u7b97\u4e3a\u4f01\u4e1a\u4e1a\u52a1\u521b\u65b0\u5e26\u6765\u65e0\u9650\u53ef\u80fd\u3002\u4f46\u662f\u5f53\u4eba\u4eec\u5728\u4eab\u53d7\u4f7f\u7528\u4e91\u8ba1\u7b97\u5e26\u6765\u7684\u4fbf\u5229\u7684\u540c\u65f6\uff0c\u670d\u52a1\u5668\u5b89\u5168\u4e5f\u4e0d\u5bb9\u5ffd\u89c6\u3002</p> <p>Linux\u662f\u4e00\u5957\u514d\u8d39\u4f7f\u7528\u548c\u81ea\u7531\u4f20\u64ad\u7684\u7c7bUnix\u64cd\u4f5c\u7cfb\u7edf\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u5f00\u653e\u6e90\u4ee3\u7801\u7684\u64cd\u4f5c\u7cfb\u7edf\uff0cLinux\u670d\u52a1\u5668\u4ee5\u5176\u5b89\u5168\u3001\u9ad8\u6548\u548c\u7a33\u5b9a\u7684\u663e\u8457\u4f18\u52bf\u800c\u5f97\u4ee5\u5e7f\u6cdb\u5e94\u7528\uff0c\u4f46\u5982\u679c\u4e0d\u505a\u597d\u6743\u9650\u7684\u5408\u7406\u5206\u914d\uff0cLinux\u7cfb\u7edf\u7684\u5b89\u5168\u6027\u8fd8\u662f\u4f1a\u5f97\u4e0d\u5230\u66f4\u597d\u7684\u4fdd\u969c\u3002</p> <p>\u4e0d\u8fc7\u7ecf\u8fc7\u5b89\u5168\u52a0\u56fa\u540e\u7684Linux\u7cfb\u7edf\u53ef\u8fbe\u5230B1\u7684\u5b89\u5168\u7ea7\u522b\uff0c\u76f8\u4fe1\u5927\u591a\u6570\u540c\u5b66\u90fd\u6709\u670d\u52a1\u5668\u88ab\u9ed1\u5ba2\u5165\u4fb5\u7684\u7ecf\u5386\uff0c\u901a\u8fc7\u672c\u6587Linux\u7cfb\u7edf\u4ece\u4e0d\u540c\u7ef4\u5ea6\u8fdb\u884c\u5b89\u5168\u52a0\u56fa\uff0c\u4e00\u5b9a\u7a0b\u5ea6\u589e\u52a0\u7cfb\u7edf\u7684\u5b89\u5168\u6027\uff0c\u6784\u7b51\u66f4\u52a0\u575a\u5b9e\u7684\u5b89\u5168\u58c1\u5792\u3002</p>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#\u4e00-\u8eab\u4efd\u9274\u522b","title":"\u4e00 \u8eab\u4efd\u9274\u522b","text":""},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#11-\u5bc6\u7801\u5b89\u5168\u7b56\u7565","title":"1.1 \u5bc6\u7801\u5b89\u5168\u7b56\u7565","text":"<p>\u64cd\u4f5c\u7cfb\u7edf\u548c\u6570\u636e\u5e93\u7cfb\u7edf\u7ba1\u7406\u7528\u6237\u8eab\u4efd\u9274\u522b\u4fe1\u606f\u5e94\u5177\u6709\u4e0d\u6613\u88ab\u5192\u7528\u7684\u7279\u70b9\uff0c\u53e3\u4ee4\u5e94\u6709\u590d\u6742\u5ea6\u8981\u6c42\u5e76\u5b9a\u671f\u66f4\u6362\u3002</p> <p>\u8bbe\u7f6e\u6709\u6548\u7684\u5bc6\u7801\u7b56\u7565\uff0c\u9632\u6b62\u653b\u51fb\u8005\u7834\u89e3\u51fa\u5bc6\u7801</p> <ul> <li>\u67e5\u770b\u7a7a\u53e3\u4ee4\u5e10\u53f7\u5e76\u4e3a\u5f31/\u7a7a\u53e3\u4ee4\u5e10\u53f7\u8bbe\u7f6e\u5f3a\u5bc6\u7801</li> </ul> <pre><code># awk -F: '($2 == \"\"){print $1}' /etc/shadow\n</code></pre> <p>\u53ef\u7528\u79bb\u7ebf\u7834\u89e3\u3001\u66b4\u529b\u5b57\u5178\u7834\u89e3\u6216\u8005\u5bc6\u7801\u7f51\u7ad9\u67e5\u8be2\u51fa\u5e10\u53f7\u5bc6\u94a5\u7684\u5bc6\u7801\u662f\u5426\u662f\u5f31\u53e3\u4ee4</p> <ul> <li>\u4fee\u6539vi /etc/login.defs\u914d\u7f6e\u5bc6\u7801\u5468\u671f\u7b56\u7565</li> </ul> <p></p> <p>\u6b64\u7b56\u7565\u53ea\u5bf9\u7b56\u7565\u5b9e\u65bd\u540e\u6240\u521b\u5efa\u7684\u5e10\u53f7\u751f\u6548\uff0c \u4ee5\u524d\u7684\u5e10\u53f7\u8fd8\u662f\u630999999\u5929\u5468\u671f\u65f6\u95f4\u6765\u7b97\u3002</p> <ul> <li>/etc/pam.d/system-auth\u914d\u7f6e\u5bc6\u7801\u590d\u6742\u5ea6\uff1a</li> </ul> <pre><code>password requisite  pam_cracklib.so retry=3 difok=2 minlen=8 lcredit=-1 dcredit=-1\n</code></pre> <p>\u53c2\u6570\u542b\u4e49\u5982\u4e0b\u6240\u793a\uff1a</p> <p>difok\uff1a\u672c\u6b21\u5bc6\u7801\u4e0e\u4e0a\u6b21\u5bc6\u7801\u81f3\u5c11\u4e0d\u540c\u5b57\u7b26\u6570</p> <p>minlen\uff1a\u5bc6\u7801\u6700\u5c0f\u957f\u5ea6\uff0c\u6b64\u914d\u7f6e\u4f18\u5148\u4e8elogin.defs\u4e2d\u7684PASS_MAX_DAYS</p> <p>ucredit\uff1a\u6700\u5c11\u5927\u5199\u5b57\u6bcd</p> <p>lcredit\uff1a\u6700\u5c11\u5c0f\u5199\u5b57\u6bcd</p> <p>dcredit\uff1a\u6700\u5c11\u6570\u5b57</p> <p>retry\uff1a\u91cd\u8bd5\u591a\u5c11\u6b21\u540e\u8fd4\u56de\u5bc6\u7801\u4fee\u6539\u9519\u8bef</p> <p>\u3010\u6ce8\u3011\u7528root\u4fee\u6539\u5176\u4ed6\u5e10\u53f7\u90fd\u4e0d\u53d7\u5bc6\u7801\u5468\u671f\u53ca\u590d\u6742\u5ea6\u914d\u7f6e\u7684\u5f71\u54cd\u3002</p>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#12-\u767b\u5f55\u5931\u8d25\u7b56\u7565","title":"1.2 \u767b\u5f55\u5931\u8d25\u7b56\u7565","text":"<p>\u5e94\u542f\u7528\u767b\u5f55\u5931\u8d25\u5904\u7406\u529f\u80fd\uff0c\u53ef\u91c7\u53d6\u7ed3\u675f\u4f1a\u8bdd\u3001\u9650\u5236\u975e\u6cd5\u767b\u5f55\u6b21\u6570\u548c\u81ea\u52a8\u9000\u51fa\u7b49\u63aa\u65bd\u3002</p> <p>\u906d\u9047\u5bc6\u7801\u7834\u89e3\u65f6\uff0c\u6682\u65f6\u9501\u5b9a\u5e10\u53f7\uff0c\u964d\u4f4e\u5bc6\u7801\u88ab\u731c\u89e3\u7684\u53ef\u80fd\u6027</p> <ul> <li>\u65b9\u6cd5\u4e00\uff1a/etc/pam.d/login\u4e2d\u8bbe\u5b9a\u63a7\u5236\u53f0\uff1b/etc/pam.d/sshd\u4e2d\u8bbe\u5b9aSSH</li> </ul> <p>/etc/pam.d/sshd\u4e2d\u7b2c\u4e8c\u884c\u6dfb\u52a0\u4e0b\u5217\u4fe1\u606f</p> <pre><code>auth required  pam_tally2.so deny=5 lock_time=2 even_deny_root unlock_time=60\n</code></pre> <p># pam_tally2 --user root</p> <p>\u89e3\u9501\u7528\u6237</p> <p># pam_tally2 -r -u root</p> <p>even_deny_root    \u4e5f\u9650\u5236root\u7528\u6237(\u9ed8\u8ba4\u914d\u7f6e\u5c31\u9501\u5b9aroot\u5e10\u53f7)\uff1b  deny     \u8bbe\u7f6e\u666e\u901a\u7528\u6237\u548croot\u7528\u6237\u8fde\u7eed\u9519\u8bef\u767b\u9646\u7684\u6700\u5927\u6b21\u6570\uff0c\u8d85\u8fc7\u6700\u5927\u6b21\u6570\uff0c\u5219\u9501\u5b9a\u8be5\u7528\u6237  unlock_time     \u8bbe\u5b9a\u666e\u901a\u7528\u6237\u9501\u5b9a\u540e\uff0c\u591a\u5c11\u65f6\u95f4\u540e\u89e3\u9501\uff0c\u5355\u4f4d\u662f\u79d2\uff1b </p> <p>root_unlock_time      \u8bbe\u5b9aroot\u7528\u6237\u9501\u5b9a\u540e\uff0c\u591a\u5c11\u65f6\u95f4\u540e\u89e3\u9501\uff0c\u5355\u4f4d\u662f\u79d2\uff1b</p>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#13-\u5b89\u5168\u7684\u8fdc\u7a0b\u7ba1\u7406\u65b9\u5f0f","title":"1.3 \u5b89\u5168\u7684\u8fdc\u7a0b\u7ba1\u7406\u65b9\u5f0f","text":"<p>\u5f53\u5bf9\u670d\u52a1\u5668\u8fdb\u884c\u8fdc\u7a0b\u7ba1\u7406\u65f6\uff0c\u5e94\u91c7\u53d6\u5fc5\u8981\u63aa\u65bd\uff0c\u9632\u6b62\u9274\u522b\u4fe1\u606f\u5728\u7f51\u7edc\u4f20\u8f93\u8fc7\u7a0b\u4e2d\u88ab\u7a83\u542c\u3002</p> <p>\u9632\u6b62\u8fdc\u7a0b\u7ba1\u7406\u8fc7\u7a0b\u4e2d\uff0c\u5bc6\u7801\u7b49\u654f\u611f\u4fe1\u606f\u88ab\u7a83\u542c</p> <p>\u6267\u884c\u5982\u4e0b\u8bed\u53e5\uff0c\u67e5\u770btelnet\u670d\u52a1\u662f\u5426\u5728\u8fd0\u884c</p> <p></p> <p>\u7981\u6b62telnet\u8fd0\u884c\uff0c\u7981\u6b62\u5f00\u673a\u542f\u52a8\uff0c\u5982\u4e0b\u56fe\uff1a</p> <p></p>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#\u4e8c-\u8bbf\u95ee\u63a7\u5236","title":"\u4e8c \u8bbf\u95ee\u63a7\u5236","text":""},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#21-\u8d26\u53f7\u53ca\u5bc6\u7801","title":"2.1 \u8d26\u53f7\u53ca\u5bc6\u7801","text":"<p>\u5e94\u53ca\u65f6\u5220\u9664\u591a\u4f59\u7684\u3001\u8fc7\u671f\u7684\u5e10\u6237\uff0c\u907f\u514d\u5171\u4eab\u5e10\u6237\u7684\u5b58\u5728\u3002</p> <p>\u5220\u9664\u6216\u7981\u7528\u4e34\u65f6\u3001\u8fc7\u671f\u53ca\u53ef\u7591\u7684\u5e10\u53f7\uff0c\u9632\u6b62\u88ab\u975e\u6cd5\u5229\u7528\u3002</p> <p>\u4e3b\u8981\u662f\u7ba1\u7406\u5458\u521b\u5efa\u7684\u666e\u901a\u5e10\u53f7\uff0c\u5982\uff1atest</p> <pre><code># usermod -L user \u7981\u7528\u5e10\u53f7\uff0c\u5e10\u53f7\u65e0\u6cd5\u767b\u5f55\uff0c/etc/shadow\u7b2c\u4e8c\u680f\u663e\u793a\u4e3a!\u5f00\u5934\n# userdel user \u5220\u9664user\u7528\u6237\n# userdel -r user\u5c06\u5220\u9664user\u7528\u6237\uff0c\u5e76\u4e14\u5c06/home\u76ee\u5f55\u4e0b\u7684user\u76ee\u5f55\u4e00\u5e76\u5220\u9664\n</code></pre>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#22-\u68c0\u67e5\u7279\u6b8a\u8d26\u53f7","title":"2.2 \u68c0\u67e5\u7279\u6b8a\u8d26\u53f7","text":"<p>\u68c0\u67e5\u662f\u5426\u5b58\u5728\u7a7a\u53e3\u4ee4\u548croot\u6743\u9650\u7684\u8d26\u53f7\u3002</p> <p>\u64cd\u4f5c\u6b65\u9aa4</p> <ol> <li>\u67e5\u770b\u7a7a\u53e3\u4ee4\u548croot\u6743\u9650\u8d26\u53f7\uff0c\u786e\u8ba4\u662f\u5426\u5b58\u5728\u5f02\u5e38\u8d26\u53f7\uff1a</li> <li>\u4f7f\u7528\u547d\u4ee4 <code>awk -F: '($2==\"\")' /etc/shadow</code> \u67e5\u770b\u7a7a\u53e3\u4ee4\u8d26\u53f7\u3002</li> <li>\u4f7f\u7528\u547d\u4ee4 <code>awk -F: '($3==0)' /etc/passwd</code> \u67e5\u770bUID\u4e3a\u96f6\u7684\u8d26\u53f7\u3002</li> <li>\u52a0\u56fa\u7a7a\u53e3\u4ee4\u8d26\u53f7\uff1a</li> <li>\u4f7f\u7528\u547d\u4ee4 <code>passwd &lt;\u7528\u6237\u540d&gt;</code> \u4e3a\u7a7a\u53e3\u4ee4\u8d26\u53f7\u8bbe\u5b9a\u5bc6\u7801\u3002</li> <li>\u786e\u8ba4UID\u4e3a\u96f6\u7684\u8d26\u53f7\u53ea\u6709root\u8d26\u53f7\u3002</li> </ol>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#23-\u6dfb\u52a0\u5bc6\u7801\u7b56\u7565","title":"2.3 \u6dfb\u52a0\u5bc6\u7801\u7b56\u7565","text":"<p>\u52a0\u5f3a\u53e3\u4ee4\u7684\u590d\u6742\u5ea6\u7b49\uff0c\u964d\u4f4e\u88ab\u731c\u89e3\u7684\u53ef\u80fd\u6027\u3002</p> <p>\u64cd\u4f5c\u6b65\u9aa4</p> <ol> <li>\u4f7f\u7528\u547d\u4ee4</li> </ol> <pre><code>vi /etc/login.defs \n</code></pre> <p>\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u3002</p> <ul> <li><code>PASS_MAX_DAYS 90 #\u65b0\u5efa\u7528\u6237\u7684\u5bc6\u7801\u6700\u957f\u4f7f\u7528\u5929\u6570</code></li> <li><code>PASS_MIN_DAYS 0 #\u65b0\u5efa\u7528\u6237\u7684\u5bc6\u7801\u6700\u77ed\u4f7f\u7528\u5929\u6570</code></li> <li> <p><code>PASS_WARN_AGE 7 #\u65b0\u5efa\u7528\u6237\u7684\u5bc6\u7801\u5230\u671f\u63d0\u524d\u63d0\u9192\u5929\u6570</code></p> </li> <li> <p>\u4f7f\u7528chage\u547d\u4ee4\u4fee\u6539\u7528\u6237\u8bbe\u7f6e\u3002    \u4f8b\u5982\uff0c<code>chage -m 0 -M 30 -E 2000-01-01 -W 7 &lt;\u7528\u6237\u540d&gt;</code>\u8868\u793a\u5c06\u6b64\u7528\u6237\u7684\u5bc6\u7801\u6700\u957f\u4f7f\u7528\u5929\u6570\u8bbe\u4e3a30\uff0c\u6700\u77ed\u4f7f\u7528\u5929\u6570\u8bbe\u4e3a0\uff0c\u5bc6\u78012000\u5e741\u67081\u65e5\u8fc7\u671f\uff0c\u8fc7\u671f\u524d\u4e03\u5929\u8b66\u544a\u7528\u6237\u3002</p> </li> <li> <p>\u8bbe\u7f6e\u8fde\u7eed\u8f93\u9519\u4e09\u6b21\u5bc6\u7801\uff0c\u8d26\u53f7\u9501\u5b9a\u4e94\u5206\u949f\u3002\u4f7f\u7528\u547d\u4ee4 <code>vi /etc/pam.d/common-auth</code>\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0 <code>auth required pam_tally.so onerr=fail deny=3 unlock_time=300</code>\u3002</p> </li> </ul>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#24-\u9650\u5236\u80fdsu\u5230root\u7684\u7528\u6237\u53ca\u7981\u7528root\u767b\u9646","title":"2.4 \u9650\u5236\u80fdsu\u5230root\u7684\u7528\u6237\u53ca\u7981\u7528root\u767b\u9646","text":"<p>\u4f7f\u7528\u547d\u4ee4 <code>vi /etc/pam.d/su</code>\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0\u884c\u3002\u4f8b\u5982\uff0c\u53ea\u5141\u8bb8test\u7ec4\u7528\u6237su\u5230root\uff0c\u5219\u6dfb\u52a0 <code>auth required pam_wheel.so group=test</code>\u3002</p> <p>\u7981\u6b62root\u76f4\u63a5\u767b\u9646\u3002</p> <ol> <li>\u521b\u5efa\u666e\u901a\u6743\u9650\u8d26\u53f7\u5e76\u914d\u7f6e\u5bc6\u7801,\u9632\u6b62\u65e0\u6cd5\u8fdc\u7a0b\u767b\u5f55;</li> <li>\u4f7f\u7528\u547d\u4ee4 <code>vi /etc/ssh/sshd_config</code>\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u5c06PermitRootLogin\u7684\u503c\u6539\u6210no\uff0c\u5e76\u4fdd\u5b58\uff0c\u7136\u540e\u4f7f\u7528<code>service sshd restart</code>\u91cd\u542f\u670d\u52a1\u3002</li> </ol>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#\u4e09-\u5b89\u5168\u5ba1\u8ba1","title":"\u4e09 \u5b89\u5168\u5ba1\u8ba1","text":""},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#31-\u5ba1\u6838\u7b56\u7565\u5f00\u542f","title":"3.1 \u5ba1\u6838\u7b56\u7565\u5f00\u542f","text":"<p>\u5ba1\u8ba1\u8303\u56f4\u5e94\u8986\u76d6\u5230\u670d\u52a1\u5668\u548c\u91cd\u8981\u5ba2\u6237\u7aef\u4e0a\u7684\u6bcf\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u7528\u6237\u548c\u6570\u636e\u5e93\u7528\u6237\uff1b</p> <p>\u5f00\u542f\u5ba1\u6838\u7b56\u7565\uff0c\u82e5\u65e5\u540e\u7cfb\u7edf\u51fa\u73b0\u6545\u969c\u3001\u5b89\u5168\u4e8b\u6545\u5219\u53ef\u4ee5\u67e5\u770b\u7cfb\u7edf\u65e5\u5fd7\u6587\u4ef6\uff0c\u6392\u9664\u6545\u969c\u3001\u8ffd\u67e5\u5165\u4fb5\u8005\u7684\u4fe1\u606f\u7b49\u3002</p> <p>\u67e5\u770brsyslog\u4e0eauditd\u670d\u52a1\u662f\u5426\u5f00\u542f</p> <p>rsyslog\u4e00\u822c\u90fd\u4f1a\u5f00\u542f\uff0cauditd\u5982\u6ca1\u5f00\u542f\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a</p> <p>```shell</p>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#systemctl-start-auditd","title":"systemctl start auditd","text":"<p>```</p> <p>auditd\u670d\u52a1\u5f00\u673a\u542f\u52a8</p> <pre><code># systemctl start auditd\n</code></pre>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#32-\u65e5\u5fd7\u5c5e\u6027\u8bbe\u7f6e","title":"3.2 \u65e5\u5fd7\u5c5e\u6027\u8bbe\u7f6e","text":"<p>\u5e94\u4fdd\u62a4\u5ba1\u8ba1\u8bb0\u5f55\uff0c\u907f\u514d\u53d7\u5230\u672a\u9884\u671f\u7684\u5220\u9664\u3001\u4fee\u6539\u6216\u8986\u76d6\u7b49\u3002</p> <p>\u9632\u6b62\u91cd\u8981\u65e5\u5fd7\u4fe1\u606f\u88ab\u8986\u76d6</p> <p>\u8ba9\u65e5\u5fd7\u6587\u4ef6\u8f6c\u50a8\u4e00\u4e2a\u6708\uff0c\u4fdd\u75596\u4e2a\u6708\u7684\u4fe1\u606f\uff0c\u5148\u67e5\u770b\u76ee\u524d\u914d\u7f6e\uff0c</p> <pre><code># more /etc/logrotate.conf | grep -v \"^#\\|^$\"\n</code></pre> <p></p>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#33-\u542f\u7528syslog","title":"3.3 \u542f\u7528syslog","text":"<p>\u542f\u7528\u65e5\u5fd7\u529f\u80fd\uff0c\u5e76\u914d\u7f6e\u65e5\u5fd7\u8bb0\u5f55\u3002</p> <p>\u64cd\u4f5c\u6b65\u9aa4</p> <p>Linux\u7cfb\u7edf\u9ed8\u8ba4\u542f\u7528\u4ee5\u4e0b\u7c7b\u578b\u65e5\u5fd7\uff1a</p> <ul> <li>\u7cfb\u7edf\u65e5\u5fd7\uff08\u9ed8\u8ba4\uff09/var/log/messages</li> <li>cron\u65e5\u5fd7\uff08\u9ed8\u8ba4\uff09/var/log/cron</li> <li>\u5b89\u5168\u65e5\u5fd7\uff08\u9ed8\u8ba4\uff09/var/log/secure</li> </ul> <p>\u6ce8\u610f\uff1a\u90e8\u5206\u7cfb\u7edf\u53ef\u80fd\u4f7f\u7528syslog-ng\u65e5\u5fd7\uff0c\u914d\u7f6e\u6587\u4ef6\u4e3a\uff1a/etc/syslog-ng/syslog-ng.conf\u3002</p> <p>\u60a8\u53ef\u4ee5\u6839\u636e\u9700\u6c42\u914d\u7f6e\u8be6\u7ec6\u65e5\u5fd7\u3002</p>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#\u56db-\u5165\u4fb5\u9632\u5fa1","title":"\u56db \u5165\u4fb5\u9632\u5fa1","text":"<p>\u64cd\u4f5c\u7cfb\u7edf\u9075\u5faa\u6700\u5c0f\u5b89\u88c5\u7684\u539f\u5219\uff0c\u4ec5\u5b89\u88c5\u9700\u8981\u7684\u7ec4\u4ef6\u548c\u5e94\u7528\u7a0b\u5e8f\uff0c\u5e76\u901a\u8fc7\u8bbe\u7f6e\u5347\u7ea7\u670d\u52a1\u5668\u7b49\u65b9\u5f0f\u4fdd\u6301\u7cfb\u7edf\u8865\u4e01\u53ca\u65f6\u5f97\u5230\u66f4\u65b0\u3002</p> <p>\u5173\u95ed\u4e0e\u7cfb\u7edf\u4e1a\u52a1\u65e0\u5173\u6216\u4e0d\u5fc5\u8981\u7684\u670d\u52a1\uff0c\u51cf\u5c0f\u7cfb\u7edf\u88ab\u9ed1\u5ba2\u88ab\u653b\u51fb\u3001\u6e17\u900f\u7684\u98ce\u9669\u3002</p> <p>\u7981\u7528\u84dd\u7259\u670d\u52a1</p> <pre><code># systemctl stop bluetooth\n</code></pre>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#\u4e94-\u7cfb\u7edf\u8d44\u6e90\u63a7\u5236","title":"\u4e94 \u7cfb\u7edf\u8d44\u6e90\u63a7\u5236","text":""},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#51-\u8bbf\u95ee\u63a7\u5236","title":"5.1 \u8bbf\u95ee\u63a7\u5236","text":"<p>\u5e94\u901a\u8fc7\u8bbe\u5b9a\u7ec8\u7aef\u63a5\u5165\u65b9\u5f0f\u3001\u7f51\u7edc\u5730\u5740\u8303\u56f4\u7b49\u6761\u4ef6\u9650\u5236\u7ec8\u7aef\u767b\u5f55\u3002</p> <p>\u5bf9\u63a5\u5165\u670d\u52a1\u5668\u7684IP\u3001\u65b9\u5f0f\u7b49\u8fdb\u884c\u9650\u5236\uff0c\u53ef\u4ee5\u963b\u6b62\u975e\u6cd5\u5165\u4fb5\u3002</p> <ul> <li>\u5728/etc/hosts.allow\u548c/etc/hosts.deny\u6587\u4ef6\u4e2d\u914d\u7f6e\u63a5\u5165\u9650\u5236</li> </ul> <p>\u6700\u597d\u7684\u7b56\u7565\u5c31\u662f\u963b\u6b62\u6240\u6709\u7684\u4e3b\u673a\u5728\u201c/etc/hosts.deny\u201d\u6587\u4ef6\u4e2d\u52a0\u5165\u201c ALL:ALL@ALL, PARANOID \u201d\uff0c\u7136\u540e\u518d\u5728\u201c/etc/hosts.allow\u201d \u6587\u4ef6\u4e2d\u52a0\u5165\u6240\u6709\u5141\u8bb8\u8bbf\u95ee\u7684\u4e3b\u673a\u5217\u8868\u3002\u5982\u4e0b\u64cd\u4f5c\uff1a</p> <p>\u7f16\u8f91 hosts.deny\u6587\u4ef6\uff08vi /etc/hosts.deny\uff09\uff0c\u52a0\u5165\u4e0b\u9762\u8be5\u884c\uff1a</p> <pre><code># Deny access to everyone. \nALL: ALL@ALL, PARANOID\n</code></pre> <p>\u7f16\u8f91hosts.allow \u6587\u4ef6\uff08vi /etc/hosts.allow\uff09\uff0c\u52a0\u5165\u5141\u8bb8\u8bbf\u95ee\u7684\u4e3b\u673a\u5217\u8868\uff0c\u6bd4\u5982\uff1a</p> <p>ftp: 202.54.15.99 foo.com    //202.54.15.99\u662f\u5141\u8bb8\u8bbf\u95ee ftp \u670d\u52a1\u7684 IP \u5730\u5740</p> <p>//foo.com \u662f\u5141\u8bb8\u8bbf\u95ee ftp \u670d\u52a1\u7684\u4e3b\u673a\u540d\u79f0\u3002</p> <ul> <li>\u4e5f\u53ef\u4ee5\u7528iptables\u8fdb\u884c\u8bbf\u95ee\u63a7\u5236 </li> </ul>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#52-\u8d85\u65f6\u9501\u5b9a","title":"5.2 \u8d85\u65f6\u9501\u5b9a","text":"<p>\u5e94\u6839\u636e\u5b89\u5168\u7b56\u7565\u8bbe\u7f6e\u767b\u5f55\u7ec8\u7aef\u7684\u64cd\u4f5c\u8d85\u65f6\u9501\u5b9a\u3002</p> <p>\u8bbe\u7f6e\u767b\u5f55\u8d85\u65f6\u65f6\u95f4\uff0c\u91ca\u653e\u7cfb\u7edf\u8d44\u6e90\uff0c\u4e5f\u63d0\u9ad8\u670d\u52a1\u5668\u7684\u5b89\u5168\u6027\u3002</p> <p>/etc/profile\u4e2d\u6dfb\u52a0\u5982\u4e0b\u4e00\u884c</p> <pre><code>exprot TMOUT=900  //15\u5206\u949f# source /etc/profile\n</code></pre> <p>\u6539\u53d8\u8fd9\u9879\u8bbe\u7f6e\u540e\uff0c\u5fc5\u987b\u5148\u6ce8\u9500\u7528\u6237\uff0c\u518d\u7528\u8be5\u7528\u6237\u767b\u5f55\u624d\u80fd\u6fc0\u6d3b\u8fd9\u4e2a\u529f\u80fd\u3002</p> <p>\u5982\u679c\u6709\u9700\u8981\uff0c\u5f00\u542f\u5c4f\u5e55\u4fdd\u62a4\u529f\u80fd</p> <p>\u8bbe\u7f6e\u5c4f\u5e55\u4fdd\u62a4\uff1a\u8bbe\u7f6e -&gt; \u7cfb\u7edf\u8bbe\u7f6e -&gt; \u5c4f\u5e55\u4fdd\u62a4\u7a0b\u5e8f\uff0c\u8fdb\u884c\u64cd\u4f5c</p>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#\u516d--\u6700\u4f73\u7ecf\u9a8c\u5b9e\u8df5","title":"\u516d  \u6700\u4f73\u7ecf\u9a8c\u5b9e\u8df5","text":"<p>\u5bf9Linux\u7cfb\u7edf\u7684\u5b89\u5168\u6027\u63d0\u5347\u6709\u4e00\u5b9a\u5e2e\u52a9\u3002</p>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#61-dos\u653b\u51fb\u9632\u5fa1","title":"6.1 DOS\u653b\u51fb\u9632\u5fa1","text":"<p>\u9632\u6b62\u62d2\u7edd\u670d\u52a1\u653b\u51fb</p> <p>TCP SYN\u4fdd\u62a4\u673a\u5236\u7b49\u8bbe\u7f6e</p> <ul> <li>\u6253\u5f00 syncookie\uff1a</li> </ul> <pre><code># echo\u201c1\u201d&gt;/proc/sys/net/ipv4/tcp_syncookies  //\u9ed8\u8ba4\u4e3a1\uff0c\u4e00\u822c\u4e0d\u7528\u8bbe\u7f6e\n</code></pre> <p>\u8868\u793a\u5f00\u542fSYN Cookies\u3002\u5f53\u51fa\u73b0SYN\u7b49\u5f85\u961f\u5217\u6ea2\u51fa\u65f6\uff0c\u542f\u7528cookies\u6765\u5904\u7406\uff0c\u53ef\u9632\u8303\u5c11\u91cfSYN\u653b\u51fb\uff0c\u9ed8\u8ba4\u4e3a0\uff0c\u8868\u793a\u5173\u95ed\uff1b</p> <ul> <li>\u9632syn \u653b\u51fb\u4f18\u5316</li> </ul> <p>\u7528vi\u7f16\u8f91/etc/sysctl.conf\uff0c\u6dfb\u52a0\u5982\u4e0b\u884c\uff1a</p> <pre><code>net.ipv4.tcp_max_syn_backlog = 2048\n</code></pre>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#62-\u5386\u53f2\u547d\u4ee4","title":"6.2 \u5386\u53f2\u547d\u4ee4","text":"<p>\u4e3a\u5386\u53f2\u7684\u547d\u4ee4\u589e\u52a0\u767b\u5f55\u7684IP\u5730\u5740\u3001\u6267\u884c\u547d\u4ee4\u65f6\u95f4\u7b49</p> <ul> <li>\u4fdd\u5b581\u4e07\u6761\u547d\u4ee4</li> </ul> <pre><code># sed -i 's/^HISTSIZE=1000/HISTSIZE=10000/g' /etc/profile\n</code></pre> <ul> <li>\u5728/etc/profile\u7684\u6587\u4ef6\u5c3e\u90e8\u6dfb\u52a0\u5982\u4e0b\u884c\u6570\u914d\u7f6e\u4fe1\u606f\uff1a</li> </ul> <pre><code>USER_IP=`who -u am i 2&gt;/dev/null| awk '{print $NF}' |sed -e 's/[()]//g'`if [ \"$USER_IP\" = \"\" ]thenUSER_IP=`hostname`fiexport HISTTIMEFORMAT=\"%F %T $USER_IP `whoami` \"shopt -s histappendexport PROMPT_COMMAND=\"history -a\"\n</code></pre>"},{"location":"Linux/system/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/#\u53c2\u8003\u94fe\u63a5","title":"\u53c2\u8003\u94fe\u63a5","text":"<ul> <li>https://mp.weixin.qq.com/s/Sq1Kdl6OfIR_0VM7IXCHOA</li> </ul>"},{"location":"Linux/system/virtio%E8%AF%A6%E8%A7%A3/","title":"Virtio \u8be6\u89e3","text":""},{"location":"Linux/system/virtio%E8%AF%A6%E8%A7%A3/#\u4e00-\u7b80\u4ecb","title":"\u4e00 \u7b80\u4ecb","text":"<p>virtio \u662f\u4e00\u79cd I/O \u534a\u865a\u62df\u5316\u89e3\u51b3\u65b9\u6848\uff0c\u662f\u4e00\u5957\u901a\u7528 I/O \u8bbe\u5907\u865a\u62df\u5316\u7684\u7a0b\u5e8f\uff0c\u662f\u5bf9\u534a\u865a\u62df\u5316 Hypervisor \u4e2d\u7684\u4e00\u7ec4\u901a\u7528 I/O \u8bbe\u5907\u7684\u62bd\u8c61\u3002\u63d0\u4f9b\u4e86\u4e00\u5957\u4e0a\u5c42\u5e94\u7528\u4e0e\u5404 Hypervisor \u865a\u62df\u5316\u8bbe\u5907\uff08KVM\uff0cXen\uff0cVMware\u7b49\uff09\u4e4b\u95f4\u7684\u901a\u4fe1\u6846\u67b6\u548c\u7f16\u7a0b\u63a5\u53e3\uff0c\u51cf\u5c11\u8de8\u5e73\u53f0\u6240\u5e26\u6765\u7684\u517c\u5bb9\u6027\u95ee\u9898\uff0c\u5927\u5927\u63d0\u9ad8\u9a71\u52a8\u7a0b\u5e8f\u5f00\u53d1\u6548\u7387\u3002</p> <p></p>"},{"location":"Linux/system/virtio%E8%AF%A6%E8%A7%A3/#\u4e8c-\u4e3a\u4ec0\u4e48\u662f-virtio","title":"\u4e8c \u4e3a\u4ec0\u4e48\u662f virtio","text":"<p>\u5728\u5b8c\u5168\u865a\u62df\u5316\u7684\u89e3\u51b3\u65b9\u6848\u4e2d\uff0cguest VM \u8981\u4f7f\u7528\u5e95\u5c42 host \u8d44\u6e90\uff0c\u9700\u8981 Hypervisor \u6765\u622a\u83b7\u6240\u6709\u7684\u8bf7\u6c42\u6307\u4ee4\uff0c\u7136\u540e\u6a21\u62df\u51fa\u8fd9\u4e9b\u6307\u4ee4\u7684\u884c\u4e3a\uff0c\u8fd9\u6837\u52bf\u5fc5\u4f1a\u5e26\u6765\u5f88\u591a\u6027\u80fd\u4e0a\u7684\u5f00\u9500\u3002\u534a\u865a\u62df\u5316\u901a\u8fc7\u5e95\u5c42\u786c\u4ef6\u8f85\u52a9\u7684\u65b9\u5f0f\uff0c\u5c06\u90e8\u5206\u6ca1\u5fc5\u8981\u865a\u62df\u5316\u7684\u6307\u4ee4\u901a\u8fc7\u786c\u4ef6\u6765\u5b8c\u6210\uff0cHypervisor \u53ea\u8d1f\u8d23\u5b8c\u6210\u90e8\u5206\u6307\u4ee4\u7684\u865a\u62df\u5316\uff0c\u8981\u505a\u5230\u8fd9\u70b9\uff0c\u9700\u8981 guest \u6765\u914d\u5408\uff0cguest \u5b8c\u6210\u4e0d\u540c\u8bbe\u5907\u7684\u524d\u7aef\u9a71\u52a8\u7a0b\u5e8f\uff0cHypervisor \u914d\u5408 guest \u5b8c\u6210\u76f8\u5e94\u7684\u540e\u7aef\u9a71\u52a8\u7a0b\u5e8f\uff0c\u8fd9\u6837\u4e24\u8005\u4e4b\u95f4\u901a\u8fc7\u67d0\u79cd\u4ea4\u4e92\u673a\u5236\u5c31\u53ef\u4ee5\u5b9e\u73b0\u9ad8\u6548\u7684\u865a\u62df\u5316\u8fc7\u7a0b\u3002</p> <p>\u7531\u4e8e\u4e0d\u540c guest \u524d\u7aef\u8bbe\u5907\u5176\u5de5\u4f5c\u903b\u8f91\u5927\u540c\u5c0f\u5f02\uff08\u5982\u5757\u8bbe\u5907\u3001\u7f51\u7edc\u8bbe\u5907\u3001PCI\u8bbe\u5907\u3001balloon\u9a71\u52a8\u7b49\uff09\uff0c\u5355\u72ec\u4e3a\u6bcf\u4e2a\u8bbe\u5907\u5b9a\u4e49\u4e00\u5957\u63a5\u53e3\u5b9e\u5c5e\u6ca1\u6709\u5fc5\u8981\uff0c\u800c\u4e14\u8fd8\u8981\u8003\u8651\u6269\u5e73\u53f0\u7684\u517c\u5bb9\u6027\u95ee\u9898\uff0c\u53e6\u5916\uff0c\u4e0d\u540c\u540e\u7aef Hypervisor \u7684\u5b9e\u73b0\u65b9\u5f0f\u4e5f\u5927\u540c\u5c0f\u5f02\uff08\u5982KVM\u3001Xen\u7b49\uff09\uff0c\u8fd9\u4e2a\u65f6\u5019\uff0c\u5c31\u9700\u8981\u4e00\u5957\u901a\u7528\u6846\u67b6\u548c\u6807\u51c6\u63a5\u53e3\uff08\u534f\u8bae\uff09\u6765\u5b8c\u6210\u4e24\u8005\u4e4b\u95f4\u7684\u4ea4\u4e92\u8fc7\u7a0b\uff0cvirtio \u5c31\u662f\u8fd9\u6837\u4e00\u5957\u6807\u51c6\uff0c\u5b83\u6781\u5927\u5730\u89e3\u51b3\u4e86\u8fd9\u4e9b\u4e0d\u901a\u7528\u7684\u95ee\u9898\u3002</p> <p></p>"},{"location":"Linux/system/virtio%E8%AF%A6%E8%A7%A3/#\u4e09-virti\u7279\u5f81","title":"\u4e09 Virti\u7279\u5f81","text":"<ul> <li>\u7b80\u5355\u6613\u5f00\u53d1</li> </ul> <p>virtio PCI \u8bbe\u5907\u4f7f\u7528\u901a\u7528\u7684 PCI \u7684\u4e2d\u65ad\u548c DMA \u673a\u5236\uff0c\u5bf9\u4e8e\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8005\u6765\u8bf4\u4e0d\u4f1a\u5e26\u6765\u56f0\u96be\u3002</p> <ul> <li>\u9ad8\u6548</li> </ul> <p>virtio PCI \u8bbe\u5907\u4f7f\u7528\u9488\u5bf9\u8f93\u5165\u548c\u8f93\u51fa\u4f7f\u7528\u4e0d\u540c\u7684 vring\uff0c\u89c4\u907f\u4e86\u53ef\u80fd\u7684\u7531\u9ad8\u901f\u7f13\u5b58\u5e26\u6765\u7684\u5f71\u54cd\u3002</p> <ul> <li>\u6807\u51c6</li> </ul> <p>virtio PCI \u4e0d\u5047\u5b9a\u5176\u6240\u5904\u7684\u73af\u5883\u4e00\u5b9a\u9700\u8981\u5bf9 PCI \u7684\u652f\u6301\uff0c\u5b9e\u9645\u4e0a\u5f53\u524d\u5f88\u591a virtio \u8bbe\u5907\u5df2\u7ecf\u5728\u975e PCI \u603b\u7ebf\u4e0a\u5b9e\u73b0\u4e86\uff0c\u8fd9\u4e9b\u8bbe\u5907\u6839\u672c\u4e0d\u9700\u8981 PCI\u3002</p> <ul> <li>\u53ef\u6269\u5c55</li> </ul> <p>virtio PCI \u8bbe\u5907\u5305\u542b\u4e00\u7ec4 Feature Bits,\u5728\u8bbe\u5907\u5b89\u88c5\u8fc7\u7a0b\u4e2d\uff0c\u53ef\u4ee5\u544a\u77e5 guest OS\u3002\u8bbe\u5907\u548c\u9a71\u52a8\u4e4b\u95f4\u76f8\u4e92\u534f\u8c03\uff0c\u9a71\u52a8\u53ef\u4ee5\u6839\u636e\u8bbe\u5907\u63d0\u4f9b\u7684\u7279\u6027\u4ee5\u53ca\u9a71\u52a8\u81ea\u8eab\u80fd\u591f\u652f\u6301\u7684\u7279\u6027\u6765\u6700\u7ec8\u786e\u5b9a\u5728 guest OS \u91cc\u9762\u80fd\u591f\u4f7f\u7528\u7684\u8bbe\u5907\u7279\u6027\u3002\u8fd9\u6837\u53ef\u4ee5\u987e\u53ca\u5230\u8bbe\u5907\u7684\u524d\u540e\u517c\u5bb9\u6027\u3002\u56e0\u6b64\uff0c\u5bf9\u4e0e guest OS \u6765\u8bf4\uff0c\u53ea\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a PCI \u8bbe\u5907\u9a71\u52a8\uff0c\u7136\u540e Hypervisor \u6dfb\u52a0\u8bbe\u5907\u7684 vring \u652f\u6301\u5373\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a virtio \u8bbe\u5907\u3002</p>"},{"location":"Linux/system/virtio%E8%AF%A6%E8%A7%A3/#\u4e09-virtio-\u7684\u67b6\u6784","title":"\u4e09 virtio \u7684\u67b6\u6784","text":"<p>\u4ece\u603b\u4f53\u4e0a\u770b\uff0cvirtio \u53ef\u4ee5\u5206\u4e3a\u56db\u5c42\uff0c\u5305\u62ec\u524d\u7aef guest \u4e2d\u5404\u79cd\u9a71\u52a8\u7a0b\u5e8f\u6a21\u5757\uff0c\u540e\u7aef Hypervisor \uff08\u5b9e\u73b0\u5728Qemu\u4e0a\uff09\u4e0a\u7684\u5904\u7406\u7a0b\u5e8f\u6a21\u5757\uff0c\u4e2d\u95f4\u7528\u4e8e\u524d\u540e\u7aef\u901a\u4fe1\u7684 virtio \u5c42\u548c virtio-ring \u5c42\uff0cvirtio \u8fd9\u4e00\u5c42\u5b9e\u73b0\u7684\u662f\u865a\u62df\u961f\u5217\u63a5\u53e3\uff0c\u7b97\u662f\u524d\u540e\u7aef\u901a\u4fe1\u7684\u6865\u6881\uff0c\u800c virtio-ring \u5219\u662f\u8be5\u6865\u6881\u7684\u5177\u4f53\u5b9e\u73b0\uff0c\u5b83\u5b9e\u73b0\u4e86\u4e24\u4e2a\u73af\u5f62\u7f13\u51b2\u533a\uff0c\u5206\u522b\u7528\u4e8e\u4fdd\u5b58\u524d\u7aef\u9a71\u52a8\u7a0b\u5e8f\u548c\u540e\u7aef\u5904\u7406\u7a0b\u5e8f\u6267\u884c\u7684\u4fe1\u606f\u3002</p> <p></p> <p>\u4e25\u683c\u6765\u8bf4\uff0cvirtio \u548c virtio-ring \u53ef\u4ee5\u770b\u505a\u662f\u4e00\u5c42\uff0cvirtio-ring \u5b9e\u73b0\u4e86 virtio \u7684\u5177\u4f53\u901a\u4fe1\u673a\u5236\u548c\u6570\u636e\u6d41\u7a0b\u3002\u6216\u8005\u8fd9\u4e48\u7406\u89e3\u53ef\u80fd\u66f4\u597d\uff0cvirtio \u5c42\u5c5e\u4e8e\u63a7\u5236\u5c42\uff0c\u8d1f\u8d23\u524d\u540e\u7aef\u4e4b\u95f4\u7684\u901a\u77e5\u673a\u5236\uff08kick\uff0cnotify\uff09\u548c\u63a7\u5236\u6d41\u7a0b\uff0c\u800c virtio-vring \u5219\u8d1f\u8d23\u5177\u4f53\u6570\u636e\u6d41\u8f6c\u53d1\u3002</p>"},{"location":"Linux/system/virtio%E8%AF%A6%E8%A7%A3/#\u56db-virtio-\u6570\u636e\u6d41\u4ea4\u4e92\u673a\u5236","title":"\u56db virtio \u6570\u636e\u6d41\u4ea4\u4e92\u673a\u5236","text":"<p>vring \u4e3b\u8981\u901a\u8fc7\u4e24\u4e2a\u73af\u5f62\u7f13\u51b2\u533a\u6765\u5b8c\u6210\u6570\u636e\u6d41\u7684\u8f6c\u53d1\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002</p> <p></p> <p>vring \u5305\u542b\u4e09\u4e2a\u90e8\u5206\uff0c\u63cf\u8ff0\u7b26\u6570\u7ec4 desc\uff0c\u53ef\u7528\u7684 available ring \u548c\u4f7f\u7528\u8fc7\u7684 used ring\u3002</p> <p>desc \u7528\u4e8e\u5b58\u50a8\u4e00\u4e9b\u5173\u8054\u7684\u63cf\u8ff0\u7b26\uff0c\u6bcf\u4e2a\u63cf\u8ff0\u7b26\u8bb0\u5f55\u4e00\u4e2a\u5bf9 buffer \u7684\u63cf\u8ff0\uff0cavailable ring \u5219\u7528\u4e8e guest \u7aef\u8868\u793a\u5f53\u524d\u6709\u54ea\u4e9b\u63cf\u8ff0\u7b26\u662f\u53ef\u7528\u7684\uff0c\u800c used ring \u5219\u8868\u793a host \u7aef\u54ea\u4e9b\u63cf\u8ff0\u7b26\u5df2\u7ecf\u88ab\u4f7f\u7528\u3002</p> <p>Virtio \u4f7f\u7528 virtqueue \u6765\u5b9e\u73b0 I/O \u673a\u5236\uff0c\u6bcf\u4e2a virtqueue \u5c31\u662f\u4e00\u4e2a\u627f\u8f7d\u5927\u91cf\u6570\u636e\u7684\u961f\u5217\uff0c\u5177\u4f53\u4f7f\u7528\u591a\u5c11\u4e2a\u961f\u5217\u53d6\u51b3\u4e8e\u9700\u6c42\uff0c\u4f8b\u5982\uff0cvirtio \u7f51\u7edc\u9a71\u52a8\u7a0b\u5e8f\uff08virtio-net\uff09\u4f7f\u7528\u4e24\u4e2a\u961f\u5217\uff08\u4e00\u4e2a\u7528\u4e8e\u63a5\u53d7\uff0c\u53e6\u4e00\u4e2a\u7528\u4e8e\u53d1\u9001\uff09\uff0c\u800c virtio \u5757\u9a71\u52a8\u7a0b\u5e8f\uff08virtio-blk\uff09\u4ec5\u4f7f\u7528\u4e00\u4e2a\u961f\u5217\u3002</p> <p>\u5177\u4f53\u7684\uff0c\u5047\u8bbe guest \u8981\u5411 host \u53d1\u9001\u6570\u636e\uff0c\u9996\u5148\uff0cguest \u901a\u8fc7\u51fd\u6570 virtqueue_add_buf \u5c06\u5b58\u6709\u6570\u636e\u7684 buffer \u6dfb\u52a0\u5230 virtqueue \u4e2d\uff0c\u7136\u540e\u8c03\u7528 virtqueue_kick \u51fd\u6570\uff0cvirtqueue_kick \u8c03\u7528 virtqueue_notify \u51fd\u6570\uff0c\u901a\u8fc7\u5199\u5165\u5bc4\u5b58\u5668\u7684\u65b9\u5f0f\u6765\u901a\u77e5\u5230 host\u3002host \u8c03\u7528 virtqueue_get_buf \u6765\u83b7\u53d6 virtqueue \u4e2d\u6536\u5230\u7684\u6570\u636e\u3002</p> <p></p> <p>\u5b58\u653e\u6570\u636e\u7684 buffer \u662f\u4e00\u79cd\u5206\u6563-\u805a\u96c6\u7684\u6570\u7ec4\uff0c\u7531 desc \u7ed3\u6784\u6765\u627f\u8f7d\uff0c\u5982\u4e0b\u662f\u4e00\u79cd\u5e38\u7528\u7684 desc \u7684\u7ed3\u6784\uff1a</p> <p></p> <p>\u5f53 guest \u5411 virtqueue \u4e2d\u5199\u6570\u636e\u65f6\uff0c\u5b9e\u9645\u4e0a\u662f\u5411 desc \u7ed3\u6784\u6307\u5411\u7684 buffer \u4e2d\u586b\u5145\u6570\u636e\uff0c\u5b8c\u4e86\u4f1a\u66f4\u65b0 available ring\uff0c\u7136\u540e\u518d\u901a\u77e5 host\u3002</p> <p>\u5f53 host \u6536\u5230\u63a5\u6536\u6570\u636e\u7684\u901a\u77e5\u65f6\uff0c\u9996\u5148\u4ece desc \u6307\u5411\u7684 buffer \u4e2d\u627e\u5230 available ring \u4e2d\u6dfb\u52a0\u7684 buffer\uff0c\u6620\u5c04\u5185\u5b58\uff0c\u540c\u65f6\u66f4\u65b0 used ring\uff0c\u5e76\u901a\u77e5 guest \u63a5\u6536\u6570\u636e\u5b8c\u6bd5\u3002</p>"},{"location":"Linux/system/virtio%E8%AF%A6%E8%A7%A3/#\u4e94-\u603b\u7ed3","title":"\u4e94 \u603b\u7ed3","text":"<p>virtio \u662f guest \u4e0e host \u4e4b\u95f4\u901a\u4fe1\u7684\u6da6\u6ed1\u5242\uff0c\u63d0\u4f9b\u4e86\u4e00\u5957\u901a\u7528\u6846\u67b6\u548c\u6807\u51c6\u63a5\u53e3\u6216\u534f\u8bae\u6765\u5b8c\u6210\u4e24\u8005\u4e4b\u95f4\u7684\u4ea4\u4e92\u8fc7\u7a0b\uff0c\u6781\u5927\u5730\u89e3\u51b3\u4e86\u5404\u79cd\u9a71\u52a8\u7a0b\u5e8f\u548c\u4e0d\u540c\u865a\u62df\u5316\u89e3\u51b3\u65b9\u6848\u4e4b\u95f4\u7684\u9002\u914d\u95ee\u9898\u3002</p> <p>virtio \u62bd\u8c61\u4e86\u4e00\u5957 vring \u63a5\u53e3\u6765\u5b8c\u6210 guest \u548c host \u4e4b\u95f4\u7684\u6570\u636e\u6536\u53d1\u8fc7\u7a0b\uff0c\u7ed3\u6784\u65b0\u9896\uff0c\u63a5\u53e3\u6e05\u6670\u3002</p> <p>Virtio \u4f5c\u8005\u7684\u76ee\u6807\u662f\u8bbe\u8ba1\u4e00\u5957\u901a\u7528\u7684\uff0c\u9690\u85cf\u7ec6\u8282\u7684\uff0c\u524d\u540e\u7aef\u65b9\u4fbf\u5b9e\u73b0\uff0c\u5171\u4eab\u901a\u7528\u4ee3\u7801\u7684\u865a\u62df\u5316\u6846\u67b6\uff0c\u4ece\u5206\u6790\u770b\u6765\uff0c\u901a\u8fc7 PCI \u548c virtqueue \u7684\u62bd\u8c61\uff0c\u7684\u786e\u80fd\u8fbe\u5230\u76ee\u7684\u3002</p> <p>\u672c\u6587\u5bf9\u90e8\u5206\u7ec6\u8282\u53ea\u8fdb\u884c\u7b80\u5355\u7684\u8bf4\u660e\uff0c\u540e\u7eed\u4f1a\u5728\u4ee5\u4e0b\u51e0\u4e2a\u8bdd\u9898\u5f00\u5c55\uff1a</p> <ul> <li>Qemu \u548c virtio \u7684\u5185\u5b58\u6620\u5c04</li> <li>\u4e2d\u65ad\u6ce8\u5165\u7684\u5b9e\u73b0</li> <li>Virtio \u6d41\u63a7\u4ee5\u53ca\u6027\u80fd\u4f18\u5316</li> <li>Vhost-user</li> </ul>"},{"location":"Linux/system/virtio%E8%AF%A6%E8%A7%A3/#\u94fe\u63a5","title":"\u94fe\u63a5","text":"<ul> <li> <p>http://www.linux-kvm.org/page/Virtio</p> </li> <li> <p>https://www.cnblogs.com/bakari/p/8309638.html</p> </li> </ul>"},{"location":"Linux/system/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%8B%E6%B5%8B/","title":"\u6570\u636e\u5e93\u538b\u6d4b","text":"<p>https://help.aliyun.com/document_detail/129152.html</p>"},{"location":"Linux/system/%E7%BA%A2%E6%97%97%E7%B3%BB%E7%BB%9F%E6%93%8D%E4%BD%9C/","title":"\u7ea2\u65d7\u7cfb\u7edf\u64cd\u4f5c","text":""},{"location":"Linux/system/%E7%BA%A2%E6%97%97%E7%B3%BB%E7%BB%9F%E6%93%8D%E4%BD%9C/#\u7ea2\u65d7\u7cfb\u7edf\u64cd\u4f5c","title":"\u7ea2\u65d7\u7cfb\u7edf\u64cd\u4f5c","text":""},{"location":"Linux/system/%E7%BA%A2%E6%97%97%E7%B3%BB%E7%BB%9F%E6%93%8D%E4%BD%9C/#\u4e00-\u7ea2\u65d7\u7cfb\u7edf\u7b80\u4ecb","title":"\u4e00 \u7ea2\u65d7\u7cfb\u7edf\u7b80\u4ecb","text":"<p>Red Flag Asianux Server\uff0c\u7ea2\u65d7Asianux\u670d\u52a1\u5668\u64cd\u4f5c\u7cfb\u7edf V 8.0</p> <p>\u7ea2\u65d7Asianux Server Linux 8.0\u662f\u4e3a\u4e91\u65f6\u4ee3\u91cd\u65b0\u8bbe\u8ba1\u7684\u64cd\u4f5c\u7cfb\u7edf\uff0c\u4e3a\u4e91\u65f6\u4ee3\u7684\u5230\u6765\u5f15\u5165\u4e86\u5927\u91cf\u65b0\u529f\u80fd\uff0c\u5305\u62ec\u7528\u4e8e\u914d\u7f6e\u7ba1\u7406\u3001\u5feb\u901f\u8fc1\u79fb\u6846\u67b6\u3001\u7f16\u7a0b\u8bed\u8a00\u548c\u8bf8\u591a\u5f00\u53d1\u8005\u5de5\u5177\uff0c\u5b83\u8fd8\u4e3a\u5bb9\u5668\u5de5\u5177\u5305\u63d0\u4f9b\u5168\u9762\u652f\u6301\uff0c\u7528\u4e8e\u521b\u5efa\uff0c\u8fd0\u884c\u548c\u5171\u4eab\u5bb9\u5668\u5316\u5e94\u7528\u7a0b\u5e8f\uff0c\u65e8\u5728\u652f\u6301\u4ece\u4f01\u4e1a\u6570\u636e\u4e2d\u5fc3\u5230\u591a\u4e91\u8ba1\u7b97\u5e73\u53f0\u7684\u5de5\u4f5c\u8d1f\u8f7d\u548c\u5e94\u7528\u3002</p>"},{"location":"Linux/system/%E7%BA%A2%E6%97%97%E7%B3%BB%E7%BB%9F%E6%93%8D%E4%BD%9C/#\u66f4\u6362yum\u6e90","title":"\u66f4\u6362yum\u6e90","text":""},{"location":"Linux/system/%E7%BA%A2%E6%97%97%E7%B3%BB%E7%BB%9F%E6%93%8D%E4%BD%9C/#\u67e5\u770b\u7cfb\u7edf\u81ea\u5e26yum\u6e90","title":"\u67e5\u770b\u7cfb\u7edf\u81ea\u5e26yum\u6e90","text":""},{"location":"Linux/system/%E7%BA%A2%E6%97%97%E7%B3%BB%E7%BB%9F%E6%93%8D%E4%BD%9C/#\u66f4\u6539\u7cfb\u7edf\u5185yum\u6e90","title":"\u66f4\u6539\u7cfb\u7edf\u5185yum\u6e90","text":"<pre><code>[root@src1 workspace]# rpm -aq | grep yum | xargs rpm -e --nodeps\n[root@src1 workspace]# whereis yum\nyum: /etc/yum /usr/share/man/man8/yum.8.gz\n[root@src1 workspace]# rm -rf /etc/yum\n[root@src1 workspace]# rm -rf /usr/share/man/man8/yum.8.gz\n</code></pre> <p>\u4e0b\u8f7dyum\u5305</p> <pre><code>wget http://mirrors.163.com/centos/7/os/x86_64/Packages/yum-3.4.3-168.el7.centos.noarch.rpm\nrpm -ivh yum-3.4.3-168.el7.centos.noarch.rpm\n</code></pre> <p></p> <p>\u4e0b\u8f7d\u5176\u4ed6yum\u4ee5\u6765\u5305</p> <pre><code>cat &gt; centos4yum.txt &lt;&lt;EOF\nhttp://mirrors.163.com/centos/7/os/x86_64/Packages/pygpgme-0.3-9.el7.x86_64.rpm   \nhttp://mirrors.163.com/centos/7/os/x86_64/Packages/pyliblzma-0.5.3-11.el7.x86_64.rpm     \nhttp://mirrors.163.com/centos/7/os/x86_64/Packages/python-iniparse-0.4-9.el7.noarch.rpm    \nhttp://mirrors.163.com/centos/7/os/x86_64/Packages/python-urlgrabber-3.10-10.el7.noarch.rpm \nhttp://mirrors.163.com/centos/7/os/x86_64/Packages/pyxattr-0.5.1-5.el7.x86_64.rpm       \nhttp://mirrors.163.com/centos/7/os/x86_64/Packages/yum-metadata-parser\nhttp://mirrors.163.com/centos/7/os/x86_64/Packages/yum-plugin-fastestmirror-1.1.31-54.el7_8.noarch.rpm\nhttp://mirrors.163.com/centos/7/os/x86_64/Packages/python-pycurl-7.19.0-19.el7.x86_64.rpm    \nhttp://mirrors.163.com/centos/7/os/x86_64/Packages/rpm-python-4.11.3-45.el7.x86_64.rpm \nhttp://mirrors.163.com/centos/7/os/x86_64/Packages/yum-metadata-parser-1.1.4-10.el7.x86_64.rpm    \nEOF\nfor p in `cat centos4yum.txt`;do wget -ivh $p ;done </code></pre>"},{"location":"Linux/system/%E7%BA%A2%E6%97%97%E7%B3%BB%E7%BB%9F%E6%93%8D%E4%BD%9C/#\u4f7f\u7528kylin\u6e90","title":"\u4f7f\u7528kylin\u6e90","text":""},{"location":"Linux/system/%E7%BA%A2%E6%97%97%E7%B3%BB%E7%BB%9F%E6%93%8D%E4%BD%9C/#\u53c2\u8003\u94fe\u63a5","title":"\u53c2\u8003\u94fe\u63a5","text":"<ul> <li> <p>http://chinaredflag.cn/product/newproduct?ulink=&amp;tolink=redflag-web/AX8 </p> </li> <li> <p>http://update.cs2c.com.cn:8080/NS/V10/</p> </li> </ul>"},{"location":"Python/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Python%E5%B7%A5%E5%8C%A0/","title":"Python\u5de5\u5320","text":"<p>\u4e66\u540d\uff1aPython\u5de5\u5320\uff1a\u6848\u4f8b\u3001\u6280\u5de7\u4e0e\u5de5\u7a0b\u5b9e\u8df5</p>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/","title":"\u57fa\u7840\u77e5\u8bc6","text":""},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#1-\u53d8\u91cf\u5e38\u89c1\u7528\u6cd5","title":"1. \u53d8\u91cf\u5e38\u89c1\u7528\u6cd5","text":"<p>\u5b9a\u4e49\u4e00\u4e2a\u53d8\u91cf\u7279\u522b\u7b80\u5355\uff1a</p> <pre><code>author=\"hujianli\"\nprint(\"Hello {}!\".format(author))\n# Hello hujianli!\n</code></pre> <p>\u4f60\u4e5f\u53ef\u4ee5\u5728\u4e00\u884c\u8bed\u53e5\u91cc\u540c\u65f6\u64cd\u4f5c\u591a\u4e2a\u53d8\u91cf\uff0c\u6bd4\u5982\u8c03\u6362\u4e24\u4e2a\u53d8\u91cf\u6240\u6307\u5411\u7684\u503c\uff1a</p> <pre><code>&gt;&gt;&gt; author, reader = 'piglei', 'raymond'\n&gt;&gt;&gt; author, reader = reader, author \u278a\n&gt;&gt;&gt; author\n'raymond'\n</code></pre>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#11-\u53d8\u91cf\u89e3\u5305","title":"1.1 \u53d8\u91cf\u89e3\u5305","text":"<pre><code>&gt;&gt;&gt; usernames = ['piglei', 'raymond']\n# \u6ce8\u610f\uff1a\u5de6\u4fa7\u53d8\u91cf\u7684\u4e2a\u6570\u5fc5\u987b\u548c\u5f85\u5c55\u5f00\u7684\u5217\u8868\u957f\u5ea6\u76f8\u7b49\uff0c\u5426\u5219\u4f1a\u62a5\u9519\n&gt;&gt;&gt; author, reader = usernames\n&gt;&gt;&gt; author\n'piglei'\n</code></pre> <p>\u5047\u5982\u5728\u8d4b\u503c\u8bed\u53e5\u5de6\u4fa7\u6dfb\u52a0\u5c0f\u62ec\u53f7(...)\uff0c\u751a\u81f3\u53ef\u4ee5\u4e00\u6b21\u5c55\u5f00\u591a\u5c42\u5d4c\u5957\u6570\u636e\uff1a</p> <pre><code>&gt;&gt;&gt; attrs = [1, ['piglei', 100]]\n&gt;&gt;&gt; user_id, (username, score) = attrs\n&gt;&gt;&gt; user_id\n1\n&gt;&gt;&gt; username\n'piglei'\n</code></pre> <p>\u9664\u4e86\u4e0a\u9762\u7684\u666e\u901a\u89e3\u5305\u5916\uff0cPython\u8fd8\u652f\u6301\u66f4\u7075\u6d3b\u7684\u52a8\u6001\u89e3\u5305\u8bed\u6cd5\u3002</p> <p>\u53ea\u8981\u7528\u661f\u53f7\u8868\u8fbe\u5f0f\uff08*variables\uff09\u4f5c\u4e3a\u53d8\u91cf\u540d\uff0c\u5b83\u4fbf\u4f1a\u8d2a\u5a6a\u5730\u6355\u83b7\u591a\u4e2a\u503c\u5bf9\u8c61\uff0c\u5e76\u5c06\u6355\u83b7\u5230\u7684\u5185\u5bb9\u4f5c\u4e3a\u5217\u8868\u8d4b\u503c\u7ed9variables\u3002</p> <pre><code>&gt;&gt;&gt; data = ['piglei', 'apple', 'orange', 'banana', 100]\n&gt;&gt;&gt; username, *fruits, score = data\n&gt;&gt;&gt; username\n'piglei'\n&gt;&gt;&gt; fruits\n['apple', 'orange', 'banana']\n&gt;&gt;&gt; score\n100\n</code></pre> <p>\u548c\u5e38\u89c4\u7684\u5207\u7247\u8d4b\u503c\u8bed\u53e5\u6bd4\u8d77\u6765\uff0c\u52a8\u6001\u89e3\u5305\u8bed\u6cd5\u8981\u76f4\u89c2\u8bb8\u591a\uff1a</p> <pre><code>#1. \u52a8\u6001\u89e3\u5305\n&gt;&gt;&gt; username, *fruits, score = data\n# 2. \u5207\u7247\u8d4b\u503c\n&gt;&gt;&gt; username, fruits, score = data[0], data[1:-1], data[-1]\n# \u4e24\u79cd\u53d8\u91cf\u8d4b\u503c\u65b9\u5f0f\u5b8c\u5168\u7b49\u4ef7\n</code></pre> <p>\u4e0a\u9762\u7684\u53d8\u91cf\u89e3\u5305\u64cd\u4f5c\u4e5f\u53ef\u4ee5\u5728\u4efb\u4f55\u5faa\u73af\u8bed\u53e5\u91cc\u4f7f\u7528\uff1a</p> <pre><code>&gt;&gt;&gt; for username, score in [('piglei', 100), ('raymond', 60)]:\n...     print(username)\n...\npiglei\nraymond\n</code></pre>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#12-\u5355\u4e0b\u5212\u7ebf\u53d8\u91cf\u540d_","title":"1.2 \u5355\u4e0b\u5212\u7ebf\u53d8\u91cf\u540d_","text":"<p>\u5728\u5e38\u7528\u7684\u8bf8\u591a\u53d8\u91cf\u540d\u4e2d\uff0c\u5355\u4e0b\u5212\u7ebf_\u662f\u6bd4\u8f83\u7279\u6b8a\u7684\u4e00\u4e2a\u3002\u5b83\u5e38\u4f5c\u4e3a\u4e00\u4e2a\u65e0\u610f\u4e49\u7684\u5360\u4f4d\u7b26\u51fa\u73b0\u5728\u8d4b\u503c\u8bed\u53e5\u4e2d\u3002_\u8fd9\u4e2a\u540d\u5b57\u672c\u8eab\u6ca1\u4ec0\u4e48\u7279\u522b\u4e4b\u5904\uff0c\u8fd9\u7b97\u662f\u5927\u5bb6\u7ea6\u5b9a\u4fd7\u6210\u7684\u4e00\u79cd\u7528\u6cd5\u3002</p> <pre><code>#\u5ffd\u7565\u5c55\u5f00\u65f6\u7684\u7b2c\u4e8c\u4e2a\u53d8\u91cf\n&gt;&gt;&gt; author, _ = usernames\n# \u5ffd\u7565\u7b2c\u4e00\u4e2a\u548c\u6700\u540e\u4e00\u4e2a\u53d8\u91cf\u4e4b\u95f4\u7684\u6240\u6709\u53d8\u91cf\n&gt;&gt;&gt; username, *_, score = data\n</code></pre> <p>\u800c\u5728Python\u4ea4\u4e92\u5f0f\u547d\u4ee4\u884c\uff08\u76f4\u63a5\u6267\u884cpython\u547d\u4ee4\u8fdb\u5165\u7684\u4ea4\u4e92\u73af\u5883\uff09\u91cc\uff0c_\u53d8\u91cf\u8fd8\u6709\u4e00\u5c42\u7279\u6b8a\u542b\u4e49\u2014\u2014\u9ed8\u8ba4\u4fdd\u5b58\u6211\u4eec\u8f93\u5165\u7684\u4e0a\u4e2a\u8868\u8fbe\u5f0f\u7684\u8fd4\u56de\u503c\uff1a</p> <pre><code>&gt;&gt;&gt; 'foo'.upper()\n'FOO'\n&gt;&gt;&gt; print(_)\nFOO\n</code></pre>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#2\u7ed9\u53d8\u91cf\u6ce8\u660e\u7c7b\u578b","title":"2.\u7ed9\u53d8\u91cf\u6ce8\u660e\u7c7b\u578b","text":"<p>\u8bd5\u7740\u8bfb\u8bfb\u4e0b\u9762\u8fd9\u6bb5\u4ee3\u7801\uff1a</p> <pre><code>def remove_invalid(items):\n\"\"\"\u5254\u9664 items \u91cc\u9762\u65e0\u6548\u7684\u5143\u7d20\"\"\"\n... ...\n</code></pre> <p>\u4f60\u80fd\u544a\u8bc9\u6211\uff0c\u51fd\u6570\u63a5\u6536\u7684items\u53c2\u6570\u662f\u4ec0\u4e48\u7c7b\u578b\u5417\uff1f\u662f\u4e00\u4e2a\u88c5\u6ee1\u6570\u5b57\u7684\u5217\u8868\uff0c\u8fd8\u662f\u4e00\u4e2a\u88c5\u6ee1\u5b57\u7b26\u4e32\u7684\u96c6\u5408\uff1f</p> <p>\u53ea\u770b\u4e0a\u9762\u8fd9\u70b9\u513f\u4ee3\u7801\uff0c\u6211\u4eec\u6839\u672c\u65e0\u4ece\u5f97\u77e5\u3002\u4e3a\u4e86\u89e3\u51b3\u52a8\u6001\u7c7b\u578b\u5e26\u6765\u7684\u53ef\u8bfb\u6027\u95ee\u9898\uff0c\u6700\u5e38\u89c1\u7684\u529e\u6cd5\u5c31\u662f\u5728\u51fd\u6570\u6587\u6863\uff08docstring\uff09\u91cc\u505a\u6587\u7ae0\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u628a\u6bcf\u4e2a\u51fd\u6570\u53c2\u6570\u7684\u7c7b\u578b\u4e0e\u8bf4\u660e\u5168\u90fd\u5199\u5728\u51fd\u6570\u6587\u6863\u91cc\u3002\u4e0b\u9762\u662f\u589e\u52a0\u4e86Python\u5b98\u65b9\u63a8\u8350\u7684Sphinx\u683c\u5f0f\u6587\u6863\u540e\u7684\u6548\u679c\uff1a</p> <pre><code>def remove_invalid(items):\n\"\"\"\u5254\u9664 items \u91cc\u9762\u65e0\u6548\u7684\u5143\u7d20\n    :param items: \u5f85\u5254\u9664\u5bf9\u8c61\n    :type items: \u5305\u542b\u6574\u6570\u7684\u5217\u8868\uff0c[int, ...]\n    \"\"\"\n</code></pre> <p>\u5f53\u7136\uff0c\u6807\u6ce8\u7c7b\u578b\u7684\u529e\u6cd5\u80af\u5b9a\u4e0d\u6b62\u4e0a\u9762\u8fd9\u4e00\u79cd\u3002\u5728Python 3.5\u7248\u672c\u4ee5\u540e\uff0c\u4f60\u53ef\u4ee5\u7528\u7c7b\u578b\u6ce8\u89e3\u529f\u80fd\u6765\u76f4\u63a5\u6ce8\u660e\u53d8\u91cf\u7c7b\u578b\u3002</p> <p>\u76f8\u6bd4\u7f16\u5199Sphinx\u683c\u5f0f\u6587\u6863\uff0c\u6211\u5176\u5b9e\u66f4\u63a8\u8350\u4f7f\u7528\u7c7b\u578b\u6ce8\u89e3\uff0c\u56e0\u4e3a\u5b83\u662fPython\u7684\u5185\u7f6e\u529f\u80fd\uff0c\u800c\u4e14\u6b63\u5728\u53d8\u5f97\u8d8a\u6765\u8d8a\u6d41\u884c\u3002</p> <p>\u8981\u4f7f\u7528\u7c7b\u578b\u6ce8\u89e3\uff0c\u53ea\u9700\u5728\u53d8\u91cf\u540e\u6dfb\u52a0\u7c7b\u578b\uff0c\u5e76\u7528\u5192\u53f7\u9694\u5f00\u5373\u53ef\uff0c\u6bd4\u5982func(value:str)\u8868\u793a\u51fd\u6570\u7684value\u53c2\u6570\u4e3a\u5b57\u7b26\u4e32\u7c7b\u578b\u3002</p> <p>\u4e0b\u9762\u662f\u7ed9remove_invalid()\u51fd\u6570\u6dfb\u52a0\u7c7b\u578b\u6ce8\u89e3\u540e\u7684\u6837\u5b50\uff1a</p> <pre><code>from typing import List\ndef remove_invalid(items: List[int]):\npass\nremove_invalid([\"piglei\", \"raymond\"])\n</code></pre> <ul> <li>List\u8868\u793a\u53c2\u6570\u4e3a\u5217\u8868\u7c7b\u578b\uff0c[int]\u8868\u793a\u91cc\u9762\u7684\u6210\u5458\u662f\u6574\u578b</li> </ul>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#3\u53d8\u91cf\u547d\u540d\u539f\u5219","title":"3.\u53d8\u91cf\u547d\u540d\u539f\u5219","text":""},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#31-\u9075\u5faapep-8\u539f\u5219","title":"3.1 \u9075\u5faaPEP 8\u539f\u5219","text":"<p>\u4e3a\u4e86\u8ba9\u4e0d\u540c\u5f00\u53d1\u8005\u5199\u51fa\u7684\u4ee3\u7801\u98ce\u683c\u5c3d\u91cf\u4fdd\u6301\u7edf\u4e00\uff0cPython\u5236\u5b9a\u4e86\u5b98\u65b9\u7684\u7f16\u7801\u98ce\u683c\u6307\u5357\uff1aPEP 8\u3002</p> <p>\u8fd9\u4efd\u98ce\u683c\u6307\u5357\u91cc\u6709\u8bb8\u591a\u8be6\u7ec6\u7684\u98ce\u683c\u5efa\u8bae\uff0c\u6bd4\u5982\u5e94\u8be5\u75284\u4e2a\u7a7a\u683c\u7f29\u8fdb\uff0c\u6bcf\u884c\u4e0d\u8d85\u8fc779\u4e2a\u5b57\u7b26\uff0c\u7b49\u7b49\u3002\u5176\u4e2d\uff0c\u5f53\u7136\u4e5f\u5305\u542b\u53d8\u91cf\u7684\u547d\u540d\u89c4\u8303\uff1a</p> <ul> <li> <p>\u5bf9\u4e8e\u666e\u901a\u53d8\u91cf\uff0c\u4f7f\u7528\u86c7\u5f62\u547d\u540d\u6cd5\uff0c\u6bd4\u5982max_value\uff1b</p> </li> <li> <p>\u5bf9\u4e8e\u5e38\u91cf\uff0c\u91c7\u7528\u5168\u5927\u5199\u5b57\u6bcd\uff0c\u4f7f\u7528\u4e0b\u5212\u7ebf\u8fde\u63a5\uff0c\u6bd4\u5982MAX_VALUE\uff1b</p> </li> <li> <p>\u5982\u679c\u53d8\u91cf\u6807\u8bb0\u4e3a\u201c\u4ec5\u5185\u90e8\u4f7f\u7528\u201d\uff0c\u4e3a\u5176\u589e\u52a0\u4e0b\u5212\u7ebf\u524d\u7f00\uff0c\u6bd4\u5982_local_var;</p> </li> <li> <p>\u5f53\u540d\u5b57\u4e0ePython\u5173\u952e\u5b57\u51b2\u7a81\u65f6\uff0c\u5728\u53d8\u91cf\u672b\u5c3e\u8ffd\u52a0\u4e0b\u5212\u7ebf\uff0c\u6bd4\u5982class_\u3002</p> </li> </ul> <p>\u9664\u53d8\u91cf\u540d\u4ee5\u5916\uff0cPEP 8\u4e2d\u8fd8\u6709\u8bb8\u591a\u5176\u4ed6\u547d\u540d\u89c4\u8303\uff0c\u6bd4\u5982\u7c7b\u540d\u5e94\u8be5\u4f7f\u7528\u9a7c\u5cf0\u98ce\u683c\uff08FooClass\uff09\u3001\u51fd\u6570\u5e94\u8be5\u4f7f\u7528\u86c7\u5f62\u98ce\u683c\uff08bar_function\uff09\uff0c\u7b49\u7b49\u3002</p> <p>\u7ed9\u53d8\u91cf\u8d77\u540d\u7684\u7b2c\u4e00\u6761\u539f\u5219\uff0c\u5c31\u662f\u4e00\u5b9a\u8981\u5728\u683c\u5f0f\u4e0a\u9075\u5faa\u4ee5\u4e0a\u89c4\u8303\u3002</p>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#32-\u63cf\u8ff0\u6027\u8981\u5f3a","title":"3.2 \u63cf\u8ff0\u6027\u8981\u5f3a","text":"<p>\u5199\u4f5c\u8fc7\u7a0b\u4e2d\u7684\u4e00\u9879\u91cd\u8981\u5de5\u4f5c\uff0c\u5c31\u662f\u4e3a\u53e5\u5b50\u659f\u914c\u6070\u5f53\u7684\u8bcd\u8bed\u3002</p> <p>\u4e0d\u540c\u8bcd\u8bed\u7684\u63cf\u8ff0\u6027\u5f3a\u5f31\u4e0d\u540c\uff0c\u6bd4\u5982\u201c\u51ac\u5929\u7684\u6885\u82b1\u201d\u5c31\u6bd4\u201c\u82b1\u201d\u7684\u63cf\u8ff0\u6027\u66f4\u5f3a\u3002\u800c\u53d8\u91cf\u540d\u548c\u666e\u901a\u8bcd\u8bed\u4e00\u6837\uff0c\u540c\u6837\u6709\u63cf\u8ff0\u6027\u5f3a\u5f31\u4e4b\u5206\uff0c\u5047\u5982\u4ee3\u7801\u5927\u91cf\u4f7f\u7528\u63cf\u8ff0\u6027\u5f31\u7684\u53d8\u91cf\u540d\uff0c\u8bfb\u8005\u5c31\u5f88\u96be\u7406\u89e3\u4ee3\u7801\u7684\u542b\u4e49\u3002</p>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#33-\u8981\u5c3d\u91cf\u77ed","title":"3.3 \u8981\u5c3d\u91cf\u77ed","text":""},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#34-\u8981\u5339\u914d\u7c7b\u578b","title":"3.4 \u8981\u5339\u914d\u7c7b\u578b","text":"<p>\u5e03\u5c14\u503c\uff08bool\uff09\u662f\u4e00\u79cd\u5f88\u7b80\u5355\u7684\u7c7b\u578b\uff0c\u5b83\u53ea\u6709\u4e24\u4e2a\u53ef\u80fd\u7684\u503c\uff1a\u201c\u662f\u201d\uff08True\uff09\u6216\u201c\u4e0d\u662f\u201d\uff08False\uff09\u3002</p> <p>\u56e0\u6b64\uff0c\u7ed9\u5e03\u5c14\u503c\u53d8\u91cf\u8d77\u540d\u6709\u4e00\u4e2a\u539f\u5219\uff1a\u4e00\u5b9a\u8981\u8ba9\u8bfb\u5230\u53d8\u91cf\u7684\u4eba\u89c9\u5f97\u5b83\u53ea\u6709\u201c\u80af\u5b9a\u201d\u548c\u201c\u5426\u5b9a\u201d\u4e24\u79cd\u53ef\u80fd\u3002\u4e3e\u4f8b\u6765\u8bf4\uff0cis\u3001has\u8fd9\u4e9b\u975e\u9ed1\u5373\u767d\u7684\u8bcd\u5c31\u5f88\u9002\u5408\u7528\u6765\u4fee\u9970\u8fd9\u7c7b\u540d\u5b57\u3002</p>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#35-\u8d85\u77ed\u547d\u540d","title":"3.5 \u8d85\u77ed\u547d\u540d","text":"<p>\u5728\u4f17\u591a\u53d8\u91cf\u540d\u91cc\uff0c\u6709\u4e00\u7c7b\u975e\u5e38\u7279\u522b\uff0c\u90a3\u5c31\u662f\u53ea\u6709\u4e00\u4e24\u4e2a\u5b57\u6bcd\u7684\u77ed\u540d\u5b57\u3002\u8fd9\u4e9b\u77ed\u540d\u5b57\u4e00\u822c\u53ef\u5206\u4e3a\u4e24\u7c7b\uff0c\u4e00\u7c7b\u662f\u90a3\u4e9b\u5927\u5bb6\u7ea6\u5b9a\u4fd7\u6210\u7684\u77ed\u540d\u5b57\uff0c\u6bd4\u5982\uff1a</p> <ul> <li>\u6570\u7ec4\u7d22\u5f15\u4e09\u5251\u5ba2i\u3001j\u3001k</li> <li>\u67d0\u4e2a\u6574\u6570n</li> <li>\u67d0\u4e2a\u5b57\u7b26\u4e32s</li> <li>\u67d0\u4e2a\u5f02\u5e38e</li> <li>\u6587\u4ef6\u5bf9\u8c61fp</li> </ul> <p>\u6211\u5e76\u4e0d\u53cd\u5bf9\u4f7f\u7528\u8fd9\u7c7b\u77ed\u540d\u5b57\uff0c\u6211\u81ea\u5df1\u4e5f\u7ecf\u5e38\u7528\uff0c\u56e0\u4e3a\u5b83\u4eec\u5199\u8d77\u6765\u7684\u786e\u5f88\u65b9\u4fbf\u3002\u4f46\u5982\u679c\u6761\u4ef6\u5141\u8bb8\uff0c\u5efa\u8bae\u5c3d\u91cf\u7528\u66f4\u7cbe\u786e\u7684\u540d\u5b57\u66ff\u4ee3\u3002\u6bd4\u5982\uff0c\u5728\u8868\u793a\u7528\u6237\u8f93\u5165\u7684\u5b57\u7b26\u4e32\u65f6\uff0c\u7528input_str\u66ff\u4ee3s\u4f1a\u66f4\u660e\u786e\u4e00\u4e9b\u3002</p>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#\u5176\u4ed6\u6280\u5de7","title":"\u5176\u4ed6\u6280\u5de7","text":"<p>\u9664\u4e86\u4e0a\u9762\u8fd9\u4e9b\u89c4\u5219\u5916\uff0c\u4e0b\u9762\u518d\u5206\u4eab\u51e0\u4e2a\u7ed9\u53d8\u91cf\u547d\u540d\u7684\u5c0f\u6280\u5de7\uff1a</p> <ul> <li>\u5728\u540c\u4e00\u6bb5\u4ee3\u7801\u5185\uff0c\u4e0d\u8981\u51fa\u73b0\u591a\u4e2a\u76f8\u4f3c\u7684\u53d8\u91cf\u540d\uff0c\u6bd4\u5982\u540c\u65f6\u4f7f\u7528users\u3001users1\u3001users3\u8fd9\u79cd\u5e8f\u5217\uff1b</li> <li>\u53ef\u4ee5\u5c1d\u8bd5\u6362\u8bcd\u6765\u7b80\u5316\u590d\u5408\u53d8\u91cf\u540d\uff0c\u6bd4\u5982\u7528is_special\u6765\u4ee3\u66ffis_not_normal\uff1b</li> <li>\u5982\u679c\u4f60\u82e6\u601d\u51a5\u60f3\u90fd\u60f3\u4e0d\u51fa\u4e00\u4e2a\u5408\u9002\u7684\u540d\u5b57\uff0c\u8bf7\u6253\u5f00GitHub\uff0c\u5230\u5176\u4ed6\u4eba\u7684\u5f00\u6e90\u9879\u76ee\u91cc\u627e\u627e\u7075\u611f\u5427\uff01</li> </ul>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#4-\u6ce8\u91ca\u57fa\u7840\u77e5\u8bc6","title":"4. \u6ce8\u91ca\u57fa\u7840\u77e5\u8bc6","text":""},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#41-\u7528\u6ce8\u91ca\u5c4f\u853d\u4ee3\u7801","title":"4.1 \u7528\u6ce8\u91ca\u5c4f\u853d\u4ee3\u7801","text":"<p>\u6709\u65f6\uff0c\u4eba\u4eec\u4f1a\u628a\u6ce8\u91ca\u5f53\u4f5c\u4e34\u65f6\u5c4f\u853d\u4ee3\u7801\u7684\u5de5\u5177\u3002\u5f53\u67d0\u4e9b\u4ee3\u7801\u6682\u65f6\u4e0d\u9700\u8981\u6267\u884c\u65f6\uff0c\u5c31\u628a\u5b83\u4eec\u90fd\u6ce8\u91ca\u4e86\uff0c\u672a\u6765\u9700\u8981\u65f6\u518d\u89e3\u9664\u6ce8\u91ca\u3002</p> <pre><code>#\u6e90\u7801\u91cc\u6709\u5927\u6bb5\u5927\u6bb5\u6682\u65f6\u4e0d\u9700\u8981\u6267\u884c\u7684\u4ee3\u7801\n# trip = get_trip(request)\n# trip.refresh()\n# ... ...\n</code></pre> <p>\u5176\u5b9e\u6839\u672c\u6ca1\u5fc5\u8981\u8fd9\u4e48\u505a\u3002\u8fd9\u4e9b\u88ab\u4e34\u65f6\u6ce8\u91ca\u6389\u7684\u5927\u6bb5\u5185\u5bb9\uff0c\u5bf9\u4e8e\u9605\u8bfb\u4ee3\u7801\u7684\u4eba\u6765\u8bf4\u662f\u4e00\u79cd\u5e72\u6270\uff0c\u6ca1\u6709\u4efb\u4f55\u610f\u4e49\u3002\u5bf9\u4e8e\u4e0d\u518d\u9700\u8981\u7684\u4ee3\u7801\uff0c\u6211\u4eec\u5e94\u8be5\u76f4\u63a5\u628a\u5b83\u4eec\u5220\u6389\uff0c\u800c\u4e0d\u662f\u6ce8\u91ca\u6389\u3002\u5982\u679c\u672a\u6765\u6709\u4eba\u771f\u7684\u9700\u8981\u7528\u5230\u8fd9\u4e9b\u65e7\u4ee3\u7801\uff0c\u4ed6\u76f4\u63a5\u53bbGit\u4ed3\u5e93\u5386\u53f2\u91cc\u5c31\u80fd\u627e\u5230\uff0c\u6bd5\u7adf\u7248\u672c\u63a7\u5236\u7cfb\u7edf\u5c31\u662f\u4e13\u95e8\u5e72\u8fd9\u4e2a\u7684\u3002</p>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#42-\u7528\u6ce8\u91ca\u590d\u8ff0\u4ee3\u7801","title":"4.2 \u7528\u6ce8\u91ca\u590d\u8ff0\u4ee3\u7801","text":"<pre><code>#\u5982\u679c\u76f4\u63a5\u628a\u5e26\u7a7a\u683c\u7684\u8f93\u5165\u4f20\u9012\u5230\u540e\u7aef\u5904\u7406\uff0c\u53ef\u80fd\u4f1a\u9020\u6210\u540e\u7aef\u670d\u52a1\u5d29\u6e83\n# \u56e0\u6b64\u4f7f\u7528strip() \u53bb\u6389\u9996\u5c3e\u7a7a\u683c\ninput_string = input_string.strip()\n</code></pre> <p>\u6ce8\u91ca\u4f5c\u4e3a\u4ee3\u7801\u4e4b\u5916\u7684\u8bf4\u660e\u6027\u6587\u5b57\uff0c\u5e94\u8be5\u5c3d\u91cf\u63d0\u4f9b\u90a3\u4e9b\u8bfb\u8005\u65e0\u6cd5\u4ece\u4ee3\u7801\u91cc\u8bfb\u51fa\u6765\u7684\u4fe1\u606f\u3002\u63cf\u8ff0\u4ee3\u7801\u4e3a\u4ec0\u4e48\u8981\u8fd9\u4e48\u505a\uff0c\u800c\u4e0d\u662f\u7b80\u5355\u590d\u8ff0\u4ee3\u7801\u672c\u8eab\u3002</p>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#43-\u5f04\u9519\u63a5\u53e3\u6ce8\u91ca\u7684\u53d7\u4f17","title":"4.3 \u5f04\u9519\u63a5\u53e3\u6ce8\u91ca\u7684\u53d7\u4f17","text":"<p>\u63a5\u53e3\u6587\u6863\u4e3b\u8981\u662f\u7ed9\u51fd\u6570\uff08\u6216\u7c7b\uff09\u7684\u4f7f\u7528\u8005\u770b\u7684\uff0c\u5b83\u6700\u4e3b\u8981\u7684\u5b58\u5728\u4ef7\u503c\uff0c\u662f\u8ba9\u4eba\u4eec\u4e0d\u7528\u9010\u884c\u9605\u8bfb\u51fd\u6570\u4ee3\u7801\uff0c\u4e5f\u80fd\u5f88\u5feb\u901a\u8fc7\u6587\u6863\u77e5\u9053\u8be5\u5982\u4f55\u4f7f\u7528\u8fd9\u4e2a\u51fd\u6570\uff0c\u4ee5\u53ca\u5728\u4f7f\u7528\u65f6\u6709\u4ec0\u4e48\u6ce8\u610f\u4e8b\u9879\u3002</p> <pre><code>def resize_image(image, size):\n\"\"\"\u5c06\u56fe\u7247\u7f29\u653e\u4e3a\u6307\u5b9a\u5c3a\u5bf8\uff0c\u5e76\u8fd4\u56de\u65b0\u7684\u56fe\u7247\u3002\n    \u6ce8\u610f\uff1a\u5f53\u6587\u4ef6\u8d85\u8fc7 5MB \u65f6\uff0c\u8bf7\u4f7f\u7528 resize_big_image()\n    :param image: \u56fe\u7247\u6587\u4ef6\u5bf9\u8c61\n    :param size: \u5305\u542b\u5bbd\u9ad8\u7684\u5143\u7ec4\uff1a\uff08width, height\uff09\n    :return: \u65b0\u56fe\u7247\u5bf9\u8c61\n    \"\"\"\n</code></pre>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#5\u5947\u602a\u7684\u5192\u6ce1\u6392\u5e8f","title":"5.\u5947\u602a\u7684\u5192\u6ce1\u6392\u5e8f","text":"<pre><code># -*- coding: utf-8 -*-\n# \u4e0d\u597d\u7684\u5199\u6cd5\ndef magic_bubble_sort_2(numbers):\n\"\"\"\u6709\u9b54\u529b\u7684\u5192\u6ce1\u6392\u5e8f\u7b97\u6cd5\uff0c\u6240\u6709\u7684\u5076\u6570\u90fd\u88ab\u8ba4\u4e3a\u6bd4\u5947\u6570\u5927\"\"\"\nj = len(numbers) - 1\nwhile j &gt; 0:\nfor i in range(j):\nif numbers[i] % 2 == 0 and numbers[i + 1] % 2 == 1:\nnumbers[i], numbers[i + 1] = numbers[i + 1], numbers[i]\ncontinue\nelif (numbers[i + 1] % 2 == numbers[i] % 2) and numbers[i] &gt; numbers[i + 1]:\nnumbers[i], numbers[i + 1] = numbers[i + 1], numbers[i]\ncontinue\nj -= 1\nreturn numbers\n# \u63a8\u8350\u7684\u5199\u6cd5\nfrom typing import List\ndef magic_bubble_sort(numbers: List[int]):\n\"\"\"\u6709\u9b54\u529b\u7684\u5192\u6ce1\u6392\u5e8f\u7b97\u6cd5\uff0c\u6240\u6709\u7684\u5076\u6570\u90fd\u88ab\u8ba4\u4e3a\u6bd4\u5947\u6570\u5927\n    :param numbers: \u9700\u8981\u6392\u5e8f\u7684\u5217\u8868\uff0c\u51fd\u6570\u5c06\u4f1a\u76f4\u63a5\u4fee\u6539\u539f\u59cb\u5217\u8868\n    \"\"\"\nstop_position = len(numbers) - 1\nwhile stop_position &gt; 0:\nfor i in range(stop_position):\ncurrent, next_ = numbers[i], numbers[i + 1]\ncurrent_is_even, next_is_even = current % 2 == 0, next_ % 2 == 0\nshould_swap = False\n# \u4ea4\u6362\u4f4d\u7f6e\u7684\u4e24\u4e2a\u6761\u4ef6\uff1a\n# - \u524d\u9762\u662f\u5076\u6570\uff0c\u540e\u9762\u662f\u5947\u6570\n# - \u524d\u9762\u548c\u540e\u9762\u540c\u4e3a\u5947\u6570\u6216\u8005\u5076\u6570\uff0c\u4f46\u662f\u524d\u9762\u6bd4\u540e\u9762\u5927\nif current_is_even and not next_is_even:\nshould_swap = True\nelif current_is_even == next_is_even and current &gt; next_:\nshould_swap = True\nif should_swap:\nnumbers[i], numbers[i + 1] = numbers[i + 1], numbers[i]\nstop_position -= 1\nreturn numbers\nif __name__ == \"__main__\":\nl = [23, 32, 1, 3, 4, 19, 20, 2, 4]\nprint(magic_bubble_sort(l))\nprint(magic_bubble_sort_2(l))\n</code></pre>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/2.%E7%BC%96%E7%A8%8B%E5%BB%BA%E8%AE%AE/","title":"\u7f16\u7a0b\u5efa\u8bae","text":""},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/2.%E7%BC%96%E7%A8%8B%E5%BB%BA%E8%AE%AE/#1\u4fdd\u6301\u53d8\u91cf\u7684\u4e00\u81f4\u6027","title":"1.\u4fdd\u6301\u53d8\u91cf\u7684\u4e00\u81f4\u6027","text":"<p>\u5305\u542b\u540d\u5b57\u4e00\u81f4\u6027\u548c\u7c7b\u578b\u4e00\u81f4\u6027\u3002</p> <p>\u540d\u5b57\u4e00\u81f4\u6027\u662f\u6307\u5728\u540c\u4e00\u4e2a\u9879\u76ee\u4e2d\uff0c\u5bf9\u4e00\u7c7b\u4e8b\u52a1\u7684\u79f0\u547c\u4e0d\u8981\u53d8\u6765\u53d8\u53bb\u3002</p> <p>\u7c7b\u578b\u4e00\u81f4\u6027\u5219\u662f\u6307\u4e0d\u8981\u628a\u540c\u4e00\u4e2a\u53d8\u91cf\u91cd\u590d\u6307\u5411\u4e0d\u540c\u7c7b\u578b\u7684\u503c\u3002</p> <p>\u4e3e\u4e2a\u4f8b\u5b50\uff1a</p> <pre><code>def foo():\n# users \u672c\u8eab\u662f\u4e00\u4e2a Dict\nusers = {'data': ['piglei', 'raymond']}\n...\n# users \u8fd9\u4e2a\u540d\u5b57\u771f\u4e0d\u9519\uff01\u5c1d\u8bd5\u590d\u7528\u5b83\uff0c\u628a\u5b83\u53d8\u6210 List \u7c7b\u578b\nusers = []\n...\n</code></pre> <p>\u5728foo()\u51fd\u6570\u7684\u4f5c\u7528\u57df\u5185\uff0cusers\u53d8\u91cf\u88ab\u4f7f\u7528\u4e86\u4e24\u6b21\uff1a\u7b2c\u4e00\u6b21\u6307\u5411\u5b57\u5178\uff0c\u7b2c\u4e8c\u6b21\u5219\u53d8\u6210\u4e86\u5217\u8868\u3002</p> <p>\u867d\u7136Python\u7684\u7c7b\u578b\u7cfb\u7edf\u5141\u8bb8\u6211\u4eec\u8fd9\u4e48\u505a\uff0c\u4f46\u8fd9\u6837\u505a\u5176\u5b9e\u6709\u5f88\u591a\u574f\u5904\uff0c\u6bd4\u5982\u53d8\u91cf\u7684\u8fa8\u8bc6\u5ea6\u4f1a\u56e0\u6b64\u964d\u4f4e\uff0c\u8fd8\u5f88\u5bb9\u6613\u5f15\u5165bug\u3002</p> <p>\u6240\u4ee5\uff0c\u6211\u5efa\u8bae\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u542f\u7528\u4e00\u4e2a\u65b0\u53d8\u91cf\uff1a</p> <pre><code>def foo():\nusers = {'data': ['piglei', 'raymond']}\n...\n# \u4f7f\u7528\u4e00\u4e2a\u65b0\u540d\u5b57\nuser_list = []\n...\n</code></pre>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/2.%E7%BC%96%E7%A8%8B%E5%BB%BA%E8%AE%AE/#2\u53d8\u91cf\u5b9a\u4e49\u5c3d\u91cf\u9760\u8fd1\u4f7f\u7528","title":"2.\u53d8\u91cf\u5b9a\u4e49\u5c3d\u91cf\u9760\u8fd1\u4f7f\u7528","text":"<p>\u8fd9\u4e2a\u539f\u5219\u5c5e\u4e8e\u8001\u751f\u5e38\u8c08\u4e86\u3002\u5f88\u591a\u4eba\uff08\u5305\u62ec\u6211\uff09\u5728\u521a\u5f00\u59cb\u5b66\u4e60\u7f16\u7a0b\u65f6\uff0c\u4f1a\u6709\u4e00\u4e2a\u4e60\u60ef\u3002\u5c31\u662f\u628a\u6240\u6709\u7684\u53d8\u91cf\u5b9a\u4e49\u5199\u5728\u4e00\u8d77\uff0c\u653e\u5728\u51fd\u6570\u6216\u65b9\u6cd5\u7684\u6700\u524d\u9762\u3002</p> <pre><code>### \u770b\u4f3c\u5f88\u597d\u770b\uff0c\u5176\u5b9e\u4e0d\u7136\ndef generate_trip_png(trip):\npath = []\nmarkers = []\nphoto_markers = []\ntext_markers = []\nmarker_count = 0\npoint_count = 0\n... ...\n</code></pre> <p>\u901a\u8fc7\u628a\u53d8\u91cf\u5b9a\u4e49\u79fb\u52a8\u5230\u6bcf\u6bb5\u201c\u5404\u53f8\u5176\u804c\u201d\u7684\u4ee3\u7801\u5934\u90e8\uff0c\u5927\u5927\u7f29\u77ed\u4e86\u53d8\u91cf\u4ece\u521d\u59cb\u5316\u5230\u88ab\u4f7f\u7528\u7684\u8ddd\u79bb\u3002</p> <p>\u5f53\u8bfb\u8005\u9605\u8bfb\u4ee3\u7801\u65f6\uff0c\u53ef\u4ee5\u66f4\u5bb9\u6613\u7406\u89e3\u4ee3\u7801\u7684\u903b\u8f91\uff0c\u800c\u4e0d\u662f\u6765\u56de\u7ffb\u9605\u4ee3\u7801\u3002</p> <pre><code>def generate_trip_png(trip):\n\"\"\"\n    \u6839\u636e\u65c5\u9014\u6570\u636e\u751f\u6210 PNG \u56fe\u7247\n    \"\"\"\n# \u5f00\u59cb\u521d\u59cb\u5316 waypoints \u6570\u636e\nwaypoints = []\nwaypoints.append(...)\n...\n# \u5f00\u59cb\u5904\u7406 photo_markers\u3001text_markers\nphoto_markers, text_markers = [], []\nphoto_markers.append(...)\n...\n# \u5f00\u59cb\u8ba1\u7b97 marker_count\nmarker_count = 0\nmarker_count += ...\n# \u62fc\u63a5\u56fe\u7247\uff1a\u5df2\u7701\u7565\u2026\u2026\n</code></pre> <p>\u901a\u8fc7\u628a\u53d8\u91cf\u5b9a\u4e49\u79fb\u52a8\u5230\u6bcf\u6bb5\u201c\u5404\u53f8\u5176\u804c\u201d\u7684\u4ee3\u7801\u5934\u90e8\uff0c\u5927\u5927\u7f29\u77ed\u4e86\u53d8\u91cf\u4ece\u521d\u59cb\u5316\u5230\u88ab\u4f7f\u7528\u7684\u201c\u8ddd\u79bb\u201d\u3002</p> <p>\u5f53\u8bfb\u8005\u9605\u8bfb\u4ee3\u7801\u65f6\uff0c\u53ef\u4ee5\u66f4\u5bb9\u6613\u7406\u89e3\u4ee3\u7801\u7684\u903b\u8f91\uff0c\u800c\u4e0d\u662f\u6765\u56de\u7ffb\u9605\u4ee3\u7801\uff0c\u5fc3\u60f3\uff1a\u201c\u8fd9\u4e2a\u53d8\u91cf\u662f\u4ec0\u4e48\u65f6\u5019\u5b9a\u4e49\u7684\uff1f\u662f\u5e72\u4ec0\u4e48\u7528\u7684\uff1f\u201d</p>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/2.%E7%BC%96%E7%A8%8B%E5%BB%BA%E8%AE%AE/#3\u5b9a\u4e49\u4e34\u65f6\u53d8\u91cf\u63d0\u5347\u53ef\u8bfb\u6027","title":"3.\u5b9a\u4e49\u4e34\u65f6\u53d8\u91cf\u63d0\u5347\u53ef\u8bfb\u6027","text":"<p>\u968f\u7740\u4e1a\u52a1\u903b\u8f91\u53d8\u5f97\u590d\u6742\uff0c\u6211\u4eec\u7684\u4ee3\u7801\u91cc\u4e5f\u4f1a\u7ecf\u5e38\u51fa\u73b0\u4e00\u4e9b\u590d\u6742\u7684\u8868\u8fbe\u5f0f\uff0c\u5c31\u50cf\u4e0b\u9762\u8fd9\u6837\uff1a</p> <pre><code># \u4e3a\u6240\u6709\u6027\u522b\u4e3a\u5973\u6027\uff0c\u6216\u8005\u7ea7\u522b\u5927\u4e8e 3 \u7684\u6d3b\u8dc3\u7528\u6237\u53d1\u653e 10000 \u4e2a\u91d1\u5e01\nif user.is_active and (user.sex == 'female' or user.level &gt; 3):\nuser.add_coins(10000)\nreturn\n</code></pre> <p>\u770b\u89c1if\u540e\u9762\u90a3\u4e00\u957f\u4e32\u4ee3\u7801\u4e86\u5417\uff1f\u6709\u70b9\u513f\u96be\u8bfb\u5bf9\u4e0d\u5bf9\uff1f\u4f46\u8fd9\u4e5f\u6ca1\u529e\u6cd5\uff0c\u6bd5\u7adf\u4ea7\u54c1\u7ecf\u7406\u5c31\u662f\u660e\u660e\u767d\u767d\u8fd9\u4e48\u8ddf\u6211\u8bf4\u7684\u2014\u2014\u4e1a\u52a1\u903b\u8f91\u5982\u6b64\u3002</p> <p>\u903b\u8f91\u867d\u7136\u5982\u6b64\uff0c\u4e0d\u4ee3\u8868\u6211\u4eec\u5c31\u5f97\u628a\u4ee3\u7801\u76f4\u767d\u5730\u5199\u6210\u8fd9\u6837\u3002\u5982\u679c\u628a\u540e\u9762\u7684\u590d\u6742\u8868\u8fbe\u5f0f\u8d4b\u503c\u4e3a\u4e00\u4e2a\u4e34\u65f6\u53d8\u91cf\uff0c\u4ee3\u7801\u53ef\u4ee5\u53d8\u5f97\u66f4\u6613\u8bfb\uff1a</p> <pre><code># \u4e3a\u6240\u6709\u6027\u522b\u4e3a\u5973\u6027\uff0c\u6216\u8005\u7ea7\u522b\u5927\u4e8e 3 \u7684\u6d3b\u8dc3\u7528\u6237\u53d1\u653e 10000 \u4e2a\u91d1\u5e01\nuser_is_eligible = user.is_active and (user.sex == 'female' or user.level &gt; 3):\nif user_is_eligible:\nuser.add_coins(10000)\nreturn\n</code></pre>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/2.%E7%BC%96%E7%A8%8B%E5%BB%BA%E8%AE%AE/#4\u540c\u4e00\u4f5c\u7528\u57df\u5185\u4e0d\u8981\u6709\u592a\u591a\u53d8\u91cf","title":"4.\u540c\u4e00\u4f5c\u7528\u57df\u5185\u4e0d\u8981\u6709\u592a\u591a\u53d8\u91cf","text":"<ul> <li>\u5b66\u4f1a\u901a\u8fc7\u7ec4\u5408\u7b49\u65b9\u6cd5\u51cf\u5c11\u51fd\u6570\u5185\u7684\u53d8\u91cf\u6570\u91cf\uff0c\u5982\u5efa\u7acb\u7c7b\u7b49\uff1b</li> <li>\u628a\u590d\u6742\u51fd\u6570\u62c6\u5206\u4e3a\u591a\u4e2a\u5c0f\u51fd\u6570\uff1b</li> <li>\u80fd\u4e0d\u5b9a\u4e49\u53d8\u91cf\u5c31\u4e0d\u5b9a\u4e49\u2014\u2014\u6709\u65f6\u5019\u6709\u4e9b\u8bed\u53e5\u53ef\u4ee5\u7cbe\u7b80\u7ec4\u5408\u5728\u4e00\u8d77\uff1b</li> </ul> <p>\u5c40\u90e8\u53d8\u91cf\u8fc7\u591a\u7684\u51fd\u6570</p> <pre><code>def import_users_from_file(fp):\n\"\"\"\u5c1d\u8bd5\u4ece\u6587\u4ef6\u5bf9\u8c61\u8bfb\u53d6\u7528\u6237\uff0c\u7136\u540e\u5bfc\u5165\u6570\u636e\u5e93\n    :param fp: \u53ef\u8bfb\u6587\u4ef6\u5bf9\u8c61\n    :return: \u6210\u529f\u4e0e\u5931\u8d25\u7684\u6570\u91cf\n    \"\"\"\n# \u521d\u59cb\u5316\u53d8\u91cf\uff1a\u91cd\u590d\u7528\u6237\u3001\u9ed1\u540d\u5355\u7528\u6237\u3001\u6b63\u5e38\u7528\u6237\nduplicated_users, banned_users, normal_users = [], [], []\nfor line in fp:\nparsed_user = parse_user(line)\n# \u2026\u2026 \u8fdb\u884c\u5224\u65ad\u5904\u7406\uff0c\u4fee\u6539\u524d\u9762\u5b9a\u4e49\u7684{X}_users \u53d8\u91cf\nsucceeded_count, failed_count = 0, 0\n# \u2026\u2026 \u8bfb\u53d6 {X}_users \u53d8\u91cf\uff0c\u5199\u5165\u6570\u636e\u5e93\u5e76\u4fee\u6539\u6210\u529f\u4e0e\u5931\u8d25\u7684\u6570\u91cf\nreturn succeeded_count, failed_count\n</code></pre> <p>\u8981\u51cf\u5c11\u51fd\u6570\u91cc\u7684\u53d8\u91cf\u6570\u91cf\uff0c\u6700\u76f4\u63a5\u7684\u65b9\u5f0f\u662f\u7ed9\u8fd9\u4e9b\u53d8\u91cf\u5206\u7ec4\uff0c\u5efa\u7acb\u65b0\u7684\u6a21\u578b\u3002</p> <p>\u6bd4\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u4ee3\u7801\u91cc\u7684succeeded_count\u3001failed_count\u5efa\u6a21\u4e3aImportedSummary\u7c7b\uff0c\u7528ImportedSummary.succeeded_count\u6765\u66ff\u4ee3\u73b0\u6709\u53d8\u91cf\uff1b</p> <p>\u5bf9{duplicated|banned|normal}_users\u4e5f\u53ef\u4ee5\u6267\u884c\u540c\u6837\u7684\u64cd\u4f5c\u3002</p> <pre><code>class ImportedSummary:\n\"\"\"\u4fdd\u5b58\u5bfc\u5165\u7ed3\u679c\u6458\u8981\u7684\u6570\u636e\u7c7b\"\"\"\ndef __init__(self):\nself.succeeded_count = 0\nself.failed_count = 0\nclass ImportingUserGroup:\n\"\"\"\u7528\u4e8e\u6682\u5b58\u7528\u6237\u5bfc\u5165\u5904\u7406\u7684\u6570\u636e\u7c7b\"\"\"\ndef __init__(self):\nself.duplicated = []\nself.banned = []\nself.normal = []\ndef import_users_from_file(fp):\n\"\"\"\u5c1d\u8bd5\u4ece\u6587\u4ef6\u5bf9\u8c61\u8bfb\u53d6\u7528\u6237\uff0c\u7136\u540e\u5bfc\u5165\u6570\u636e\u5e93\u3000\u3000\n    :param fp: \u53ef\u8bfb\u6587\u4ef6\u5bf9\u8c61\n    :return: \u6210\u529f\u4e0e\u5931\u8d25\u7684\u6570\u91cf\n    \"\"\"\nimporting_user_group = ImportingUserGroup()\nfor line in fp:\nparsed_user = parse_user(line)\n# \u2026\u2026 \u8fdb\u884c\u5224\u65ad\u5904\u7406\uff0c\u4fee\u6539\u4e0a\u9762\u5b9a\u4e49\u7684importing_user_group \u53d8\u91cf\nsummary = ImportedSummary()\n# \u2026\u2026 \u8bfb\u53d6 importing_user_group\uff0c\u5199\u5165\u6570\u636e\u5e93\u5e76\u4fee\u6539\u6210\u529f\u4e0e\u5931\u8d25\u7684\u6570\u91cf\nreturn summary.succeeded_count, summary.failed_count\n</code></pre>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/2.%E7%BC%96%E7%A8%8B%E5%BB%BA%E8%AE%AE/#5\u80fd\u4e0d\u5b9a\u4e49\u53d8\u91cf\u5c31\u522b\u5b9a\u4e49","title":"5.\u80fd\u4e0d\u5b9a\u4e49\u53d8\u91cf\u5c31\u522b\u5b9a\u4e49","text":"<pre><code># \u574f\u7684\u4ee3\u7801\ndef get_best_trip_by_user_id(user_id):\n# \u5fc3\u7406\u6d3b\u52a8\uff1a\u55ef\uff0c\u8fd9\u4e2a\u503c\u672a\u6765\u8bf4\u4e0d\u5b9a\u4f1a\u4fee\u6539/\u4e8c\u6b21\u4f7f\u7528\uff0c\u6211\u4eec\u5148\u628a\u5b83\u5b9a\u4e49\u6210\u53d8\u91cf\u5427\uff01\nuser = get_user(user_id)\ntrip = get_best_trip(user_id)\nresult = {\n'user': user,\n'trip': trip\n}\nreturn result\n# \u4e0a\u9762\u8fd9\u6bb5\u4ee3\u7801\u91cc\u7684\u4e09\u4e2a\u4e34\u65f6\u53d8\u91cf\u5b8c\u5168\u53ef\u4ee5\u53bb\u6389\uff0c\u53d8\u6210\u4e0b\u9762\u8fd9\u6837\uff1a\ndef get_best_trip_by_user_id(user_id):\nreturn {\n'user': get_user(user_id),\n'trip': get_best_trip(user_id)\n}\n</code></pre> <p>\u8fd9\u6837\u7684\u4ee3\u7801\u5c31\u50cf\u5220\u6389\u8d58\u8bed\u7684\u53e5\u5b50\uff0c\u53d8\u5f97\u66f4\u7cbe\u7ec3\u3001\u66f4\u6613\u8bfb\u3002</p> <p>\u6240\u4ee5\uff0c\u4e0d\u5fc5\u4e3a\u4e86\u90a3\u4e9b\u672a\u6765\u53ef\u80fd\u51fa\u73b0\u7684\u53d8\u52a8\uff0c\u727a\u7272\u4ee3\u7801\u6b64\u65f6\u6b64\u523b\u7684\u53ef\u8bfb\u6027\u3002\u5982\u679c\u4ee5\u540e\u9700\u8981\u5b9a\u4e49\u53d8\u91cf\uff0c\u90a3\u5c31\u4ee5\u540e\u518d\u505a\u5427\uff01</p>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/2.%E7%BC%96%E7%A8%8B%E5%BB%BA%E8%AE%AE/#6\u4e0d\u8981\u4f7f\u7528locals","title":"6.\u4e0d\u8981\u4f7f\u7528locals()","text":"<p>locals()\u662fPython\u7684\u4e00\u4e2a\u5185\u7f6e\u51fd\u6570\uff0c\u8c03\u7528\u5b83\u4f1a\u8fd4\u56de\u5f53\u524d\u4f5c\u7528\u57df\u4e2d\u7684\u6240\u6709\u5c40\u90e8\u53d8\u91cf\uff1a</p> <pre><code>def foo():\nname = 'piglei'\nbar = 1\nprint(locals())\n# \u8c03\u7528foo() \u5c06\u8f93\u51fa\uff1a\n{'name': 'piglei', 'bar': 1}\n</code></pre> <p>\u5728\u6709\u4e9b\u573a\u666f\u4e0b\uff0c\u6211\u4eec\u9700\u8981\u4e00\u6b21\u6027\u62ff\u5230\u5f53\u524d\u4f5c\u7528\u57df\u4e0b\u7684\u6240\u6709\uff08\u6216\u7edd\u5927\u90e8\u5206\uff09\u53d8\u91cf\uff0c\u6bd4\u5982\u5728\u6e32\u67d3Django\u6a21\u677f\u65f6\uff1a</p> <pre><code>def render_trip_page(request, user_id, trip_id):\n\"\"\"\u6e32\u67d3\u65c5\u7a0b\u9875\u9762\"\"\"\nuser = User.objects.get(id=user_id)\ntrip = get_object_or_404(Trip, pk=trip_id)\nis_suggested = check_if_suggested(user, trip)\nreturn render(request, 'trip.html', {\n'user': user,\n'trip': trip,\n'is_suggested': is_suggested\n})\n</code></pre> <p>\u770b\u4e0a\u53bb\u4f7f\u7528locals()\u51fd\u6570\u6b63\u5408\u9002\uff0c\u5047\u5982\u8c03\u7528locals()\uff0c\u4e0a\u9762\u7684\u4ee3\u7801\u4f1a\u7b80\u5316\u8bb8\u591a\uff1a</p> <pre><code>def render_trip_page(request, user_id, trip_id):\n...\n# \u5229\u7528locals() \u628a\u5f53\u524d\u6240\u6709\u53d8\u91cf\u4f5c\u4e3a\u6a21\u677f\u6e32\u67d3\u53c2\u6570\u8fd4\u56de\n# \u8282\u7ea6\u4e86\u4e09\u884c\u4ee3\u7801\uff0c\u6211\u7b80\u76f4\u662f\u4e2a\u5929\u624d\uff01\nreturn render(request, 'trip.html', locals())\n</code></pre> <p>\u7b2c\u4e00\u773c\u770b\u4e0a\u53bb\u975e\u5e38\u201c\u7b80\u6d01\u201d\uff0c\u4f46\u662f\uff0c\u8fd9\u6837\u7684\u4ee3\u7801\u771f\u7684\u66f4\u597d\u5417\uff1f\u7b54\u6848\u5e76\u975e\u5982\u6b64\u3002locals()\u770b\u4f3c\u7b80\u6d01\uff0c\u4f46\u5176\u4ed6\u4eba\u5728\u9605\u8bfb\u4ee3\u7801\u65f6\uff0c\u4e3a\u4e86\u641e\u660e\u767d\u6a21\u677f\u6e32\u67d3\u5230\u5e95\u7528\u4e86\u54ea\u4e9b\u53d8\u91cf\uff0c\u5fc5\u987b\u8bb0\u4f4f\u5f53\u524d\u4f5c\u7528\u57df\u91cc\u7684\u6240\u6709\u53d8\u91cf\u3002</p> <p>\u5047\u5982\u51fd\u6570\u975e\u5e38\u590d\u6742\uff0c\u201c\u8bb0\u4f4f\u6240\u6709\u5c40\u90e8\u53d8\u91cf\u201d\u7b80\u76f4\u662f\u4e2a\u4e0d\u53ef\u80fd\u5b8c\u6210\u7684\u4efb\u52a1\u3002\u4f7f\u7528locals()\u8fd8\u6709\u4e00\u4e2a\u7f3a\u70b9\uff0c\u90a3\u5c31\u662f\u5b83\u4f1a\u628a\u4e00\u4e9b\u5e76\u6ca1\u6709\u771f\u6b63\u4f7f\u7528\u7684\u53d8\u91cf\u4e5f\u4e00\u5e76\u66b4\u9732\u3002</p> <p>\u56e0\u6b64\uff0c\u6bd4\u8d77\u4f7f\u7528locals()\uff0c\u5efa\u8bae\u8001\u8001\u5b9e\u5b9e\u628a\u4ee3\u7801\u5199\u6210\u8fd9\u6837\uff1a</p> <pre><code>    return render(request, 'trip.html', {\n'user': user,\n'trip': trip,\n'is_suggested': is_suggested\n})\n</code></pre> <p>Python\u4e4b\u7985\uff1a\u663e\u5f0f\u4f18\u4e8e\u9690\u5f0f\u5728Python\u547d\u4ee4\u884c\u4e2d\u8f93\u5165import this\uff0c\u4f60\u53ef\u4ee5\u770b\u5230Tim Peters\u5199\u7684\u4e00\u6bb5\u7f16\u7a0b\u539f\u5219\uff1aThe Zen of Python\uff08\u201cPython\u4e4b\u7985\u201d\uff09\u3002</p> <p>\u8fd9\u4e9b\u539f\u5219\u5b57\u5b57\u73e0\u7391\uff0c\u91cc\u9762\u8574\u85cf\u7740\u8bb8\u591aPython\u7f16\u7a0b\u667a\u6167\u3002</p> <p>\u201cPython\u4e4b\u7985\u201d\u4e2d\u6709\u4e00\u53e5\u201cExplicit is better than implicit\u201d\uff08\u663e\u5f0f\u4f18\u4e8e\u9690\u5f0f\uff09\uff0c\u8fd9\u6761\u539f\u5219\u5b8c\u5168\u53ef\u4ee5\u5957\u7528\u5230locals()\u7684\u4f8b\u5b50\u4e0a\u2014\u2014locals()\u5b9e\u5728\u662f\u592a\u9690\u6666\u4e86\uff0c\u76f4\u63a5\u5199\u51fa\u53d8\u91cf\u540d\u663e\u7136\u66f4\u597d\u3002</p>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/2.%E7%BC%96%E7%A8%8B%E5%BB%BA%E8%AE%AE/#7\u7a7a\u884c\u4e5f\u662f\u4e00\u79cd\u6ce8\u91ca","title":"7.\u7a7a\u884c\u4e5f\u662f\u4e00\u79cd\u6ce8\u91ca","text":"<p>\u9002\u5f53\u5730\u5728\u4ee3\u7801\u4e2d\u63d2\u5165\u7a7a\u884c\uff0c\u628a\u4ee3\u7801**\u6309\u7167\u4e0d\u540c\u7684\u903b\u8f91\u5757**\u5206\u5272\u5f00\uff0c\u8fd9\u6837\u80fd\u6709\u6548\u63d0\u5347\u4ee3\u7801\u7684\u53ef\u8bfb\u6027\u3002</p>"},{"location":"Python/1.%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B3%A8%E9%87%8A/2.%E7%BC%96%E7%A8%8B%E5%BB%BA%E8%AE%AE/#8\u5148\u5199\u6ce8\u91ca\u540e\u5199\u4ee3\u7801","title":"8.\u5148\u5199\u6ce8\u91ca\uff0c\u540e\u5199\u4ee3\u7801","text":"<p>\u51fd\u6570\u540d\u79f0\u548c\u63a5\u53e3\u6ce8\u91ca\u6bd4\u51fd\u6570\u5185\u90e8\u4ee3\u7801\u66f4\u52a0\u62bd\u8c61\uff0c\u56e0\u4e3a\u4f60\u9700\u8981\u5728\u51fd\u6570\u540d\u548c\u77ed\u77ed\u51e0\u884c\u6ce8\u91ca\u91cc\uff0c\u628a\u51fd\u6570\u5185\u90e8\u4ee3\u7801\u6240\u505a\u7684\u4e8b\u60c5\u9ad8\u5ea6\u6d53\u7f29\u7684\u8868\u8fbe\u6e05\u695a\u3002</p> <p>\u5047\u5982\u4f60\u6ca1\u6cd5\u901a\u8fc7\u51e0\u884c\u6ce8\u91ca\u628a\u51fd\u6570\u7684\u804c\u8d23\u63cf\u8ff0\u6e05\u695a\uff0c\u90a3\u4e48\u6574\u4e2a\u51fd\u6570\u7684\u5408\u7406\u6027\u5c31\u5e94\u8be5\u6253\u4e00\u4e2a\u95ee\u53f7\u3002</p>"},{"location":"docker/1.confcenter-docker/","title":"\u90e8\u7f72confcenter-docker","text":"<p>confcenter-docker\u4ed3\u5e93\u5730\u5740\uff1a </p> <p>https://github.com/hujianli94/confcenter-docker</p> <p>\u90e8\u7f72 webdavd \u53ca code-server</p> <ol> <li>\u521b\u5efa\u6301\u4e45\u5316\u76ee\u5f55</li> </ol> <pre><code>$ git clone https://github.com/hujianli94/confcenter-docker\n$ cd confcenter-docker\n$ sudo install -o 1000 -g 1000 -m 755 -d data/conf\n$ sudo install -o 0 -g 0 -m 755 -d data/share/share\n$ docker-compose up -d\n$ sudo install -o 1000 -g 1000 -m 755 -d data/conf/projects\n</code></pre> <p>\u672a\u5b8c\u5f85\u7eed</p>"}]}