<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="stay hungry,stay foolish #magic___^_^___line"><meta name=author content=hujainli94><link href=https://hujianli94.github.io/Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/ rel=canonical><link href=../../5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/ rel=prev><link href=../../../Docker/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Docker/ rel=next><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.5.22"><title>DevOps实践 - DevOps运维开发</title><link rel=stylesheet href=../../../assets/stylesheets/main.732c4fb1.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><style>:root{--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.752 1.752 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25ZM6 5a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"/></svg>');--md-admonition-icon--abstract:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.5 1.75v11.5c0 .138.112.25.25.25h3.17a.75.75 0 0 1 0 1.5H2.75A1.75 1.75 0 0 1 1 13.25V1.75C1 .784 1.784 0 2.75 0h8.5C12.216 0 13 .784 13 1.75v7.736a.75.75 0 0 1-1.5 0V1.75a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25Zm13.274 9.537v-.001l-4.557 4.45a.75.75 0 0 1-1.055-.008l-1.943-1.95a.75.75 0 0 1 1.062-1.058l1.419 1.425 4.026-3.932a.75.75 0 1 1 1.048 1.074ZM4.75 4h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM4 7.75A.75.75 0 0 1 4.75 7h2a.75.75 0 0 1 0 1.5h-2A.75.75 0 0 1 4 7.75Z"/></svg>');--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>');--md-admonition-icon--tip:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M3.499.75a.75.75 0 0 1 1.5 0v.996C5.9 2.903 6.793 3.65 7.662 4.376l.24.202c-.036-.694.055-1.422.426-2.163C9.1.873 10.794-.045 12.622.26 14.408.558 16 1.94 16 4.25c0 1.278-.954 2.575-2.44 2.734l.146.508.065.22c.203.701.412 1.455.476 2.226.142 1.707-.4 3.03-1.487 3.898C11.714 14.671 10.27 15 8.75 15h-6a.75.75 0 0 1 0-1.5h1.376a4.484 4.484 0 0 1-.563-1.191 3.835 3.835 0 0 1-.05-2.063 4.647 4.647 0 0 1-2.025-.293.75.75 0 0 1 .525-1.406c1.357.507 2.376-.006 2.698-.318l.009-.01a.747.747 0 0 1 1.06 0 .748.748 0 0 1-.012 1.074c-.912.92-.992 1.835-.768 2.586.221.74.745 1.337 1.196 1.621H8.75c1.343 0 2.398-.296 3.074-.836.635-.507 1.036-1.31.928-2.602-.05-.603-.216-1.224-.422-1.93l-.064-.221c-.12-.407-.246-.84-.353-1.29a2.425 2.425 0 0 1-.507-.441 3.075 3.075 0 0 1-.633-1.248.75.75 0 0 1 1.455-.364c.046.185.144.436.31.627.146.168.353.305.712.305.738 0 1.25-.615 1.25-1.25 0-1.47-.95-2.315-2.123-2.51-1.172-.196-2.227.387-2.706 1.345-.46.92-.27 1.774.019 3.062l.042.19a.884.884 0 0 1 .01.05c.348.443.666.949.94 1.553a.75.75 0 1 1-1.365.62c-.553-1.217-1.32-1.94-2.3-2.768L6.7 5.527c-.814-.68-1.75-1.462-2.692-2.619a3.737 3.737 0 0 0-1.023.88c-.406.495-.663 1.036-.722 1.508.116.122.306.21.591.239.388.038.797-.06 1.032-.19a.75.75 0 0 1 .728 1.31c-.515.287-1.23.439-1.906.373-.682-.067-1.473-.38-1.879-1.193L.75 5.677V5.5c0-.984.48-1.94 1.077-2.664.46-.559 1.05-1.055 1.673-1.353V.75Z"/></svg>');--md-admonition-icon--success:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg>');--md-admonition-icon--question:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.92 6.085h.001a.749.749 0 1 1-1.342-.67c.169-.339.436-.701.849-.977C6.845 4.16 7.369 4 8 4a2.756 2.756 0 0 1 1.637.525c.503.377.863.965.863 1.725 0 .448-.115.83-.329 1.15-.205.307-.47.513-.692.662-.109.072-.22.138-.313.195l-.006.004a6.24 6.24 0 0 0-.26.16.952.952 0 0 0-.276.245.75.75 0 0 1-1.248-.832c.184-.264.42-.489.692-.661.103-.067.207-.132.313-.195l.007-.004c.1-.061.182-.11.258-.161a.969.969 0 0 0 .277-.245C8.96 6.514 9 6.427 9 6.25a.612.612 0 0 0-.262-.525A1.27 1.27 0 0 0 8 5.5c-.369 0-.595.09-.74.187a1.01 1.01 0 0 0-.34.398ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>');--md-admonition-icon--warning:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>');--md-admonition-icon--failure:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.344 2.343h-.001a8 8 0 0 1 11.314 11.314A8.002 8.002 0 0 1 .234 10.089a8 8 0 0 1 2.11-7.746Zm1.06 10.253a6.5 6.5 0 1 0 9.108-9.275 6.5 6.5 0 0 0-9.108 9.275ZM6.03 4.97 8 6.94l1.97-1.97a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l1.97 1.97a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-1.97 1.97a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L6.94 8 4.97 6.03a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018Z"/></svg>');--md-admonition-icon--danger:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M9.504.43a1.516 1.516 0 0 1 2.437 1.713L10.415 5.5h2.123c1.57 0 2.346 1.909 1.22 3.004l-7.34 7.142a1.249 1.249 0 0 1-.871.354h-.302a1.25 1.25 0 0 1-1.157-1.723L5.633 10.5H3.462c-1.57 0-2.346-1.909-1.22-3.004L9.503.429Zm1.047 1.074L3.286 8.571A.25.25 0 0 0 3.462 9H6.75a.75.75 0 0 1 .694 1.034l-1.713 4.188 6.982-6.793A.25.25 0 0 0 12.538 7H9.25a.75.75 0 0 1-.683-1.06l2.008-4.418.003-.006a.036.036 0 0 0-.004-.009l-.006-.006-.008-.001c-.003 0-.006.002-.009.004Z"/></svg>');--md-admonition-icon--bug:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M4.72.22a.75.75 0 0 1 1.06 0l1 .999a3.488 3.488 0 0 1 2.441 0l.999-1a.748.748 0 0 1 1.265.332.75.75 0 0 1-.205.729l-.775.776c.616.63.995 1.493.995 2.444v.327c0 .1-.009.197-.025.292.408.14.764.392 1.029.722l1.968-.787a.75.75 0 0 1 .556 1.392L13 7.258V9h2.25a.75.75 0 0 1 0 1.5H13v.5c0 .409-.049.806-.141 1.186l2.17.868a.75.75 0 0 1-.557 1.392l-2.184-.873A4.997 4.997 0 0 1 8 16a4.997 4.997 0 0 1-4.288-2.427l-2.183.873a.75.75 0 0 1-.558-1.392l2.17-.868A5.036 5.036 0 0 1 3 11v-.5H.75a.75.75 0 0 1 0-1.5H3V7.258L.971 6.446a.75.75 0 0 1 .558-1.392l1.967.787c.265-.33.62-.583 1.03-.722a1.677 1.677 0 0 1-.026-.292V4.5c0-.951.38-1.814.995-2.444L4.72 1.28a.75.75 0 0 1 0-1.06Zm.53 6.28a.75.75 0 0 0-.75.75V11a3.5 3.5 0 1 0 7 0V7.25a.75.75 0 0 0-.75-.75ZM6.173 5h3.654A.172.172 0 0 0 10 4.827V4.5a2 2 0 1 0-4 0v.327c0 .096.077.173.173.173Z"/></svg>');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M5 5.782V2.5h-.25a.75.75 0 0 1 0-1.5h6.5a.75.75 0 0 1 0 1.5H11v3.282l3.666 5.76C15.619 13.04 14.543 15 12.767 15H3.233c-1.776 0-2.852-1.96-1.899-3.458Zm-2.4 6.565a.75.75 0 0 0 .633 1.153h9.534a.75.75 0 0 0 .633-1.153L12.225 10.5h-8.45ZM9.5 2.5h-3V6c0 .143-.04.283-.117.403L4.73 9h6.54L9.617 6.403A.746.746 0 0 1 9.5 6Z"/></svg>');--md-admonition-icon--quote:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1.75 2.5h10.5a.75.75 0 0 1 0 1.5H1.75a.75.75 0 0 1 0-1.5Zm4 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5Zm0 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5ZM2.5 7.75v6a.75.75 0 0 1-1.5 0v-6a.75.75 0 0 1 1.5 0Z"/></svg>');}</style><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../stylesheets/extra.css><link rel=stylesheet href=https://file.cdn.shafish.cn/blog/css/vssue.css><link rel=stylesheet href=https://file.cdn.shafish.cn/blog/css/video-js.min.css><link rel=stylesheet href=https://file.cdn.shafish.cn/blog/css/video.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","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"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","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",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=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",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script><script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#devops实践 class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../.. title=DevOps运维开发 class="md-header__button md-logo" aria-label=DevOps运维开发 data-md-component=logo> <img src=../../../assets/images/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> DevOps运维开发 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> DevOps实践 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label=切换至深色模式 type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title=切换至深色模式 for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=blue aria-label=切换至浅色模式 type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title=切换至浅色模式 for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=查找> <a href=javascript:void(0) class="md-search__icon md-icon" title=分享 aria-label=分享 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/hujianli94/hujianli94.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> hujianli94.github.io </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> 首页 </a> </li> <li class=md-tabs__item> <a href=../../../k8s/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.k8s/ class=md-tabs__link> k8s </a> </li> <li class=md-tabs__item> <a href=../../../K8s-network/0.network-namespace/1.network-namespace/ class=md-tabs__link> K8s-network </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Kubernetes/ class=md-tabs__link> Kubernetes </a> </li> <li class=md-tabs__item> <a href=../../../Docker/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Docker/ class=md-tabs__link> Docker </a> </li> <li class=md-tabs__item> <a href=../../../Golang/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Go-Web%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/ class=md-tabs__link> Golang </a> </li> <li class=md-tabs__item> <a href=../../../Python/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Pythjon-auto-ops/ class=md-tabs__link> Python </a> </li> <li class=md-tabs__item> <a href=../../../Openstack/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.OpenStack/ class=md-tabs__link> Openstack </a> </li> <li class=md-tabs__item> <a href=../../../Python-vs-Go/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Python-vs-Go/ class=md-tabs__link> Python-vs-Go </a> </li> <li class=md-tabs__item> <a href=../../../Linux/Shell/Shell%E7%AE%80%E4%BB%8B/ class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../../Other/tools/1.PicGo%E5%9B%BE%E5%BA%8A/ class=md-tabs__link> Other </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=DevOps运维开发 class="md-nav__button md-logo" aria-label=DevOps运维开发 data-md-component=logo> <img src=../../../assets/images/logo.png alt=logo> </a> DevOps运维开发 </label> <div class=md-nav__source> <a href=https://github.com/hujianli94/hujianli94.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> hujianli94.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> 首页 </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> k8s </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> k8s </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1> <label class=md-nav__link for=__nav_2_1 id=__nav_2_1_label tabindex=0> <span class=md-ellipsis> 0.学习线路 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> 0.学习线路 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.k8s/ class=md-nav__link> <span class=md-ellipsis> Kubernetes从入门到实践 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex=0> <span class=md-ellipsis> 1.容器的发展史 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> 1.容器的发展史 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/1.%E5%AE%B9%E5%99%A8%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2/1.1%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B%E7%9A%84%E5%8F%91%E5%B1%95/ class=md-nav__link> <span class=md-ellipsis> 1.1开发过程的发展 </span> </a> </li> <li class=md-nav__item> <a href=../../../k8s/1.%E5%AE%B9%E5%99%A8%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2/1.2%E5%BA%94%E7%94%A8%E6%9E%B6%E6%9E%84%E7%9A%84%E5%8F%91%E5%B1%95/ class=md-nav__link> <span class=md-ellipsis> 1.2应用架构的发展 </span> </a> </li> <li class=md-nav__item> <a href=../../../k8s/1.%E5%AE%B9%E5%99%A8%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2/1.3%E9%83%A8%E7%BD%B2%E6%89%93%E5%8C%85%E7%9A%84%E5%8F%91%E5%B1%95/ class=md-nav__link> <span class=md-ellipsis> 1.3部署打包的发展 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> <span class=md-ellipsis> 2.Kubernetes的核心概念 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> 2.Kubernetes的核心概念 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/2.Kubernetes%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5/2.1Kubernetes%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%9E%B6%E6%9E%84/ class=md-nav__link> <span class=md-ellipsis> 2.1Kubernetes的设计架构 </span> </a> </li> <li class=md-nav__item> <a href=../../../k8s/2.Kubernetes%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5/2.2Kubernetes%E7%9A%84%E6%A0%B8%E5%BF%83%E5%AF%B9%E8%B1%A1/ class=md-nav__link> <span class=md-ellipsis> 2.2Kubernetes的核心对象 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4 id=__nav_2_4_label tabindex=0> <span class=md-ellipsis> 3.Kubernetes的安装和部署 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> 3.Kubernetes的安装和部署 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/3.Kubernetes%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E9%83%A8%E7%BD%B2/3.1kubeadm%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/ class=md-nav__link> <span class=md-ellipsis> 3.1kubeadm搭建开发环境 </span> </a> </li> <li class=md-nav__item> <a href=../../../k8s/3.Kubernetes%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E9%83%A8%E7%BD%B2/3.2kubeadm%E6%90%AD%E5%BB%BA%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83/ class=md-nav__link> <span class=md-ellipsis> 3.2kubeadm搭建生产环境 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_5> <label class=md-nav__link for=__nav_2_5 id=__nav_2_5_label tabindex=0> <span class=md-ellipsis> 4.Pod </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_5_label aria-expanded=false> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> 4.Pod </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/4.Pod/4.1Pod%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/ class=md-nav__link> <span class=md-ellipsis> 4.1Pod的基本操作 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_6> <label class=md-nav__link for=__nav_2_6 id=__nav_2_6_label tabindex=0> <span class=md-ellipsis> 5.控制器 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_6_label aria-expanded=false> <label class=md-nav__title for=__nav_2_6> <span class="md-nav__icon md-icon"></span> 5.控制器 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/5.%E6%8E%A7%E5%88%B6%E5%99%A8/5.1Deployment/ class=md-nav__link> <span class=md-ellipsis> 5.1Deployment </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> K8s-network </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> K8s-network </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1> <label class=md-nav__link for=__nav_3_1 id=__nav_3_1_label tabindex=0> <span class=md-ellipsis> 0.network-namespace </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> 0.network-namespace </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../K8s-network/0.network-namespace/1.network-namespace/ class=md-nav__link> <span class=md-ellipsis> 1.network-namespace </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Kubernetes </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1 id=__nav_4_1_label tabindex=0> <span class=md-ellipsis> 0.学习线路 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> 0.学习线路 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Kubernetes/ class=md-nav__link> <span class=md-ellipsis> Kubernetes </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex=0> <span class=md-ellipsis> 1.安装篇 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> 1.安装篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/ class=md-nav__link> <span class=md-ellipsis> Kubeadm安装高可用集群 </span> </a> </li> <li class=md-nav__item> <a href=../../1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/ class=md-nav__link> <span class=md-ellipsis> 二进制安装高可用K8s集群 </span> </a> </li> <li class=md-nav__item> <a href=../../1.%E5%AE%89%E8%A3%85%E7%AF%87/3.%E5%AE%89%E8%A3%85%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/ class=md-nav__link> <span class=md-ellipsis> 安装常用工具 </span> </a> </li> <li class=md-nav__item> <a href=../../1.%E5%AE%89%E8%A3%85%E7%AF%87/4.Kubeadm%E5%AE%89%E8%A3%85%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/ class=md-nav__link> <span class=md-ellipsis> Kubeadm安装开发环境 </span> </a> </li> <li class=md-nav__item> <a href=../../1.%E5%AE%89%E8%A3%85%E7%AF%87/5.K3s%E5%92%8CMinikube/ class=md-nav__link> <span class=md-ellipsis> K3s和Minikube </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3 id=__nav_4_3_label tabindex=0> <span class=md-ellipsis> 2.基础篇 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> 2.基础篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/ class=md-nav__link> <span class=md-ellipsis> Docker基础 </span> </a> </li> <li class=md-nav__item> <a href=../../2.%E5%9F%BA%E7%A1%80%E7%AF%87/4.Kubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/ class=md-nav__link> <span class=md-ellipsis> Kubernetes的基础概念 </span> </a> </li> <li class=md-nav__item> <a href=../../2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/ class=md-nav__link> <span class=md-ellipsis> Kubernetes调度基础 </span> </a> </li> <li class=md-nav__item> <a href=../../2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/ class=md-nav__link> <span class=md-ellipsis> Kubernetes服务发布基础 </span> </a> </li> <li class=md-nav__item> <a href=../../2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> Kubernetes配置管理 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4 id=__nav_4_4_label tabindex=0> <span class=md-ellipsis> 3.进阶篇 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> 3.进阶篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/ class=md-nav__link> <span class=md-ellipsis> Kubernetes存储入门 </span> </a> </li> <li class=md-nav__item> <a href=../../3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/ class=md-nav__link> <span class=md-ellipsis> Kubernetes高级调度 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_5> <label class=md-nav__link for=__nav_4_5 id=__nav_4_5_label tabindex=0> <span class=md-ellipsis> 4.高级篇 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_5_label aria-expanded=false> <label class=md-nav__title for=__nav_4_5> <span class="md-nav__icon md-icon"></span> 4.高级篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../4.%E9%AB%98%E7%BA%A7%E7%AF%87/12.%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AD%98%E5%82%A8Rook/ class=md-nav__link> <span class=md-ellipsis> 云原生存储Rook </span> </a> </li> <li class=md-nav__item> <a href=../../4.%E9%AB%98%E7%BA%A7%E7%AF%87/13.%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%B9%E5%99%A8%E5%8C%96/ class=md-nav__link> <span class=md-ellipsis> 中间件容器化 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_6> <label class=md-nav__link for=__nav_4_6 id=__nav_4_6_label tabindex=0> <span class=md-ellipsis> 5.运维篇 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_6_label aria-expanded=false> <label class=md-nav__title for=__nav_4_6> <span class="md-nav__icon md-icon"></span> 5.运维篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../5.%E8%BF%90%E7%BB%B4%E7%AF%87/14.Kubernetes%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/ class=md-nav__link> <span class=md-ellipsis> Kubernetes日志收集 </span> </a> </li> <li class=md-nav__item> <a href=../../5.%E8%BF%90%E7%BB%B4%E7%AF%87/15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/ class=md-nav__link> <span class=md-ellipsis> Kubernetes监控告警 </span> </a> </li> <li class=md-nav__item> <a href=../../5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/ class=md-nav__link> <span class=md-ellipsis> 服务发布Ingress进阶 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_7 checked> <label class=md-nav__link for=__nav_4_7 id=__nav_4_7_label tabindex=0> <span class=md-ellipsis> 6.DevOps篇 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_7_label aria-expanded=true> <label class=md-nav__title for=__nav_4_7> <span class="md-nav__icon md-icon"></span> 6.DevOps篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> DevOps实践 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> DevOps实践 </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1-cicd介绍 class=md-nav__link> <span class=md-ellipsis> 1. CI/CD介绍 </span> </a> <nav class=md-nav aria-label="1. CI/CD介绍"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#11-持续集成ci class=md-nav__link> <span class=md-ellipsis> 1.1 持续集成(CI) </span> </a> </li> <li class=md-nav__item> <a href=#12-持续交付cd class=md-nav__link> <span class=md-ellipsis> 1.2 持续交付(CD) </span> </a> </li> <li class=md-nav__item> <a href=#13-持续部署cd class=md-nav__link> <span class=md-ellipsis> 1.3 持续部署(CD) </span> </a> </li> <li class=md-nav__item> <a href=#14-ci和cd的区别 class=md-nav__link> <span class=md-ellipsis> 1.4 CI和CD的区别 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-jenkins流水线介绍 class=md-nav__link> <span class=md-ellipsis> 2. Jenkins流水线介绍 </span> </a> <nav class=md-nav aria-label="2. Jenkins流水线介绍"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-什么是流水线 class=md-nav__link> <span class=md-ellipsis> 2.1 什么是流水线 </span> </a> </li> <li class=md-nav__item> <a href=#22-声明式流水线 class=md-nav__link> <span class=md-ellipsis> 2.2 声明式流水线 </span> </a> </li> <li class=md-nav__item> <a href=#23-脚本化流水线 class=md-nav__link> <span class=md-ellipsis> 2.3 脚本化流水线 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-声明式流水线的语法 class=md-nav__link> <span class=md-ellipsis> 3. 声明式流水线的语法 </span> </a> <nav class=md-nav aria-label="3. 声明式流水线的语法"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-sections class=md-nav__link> <span class=md-ellipsis> 3.1 Sections </span> </a> <nav class=md-nav aria-label="3.1 Sections"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-agent class=md-nav__link> <span class=md-ellipsis> 1. agent </span> </a> </li> <li class=md-nav__item> <a href=#2-post class=md-nav__link> <span class=md-ellipsis> 2. Post </span> </a> </li> <li class=md-nav__item> <a href=#3-stages class=md-nav__link> <span class=md-ellipsis> 3. stages </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#32-directives class=md-nav__link> <span class=md-ellipsis> 3.2 directives </span> </a> <nav class=md-nav aria-label="3.2 directives"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-environment class=md-nav__link> <span class=md-ellipsis> 1. environment </span> </a> </li> <li class=md-nav__item> <a href=#2-options class=md-nav__link> <span class=md-ellipsis> 2. options </span> </a> </li> <li class=md-nav__item> <a href=#3-parameters class=md-nav__link> <span class=md-ellipsis> 3. parameters </span> </a> </li> <li class=md-nav__item> <a href=#4-triggers class=md-nav__link> <span class=md-ellipsis> 4. triggers </span> </a> </li> <li class=md-nav__item> <a href=#5-stage class=md-nav__link> <span class=md-ellipsis> 5. stage </span> </a> </li> <li class=md-nav__item> <a href=#6-input class=md-nav__link> <span class=md-ellipsis> 6. Input </span> </a> </li> <li class=md-nav__item> <a href=#7-when class=md-nav__link> <span class=md-ellipsis> 7. when </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#33-parallel class=md-nav__link> <span class=md-ellipsis> 3.3 parallel </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-jenkinsfile的使用 class=md-nav__link> <span class=md-ellipsis> 4. Jenkinsfile的使用 </span> </a> <nav class=md-nav aria-label="4. Jenkinsfile的使用"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#41-环境变量 class=md-nav__link> <span class=md-ellipsis> 4.1 环境变量 </span> </a> <nav class=md-nav aria-label="4.1 环境变量"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-静态变量 class=md-nav__link> <span class=md-ellipsis> 1. 静态变量 </span> </a> </li> <li class=md-nav__item> <a href=#2-动态变量 class=md-nav__link> <span class=md-ellipsis> 2. 动态变量 </span> </a> </li> <li class=md-nav__item> <a href=#3-jenkins内置变量 class=md-nav__link> <span class=md-ellipsis> 3. Jenkins内置变量 </span> </a> </li> <li class=md-nav__item> <a href=#4-自定义变量 class=md-nav__link> <span class=md-ellipsis> 4. 自定义变量 </span> </a> </li> <li class=md-nav__item> <a href=#5-覆盖环境变量 class=md-nav__link> <span class=md-ellipsis> 5. 覆盖环境变量 </span> </a> </li> <li class=md-nav__item> <a href=#6-环境变量的互相引用 class=md-nav__link> <span class=md-ellipsis> 6. 环境变量的互相引用 </span> </a> </li> <li class=md-nav__item> <a href=#7-将布尔值存储在环境变量中 class=md-nav__link> <span class=md-ellipsis> 7. 将布尔值存储在环境变量中 </span> </a> </li> <li class=md-nav__item> <a href=#8-自定义全局环境变量 class=md-nav__link> <span class=md-ellipsis> 8. 自定义全局环境变量 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#42-凭证管理 class=md-nav__link> <span class=md-ellipsis> 4.2 凭证管理 </span> </a> <nav class=md-nav aria-label="4.2 凭证管理"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-加密文本 class=md-nav__link> <span class=md-ellipsis> 1. 加密文本 </span> </a> </li> <li class=md-nav__item> <a href=#2-用户名密码 class=md-nav__link> <span class=md-ellipsis> 2. 用户名密码 </span> </a> </li> <li class=md-nav__item> <a href=#3-加密文件 class=md-nav__link> <span class=md-ellipsis> 3. 加密文件 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#43-参数处理 class=md-nav__link> <span class=md-ellipsis> 4.3 参数处理 </span> </a> </li> <li class=md-nav__item> <a href=#44-处理失败 class=md-nav__link> <span class=md-ellipsis> 4.4 处理失败 </span> </a> </li> <li class=md-nav__item> <a href=#45-使用多个代理 class=md-nav__link> <span class=md-ellipsis> 4.5 使用多个代理 </span> </a> </li> <li class=md-nav__item> <a href=#46-流水线回放功能 class=md-nav__link> <span class=md-ellipsis> 4.6 流水线回放功能 </span> </a> </li> <li class=md-nav__item> <a href=#47-pipeline开发工具 class=md-nav__link> <span class=md-ellipsis> 4.7 Pipeline开发工具 </span> </a> <nav class=md-nav aria-label="4.7 Pipeline开发工具"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#片段生成器 class=md-nav__link> <span class=md-ellipsis> 片段生成器 </span> </a> </li> <li class=md-nav__item> <a href=#声明式语法生成器 class=md-nav__link> <span class=md-ellipsis> 声明式语法生成器 </span> </a> </li> <li class=md-nav__item> <a href=#全局变量参考 class=md-nav__link> <span class=md-ellipsis> 全局变量参考 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#48-dsl方法 class=md-nav__link> <span class=md-ellipsis> 4.8 DSL方法 </span> </a> <nav class=md-nav aria-label="4.8 DSL方法"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#481-json数据格式解析 class=md-nav__link> <span class=md-ellipsis> 4.8.1 JSON数据格式解析 </span> </a> </li> <li class=md-nav__item> <a href=#482-流水线中使用凭证 class=md-nav__link> <span class=md-ellipsis> 4.8.2 流水线中使用凭证 </span> </a> </li> <li class=md-nav__item> <a href=#483-代码管理-下载代码 class=md-nav__link> <span class=md-ellipsis> 4.8.3 代码管理-下载代码 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#49-groovy编程 class=md-nav__link> <span class=md-ellipsis> 4.9 Groovy编程 </span> </a> <nav class=md-nav aria-label="4.9 Groovy编程"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1安装 class=md-nav__link> <span class=md-ellipsis> 1.安装 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#5-devops平台建设 class=md-nav__link> <span class=md-ellipsis> 5. DevOps平台建设 </span> </a> <nav class=md-nav aria-label="5. DevOps平台建设"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#51-安装jenkins class=md-nav__link> <span class=md-ellipsis> 5.1 安装Jenkins </span> </a> <nav class=md-nav aria-label="5.1 安装Jenkins"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-服务方式 class=md-nav__link> <span class=md-ellipsis> 1. 服务方式 </span> </a> </li> <li class=md-nav__item> <a href=#2-docker-master-slave方式部推荐 class=md-nav__link> <span class=md-ellipsis> 2. docker-master-slave方式部(推荐) </span> </a> </li> <li class=md-nav__item> <a href=#3-helm方式部署推荐 class=md-nav__link> <span class=md-ellipsis> 3. helm方式部署(推荐) </span> </a> <nav class=md-nav aria-label="3. helm方式部署(推荐)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-部署nfs class=md-nav__link> <span class=md-ellipsis> 3.1 部署nfs </span> </a> </li> <li class=md-nav__item> <a href=#32-部署storageclass class=md-nav__link> <span class=md-ellipsis> 3.2 部署StorageClass </span> </a> </li> <li class=md-nav__item> <a href=#33-部署jenkins class=md-nav__link> <span class=md-ellipsis> 3.3 部署jenkins </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-yaml方式部署不推荐 class=md-nav__link> <span class=md-ellipsis> 4. yaml方式部署(不推荐) </span> </a> </li> <li class=md-nav__item> <a href=#5-架构 class=md-nav__link> <span class=md-ellipsis> 5. 架构 </span> </a> <nav class=md-nav aria-label="5. 架构"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-配置 class=md-nav__link> <span class=md-ellipsis> 1. 配置 </span> </a> <nav class=md-nav aria-label="1. 配置"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#11-docker-in-pod推荐 class=md-nav__link> <span class=md-ellipsis> 1.1 docker in pod(推荐) </span> </a> </li> <li class=md-nav__item> <a href=#12-物理机build推荐 class=md-nav__link> <span class=md-ellipsis> 1.2 物理机build(推荐) </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-测试 class=md-nav__link> <span class=md-ellipsis> 2. 测试 </span> </a> <nav class=md-nav aria-label="2. 测试"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-自由风格的流水线 class=md-nav__link> <span class=md-ellipsis> 2.1 自由风格的流水线 </span> </a> </li> <li class=md-nav__item> <a href=#22-pipeline流水线 class=md-nav__link> <span class=md-ellipsis> 2.2 pipeline流水线 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#52-安装gitlab class=md-nav__link> <span class=md-ellipsis> 5.2 安装GitLab </span> </a> <nav class=md-nav aria-label="5.2 安装GitLab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-服务方式部署推荐 class=md-nav__link> <span class=md-ellipsis> 1. 服务方式部署(推荐) </span> </a> </li> <li class=md-nav__item> <a href=#2-docker方式部署推荐 class=md-nav__link> <span class=md-ellipsis> 2. docker方式部署(推荐) </span> </a> <nav class=md-nav aria-label="2. docker方式部署(推荐)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-sameersbngitlab class=md-nav__link> <span class=md-ellipsis> 2.1 sameersbn/gitlab </span> </a> </li> <li class=md-nav__item> <a href=#22-gitlabgitlab-ce class=md-nav__link> <span class=md-ellipsis> 2.2 gitlab/gitlab-ce </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-yaml方式部署不推荐 class=md-nav__link> <span class=md-ellipsis> 3. yaml方式部署(不推荐) </span> </a> </li> <li class=md-nav__item> <a href=#4-helm3安装gitlab不推荐 class=md-nav__link> <span class=md-ellipsis> 4. helm3安装gitlab(不推荐) </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#53-安装harbor class=md-nav__link> <span class=md-ellipsis> 5.3 安装Harbor </span> </a> <nav class=md-nav aria-label="5.3 安装Harbor"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-docker方式部署推荐 class=md-nav__link> <span class=md-ellipsis> 1. docker方式部署(推荐) </span> </a> </li> <li class=md-nav__item> <a href=#2-helm方式部署 class=md-nav__link> <span class=md-ellipsis> 2. helm方式部署 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#54-jenkins凭证credentials class=md-nav__link> <span class=md-ellipsis> 5.4 Jenkins凭证Credentials </span> </a> <nav class=md-nav aria-label="5.4 Jenkins凭证Credentials"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-配置kubernetes证书 class=md-nav__link> <span class=md-ellipsis> 1. 配置Kubernetes证书 </span> </a> </li> <li class=md-nav__item> <a href=#2-配置harbor账号和密码 class=md-nav__link> <span class=md-ellipsis> 2. 配置Harbor账号和密码 </span> </a> </li> <li class=md-nav__item> <a href=#3-配置gitlab-key class=md-nav__link> <span class=md-ellipsis> 3. 配置GitLab Key </span> </a> </li> <li class=md-nav__item> <a href=#4-配置gitlab账号密码 class=md-nav__link> <span class=md-ellipsis> 4. 配置GitLab账号密码 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#55-配置agent class=md-nav__link> <span class=md-ellipsis> 5.5 配置Agent </span> </a> </li> <li class=md-nav__item> <a href=#56-jenkins配置kubernetes多集群 class=md-nav__link> <span class=md-ellipsis> 5.6 Jenkins配置Kubernetes多集群 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#6-自动化构建java应用 class=md-nav__link> <span class=md-ellipsis> 6. 自动化构建Java应用 </span> </a> <nav class=md-nav aria-label="6. 自动化构建Java应用"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#61-部署kubernetes应用 class=md-nav__link> <span class=md-ellipsis> 6.1 部署Kubernetes应用 </span> </a> </li> <li class=md-nav__item> <a href=#62-创建java测试用例 class=md-nav__link> <span class=md-ellipsis> 6.2 创建Java测试用例 </span> </a> </li> <li class=md-nav__item> <a href=#63-定义jenkinsfile class=md-nav__link> <span class=md-ellipsis> 6.3 定义Jenkinsfile </span> </a> </li> <li class=md-nav__item> <a href=#64-jenkinsfile详解 class=md-nav__link> <span class=md-ellipsis> 6.4 Jenkinsfile详解 </span> </a> </li> <li class=md-nav__item> <a href=#65-定义dockerfile class=md-nav__link> <span class=md-ellipsis> 6.5 定义Dockerfile </span> </a> </li> <li class=md-nav__item> <a href=#66-定义kubernetes资源 class=md-nav__link> <span class=md-ellipsis> 6.6 定义Kubernetes资源 </span> </a> </li> <li class=md-nav__item> <a href=#67-创建jenkins任务 class=md-nav__link> <span class=md-ellipsis> 6.7 创建Jenkins任务 </span> </a> </li> <li class=md-nav__item> <a href=#68-webhook自动触发构建 class=md-nav__link> <span class=md-ellipsis> 6.8 Webhook自动触发构建 </span> </a> </li> <li class=md-nav__item> <a href=#69-构建状态信息推送到gitlab class=md-nav__link> <span class=md-ellipsis> 6.9 构建状态信息推送到GitLab </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#7-自动化构建vueh5前端应用 class=md-nav__link> <span class=md-ellipsis> 7. 自动化构建Vue/H5前端应用 </span> </a> <nav class=md-nav aria-label="7. 自动化构建Vue/H5前端应用"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#71-定义jenkinsfile class=md-nav__link> <span class=md-ellipsis> 7.1 定义Jenkinsfile </span> </a> </li> <li class=md-nav__item> <a href=#72-定义dockerfile class=md-nav__link> <span class=md-ellipsis> 7.2 定义Dockerfile </span> </a> </li> <li class=md-nav__item> <a href=#73-定义kubernetes资源 class=md-nav__link> <span class=md-ellipsis> 7,3 定义Kubernetes资源 </span> </a> </li> <li class=md-nav__item> <a href=#74-创建jenkins-job class=md-nav__link> <span class=md-ellipsis> 7.4 创建Jenkins Job </span> </a> </li> <li class=md-nav__item> <a href=#75-webhook自动触发 class=md-nav__link> <span class=md-ellipsis> 7.5 Webhook自动触发 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#8-自动化构建golang项目 class=md-nav__link> <span class=md-ellipsis> 8. 自动化构建Golang项目 </span> </a> <nav class=md-nav aria-label="8. 自动化构建Golang项目"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#81-定义jenkinsfile class=md-nav__link> <span class=md-ellipsis> 8.1 定义Jenkinsfile </span> </a> </li> <li class=md-nav__item> <a href=#82-定义dockerfile class=md-nav__link> <span class=md-ellipsis> 8.2 定义Dockerfile </span> </a> </li> <li class=md-nav__item> <a href=#83-定义kubernets资源 class=md-nav__link> <span class=md-ellipsis> 8.3 定义Kubernets资源 </span> </a> </li> <li class=md-nav__item> <a href=#84-创建jenkins-job class=md-nav__link> <span class=md-ellipsis> 8.4 创建Jenkins Job </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#9-uat及生产环境流水线设计 class=md-nav__link> <span class=md-ellipsis> 9. UAT及生产环境流水线设计 </span> </a> </li> <li class=md-nav__item> <a href=#10-vscode-jenkins插件分享 class=md-nav__link> <span class=md-ellipsis> 10. vscode Jenkins插件分享 </span> </a> <nav class=md-nav aria-label="10. vscode Jenkins插件分享"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#101-在vscode中校验您的jenkinsfile class=md-nav__link> <span class=md-ellipsis> 10.1 在VSCode中校验您的Jenkinsfile </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#11-小结 class=md-nav__link> <span class=md-ellipsis> 11. 小结 </span> </a> </li> <li class=md-nav__item> <a href=#参考文献 class=md-nav__link> <span class=md-ellipsis> 参考文献 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Docker </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_1> <label class=md-nav__link for=__nav_5_1 id=__nav_5_1_label tabindex=0> <span class=md-ellipsis> 0.学习线路 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_1_label aria-expanded=false> <label class=md-nav__title for=__nav_5_1> <span class="md-nav__icon md-icon"></span> 0.学习线路 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Docker/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Docker/ class=md-nav__link> <span class=md-ellipsis> Docker </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_2> <label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex=0> <span class=md-ellipsis> 1.基础 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=false> <label class=md-nav__title for=__nav_5_2> <span class="md-nav__icon md-icon"></span> 1.基础 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/1.%E5%AE%89%E8%A3%85Docker/ class=md-nav__link> <span class=md-ellipsis> 1.安装Docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/2.Docker%E9%95%9C%E5%83%8F/ class=md-nav__link> <span class=md-ellipsis> 2.Docker 镜像 </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/3.Docker%E5%AE%B9%E5%99%A8/ class=md-nav__link> <span class=md-ellipsis> 3.Docker容器 </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/4.%E4%BC%81%E4%B8%9A%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93harbor/ class=md-nav__link> <span class=md-ellipsis> 4.企业私有仓库harbor </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/5.Docker%E6%95%B0%E6%8D%AE/ class=md-nav__link> <span class=md-ellipsis> 5.Docker数据 </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/6.Docker%E7%BD%91%E7%BB%9C/ class=md-nav__link> <span class=md-ellipsis> 6.Docker网络 </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/7.Dockerfile/ class=md-nav__link> <span class=md-ellipsis> 7.Dockerfile </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/8.docker-compose/ class=md-nav__link> <span class=md-ellipsis> 8.docker-compose </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/9.Docker%E7%9B%B8%E5%85%B3%E8%84%9A%E6%9C%AC/ class=md-nav__link> <span class=md-ellipsis> 9.Docker相关脚本 </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/10.Docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/ class=md-nav__link> <span class=md-ellipsis> 10.Docker常用命令 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_3> <label class=md-nav__link for=__nav_5_3 id=__nav_5_3_label tabindex=0> <span class=md-ellipsis> 2.实战案例 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_3_label aria-expanded=false> <label class=md-nav__title for=__nav_5_3> <span class="md-nav__icon md-icon"></span> 2.实战案例 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Docker/2.%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/1.%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/ class=md-nav__link> <span class=md-ellipsis> 1.操作系统 </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/2.%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/2.Web%E6%9C%8D%E5%8A%A1%E4%B8%8E%E5%BA%94%E7%94%A8/ class=md-nav__link> <span class=md-ellipsis> 2.Web服务与应用 </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/2.%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/3.%E6%8C%81%E7%BB%AD%E5%BC%80%E5%8F%91%E4%B8%8E%E7%AE%A1%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 3.持续开发与管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/2.%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/4.%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BA%94%E7%94%A8/ class=md-nav__link> <span class=md-ellipsis> 4.数据库应用 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_4> <label class=md-nav__link for=__nav_5_4 id=__nav_5_4_label tabindex=0> <span class=md-ellipsis> 3.Devops </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_4_label aria-expanded=false> <label class=md-nav__title for=__nav_5_4> <span class="md-nav__icon md-icon"></span> 3.Devops </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Docker/3.Devops/1.confcenter-docker/ class=md-nav__link> <span class=md-ellipsis> 1.confcenter-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/2.simaple-jenkins/ class=md-nav__link> <span class=md-ellipsis> 2.simaple-jenkins </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/3.docker-nginx-spa/ class=md-nav__link> <span class=md-ellipsis> 3.docker-nginx-spa </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/4.fileserver-docker/ class=md-nav__link> <span class=md-ellipsis> 4.fileserver-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/5.haproxy-docker/ class=md-nav__link> <span class=md-ellipsis> 5.haproxy-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/6.mysql-docker/ class=md-nav__link> <span class=md-ellipsis> 6.mysql-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/7.frp-docker/ class=md-nav__link> <span class=md-ellipsis> 7.frp-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/8.coredns-docker/ class=md-nav__link> <span class=md-ellipsis> 8.coredns-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/9.simple-harbor/ class=md-nav__link> <span class=md-ellipsis> 9.simple-harbor </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/10.redis-docker/ class=md-nav__link> <span class=md-ellipsis> 10.redis-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/11.nexus3-docker/ class=md-nav__link> <span class=md-ellipsis> 11.nexus3-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/12.openvpn-docker/ class=md-nav__link> <span class=md-ellipsis> 12.openvpn-docker.md </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/13.nfs-docker/ class=md-nav__link> <span class=md-ellipsis> 13.nfs-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/14.jumpserver-docker/ class=md-nav__link> <span class=md-ellipsis> 14.jumpserver-docker.md </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/15.ansible-docker/ class=md-nav__link> <span class=md-ellipsis> 15.ansible-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/16.minio-docker/ class=md-nav__link> <span class=md-ellipsis> 16.minio-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/17.vaultwarden-docker/ class=md-nav__link> <span class=md-ellipsis> 17.vaultwarden-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/18.kasm-docker/ class=md-nav__link> <span class=md-ellipsis> 18.kasm-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/19.nginx-docker/ class=md-nav__link> <span class=md-ellipsis> 19.nginx-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/20.kafka-docker/ class=md-nav__link> <span class=md-ellipsis> 20.kafka-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/21.golang-docker/ class=md-nav__link> <span class=md-ellipsis> 21.golang-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/22.postgres-docker/ class=md-nav__link> <span class=md-ellipsis> 22.postgres-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/23.nginx-download-docker/ class=md-nav__link> <span class=md-ellipsis> 23.nginx-download-docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/24.helm%E9%83%A8%E7%BD%B2%E5%B8%B8%E7%94%A8%E6%9C%8D%E5%8A%A1/ class=md-nav__link> <span class=md-ellipsis> 24.helm部署常用服务 </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/25.Python%E6%93%8D%E4%BD%9CDocker/ class=md-nav__link> <span class=md-ellipsis> 25.Python操作Docker </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/26.docker-compose-devops/ class=md-nav__link> <span class=md-ellipsis> 26.docker-compose-devops </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/27.DevOps%E4%B8%8B%E7%9A%84Shell%E8%84%9A%E6%9C%AC/ class=md-nav__link> <span class=md-ellipsis> 27.DevOps下的Shell脚本 </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/28.Devops%E4%B8%8B%E7%9A%84Python%E8%84%9A%E6%9C%AC/ class=md-nav__link> <span class=md-ellipsis> 28.Devops下的Python脚本 </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/29.Vagrant%E8%99%9A%E6%8B%9F%E6%9C%BA/ class=md-nav__link> <span class=md-ellipsis> 29.Vagrant虚拟机 </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/30.VMware-workstation/ class=md-nav__link> <span class=md-ellipsis> 30.VMware Workstation </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/31.VirtualBox/ class=md-nav__link> <span class=md-ellipsis> 31.VirtualBox </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/32.Devops%E7%9B%B8%E5%85%B3%E5%AD%98%E5%82%A8%E5%BA%93/ class=md-nav__link> <span class=md-ellipsis> 32.Devops相关存储库 </span> </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/33.terraform%E6%A6%82%E8%BF%B0/ class=md-nav__link> <span class=md-ellipsis> 33.terraform概述 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Golang </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Golang </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_1> <label class=md-nav__link for=__nav_6_1 id=__nav_6_1_label tabindex=0> <span class=md-ellipsis> 0.学习线路 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_1_label aria-expanded=false> <label class=md-nav__title for=__nav_6_1> <span class="md-nav__icon md-icon"></span> 0.学习线路 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Go-Web%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/ class=md-nav__link> <span class=md-ellipsis> Go Web开发实战 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_2> <label class=md-nav__link for=__nav_6_2 id=__nav_6_2_label tabindex=0> <span class=md-ellipsis> 1.Go基础 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_2_label aria-expanded=false> <label class=md-nav__title for=__nav_6_2> <span class="md-nav__icon md-icon"></span> 1.Go基础 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/1.Go%E5%9F%BA%E7%A1%80/1.%E5%AE%89%E8%A3%85Go/ class=md-nav__link> <span class=md-ellipsis> 安装 Go </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/1.Go%E5%9F%BA%E7%A1%80/2.%E7%AC%AC%E4%B8%80%E4%B8%AAGo%E7%A8%8B%E5%BA%8F/ class=md-nav__link> <span class=md-ellipsis> 第一个Go程序 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/1.Go%E5%9F%BA%E7%A1%80/3.Go%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/ class=md-nav__link> <span class=md-ellipsis> Go 基础语法 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/1.Go%E5%9F%BA%E7%A1%80/4.Go-Module/ class=md-nav__link> <span class=md-ellipsis> Go Module </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/1.Go%E5%9F%BA%E7%A1%80/5.Go-%E6%A0%87%E5%87%86%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84/ class=md-nav__link> <span class=md-ellipsis> Go 标准目录结构 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_3> <label class=md-nav__link for=__nav_6_3 id=__nav_6_3_label tabindex=0> <span class=md-ellipsis> 2.Go-Web基础 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_3_label aria-expanded=false> <label class=md-nav__title for=__nav_6_3> <span class="md-nav__icon md-icon"></span> 2.Go-Web基础 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/2.Go-Web%E5%9F%BA%E7%A1%80/5.%E7%AC%AC%E4%B8%80%E4%B8%AAGo-Web%E7%A8%8B%E5%BA%8F/ class=md-nav__link> <span class=md-ellipsis> 第一个Go Web程序 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/2.Go-Web%E5%9F%BA%E7%A1%80/6.Web%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86%E7%AE%80%E4%BB%8B/ class=md-nav__link> <span class=md-ellipsis> Web程序运行原理简介 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/2.Go-Web%E5%9F%BA%E7%A1%80/7.net-http%E5%8C%85/ class=md-nav__link> <span class=md-ellipsis> net/http包 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/2.Go-Web%E5%9F%BA%E7%A1%80/8.html-template%E5%8C%85/ class=md-nav__link> <span class=md-ellipsis> html/template包 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_4> <label class=md-nav__link for=__nav_6_4 id=__nav_6_4_label tabindex=0> <span class=md-ellipsis> 3.Go-Web请求处理 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_4_label aria-expanded=false> <label class=md-nav__title for=__nav_6_4> <span class="md-nav__icon md-icon"></span> 3.Go-Web请求处理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/3.Go-Web%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86/9.%E7%AE%80%E5%8D%95Web%E6%9C%8D%E5%8A%A1%E5%99%A8/ class=md-nav__link> <span class=md-ellipsis> 简单Web服务器 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/3.Go-Web%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86/10.%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82/ class=md-nav__link> <span class=md-ellipsis> 处理请求 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/3.Go-Web%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86/11.session%E5%92%8Ccookie/ class=md-nav__link> <span class=md-ellipsis> session和cookie </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_5> <label class=md-nav__link for=__nav_6_5 id=__nav_6_5_label tabindex=0> <span class=md-ellipsis> 4.Go访问数据库 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_5_label aria-expanded=false> <label class=md-nav__title for=__nav_6_5> <span class="md-nav__icon md-icon"></span> 4.Go访问数据库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/4.Go%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93/12.Go%E6%93%8D%E4%BD%9CMySQL/ class=md-nav__link> <span class=md-ellipsis> Go操作MySQL </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/4.Go%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93/13.Go%E6%93%8D%E4%BD%9CRedis/ class=md-nav__link> <span class=md-ellipsis> Go操作Redis </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/4.Go%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93/14.Go%E6%93%8D%E4%BD%9CMongoDB/ class=md-nav__link> <span class=md-ellipsis> Go操作MongoDB </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/4.Go%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93/15.Go%E7%9A%84%E5%B8%B8%E8%A7%81ORM%E5%BA%93/ class=md-nav__link> <span class=md-ellipsis> Go的常见ORM库 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/4.Go%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93/16.Go%E6%93%8D%E4%BD%9CSQLite/ class=md-nav__link> <span class=md-ellipsis> Go操作SQLite </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_6> <label class=md-nav__link for=__nav_6_6 id=__nav_6_6_label tabindex=0> <span class=md-ellipsis> 5.Go高级网络编程 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6_6> <span class="md-nav__icon md-icon"></span> 5.Go高级网络编程 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/5.Go%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/17.Go-Socket%E7%BC%96%E7%A8%8B/ class=md-nav__link> <span class=md-ellipsis> Go Socket编程 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/5.Go%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/18.Go-RPC%E7%BC%96%E7%A8%8B/ class=md-nav__link> <span class=md-ellipsis> Go RPC编程 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/5.Go%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/19.Go-%E5%BE%AE%E6%9C%8D%E5%8A%A1/ class=md-nav__link> <span class=md-ellipsis> Go 微服务 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_7> <label class=md-nav__link for=__nav_6_7 id=__nav_6_7_label tabindex=0> <span class=md-ellipsis> 6.Go文件处理 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_7_label aria-expanded=false> <label class=md-nav__title for=__nav_6_7> <span class="md-nav__icon md-icon"></span> 6.Go文件处理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/20.%E5%A4%84%E7%90%86%E7%9B%AE%E5%BD%95%E4%B8%8E%E6%96%87%E4%BB%B6/ class=md-nav__link> <span class=md-ellipsis> 处理目录与文件 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/21.%E5%A4%84%E7%90%86XML%E6%96%87%E4%BB%B6/ class=md-nav__link> <span class=md-ellipsis> 处理XML文件 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/22.%E5%A4%84%E7%90%86JSON%E6%96%87%E4%BB%B6/ class=md-nav__link> <span class=md-ellipsis> 处理JSON文件 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/23.%E5%A4%84%E7%90%86CSV%E6%96%87%E4%BB%B6/ class=md-nav__link> <span class=md-ellipsis> 处理CSV文件 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/24.%E5%A4%84%E7%90%86Go%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95/ class=md-nav__link> <span class=md-ellipsis> 处理Go日志记录 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/25.%E5%A4%84%E7%90%86%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 处理正则表达式 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/26.%E5%A4%84%E7%90%86Excel%E6%96%87%E4%BB%B6/ class=md-nav__link> <span class=md-ellipsis> 处理Excel文件 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_8> <label class=md-nav__link for=__nav_6_8 id=__nav_6_8_label tabindex=0> <span class=md-ellipsis> 7.Go并发编程 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_8_label aria-expanded=false> <label class=md-nav__title for=__nav_6_8> <span class="md-nav__icon md-icon"></span> 7.Go并发编程 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/26.%E5%B9%B6%E5%8F%91-%E5%B9%B6%E8%A1%8C/ class=md-nav__link> <span class=md-ellipsis> 并发 并行 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/27.%E8%BF%9B%E7%A8%8B-%E7%BA%BF%E7%A8%8B-%E5%8D%8F%E7%A8%8B/ class=md-nav__link> <span class=md-ellipsis> 进程 线程 协程 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/28.Go%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/ class=md-nav__link> <span class=md-ellipsis> Go并发模型 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/29.goroutine%E5%92%8Cchannel/ class=md-nav__link> <span class=md-ellipsis> goroutine和channel </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/30.sync%E5%AE%9E%E7%8E%B0%E5%B9%B6%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> sync实现并发 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/31.Go%E5%B9%B6%E5%8F%91%E7%9A%84Web%E5%BA%94%E7%94%A8/ class=md-nav__link> <span class=md-ellipsis> Go并发的Web应用 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_9> <label class=md-nav__link for=__nav_6_9 id=__nav_6_9_label tabindex=0> <span class=md-ellipsis> 8.Go标准库 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_9_label aria-expanded=false> <label class=md-nav__title for=__nav_6_9> <span class="md-nav__icon md-icon"></span> 8.Go标准库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/32.time/ class=md-nav__link> <span class=md-ellipsis> time </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/33.strings/ class=md-nav__link> <span class=md-ellipsis> strings </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/34.bytes/ class=md-nav__link> <span class=md-ellipsis> bytes </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/35.json/ class=md-nav__link> <span class=md-ellipsis> json </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/36.io-bufio/ class=md-nav__link> <span class=md-ellipsis> io/bufio </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/37.fmt/ class=md-nav__link> <span class=md-ellipsis> fmt </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/38.strconv/ class=md-nav__link> <span class=md-ellipsis> strconv </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/39.regexp/ class=md-nav__link> <span class=md-ellipsis> regexp </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/40.log/ class=md-nav__link> <span class=md-ellipsis> log </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/41.reflect-unsafe/ class=md-nav__link> <span class=md-ellipsis> reflect/unsafe </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/42.os-path-filepath/ class=md-nav__link> <span class=md-ellipsis> os/path/filepath </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/43.unicode/ class=md-nav__link> <span class=md-ellipsis> unicode </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/44.flag/ class=md-nav__link> <span class=md-ellipsis> flag </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/45.net-url/ class=md-nav__link> <span class=md-ellipsis> net/url </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/46.net-http/ class=md-nav__link> <span class=md-ellipsis> net/http </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/47.sort/ class=md-nav__link> <span class=md-ellipsis> sort </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/48.errors/ class=md-nav__link> <span class=md-ellipsis> errors </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_10> <label class=md-nav__link for=__nav_6_10 id=__nav_6_10_label tabindex=0> <span class=md-ellipsis> 9.Go三方库 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_10_label aria-expanded=false> <label class=md-nav__title for=__nav_6_10> <span class="md-nav__icon md-icon"></span> 9.Go三方库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/0.%E5%BC%80%E6%BA%90%E8%87%AA%E5%B7%B1%E7%9A%84Go%E5%BA%93/ class=md-nav__link> <span class=md-ellipsis> 开源自己的Go库 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/1.cobra/ class=md-nav__link> <span class=md-ellipsis> Cobra </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/2.viper/ class=md-nav__link> <span class=md-ellipsis> Viper </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/3.Zap/ class=md-nav__link> <span class=md-ellipsis> Zap </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/4.mahonia/ class=md-nav__link> <span class=md-ellipsis> mahonia </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/5.ssh/ class=md-nav__link> <span class=md-ellipsis> ssh </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/6.fsnotify/ class=md-nav__link> <span class=md-ellipsis> fsnotify </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/7.yaml/ class=md-nav__link> <span class=md-ellipsis> yaml </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/8.tail/ class=md-nav__link> <span class=md-ellipsis> tail </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/9.gRPC/ class=md-nav__link> <span class=md-ellipsis> gRPC </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/10.gopsutil/ class=md-nav__link> <span class=md-ellipsis> gopsutil </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/11.go-awesome/ class=md-nav__link> <span class=md-ellipsis> go-awesome </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/12.dmidecode/ class=md-nav__link> <span class=md-ellipsis> dmidecode </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/13.toml/ class=md-nav__link> <span class=md-ellipsis> toml </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_11> <label class=md-nav__link for=__nav_6_11 id=__nav_6_11_label tabindex=0> <span class=md-ellipsis> 10.Go-RESTful-API接口开发 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_11_label aria-expanded=false> <label class=md-nav__title for=__nav_6_11> <span class="md-nav__icon md-icon"></span> 10.Go-RESTful-API接口开发 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/10.Go-RESTful-API%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91/1.%E4%BB%80%E4%B9%88%E6%98%AFRESTful-API/ class=md-nav__link> <span class=md-ellipsis> 1.什么是RESTful-API </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/10.Go-RESTful-API%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91/2.GORMv2/ class=md-nav__link> <span class=md-ellipsis> 2.GORMv2 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/10.Go-RESTful-API%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91/3.Gin%E6%A1%86%E6%9E%B6%E7%9A%84%E4%BD%BF%E7%94%A8/ class=md-nav__link> <span class=md-ellipsis> 3.Gin 框架的使用 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/10.Go-RESTful-API%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91/4.%E5%9B%BE%E4%B9%A6%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F-%E5%89%8D%E7%AB%AF/ class=md-nav__link> <span class=md-ellipsis> 4.图书管理系统-前端 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/10.Go-RESTful-API%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91/5.%E5%9B%BE%E4%B9%A6%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F-%E5%90%8E%E7%AB%AF/ class=md-nav__link> <span class=md-ellipsis> 5.图书管理系统-后端 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/10.Go-RESTful-API%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91/6.Gin%2BVue%E5%85%A5%E9%97%A8%E9%A1%B9%E7%9B%AE/ class=md-nav__link> <span class=md-ellipsis> 6.Gin+Vue入门项目 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_12> <label class=md-nav__link for=__nav_6_12 id=__nav_6_12_label tabindex=0> <span class=md-ellipsis> 11.Web前端 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_12_label aria-expanded=false> <label class=md-nav__title for=__nav_6_12> <span class="md-nav__icon md-icon"></span> 11.Web前端 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/11.Web%E5%89%8D%E7%AB%AF/1.HTML%E6%A0%87%E8%AE%B0%E8%AF%AD%E8%A8%80/ class=md-nav__link> <span class=md-ellipsis> 1.HTML标记语言 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/11.Web%E5%89%8D%E7%AB%AF/2.CSS%E6%A0%B7%E5%BC%8F%E8%AF%AD%E8%A8%80/ class=md-nav__link> <span class=md-ellipsis> 2.CSS样式语言 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/11.Web%E5%89%8D%E7%AB%AF/3.JavaScript%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80/ class=md-nav__link> <span class=md-ellipsis> 3.JavaScript客户端脚本语言 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/11.Web%E5%89%8D%E7%AB%AF/4.JavaScript%E5%BA%93-JQuery/ class=md-nav__link> <span class=md-ellipsis> 4.JavaScript库:JQuery </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_13> <label class=md-nav__link for=__nav_6_13 id=__nav_6_13_label tabindex=0> <span class=md-ellipsis> 12.Vue前端开发 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_13_label aria-expanded=false> <label class=md-nav__title for=__nav_6_13> <span class="md-nav__icon md-icon"></span> 12.Vue前端开发 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/12.Vue%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/1.%E8%AE%A4%E8%AF%86Vue.js/ class=md-nav__link> <span class=md-ellipsis> 1.认识Vue.js.md </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/12.Vue%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/2.Vue%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/ class=md-nav__link> <span class=md-ellipsis> 2.Vue常用指令 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/12.Vue%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/3.Vue%E5%B8%B8%E7%94%A8%E5%B1%9E%E6%80%A7/ class=md-nav__link> <span class=md-ellipsis> 3.Vue常用属性 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/12.Vue%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/4.Vue%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4%E4%B9%8B%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/ class=md-nav__link> <span class=md-ellipsis> 4.Vue常用指令之流程控制 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/12.Vue%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/5.Vue%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4%E4%B9%8B%E6%95%B0%E6%8D%AE%E5%8F%8C%E5%90%91%E7%BB%91%E5%AE%9A/ class=md-nav__link> <span class=md-ellipsis> 5.Vue常用指令之数据双向绑定 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/12.Vue%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/6.Vue%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E9%92%A9%E5%AD%90/ class=md-nav__link> <span class=md-ellipsis> 6.Vue生命周期钩子 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/12.Vue%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/7.VueCli%E8%84%9A%E6%89%8B%E6%9E%B6/ class=md-nav__link> <span class=md-ellipsis> 7.VueCli脚手架 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/12.Vue%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/8.Vue%E7%BB%84%E4%BB%B6/ class=md-nav__link> <span class=md-ellipsis> 8.Vue组件 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/12.Vue%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/9.Vue%E8%B7%AF%E7%94%B1/ class=md-nav__link> <span class=md-ellipsis> 9.Vue路由 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/12.Vue%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/10.Vuex%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 10.Vuex状态管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/12.Vue%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/11.%E5%89%8D%E5%90%8E%E7%AB%AF%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92-Axios/ class=md-nav__link> <span class=md-ellipsis> 11.前后端数据交互 Axios </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/12.Vue%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/12.Element-Plus/ class=md-nav__link> <span class=md-ellipsis> 12.Element Plus </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_14> <label class=md-nav__link for=__nav_6_14 id=__nav_6_14_label tabindex=0> <span class=md-ellipsis> 13.K8s管理系统项目实战 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_14_label aria-expanded=false> <label class=md-nav__title for=__nav_6_14> <span class="md-nav__icon md-icon"></span> 13.K8s管理系统项目实战 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/13.K8s%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/1.K8s%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F-%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> K8s 管理系统-后端开发 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/13.K8s%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/2.K8s%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F-%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> K8s管理系统-前端开发 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_15> <label class=md-nav__link for=__nav_6_15 id=__nav_6_15_label tabindex=0> <span class=md-ellipsis> 14.Go开发的三方平台 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_15_label aria-expanded=false> <label class=md-nav__title for=__nav_6_15> <span class="md-nav__icon md-icon"></span> 14.Go开发的三方平台 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/14.Go%E5%BC%80%E5%8F%91%E7%9A%84%E4%B8%89%E6%96%B9%E5%B9%B3%E5%8F%B0/0.%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8Go%E5%81%9A%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> 为什么使用Go做后端开发 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/14.Go%E5%BC%80%E5%8F%91%E7%9A%84%E4%B8%89%E6%96%B9%E5%B9%B3%E5%8F%B0/1.TBak-System%E5%A4%87%E4%BB%BD%E5%B9%B3%E5%8F%B0/ class=md-nav__link> <span class=md-ellipsis> TBak System备份平台 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/14.Go%E5%BC%80%E5%8F%91%E7%9A%84%E4%B8%89%E6%96%B9%E5%B9%B3%E5%8F%B0/2.kubernetes%E5%AE%B9%E5%99%A8%E4%BA%91%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/ class=md-nav__link> <span class=md-ellipsis> kubernetes容器云管理平台 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/14.Go%E5%BC%80%E5%8F%91%E7%9A%84%E4%B8%89%E6%96%B9%E5%B9%B3%E5%8F%B0/3.Go%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7/ class=md-nav__link> <span class=md-ellipsis> Go命令行工具 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/14.Go%E5%BC%80%E5%8F%91%E7%9A%84%E4%B8%89%E6%96%B9%E5%B9%B3%E5%8F%B0/4.%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/ class=md-nav__link> <span class=md-ellipsis> nps </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/14.Go%E5%BC%80%E5%8F%91%E7%9A%84%E4%B8%89%E6%96%B9%E5%B9%B3%E5%8F%B0/5.go-web%E9%A1%B9%E7%9B%AE/ class=md-nav__link> <span class=md-ellipsis> go-web项目 </span> </a> </li> <li class=md-nav__item> <a href=../../../Golang/14.Go%E5%BC%80%E5%8F%91%E7%9A%84%E4%B8%89%E6%96%B9%E5%B9%B3%E5%8F%B0/6.go-%E4%B8%89%E6%96%B9%E5%B7%A5%E5%85%B7%E7%AE%80%E5%8D%95%E5%85%A5%E9%97%A8/ class=md-nav__link> <span class=md-ellipsis> go-三方工具简单入门 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_16> <label class=md-nav__link for=__nav_6_16 id=__nav_6_16_label tabindex=0> <span class=md-ellipsis> 15.容器化Go </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_16_label aria-expanded=false> <label class=md-nav__title for=__nav_6_16> <span class="md-nav__icon md-icon"></span> 15.容器化Go </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/15.%E5%AE%B9%E5%99%A8%E5%8C%96Go/0.%E6%9E%84%E5%BB%BAGo%E5%BA%94%E7%94%A8docker%E9%95%9C%E5%83%8F/ class=md-nav__link> <span class=md-ellipsis> 构建Go应用docker镜像 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Python </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_1> <label class=md-nav__link for=__nav_7_1 id=__nav_7_1_label tabindex=0> <span class=md-ellipsis> 0.学习线路 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_1_label aria-expanded=false> <label class=md-nav__title for=__nav_7_1> <span class="md-nav__icon md-icon"></span> 0.学习线路 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Pythjon-auto-ops/ class=md-nav__link> <span class=md-ellipsis> Python Linux管理与自动化运维 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_2> <label class=md-nav__link for=__nav_7_2 id=__nav_7_2_label tabindex=0> <span class=md-ellipsis> 1.Python基础篇 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_2_label aria-expanded=false> <label class=md-nav__title for=__nav_7_2> <span class="md-nav__icon md-icon"></span> 1.Python基础篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/1.Python%E7%94%9F%E6%80%81%E5%B7%A5%E5%85%B7/ class=md-nav__link> <span class=md-ellipsis> 1.Python 生态工具 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/2.Python%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E5%AE%89%E8%A3%85/ class=md-nav__link> <span class=md-ellipsis> 2.Python 第三方库安装 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/3.Python%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83%E7%AE%A1%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 3.Python 工作环境管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/4.Python%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/ class=md-nav__link> <span class=md-ellipsis> 4.Python 开发环境 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/5.Python%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/ class=md-nav__link> <span class=md-ellipsis> 5.Python 数据结构 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/6.Python%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84/ class=md-nav__link> <span class=md-ellipsis> 6.Python 项目的组织结构 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/7.Python%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/ class=md-nav__link> <span class=md-ellipsis> 7.Python 代码规范 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/8.Python%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/ class=md-nav__link> <span class=md-ellipsis> 8.Python 基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/9.Python%E5%AD%97%E7%AC%A6%E4%B8%B2/ class=md-nav__link> <span class=md-ellipsis> 9.Python 字符串 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/10.Python%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/ class=md-nav__link> <span class=md-ellipsis> 10.Python 数据类型 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/11.Python%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C/ class=md-nav__link> <span class=md-ellipsis> 11.Python 文件操作 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/12.Python%E5%87%BD%E6%95%B0/ class=md-nav__link> <span class=md-ellipsis> 12.Python 函数 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/13.Python%E5%B8%B8%E7%94%A8%E5%86%85%E5%BB%BA%E5%87%BD%E6%95%B0/ class=md-nav__link> <span class=md-ellipsis> 13.Python 常用内建函数 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/14.Python%E7%B1%BB/ class=md-nav__link> <span class=md-ellipsis> 14.Python 类 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/15.Python%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 15.Python 异常处理 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/16.Python%E6%A8%A1%E5%9D%97%E4%B8%8E%E5%8C%85/ class=md-nav__link> <span class=md-ellipsis> 16.Python 模块与包 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/17.Python%E6%A0%87%E5%87%86%E5%BA%93/ class=md-nav__link> <span class=md-ellipsis> 17.Python 标准库 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/18.Python%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 18.Python 正则表达式 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/19.Python%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%96%E7%A8%8B/ class=md-nav__link> <span class=md-ellipsis> 19.Python 数据库编程 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/20.Python%E6%89%B9%E9%87%8F%E7%AE%A1%E7%90%86%E4%B8%BB%E6%9C%BA/ class=md-nav__link> <span class=md-ellipsis> 20.Python 批量管理主机 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/1.Python%E5%9F%BA%E7%A1%80%E7%AF%87/21.Python%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%8D%8F%E7%A8%8B/ class=md-nav__link> <span class=md-ellipsis> 21.Python 多线程多进程协程 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_3> <label class=md-nav__link for=__nav_7_3 id=__nav_7_3_label tabindex=0> <span class=md-ellipsis> 2.Python运维开发 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_3_label aria-expanded=false> <label class=md-nav__title for=__nav_7_3> <span class="md-nav__icon md-icon"></span> 2.Python运维开发 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python/2.Python%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/1.%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7/ class=md-nav__link> <span class=md-ellipsis> 1.命令行工具 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/2.Python%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/2.%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 2.文本处理 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/2.Python%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/3.Linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 3.Linux 系统管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/2.Python%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/4.%E7%9B%91%E6%8E%A7Linux/ class=md-nav__link> <span class=md-ellipsis> 4.监控 Linux </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/2.Python%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/5.%E6%96%87%E6%A1%A3%E4%B8%8E%E6%8A%A5%E5%91%8A/ class=md-nav__link> <span class=md-ellipsis> 5.文档与报告 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/2.Python%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/6.%E7%BD%91%E7%BB%9C/ class=md-nav__link> <span class=md-ellipsis> 6.网络 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/2.Python%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/7.%E8%87%AA%E5%8A%A8%E5%8C%96%E7%AE%A1%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 7.自动化管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/2.Python%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/8.%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97/ class=md-nav__link> <span class=md-ellipsis> 8.常用模块 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/2.Python%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/9.Python%E6%89%93%E9%80%A0MySQL%E4%B8%93%E5%AE%B6%E7%B3%BB%E7%BB%9F/ class=md-nav__link> <span class=md-ellipsis> 9.Python打造MySQL专家系统 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/2.Python%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/10.%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%BC%80%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> 10.自动化运维系统的开发 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/2.Python%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/11.%E5%8D%8E%E4%B8%BA%E4%BA%91Python%E6%BC%94%E7%A4%BA%E4%BB%A3%E7%A0%81/ class=md-nav__link> <span class=md-ellipsis> 11.华为云Python演示代码 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/2.Python%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/12.%E5%8D%8E%E4%B8%BA%E4%BA%91Go%E6%BC%94%E7%A4%BA%E4%BB%A3%E7%A0%81/ class=md-nav__link> <span class=md-ellipsis> 12.华为云Go演示代码 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/2.Python%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E9%99%84-%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/ class=md-nav__link> <span class=md-ellipsis> 附-运维相关开源项目 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/2.Python%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E9%99%84-awesome-python-cn/ class=md-nav__link> <span class=md-ellipsis> 附-awesome-python-cn </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/2.Python%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E9%99%84-CMDB/ class=md-nav__link> <span class=md-ellipsis> 附-CMDB </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/2.Python%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E9%99%84-Django-web%E5%BC%80%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> 附-Django-web开发 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_4> <label class=md-nav__link for=__nav_7_4 id=__nav_7_4_label tabindex=0> <span class=md-ellipsis> 3.Python测试开发 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_4_label aria-expanded=false> <label class=md-nav__title for=__nav_7_4> <span class="md-nav__icon md-icon"></span> 3.Python测试开发 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python/3.Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91/1.Python2%E4%B8%8EPython3%E5%8C%BA%E5%88%AB/ class=md-nav__link> <span class=md-ellipsis> 1.Python2 与 Python3 区别 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/3.Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91/2.Windows%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Python/ class=md-nav__link> <span class=md-ellipsis> 2.Windows环境安装Python </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/3.Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91/3.Linux%E5%A4%9A%E7%89%88%E6%9C%ACPython%E5%AE%89%E8%A3%85/ class=md-nav__link> <span class=md-ellipsis> 3.Linux多版本Python安装 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/3.Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91/4.Python%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/ class=md-nav__link> <span class=md-ellipsis> 4.Python虚拟环境安装 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/3.Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91/5.Pycharm%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/ class=md-nav__link> <span class=md-ellipsis> 5.Pycharm安装与使用 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/3.Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91/6.Python%E9%97%B4%E6%8E%A5%E5%AE%9A%E4%B9%89%E5%B8%B8%E9%87%8F/ class=md-nav__link> <span class=md-ellipsis> 6.Python间接定义常量 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/3.Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91/7.Python%E8%BF%90%E7%AE%97%E7%AC%A6%E4%B8%8E%E8%A1%A8%E8%BE%BE%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 7.Python运算符与表达式 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/3.Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91/8.%E9%80%BB%E8%BE%91%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5/ class=md-nav__link> <span class=md-ellipsis> 8.逻辑控制语句 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/3.Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91/9.%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BB%8B%E7%BB%8D/ class=md-nav__link> <span class=md-ellipsis> 9.数据结构 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/3.Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91/10.%E5%87%BD%E6%95%B0%E4%BB%8B%E7%BB%8D/ class=md-nav__link> <span class=md-ellipsis> 10.函数介绍 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/3.Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91/11.%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/ class=md-nav__link> <span class=md-ellipsis> 11.类与对象 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/3.Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91/12.%E6%89%93%E5%8C%85%E4%B8%8E%E5%8F%91%E5%B8%83/ class=md-nav__link> <span class=md-ellipsis> 12.打包与发布 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/3.Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91/13.%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7%E4%B8%8E%E5%A4%84%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 13.异常捕获与处理 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/3.Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91/14.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/ class=md-nav__link> <span class=md-ellipsis> 14.并发编程 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/3.Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91/15.%E6%A0%87%E5%87%86%E5%BA%93%E5%92%8C%E4%B8%89%E6%96%B9%E5%BA%93/ class=md-nav__link> <span class=md-ellipsis> 15.标准库和三方库 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/3.Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91/16.vue-cli%E8%84%9A%E6%89%8B%E6%9E%B6/ class=md-nav__link> <span class=md-ellipsis> 16.vue-cli脚手架 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/3.Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91/17.%E6%A1%88%E4%BE%8B%E5%AE%9E%E8%B7%B5-%E4%BB%BB%E5%8A%A1%E5%88%97%E8%A1%A8/ class=md-nav__link> <span class=md-ellipsis> 17.案例实践-任务列表 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_5> <label class=md-nav__link for=__nav_7_5 id=__nav_7_5_label tabindex=0> <span class=md-ellipsis> 4.Flask-Web全栈开发 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_5_label aria-expanded=false> <label class=md-nav__title for=__nav_7_5> <span class="md-nav__icon md-icon"></span> 4.Flask-Web全栈开发 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/1.Flask%E5%89%8D%E5%A5%8F/ class=md-nav__link> <span class=md-ellipsis> 1.Flask 前缀 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/2.%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE/ class=md-nav__link> <span class=md-ellipsis> 2.项目配置 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/3.URL%E4%B8%8E%E8%A7%86%E5%9B%BE/ class=md-nav__link> <span class=md-ellipsis> 3.URL与视图 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/4.Jinja2%E6%A8%A1%E6%9D%BF/ class=md-nav__link> <span class=md-ellipsis> 4.Jinja2模板 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/5.%E6%95%B0%E6%8D%AE%E5%BA%93/ class=md-nav__link> <span class=md-ellipsis> 5.数据库 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/6.%E8%A1%A8%E5%8D%95/ class=md-nav__link> <span class=md-ellipsis> 6.表单 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/7.Flask%E8%BF%9B%E9%98%B6/ class=md-nav__link> <span class=md-ellipsis> 7.Flask进阶 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/8.%E7%BC%93%E5%AD%98%E7%B3%BB%E7%BB%9F/ class=md-nav__link> <span class=md-ellipsis> 8.缓存系统 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/9.Flask%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/ class=md-nav__link> <span class=md-ellipsis> 9.Flask 项目实战 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/10.WebSock%E5%AE%9E%E6%88%98/ class=md-nav__link> <span class=md-ellipsis> 10.WebSock实战 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/11.Flask%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/ class=md-nav__link> <span class=md-ellipsis> 11.Flask异步编程 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/%E9%99%84-%E4%BD%BF%E7%94%A8Pytest%E6%B5%8B%E8%AF%95Flask/ class=md-nav__link> <span class=md-ellipsis> 附-使用 Pytest 测试 Flask </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/%E9%99%84-%E5%9B%BE%E4%B9%A6%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/ class=md-nav__link> <span class=md-ellipsis> 附-图书管理系统 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/%E9%99%84-Flask%E5%B8%B8%E7%94%A8%E6%89%A9%E5%B1%95/ class=md-nav__link> <span class=md-ellipsis> 附-Flask常用扩展 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/%E9%99%84-Flask%E5%92%8CRedis%E9%98%9F%E5%88%97%E7%9A%84%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/ class=md-nav__link> <span class=md-ellipsis> 附-Flask和Redis队列的异步任务 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/%E9%99%84-Flask%E5%92%8CVue.js%E5%BC%80%E5%8F%91%E5%8D%95%E9%A1%B5%E5%BA%94%E7%94%A8/ class=md-nav__link> <span class=md-ellipsis> 附-Flask 和 Vue.js 开发单页应用 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/%E9%99%84-Flask%E5%AE%B9%E5%99%A8%E5%8C%96%E5%AE%9E%E8%B7%B5/ class=md-nav__link> <span class=md-ellipsis> 附-Flask容器化实践 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/4.Flask-Web%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/%E9%99%84-Flask%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B/ class=md-nav__link> <span class=md-ellipsis> 附-Flask数据模型 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_6> <label class=md-nav__link for=__nav_7_6 id=__nav_7_6_label tabindex=0> <span class=md-ellipsis> 5.DevOps和自动化运维实践 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_6_label aria-expanded=false> <label class=md-nav__title for=__nav_7_6> <span class="md-nav__icon md-icon"></span> 5.DevOps和自动化运维实践 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python/5.DevOps%E5%92%8C%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%AE%9E%E8%B7%B5/1.Devops%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E7%9A%84%E6%84%8F%E4%B9%89/ class=md-nav__link> <span class=md-ellipsis> 1.Devops 与自动化运维的意义 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/5.DevOps%E5%92%8C%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%AE%9E%E8%B7%B5/2.Shell%E8%84%9A%E6%9C%AC%E5%9C%A8Devops%E4%B8%8B%E7%9A%84%E5%BA%94%E7%94%A8/ class=md-nav__link> <span class=md-ellipsis> 2.Shell脚本在Devops下的应用 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/5.DevOps%E5%92%8C%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%AE%9E%E8%B7%B5/3.%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84Shell%E8%84%9A%E6%9C%AC/ class=md-nav__link> <span class=md-ellipsis> 3.生产环境下的 Shell 脚本 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/5.DevOps%E5%92%8C%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%AE%9E%E8%B7%B5/4.%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84Python%E8%84%9A%E6%9C%AC%E5%88%86%E4%BA%AB/ class=md-nav__link> <span class=md-ellipsis> 4.工作中的 Python 脚本分享 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_7> <label class=md-nav__link for=__nav_7_7 id=__nav_7_7_label tabindex=0> <span class=md-ellipsis> 6.CMDB项目实战 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7_7> <span class="md-nav__icon md-icon"></span> 6.CMDB项目实战 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python/6.CMDB%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/0.DRF%E5%89%8D%E5%A5%8F/ class=md-nav__link> <span class=md-ellipsis> 0.DRF前奏 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/6.CMDB%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/1.DRF%E5%85%A5%E9%97%A8/ class=md-nav__link> <span class=md-ellipsis> 1.DRF入门 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/6.CMDB%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/2.DRF%E8%BF%9B%E9%98%B6/ class=md-nav__link> <span class=md-ellipsis> 2.DRF进阶 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/6.CMDB%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/3.CMDB%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> 3.CMDB后端开发 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/6.CMDB%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/4.Vue%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91-%E4%B8%8A/ class=md-nav__link> <span class=md-ellipsis> 4.Vue前端开发-上 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/6.CMDB%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/5.Vue%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91-%E4%B8%8B/ class=md-nav__link> <span class=md-ellipsis> 5.Vue前端开发-下 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/6.CMDB%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/6.Element-Plus%E5%89%8D%E7%AB%AF%E7%BB%84%E4%BB%B6%E5%BA%93/ class=md-nav__link> <span class=md-ellipsis> 6.Element-Plus前端组件库 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/6.CMDB%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/7.CMDB%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91-%E4%B8%8A/ class=md-nav__link> <span class=md-ellipsis> 7.CMDB前端开发-上 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/6.CMDB%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/8.CMDB%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91-%E4%B8%8B/ class=md-nav__link> <span class=md-ellipsis> 8.CMDB前端开发-下 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_8> <label class=md-nav__link for=__nav_7_8 id=__nav_7_8_label tabindex=0> <span class=md-ellipsis> 7.Python网络编程攻略 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_8_label aria-expanded=false> <label class=md-nav__title for=__nav_7_8> <span class="md-nav__icon md-icon"></span> 7.Python网络编程攻略 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python/7.Python%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E6%94%BB%E7%95%A5/1.IPv4%E5%92%8C%E7%AE%80%E5%8D%95%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B/ class=md-nav__link> <span class=md-ellipsis> 1.IPv4 和简单的客户端-服务器编程 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/7.Python%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E6%94%BB%E7%95%A5/2.%E4%BD%BF%E7%94%A8%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E5%A5%97%E6%8E%A5%E5%AD%97-IO%E6%8F%90%E5%8D%87%E6%80%A7%E8%83%BD/ class=md-nav__link> <span class=md-ellipsis> 2.使用多路复用套接字-IO 提升性能 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/7.Python%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E6%94%BB%E7%95%A5/3.IPv6-Unix%E5%9F%9F%E5%A5%97%E6%8E%A5%E5%AD%97%E5%92%8C%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3/ class=md-nav__link> <span class=md-ellipsis> 3.IPv6-Unix 域套接字和网络接口 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_9> <label class=md-nav__link for=__nav_7_9 id=__nav_7_9_label tabindex=0> <span class=md-ellipsis> 8.Python自动化运维实战 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_9_label aria-expanded=false> <label class=md-nav__title for=__nav_7_9> <span class="md-nav__icon md-icon"></span> 8.Python自动化运维实战 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python/8.Python%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%AE%9E%E6%88%98/1.%E6%90%AD%E5%BB%BAPython%E7%8E%AF%E5%A2%83/ class=md-nav__link> <span class=md-ellipsis> 1.搭建 Python 环境 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/8.Python%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%AE%9E%E6%88%98/2.%E5%B8%B8%E7%94%A8%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BA%93/ class=md-nav__link> <span class=md-ellipsis> 2.常用的自动化库 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/8.Python%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%AE%9E%E6%88%98/3.%E6%90%AD%E5%BB%BA%E7%BD%91%E7%BB%9C%E5%AE%9E%E9%AA%8C%E5%AE%A4%E7%8E%AF%E5%A2%83/ class=md-nav__link> <span class=md-ellipsis> 3.搭建网络实验室环境 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python/8.Python%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%AE%9E%E6%88%98/5.%E4%BB%8E%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E4%B8%AD%E6%8F%90%E5%8F%96%E6%95%B0%E6%8D%AE/ class=md-nav__link> <span class=md-ellipsis> 5.从网络设备中提取数据 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex=0> <span class=md-ellipsis> Openstack </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Openstack </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8_1> <label class=md-nav__link for=__nav_8_1 id=__nav_8_1_label tabindex=0> <span class=md-ellipsis> 0.学习线路 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_8_1_label aria-expanded=false> <label class=md-nav__title for=__nav_8_1> <span class="md-nav__icon md-icon"></span> 0.学习线路 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Openstack/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.OpenStack/ class=md-nav__link> <span class=md-ellipsis> 基于 OpenStack 组件开发 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8_2> <label class=md-nav__link for=__nav_8_2 id=__nav_8_2_label tabindex=0> <span class=md-ellipsis> 1.OpenStack工程师工作 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_8_2_label aria-expanded=false> <label class=md-nav__title for=__nav_8_2> <span class="md-nav__icon md-icon"></span> 1.OpenStack工程师工作 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Openstack/1.OpenStack%E5%B7%A5%E7%A8%8B%E5%B8%88%E5%B7%A5%E4%BD%9C/1.Horizon%E7%95%8C%E9%9D%A2%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%86%85%E5%AE%B9/ class=md-nav__link> <span class=md-ellipsis> 1.Horizon 界面工程师的工作内容 </span> </a> </li> <li class=md-nav__item> <a href=../../../Openstack/1.OpenStack%E5%B7%A5%E7%A8%8B%E5%B8%88%E5%B7%A5%E4%BD%9C/2.Neutron%E7%BD%91%E7%BB%9C%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%86%85%E5%AE%B9/ class=md-nav__link> <span class=md-ellipsis> 2.Neutron 网络工程师的工作内容 </span> </a> </li> <li class=md-nav__item> <a href=../../../Openstack/1.OpenStack%E5%B7%A5%E7%A8%8B%E5%B8%88%E5%B7%A5%E4%BD%9C/3.Nova%E8%B5%84%E6%B7%B1%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%86%85%E5%AE%B9/ class=md-nav__link> <span class=md-ellipsis> 3.Nova 资深工程师的工作内容 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8_3> <label class=md-nav__link for=__nav_8_3 id=__nav_8_3_label tabindex=0> <span class=md-ellipsis> 2.开发环境的搭建 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_8_3_label aria-expanded=false> <label class=md-nav__title for=__nav_8_3> <span class="md-nav__icon md-icon"></span> 2.开发环境的搭建 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Openstack/2.%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E7%9A%84%E6%90%AD%E5%BB%BA/1.Windows%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E7%9A%84%E6%90%AD%E5%BB%BA/ class=md-nav__link> <span class=md-ellipsis> 1.Windows 开发环境的搭建 </span> </a> </li> <li class=md-nav__item> <a href=../../../Openstack/2.%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E7%9A%84%E6%90%AD%E5%BB%BA/2.Linux%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E7%9A%84%E6%90%AD%E5%BB%BA/ class=md-nav__link> <span class=md-ellipsis> 2.Linux 开发环境的搭建 </span> </a> </li> <li class=md-nav__item> <a href=../../../Openstack/2.%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E7%9A%84%E6%90%AD%E5%BB%BA/3.Launchpad%E8%B4%A6%E5%8F%B7/ class=md-nav__link> <span class=md-ellipsis> 3.Launchpad 账号 </span> </a> </li> <li class=md-nav__item> <a href=../../../Openstack/2.%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E7%9A%84%E6%90%AD%E5%BB%BA/4.Git%E7%9A%84%E4%BD%BF%E7%94%A8/ class=md-nav__link> <span class=md-ellipsis> 4.Git 的使用 </span> </a> </li> <li class=md-nav__item> <a href=../../../Openstack/2.%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E7%9A%84%E6%90%AD%E5%BB%BA/5.OpenStack%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9/ class=md-nav__link> <span class=md-ellipsis> 5.OpenStack配置文件修改 </span> </a> </li> <li class=md-nav__item> <a href=../../../Openstack/2.%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E7%9A%84%E6%90%AD%E5%BB%BA/6.%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> 6.配置文件解析 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8_4> <label class=md-nav__link for=__nav_8_4 id=__nav_8_4_label tabindex=0> <span class=md-ellipsis> 3.Python模块 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_8_4_label aria-expanded=false> <label class=md-nav__title for=__nav_8_4> <span class="md-nav__icon md-icon"></span> 3.Python模块 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Openstack/3.Python%E6%A8%A1%E5%9D%97/0.Python%E5%8C%85%E7%9A%84%E6%9E%84%E5%BB%BA%E4%B8%8E%E5%88%86%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> 0.Python 包的构建与分发 </span> </a> </li> <li class=md-nav__item> <a href=../../../Openstack/3.Python%E6%A8%A1%E5%9D%97/1.SQLAlchemy/ class=md-nav__link> <span class=md-ellipsis> 1.SQLAlchemy </span> </a> </li> <li class=md-nav__item> <a href=../../../Openstack/3.Python%E6%A8%A1%E5%9D%97/2.logging/ class=md-nav__link> <span class=md-ellipsis> 2.logging </span> </a> </li> <li class=md-nav__item> <a href=../../../Openstack/3.Python%E6%A8%A1%E5%9D%97/3.cliff/ class=md-nav__link> <span class=md-ellipsis> 3.cliff </span> </a> </li> <li class=md-nav__item> <a href=../../../Openstack/3.Python%E6%A8%A1%E5%9D%97/4.Eventlet/ class=md-nav__link> <span class=md-ellipsis> 4.Eventlet </span> </a> </li> <li class=md-nav__item> <a href=../../../Openstack/3.Python%E6%A8%A1%E5%9D%97/5.WSGI/ class=md-nav__link> <span class=md-ellipsis> 5.WSGI </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_9> <label class=md-nav__link for=__nav_9 id=__nav_9_label tabindex=0> <span class=md-ellipsis> Python-vs-Go </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_9_label aria-expanded=false> <label class=md-nav__title for=__nav_9> <span class="md-nav__icon md-icon"></span> Python-vs-Go </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_9_1> <label class=md-nav__link for=__nav_9_1 id=__nav_9_1_label tabindex=0> <span class=md-ellipsis> 0.学习线路 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_9_1_label aria-expanded=false> <label class=md-nav__title for=__nav_9_1> <span class="md-nav__icon md-icon"></span> 0.学习线路 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python-vs-Go/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Python-vs-Go/ class=md-nav__link> <span class=md-ellipsis> Python-vs-Go </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_9_2> <label class=md-nav__link for=__nav_9_2 id=__nav_9_2_label tabindex=0> <span class=md-ellipsis> 1.对比 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_9_2_label aria-expanded=false> <label class=md-nav__title for=__nav_9_2> <span class="md-nav__icon md-icon"></span> 1.对比 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/1.Hello-World/ class=md-nav__link> <span class=md-ellipsis> Hello-World </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/2.Print/ class=md-nav__link> <span class=md-ellipsis> Print </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/3.%E6%B3%A8%E9%87%8A/ class=md-nav__link> <span class=md-ellipsis> 注释 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/4.%E5%A4%9A%E8%A1%8C%E5%AD%97%E7%AC%A6%E4%B8%B2/ class=md-nav__link> <span class=md-ellipsis> 多行字符串 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/5.Lists/ class=md-nav__link> <span class=md-ellipsis> Lists </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/6.Map/ class=md-nav__link> <span class=md-ellipsis> Map </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/7.Booleans/ class=md-nav__link> <span class=md-ellipsis> Booleans </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/8.Forloop/ class=md-nav__link> <span class=md-ellipsis> Forloop </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/9.Range/ class=md-nav__link> <span class=md-ellipsis> Range </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/10.Switch/ class=md-nav__link> <span class=md-ellipsis> Switch </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/11.%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0%E5%87%BD%E6%95%B0/ class=md-nav__link> <span class=md-ellipsis> 可变参数函数 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/12.%E6%97%B6%E9%97%B4%E8%AE%A1%E7%AE%97/ class=md-nav__link> <span class=md-ellipsis> 时间计算 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/13.%E5%87%BD%E6%95%B0%E7%9A%84%E9%97%AD%E5%8C%85/ class=md-nav__link> <span class=md-ellipsis> 函数的闭包 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/14.%E9%80%80%E5%87%BA%E5%A4%84%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 退出处理 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/15.%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7/ class=md-nav__link> <span class=md-ellipsis> 异常捕获 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/16.%E5%8F%AF%E5%8F%98%E9%A1%B9/ class=md-nav__link> <span class=md-ellipsis> 可变项 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/17.%E7%B1%BB/ class=md-nav__link> <span class=md-ellipsis> 类 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/18.%E6%96%B9%E6%B3%95/ class=md-nav__link> <span class=md-ellipsis> 方法 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/19.%E5%B9%B6%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> 并发 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/20.Args/ class=md-nav__link> <span class=md-ellipsis> Args </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/21.%E5%AF%BC%E5%85%A5%E6%A8%A1%E5%9D%97%E5%88%AB%E5%90%8D/ class=md-nav__link> <span class=md-ellipsis> 导入模块别名 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/22.%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%A0%BC%E5%BC%8F%E5%8C%96/ class=md-nav__link> <span class=md-ellipsis> 字符串格式化 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/23.%E5%8E%BB%E9%87%8D/ class=md-nav__link> <span class=md-ellipsis> 去重 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/24.%E5%B8%A6%E9%A2%9C%E8%89%B2%E6%89%93%E5%8D%B0/ class=md-nav__link> <span class=md-ellipsis> 带颜色打印 </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/25.python-example/ class=md-nav__link> <span class=md-ellipsis> Python By Example </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94/26.go-example/ class=md-nav__link> <span class=md-ellipsis> Go By Example </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_9_3> <label class=md-nav__link for=__nav_9_3 id=__nav_9_3_label tabindex=0> <span class=md-ellipsis> 2.进阶 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_9_3_label aria-expanded=false> <label class=md-nav__title for=__nav_9_3> <span class="md-nav__icon md-icon"></span> 2.进阶 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python-vs-Go/2.%E8%BF%9B%E9%98%B6/1.%E4%BD%BF%E7%94%A8RPC/ class=md-nav__link> <span class=md-ellipsis> 使用RPC </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/2.%E8%BF%9B%E9%98%B6/2.%E4%BD%BF%E7%94%A8MySQL/ class=md-nav__link> <span class=md-ellipsis> 使用MySQL </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/2.%E8%BF%9B%E9%98%B6/3.%E4%BD%BF%E7%94%A8Redis/ class=md-nav__link> <span class=md-ellipsis> 使用Redis </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/2.%E8%BF%9B%E9%98%B6/4.%E4%BD%BF%E7%94%A8MongoDB/ class=md-nav__link> <span class=md-ellipsis> 使用MongoDB </span> </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/2.%E8%BF%9B%E9%98%B6/5.%E7%BB%83%E6%89%8B%E9%A1%B9%E7%9B%AE%E6%8E%A8%E8%8D%90/ class=md-nav__link> <span class=md-ellipsis> 练手项目推荐 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_10> <label class=md-nav__link for=__nav_10 id=__nav_10_label tabindex=0> <span class=md-ellipsis> Linux </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_10_label aria-expanded=false> <label class=md-nav__title for=__nav_10> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_10_1> <label class=md-nav__link for=__nav_10_1 id=__nav_10_1_label tabindex=0> <span class=md-ellipsis> Shell </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_10_1_label aria-expanded=false> <label class=md-nav__title for=__nav_10_1> <span class="md-nav__icon md-icon"></span> Shell </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Linux/Shell/Shell%E7%AE%80%E4%BB%8B/ class=md-nav__link> <span class=md-ellipsis> Shell 教程概述 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/ class=md-nav__link> <span class=md-ellipsis> 1.第一个 Shell 程序 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/2.Shell%E5%8F%98%E9%87%8F%E5%92%8C%E5%AD%97%E7%AC%A6%E4%B8%B2/ class=md-nav__link> <span class=md-ellipsis> 2.Shell变量和字符串 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/3.Shell%E5%8F%82%E6%95%B0/ class=md-nav__link> <span class=md-ellipsis> 3.Shell参数 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/4.Shell%E6%95%B0%E7%BB%84/ class=md-nav__link> <span class=md-ellipsis> 4.Shell数组 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/ class=md-nav__link> <span class=md-ellipsis> 5.Shell运算符 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/6.Shell-echo_printf%E5%91%BD%E4%BB%A4/ class=md-nav__link> <span class=md-ellipsis> 6.Shell echo/printf 命令 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/7.Shell-test%E5%91%BD%E4%BB%A4/ class=md-nav__link> <span class=md-ellipsis> 7.Shell test命令 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/ class=md-nav__link> <span class=md-ellipsis> 8.Shell流程控制 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/9.Shell%E5%87%BD%E6%95%B0/ class=md-nav__link> <span class=md-ellipsis> 9.Shell函数 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/ class=md-nav__link> <span class=md-ellipsis> 10.Shell输入/输出重定向 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/11.Shell%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 11.Shell正则表达式 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/12.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/ class=md-nav__link> <span class=md-ellipsis> 12.Shell三剑客之grep </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/ class=md-nav__link> <span class=md-ellipsis> 13.Shell三剑客之sed </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/ class=md-nav__link> <span class=md-ellipsis> 14.Shell三剑客之awk </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/15.Shell%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/ class=md-nav__link> <span class=md-ellipsis> 15.Shell常用工具 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/ class=md-nav__link> <span class=md-ellipsis> 16.Shell实战项目 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/17.Shell%E8%84%9A%E6%9C%AC%E7%A4%BA%E4%BE%8B/ class=md-nav__link> <span class=md-ellipsis> 17.Shell脚本示例 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/18.Shell%E8%84%9A%E6%9C%AC%E7%9A%84%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%B7%A5%E5%85%B7/ class=md-nav__link> <span class=md-ellipsis> 18.Shell脚本的参数解析工具 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/19.%E5%AE%9E%E7%94%A8Shell%E8%84%9A%E6%9C%AC%E6%A1%88%E4%BE%8B/ class=md-nav__link> <span class=md-ellipsis> 19.实用 Shell 脚本案例 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/20.Shell%E8%84%9A%E6%9C%AC%E7%9A%84%E8%A7%84%E8%8C%83/ class=md-nav__link> <span class=md-ellipsis> 20.Shell脚本的规范 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/21.Shell%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%B9%B6%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> 21.Shell多进程并发 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/22.Bash_Library/ class=md-nav__link> <span class=md-ellipsis> 22.Bash Library </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/%E9%99%84-shell%E5%85%B6%E5%AE%83%E8%B5%84%E6%BA%90/ class=md-nav__link> <span class=md-ellipsis> 附-shell 其它资源 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Shell/%E9%99%84-vim%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/ class=md-nav__link> <span class=md-ellipsis> 附-vim常用操作 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_10_2> <label class=md-nav__link for=__nav_10_2 id=__nav_10_2_label tabindex=0> <span class=md-ellipsis> Ansible </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_10_2_label aria-expanded=false> <label class=md-nav__title for=__nav_10_2> <span class="md-nav__icon md-icon"></span> Ansible </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Linux/Ansible/1.Ansible%E5%85%A5%E9%97%A8%E5%92%8C%E5%AE%9E%E8%B7%B5/ class=md-nav__link> <span class=md-ellipsis> 1.Ansible 入门和实践 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Ansible/2.Ansible-wiki/ class=md-nav__link> <span class=md-ellipsis> 2.Ansible-wiki </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_10_3> <label class=md-nav__link for=__nav_10_3 id=__nav_10_3_label tabindex=0> <span class=md-ellipsis> Git </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_10_3_label aria-expanded=false> <label class=md-nav__title for=__nav_10_3> <span class="md-nav__icon md-icon"></span> Git </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Linux/Git/1.Git%E5%9F%BA%E7%A1%80/ class=md-nav__link> <span class=md-ellipsis> 1.Git基础 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Git/2.%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93/ class=md-nav__link> <span class=md-ellipsis> 2.远程仓库 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Git/3.%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 3.分支管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Git/4.%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86%E7%AD%96%E7%95%A5/ class=md-nav__link> <span class=md-ellipsis> 4.分支管理策略 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Git/7.%E4%BD%BF%E7%94%A8Github/ class=md-nav__link> <span class=md-ellipsis> 7.使用Github </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Git/8.%E5%AE%9E%E8%B7%B5GitHub-Flow/ class=md-nav__link> <span class=md-ellipsis> 8.实践GitHub Flow </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Git/9.%E5%AE%9E%E8%B7%B5Git-Flow/ class=md-nav__link> <span class=md-ellipsis> 9.实践Git Flow </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Git/10.%E9%A1%B9%E7%9B%AE%E8%A7%84%E8%8C%83/ class=md-nav__link> <span class=md-ellipsis> 10.项目规范 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_10_4> <label class=md-nav__link for=__nav_10_4 id=__nav_10_4_label tabindex=0> <span class=md-ellipsis> KVM </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_10_4_label aria-expanded=false> <label class=md-nav__title for=__nav_10_4> <span class="md-nav__icon md-icon"></span> KVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Linux/KVM/1.kvm%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/ class=md-nav__link> <span class=md-ellipsis> 1.kvm相关命令 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/KVM/2.kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%88%9B%E5%BB%BA/ class=md-nav__link> <span class=md-ellipsis> 2.kvm虚拟机创建 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/KVM/3.kvm%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/ class=md-nav__link> <span class=md-ellipsis> 3.kvm网络配置 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_10_5> <label class=md-nav__link for=__nav_10_5 id=__nav_10_5_label tabindex=0> <span class=md-ellipsis> Nginx </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_10_5_label aria-expanded=false> <label class=md-nav__title for=__nav_10_5> <span class="md-nav__icon md-icon"></span> Nginx </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Linux/Nginx/1.Nginx%E7%AE%80%E4%BB%8B/ class=md-nav__link> <span class=md-ellipsis> 1.Nginx简介 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Nginx/2.Nginx%E5%AE%89%E8%A3%85%E5%8F%8A%E5%90%AF%E5%8A%A8/ class=md-nav__link> <span class=md-ellipsis> 2.Nginx安装及启动 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Nginx/3.Nginx%E9%85%8D%E7%BD%AE/ class=md-nav__link> <span class=md-ellipsis> 3.Nginx配置 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Nginx/4.Nginx%E9%85%8D%E7%BD%AE%E4%B8%8B%E8%BD%BD%E7%AB%99%E7%82%B9/ class=md-nav__link> <span class=md-ellipsis> 4.Nginx配置下载站点 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Nginx/5.Nginx%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/ class=md-nav__link> <span class=md-ellipsis> 5.Nginx访问控制 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Nginx/6.Nginx%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA/ class=md-nav__link> <span class=md-ellipsis> 6.Nginx虚拟主机 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Nginx/7.Nginx%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90/ class=md-nav__link> <span class=md-ellipsis> 7.Nginx静态资源 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Nginx/8.Nginx%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE/ class=md-nav__link> <span class=md-ellipsis> 8.Nginx缓存配置 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Nginx/9.Nginx%E6%AD%A3%E5%8F%8D%E4%BB%A3%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 9.Nginx正反向代理 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Nginx/10.Nginx%E9%98%B2%E7%9B%97%E9%93%BE/ class=md-nav__link> <span class=md-ellipsis> 10.Nginx防盗链 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Nginx/11.Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/ class=md-nav__link> <span class=md-ellipsis> 11.Nginx负载均衡 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Nginx/12.Nginx%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/ class=md-nav__link> <span class=md-ellipsis> 12.Nginx动静分离 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Nginx/13.Nginx%E8%B7%A8%E5%9F%9F%E9%85%8D%E7%BD%AE/ class=md-nav__link> <span class=md-ellipsis> 13.Nginx跨域配置 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Nginx/14.Nginx%E9%87%8D%E5%AE%9A%E5%90%91/ class=md-nav__link> <span class=md-ellipsis> 14.Nginx重定向 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Nginx/15.Nginx-HTTPS/ class=md-nav__link> <span class=md-ellipsis> 15.Nginx HTTPS </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Nginx/16.%E9%99%84-Nginx-location%E8%AF%AD%E6%B3%95/ class=md-nav__link> <span class=md-ellipsis> 16.附-Nginx-location语法 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/Nginx/17.%E9%99%84-Nginx%E4%BB%A3%E7%90%86%E7%9B%B8%E5%85%B3%E6%A8%A1%E5%9D%97%E8%A7%A3%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> 17.附-Nginx代理相关模块解析 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_10_6> <label class=md-nav__link for=__nav_10_6 id=__nav_10_6_label tabindex=0> <span class=md-ellipsis> System </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_10_6_label aria-expanded=false> <label class=md-nav__title for=__nav_10_6> <span class="md-nav__icon md-icon"></span> System </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Linux/System/1.%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F%E5%92%8C%E8%BD%AF%E4%BB%B6%E6%BA%90/ class=md-nav__link> <span class=md-ellipsis> 1.系统镜像和软件源 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/System/2.Linux%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/ class=md-nav__link> <span class=md-ellipsis> 2.Linux安全加固 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/System/3.Systemd/ class=md-nav__link> <span class=md-ellipsis> 3.Systemd </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/System/4.Superivisor/ class=md-nav__link> <span class=md-ellipsis> 4.Superivisor </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/System/5.SSH%E7%99%BB%E5%BD%95Linux%E6%98%BE%E7%A4%BA%E6%A8%AA%E5%B9%85/ class=md-nav__link> <span class=md-ellipsis> 5.SSH登录Linux显示横幅 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/System/6.Linux%E4%B8%AD%E7%AB%AF%E5%8F%A3%E5%8D%A0%E7%94%A8%E6%8E%92%E6%9F%A5/ class=md-nav__link> <span class=md-ellipsis> 6.Linux中端口占用排查 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/System/7.%E4%BD%BF%E7%94%A8curl%E5%8F%91%E9%80%81REST-API%E8%AF%B7%E6%B1%82/ class=md-nav__link> <span class=md-ellipsis> 7.使用curl发送REST API请求 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/System/8.%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%A8%A1%E7%B3%8A%E6%9F%A5%E6%89%BE%E5%99%A8fzf/ class=md-nav__link> <span class=md-ellipsis> 8.命令行模糊查找器fzf </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/System/9.Centos7.9%E7%B3%BB%E7%BB%9F%E7%9B%98%E6%89%A9%E5%AE%B9/ class=md-nav__link> <span class=md-ellipsis> 9.Centos7.9系统盘扩容 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/System/10.Centos%E5%9C%A8%E7%BA%BF-%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96/ class=md-nav__link> <span class=md-ellipsis> 10.Centos在线-离线安装依赖 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/System/11.rsync-ssh/ class=md-nav__link> <span class=md-ellipsis> 11.rsync ssh使用 </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/System/12.%E5%90%84%E5%A4%A7%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%81%9ARAID/ class=md-nav__link> <span class=md-ellipsis> 12.各大服务器做RAID </span> </a> </li> <li class=md-nav__item> <a href=../../../Linux/System/13.Linux%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E4%B8%8E%E8%BF%90%E7%BB%B4%E5%AE%9E%E6%88%98/ class=md-nav__link> <span class=md-ellipsis> 13.Linux 系统架构与运维实战 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_10_7> <label class=md-nav__link for=__nav_10_7 id=__nav_10_7_label tabindex=0> <span class=md-ellipsis> Serveices </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_10_7_label aria-expanded=false> <label class=md-nav__title for=__nav_10_7> <span class="md-nav__icon md-icon"></span> Serveices </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Linux/Serveices/0.ubuntu-desktop-vmware/ class=md-nav__link> <span class=md-ellipsis> ubuntu-desktop-vmware </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_11> <label class=md-nav__link for=__nav_11 id=__nav_11_label tabindex=0> <span class=md-ellipsis> Other </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_11_label aria-expanded=false> <label class=md-nav__title for=__nav_11> <span class="md-nav__icon md-icon"></span> Other </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_11_1> <label class=md-nav__link for=__nav_11_1 id=__nav_11_1_label tabindex=0> <span class=md-ellipsis> tools </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_11_1_label aria-expanded=false> <label class=md-nav__title for=__nav_11_1> <span class="md-nav__icon md-icon"></span> tools </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Other/tools/1.PicGo%E5%9B%BE%E5%BA%8A/ class=md-nav__link> <span class=md-ellipsis> 1.PicGo图床 </span> </a> </li> <li class=md-nav__item> <a href=../../../Other/tools/2.PicX%E5%9B%BE%E5%BA%8A/ class=md-nav__link> <span class=md-ellipsis> 2.Picx图床 </span> </a> </li> <li class=md-nav__item> <a href=../../../Other/tools/3.Markdown%E8%AF%AD%E6%B3%95/ class=md-nav__link> <span class=md-ellipsis> 3.Markdown语法 </span> </a> </li> <li class=md-nav__item> <a href=../../../Other/tools/4.KeyManager/ class=md-nav__link> <span class=md-ellipsis> 4.KeyManager </span> </a> </li> <li class=md-nav__item> <a href=../../../Other/tools/5.mkdocs-material%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/ class=md-nav__link> <span class=md-ellipsis> 5.mkdocs-material搭建博客 </span> </a> </li> <li class=md-nav__item> <a href=../../../Other/tools/6.sphinx%E6%9E%84%E5%BB%BA%E5%8D%9A%E5%AE%A2/ class=md-nav__link> <span class=md-ellipsis> 6.sphinx构建博客 </span> </a> </li> <li class=md-nav__item> <a href=../../../Other/tools/7.%E4%BC%81%E4%B8%9A%E7%BA%A7VPN%E8%BD%AF%E4%BB%B6AnyLink/ class=md-nav__link> <span class=md-ellipsis> 7.企业级VPN软件AnyLink </span> </a> </li> <li class=md-nav__item> <a href=../../../Other/tools/8.%E5%B9%B3%E5%8F%B0%E5%8F%8A%E5%B7%A5%E5%85%B7%E6%B1%87%E6%80%BB/ class=md-nav__link> <span class=md-ellipsis> 8.平台及工具汇总 </span> </a> </li> <li class=md-nav__item> <a href=../../../Other/tools/9.%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%E7%B3%BB%E7%BB%9F%E4%BB%A3%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 9.自动更新系统代理 </span> </a> </li> <li class=md-nav__item> <a href=../../../Other/tools/10.Bash-to-Bat-Converter/ class=md-nav__link> <span class=md-ellipsis> 10.Bash-to-Bat-Converter </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_11_2> <label class=md-nav__link for=__nav_11_2 id=__nav_11_2_label tabindex=0> <span class=md-ellipsis> windows </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_11_2_label aria-expanded=false> <label class=md-nav__title for=__nav_11_2> <span class="md-nav__icon md-icon"></span> windows </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Other/windows/1.%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6%E4%B8%8B%E8%BD%BD/ class=md-nav__link> <span class=md-ellipsis> 1.常用软件下载 </span> </a> </li> <li class=md-nav__item> <a href=../../../Other/windows/2.windows%E5%BF%AB%E6%8D%B7%E6%8C%87%E4%BB%A4/ class=md-nav__link> <span class=md-ellipsis> 2.windows 快捷指令 </span> </a> </li> <li class=md-nav__item> <a href=../../../Other/windows/3.DOS/ class=md-nav__link> <span class=md-ellipsis> 3.DOS </span> </a> </li> <li class=md-nav__item> <a href=../../../Other/windows/4.win11%E9%95%9C%E5%83%8F%E4%B8%8B%E8%BD%BD-%E6%BF%80%E6%B4%BB/ class=md-nav__link> <span class=md-ellipsis> 4.win11镜像下载-激活 </span> </a> </li> <li class=md-nav__item> <a href=../../../Other/windows/5.windows%E4%B8%8Bnetcat%E5%AE%89%E8%A3%85/ class=md-nav__link> <span class=md-ellipsis> 5.windows下netcat安装 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_11_3> <label class=md-nav__link for=__nav_11_3 id=__nav_11_3_label tabindex=0> <span class=md-ellipsis> Interview </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_11_3_label aria-expanded=false> <label class=md-nav__title for=__nav_11_3> <span class="md-nav__icon md-icon"></span> Interview </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Other/Interview/0.%E9%9D%A2%E8%AF%95%E5%AE%9D%E5%85%B8/ class=md-nav__link> <span class=md-ellipsis> 面试宝典 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1-cicd介绍 class=md-nav__link> <span class=md-ellipsis> 1. CI/CD介绍 </span> </a> <nav class=md-nav aria-label="1. CI/CD介绍"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#11-持续集成ci class=md-nav__link> <span class=md-ellipsis> 1.1 持续集成(CI) </span> </a> </li> <li class=md-nav__item> <a href=#12-持续交付cd class=md-nav__link> <span class=md-ellipsis> 1.2 持续交付(CD) </span> </a> </li> <li class=md-nav__item> <a href=#13-持续部署cd class=md-nav__link> <span class=md-ellipsis> 1.3 持续部署(CD) </span> </a> </li> <li class=md-nav__item> <a href=#14-ci和cd的区别 class=md-nav__link> <span class=md-ellipsis> 1.4 CI和CD的区别 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-jenkins流水线介绍 class=md-nav__link> <span class=md-ellipsis> 2. Jenkins流水线介绍 </span> </a> <nav class=md-nav aria-label="2. Jenkins流水线介绍"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-什么是流水线 class=md-nav__link> <span class=md-ellipsis> 2.1 什么是流水线 </span> </a> </li> <li class=md-nav__item> <a href=#22-声明式流水线 class=md-nav__link> <span class=md-ellipsis> 2.2 声明式流水线 </span> </a> </li> <li class=md-nav__item> <a href=#23-脚本化流水线 class=md-nav__link> <span class=md-ellipsis> 2.3 脚本化流水线 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-声明式流水线的语法 class=md-nav__link> <span class=md-ellipsis> 3. 声明式流水线的语法 </span> </a> <nav class=md-nav aria-label="3. 声明式流水线的语法"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-sections class=md-nav__link> <span class=md-ellipsis> 3.1 Sections </span> </a> <nav class=md-nav aria-label="3.1 Sections"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-agent class=md-nav__link> <span class=md-ellipsis> 1. agent </span> </a> </li> <li class=md-nav__item> <a href=#2-post class=md-nav__link> <span class=md-ellipsis> 2. Post </span> </a> </li> <li class=md-nav__item> <a href=#3-stages class=md-nav__link> <span class=md-ellipsis> 3. stages </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#32-directives class=md-nav__link> <span class=md-ellipsis> 3.2 directives </span> </a> <nav class=md-nav aria-label="3.2 directives"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-environment class=md-nav__link> <span class=md-ellipsis> 1. environment </span> </a> </li> <li class=md-nav__item> <a href=#2-options class=md-nav__link> <span class=md-ellipsis> 2. options </span> </a> </li> <li class=md-nav__item> <a href=#3-parameters class=md-nav__link> <span class=md-ellipsis> 3. parameters </span> </a> </li> <li class=md-nav__item> <a href=#4-triggers class=md-nav__link> <span class=md-ellipsis> 4. triggers </span> </a> </li> <li class=md-nav__item> <a href=#5-stage class=md-nav__link> <span class=md-ellipsis> 5. stage </span> </a> </li> <li class=md-nav__item> <a href=#6-input class=md-nav__link> <span class=md-ellipsis> 6. Input </span> </a> </li> <li class=md-nav__item> <a href=#7-when class=md-nav__link> <span class=md-ellipsis> 7. when </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#33-parallel class=md-nav__link> <span class=md-ellipsis> 3.3 parallel </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-jenkinsfile的使用 class=md-nav__link> <span class=md-ellipsis> 4. Jenkinsfile的使用 </span> </a> <nav class=md-nav aria-label="4. Jenkinsfile的使用"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#41-环境变量 class=md-nav__link> <span class=md-ellipsis> 4.1 环境变量 </span> </a> <nav class=md-nav aria-label="4.1 环境变量"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-静态变量 class=md-nav__link> <span class=md-ellipsis> 1. 静态变量 </span> </a> </li> <li class=md-nav__item> <a href=#2-动态变量 class=md-nav__link> <span class=md-ellipsis> 2. 动态变量 </span> </a> </li> <li class=md-nav__item> <a href=#3-jenkins内置变量 class=md-nav__link> <span class=md-ellipsis> 3. Jenkins内置变量 </span> </a> </li> <li class=md-nav__item> <a href=#4-自定义变量 class=md-nav__link> <span class=md-ellipsis> 4. 自定义变量 </span> </a> </li> <li class=md-nav__item> <a href=#5-覆盖环境变量 class=md-nav__link> <span class=md-ellipsis> 5. 覆盖环境变量 </span> </a> </li> <li class=md-nav__item> <a href=#6-环境变量的互相引用 class=md-nav__link> <span class=md-ellipsis> 6. 环境变量的互相引用 </span> </a> </li> <li class=md-nav__item> <a href=#7-将布尔值存储在环境变量中 class=md-nav__link> <span class=md-ellipsis> 7. 将布尔值存储在环境变量中 </span> </a> </li> <li class=md-nav__item> <a href=#8-自定义全局环境变量 class=md-nav__link> <span class=md-ellipsis> 8. 自定义全局环境变量 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#42-凭证管理 class=md-nav__link> <span class=md-ellipsis> 4.2 凭证管理 </span> </a> <nav class=md-nav aria-label="4.2 凭证管理"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-加密文本 class=md-nav__link> <span class=md-ellipsis> 1. 加密文本 </span> </a> </li> <li class=md-nav__item> <a href=#2-用户名密码 class=md-nav__link> <span class=md-ellipsis> 2. 用户名密码 </span> </a> </li> <li class=md-nav__item> <a href=#3-加密文件 class=md-nav__link> <span class=md-ellipsis> 3. 加密文件 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#43-参数处理 class=md-nav__link> <span class=md-ellipsis> 4.3 参数处理 </span> </a> </li> <li class=md-nav__item> <a href=#44-处理失败 class=md-nav__link> <span class=md-ellipsis> 4.4 处理失败 </span> </a> </li> <li class=md-nav__item> <a href=#45-使用多个代理 class=md-nav__link> <span class=md-ellipsis> 4.5 使用多个代理 </span> </a> </li> <li class=md-nav__item> <a href=#46-流水线回放功能 class=md-nav__link> <span class=md-ellipsis> 4.6 流水线回放功能 </span> </a> </li> <li class=md-nav__item> <a href=#47-pipeline开发工具 class=md-nav__link> <span class=md-ellipsis> 4.7 Pipeline开发工具 </span> </a> <nav class=md-nav aria-label="4.7 Pipeline开发工具"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#片段生成器 class=md-nav__link> <span class=md-ellipsis> 片段生成器 </span> </a> </li> <li class=md-nav__item> <a href=#声明式语法生成器 class=md-nav__link> <span class=md-ellipsis> 声明式语法生成器 </span> </a> </li> <li class=md-nav__item> <a href=#全局变量参考 class=md-nav__link> <span class=md-ellipsis> 全局变量参考 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#48-dsl方法 class=md-nav__link> <span class=md-ellipsis> 4.8 DSL方法 </span> </a> <nav class=md-nav aria-label="4.8 DSL方法"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#481-json数据格式解析 class=md-nav__link> <span class=md-ellipsis> 4.8.1 JSON数据格式解析 </span> </a> </li> <li class=md-nav__item> <a href=#482-流水线中使用凭证 class=md-nav__link> <span class=md-ellipsis> 4.8.2 流水线中使用凭证 </span> </a> </li> <li class=md-nav__item> <a href=#483-代码管理-下载代码 class=md-nav__link> <span class=md-ellipsis> 4.8.3 代码管理-下载代码 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#49-groovy编程 class=md-nav__link> <span class=md-ellipsis> 4.9 Groovy编程 </span> </a> <nav class=md-nav aria-label="4.9 Groovy编程"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1安装 class=md-nav__link> <span class=md-ellipsis> 1.安装 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#5-devops平台建设 class=md-nav__link> <span class=md-ellipsis> 5. DevOps平台建设 </span> </a> <nav class=md-nav aria-label="5. DevOps平台建设"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#51-安装jenkins class=md-nav__link> <span class=md-ellipsis> 5.1 安装Jenkins </span> </a> <nav class=md-nav aria-label="5.1 安装Jenkins"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-服务方式 class=md-nav__link> <span class=md-ellipsis> 1. 服务方式 </span> </a> </li> <li class=md-nav__item> <a href=#2-docker-master-slave方式部推荐 class=md-nav__link> <span class=md-ellipsis> 2. docker-master-slave方式部(推荐) </span> </a> </li> <li class=md-nav__item> <a href=#3-helm方式部署推荐 class=md-nav__link> <span class=md-ellipsis> 3. helm方式部署(推荐) </span> </a> <nav class=md-nav aria-label="3. helm方式部署(推荐)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-部署nfs class=md-nav__link> <span class=md-ellipsis> 3.1 部署nfs </span> </a> </li> <li class=md-nav__item> <a href=#32-部署storageclass class=md-nav__link> <span class=md-ellipsis> 3.2 部署StorageClass </span> </a> </li> <li class=md-nav__item> <a href=#33-部署jenkins class=md-nav__link> <span class=md-ellipsis> 3.3 部署jenkins </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-yaml方式部署不推荐 class=md-nav__link> <span class=md-ellipsis> 4. yaml方式部署(不推荐) </span> </a> </li> <li class=md-nav__item> <a href=#5-架构 class=md-nav__link> <span class=md-ellipsis> 5. 架构 </span> </a> <nav class=md-nav aria-label="5. 架构"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-配置 class=md-nav__link> <span class=md-ellipsis> 1. 配置 </span> </a> <nav class=md-nav aria-label="1. 配置"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#11-docker-in-pod推荐 class=md-nav__link> <span class=md-ellipsis> 1.1 docker in pod(推荐) </span> </a> </li> <li class=md-nav__item> <a href=#12-物理机build推荐 class=md-nav__link> <span class=md-ellipsis> 1.2 物理机build(推荐) </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-测试 class=md-nav__link> <span class=md-ellipsis> 2. 测试 </span> </a> <nav class=md-nav aria-label="2. 测试"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-自由风格的流水线 class=md-nav__link> <span class=md-ellipsis> 2.1 自由风格的流水线 </span> </a> </li> <li class=md-nav__item> <a href=#22-pipeline流水线 class=md-nav__link> <span class=md-ellipsis> 2.2 pipeline流水线 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#52-安装gitlab class=md-nav__link> <span class=md-ellipsis> 5.2 安装GitLab </span> </a> <nav class=md-nav aria-label="5.2 安装GitLab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-服务方式部署推荐 class=md-nav__link> <span class=md-ellipsis> 1. 服务方式部署(推荐) </span> </a> </li> <li class=md-nav__item> <a href=#2-docker方式部署推荐 class=md-nav__link> <span class=md-ellipsis> 2. docker方式部署(推荐) </span> </a> <nav class=md-nav aria-label="2. docker方式部署(推荐)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-sameersbngitlab class=md-nav__link> <span class=md-ellipsis> 2.1 sameersbn/gitlab </span> </a> </li> <li class=md-nav__item> <a href=#22-gitlabgitlab-ce class=md-nav__link> <span class=md-ellipsis> 2.2 gitlab/gitlab-ce </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-yaml方式部署不推荐 class=md-nav__link> <span class=md-ellipsis> 3. yaml方式部署(不推荐) </span> </a> </li> <li class=md-nav__item> <a href=#4-helm3安装gitlab不推荐 class=md-nav__link> <span class=md-ellipsis> 4. helm3安装gitlab(不推荐) </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#53-安装harbor class=md-nav__link> <span class=md-ellipsis> 5.3 安装Harbor </span> </a> <nav class=md-nav aria-label="5.3 安装Harbor"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-docker方式部署推荐 class=md-nav__link> <span class=md-ellipsis> 1. docker方式部署(推荐) </span> </a> </li> <li class=md-nav__item> <a href=#2-helm方式部署 class=md-nav__link> <span class=md-ellipsis> 2. helm方式部署 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#54-jenkins凭证credentials class=md-nav__link> <span class=md-ellipsis> 5.4 Jenkins凭证Credentials </span> </a> <nav class=md-nav aria-label="5.4 Jenkins凭证Credentials"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-配置kubernetes证书 class=md-nav__link> <span class=md-ellipsis> 1. 配置Kubernetes证书 </span> </a> </li> <li class=md-nav__item> <a href=#2-配置harbor账号和密码 class=md-nav__link> <span class=md-ellipsis> 2. 配置Harbor账号和密码 </span> </a> </li> <li class=md-nav__item> <a href=#3-配置gitlab-key class=md-nav__link> <span class=md-ellipsis> 3. 配置GitLab Key </span> </a> </li> <li class=md-nav__item> <a href=#4-配置gitlab账号密码 class=md-nav__link> <span class=md-ellipsis> 4. 配置GitLab账号密码 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#55-配置agent class=md-nav__link> <span class=md-ellipsis> 5.5 配置Agent </span> </a> </li> <li class=md-nav__item> <a href=#56-jenkins配置kubernetes多集群 class=md-nav__link> <span class=md-ellipsis> 5.6 Jenkins配置Kubernetes多集群 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#6-自动化构建java应用 class=md-nav__link> <span class=md-ellipsis> 6. 自动化构建Java应用 </span> </a> <nav class=md-nav aria-label="6. 自动化构建Java应用"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#61-部署kubernetes应用 class=md-nav__link> <span class=md-ellipsis> 6.1 部署Kubernetes应用 </span> </a> </li> <li class=md-nav__item> <a href=#62-创建java测试用例 class=md-nav__link> <span class=md-ellipsis> 6.2 创建Java测试用例 </span> </a> </li> <li class=md-nav__item> <a href=#63-定义jenkinsfile class=md-nav__link> <span class=md-ellipsis> 6.3 定义Jenkinsfile </span> </a> </li> <li class=md-nav__item> <a href=#64-jenkinsfile详解 class=md-nav__link> <span class=md-ellipsis> 6.4 Jenkinsfile详解 </span> </a> </li> <li class=md-nav__item> <a href=#65-定义dockerfile class=md-nav__link> <span class=md-ellipsis> 6.5 定义Dockerfile </span> </a> </li> <li class=md-nav__item> <a href=#66-定义kubernetes资源 class=md-nav__link> <span class=md-ellipsis> 6.6 定义Kubernetes资源 </span> </a> </li> <li class=md-nav__item> <a href=#67-创建jenkins任务 class=md-nav__link> <span class=md-ellipsis> 6.7 创建Jenkins任务 </span> </a> </li> <li class=md-nav__item> <a href=#68-webhook自动触发构建 class=md-nav__link> <span class=md-ellipsis> 6.8 Webhook自动触发构建 </span> </a> </li> <li class=md-nav__item> <a href=#69-构建状态信息推送到gitlab class=md-nav__link> <span class=md-ellipsis> 6.9 构建状态信息推送到GitLab </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#7-自动化构建vueh5前端应用 class=md-nav__link> <span class=md-ellipsis> 7. 自动化构建Vue/H5前端应用 </span> </a> <nav class=md-nav aria-label="7. 自动化构建Vue/H5前端应用"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#71-定义jenkinsfile class=md-nav__link> <span class=md-ellipsis> 7.1 定义Jenkinsfile </span> </a> </li> <li class=md-nav__item> <a href=#72-定义dockerfile class=md-nav__link> <span class=md-ellipsis> 7.2 定义Dockerfile </span> </a> </li> <li class=md-nav__item> <a href=#73-定义kubernetes资源 class=md-nav__link> <span class=md-ellipsis> 7,3 定义Kubernetes资源 </span> </a> </li> <li class=md-nav__item> <a href=#74-创建jenkins-job class=md-nav__link> <span class=md-ellipsis> 7.4 创建Jenkins Job </span> </a> </li> <li class=md-nav__item> <a href=#75-webhook自动触发 class=md-nav__link> <span class=md-ellipsis> 7.5 Webhook自动触发 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#8-自动化构建golang项目 class=md-nav__link> <span class=md-ellipsis> 8. 自动化构建Golang项目 </span> </a> <nav class=md-nav aria-label="8. 自动化构建Golang项目"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#81-定义jenkinsfile class=md-nav__link> <span class=md-ellipsis> 8.1 定义Jenkinsfile </span> </a> </li> <li class=md-nav__item> <a href=#82-定义dockerfile class=md-nav__link> <span class=md-ellipsis> 8.2 定义Dockerfile </span> </a> </li> <li class=md-nav__item> <a href=#83-定义kubernets资源 class=md-nav__link> <span class=md-ellipsis> 8.3 定义Kubernets资源 </span> </a> </li> <li class=md-nav__item> <a href=#84-创建jenkins-job class=md-nav__link> <span class=md-ellipsis> 8.4 创建Jenkins Job </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#9-uat及生产环境流水线设计 class=md-nav__link> <span class=md-ellipsis> 9. UAT及生产环境流水线设计 </span> </a> </li> <li class=md-nav__item> <a href=#10-vscode-jenkins插件分享 class=md-nav__link> <span class=md-ellipsis> 10. vscode Jenkins插件分享 </span> </a> <nav class=md-nav aria-label="10. vscode Jenkins插件分享"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#101-在vscode中校验您的jenkinsfile class=md-nav__link> <span class=md-ellipsis> 10.1 在VSCode中校验您的Jenkinsfile </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#11-小结 class=md-nav__link> <span class=md-ellipsis> 11. 小结 </span> </a> </li> <li class=md-nav__item> <a href=#参考文献 class=md-nav__link> <span class=md-ellipsis> 参考文献 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=devops实践>DevOps实践<a class=headerlink href=#devops实践 title="Permanent link">&para;</a></h1> <p>在之前的章节，我们所介绍的应用部署或者更新都是采用手工的方式，但在企业内部，应用架构一般都采用微服务，大部分项目都会对应几十、上 百，甚至上千个微服务，并且还不仅仅只有一个项目，所以采用手工方式上线是不太现实的事情，特别是随着应用的增多，对应的工作量也变得不可想 象。</p> <p>由于上线的过程一般比较固定，大都是提前规定好、比较一致的流程，因此采用工具来完成这类“死板”的工作是比较推荐的方式，同时也能减少 手工操作带来故障的风险。</p> <p>本章主要介绍在生产环境中持续集成（Continuous Integration，CI）与持续部署（Continuous Deployment，CD）的使用--实现Jenkins流水线 脚本自动发布应用到Kubernetes集群中，当然CI/CD是DevOps中非常重要的一个环节。</p> <h2 id=1-cicd介绍>1. CI/CD介绍<a class=headerlink href=#1-cicd介绍 title="Permanent link">&para;</a></h2> <p>CI/CD是一种通过在应用开发阶段引入自动化来频繁向客户交付应用的方法。</p> <p>CI/CD的核心概念是持续集成、持续交付（Continuous Delivery，CD）和持续部署。</p> <p>作为一个面向开发和运营团队的解决方案，CI/CD主要针对在集成新代码时所引发的问题（也称“集成地狱”）。</p> <p>具体而言，CI/CD在整个应用生命周期内（从集成和测试阶段到交付和部署）引入了持续自动化和持续监控，这些关联的事务通常被称为“CI/CD管 道”，由开发和运维团队以敏捷方式协同支持。</p> <h3 id=11-持续集成ci>1.1 持续集成(CI)<a class=headerlink href=#11-持续集成ci title="Permanent link">&para;</a></h3> <p>现代应用开发的目标是让多位开发人员同时开发同一个应用的不同功能。</p> <p>但是，如果企业安排在一天内将所有分支源代码合并在一起，最终可能导致工作烦琐、耗时，而且需要手动完成。</p> <p>这是因为当一位独立工作的开发人员对应用进行更改时，有可能会有其他开发人员同时进行更改，从而引发 冲突。</p> <p><mark>持续集成可以帮助开发人员更加频繁地将代码更改合并到共享分支或主干中。一旦开发人员对应用所做的更改被合并，系统就会通过自动构建应用 并运行不同级别的自动化测试（通常是单元测试和集成测试）来验证这些更改，确保更改没有对应用造成破坏。</mark></p> <p>这意味着测试内容涵盖了从类和函数到构成整个应用的不同模块，如果自动化测试发现新代码和现有代码之间有冲突，持续集成可以更加轻松快速地修复这些错误。</p> <h3 id=12-持续交付cd>1.2 持续交付(CD)<a class=headerlink href=#12-持续交付cd title="Permanent link">&para;</a></h3> <p>完成持续集成中构建单元测试和集成测试的自动化流程后，通过持续交付可以自动将已验证的代码发布到存储库。为了实现高效的持续交付流程， 务必要确保持续交付已内置于开发管道。</p> <p>持续交付的目标是拥有一个可随时部署到生产环境的代码库。</p> <p>在持续交付中，每个阶段（从代码更改的合并到生产就绪型构建版本的交付）都涉及测试自动化和代码发布自动化。在流程结束时，运维团队可以 快速、轻松地将应用部署到生产环境中。</p> <h3 id=13-持续部署cd>1.3 持续部署(CD)<a class=headerlink href=#13-持续部署cd title="Permanent link">&para;</a></h3> <p>对于一个成熟的CI/CD管道来说，最后的阶段是持续部署。</p> <p>作为持续交付（自动将生产就绪型构建版本发布到代码存储库）的延伸，持续部署可以自动将应用发布到生产环境中。</p> <p>由于生产之前的管道阶段没有手动门控，因此持续部署在很大程度上都得依赖精心设计的测试自动化。</p> <p>实际上，持续部署意味着开发人员对应用的更改在编写后的几分钟内就能生效，这更加便于持续接收和整合用户反馈。</p> <p>总而言之，所有这些CI/CD的关联步骤都有助于降低应用的部署风险，因此更便于以小件的方式（非一次性）发布对应用的更改。</p> <p>不过，由于还需要编写自动化测试以适应CI/CD管道中的各种测试和发布阶段，因此前期投资会很大。</p> <h3 id=14-ci和cd的区别>1.4 CI和CD的区别<a class=headerlink href=#14-ci和cd的区别 title="Permanent link">&para;</a></h3> <p>CI/CD中的CI即持续集成，它属于开发人员的自动化流程。</p> <p>成功的CI意味着应用代码的最新更改会定期构建、测试并合并到共享存储中。</p> <p><mark><strong>该解决方案可以解决在一次开发中有太多应用分支，从而导致相互冲突的问题。</strong></mark></p> <p>CI/CD中的CD指的是持续交付或持续部署，这些相关概念有时会交叉使用。</p> <p>两者都事关管道后续阶段的自动化，但它们有时也会单独使用，用于说明自动化程度。</p> <p>持续交付通常是指开发人员对应用的更改会自动进行错误测试并上传到存储库（如GitLab或容器注册表），然后由运维团队将其部署到实时生产环 境中，旨在解决开发和运维团队之间可见性及沟通较差的问题，因此持续交付的目的就是确保尽可能减少部署新代码时所需的工作量。</p> <p>持续部署指的是自动将开发人员的更改从代码库发布到生产环境中以供客户使用，它主要为解决因手动流程降低应用交付速度，从而使运维团队超 负荷的问题。</p> <p>持续部署以持续交付的优势为根基，实现了管道后续阶段的自动化。</p> <p>CI/CD既可能仅指持续集成和持续交付构成的关联环节，也可以指持续集成、持续交付和持续部署这3个方面构成的关联环节。</p> <p>更为复杂的是有时持续交付也包含持续部署流程。</p> <p>纠缠于这些语义其实没有必要，只需记得CI/CD实际上就是一个流程（通常表述为管道），用于在更大程度上实现应用开发的持续自动化和持续监控。</p> <h2 id=2-jenkins流水线介绍>2. Jenkins流水线介绍<a class=headerlink href=#2-jenkins流水线介绍 title="Permanent link">&para;</a></h2> <p>提到CI工具，首先想到的就是“CI界”的大佬——Jenkins，虽然在云原生爆发的年代，蹦出来了很多云原生的CI工具，但是都不足以撼动Jenkins的 地位。</p> <p>在企业中对于持续集成、持续部署的需求非常多，并且也会经常有一些比较复杂的需求，此时新生的CI工具不足以支撑这些很复杂的需求。</p> <p>但是Jenkins丰富的插件基本上可以满足任何场景，所以本书的CI/CD还是围绕Jenkins进行讲解。</p> <p>限于篇幅，本书并不打算从基础的概念讲起，而是讲解Jenkins最佳的使用方式，也就是Jenkins Pipeline（Jenkins流水线）的使用。</p> <p>首先介绍流水线的概念和类型，包括Jenkins声明式流水线（Declarative Pipeline）和脚本式流水线（Scripted Pipeline），然后讲解流水线的基本语法和一些例 子。</p> <h3 id=21-什么是流水线>2.1 什么是流水线<a class=headerlink href=#21-什么是流水线 title="Permanent link">&para;</a></h3> <p>Jenkins流水线是一套插件，它支持在Jenkins中实现和集成持续交付流水线（Continuous Delivery Pipeline）。</p> <p>流水线提供了一组可扩展的工具，用于通过Pipeline DSL将简单到复杂的交付流水线以代码的形势展现，类似于基础设施即代码。</p> <p>持续交付流水线会经历一个复杂的过程：</p> <p>从版本控制、向用户和客户提交软件、软件的每次变更（提交代码到仓库）到软件发布（Release）。</p> <p>这个过程包括以一种可靠并可重复的方式构建软件，以及通过多个测试和部署阶段来开发构建好的软件（称为Build）。</p> <p>Jenkins流水线的定义被写在一个文本文件中（一般为Jenkinsfile），该文件“定制”了整个构建软件的过程。Jenkinsfile也可以被提交到项目的 代码仓库中，在Jenkins中可以直接引用。将持续交付流水线作为应用程序的一部分，像其他代码一样进行版本化和审查，这是流水线即代码的基础。</p> <p>创建Jenkinsfile并提交到代码仓库中的好处如下：</p> <ul> <li>自动为所有分支创建流水线构建过程。</li> <li>在流水线上进行代码复查/迭代。</li> <li>对流水线进行审计跟踪。</li> <li>流水线的代码可以被项目的多个成员查看和编辑。</li> <li>可以对Jenkinsfile进行版本控制。</li> </ul> <p>Jenkins流水线主要分为声明式和脚本式两种，包含pipeline（流水线）、node（节点）、stage（阶段）、step（步骤）等区块。</p> <p>（1）pipeline pipeline是用户定义的一个持续交付（CD）流水线模型。流水线的代码定义了整个构建过程，包括构建、测试和交付应用程序的阶段。另外， pipeline块是声明式流水线语法的关键部分。</p> <p>（2）node node是一个机器，它是Jenkins环境的一部分，另外，node块是脚本化流水线语法的关键部分。</p> <p>（3）stage stage块定义了在整个流水线的执行任务中概念不同的子集（比如Build、Test、Deploy阶段），它被许多插件用于可视化Jenkins流水线当前 的状态/进展。</p> <p>（4）step 本质上是指通过一个单一的任务告诉Jenkins在特定的时间点需要做什么，比如要执行shell命令，可以使用<code>sh SHELL_COMMAND</code>。</p> <p>从上文可以了解，Jenkins流水线分为脚本式和声明式，而声明式是“新一代”的流水线，比脚本式更加灵活，可读性更强，并且声明式流水线支持 以图形化的方式进行编辑，所以声明式流水线是着重学习的对象。</p> <p>接下来看一下声明式流水线和脚本式流水线的语法区别。</p> <h3 id=22-声明式流水线>2.2 声明式流水线<a class=headerlink href=#22-声明式流水线 title="Permanent link">&para;</a></h3> <p>在声明式流水线的语法中，流水线过程定义在pipeline{}中，pipeline块定义了整个流水线中完成的所有工作，比如：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>//Jenkinsfile (Declarative Pipeline)
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>pipeline {
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>  agent any
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>    stages {
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>      stage(&#39;Build&#39;) {
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>        steps {
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>          echo &#39;Build&#39;
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>        }
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>      }
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>      stage(&#39;Test&#39;) {
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>        steps {
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>          echo &#39;Test&#39;
<a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>        }
<a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>      }
<a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>      stage(&#39;Deploy&#39;) {
<a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>        steps {
<a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>          echo &#39;Deploy&#39;
<a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>      }
<a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>    }
<a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>  }
<a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a>}
</code></pre></div> <p>参数说明：</p> <ul> <li>agent any：在任何可用的代理上执行流水线或它的任何阶段，也就是执行流水线过程的位置，也可以指定到具体的节点。</li> <li>stage：定义流水线的执行过程（相当于一个阶段），比如上文所示的Build、Test、Deploy，但是这个名字是根据实际情况定义的，并 非固定的名字。</li> <li>steps：执行某阶段具体的步骤。</li> </ul> <p>一个以声明式流水线的语法编写的Jenkinsfile文件如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>//Jenkinsfile (Declarative Pipeline)
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>pipeline {
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>  agent any
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>    stages {
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>      stage(&#39;Build&#39;) {
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>        steps {
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>          sh &#39;make&#39;
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>        }
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>      }
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>      stage(&#39;Test&#39;) {
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>        steps {
<a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>          sh &#39;make check&#39;
<a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>          junit &#39;reports/**/*.xml&#39;
<a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>        }
<a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>      }
<a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a>      stage(&#39;Deploy&#39;) {
<a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a>        steps {
<a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a>          sh &#39;make publish&#39;
<a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a>      }
<a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a>    }
<a id=__codelineno-1-21 name=__codelineno-1-21 href=#__codelineno-1-21></a>  }
<a id=__codelineno-1-22 name=__codelineno-1-22 href=#__codelineno-1-22></a>}
</code></pre></div> <p>参数说明：</p> <ul> <li>pipeline：声明式流水线的一种特定语法，定义了包含执行整个流水线的所有内容和指令，也是声明式流水线的开始。</li> <li>agent：声明式流水线的一种特定语法，指示Jenkins为整个流水线分配一个执行器和工作区，也就是在流水线中的步骤在哪个agent上 执行，该参数同样可以在stage中配置。</li> <li>stage：描述流水线阶段的语法块，在脚本式流水线语法中，stage块是可选的。</li> <li>steps：声明式流水线的一种特定语法，它描述了在这个stage中要运行的步骤。</li> <li>sh：执行一个shell命令。</li> <li>junit：用于聚合测试报告。</li> </ul> <h3 id=23-脚本化流水线>2.3 脚本化流水线<a class=headerlink href=#23-脚本化流水线 title="Permanent link">&para;</a></h3> <p>在脚本化流水线的语法中，会有一个或多个node块在整个流水线中执行核心工作，比如：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>//Jenkinsfile (Scripted Pipeline)
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>node {
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>  stage(&#39;Build&#39;) {
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>    echo &#39;Build&#39;
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>  }
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>  stage(&#39;Test&#39;) {
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>    echo &#39;Test&#39;
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>  }
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a>  stage(&#39;Deploy&#39;) {
<a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>    echo &#39;Deploy&#39;
<a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a>  }
<a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>}
</code></pre></div> <p>参数说明：</p> <ul> <li>node：在任何可用的代理上执行流水线或它的任何阶段，也可以指定到具体的节点。</li> <li>stage：和声明式的含义一致，定义流水线的阶段。stage块在脚本化流水线语法中是可选的，然而在脚本化流水线中实现stage块，可 以清楚地在Jenkins UI界面中显示每个stage的任务子集。</li> </ul> <p>上一小节的声明式流水线也可以用以下脚本式流水线代替：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>//Jenkinsfile (Scripted Pipeline)
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>node {
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>  stage(&#39;Build&#39;) {
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>    sh &#39;make&#39;
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>  }
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>  stage(&#39;Test&#39;) {
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>     sh &#39;make check&#39;
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>     junit &#39;reports/**/*.xml&#39;
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>  }
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>  stage(&#39;Deploy&#39;) {
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>      sh &#39;make publish&#39;
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>  }
<a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>}
</code></pre></div> <h2 id=3-声明式流水线的语法>3. 声明式流水线的语法<a class=headerlink href=#3-声明式流水线的语法 title="Permanent link">&para;</a></h2> <p>前文提到，声明式是Jenkins新一代的流水线编写方式，而且声明式流水线支持类似Blue Ocean这类的图形化工具进行在线编辑，因此本书主要讲解 声明式流水线的写法。</p> <p>声明式流水线在流水线子系统之上提供了一种更简单、更容易理解的语法。</p> <p>之前也提到过，所有有效的声明式流水线必须包含在一个pipeline块中，比如以下是一个pipeline块的格式：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>//Jenkinsfile (Declarative Pipeline)
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>pipeline {
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>/* insert Declarative Pipeline here */
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>}
</code></pre></div> <p>在声明式流水线中，有效的基本语句和表达式遵循与Groovy的语法同样的规则，但有以下例外：</p> <ul> <li>流水线顶层必须是一个 block，即 <code>pipeline{}</code></li> <li>分隔符可以不需要分号，但是每条语句都必须在自己的行上</li> <li>块只能由 Sections、Directives、Steps 或 assignment statements组成</li> <li>属性引用语句被当做是无参数的方法调用，比如 input 会被当做input()。</li> </ul> <p>接下来学习声明式流水线的基本语法，包括sections、directives区块及parallel字段的用法。</p> <h3 id=31-sections>3.1 Sections<a class=headerlink href=#31-sections title="Permanent link">&para;</a></h3> <p>声明式流水线中的 Sections 不是一个关键字或指令，而是包含一个或多个 Agent、Stages、 post、Directives 和 Steps 的代码区域块。</p> <h4 id=1-agent>1. agent<a class=headerlink href=#1-agent title="Permanent link">&para;</a></h4> <p>agent表示整个流水线或特定阶段中的步骤和命令执行的位置，该部分必须在pipeline块的顶层被定义，也可以在stage中再次定义，但是stage级别 是可选的。</p> <p>（1）agent的配置函数 为了支持可能有的各种各样的流水线，agent支持一些不同类型的参数，这些参数应用在pipeline块的顶层，或stage指令内部。agent可选配置如 下：</p> <ul> <li>any：在任何可用的代理上执行流水线，配置语法：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>pipeline {
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>  agent any
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>}
</code></pre></div> <ul> <li>none：表示该pipeline脚本没有全局的agent配置。当顶层的agent配置为none时，每个stage部分都需要包含它自己的agent。配置语法：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>pipeline {
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>  agent none
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>  stages {
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>    stage(&#39;Stage For Build&#39;){
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>      agent any
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>    }
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>  }
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>}
</code></pre></div> <ul> <li>label: 以节点标签形式选择某个具体的节点执行 Pipeline 命令，例如：agent { label 'my-defined-label' }。节点需要提前配置标签。</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>pipeline {
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>  agent none
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>    stages {
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>      stage(&#39;Stage For Build&#39;){
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>        agent { label &#39;role-master&#39; }
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>        steps {
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>          echo &quot;role-master&quot;
<a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>        }
<a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>      }
<a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>    }
<a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a>}
</code></pre></div> <ul> <li>node: 和 label 配置类似，只不过是可以添加一些额外的配置，比如 customWorkspace(设置默认工作目录)</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>pipeline {
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>  agent none
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>    stages {
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>      stage(&#39;Stage For Build&#39;){
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>        agent {
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>          node {
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>            label &#39;role-master&#39;
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>            customWorkspace &quot;/tmp/zhangzhuo/data&quot;
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>          }
<a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>        }
<a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>        steps {
<a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>          sh &quot;echo role-master &gt; 1.txt&quot;
<a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>        }
<a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>      }
<a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a>    }
<a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a>}
</code></pre></div> <ul> <li>dockerfile：使用从源码中包含的Dockerfile所构建的容器执行流水线或stage。为了使用该选项，Jenkinsfile必须从多个分支流水线中加载，或者从pipeline from SCM（后面的章节会涉及）加载。</li> </ul> <p>如果配置的语法为agent {dockerfile true}，那么将从源码的根目录下使用Dockerfile文件进行构建。</p> <p>如果Dockerfile文件在其他目录，则需要使用dir字段更改Dockerfile所在的目录，配置方法为agent { dockerfile { dir 'DockerfileDir'} }。</p> <p>如果构建镜像的Dockerfile名称不是Dockerfile，可以使用filename选项指定Dockerfile文件名。</p> <p>同时也可以使用additionalBuildArgs参数传递构建镜像的参数，比如agent{dockerfile{ additionalBuildArgs '--build-arg version=1.0.2' } }。</p> <p>假如有一个项目需要使用Dockerfile类型的agent，并且Dockerfile在build目录，文件名为Dockerfile.build，构建时期望有一个version的参数。此时对应的 agent写法如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>  agent {
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>     dockerfile {
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>       filename &#39;Dockerfile.build&#39;  //dockerfile文件名称
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>       dir &#39;build&#39;                  //执行构建镜像的工作目录
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>       label &#39;role-master&#39;          //执行的node节点，标签选择
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>       additionalBuildArgs &#39;--build-arg version=1.0.2&#39; //构建参数
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>     }
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>  }
</code></pre></div> <ul> <li>docker：相当于dockerfile，可以直接使用docker字段指定外部镜像，可以省去构建的时间。比如使用maven镜像进行打包，同时可以指定args：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>agent{
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>  docker{
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>    image &#39;192.168.10.15/kubernetes/alpine:latest&#39;   //镜像地址
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>    label &#39;role-master&#39; //执行的节点，标签选择
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>    args &#39;-v /tmp:/tmp&#39;      //启动镜像的参数
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>  }
<a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a>}
</code></pre></div> <ul> <li>kubernetes：<strong>Jenkins也支持使用Kubernetes创建Slave，也就是常说的动态Slave。</strong></li> </ul> <p>需要部署 kubernetes 相关的插件，官方文档：</p> <blockquote> <p><a href=https://github.com/jenkinsci/kubernetes-plugin/ >https://github.com/jenkinsci/kubernetes-plugin/</a></p> </blockquote> <p>配置示例如下;</p> <ul> <li>cloud: Configure Clouds 的名称，指定到其中一个k8s</li> <li>slaveConnectTimeout: 连接超时时间</li> <li>yaml: pod 定义文件，jnlp 容器的配置必须有配置无需改变，其余containerd根据自己情况指定</li> <li>workspaceVolume：持久化 jenkins 的工作目录。<ul> <li>persistentVolumeClaimWorkspaceVolume：挂载已有pvc。</li> </ul> </li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a>workspaceVolume persistentVolumeClaimWorkspaceVolume(claimName: &quot;jenkins-agent&quot;, mountPath: &quot;/&quot;, readOnly: &quot;false&quot;)
</code></pre></div> <ul> <li>nfsWorkspaceVolume：挂载 nfs 服务器目录</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>workspaceVolume nfsWorkspaceVolume(serverAddress: &quot;192.168.10.254&quot;, serverPath: &quot;/nfs&quot;, readOnly: &quot;false&quot;)
</code></pre></div> <ul> <li>dynamicPVC：动态申请 pvc，任务执行结束后删除</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>workspaceVolume dynamicPVC(storageClassName: &quot;nfs-client&quot;, requestsSize: &quot;1Gi&quot;, accessModes: &quot;ReadWriteMany&quot;)
</code></pre></div> <ul> <li>emptyDirWorkspaceVolume：临时目录，任务执行结束后会随着 pod 删除被删除，主要功能多个任务 container 共享 jenkins 工作目录。</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a>workspaceVolume emptyDirWorkspaceVolume()
</code></pre></div> <ul> <li>hostPathWorkspaceVolume：挂载 node 节点本机目录，注意挂载本机目录注意权限问题，可以先创建设置 777 权限，否则默认 kubelet 创建的目录权限为 755 默认其他用户没有写权限，执行流水线会报错。</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a>workspaceVolume hostPathWorkspaceVolume(hostPath: &quot;/opt/workspace&quot;, readOnly: false)
</code></pre></div> <p><strong>示例</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a>agent {
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a>  kubernetes {
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>      cloud &#39;kubernetes&#39;
<a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a>      slaveConnectTimeout 1200
<a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a>      workspaceVolume emptyDirWorkspaceVolume()
<a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a>      yaml &#39;&#39;&#39;
<a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a>kind: Pod
<a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a>metadata:
<a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a>  name: jenkins-agent
<a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a>spec:
<a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a>  containers:
<a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a>  - args: [\&#39;$(JENKINS_SECRET)\&#39;, \&#39;$(JENKINS_NAME)\&#39;]
<a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a>    image: &#39;192.168.10.15/kubernetes/jnlp:alpine&#39;
<a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a>    name: jnlp
<a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a>    imagePullPolicy: IfNotPresent
<a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a>  - command:
<a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a>      - &quot;cat&quot;
<a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a>    image: &quot;192.168.10.15/kubernetes/alpine:latest&quot;
<a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a>    imagePullPolicy: &quot;IfNotPresent&quot;
<a id=__codelineno-16-20 name=__codelineno-16-20 href=#__codelineno-16-20></a>    name: &quot;date&quot;
<a id=__codelineno-16-21 name=__codelineno-16-21 href=#__codelineno-16-21></a>    tty: true
<a id=__codelineno-16-22 name=__codelineno-16-22 href=#__codelineno-16-22></a>  restartPolicy: Never
<a id=__codelineno-16-23 name=__codelineno-16-23 href=#__codelineno-16-23></a>&#39;&#39;&#39;
<a id=__codelineno-16-24 name=__codelineno-16-24 href=#__codelineno-16-24></a>  }
<a id=__codelineno-16-25 name=__codelineno-16-25 href=#__codelineno-16-25></a>}
</code></pre></div> <p>（2）agent的常见选项</p> <ul> <li> <p>label：一个字符串，该标签用于运行流水线的位置。该选项对node、docker和dockerfile可用，node必须选择该选项</p> </li> <li> <p>customWorkspace：一个字符串，用于自定义工作区运行流水线或stage。它可以是相对路径，也可以是绝对路径，该选项对node、 docker和dockerfile可用。比如：</p> </li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a>agent {
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>  node {
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>      label &#39;my-defied-label&#39;
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a>      customWorkspace &#39;some/other/path&#39;
<a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a>  }
<a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a>}
</code></pre></div> <ul> <li>reuseNode：一个布尔值，默认为false。如果是true，则在同一个工作目录执行流水线。</li> </ul> <p>这个选项对docker和dockerfile有用，并且只有使用在个别stage的agent上才会有效。通常情况下使用docker 作为agent时会开启此参数：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a>agent {
<a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>  docker {
<a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>      image &#39;maven:3-alpine&#39;
<a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a>      label &#39;my-defined-label&#39;
<a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a>      args &#39;-v /tmp:/tmp&#39;
<a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a>      reuseNode true
<a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a>  }
<a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a>}
</code></pre></div> <p>（3）agent的配置示例</p> <ul> <li>示例1：假设有一个Java项目，需要用mvn命令进行编译，此时可以使用maven的镜像作为agent。配置如下：</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a>pipeline {
<a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a>  agent { docker &#39;maven:3-alpine&#39; }
<a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a>  stages {
<a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a>    stage(&#39;Example Build&#39;) {
<a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a>      steps {
<a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a>        echo &#39;Hello, Maven&#39;
<a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a>        sh &#39;mvn -B clean verify&#39;
<a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a>      }
<a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a>    }
<a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a>  }
<a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a>}
</code></pre></div> <ul> <li>示例2：本示例在流水线顶层将agent定义为none，那么此时stage部分就必须包含它自己的agent部分。</li> </ul> <p>在stage('Example Build')部分使用maven:3-alpine执行该阶段的步骤，在stage('Example Test')部分使用openjdk:8-jre执行该阶段的步骤。此时Pipeline如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a>pipeline {
<a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a>  agent none
<a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a>  stages {
<a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a>    stage(&#39;Example Build&#39;) {
<a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a>      agent { docker &#39;maven:3-alpine&#39; }
<a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a>      steps {
<a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a>        echo &#39;Hello, Maven&#39;
<a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a>        sh &#39;mvn --version&#39;
<a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a>      }
<a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a>    }
<a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a>    stage(&#39;Example Test&#39;) {
<a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a>      agent { docker &#39;openjdk:8-jre&#39; }
<a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a>      steps {
<a id=__codelineno-20-14 name=__codelineno-20-14 href=#__codelineno-20-14></a>        echo &#39;Hello, JDK&#39;
<a id=__codelineno-20-15 name=__codelineno-20-15 href=#__codelineno-20-15></a>        sh &#39;java -version&#39;
<a id=__codelineno-20-16 name=__codelineno-20-16 href=#__codelineno-20-16></a>      }
<a id=__codelineno-20-17 name=__codelineno-20-17 href=#__codelineno-20-17></a>    }
<a id=__codelineno-20-18 name=__codelineno-20-18 href=#__codelineno-20-18></a>  }
<a id=__codelineno-20-19 name=__codelineno-20-19 href=#__codelineno-20-19></a>} 
</code></pre></div> <ul> <li>kubernetes 示例</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a>pipeline {
<a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>  agent {
<a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a>    kubernetes {
<a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a>      cloud &#39;kubernetes&#39;
<a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a>      slaveConnectTimeout 1200
<a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a>      workspaceVolume emptyDirWorkspaceVolume()
<a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a>      yaml &#39;&#39;&#39;
<a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a>kind: Pod
<a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a>metadata:
<a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a>  name: jenkins-agent
<a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a>spec:
<a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a>  containers:
<a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a>  - args: [\&#39;$(JENKINS_SECRET)\&#39;, \&#39;$(JENKINS_NAME)\&#39;]
<a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a>    image: &#39;192.168.10.15/kubernetes/jnlp:alpine&#39;
<a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a>    name: jnlp
<a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a>    imagePullPolicy: IfNotPresent
<a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a>  - command:
<a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a>      - &quot;cat&quot;
<a id=__codelineno-21-19 name=__codelineno-21-19 href=#__codelineno-21-19></a>    image: &quot;192.168.10.15/kubernetes/alpine:latest&quot;
<a id=__codelineno-21-20 name=__codelineno-21-20 href=#__codelineno-21-20></a>    imagePullPolicy: &quot;IfNotPresent&quot;
<a id=__codelineno-21-21 name=__codelineno-21-21 href=#__codelineno-21-21></a>    name: &quot;date&quot;
<a id=__codelineno-21-22 name=__codelineno-21-22 href=#__codelineno-21-22></a>    tty: true
<a id=__codelineno-21-23 name=__codelineno-21-23 href=#__codelineno-21-23></a>  - command:
<a id=__codelineno-21-24 name=__codelineno-21-24 href=#__codelineno-21-24></a>      - &quot;cat&quot;
<a id=__codelineno-21-25 name=__codelineno-21-25 href=#__codelineno-21-25></a>    image: &quot;192.168.10.15/kubernetes/kubectl:apline&quot;
<a id=__codelineno-21-26 name=__codelineno-21-26 href=#__codelineno-21-26></a>    imagePullPolicy: &quot;IfNotPresent&quot;
<a id=__codelineno-21-27 name=__codelineno-21-27 href=#__codelineno-21-27></a>    name: &quot;kubectl&quot;
<a id=__codelineno-21-28 name=__codelineno-21-28 href=#__codelineno-21-28></a>    tty: true
<a id=__codelineno-21-29 name=__codelineno-21-29 href=#__codelineno-21-29></a>  restartPolicy: Never
<a id=__codelineno-21-30 name=__codelineno-21-30 href=#__codelineno-21-30></a>&#39;&#39;&#39;
<a id=__codelineno-21-31 name=__codelineno-21-31 href=#__codelineno-21-31></a>    }
<a id=__codelineno-21-32 name=__codelineno-21-32 href=#__codelineno-21-32></a>  }
<a id=__codelineno-21-33 name=__codelineno-21-33 href=#__codelineno-21-33></a>  environment {
<a id=__codelineno-21-34 name=__codelineno-21-34 href=#__codelineno-21-34></a>    MY_KUBECONFIG = credentials(&#39;kubernetes-cluster&#39;)
<a id=__codelineno-21-35 name=__codelineno-21-35 href=#__codelineno-21-35></a>  }
<a id=__codelineno-21-36 name=__codelineno-21-36 href=#__codelineno-21-36></a>  stages {
<a id=__codelineno-21-37 name=__codelineno-21-37 href=#__codelineno-21-37></a>    stage(&#39;Data&#39;) {
<a id=__codelineno-21-38 name=__codelineno-21-38 href=#__codelineno-21-38></a>      steps {
<a id=__codelineno-21-39 name=__codelineno-21-39 href=#__codelineno-21-39></a>        container(name: &#39;date&#39;) {
<a id=__codelineno-21-40 name=__codelineno-21-40 href=#__codelineno-21-40></a>          sh &quot;&quot;&quot;
<a id=__codelineno-21-41 name=__codelineno-21-41 href=#__codelineno-21-41></a>            date
<a id=__codelineno-21-42 name=__codelineno-21-42 href=#__codelineno-21-42></a>          &quot;&quot;&quot;
<a id=__codelineno-21-43 name=__codelineno-21-43 href=#__codelineno-21-43></a>        }
<a id=__codelineno-21-44 name=__codelineno-21-44 href=#__codelineno-21-44></a>      }
<a id=__codelineno-21-45 name=__codelineno-21-45 href=#__codelineno-21-45></a>    }
<a id=__codelineno-21-46 name=__codelineno-21-46 href=#__codelineno-21-46></a>    stage(&#39;echo&#39;) {
<a id=__codelineno-21-47 name=__codelineno-21-47 href=#__codelineno-21-47></a>      steps {
<a id=__codelineno-21-48 name=__codelineno-21-48 href=#__codelineno-21-48></a>        container(name: &#39;date&#39;) {
<a id=__codelineno-21-49 name=__codelineno-21-49 href=#__codelineno-21-49></a>          sh &quot;&quot;&quot;
<a id=__codelineno-21-50 name=__codelineno-21-50 href=#__codelineno-21-50></a>            echo &#39;k8s is pod&#39;
<a id=__codelineno-21-51 name=__codelineno-21-51 href=#__codelineno-21-51></a>          &quot;&quot;&quot;
<a id=__codelineno-21-52 name=__codelineno-21-52 href=#__codelineno-21-52></a>        }
<a id=__codelineno-21-53 name=__codelineno-21-53 href=#__codelineno-21-53></a>      }
<a id=__codelineno-21-54 name=__codelineno-21-54 href=#__codelineno-21-54></a>    }
<a id=__codelineno-21-55 name=__codelineno-21-55 href=#__codelineno-21-55></a>    stage(&#39;kubectl&#39;) {
<a id=__codelineno-21-56 name=__codelineno-21-56 href=#__codelineno-21-56></a>      steps {
<a id=__codelineno-21-57 name=__codelineno-21-57 href=#__codelineno-21-57></a>        container(name: &#39;kubectl&#39;) {
<a id=__codelineno-21-58 name=__codelineno-21-58 href=#__codelineno-21-58></a>          sh &quot;&quot;&quot;
<a id=__codelineno-21-59 name=__codelineno-21-59 href=#__codelineno-21-59></a>            kubectl get pod -A  --kubeconfig $MY_KUBECONFIG
<a id=__codelineno-21-60 name=__codelineno-21-60 href=#__codelineno-21-60></a>          &quot;&quot;&quot;
<a id=__codelineno-21-61 name=__codelineno-21-61 href=#__codelineno-21-61></a>        }
<a id=__codelineno-21-62 name=__codelineno-21-62 href=#__codelineno-21-62></a>      }
<a id=__codelineno-21-63 name=__codelineno-21-63 href=#__codelineno-21-63></a>    }
<a id=__codelineno-21-64 name=__codelineno-21-64 href=#__codelineno-21-64></a>  }
<a id=__codelineno-21-65 name=__codelineno-21-65 href=#__codelineno-21-65></a>  }
</code></pre></div> <div class="admonition abstract"> <p class=admonition-title>Jenkins的pipeline实践之GitSCM参数配置项详解</p> <p><a href=https://cloud.tencent.com/developer/article/2017111>https://cloud.tencent.com/developer/article/2017111</a></p> </div> <p>超时设置与部署参数switch语句选择</p> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a>timeout(time: 1, unit: &#39;MINUTES&#39;) {
<a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a>  script {
<a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a>    env.deploy_option = input message: &#39;选择操作&#39;, ok: &#39;deploy&#39;,
<a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a>    parameters: [choice(name: &#39;deploy_option&#39;, choices: [&#39;deploy&#39;, &#39;rollback&#39;, &#39;redeploy&#39;], description: &#39;选择部署环境&#39;)]
<a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a>    switch(&quot;${env.deploy_option}&quot;){
<a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a>        case &#39;deploy&#39;:
<a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a>            println(&#39;1.deploy prd env&#39;)
<a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a>            break;
<a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a>        case &#39;rollback&#39;:
<a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a>            println(&#39;2.rollback env&#39;)
<a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a>            break;
<a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a>        case &#39;redeploy&#39;:
<a id=__codelineno-22-13 name=__codelineno-22-13 href=#__codelineno-22-13></a>            println(&#39;3.redeploy env&#39;)
<a id=__codelineno-22-14 name=__codelineno-22-14 href=#__codelineno-22-14></a>            break;
<a id=__codelineno-22-15 name=__codelineno-22-15 href=#__codelineno-22-15></a>        default:
<a id=__codelineno-22-16 name=__codelineno-22-16 href=#__codelineno-22-16></a>            println(&#39;error env&#39;)
<a id=__codelineno-22-17 name=__codelineno-22-17 href=#__codelineno-22-17></a>    }
<a id=__codelineno-22-18 name=__codelineno-22-18 href=#__codelineno-22-18></a>  }
<a id=__codelineno-22-19 name=__codelineno-22-19 href=#__codelineno-22-19></a>}
</code></pre></div> <p>docker的示例 <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a>pipeline {
<a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a>  agent none 
<a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a>  stages {
<a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a>    stage(&#39;Example Build&#39;) {
<a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a>      agent { docker &#39;maven:3-alpine&#39; } 
<a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a>      steps {
<a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a>        echo &#39;Hello, Maven&#39;
<a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a>        sh &#39;mvn --version&#39;
<a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a>      }
<a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a>    }
<a id=__codelineno-23-11 name=__codelineno-23-11 href=#__codelineno-23-11></a>    stage(&#39;Example Test&#39;) {
<a id=__codelineno-23-12 name=__codelineno-23-12 href=#__codelineno-23-12></a>      agent { docker &#39;openjdk:8-jre&#39; } 
<a id=__codelineno-23-13 name=__codelineno-23-13 href=#__codelineno-23-13></a>      steps {
<a id=__codelineno-23-14 name=__codelineno-23-14 href=#__codelineno-23-14></a>        echo &#39;Hello, JDK&#39;
<a id=__codelineno-23-15 name=__codelineno-23-15 href=#__codelineno-23-15></a>        sh &#39;java -version&#39;
<a id=__codelineno-23-16 name=__codelineno-23-16 href=#__codelineno-23-16></a>      }
<a id=__codelineno-23-17 name=__codelineno-23-17 href=#__codelineno-23-17></a>    }
<a id=__codelineno-23-18 name=__codelineno-23-18 href=#__codelineno-23-18></a>  }
<a id=__codelineno-23-19 name=__codelineno-23-19 href=#__codelineno-23-19></a>}
</code></pre></div></p> <h4 id=2-post>2. Post<a class=headerlink href=#2-post title="Permanent link">&para;</a></h4> <p>post 一般用于流水线结束后的进一步处理，比如错误通知等。</p> <p>post可以针对流水线不同的结果做出不同的处理，就像开发程序的错误处理，比如Python语言的try catch。post可以定义在Pipeline或stage中，目前支持以下post-condition：</p> <ol> <li>always：无论 Pipeline 或 stage 的完成状态如何，都允许运行该 post 中定义的指令；</li> <li>changed：只有当前 Pipeline 或 stage 的完成状态与它之前的运行不同时，才允许在该 post 部分运行该步骤；</li> <li>fixed：当本次 Pipeline 或 stage 成功，且上一次构建是失败或不稳定时，允许运行该 post 中定义的指令；</li> <li>regression：当本次 Pipeline 或 stage 的状态为失败、不稳定或终止，且上一次构建的 状态为成功时，允许运行该 post 中定义的指令；</li> <li>failure：只有当前 Pipeline 或 stage 的完成状态为失败（failure），才允许在 post 部分运行该步骤，通常这时在 Web 界面中显示为红色</li> <li>success：当前状态为成功（success），执行 post 步骤，通常在 Web 界面中显示为蓝色 或绿色</li> <li>unstable：当前状态为不稳定（unstable），执行 post 步骤，通常由于测试失败或代码 违规等造成，在 Web 界面中显示为黄色</li> <li>aborted：当前状态为终止（aborted），执行该 post 步骤，通常由于流水线被手动终止触发，这时在 Web 界面中显示为灰色；</li> <li>unsuccessful：当前状态不是 success 时，执行该 post 步骤；</li> <li>cleanup：无论 pipeline 或 stage 的完成状态如何，都允许运行该 post 中定义的指令。和 always 的区别在于，cleanup 会在其它执行之后执行。</li> </ol> <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a>pipeline {
<a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a>
<a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a>  .....
<a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a>
<a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a>  post {
<a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a>    always{
<a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a>      script{ println(&quot;流水线结束后，经常要做的事情&quot;) }
<a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a>    }
<a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a>
<a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a>    success{
<a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a>      script{ println(&quot;流水线成功后，要做的事情&quot;) }
<a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a>    }
<a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a>
<a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a>    failure{
<a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a>      script{ println(&quot;流水线失败后，要做的事情&quot;) }
<a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a>    }
<a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a>
<a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a>    failure{
<a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a>      script{ println(&quot;流水线取消后，要做的事情&quot;) }
<a id=__codelineno-24-20 name=__codelineno-24-20 href=#__codelineno-24-20></a>    }
<a id=__codelineno-24-21 name=__codelineno-24-21 href=#__codelineno-24-21></a>  }
<a id=__codelineno-24-22 name=__codelineno-24-22 href=#__codelineno-24-22></a>}
</code></pre></div> <p>示例</p> <p>一般情况下 post 部分放在流水线的底部，比如本实例，无论 stage 的完成状态如何，都会输出一条 I will always say Hello again!信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a>//Jenkinsfile (Declarative Pipeline)
<a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a>pipeline {
<a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a>  agent any
<a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a>  stages {
<a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a>    stage(&#39;Example1&#39;) {
<a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a>      steps {
<a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a>        echo &#39;Hello World1&#39;
<a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a>      }
<a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a>    }
<a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a>    stage(&#39;Example2&#39;) {
<a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a>      steps {
<a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a>        echo &#39;Hello World2&#39;
<a id=__codelineno-25-13 name=__codelineno-25-13 href=#__codelineno-25-13></a>      }
<a id=__codelineno-25-14 name=__codelineno-25-14 href=#__codelineno-25-14></a>    }
<a id=__codelineno-25-15 name=__codelineno-25-15 href=#__codelineno-25-15></a>  }
<a id=__codelineno-25-16 name=__codelineno-25-16 href=#__codelineno-25-16></a>  post {
<a id=__codelineno-25-17 name=__codelineno-25-17 href=#__codelineno-25-17></a>    always {
<a id=__codelineno-25-18 name=__codelineno-25-18 href=#__codelineno-25-18></a>      echo &#39;I will always say Hello again!&#39;
<a id=__codelineno-25-19 name=__codelineno-25-19 href=#__codelineno-25-19></a>    }
<a id=__codelineno-25-20 name=__codelineno-25-20 href=#__codelineno-25-20></a>  }
<a id=__codelineno-25-21 name=__codelineno-25-21 href=#__codelineno-25-21></a>}
</code></pre></div> <p>也可以将 post 写在 stage，下面示例表示 Example1 执行失败执行 post。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a>//Jenkinsfile (Declarative Pipeline)
<a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a>pipeline {
<a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a>  agent any
<a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a>  stages {
<a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a>    stage(&#39;Example1&#39;) {
<a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a>      steps {
<a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a>        sh &#39;ip a&#39;
<a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a>      }
<a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a>      post {
<a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a>        failure {
<a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a>          echo &#39;I will always say Hello again!&#39;
<a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a>        }
<a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a>      }
<a id=__codelineno-26-14 name=__codelineno-26-14 href=#__codelineno-26-14></a>    }
<a id=__codelineno-26-15 name=__codelineno-26-15 href=#__codelineno-26-15></a>  }
<a id=__codelineno-26-16 name=__codelineno-26-16 href=#__codelineno-26-16></a>}
</code></pre></div> <h4 id=3-stages>3. stages<a class=headerlink href=#3-stages title="Permanent link">&para;</a></h4> <p>在前文中，其实已经能看到一些对stages的定义，stages包含一个或多个stage指令，同时可以在stage的steps块中定义真正执行的指令。</p> <p>stages部分是流水线描述的大部分工作（work）的位置。建议stages至少包含一个stage指令，用于持续交付过程的某个离散的部分，比如构建、测试或部署。</p> <p>比如创建一个流水线，stages包含一个名为Example的stage，该stage执行echo 'Hello World'命令输出Hello World字符串：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a>//Jenkinsfile (Declarative Pipeline)
<a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a>pipeline {
<a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a>  agent any
<a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a>  stages {
<a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a>    stage(&#39;Example&#39;) {
<a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a>      steps {
<a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a>        echo &#39;Hello World&#39;
<a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a>      }
<a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a>    }
<a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a>  }
<a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a>}
</code></pre></div> <p>steps部分在给定的stage指令中执行一个或多个步骤，比如在steps中定义执行一条shell命令：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a>//Jenkinsfile (Declarative Pipeline)
<a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a>pipeline {
<a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a>  agent any
<a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a>  stages {
<a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a>    stage(&#39;Example&#39;) {
<a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a>      steps {
<a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a>        echo &#39;Hello World&#39;
<a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a>      }
<a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a>    }
<a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a>  }
<a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a>}
</code></pre></div> <p>或者也可以使用sh字段执行多条指令：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a>//Jenkinsfile (Declarative Pipeline)
<a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a>pipeline {
<a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a>  agent any
<a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a>  stages {
<a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a>    stage(&#39;Example&#39;) {
<a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a>      steps {
<a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a>        sh &quot;&quot;&quot;
<a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a>           echo &#39;Hello World1&#39;
<a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a>           echo &#39;Hello World2&#39;
<a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a>        &quot;&quot;&quot;
<a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a>      }
<a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a>    }
<a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a>  }
<a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a>}
</code></pre></div> <h3 id=32-directives>3.2 directives<a class=headerlink href=#32-directives title="Permanent link">&para;</a></h3> <p>directives可用于一些执行stage时的条件判断或预处理一些数据，和sections一致。directives不是一个关键字或指令，而是包含environment、options、parameters、triggers、stage、input、when等配置。</p> <h4 id=1-environment>1. environment<a class=headerlink href=#1-environment title="Permanent link">&para;</a></h4> <p>environment主要用于在流水线中配置一些环境变量，根据配置的位置决定环境变量的作用域。</p> <p>environment可以定义在pipeline中作为全局变量，也可以配置在stage中作为该stage的环境变量。</p> <p>该指令支持一个特殊的方法credentials()，该方法可用于在Jenkins环境中通过标识符访问预定义的凭证。对于类型为Secret Text的凭证，credentials()可以将该Secret中的文本内容赋值给环境变量。</p> <p>对于类型为标准的账号密码型的凭证，指定的环境变量为username和password，并且也会定义两个额外的环境变量，分别为MYVARNAME_USR和MYVARNAME_PSW。</p> <p>基本变量使用</p> <div class=highlight><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a>//示例
<a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a>pipeline {
<a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a>  agent any
<a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a>  environment {   //全局变量，会在所有stage中生效
<a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a>    NAME= &#39;zhangzhuo&#39;
<a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a>  }
<a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a>  stages {
<a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a>    stage(&#39;env1&#39;) {
<a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a>      environment { //定义在stage中的变量只会在当前stage生效，其他的stage不会生效
<a id=__codelineno-30-10 name=__codelineno-30-10 href=#__codelineno-30-10></a>        HARBOR = &#39;https://192.168.10.15&#39;
<a id=__codelineno-30-11 name=__codelineno-30-11 href=#__codelineno-30-11></a>      }
<a id=__codelineno-30-12 name=__codelineno-30-12 href=#__codelineno-30-12></a>      steps {
<a id=__codelineno-30-13 name=__codelineno-30-13 href=#__codelineno-30-13></a>        sh &quot;env&quot;
<a id=__codelineno-30-14 name=__codelineno-30-14 href=#__codelineno-30-14></a>      }
<a id=__codelineno-30-15 name=__codelineno-30-15 href=#__codelineno-30-15></a>    }
<a id=__codelineno-30-16 name=__codelineno-30-16 href=#__codelineno-30-16></a>    stage(&#39;env2&#39;) {
<a id=__codelineno-30-17 name=__codelineno-30-17 href=#__codelineno-30-17></a>      steps {
<a id=__codelineno-30-18 name=__codelineno-30-18 href=#__codelineno-30-18></a>        sh &quot;env&quot;
<a id=__codelineno-30-19 name=__codelineno-30-19 href=#__codelineno-30-19></a>      }
<a id=__codelineno-30-20 name=__codelineno-30-20 href=#__codelineno-30-20></a>    }
<a id=__codelineno-30-21 name=__codelineno-30-21 href=#__codelineno-30-21></a>  }
<a id=__codelineno-30-22 name=__codelineno-30-22 href=#__codelineno-30-22></a>}
</code></pre></div> <p>使用变量引用 secret 的凭证</p> <div class=highlight><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a>//这里使用k8s的kubeconfig文件示例
<a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a>pipeline {
<a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a>  agent any
<a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a>  environment {
<a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a>    KUBECONFIG = credentials(&#39;kubernetes-cluster&#39;)
<a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a>  }
<a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a>  stages {
<a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a>    stage(&#39;env&#39;) {
<a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a>      steps {
<a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a>        sh &quot;env&quot;  //默认情况下输出的变量内容会被加密
<a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a>      }
<a id=__codelineno-31-12 name=__codelineno-31-12 href=#__codelineno-31-12></a>    }
<a id=__codelineno-31-13 name=__codelineno-31-13 href=#__codelineno-31-13></a>  }
<a id=__codelineno-31-14 name=__codelineno-31-14 href=#__codelineno-31-14></a>}
</code></pre></div> <p>使用变量引用类型为标准的账号密码型的凭证</p> <p>这里使用 HARBOR 变量进行演示，默认情况下账号密码型的凭证会自动创建 3 个变量</p> <ul> <li>HARBOR_USR:会把凭证中 username 值赋值给这个变量</li> <li>HARBOR_PSW:会把凭证中 password 值赋值给这个变量</li> <li>HARBOR:默认情况下赋值的值为<code>usernamme:password</code></li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a>pipeline {
<a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a>  agent any
<a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a>  environment {
<a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a>    HARBOR = credentials(&#39;harbor-account&#39;)
<a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a>  }
<a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a>  stages {
<a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a>    stage(&#39;env&#39;) {
<a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a>      steps {
<a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a>        sh &quot;env&quot;
<a id=__codelineno-32-10 name=__codelineno-32-10 href=#__codelineno-32-10></a>      }
<a id=__codelineno-32-11 name=__codelineno-32-11 href=#__codelineno-32-11></a>    }
<a id=__codelineno-32-12 name=__codelineno-32-12 href=#__codelineno-32-12></a>  }
<a id=__codelineno-32-13 name=__codelineno-32-13 href=#__codelineno-32-13></a>}
</code></pre></div> <h4 id=2-options>2. options<a class=headerlink href=#2-options title="Permanent link">&para;</a></h4> <p>Jenkins 流水线支持很多内置指令，比如 retry 可以对失败的步骤进行重复执行 n 次，可以根据不同的指令实现不同的效果。比较常用的指令如下:</p> <ul> <li> <p>buildDiscarder：保留多少个流水线的构建记录，比如<code>options { buildDiscarder(logRotator(numToKeepStr: '1')) }</code>。</p> </li> <li> <p>disableConcurrentBuilds：禁止流水线并行执行，防止并行流水线同时访问共享资源导致流水线失 败,比如<code>options { disableConcurrentBuilds() }</code>。</p> </li> <li> <p>disableResume ：如果控制器重启，禁止流水线自动恢复。比如<code>options { disableResume() }</code>。</p> </li> <li> <p>newContainerPerStage：agent 为 docker 或 dockerfile 时，每个阶段将在同一个节点的新容器中运行，而不是所有的阶段都在同一个容器中运行。比如<code>options { newContainerPerStage () }</code>。</p> </li> <li> <p>quietPeriod：流水线静默期，也就是触发流水线后等待一会在执行。比如<code>options{ quietPeriod(30) }</code>。</p> </li> <li> <p>retry：流水线失败后重试次数，比如<code>options { retry(3) }</code>。</p> </li> <li> <p>timeout：设置流水线的超时时间，超过流水线时间，job 会自动终止。如果不加 unit 参数默认为 1 分,比如<code>options{ timeout(time: 1, unit: 'HOURS') }</code>。</p> </li> <li> <p>skipDefaultCheckout：跳过checkout scm语句，比如<code>options { skipDefaultCheckout () }</code>。</p> </li> <li> <p>timestamps：为控制台输出时间戳, 比如<code>options { timestamps() }</code>。</p> </li> <li> <p>checkoutToSubdirectory 指定代码检出到 <code>$WORKSPACE</code>的子目录。</p> </li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a>  options {
<a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a>        checkoutToSubdirectory(&#39;testdir&#39;)
<a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a>  }
</code></pre></div> <p>常用汇总：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a>options {
<a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a>        timestamps()
<a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a>        disableConcurrentBuilds()
<a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a>        timeout(time: 10, unit: &#39;MINUTES&#39;)
<a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a>        buildDiscarder(logRotator(numToKeepStr: &#39;10&#39;))
<a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a>}
</code></pre></div> <p>配置示例如下，只需要添加options字段即可：</p> <p>定义在 pipeline 中</p> <div class=highlight><pre><span></span><code><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a>pipeline {
<a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a>  agent any
<a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a>  options {
<a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a>    timeout(time: 1, unit: &#39;HOURS&#39;)  //超时时间1小时，如果不加unit参数默认为1分
<a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a>    timestamps()                     //所有输出每行都会打印时间戳
<a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a>    buildDiscarder(logRotator(numToKeepStr: &#39;3&#39;)) //保留三个历史构建版本
<a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a>    quietPeriod(10)  //静默10s
<a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a>    retry(3)    //流水线失败后重试次数
<a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a>  }
<a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a>  stages {
<a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a>    stage(&#39;env1&#39;) {
<a id=__codelineno-35-12 name=__codelineno-35-12 href=#__codelineno-35-12></a>      options {
<a id=__codelineno-35-13 name=__codelineno-35-13 href=#__codelineno-35-13></a>        timeout(time: 5, unit: &#39;MINUTES&#39;)
<a id=__codelineno-35-14 name=__codelineno-35-14 href=#__codelineno-35-14></a>        retry(3)
<a id=__codelineno-35-15 name=__codelineno-35-15 href=#__codelineno-35-15></a>        timestamps()
<a id=__codelineno-35-16 name=__codelineno-35-16 href=#__codelineno-35-16></a>      }
<a id=__codelineno-35-17 name=__codelineno-35-17 href=#__codelineno-35-17></a>      steps {
<a id=__codelineno-35-18 name=__codelineno-35-18 href=#__codelineno-35-18></a>        sh &quot;env&quot;
<a id=__codelineno-35-19 name=__codelineno-35-19 href=#__codelineno-35-19></a>        sleep 2
<a id=__codelineno-35-20 name=__codelineno-35-20 href=#__codelineno-35-20></a>      }
<a id=__codelineno-35-21 name=__codelineno-35-21 href=#__codelineno-35-21></a>    }
<a id=__codelineno-35-22 name=__codelineno-35-22 href=#__codelineno-35-22></a>    stage(&#39;env2&#39;) {
<a id=__codelineno-35-23 name=__codelineno-35-23 href=#__codelineno-35-23></a>      steps {
<a id=__codelineno-35-24 name=__codelineno-35-24 href=#__codelineno-35-24></a>        sh &quot;env&quot;
<a id=__codelineno-35-25 name=__codelineno-35-25 href=#__codelineno-35-25></a>      }
<a id=__codelineno-35-26 name=__codelineno-35-26 href=#__codelineno-35-26></a>    }
<a id=__codelineno-35-27 name=__codelineno-35-27 href=#__codelineno-35-27></a>  }
<a id=__codelineno-35-28 name=__codelineno-35-28 href=#__codelineno-35-28></a>}
</code></pre></div> <p>定义在 stage 中</p> <p>Option 除了写在 Pipeline 顶层，还可以写在 stage 中，但是写在 stage 中的 option 仅支持 retry、 timeout、timestamps，或者是和 stage 相关的声明式选项，比如 skipDefaultCheckout。处于 stage 级别的 options 写法如下</p> <div class=highlight><pre><span></span><code><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a>pipeline {
<a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a>  agent any
<a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a>  stages {
<a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a>    stage(&#39;env1&#39;) {
<a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a>      options {   //定义在这里这对这个stage生效
<a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a>        timeout(time: 2, unit: &#39;SECONDS&#39;) //超时时间2秒
<a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a>        timestamps()                     //所有输出每行都会打印时间戳
<a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a>        retry(3)    //流水线失败后重试次数
<a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a>      }
<a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a>      steps {
<a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a>        sh &quot;env &amp;&amp; sleep 2&quot;
<a id=__codelineno-36-12 name=__codelineno-36-12 href=#__codelineno-36-12></a>      }
<a id=__codelineno-36-13 name=__codelineno-36-13 href=#__codelineno-36-13></a>    }
<a id=__codelineno-36-14 name=__codelineno-36-14 href=#__codelineno-36-14></a>    stage(&#39;env2&#39;) {
<a id=__codelineno-36-15 name=__codelineno-36-15 href=#__codelineno-36-15></a>      steps {
<a id=__codelineno-36-16 name=__codelineno-36-16 href=#__codelineno-36-16></a>        sh &quot;env&quot;
<a id=__codelineno-36-17 name=__codelineno-36-17 href=#__codelineno-36-17></a>      }
<a id=__codelineno-36-18 name=__codelineno-36-18 href=#__codelineno-36-18></a>    }
<a id=__codelineno-36-19 name=__codelineno-36-19 href=#__codelineno-36-19></a>  }
<a id=__codelineno-36-20 name=__codelineno-36-20 href=#__codelineno-36-20></a>}
</code></pre></div> <h4 id=3-parameters>3. parameters<a class=headerlink href=#3-parameters title="Permanent link">&para;</a></h4> <p>parameters提供了一个用户在触发流水线时应该提供的参数列表，这些用户指定参数的值可以通过params对象提供给流水线的step（步骤）。</p> <p>目前支持的参数类型如下：</p> <ul> <li>string：字符串类型的参数。</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a>parameters { string(name:&#39;DEPLOY_ENV&#39;, defaultValue:&#39;staging&#39;, description: &#39;&#39;) }
<a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a>
<a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a>// 表示定义一个名为DEPLOY_ENV的字符型变量，默认值为staging。
</code></pre></div> <ul> <li>text：文本型参数，一般用于定义多行文本内容的变量。</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a>parameters {text(name:&#39;DEPLOY_TEXT&#39;, defaultValue:&#39;One\nTwo\nThree\n&#39;,
<a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a>description: &#39;&#39;)}
<a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a>
<a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a>// 表示定义一个名为DEPLOY_TEXT的变量，默认值是&#39;One\nTwo\nThree\n&#39;
</code></pre></div> <ul> <li>booleanParam：布尔型参数。</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a>parameters {booleanParam(name:  &#39;DEBUG_BUILD&#39;,defaultValue:  true,description: &#39;&#39;)}
</code></pre></div> <ul> <li>choice：选择型参数，一般用于给定几个可选的值，然后选择其中一个进行赋值。</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a>parameters { choice(name: &#39;CHOICES&#39;,choices: [&#39;one&#39;, &#39;two&#39;, &#39;three&#39;], description: &#39;&#39;) }
<a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a>
<a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a>// 表示定义一个名为CHOICES的变量，可选的值为one、two、three。
</code></pre></div> <ul> <li>password：密码型变量，一般用于定义敏感型变量，在 Jenkins 控制台会输出为*。</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a>parameters { password(name: &#39;PASSWORD&#39;,defaultValue: &#39;SECRET&#39;, description: &#39;A secret password&#39;)}
<a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a>
<a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a>// 表示定义一个名为PASSWORD的变量，其默认值为SECRE?。
</code></pre></div> <p><strong>插件 Parameters</strong></p> <ul> <li>imageTag：镜像 tag，需要安装 Image Tag Parameter 插件后使用</li> <li>gitParameter：获取 git 仓库分支，需要 Git Parameter 插件后使用</li> </ul> <p><strong>示例</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a>pipeline {
<a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a>  agent any
<a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a>  parameters {
<a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a>    string(name: &#39;DEPLOY_ENV&#39;, defaultValue:  &#39;staging&#39;, description: &#39;1&#39;)   //执行构建时需要手动配置字符串类型参数，之后赋值给变量
<a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a>    text(name:  &#39;DEPLOY_TEXT&#39;, defaultValue: &#39;One\nTwo\nThree\n&#39;, description: &#39;2&#39;)  //执行构建时需要提供文本参数，之后赋值给变量
<a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a>    booleanParam(name: &#39;DEBUG_BUILD&#39;,  defaultValue: true, description: &#39;3&#39;)   //布尔型参数
<a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a>    choice(name: &#39;CHOICES&#39;, choices: [&#39;one&#39;, &#39;two&#39;, &#39;three&#39;], description: &#39;4&#39;)  //选择形式列表参数
<a id=__codelineno-42-8 name=__codelineno-42-8 href=#__codelineno-42-8></a>    password(name: &#39;PASSWORD&#39;, defaultValue: &#39;SECRET&#39;, description: &#39;A  secret password&#39;)  //密码类型参数，会进行加密
<a id=__codelineno-42-9 name=__codelineno-42-9 href=#__codelineno-42-9></a>    imageTag(name: &#39;DOCKER_IMAGE&#39;, description: &#39;&#39;, image: &#39;kubernetes/kubectl&#39;, filter: &#39;.*&#39;, defaultTag: &#39;&#39;, registry: &#39;https://192.168.10.15&#39;, credentialId: &#39;harbor-account&#39;, tagOrder: &#39;NATURAL&#39;)   //获取镜像名称与tag
<a id=__codelineno-42-10 name=__codelineno-42-10 href=#__codelineno-42-10></a>    gitParameter(branch: &#39;&#39;, branchFilter: &#39;origin/(.*)&#39;, defaultValue: &#39;&#39;, description: &#39;Branch for build and deploy&#39;, name: &#39;BRANCH&#39;, quickFilterEnabled: false, selectedValue: &#39;NONE&#39;, sortMode: &#39;NONE&#39;,  tagFilter: &#39;*&#39;, type: &#39;PT_BRANCH&#39;)
<a id=__codelineno-42-11 name=__codelineno-42-11 href=#__codelineno-42-11></a>  }  //获取git仓库分支列表，必须有git引用
<a id=__codelineno-42-12 name=__codelineno-42-12 href=#__codelineno-42-12></a>  stages {
<a id=__codelineno-42-13 name=__codelineno-42-13 href=#__codelineno-42-13></a>    stage(&#39;env1&#39;) {
<a id=__codelineno-42-14 name=__codelineno-42-14 href=#__codelineno-42-14></a>      steps {
<a id=__codelineno-42-15 name=__codelineno-42-15 href=#__codelineno-42-15></a>        sh &quot;env&quot;
<a id=__codelineno-42-16 name=__codelineno-42-16 href=#__codelineno-42-16></a>      }
<a id=__codelineno-42-17 name=__codelineno-42-17 href=#__codelineno-42-17></a>    }
<a id=__codelineno-42-18 name=__codelineno-42-18 href=#__codelineno-42-18></a>    stage(&#39;git&#39;) {
<a id=__codelineno-42-19 name=__codelineno-42-19 href=#__codelineno-42-19></a>      steps {
<a id=__codelineno-42-20 name=__codelineno-42-20 href=#__codelineno-42-20></a>        git branch: &quot;$BRANCH&quot;, credentialsId: &#39;gitlab-key&#39;, url: &#39;git@192.168.10.14:root/env.git&#39;   //使用gitParameter，必须有这个
<a id=__codelineno-42-21 name=__codelineno-42-21 href=#__codelineno-42-21></a>      }
<a id=__codelineno-42-22 name=__codelineno-42-22 href=#__codelineno-42-22></a>    }
<a id=__codelineno-42-23 name=__codelineno-42-23 href=#__codelineno-42-23></a>  }
<a id=__codelineno-42-24 name=__codelineno-42-24 href=#__codelineno-42-24></a>}
</code></pre></div> <div class="admonition example"> <p class=admonition-title>参考文献</p> <p><a href=https://www.cnblogs.com/Dev0ps/p/11740803.html>Jenkins指定tag发布到k8s环境</a></p> <p><a href=https://www.cnblogs.com/Dev0ps/p/9125232.html>Jenkins系列之六——拉取指定branch或tag </a></p> </div> <h4 id=4-triggers>4. triggers<a class=headerlink href=#4-triggers title="Permanent link">&para;</a></h4> <p>在pipeline中可以用triggers实现自动触发流水线执行任务，可以通过Webhook、Cron、pollSCM和upstream等方式触发流水线。</p> <p>假如某个流水线构建的时间比较长，或者某个流水线需要定期在某个时 间段执行构建，可以使用cron配置触发器，比如周一到周五每隔4个小时执行一次：</p> <p><strong>Cron</strong></p> <p>定时构建假如某个流水线构建的时间比较长，或者某个流水线需要定期在某个时间段执行构建，可以 使用 cron 配置触发器，比如周一到周五每隔四个小时执行一次</p> <p>注意：H 的意思不是 HOURS 的意思，而是 Hash 的缩写。主要为了解决多个流水线在同一时间同时运行带来的系统负载压力。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a>pipeline {
<a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a>  agent any
<a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a>  triggers {
<a id=__codelineno-43-4 name=__codelineno-43-4 href=#__codelineno-43-4></a>    cron(&#39;H */4 * * 1-5&#39;)   //周一到周五每隔四个小时执行一次
<a id=__codelineno-43-5 name=__codelineno-43-5 href=#__codelineno-43-5></a>    cron(&#39;H/12 * * * *&#39;)   //每隔12分钟执行一次
<a id=__codelineno-43-6 name=__codelineno-43-6 href=#__codelineno-43-6></a>    cron(&#39;H * * * *&#39;)   //每隔1小时执行一次
<a id=__codelineno-43-7 name=__codelineno-43-7 href=#__codelineno-43-7></a>  }
<a id=__codelineno-43-8 name=__codelineno-43-8 href=#__codelineno-43-8></a>  stages {
<a id=__codelineno-43-9 name=__codelineno-43-9 href=#__codelineno-43-9></a>    stage(&#39;Example&#39;) {
<a id=__codelineno-43-10 name=__codelineno-43-10 href=#__codelineno-43-10></a>      steps {
<a id=__codelineno-43-11 name=__codelineno-43-11 href=#__codelineno-43-11></a>        echo &#39;Hello World&#39;
<a id=__codelineno-43-12 name=__codelineno-43-12 href=#__codelineno-43-12></a>      }
<a id=__codelineno-43-13 name=__codelineno-43-13 href=#__codelineno-43-13></a>    }
<a id=__codelineno-43-14 name=__codelineno-43-14 href=#__codelineno-43-14></a>  }
<a id=__codelineno-43-15 name=__codelineno-43-15 href=#__codelineno-43-15></a>}
</code></pre></div> <p>使用cron字段可以定期执行流水线，如果代码更新，想要重新触发流水线，可以使用pollSCM字段：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a>pipeline {
<a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a>  agent any
<a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a>  triggers {
<a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a>    POLLscm(&#39;H */4 * * 1-5&#39;)
<a id=__codelineno-44-5 name=__codelineno-44-5 href=#__codelineno-44-5></a>  }
<a id=__codelineno-44-6 name=__codelineno-44-6 href=#__codelineno-44-6></a>  stages {
<a id=__codelineno-44-7 name=__codelineno-44-7 href=#__codelineno-44-7></a>    stage(&#39;Example&#39;) {
<a id=__codelineno-44-8 name=__codelineno-44-8 href=#__codelineno-44-8></a>      steps {
<a id=__codelineno-44-9 name=__codelineno-44-9 href=#__codelineno-44-9></a>        echo &#39;Hello World&#39;
<a id=__codelineno-44-10 name=__codelineno-44-10 href=#__codelineno-44-10></a>      }
<a id=__codelineno-44-11 name=__codelineno-44-11 href=#__codelineno-44-11></a>    }
<a id=__codelineno-44-12 name=__codelineno-44-12 href=#__codelineno-44-12></a>  }
<a id=__codelineno-44-13 name=__codelineno-44-13 href=#__codelineno-44-13></a>}
</code></pre></div> <p><strong>Upstream</strong></p> <p>Upstream 可以根据上游 job 的执行结果决定是否触发该流水线。比如当 job1 或 job2 执行成功时触发该流水线</p> <p>目前支持的状态有 SUCCESS、UNSTABLE、FAILURE、NOT_BUILT、ABORTED 等。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a>pipeline {
<a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a>  agent any
<a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a>  triggers {
<a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a>    upstream(upstreamProjects: &#39;env&#39;, threshold: hudson.model.Result.SUCCESS)  //当env构建成功时构建这个流水线
<a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a>  }
<a id=__codelineno-45-6 name=__codelineno-45-6 href=#__codelineno-45-6></a>  stages {
<a id=__codelineno-45-7 name=__codelineno-45-7 href=#__codelineno-45-7></a>    stage(&#39;Example&#39;) {
<a id=__codelineno-45-8 name=__codelineno-45-8 href=#__codelineno-45-8></a>      steps {
<a id=__codelineno-45-9 name=__codelineno-45-9 href=#__codelineno-45-9></a>        echo &#39;Hello World&#39;
<a id=__codelineno-45-10 name=__codelineno-45-10 href=#__codelineno-45-10></a>      }
<a id=__codelineno-45-11 name=__codelineno-45-11 href=#__codelineno-45-11></a>    }
<a id=__codelineno-45-12 name=__codelineno-45-12 href=#__codelineno-45-12></a>  }
<a id=__codelineno-45-13 name=__codelineno-45-13 href=#__codelineno-45-13></a>}
</code></pre></div> <h4 id=5-stage>5. stage<a class=headerlink href=#5-stage title="Permanent link">&para;</a></h4> <p>stage指令位于stages下，包含一个steps、一个agent（可选）或其他特定的stage指令。</p> <p>流水线中实际执行的指令都在stage中配置，所以在流水线中，至少有一个stage。配置示例如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a>pipeline {
<a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a>  agent any
<a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a>  stages {
<a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a>    stage(&#39;Example&#39;) {
<a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a>      steps {
<a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a>        echo &#39;Hello World&#39;
<a id=__codelineno-46-7 name=__codelineno-46-7 href=#__codelineno-46-7></a>      }
<a id=__codelineno-46-8 name=__codelineno-46-8 href=#__codelineno-46-8></a>    }
<a id=__codelineno-46-9 name=__codelineno-46-9 href=#__codelineno-46-9></a>  }
<a id=__codelineno-46-10 name=__codelineno-46-10 href=#__codelineno-46-10></a>}
</code></pre></div> <h4 id=6-input>6. Input<a class=headerlink href=#6-input title="Permanent link">&para;</a></h4> <p>Input 字段可以实现在流水线中进行交互式操作，比如选择要部署的环境、是否继续执行某个阶段等。</p> <p><strong>配置 Input 支持以下选项</strong></p> <ul> <li>message：必选，需要用户进行 input 的提示信息，比如：“是否发布到生产环境？”；</li> <li>id：可选，input 的标识符，默认为 stage 的名称；</li> <li>ok：可选，确认按钮的显示信息，比如：“确定”、“允许”；</li> <li>submitter：可选，允许提交 input 操作的用户或组的名称，如果为空，任何登录用户均可提交 input；</li> <li>parameters：提供一个参数列表供 input 使用。</li> </ul> <p>假如需要配置一个提示消息为“还继续么”、确认按钮为“继续”、提供一个 PERSON 的变量的参数，并且只能由登录用户为 alice 和 bob 提交的 input 流水线</p> <div class=highlight><pre><span></span><code><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a>pipeline {
<a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a>  agent any
<a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a>  stages {
<a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a>    stage(&#39;Example&#39;) {
<a id=__codelineno-47-5 name=__codelineno-47-5 href=#__codelineno-47-5></a>      input {
<a id=__codelineno-47-6 name=__codelineno-47-6 href=#__codelineno-47-6></a>        message &quot;还继续么?&quot;
<a id=__codelineno-47-7 name=__codelineno-47-7 href=#__codelineno-47-7></a>        ok &quot;继续&quot;
<a id=__codelineno-47-8 name=__codelineno-47-8 href=#__codelineno-47-8></a>        submitter &quot;alice,bob&quot;
<a id=__codelineno-47-9 name=__codelineno-47-9 href=#__codelineno-47-9></a>        parameters {
<a id=__codelineno-47-10 name=__codelineno-47-10 href=#__codelineno-47-10></a>          string(name: &#39;PERSON&#39;, defaultValue: &#39;Mr Jenkins&#39;, description: &#39;Who should I say hello to?&#39;)
<a id=__codelineno-47-11 name=__codelineno-47-11 href=#__codelineno-47-11></a>        }
<a id=__codelineno-47-12 name=__codelineno-47-12 href=#__codelineno-47-12></a>      }
<a id=__codelineno-47-13 name=__codelineno-47-13 href=#__codelineno-47-13></a>      steps {
<a id=__codelineno-47-14 name=__codelineno-47-14 href=#__codelineno-47-14></a>        echo &quot;Hello, ${PERSON}, nice to meet you.&quot;
<a id=__codelineno-47-15 name=__codelineno-47-15 href=#__codelineno-47-15></a>      }
<a id=__codelineno-47-16 name=__codelineno-47-16 href=#__codelineno-47-16></a>    }
<a id=__codelineno-47-17 name=__codelineno-47-17 href=#__codelineno-47-17></a>  }
<a id=__codelineno-47-18 name=__codelineno-47-18 href=#__codelineno-47-18></a>}
</code></pre></div> <h4 id=7-when>7. when<a class=headerlink href=#7-when title="Permanent link">&para;</a></h4> <p>When 指令允许流水线根据给定的条件决定是否应该执行该 stage，when 指令必须包含至少 一个条件。如果 when 包含多个条件，所有的子条件必须都返回 True，stage 才能执行。</p> <p>When 也可以结合 not、allOf、anyOf 语法达到更灵活的条件匹配。</p> <p><strong>目前比较常用的内置条件如下</strong></p> <ul> <li> <p>branch：当正在构建的分支与给定的分支匹配时，执行这个 stage，例如when { branch'master' }。注意，branch 只适用于多分支流水线。</p> </li> <li> <p>changelog：匹配提交的 changeLog 决定是否构建，例如:<code>when { changelog '.*^\\[DEPENDENCY\\] .+$' }</code></p> </li> <li> <p>environment：当指定的环境变量和给定的变量匹配时，执行这个 stage，例如：when { environment name: 'DEPLOY_TO', value: 'production' }。</p> </li> <li> <p>equals：当期望值和实际值相同时，执行这个 stage，例如：when { equals expected: 2, actual: currentBuild.number }。</p> </li> <li> <p>expression：当指定的 Groovy 表达式评估为 True，执行这个 stage，例如：when { expression { return params.DEBUG_BUILD } }。</p> </li> <li> <p>tag：如果 TAG_NAME 的值和给定的条件匹配，执行这个 stage，例如：when { tag "release-*" }。</p> </li> <li> <p>not：当嵌套条件出现错误时，执行这个 stage，必须包含一个条件，例如：when { not { branch 'master' } }。</p> </li> <li> <p>allOf：当所有的嵌套条件都正确时，执行这个 stage，必须包含至少一个条件，例如：when { allOf { branch 'master'; environment name: 'DEPLOY_TO', value: 'production' } }。</p> </li> <li> <p>anyOf：当至少有一个嵌套条件为 True 时，执行这个 stage，例如：when { anyOf { branch 'master'; branch 'staging' } }。</p> </li> </ul> <p><strong>示例：当分支为<code>main</code>时执行Example Deploy步骤</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a>pipeline {
<a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a>  agent any
<a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a>  stages {
<a id=__codelineno-48-4 name=__codelineno-48-4 href=#__codelineno-48-4></a>    stage(&#39;Example Build&#39;) {
<a id=__codelineno-48-5 name=__codelineno-48-5 href=#__codelineno-48-5></a>      steps {
<a id=__codelineno-48-6 name=__codelineno-48-6 href=#__codelineno-48-6></a>        echo &#39;Hello World&#39;
<a id=__codelineno-48-7 name=__codelineno-48-7 href=#__codelineno-48-7></a>      }
<a id=__codelineno-48-8 name=__codelineno-48-8 href=#__codelineno-48-8></a>    }
<a id=__codelineno-48-9 name=__codelineno-48-9 href=#__codelineno-48-9></a>    stage(&#39;Example Deploy&#39;) {
<a id=__codelineno-48-10 name=__codelineno-48-10 href=#__codelineno-48-10></a>      when {
<a id=__codelineno-48-11 name=__codelineno-48-11 href=#__codelineno-48-11></a>        branch &#39;main&#39; //多分支流水线，分支为才会执行。
<a id=__codelineno-48-12 name=__codelineno-48-12 href=#__codelineno-48-12></a>      }
<a id=__codelineno-48-13 name=__codelineno-48-13 href=#__codelineno-48-13></a>      steps {
<a id=__codelineno-48-14 name=__codelineno-48-14 href=#__codelineno-48-14></a>        echo &#39;Deploying&#39;
<a id=__codelineno-48-15 name=__codelineno-48-15 href=#__codelineno-48-15></a>      }
<a id=__codelineno-48-16 name=__codelineno-48-16 href=#__codelineno-48-16></a>    }
<a id=__codelineno-48-17 name=__codelineno-48-17 href=#__codelineno-48-17></a>  }
<a id=__codelineno-48-18 name=__codelineno-48-18 href=#__codelineno-48-18></a>}
</code></pre></div> <p>也可以同时配置多个条件，比如分支是<code>production</code>，而且<code>DEPLOY_TO</code>变量的值为main时，才执行Example Deploy</p> <div class=highlight><pre><span></span><code><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a>pipeline {
<a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a>  agent any
<a id=__codelineno-49-3 name=__codelineno-49-3 href=#__codelineno-49-3></a>  environment {
<a id=__codelineno-49-4 name=__codelineno-49-4 href=#__codelineno-49-4></a>    DEPLOY_TO = &quot;main&quot;
<a id=__codelineno-49-5 name=__codelineno-49-5 href=#__codelineno-49-5></a>  }
<a id=__codelineno-49-6 name=__codelineno-49-6 href=#__codelineno-49-6></a>  stages {
<a id=__codelineno-49-7 name=__codelineno-49-7 href=#__codelineno-49-7></a>    stage(&#39;Example Deploy&#39;) {
<a id=__codelineno-49-8 name=__codelineno-49-8 href=#__codelineno-49-8></a>      when {
<a id=__codelineno-49-9 name=__codelineno-49-9 href=#__codelineno-49-9></a>        branch &#39;production&#39;
<a id=__codelineno-49-10 name=__codelineno-49-10 href=#__codelineno-49-10></a>        environment name: &#39;DEPLOY_TO&#39;, value: &#39;main&#39;
<a id=__codelineno-49-11 name=__codelineno-49-11 href=#__codelineno-49-11></a>      }
<a id=__codelineno-49-12 name=__codelineno-49-12 href=#__codelineno-49-12></a>      steps {
<a id=__codelineno-49-13 name=__codelineno-49-13 href=#__codelineno-49-13></a>        echo &#39;Deploying&#39;
<a id=__codelineno-49-14 name=__codelineno-49-14 href=#__codelineno-49-14></a>      }
<a id=__codelineno-49-15 name=__codelineno-49-15 href=#__codelineno-49-15></a>    }
<a id=__codelineno-49-16 name=__codelineno-49-16 href=#__codelineno-49-16></a>  }
<a id=__codelineno-49-17 name=__codelineno-49-17 href=#__codelineno-49-17></a>}
</code></pre></div> <p>也可以使用<code>anyOf</code>进行匹配其中一个条件即可，比如分支为<code>main</code>或<code>DEPLOY_TO</code>为<code>main</code>或<code>master</code>时执行Deploy</p> <div class=highlight><pre><span></span><code><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a>pipeline {
<a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a>  agent any
<a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a>  stages {
<a id=__codelineno-50-4 name=__codelineno-50-4 href=#__codelineno-50-4></a>    stage(&#39;Example Deploy&#39;) {
<a id=__codelineno-50-5 name=__codelineno-50-5 href=#__codelineno-50-5></a>      when {
<a id=__codelineno-50-6 name=__codelineno-50-6 href=#__codelineno-50-6></a>        anyOf {
<a id=__codelineno-50-7 name=__codelineno-50-7 href=#__codelineno-50-7></a>          branch &#39;main&#39;
<a id=__codelineno-50-8 name=__codelineno-50-8 href=#__codelineno-50-8></a>          environment name: &#39;DEPLOY_TO&#39;, value: &#39;main&#39;
<a id=__codelineno-50-9 name=__codelineno-50-9 href=#__codelineno-50-9></a>          environment name: &#39;DEPLOY_TO&#39;, value: &#39;master&#39;
<a id=__codelineno-50-10 name=__codelineno-50-10 href=#__codelineno-50-10></a>        }
<a id=__codelineno-50-11 name=__codelineno-50-11 href=#__codelineno-50-11></a>      }
<a id=__codelineno-50-12 name=__codelineno-50-12 href=#__codelineno-50-12></a>      steps {
<a id=__codelineno-50-13 name=__codelineno-50-13 href=#__codelineno-50-13></a>        echo &#39;Deploying&#39;
<a id=__codelineno-50-14 name=__codelineno-50-14 href=#__codelineno-50-14></a>      }
<a id=__codelineno-50-15 name=__codelineno-50-15 href=#__codelineno-50-15></a>    }
<a id=__codelineno-50-16 name=__codelineno-50-16 href=#__codelineno-50-16></a>  }
<a id=__codelineno-50-17 name=__codelineno-50-17 href=#__codelineno-50-17></a>}
</code></pre></div> <p>也可以使用 expression 进行正则匹配，比如当<code>BRANCH_NAME</code>为<code>main</code>或<code>maste</code>，并且<code>DEPLOY_TO</code>为<code>master</code>或<code>main</code>时才会执行Example Deploy</p> <div class=highlight><pre><span></span><code><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a>pipeline {
<a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a>  agent any
<a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a>  stages {
<a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a>    stage(&#39;Example Deploy&#39;) {
<a id=__codelineno-51-5 name=__codelineno-51-5 href=#__codelineno-51-5></a>      when {
<a id=__codelineno-51-6 name=__codelineno-51-6 href=#__codelineno-51-6></a>        expression { BRANCH_NAME ==~ /(main|master)/ }
<a id=__codelineno-51-7 name=__codelineno-51-7 href=#__codelineno-51-7></a>        anyOf {
<a id=__codelineno-51-8 name=__codelineno-51-8 href=#__codelineno-51-8></a>          environment name: &#39;DEPLOY_TO&#39;, value: &#39;main&#39;
<a id=__codelineno-51-9 name=__codelineno-51-9 href=#__codelineno-51-9></a>          environment name: &#39;DEPLOY_TO&#39;, value: &#39;master&#39;
<a id=__codelineno-51-10 name=__codelineno-51-10 href=#__codelineno-51-10></a>        }
<a id=__codelineno-51-11 name=__codelineno-51-11 href=#__codelineno-51-11></a>      }
<a id=__codelineno-51-12 name=__codelineno-51-12 href=#__codelineno-51-12></a>      steps {
<a id=__codelineno-51-13 name=__codelineno-51-13 href=#__codelineno-51-13></a>        echo &#39;Deploying&#39;
<a id=__codelineno-51-14 name=__codelineno-51-14 href=#__codelineno-51-14></a>      }
<a id=__codelineno-51-15 name=__codelineno-51-15 href=#__codelineno-51-15></a>    }
<a id=__codelineno-51-16 name=__codelineno-51-16 href=#__codelineno-51-16></a>  }
<a id=__codelineno-51-17 name=__codelineno-51-17 href=#__codelineno-51-17></a>}
</code></pre></div> <p>默认情况下，如果定义了某个 stage 的 agent，在进入该 stage 的 agent 后，该 stage 的 when 条件才会被评估，但是可以通过一些选项更改此选项。</p> <p>比如在进入stage的agent 前评估when， 可以使用 beforeAgent，当when为true时才进行该 stage</p> <p><strong>目前支持的前置条件如下</strong></p> <ul> <li>beforeAgent：如果 beforeAgent 为 true，则会先评估 when 条件。在 when 条件为 true 时，才会进入该 stage</li> <li>beforeInput：如果 beforeInput 为 true，则会先评估 when 条件。在 when 条件为 true 时，才会进入到 input 阶段；</li> <li>beforeOptions：如果 beforeInput 为 true，则会先评估 when 条件。在 when 条件为 true 时，才会进入到 options 阶段；</li> </ul> <p><strong>beforeOptions 优先级大于 beforeInput 大于 beforeAgent</strong></p> <p>示例1：配置一个beforeAgent。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a>pipeline {
<a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a>  agent none
<a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a>  stages {
<a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a>    stage(&#39;Example Build&#39;) {
<a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a>      steps {
<a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a>        echo &#39;Hello World&#39;
<a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a>      }
<a id=__codelineno-52-8 name=__codelineno-52-8 href=#__codelineno-52-8></a>    }
<a id=__codelineno-52-9 name=__codelineno-52-9 href=#__codelineno-52-9></a>    stage(&#39;Example Deploy&#39;) {
<a id=__codelineno-52-10 name=__codelineno-52-10 href=#__codelineno-52-10></a>      when {
<a id=__codelineno-52-11 name=__codelineno-52-11 href=#__codelineno-52-11></a>        beforeAgent true
<a id=__codelineno-52-12 name=__codelineno-52-12 href=#__codelineno-52-12></a>        branch &#39;production&#39;
<a id=__codelineno-52-13 name=__codelineno-52-13 href=#__codelineno-52-13></a>      }
<a id=__codelineno-52-14 name=__codelineno-52-14 href=#__codelineno-52-14></a>      steps {
<a id=__codelineno-52-15 name=__codelineno-52-15 href=#__codelineno-52-15></a>        echo &#39;Deploying&#39;
<a id=__codelineno-52-16 name=__codelineno-52-16 href=#__codelineno-52-16></a>      }
<a id=__codelineno-52-17 name=__codelineno-52-17 href=#__codelineno-52-17></a>    }
<a id=__codelineno-52-18 name=__codelineno-52-18 href=#__codelineno-52-18></a>  }
<a id=__codelineno-52-19 name=__codelineno-52-19 href=#__codelineno-52-19></a>}
</code></pre></div> <p>示例2：配置一个beforeInput。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a>pipeline {
<a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a>  agent none
<a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a>  stages {
<a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a>    stage(&#39;Example Build&#39;) {
<a id=__codelineno-53-5 name=__codelineno-53-5 href=#__codelineno-53-5></a>      steps {
<a id=__codelineno-53-6 name=__codelineno-53-6 href=#__codelineno-53-6></a>        echo &#39;Hello World&#39;
<a id=__codelineno-53-7 name=__codelineno-53-7 href=#__codelineno-53-7></a>      }
<a id=__codelineno-53-8 name=__codelineno-53-8 href=#__codelineno-53-8></a>    }
<a id=__codelineno-53-9 name=__codelineno-53-9 href=#__codelineno-53-9></a>    stage(&#39;Example Deploy&#39;) {
<a id=__codelineno-53-10 name=__codelineno-53-10 href=#__codelineno-53-10></a>      when {
<a id=__codelineno-53-11 name=__codelineno-53-11 href=#__codelineno-53-11></a>        beforeInput true
<a id=__codelineno-53-12 name=__codelineno-53-12 href=#__codelineno-53-12></a>        branch &#39;production&#39;
<a id=__codelineno-53-13 name=__codelineno-53-13 href=#__codelineno-53-13></a>      }
<a id=__codelineno-53-14 name=__codelineno-53-14 href=#__codelineno-53-14></a>      input {
<a id=__codelineno-53-15 name=__codelineno-53-15 href=#__codelineno-53-15></a>        message &quot;Deploy to production?&quot;
<a id=__codelineno-53-16 name=__codelineno-53-16 href=#__codelineno-53-16></a>        id &quot;simple-input&quot;
<a id=__codelineno-53-17 name=__codelineno-53-17 href=#__codelineno-53-17></a>      }
<a id=__codelineno-53-18 name=__codelineno-53-18 href=#__codelineno-53-18></a>      steps {
<a id=__codelineno-53-19 name=__codelineno-53-19 href=#__codelineno-53-19></a>        echo &#39;Deploying&#39;
<a id=__codelineno-53-20 name=__codelineno-53-20 href=#__codelineno-53-20></a>      }
<a id=__codelineno-53-21 name=__codelineno-53-21 href=#__codelineno-53-21></a>    }
<a id=__codelineno-53-22 name=__codelineno-53-22 href=#__codelineno-53-22></a>  }
<a id=__codelineno-53-23 name=__codelineno-53-23 href=#__codelineno-53-23></a>}
</code></pre></div> <p>示例3：配置一个beforeOptions。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a>pipeline {
<a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a>  agent none
<a id=__codelineno-54-3 name=__codelineno-54-3 href=#__codelineno-54-3></a>  stages {
<a id=__codelineno-54-4 name=__codelineno-54-4 href=#__codelineno-54-4></a>    stage(&#39;Example Build&#39;) {
<a id=__codelineno-54-5 name=__codelineno-54-5 href=#__codelineno-54-5></a>      steps {
<a id=__codelineno-54-6 name=__codelineno-54-6 href=#__codelineno-54-6></a>        echo &#39;Hello World&#39;
<a id=__codelineno-54-7 name=__codelineno-54-7 href=#__codelineno-54-7></a>      }
<a id=__codelineno-54-8 name=__codelineno-54-8 href=#__codelineno-54-8></a>    }
<a id=__codelineno-54-9 name=__codelineno-54-9 href=#__codelineno-54-9></a>    stage(&#39;Example Deploy&#39;) {
<a id=__codelineno-54-10 name=__codelineno-54-10 href=#__codelineno-54-10></a>      when {
<a id=__codelineno-54-11 name=__codelineno-54-11 href=#__codelineno-54-11></a>        beforeOptions true
<a id=__codelineno-54-12 name=__codelineno-54-12 href=#__codelineno-54-12></a>        branch &#39;testing&#39;
<a id=__codelineno-54-13 name=__codelineno-54-13 href=#__codelineno-54-13></a>      }
<a id=__codelineno-54-14 name=__codelineno-54-14 href=#__codelineno-54-14></a>      options {
<a id=__codelineno-54-15 name=__codelineno-54-15 href=#__codelineno-54-15></a>        lock label: &#39;testing-deploy-envs&#39;,quantity: 1, variable: &#39;deployEnv&#39;    
<a id=__codelineno-54-16 name=__codelineno-54-16 href=#__codelineno-54-16></a>        }
<a id=__codelineno-54-17 name=__codelineno-54-17 href=#__codelineno-54-17></a>      steps {
<a id=__codelineno-54-18 name=__codelineno-54-18 href=#__codelineno-54-18></a>        echo &#39;Deploying&#39;
<a id=__codelineno-54-19 name=__codelineno-54-19 href=#__codelineno-54-19></a>      }
<a id=__codelineno-54-20 name=__codelineno-54-20 href=#__codelineno-54-20></a>    }
<a id=__codelineno-54-21 name=__codelineno-54-21 href=#__codelineno-54-21></a>  }
<a id=__codelineno-54-22 name=__codelineno-54-22 href=#__codelineno-54-22></a>}
</code></pre></div> <p>steps包含一个完整的script步骤列表，是流水线真正指定操作的位置， 比如构建命令、部署命令等。script步骤需要scripted-pipeline块并在声明式流水线中执行，对于大多数用例来说，script步骤并不是必要的</p> <p>可以在steps中添加script进行for循环，示例如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a>pipeline {
<a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a>  agent any
<a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a>  stages {
<a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a>    stage(&#39;Example&#39;) {
<a id=__codelineno-55-5 name=__codelineno-55-5 href=#__codelineno-55-5></a>      steps {
<a id=__codelineno-55-6 name=__codelineno-55-6 href=#__codelineno-55-6></a>        echo &#39;Hello World&#39;
<a id=__codelineno-55-7 name=__codelineno-55-7 href=#__codelineno-55-7></a>
<a id=__codelineno-55-8 name=__codelineno-55-8 href=#__codelineno-55-8></a>        script {
<a id=__codelineno-55-9 name=__codelineno-55-9 href=#__codelineno-55-9></a>            def browsers = [&#39;chrome&#39;,&#39;firefox&#39;]
<a id=__codelineno-55-10 name=__codelineno-55-10 href=#__codelineno-55-10></a>            for (int i =0; i &lt; browsers.size(); ++i) {
<a id=__codelineno-55-11 name=__codelineno-55-11 href=#__codelineno-55-11></a>                echo &quot;Testing the ${browsers[i]} browsers &quot;
<a id=__codelineno-55-12 name=__codelineno-55-12 href=#__codelineno-55-12></a>            }
<a id=__codelineno-55-13 name=__codelineno-55-13 href=#__codelineno-55-13></a>         }   
<a id=__codelineno-55-14 name=__codelineno-55-14 href=#__codelineno-55-14></a>       }
<a id=__codelineno-55-15 name=__codelineno-55-15 href=#__codelineno-55-15></a>     }
<a id=__codelineno-55-16 name=__codelineno-55-16 href=#__codelineno-55-16></a>  } 
<a id=__codelineno-55-17 name=__codelineno-55-17 href=#__codelineno-55-17></a>}
</code></pre></div> <h3 id=33-parallel>3.3 parallel<a class=headerlink href=#33-parallel title="Permanent link">&para;</a></h3> <p>在声明式流水线中可以使用 Parallel 字段，即可很方便的实现并发构建，比如对分支 A、B、 C 进行并行处理</p> <div class=highlight><pre><span></span><code><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a>pipeline {
<a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a>  agent any
<a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a>  stages {
<a id=__codelineno-56-4 name=__codelineno-56-4 href=#__codelineno-56-4></a>    stage(&#39;Non-Parallel Stage&#39;) {
<a id=__codelineno-56-5 name=__codelineno-56-5 href=#__codelineno-56-5></a>      steps {
<a id=__codelineno-56-6 name=__codelineno-56-6 href=#__codelineno-56-6></a>        echo &#39;This stage will be executed first.&#39;
<a id=__codelineno-56-7 name=__codelineno-56-7 href=#__codelineno-56-7></a>      }
<a id=__codelineno-56-8 name=__codelineno-56-8 href=#__codelineno-56-8></a>    }
<a id=__codelineno-56-9 name=__codelineno-56-9 href=#__codelineno-56-9></a>    stage(&#39;Parallel Stage&#39;) {
<a id=__codelineno-56-10 name=__codelineno-56-10 href=#__codelineno-56-10></a>      failFast true         //表示其中只要有一个分支构建执行失败，就直接推出不等待其他分支构建
<a id=__codelineno-56-11 name=__codelineno-56-11 href=#__codelineno-56-11></a>      parallel {
<a id=__codelineno-56-12 name=__codelineno-56-12 href=#__codelineno-56-12></a>        stage(&#39;Branch A&#39;) {
<a id=__codelineno-56-13 name=__codelineno-56-13 href=#__codelineno-56-13></a>          steps {
<a id=__codelineno-56-14 name=__codelineno-56-14 href=#__codelineno-56-14></a>            echo &quot;On Branch A&quot;
<a id=__codelineno-56-15 name=__codelineno-56-15 href=#__codelineno-56-15></a>          }
<a id=__codelineno-56-16 name=__codelineno-56-16 href=#__codelineno-56-16></a>        }
<a id=__codelineno-56-17 name=__codelineno-56-17 href=#__codelineno-56-17></a>        stage(&#39;Branch B&#39;) {
<a id=__codelineno-56-18 name=__codelineno-56-18 href=#__codelineno-56-18></a>          steps {
<a id=__codelineno-56-19 name=__codelineno-56-19 href=#__codelineno-56-19></a>            echo &quot;On Branch B&quot;
<a id=__codelineno-56-20 name=__codelineno-56-20 href=#__codelineno-56-20></a>          }
<a id=__codelineno-56-21 name=__codelineno-56-21 href=#__codelineno-56-21></a>        }
<a id=__codelineno-56-22 name=__codelineno-56-22 href=#__codelineno-56-22></a>        stage(&#39;Branch C&#39;) {
<a id=__codelineno-56-23 name=__codelineno-56-23 href=#__codelineno-56-23></a>          stages {
<a id=__codelineno-56-24 name=__codelineno-56-24 href=#__codelineno-56-24></a>            stage(&#39;Nested 1&#39;) {
<a id=__codelineno-56-25 name=__codelineno-56-25 href=#__codelineno-56-25></a>              steps {
<a id=__codelineno-56-26 name=__codelineno-56-26 href=#__codelineno-56-26></a>                echo &quot;In stage Nested 1 within Branch C&quot;
<a id=__codelineno-56-27 name=__codelineno-56-27 href=#__codelineno-56-27></a>              }
<a id=__codelineno-56-28 name=__codelineno-56-28 href=#__codelineno-56-28></a>            }
<a id=__codelineno-56-29 name=__codelineno-56-29 href=#__codelineno-56-29></a>            stage(&#39;Nested 2&#39;) {
<a id=__codelineno-56-30 name=__codelineno-56-30 href=#__codelineno-56-30></a>              steps {
<a id=__codelineno-56-31 name=__codelineno-56-31 href=#__codelineno-56-31></a>               echo &quot;In stage Nested 2 within Branch C&quot;
<a id=__codelineno-56-32 name=__codelineno-56-32 href=#__codelineno-56-32></a>              }
<a id=__codelineno-56-33 name=__codelineno-56-33 href=#__codelineno-56-33></a>            }
<a id=__codelineno-56-34 name=__codelineno-56-34 href=#__codelineno-56-34></a>          }
<a id=__codelineno-56-35 name=__codelineno-56-35 href=#__codelineno-56-35></a>        }
<a id=__codelineno-56-36 name=__codelineno-56-36 href=#__codelineno-56-36></a>      }
<a id=__codelineno-56-37 name=__codelineno-56-37 href=#__codelineno-56-37></a>    }
<a id=__codelineno-56-38 name=__codelineno-56-38 href=#__codelineno-56-38></a>  }
<a id=__codelineno-56-39 name=__codelineno-56-39 href=#__codelineno-56-39></a>}
</code></pre></div> <p>设置failFast为true表示并行流水线中任意一个stage出现错误，其他stage也会立即终止。也可以通过options配置在全局：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a>pipeline {
<a id=__codelineno-57-2 name=__codelineno-57-2 href=#__codelineno-57-2></a>  agent any
<a id=__codelineno-57-3 name=__codelineno-57-3 href=#__codelineno-57-3></a>  options {
<a id=__codelineno-57-4 name=__codelineno-57-4 href=#__codelineno-57-4></a>    parallelsAlwaysFailFast()
<a id=__codelineno-57-5 name=__codelineno-57-5 href=#__codelineno-57-5></a>  }
<a id=__codelineno-57-6 name=__codelineno-57-6 href=#__codelineno-57-6></a>  stages {
<a id=__codelineno-57-7 name=__codelineno-57-7 href=#__codelineno-57-7></a>    stage(&#39;Non-Parallel Stage&#39;) {
<a id=__codelineno-57-8 name=__codelineno-57-8 href=#__codelineno-57-8></a>      steps {
<a id=__codelineno-57-9 name=__codelineno-57-9 href=#__codelineno-57-9></a>        echo &#39;This stage will be executed first.&#39;
<a id=__codelineno-57-10 name=__codelineno-57-10 href=#__codelineno-57-10></a>      }
<a id=__codelineno-57-11 name=__codelineno-57-11 href=#__codelineno-57-11></a>    }
<a id=__codelineno-57-12 name=__codelineno-57-12 href=#__codelineno-57-12></a>    stage(&#39;Parallel Stage&#39;) {
<a id=__codelineno-57-13 name=__codelineno-57-13 href=#__codelineno-57-13></a>      parallel {
<a id=__codelineno-57-14 name=__codelineno-57-14 href=#__codelineno-57-14></a>        stage(&#39;Branch A&#39;) {
<a id=__codelineno-57-15 name=__codelineno-57-15 href=#__codelineno-57-15></a>          steps {
<a id=__codelineno-57-16 name=__codelineno-57-16 href=#__codelineno-57-16></a>            echo &quot;On Branch A&quot;
<a id=__codelineno-57-17 name=__codelineno-57-17 href=#__codelineno-57-17></a>          }
<a id=__codelineno-57-18 name=__codelineno-57-18 href=#__codelineno-57-18></a>        }
<a id=__codelineno-57-19 name=__codelineno-57-19 href=#__codelineno-57-19></a>        stage(&#39;Branch B&#39;) {
<a id=__codelineno-57-20 name=__codelineno-57-20 href=#__codelineno-57-20></a>          steps {
<a id=__codelineno-57-21 name=__codelineno-57-21 href=#__codelineno-57-21></a>            echo &quot;On Branch B&quot;
<a id=__codelineno-57-22 name=__codelineno-57-22 href=#__codelineno-57-22></a>          }
<a id=__codelineno-57-23 name=__codelineno-57-23 href=#__codelineno-57-23></a>        }
<a id=__codelineno-57-24 name=__codelineno-57-24 href=#__codelineno-57-24></a>        stage(&#39;Branch C&#39;) {
<a id=__codelineno-57-25 name=__codelineno-57-25 href=#__codelineno-57-25></a>          stages {
<a id=__codelineno-57-26 name=__codelineno-57-26 href=#__codelineno-57-26></a>            stage(&#39;Nested 1&#39;) {
<a id=__codelineno-57-27 name=__codelineno-57-27 href=#__codelineno-57-27></a>              steps {
<a id=__codelineno-57-28 name=__codelineno-57-28 href=#__codelineno-57-28></a>                echo &quot;In stage Nested 1 within Branch C&quot;
<a id=__codelineno-57-29 name=__codelineno-57-29 href=#__codelineno-57-29></a>              }
<a id=__codelineno-57-30 name=__codelineno-57-30 href=#__codelineno-57-30></a>            }
<a id=__codelineno-57-31 name=__codelineno-57-31 href=#__codelineno-57-31></a>            stage(&#39;Nested 2&#39;) {
<a id=__codelineno-57-32 name=__codelineno-57-32 href=#__codelineno-57-32></a>              steps {
<a id=__codelineno-57-33 name=__codelineno-57-33 href=#__codelineno-57-33></a>               echo &quot;In stage Nested 2 within Branch C&quot;
<a id=__codelineno-57-34 name=__codelineno-57-34 href=#__codelineno-57-34></a>              }
<a id=__codelineno-57-35 name=__codelineno-57-35 href=#__codelineno-57-35></a>            }
<a id=__codelineno-57-36 name=__codelineno-57-36 href=#__codelineno-57-36></a>          }
<a id=__codelineno-57-37 name=__codelineno-57-37 href=#__codelineno-57-37></a>        }
<a id=__codelineno-57-38 name=__codelineno-57-38 href=#__codelineno-57-38></a>      }
<a id=__codelineno-57-39 name=__codelineno-57-39 href=#__codelineno-57-39></a>    }
<a id=__codelineno-57-40 name=__codelineno-57-40 href=#__codelineno-57-40></a>  }
<a id=__codelineno-57-41 name=__codelineno-57-41 href=#__codelineno-57-41></a>}
</code></pre></div> <p>parallel并行</p> <div class=highlight><pre><span></span><code><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a> stage(&#39;Parallel Stage&#39;) {
<a id=__codelineno-58-2 name=__codelineno-58-2 href=#__codelineno-58-2></a>    when {
<a id=__codelineno-58-3 name=__codelineno-58-3 href=#__codelineno-58-3></a>        branch &#39;master&#39;
<a id=__codelineno-58-4 name=__codelineno-58-4 href=#__codelineno-58-4></a>    }
<a id=__codelineno-58-5 name=__codelineno-58-5 href=#__codelineno-58-5></a>    failFast true
<a id=__codelineno-58-6 name=__codelineno-58-6 href=#__codelineno-58-6></a>    parallel {
<a id=__codelineno-58-7 name=__codelineno-58-7 href=#__codelineno-58-7></a>        stage(&#39;Branch A&#39;) {
<a id=__codelineno-58-8 name=__codelineno-58-8 href=#__codelineno-58-8></a>            agent {
<a id=__codelineno-58-9 name=__codelineno-58-9 href=#__codelineno-58-9></a>                label &quot;for-branch-a&quot;
<a id=__codelineno-58-10 name=__codelineno-58-10 href=#__codelineno-58-10></a>            }
<a id=__codelineno-58-11 name=__codelineno-58-11 href=#__codelineno-58-11></a>            steps {
<a id=__codelineno-58-12 name=__codelineno-58-12 href=#__codelineno-58-12></a>                echo &quot;On Branch A&quot;
<a id=__codelineno-58-13 name=__codelineno-58-13 href=#__codelineno-58-13></a>            }
<a id=__codelineno-58-14 name=__codelineno-58-14 href=#__codelineno-58-14></a>        }
<a id=__codelineno-58-15 name=__codelineno-58-15 href=#__codelineno-58-15></a>        stage(&#39;Branch B&#39;) {
<a id=__codelineno-58-16 name=__codelineno-58-16 href=#__codelineno-58-16></a>            agent {
<a id=__codelineno-58-17 name=__codelineno-58-17 href=#__codelineno-58-17></a>                label &quot;for-branch-b&quot;
<a id=__codelineno-58-18 name=__codelineno-58-18 href=#__codelineno-58-18></a>            }
<a id=__codelineno-58-19 name=__codelineno-58-19 href=#__codelineno-58-19></a>            steps {
<a id=__codelineno-58-20 name=__codelineno-58-20 href=#__codelineno-58-20></a>                echo &quot;On Branch B&quot;
<a id=__codelineno-58-21 name=__codelineno-58-21 href=#__codelineno-58-21></a>            }
<a id=__codelineno-58-22 name=__codelineno-58-22 href=#__codelineno-58-22></a>        }
<a id=__codelineno-58-23 name=__codelineno-58-23 href=#__codelineno-58-23></a>    }
<a id=__codelineno-58-24 name=__codelineno-58-24 href=#__codelineno-58-24></a>}
</code></pre></div> <h2 id=4-jenkinsfile的使用>4. Jenkinsfile的使用<a class=headerlink href=#4-jenkinsfile的使用 title="Permanent link">&para;</a></h2> <p>前面讲过流水线支持两种语法，即声明式和脚本式，这两种语法都支持构建持续交付流水线，并且都可以用来在Web UI或Jenkinsfile中定义流水 线，不过通常将Jenkinsfile放置于代码仓库中（当然也可以放在单独的代码仓库中进行管理）。</p> <p>创建一个Jenkinsfile并将其放置于代码仓库中，有以下好处：</p> <ul> <li>方便对流水线上的代码进行复查/迭代。</li> <li>对管道进行审计跟踪。</li> <li>流水线真正的源代码能够被项目的多个成员查看和编辑。</li> </ul> <p><a href=https://www.soulchild.cn/post/684864836/ >Jenkins pipeline 基础语法详解</a></p> <h3 id=41-环境变量>4.1 环境变量<a class=headerlink href=#41-环境变量 title="Permanent link">&para;</a></h3> <h4 id=1-静态变量>1. 静态变量<a class=headerlink href=#1-静态变量 title="Permanent link">&para;</a></h4> <p>Jenkins 有许多内置变量可以直接在 Jenkinsfile 中使用，可以通过 <code>JENKINS_URL/pipeline/syntax/globals#env</code> 获取完整列表。目前比较常用的环境变量如下</p> <ul> <li>BUILD_ID：当前构建的 ID，与 Jenkins 版本 1.597+中的 BUILD_NUMBER 完全相同</li> <li>BUILD_NUMBER：当前构建的 ID，和 BUILD_ID 一致</li> <li>BUILD_TAG：用来标识构建的版本号，格式为：<code>jenkins-${JOB_NAME}-${BUILD_NUMBER}</code>， 可以对产物进行命名，比如生产的 jar 包名字、镜像的 TAG 等；</li> <li>BUILD_URL：本次构建的完整 URL，比如：<a href=http://buildserver/jenkins/job/MyJobName/17/%EF%BC%9B>http://buildserver/jenkins/job/MyJobName/17/%EF%BC%9B</a></li> <li>JOB_NAME：本次构建的项目名称</li> <li>NODE_NAME：当前构建节点的名称；</li> <li>JENKINS_URL：Jenkins 完整的 URL，需要在 SystemConfiguration 设置；</li> <li>WORKSPACE：执行构建的工作目录。</li> </ul> <p>示例如果一个流水线名称为<code>print_env</code>，第 2 次构建，各个变量的值。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a>BUILD_ID：2
<a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a>BUILD_NUMBER：2
<a id=__codelineno-59-3 name=__codelineno-59-3 href=#__codelineno-59-3></a>BUILD_TAG：jenkins-print_env-2
<a id=__codelineno-59-4 name=__codelineno-59-4 href=#__codelineno-59-4></a>BUILD_URL：http://192.168.10.16:8080/job/print_env/2/
<a id=__codelineno-59-5 name=__codelineno-59-5 href=#__codelineno-59-5></a>JOB_NAME：print_env
<a id=__codelineno-59-6 name=__codelineno-59-6 href=#__codelineno-59-6></a>NODE_NAME：built-in
<a id=__codelineno-59-7 name=__codelineno-59-7 href=#__codelineno-59-7></a>JENKINS_URL：http://192.168.10.16:8080/
<a id=__codelineno-59-8 name=__codelineno-59-8 href=#__codelineno-59-8></a>WORKSPACE：/bitnami/jenkins/home/workspace/print_env
</code></pre></div> <p>上述变量会保存在一个 Map 中，可以使用 env.BUILD_ID 或 env.JENKINS_URL 引用某个内置变量</p> <div class=highlight><pre><span></span><code><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a>pipeline {
<a id=__codelineno-60-2 name=__codelineno-60-2 href=#__codelineno-60-2></a>  agent any
<a id=__codelineno-60-3 name=__codelineno-60-3 href=#__codelineno-60-3></a>  stages {
<a id=__codelineno-60-4 name=__codelineno-60-4 href=#__codelineno-60-4></a>    stage(&#39;print env&#39;) {
<a id=__codelineno-60-5 name=__codelineno-60-5 href=#__codelineno-60-5></a>      parallel {
<a id=__codelineno-60-6 name=__codelineno-60-6 href=#__codelineno-60-6></a>        stage(&#39;BUILD_ID&#39;) {
<a id=__codelineno-60-7 name=__codelineno-60-7 href=#__codelineno-60-7></a>          steps {
<a id=__codelineno-60-8 name=__codelineno-60-8 href=#__codelineno-60-8></a>            echo &quot;$env.BUILD_ID&quot;
<a id=__codelineno-60-9 name=__codelineno-60-9 href=#__codelineno-60-9></a>          }
<a id=__codelineno-60-10 name=__codelineno-60-10 href=#__codelineno-60-10></a>        }
<a id=__codelineno-60-11 name=__codelineno-60-11 href=#__codelineno-60-11></a>        stage(&#39;BUILD_NUMBER&#39;) {
<a id=__codelineno-60-12 name=__codelineno-60-12 href=#__codelineno-60-12></a>          steps {
<a id=__codelineno-60-13 name=__codelineno-60-13 href=#__codelineno-60-13></a>            echo &quot;$env.BUILD_NUMBER&quot;
<a id=__codelineno-60-14 name=__codelineno-60-14 href=#__codelineno-60-14></a>          }
<a id=__codelineno-60-15 name=__codelineno-60-15 href=#__codelineno-60-15></a>        }
<a id=__codelineno-60-16 name=__codelineno-60-16 href=#__codelineno-60-16></a>        stage(&#39;BUILD_TAG&#39;) {
<a id=__codelineno-60-17 name=__codelineno-60-17 href=#__codelineno-60-17></a>          steps {
<a id=__codelineno-60-18 name=__codelineno-60-18 href=#__codelineno-60-18></a>            echo &quot;$env.BUILD_TAG&quot;
<a id=__codelineno-60-19 name=__codelineno-60-19 href=#__codelineno-60-19></a>          }
<a id=__codelineno-60-20 name=__codelineno-60-20 href=#__codelineno-60-20></a>        }
<a id=__codelineno-60-21 name=__codelineno-60-21 href=#__codelineno-60-21></a>      }
<a id=__codelineno-60-22 name=__codelineno-60-22 href=#__codelineno-60-22></a>    }
<a id=__codelineno-60-23 name=__codelineno-60-23 href=#__codelineno-60-23></a>  }
<a id=__codelineno-60-24 name=__codelineno-60-24 href=#__codelineno-60-24></a>}
</code></pre></div> <p>pipeline中的变量：</p> <p>首先你要先理解pipeline可以用groovy语法来编写，而groovy是一门编程语言。所有的编程语言也都有各自的变量定义方式，这就容易让大家产生疑惑的地方，pipeline中可以有多种写法。</p> <p><div class=highlight><pre><span></span><code><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a>def name = &quot;devops&quot;
<a id=__codelineno-61-2 name=__codelineno-61-2 href=#__codelineno-61-2></a>String name = &quot;devops&quot;
</code></pre></div> 两种写法是一样的，def可以自动推导出变量类型，而String这种写法是精确这个变量是一个字符串类型的。</p> <p>如果你再Jenkins图形界面设置了参数化构建没那么这些参数也变成了Jenkins全局变量，可以使用与Jenkins内置变量相同的引用方式。</p> <p>如果某个stage定义的变量默认是局部变量，在后续的stage中可能语法引用，所以如果需要引用最好定义为全局变量。</p> <p>全局变量的定义方式：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a>env.name = &quot;devops&quot;
</code></pre></div> <p>引用方式： <code>"${env.name}"</code></p> <p>总之变量的定义无处不在，如果定义全局变量就用<code>env.变量名</code>的方式定义。</p> <h4 id=2-动态变量>2. 动态变量<a class=headerlink href=#2-动态变量 title="Permanent link">&para;</a></h4> <p>动态变量是根据某个指令的结果进行动态赋值，变量的值根据指令的执行结果而不同。如下所示</p> <ul> <li>returnStdout：将命令的执行结果赋值给变量，比如下述的命令返回的是 clang，此时 CC 的值为“clang”。</li> <li>returnStatus：将命令的执行状态赋值给变量，比如下述命令的执行状态为 1，此时 EXIT_STATUS 的值为 1。</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a>//Jenkinsfile (Declarative Pipeline)
<a id=__codelineno-63-2 name=__codelineno-63-2 href=#__codelineno-63-2></a>pipeline {
<a id=__codelineno-63-3 name=__codelineno-63-3 href=#__codelineno-63-3></a>  agent any
<a id=__codelineno-63-4 name=__codelineno-63-4 href=#__codelineno-63-4></a>  environment {
<a id=__codelineno-63-5 name=__codelineno-63-5 href=#__codelineno-63-5></a>    // 使用 returnStdout
<a id=__codelineno-63-6 name=__codelineno-63-6 href=#__codelineno-63-6></a>    CC = &quot;&quot;&quot;${sh(
<a id=__codelineno-63-7 name=__codelineno-63-7 href=#__codelineno-63-7></a>         returnStdout: true,
<a id=__codelineno-63-8 name=__codelineno-63-8 href=#__codelineno-63-8></a>         script: &#39;echo -n &quot;clang&quot;&#39;   //如果使用shell命令的echo赋值变量最好加-n取消换行
<a id=__codelineno-63-9 name=__codelineno-63-9 href=#__codelineno-63-9></a>         )}&quot;&quot;&quot;
<a id=__codelineno-63-10 name=__codelineno-63-10 href=#__codelineno-63-10></a>
<a id=__codelineno-63-11 name=__codelineno-63-11 href=#__codelineno-63-11></a>    // 使用 returnStatus
<a id=__codelineno-63-12 name=__codelineno-63-12 href=#__codelineno-63-12></a>    EXIT_STATUS = &quot;&quot;&quot;${sh(
<a id=__codelineno-63-13 name=__codelineno-63-13 href=#__codelineno-63-13></a>         returnStatus: true,
<a id=__codelineno-63-14 name=__codelineno-63-14 href=#__codelineno-63-14></a>         script: &#39;exit 1&#39;
<a id=__codelineno-63-15 name=__codelineno-63-15 href=#__codelineno-63-15></a>         )}&quot;&quot;&quot;
<a id=__codelineno-63-16 name=__codelineno-63-16 href=#__codelineno-63-16></a>  }
<a id=__codelineno-63-17 name=__codelineno-63-17 href=#__codelineno-63-17></a>  stages {
<a id=__codelineno-63-18 name=__codelineno-63-18 href=#__codelineno-63-18></a>    stage(&#39;Example&#39;) {
<a id=__codelineno-63-19 name=__codelineno-63-19 href=#__codelineno-63-19></a>      environment {
<a id=__codelineno-63-20 name=__codelineno-63-20 href=#__codelineno-63-20></a>        DEBUG_FLAGS = &#39;-g&#39;
<a id=__codelineno-63-21 name=__codelineno-63-21 href=#__codelineno-63-21></a>      }
<a id=__codelineno-63-22 name=__codelineno-63-22 href=#__codelineno-63-22></a>      steps {
<a id=__codelineno-63-23 name=__codelineno-63-23 href=#__codelineno-63-23></a>        sh &#39;printenv&#39;
<a id=__codelineno-63-24 name=__codelineno-63-24 href=#__codelineno-63-24></a>      }
<a id=__codelineno-63-25 name=__codelineno-63-25 href=#__codelineno-63-25></a>    }
<a id=__codelineno-63-26 name=__codelineno-63-26 href=#__codelineno-63-26></a>  }
<a id=__codelineno-63-27 name=__codelineno-63-27 href=#__codelineno-63-27></a>}
</code></pre></div> <ul> <li> <p>必须在管道的顶层设置agent。如果agent设置none，则此操作将失败。</p> </li> <li> <p>使用returnStout时，将在返回的字符串后面附加一个尾随空格。使用.trim()删除此项。</p> </li> </ul> <h4 id=3-jenkins内置变量>3. Jenkins内置变量<a class=headerlink href=#3-jenkins内置变量 title="Permanent link">&para;</a></h4> <p>在pipeline执行时，Jenkins通过一个名为env的全局变量，将Jenkins内置环境变量暴露出来。其使用方法有多种，示例如下: <div class=highlight><pre><span></span><code><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a>pipeline {
<a id=__codelineno-64-2 name=__codelineno-64-2 href=#__codelineno-64-2></a>  agent any
<a id=__codelineno-64-3 name=__codelineno-64-3 href=#__codelineno-64-3></a>  stages {
<a id=__codelineno-64-4 name=__codelineno-64-4 href=#__codelineno-64-4></a>    stage(&#39;debug-列出当前流水线的所有环境变量) {
<a id=__codelineno-64-5 name=__codelineno-64-5 href=#__codelineno-64-5></a>      setps {
<a id=__codelineno-64-6 name=__codelineno-64-6 href=#__codelineno-64-6></a>        sh &quot;printenv | sort&quot;
<a id=__codelineno-64-7 name=__codelineno-64-7 href=#__codelineno-64-7></a>      }
<a id=__codelineno-64-8 name=__codelineno-64-8 href=#__codelineno-64-8></a>    }
<a id=__codelineno-64-9 name=__codelineno-64-9 href=#__codelineno-64-9></a>    stage(&#39;Example&#39;) {
<a id=__codelineno-64-10 name=__codelineno-64-10 href=#__codelineno-64-10></a>      steps {
<a id=__codelineno-64-11 name=__codelineno-64-11 href=#__codelineno-64-11></a>         echo &quot;Running ${env.BUILDNUMBER} on ${env.JENKINS_URL}&quot; # 方法1
<a id=__codelineno-64-12 name=__codelineno-64-12 href=#__codelineno-64-12></a>         echo &quot;Running $env.BUILDNUMBER on $env.JENKINS_URL&quot;  # 方法2
<a id=__codelineno-64-13 name=__codelineno-64-13 href=#__codelineno-64-13></a>         echo &quot;Running ${BUILDNUMBER} on ${JENKINS_URL}&quot;   # 方法3 简写版本不推荐，难排查
<a id=__codelineno-64-14 name=__codelineno-64-14 href=#__codelineno-64-14></a>      }
<a id=__codelineno-64-15 name=__codelineno-64-15 href=#__codelineno-64-15></a>    }
<a id=__codelineno-64-16 name=__codelineno-64-16 href=#__codelineno-64-16></a>  }
<a id=__codelineno-64-17 name=__codelineno-64-17 href=#__codelineno-64-17></a>}
</code></pre></div></p> <p>默认env的属性可以直接在pipeline中引用。所以以上方法都是合法的。但是不推荐方法三，因为出现变量冲突时，非常难查问题。</p> <p>那么，env变量都有哪些可用属性呢? 通过访问<code>&lt;Jenkins master的地址&gt;/pipeline-syntax/globals#env</code>来获取完整列表。 在列表中，当一个变量被声明为"For a multibranch project"时，代表只有多分支项目才会有此变量。</p> <h4 id=4-自定义变量>4. 自定义变量<a class=headerlink href=#4-自定义变量 title="Permanent link">&para;</a></h4> <p>1.pipeline提供的environment指令中定义 <div class=highlight><pre><span></span><code><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a>pipeline {
<a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a>    agent any
<a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a>    environment {
<a id=__codelineno-65-4 name=__codelineno-65-4 href=#__codelineno-65-4></a>        // 覆盖默认的PATH变量值
<a id=__codelineno-65-5 name=__codelineno-65-5 href=#__codelineno-65-5></a>        PATH=&quot;/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin&quot;
<a id=__codelineno-65-6 name=__codelineno-65-6 href=#__codelineno-65-6></a>        name=&#39;jack&#39;
<a id=__codelineno-65-7 name=__codelineno-65-7 href=#__codelineno-65-7></a>    }
<a id=__codelineno-65-8 name=__codelineno-65-8 href=#__codelineno-65-8></a>    stages {
<a id=__codelineno-65-9 name=__codelineno-65-9 href=#__codelineno-65-9></a>        stage(&quot;test env&quot;) {
<a id=__codelineno-65-10 name=__codelineno-65-10 href=#__codelineno-65-10></a>          steps {
<a id=__codelineno-65-11 name=__codelineno-65-11 href=#__codelineno-65-11></a>            sh &quot;printenv&quot;  #调试，打印所有env变量
<a id=__codelineno-65-12 name=__codelineno-65-12 href=#__codelineno-65-12></a>            echo &quot;${name}&quot;  # jack
<a id=__codelineno-65-13 name=__codelineno-65-13 href=#__codelineno-65-13></a>            echo &quot;${env.name}&quot;  # jack
<a id=__codelineno-65-14 name=__codelineno-65-14 href=#__codelineno-65-14></a>          }
<a id=__codelineno-65-15 name=__codelineno-65-15 href=#__codelineno-65-15></a>        }
<a id=__codelineno-65-16 name=__codelineno-65-16 href=#__codelineno-65-16></a>     }
<a id=__codelineno-65-17 name=__codelineno-65-17 href=#__codelineno-65-17></a>  }
</code></pre></div></p> <div class=highlight><pre><span></span><code><a id=__codelineno-66-1 name=__codelineno-66-1 href=#__codelineno-66-1></a>pipeline {
<a id=__codelineno-66-2 name=__codelineno-66-2 href=#__codelineno-66-2></a>    agent any
<a id=__codelineno-66-3 name=__codelineno-66-3 href=#__codelineno-66-3></a>
<a id=__codelineno-66-4 name=__codelineno-66-4 href=#__codelineno-66-4></a>    environment {
<a id=__codelineno-66-5 name=__codelineno-66-5 href=#__codelineno-66-5></a>        FOO = &quot;bar&quot;
<a id=__codelineno-66-6 name=__codelineno-66-6 href=#__codelineno-66-6></a>    }
<a id=__codelineno-66-7 name=__codelineno-66-7 href=#__codelineno-66-7></a>
<a id=__codelineno-66-8 name=__codelineno-66-8 href=#__codelineno-66-8></a>    stages {
<a id=__codelineno-66-9 name=__codelineno-66-9 href=#__codelineno-66-9></a>        stage(&quot;Env Variables&quot;) {
<a id=__codelineno-66-10 name=__codelineno-66-10 href=#__codelineno-66-10></a>            environment {
<a id=__codelineno-66-11 name=__codelineno-66-11 href=#__codelineno-66-11></a>                NAME = &quot;Alan&quot;
<a id=__codelineno-66-12 name=__codelineno-66-12 href=#__codelineno-66-12></a>            }
<a id=__codelineno-66-13 name=__codelineno-66-13 href=#__codelineno-66-13></a>
<a id=__codelineno-66-14 name=__codelineno-66-14 href=#__codelineno-66-14></a>            steps {
<a id=__codelineno-66-15 name=__codelineno-66-15 href=#__codelineno-66-15></a>                echo &quot;FOO = ${env.FOO}&quot;
<a id=__codelineno-66-16 name=__codelineno-66-16 href=#__codelineno-66-16></a>                echo &quot;NAME = ${env.NAME}&quot;
<a id=__codelineno-66-17 name=__codelineno-66-17 href=#__codelineno-66-17></a>
<a id=__codelineno-66-18 name=__codelineno-66-18 href=#__codelineno-66-18></a>                script {
<a id=__codelineno-66-19 name=__codelineno-66-19 href=#__codelineno-66-19></a>                    env.TEST_VARIABLE = &quot;some test value&quot;
<a id=__codelineno-66-20 name=__codelineno-66-20 href=#__codelineno-66-20></a>                }
<a id=__codelineno-66-21 name=__codelineno-66-21 href=#__codelineno-66-21></a>
<a id=__codelineno-66-22 name=__codelineno-66-22 href=#__codelineno-66-22></a>                echo &quot;TEST_VARIABLE = ${env.TEST_VARIABLE}&quot;
<a id=__codelineno-66-23 name=__codelineno-66-23 href=#__codelineno-66-23></a>
<a id=__codelineno-66-24 name=__codelineno-66-24 href=#__codelineno-66-24></a>                withEnv([&quot;ANOTHER_ENV_VAR=here is some value&quot;]) {
<a id=__codelineno-66-25 name=__codelineno-66-25 href=#__codelineno-66-25></a>                    echo &quot;ANOTHER_ENV_VAR = ${env.ANOTHER_ENV_VAR}&quot;
<a id=__codelineno-66-26 name=__codelineno-66-26 href=#__codelineno-66-26></a>                }
<a id=__codelineno-66-27 name=__codelineno-66-27 href=#__codelineno-66-27></a>            }
<a id=__codelineno-66-28 name=__codelineno-66-28 href=#__codelineno-66-28></a>        }
<a id=__codelineno-66-29 name=__codelineno-66-29 href=#__codelineno-66-29></a>    }
<a id=__codelineno-66-30 name=__codelineno-66-30 href=#__codelineno-66-30></a>}
</code></pre></div> <h4 id=5-覆盖环境变量>5. 覆盖环境变量<a class=headerlink href=#5-覆盖环境变量 title="Permanent link">&para;</a></h4> <p>Jenkins Pipeline支持覆盖环境变量。您需要注意一些规则。</p> <ul> <li>使用withEnv(["env=value]) { }语句块可以覆盖任何环境变量。 </li> <li>使用environment {}语句块设置的变量不能使用命令式env.VAR = "value"赋值覆盖。 </li> <li>命令式env.VAR = "value"分配只能覆盖使用命令式创建的环境变量。</li> </ul> <p>这是一个示例性的Jenkinsfile，显示了所有三种不同的用例。 <div class=highlight><pre><span></span><code><a id=__codelineno-67-1 name=__codelineno-67-1 href=#__codelineno-67-1></a>pipeline {
<a id=__codelineno-67-2 name=__codelineno-67-2 href=#__codelineno-67-2></a>    agent any
<a id=__codelineno-67-3 name=__codelineno-67-3 href=#__codelineno-67-3></a>
<a id=__codelineno-67-4 name=__codelineno-67-4 href=#__codelineno-67-4></a>    environment {
<a id=__codelineno-67-5 name=__codelineno-67-5 href=#__codelineno-67-5></a>        FOO = &quot;bar&quot;
<a id=__codelineno-67-6 name=__codelineno-67-6 href=#__codelineno-67-6></a>        NAME = &quot;Joe&quot;
<a id=__codelineno-67-7 name=__codelineno-67-7 href=#__codelineno-67-7></a>    }
<a id=__codelineno-67-8 name=__codelineno-67-8 href=#__codelineno-67-8></a>
<a id=__codelineno-67-9 name=__codelineno-67-9 href=#__codelineno-67-9></a>    stages {
<a id=__codelineno-67-10 name=__codelineno-67-10 href=#__codelineno-67-10></a>        stage(&quot;Env Variables&quot;) {
<a id=__codelineno-67-11 name=__codelineno-67-11 href=#__codelineno-67-11></a>            environment {
<a id=__codelineno-67-12 name=__codelineno-67-12 href=#__codelineno-67-12></a>                NAME = &quot;Alan&quot; // overrides pipeline level NAME env variable
<a id=__codelineno-67-13 name=__codelineno-67-13 href=#__codelineno-67-13></a>                BUILD_NUMBER = &quot;2&quot; // overrides the default BUILD_NUMBER
<a id=__codelineno-67-14 name=__codelineno-67-14 href=#__codelineno-67-14></a>            }
<a id=__codelineno-67-15 name=__codelineno-67-15 href=#__codelineno-67-15></a>
<a id=__codelineno-67-16 name=__codelineno-67-16 href=#__codelineno-67-16></a>            steps {
<a id=__codelineno-67-17 name=__codelineno-67-17 href=#__codelineno-67-17></a>                echo &quot;FOO = ${env.FOO}&quot; // prints &quot;FOO = bar&quot;
<a id=__codelineno-67-18 name=__codelineno-67-18 href=#__codelineno-67-18></a>                echo &quot;NAME = ${env.NAME}&quot; // prints &quot;NAME = Alan&quot;
<a id=__codelineno-67-19 name=__codelineno-67-19 href=#__codelineno-67-19></a>                echo &quot;BUILD_NUMBER =  ${env.BUILD_NUMBER}&quot; // prints &quot;BUILD_NUMBER = 2&quot;
<a id=__codelineno-67-20 name=__codelineno-67-20 href=#__codelineno-67-20></a>
<a id=__codelineno-67-21 name=__codelineno-67-21 href=#__codelineno-67-21></a>                script {
<a id=__codelineno-67-22 name=__codelineno-67-22 href=#__codelineno-67-22></a>                    env.SOMETHING = &quot;1&quot; // creates env.SOMETHING variable
<a id=__codelineno-67-23 name=__codelineno-67-23 href=#__codelineno-67-23></a>                }
<a id=__codelineno-67-24 name=__codelineno-67-24 href=#__codelineno-67-24></a>            }
<a id=__codelineno-67-25 name=__codelineno-67-25 href=#__codelineno-67-25></a>        }
<a id=__codelineno-67-26 name=__codelineno-67-26 href=#__codelineno-67-26></a>
<a id=__codelineno-67-27 name=__codelineno-67-27 href=#__codelineno-67-27></a>        stage(&quot;Override Variables&quot;) {
<a id=__codelineno-67-28 name=__codelineno-67-28 href=#__codelineno-67-28></a>            steps {
<a id=__codelineno-67-29 name=__codelineno-67-29 href=#__codelineno-67-29></a>                script {
<a id=__codelineno-67-30 name=__codelineno-67-30 href=#__codelineno-67-30></a>                    env.FOO = &quot;IT DOES NOT WORK!&quot; // it can&#39;t override env.FOO declared at the pipeline (or stage) level
<a id=__codelineno-67-31 name=__codelineno-67-31 href=#__codelineno-67-31></a>                    env.SOMETHING = &quot;2&quot; // it can override env variable created imperatively
<a id=__codelineno-67-32 name=__codelineno-67-32 href=#__codelineno-67-32></a>                }
<a id=__codelineno-67-33 name=__codelineno-67-33 href=#__codelineno-67-33></a>
<a id=__codelineno-67-34 name=__codelineno-67-34 href=#__codelineno-67-34></a>                echo &quot;FOO = ${env.FOO}&quot; // prints &quot;FOO = bar&quot;
<a id=__codelineno-67-35 name=__codelineno-67-35 href=#__codelineno-67-35></a>                echo &quot;SOMETHING = ${env.SOMETHING}&quot; // prints &quot;SOMETHING = 2&quot;
<a id=__codelineno-67-36 name=__codelineno-67-36 href=#__codelineno-67-36></a>
<a id=__codelineno-67-37 name=__codelineno-67-37 href=#__codelineno-67-37></a>                withEnv([&quot;FOO=foobar&quot;]) { // it can override any env variable
<a id=__codelineno-67-38 name=__codelineno-67-38 href=#__codelineno-67-38></a>                    echo &quot;FOO = ${env.FOO}&quot; // prints &quot;FOO = foobar&quot;
<a id=__codelineno-67-39 name=__codelineno-67-39 href=#__codelineno-67-39></a>                }
<a id=__codelineno-67-40 name=__codelineno-67-40 href=#__codelineno-67-40></a>
<a id=__codelineno-67-41 name=__codelineno-67-41 href=#__codelineno-67-41></a>                withEnv([&quot;BUILD_NUMBER=1&quot;]) {
<a id=__codelineno-67-42 name=__codelineno-67-42 href=#__codelineno-67-42></a>                    echo &quot;BUILD_NUMBER = ${env.BUILD_NUMBER}&quot; // prints &quot;BUILD_NUMBER = 1&quot;
<a id=__codelineno-67-43 name=__codelineno-67-43 href=#__codelineno-67-43></a>                }
<a id=__codelineno-67-44 name=__codelineno-67-44 href=#__codelineno-67-44></a>            }
<a id=__codelineno-67-45 name=__codelineno-67-45 href=#__codelineno-67-45></a>        }
<a id=__codelineno-67-46 name=__codelineno-67-46 href=#__codelineno-67-46></a>    }
<a id=__codelineno-67-47 name=__codelineno-67-47 href=#__codelineno-67-47></a>}
</code></pre></div></p> <h4 id=6-环境变量的互相引用>6. 环境变量的互相引用<a class=headerlink href=#6-环境变量的互相引用 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-68-1 name=__codelineno-68-1 href=#__codelineno-68-1></a>environment {
<a id=__codelineno-68-2 name=__codelineno-68-2 href=#__codelineno-68-2></a>  __server_name = &#39;email-server&#39;
<a id=__codelineno-68-3 name=__codelineno-68-3 href=#__codelineno-68-3></a>  __version = &quot;${BUILD_NUMBER}&quot;
<a id=__codelineno-68-4 name=__codelineno-68-4 href=#__codelineno-68-4></a>  __artifact_name = &quot;${__server_name}-${__version}.jar&quot;
<a id=__codelineno-68-5 name=__codelineno-68-5 href=#__codelineno-68-5></a>}
</code></pre></div> <h4 id=7-将布尔值存储在环境变量中>7. 将布尔值存储在环境变量中<a class=headerlink href=#7-将布尔值存储在环境变量中 title="Permanent link">&para;</a></h4> <p>关于使用环境变量，存在一种普遍的误解。存储为环境变量的每个值都将转换为String。 当您存储布尔false值时，它将转换为"false"。如果要在布尔表达式中正确使用该值，则需要调用<code>"false".toBoolean()</code>method。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-69-1 name=__codelineno-69-1 href=#__codelineno-69-1></a>pipeline {
<a id=__codelineno-69-2 name=__codelineno-69-2 href=#__codelineno-69-2></a>    agent any
<a id=__codelineno-69-3 name=__codelineno-69-3 href=#__codelineno-69-3></a>
<a id=__codelineno-69-4 name=__codelineno-69-4 href=#__codelineno-69-4></a>    environment {
<a id=__codelineno-69-5 name=__codelineno-69-5 href=#__codelineno-69-5></a>        IS_BOOLEAN = false
<a id=__codelineno-69-6 name=__codelineno-69-6 href=#__codelineno-69-6></a>    }
<a id=__codelineno-69-7 name=__codelineno-69-7 href=#__codelineno-69-7></a>
<a id=__codelineno-69-8 name=__codelineno-69-8 href=#__codelineno-69-8></a>    stages {
<a id=__codelineno-69-9 name=__codelineno-69-9 href=#__codelineno-69-9></a>        stage(&quot;Env Variables&quot;) {
<a id=__codelineno-69-10 name=__codelineno-69-10 href=#__codelineno-69-10></a>            steps {
<a id=__codelineno-69-11 name=__codelineno-69-11 href=#__codelineno-69-11></a>                script {
<a id=__codelineno-69-12 name=__codelineno-69-12 href=#__codelineno-69-12></a>                    if (env.IS_BOOLEAN) {
<a id=__codelineno-69-13 name=__codelineno-69-13 href=#__codelineno-69-13></a>                        echo &quot;You can see this message, because \&quot;false\&quot; String evaluates to Boolean.TRUE value&quot;
<a id=__codelineno-69-14 name=__codelineno-69-14 href=#__codelineno-69-14></a>                    }
<a id=__codelineno-69-15 name=__codelineno-69-15 href=#__codelineno-69-15></a>
<a id=__codelineno-69-16 name=__codelineno-69-16 href=#__codelineno-69-16></a>                    if (env.IS_BOOLEAN.toBoolean() == false) {
<a id=__codelineno-69-17 name=__codelineno-69-17 href=#__codelineno-69-17></a>                        echo &quot;You can see this message, because \&quot;false\&quot;.toBoolean() returns Boolean.FALSE value&quot;
<a id=__codelineno-69-18 name=__codelineno-69-18 href=#__codelineno-69-18></a>                    }
<a id=__codelineno-69-19 name=__codelineno-69-19 href=#__codelineno-69-19></a>                }
<a id=__codelineno-69-20 name=__codelineno-69-20 href=#__codelineno-69-20></a>            }
<a id=__codelineno-69-21 name=__codelineno-69-21 href=#__codelineno-69-21></a>        }
<a id=__codelineno-69-22 name=__codelineno-69-22 href=#__codelineno-69-22></a>    }
<a id=__codelineno-69-23 name=__codelineno-69-23 href=#__codelineno-69-23></a>}
</code></pre></div> <h4 id=8-自定义全局环境变量>8. 自定义全局环境变量<a class=headerlink href=#8-自定义全局环境变量 title="Permanent link">&para;</a></h4> <p>定义全局环境变量可以跨pipeline使用 进入Jenkins -- Manage Jenkins -- 找到Global properties -- 勾选Environment variables</p> <h3 id=42-凭证管理>4.2 凭证管理<a class=headerlink href=#42-凭证管理 title="Permanent link">&para;</a></h3> <p>Jenkins 的声明式流水线语法有一个 credentials()函数，它支持 secret text（加密文本）、username 和 password（用户名和密码）以及 secret file（加密文件）等。接下来看一下一些常用的凭证处理方法。</p> <h4 id=1-加密文本>1. 加密文本<a class=headerlink href=#1-加密文本 title="Permanent link">&para;</a></h4> <p>本实例演示将两个 Secret 文本凭证分配给单独的环境变量来访问 Amazon Web 服务，需要提前创建这两个文件的 credentials（实践的章节会有演示），Jenkinsfile 文件的内容如下</p> <div class=highlight><pre><span></span><code><a id=__codelineno-70-1 name=__codelineno-70-1 href=#__codelineno-70-1></a>//Jenkinsfile (Declarative Pipeline)
<a id=__codelineno-70-2 name=__codelineno-70-2 href=#__codelineno-70-2></a>pipeline {
<a id=__codelineno-70-3 name=__codelineno-70-3 href=#__codelineno-70-3></a>  agent any
<a id=__codelineno-70-4 name=__codelineno-70-4 href=#__codelineno-70-4></a>  environment {
<a id=__codelineno-70-5 name=__codelineno-70-5 href=#__codelineno-70-5></a>    AWS_ACCESS_KEY_ID = credentials(&#39;txt1&#39;)
<a id=__codelineno-70-6 name=__codelineno-70-6 href=#__codelineno-70-6></a>    AWS_SECRET_ACCESS_KEY = credentials(&#39;txt2&#39;)
<a id=__codelineno-70-7 name=__codelineno-70-7 href=#__codelineno-70-7></a>  }
<a id=__codelineno-70-8 name=__codelineno-70-8 href=#__codelineno-70-8></a>  stages {
<a id=__codelineno-70-9 name=__codelineno-70-9 href=#__codelineno-70-9></a>    stage(&#39;Example stage 1&#39;) {
<a id=__codelineno-70-10 name=__codelineno-70-10 href=#__codelineno-70-10></a>      steps {
<a id=__codelineno-70-11 name=__codelineno-70-11 href=#__codelineno-70-11></a>        echo &quot;$AWS_ACCESS_KEY_ID&quot;
<a id=__codelineno-70-12 name=__codelineno-70-12 href=#__codelineno-70-12></a>      }
<a id=__codelineno-70-13 name=__codelineno-70-13 href=#__codelineno-70-13></a>    }
<a id=__codelineno-70-14 name=__codelineno-70-14 href=#__codelineno-70-14></a>    stage(&#39;Example stage 2&#39;) {
<a id=__codelineno-70-15 name=__codelineno-70-15 href=#__codelineno-70-15></a>      steps {
<a id=__codelineno-70-16 name=__codelineno-70-16 href=#__codelineno-70-16></a>        echo &quot;$AWS_SECRET_ACCESS_KEY&quot;
<a id=__codelineno-70-17 name=__codelineno-70-17 href=#__codelineno-70-17></a>      }
<a id=__codelineno-70-18 name=__codelineno-70-18 href=#__codelineno-70-18></a>    }
<a id=__codelineno-70-19 name=__codelineno-70-19 href=#__codelineno-70-19></a>  }
<a id=__codelineno-70-20 name=__codelineno-70-20 href=#__codelineno-70-20></a>}
</code></pre></div> <h4 id=2-用户名密码>2. 用户名密码<a class=headerlink href=#2-用户名密码 title="Permanent link">&para;</a></h4> <p>本示例用来演示 credentials 账号密码的使用，比如使用一个公用账户访问 Bitbucket、GitLab、 Harbor 等。假设已经配置完成了用户名密码形式的 credentials，凭证 ID 为 harbor-account</p> <div class=highlight><pre><span></span><code><a id=__codelineno-71-1 name=__codelineno-71-1 href=#__codelineno-71-1></a>//Jenkinsfile (Declarative Pipeline)
<a id=__codelineno-71-2 name=__codelineno-71-2 href=#__codelineno-71-2></a>pipeline {
<a id=__codelineno-71-3 name=__codelineno-71-3 href=#__codelineno-71-3></a>  agent any
<a id=__codelineno-71-4 name=__codelineno-71-4 href=#__codelineno-71-4></a>  environment {
<a id=__codelineno-71-5 name=__codelineno-71-5 href=#__codelineno-71-5></a>    BITBUCKET_COMMON_CREDS = credentials(&#39;harbor-account&#39;)
<a id=__codelineno-71-6 name=__codelineno-71-6 href=#__codelineno-71-6></a>  }
<a id=__codelineno-71-7 name=__codelineno-71-7 href=#__codelineno-71-7></a>  stages {
<a id=__codelineno-71-8 name=__codelineno-71-8 href=#__codelineno-71-8></a>    stage(&#39;printenv&#39;) {
<a id=__codelineno-71-9 name=__codelineno-71-9 href=#__codelineno-71-9></a>      steps {
<a id=__codelineno-71-10 name=__codelineno-71-10 href=#__codelineno-71-10></a>        sh &quot;env&quot;
<a id=__codelineno-71-11 name=__codelineno-71-11 href=#__codelineno-71-11></a>      }
<a id=__codelineno-71-12 name=__codelineno-71-12 href=#__codelineno-71-12></a>    }
<a id=__codelineno-71-13 name=__codelineno-71-13 href=#__codelineno-71-13></a>}
</code></pre></div> <p><strong>上述的配置会自动生成 3 个环境变量</strong></p> <ul> <li>BITBUCKET_COMMON_CREDS：包含一个以冒号分隔的用户名和密码，格式为 username:password</li> <li>BITBUCKET_COMMON_CREDS_USR：仅包含用户名的附加变量</li> <li>BITBUCKET_COMMON_CREDS_PSW：仅包含密码的附加变量。</li> </ul> <h4 id=3-加密文件>3. 加密文件<a class=headerlink href=#3-加密文件 title="Permanent link">&para;</a></h4> <p>需要加密保存的文件，也可以使用 credential，比如链接到 Kubernetes 集群的 kubeconfig 文件等。</p> <p>假如已经配置好了一个 kubeconfig 文件，此时可以在 Pipeline 中引用该文件</p> <div class=highlight><pre><span></span><code><a id=__codelineno-72-1 name=__codelineno-72-1 href=#__codelineno-72-1></a>//Jenkinsfile (Declarative Pipeline)
<a id=__codelineno-72-2 name=__codelineno-72-2 href=#__codelineno-72-2></a>pipeline {
<a id=__codelineno-72-3 name=__codelineno-72-3 href=#__codelineno-72-3></a>  agent {
<a id=__codelineno-72-4 name=__codelineno-72-4 href=#__codelineno-72-4></a>    kubernetes {
<a id=__codelineno-72-5 name=__codelineno-72-5 href=#__codelineno-72-5></a>      cloud &#39;kubernetes&#39;
<a id=__codelineno-72-6 name=__codelineno-72-6 href=#__codelineno-72-6></a>      slaveConnectTimeout 1200
<a id=__codelineno-72-7 name=__codelineno-72-7 href=#__codelineno-72-7></a>      workspaceVolume emptyDirWorkspaceVolume()
<a id=__codelineno-72-8 name=__codelineno-72-8 href=#__codelineno-72-8></a>      yaml &#39;&#39;&#39;
<a id=__codelineno-72-9 name=__codelineno-72-9 href=#__codelineno-72-9></a>kind: Pod
<a id=__codelineno-72-10 name=__codelineno-72-10 href=#__codelineno-72-10></a>metadata:
<a id=__codelineno-72-11 name=__codelineno-72-11 href=#__codelineno-72-11></a>  name: jenkins-agent
<a id=__codelineno-72-12 name=__codelineno-72-12 href=#__codelineno-72-12></a>spec:
<a id=__codelineno-72-13 name=__codelineno-72-13 href=#__codelineno-72-13></a>  containers:
<a id=__codelineno-72-14 name=__codelineno-72-14 href=#__codelineno-72-14></a>  - args: [\&#39;$(JENKINS_SECRET)\&#39;, \&#39;$(JENKINS_NAME)\&#39;]
<a id=__codelineno-72-15 name=__codelineno-72-15 href=#__codelineno-72-15></a>    image: &#39;192.168.10.15/kubernetes/jnlp:alpine&#39;
<a id=__codelineno-72-16 name=__codelineno-72-16 href=#__codelineno-72-16></a>    name: jnlp
<a id=__codelineno-72-17 name=__codelineno-72-17 href=#__codelineno-72-17></a>    imagePullPolicy: IfNotPresent
<a id=__codelineno-72-18 name=__codelineno-72-18 href=#__codelineno-72-18></a>  - command:
<a id=__codelineno-72-19 name=__codelineno-72-19 href=#__codelineno-72-19></a>      - &quot;cat&quot;
<a id=__codelineno-72-20 name=__codelineno-72-20 href=#__codelineno-72-20></a>    image: &quot;192.168.10.15/kubernetes/kubectl:apline&quot;
<a id=__codelineno-72-21 name=__codelineno-72-21 href=#__codelineno-72-21></a>    imagePullPolicy: &quot;IfNotPresent&quot;
<a id=__codelineno-72-22 name=__codelineno-72-22 href=#__codelineno-72-22></a>    name: &quot;kubectl&quot;
<a id=__codelineno-72-23 name=__codelineno-72-23 href=#__codelineno-72-23></a>    tty: true
<a id=__codelineno-72-24 name=__codelineno-72-24 href=#__codelineno-72-24></a>  restartPolicy: Never
<a id=__codelineno-72-25 name=__codelineno-72-25 href=#__codelineno-72-25></a>&#39;&#39;&#39;
<a id=__codelineno-72-26 name=__codelineno-72-26 href=#__codelineno-72-26></a>    }
<a id=__codelineno-72-27 name=__codelineno-72-27 href=#__codelineno-72-27></a>  }
<a id=__codelineno-72-28 name=__codelineno-72-28 href=#__codelineno-72-28></a>  environment {
<a id=__codelineno-72-29 name=__codelineno-72-29 href=#__codelineno-72-29></a>    KUBECONFIG = credentials(&#39;kubernetes-cluster&#39;)
<a id=__codelineno-72-30 name=__codelineno-72-30 href=#__codelineno-72-30></a>  }
<a id=__codelineno-72-31 name=__codelineno-72-31 href=#__codelineno-72-31></a>  stages {
<a id=__codelineno-72-32 name=__codelineno-72-32 href=#__codelineno-72-32></a>    stage(&#39;kubectl&#39;) {
<a id=__codelineno-72-33 name=__codelineno-72-33 href=#__codelineno-72-33></a>      steps {
<a id=__codelineno-72-34 name=__codelineno-72-34 href=#__codelineno-72-34></a>        container(name: &#39;kubectl&#39;) {
<a id=__codelineno-72-35 name=__codelineno-72-35 href=#__codelineno-72-35></a>          sh &quot;&quot;&quot;
<a id=__codelineno-72-36 name=__codelineno-72-36 href=#__codelineno-72-36></a>            # kubectl get pod -A  --kubeconfig $MY_KUBECONFIG
<a id=__codelineno-72-37 name=__codelineno-72-37 href=#__codelineno-72-37></a>
<a id=__codelineno-72-38 name=__codelineno-72-38 href=#__codelineno-72-38></a>            mkdir -p ~/.kube &amp;&amp; cp ${KUBECONFIG} ~/.kube/config
<a id=__codelineno-72-39 name=__codelineno-72-39 href=#__codelineno-72-39></a>            kubectl get nodes
<a id=__codelineno-72-40 name=__codelineno-72-40 href=#__codelineno-72-40></a>          &quot;&quot;&quot;
<a id=__codelineno-72-41 name=__codelineno-72-41 href=#__codelineno-72-41></a>        }
<a id=__codelineno-72-42 name=__codelineno-72-42 href=#__codelineno-72-42></a>      }
<a id=__codelineno-72-43 name=__codelineno-72-43 href=#__codelineno-72-43></a>    }
<a id=__codelineno-72-44 name=__codelineno-72-44 href=#__codelineno-72-44></a>  }
<a id=__codelineno-72-45 name=__codelineno-72-45 href=#__codelineno-72-45></a>}
</code></pre></div> <div class="admonition info"> <p class=admonition-title>更多其他类型的凭证可以参考</p> <p><a href=https://www.jenkins.io/doc/book/pipeline/jenkinsfile/#handlingcredentials>https://www.jenkins.io/doc/book/pipeline/jenkinsfile/#handlingcredentials</a>。</p> </div> <h3 id=43-参数处理>4.3 参数处理<a class=headerlink href=#43-参数处理 title="Permanent link">&para;</a></h3> <p>声明式流水线支持很多开箱即用的参数，可以让流水线接收不同的参数以达到不同的构建效果。</p> <p>在Jenkinsfile中指定的parameters会在Jenkins Web UI自动生成对应的参数列表，此时可以在Jenkins页面单击Build With Parameters来指定参数 的值，这些参数可以通过params变量被成员访问。</p> <p>假设在Jenkinsfile中配置了名为Greeting的字符串参数，可以通过${params.Greeting}访问该参数，比如：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-73-1 name=__codelineno-73-1 href=#__codelineno-73-1></a>//Jenkinsfile (Declarative Pipeline)
<a id=__codelineno-73-2 name=__codelineno-73-2 href=#__codelineno-73-2></a>pipeline {
<a id=__codelineno-73-3 name=__codelineno-73-3 href=#__codelineno-73-3></a>  agent any
<a id=__codelineno-73-4 name=__codelineno-73-4 href=#__codelineno-73-4></a>  parameters {
<a id=__codelineno-73-5 name=__codelineno-73-5 href=#__codelineno-73-5></a>    string(name：‘Greeting’, defaultValue: &#39;Hello&#39;, description: &quot;How should I greet the world?&quot;)
<a id=__codelineno-73-6 name=__codelineno-73-6 href=#__codelineno-73-6></a>  }
<a id=__codelineno-73-7 name=__codelineno-73-7 href=#__codelineno-73-7></a>  stages {
<a id=__codelineno-73-8 name=__codelineno-73-8 href=#__codelineno-73-8></a>    stage(&#39;Example&#39;) {
<a id=__codelineno-73-9 name=__codelineno-73-9 href=#__codelineno-73-9></a>      steps {
<a id=__codelineno-73-10 name=__codelineno-73-10 href=#__codelineno-73-10></a>        echo &quot;${params.Greeting} World!&quot;
<a id=__codelineno-73-11 name=__codelineno-73-11 href=#__codelineno-73-11></a>       }
<a id=__codelineno-73-12 name=__codelineno-73-12 href=#__codelineno-73-12></a>     }
<a id=__codelineno-73-13 name=__codelineno-73-13 href=#__codelineno-73-13></a>  }
<a id=__codelineno-73-14 name=__codelineno-73-14 href=#__codelineno-73-14></a>}
</code></pre></div> <p>对应的脚本式流水线如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-74-1 name=__codelineno-74-1 href=#__codelineno-74-1></a>//Jenkinsfile (Scripted Pipeline)
<a id=__codelineno-74-2 name=__codelineno-74-2 href=#__codelineno-74-2></a>properties([parameters([string(name：‘Greeting’, defaultValue: &#39;Hello&#39;, description: &quot;How should I greet the world?&quot;)])])
<a id=__codelineno-74-3 name=__codelineno-74-3 href=#__codelineno-74-3></a>
<a id=__codelineno-74-4 name=__codelineno-74-4 href=#__codelineno-74-4></a>node {
<a id=__codelineno-74-5 name=__codelineno-74-5 href=#__codelineno-74-5></a>    echo &quot;${params.Greeting} World!&quot; 
<a id=__codelineno-74-6 name=__codelineno-74-6 href=#__codelineno-74-6></a>}
</code></pre></div> <h3 id=44-处理失败>4.4 处理失败<a class=headerlink href=#44-处理失败 title="Permanent link">&para;</a></h3> <p>在声明式流水线中，可以根据不同的结果进行后置处理，比如always、unstable、success、failure和changed，具体可参考Pipeline Post的语法。</p> <p>假如流水线构建失败需要进行邮件通知，可以参考如下示例（Jenkins需要配置邮箱）：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-75-1 name=__codelineno-75-1 href=#__codelineno-75-1></a>pipeline { 
<a id=__codelineno-75-2 name=__codelineno-75-2 href=#__codelineno-75-2></a>    agent any 
<a id=__codelineno-75-3 name=__codelineno-75-3 href=#__codelineno-75-3></a>
<a id=__codelineno-75-4 name=__codelineno-75-4 href=#__codelineno-75-4></a>    parameters {
<a id=__codelineno-75-5 name=__codelineno-75-5 href=#__codelineno-75-5></a>        省略内容……
<a id=__codelineno-75-6 name=__codelineno-75-6 href=#__codelineno-75-6></a>    }
<a id=__codelineno-75-7 name=__codelineno-75-7 href=#__codelineno-75-7></a>    environment {
<a id=__codelineno-75-8 name=__codelineno-75-8 href=#__codelineno-75-8></a>        省略内容……
<a id=__codelineno-75-9 name=__codelineno-75-9 href=#__codelineno-75-9></a>    }
<a id=__codelineno-75-10 name=__codelineno-75-10 href=#__codelineno-75-10></a>    stages {
<a id=__codelineno-75-11 name=__codelineno-75-11 href=#__codelineno-75-11></a>        省略内容……
<a id=__codelineno-75-12 name=__codelineno-75-12 href=#__codelineno-75-12></a>    }
<a id=__codelineno-75-13 name=__codelineno-75-13 href=#__codelineno-75-13></a>    post {
<a id=__codelineno-75-14 name=__codelineno-75-14 href=#__codelineno-75-14></a>        success {
<a id=__codelineno-75-15 name=__codelineno-75-15 href=#__codelineno-75-15></a>            emailext (
<a id=__codelineno-75-16 name=__codelineno-75-16 href=#__codelineno-75-16></a>                subject: &quot;SUCCESSFUL: Job &#39;${env.JOB_NAME} [${env.BUILD_NUMBER}]&#39;&quot;,
<a id=__codelineno-75-17 name=__codelineno-75-17 href=#__codelineno-75-17></a>                body: &quot;&quot;&quot;&lt;p&gt;SUCCESSFUL: Job &#39;${env.JOB_NAME} [${env.BUILD_NUMBER}]&#39;:&lt;/p&gt;
<a id=__codelineno-75-18 name=__codelineno-75-18 href=#__codelineno-75-18></a>                    &lt;p&gt;Check console output at &quot;&lt;a href=&quot;${env.BUILD_URL}&quot;&gt;${env.JOB_NAME} [${env.BUILD_NUMBER}]&lt;/a&gt;&quot;&lt;/p&gt;&quot;&quot;&quot;,
<a id=__codelineno-75-19 name=__codelineno-75-19 href=#__codelineno-75-19></a>                to: &quot;user1@qq.com,user2@qq.com&quot;,
<a id=__codelineno-75-20 name=__codelineno-75-20 href=#__codelineno-75-20></a>                from: &quot;admin@sina.com&quot;
<a id=__codelineno-75-21 name=__codelineno-75-21 href=#__codelineno-75-21></a>            )
<a id=__codelineno-75-22 name=__codelineno-75-22 href=#__codelineno-75-22></a>        }
<a id=__codelineno-75-23 name=__codelineno-75-23 href=#__codelineno-75-23></a>        failure {
<a id=__codelineno-75-24 name=__codelineno-75-24 href=#__codelineno-75-24></a>            emailext (
<a id=__codelineno-75-25 name=__codelineno-75-25 href=#__codelineno-75-25></a>                subject: &quot;FAILED: Job &#39;${env.JOB_NAME} [${env.BUILD_NUMBER}]&#39;&quot;,
<a id=__codelineno-75-26 name=__codelineno-75-26 href=#__codelineno-75-26></a>                body: &quot;&quot;&quot;&lt;p&gt;FAILED: Job &#39;${env.JOB_NAME} [${env.BUILD_NUMBER}]&#39;:&lt;/p&gt;
<a id=__codelineno-75-27 name=__codelineno-75-27 href=#__codelineno-75-27></a>                    &lt;p&gt;Check console output at &quot;&lt;a href=&quot;${env.BUILD_URL}&quot;&gt;${env.JOB_NAME}          [${env.BUILD_NUMBER}]&lt;/a&gt;&quot;&lt;/p&gt;&quot;&quot;&quot;,
<a id=__codelineno-75-28 name=__codelineno-75-28 href=#__codelineno-75-28></a>                to: &quot;user1@qq.com,user2@qq.com&quot;,
<a id=__codelineno-75-29 name=__codelineno-75-29 href=#__codelineno-75-29></a>                from: &quot;admin@sina.com&quot;
<a id=__codelineno-75-30 name=__codelineno-75-30 href=#__codelineno-75-30></a>            )
<a id=__codelineno-75-31 name=__codelineno-75-31 href=#__codelineno-75-31></a>        }
<a id=__codelineno-75-32 name=__codelineno-75-32 href=#__codelineno-75-32></a>    }
<a id=__codelineno-75-33 name=__codelineno-75-33 href=#__codelineno-75-33></a>}
</code></pre></div> <h3 id=45-使用多个代理>4.5 使用多个代理<a class=headerlink href=#45-使用多个代理 title="Permanent link">&para;</a></h3> <p>流水线允许在Jenkins环境中使用多个代理，这有助于更高级的用例，例如跨多个平台执行构建、测试等。</p> <p>比如，在Linux和Windows系统的不同agent上进行测试：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-76-1 name=__codelineno-76-1 href=#__codelineno-76-1></a>pipeline {
<a id=__codelineno-76-2 name=__codelineno-76-2 href=#__codelineno-76-2></a>    agent none
<a id=__codelineno-76-3 name=__codelineno-76-3 href=#__codelineno-76-3></a>    stages {
<a id=__codelineno-76-4 name=__codelineno-76-4 href=#__codelineno-76-4></a>        stage(&#39;Build&#39;) {
<a id=__codelineno-76-5 name=__codelineno-76-5 href=#__codelineno-76-5></a>            agent any
<a id=__codelineno-76-6 name=__codelineno-76-6 href=#__codelineno-76-6></a>            steps {
<a id=__codelineno-76-7 name=__codelineno-76-7 href=#__codelineno-76-7></a>                checkout scm
<a id=__codelineno-76-8 name=__codelineno-76-8 href=#__codelineno-76-8></a>                sh &#39;make&#39;
<a id=__codelineno-76-9 name=__codelineno-76-9 href=#__codelineno-76-9></a>                stash includes: &#39;**/target/*.jar&#39;, name: &#39;app&#39;
<a id=__codelineno-76-10 name=__codelineno-76-10 href=#__codelineno-76-10></a>            }
<a id=__codelineno-76-11 name=__codelineno-76-11 href=#__codelineno-76-11></a>        }
<a id=__codelineno-76-12 name=__codelineno-76-12 href=#__codelineno-76-12></a>
<a id=__codelineno-76-13 name=__codelineno-76-13 href=#__codelineno-76-13></a>         stage(&#39;Test on Linux&#39;) {
<a id=__codelineno-76-14 name=__codelineno-76-14 href=#__codelineno-76-14></a>            agent { label &#39;linux&#39;}
<a id=__codelineno-76-15 name=__codelineno-76-15 href=#__codelineno-76-15></a>            steps {
<a id=__codelineno-76-16 name=__codelineno-76-16 href=#__codelineno-76-16></a>              unstash &#39;app&#39;
<a id=__codelineno-76-17 name=__codelineno-76-17 href=#__codelineno-76-17></a>               sh &#39;make check&#39;
<a id=__codelineno-76-18 name=__codelineno-76-18 href=#__codelineno-76-18></a>            }
<a id=__codelineno-76-19 name=__codelineno-76-19 href=#__codelineno-76-19></a>            post {
<a id=__codelineno-76-20 name=__codelineno-76-20 href=#__codelineno-76-20></a>              always {
<a id=__codelineno-76-21 name=__codelineno-76-21 href=#__codelineno-76-21></a>                junit &#39;**/target/*.xml&#39;
<a id=__codelineno-76-22 name=__codelineno-76-22 href=#__codelineno-76-22></a>              }
<a id=__codelineno-76-23 name=__codelineno-76-23 href=#__codelineno-76-23></a>            }
<a id=__codelineno-76-24 name=__codelineno-76-24 href=#__codelineno-76-24></a>        }
<a id=__codelineno-76-25 name=__codelineno-76-25 href=#__codelineno-76-25></a>
<a id=__codelineno-76-26 name=__codelineno-76-26 href=#__codelineno-76-26></a>       stage(&#39;Test on Windows&#39;) {
<a id=__codelineno-76-27 name=__codelineno-76-27 href=#__codelineno-76-27></a>            agent { label &#39;windows&#39;}
<a id=__codelineno-76-28 name=__codelineno-76-28 href=#__codelineno-76-28></a>            steps {
<a id=__codelineno-76-29 name=__codelineno-76-29 href=#__codelineno-76-29></a>              unstash &#39;app&#39;
<a id=__codelineno-76-30 name=__codelineno-76-30 href=#__codelineno-76-30></a>               sh &#39;make check&#39;
<a id=__codelineno-76-31 name=__codelineno-76-31 href=#__codelineno-76-31></a>            }
<a id=__codelineno-76-32 name=__codelineno-76-32 href=#__codelineno-76-32></a>            post {
<a id=__codelineno-76-33 name=__codelineno-76-33 href=#__codelineno-76-33></a>              always {
<a id=__codelineno-76-34 name=__codelineno-76-34 href=#__codelineno-76-34></a>                junit &#39;**/target/*.xml&#39;
<a id=__codelineno-76-35 name=__codelineno-76-35 href=#__codelineno-76-35></a>              }
<a id=__codelineno-76-36 name=__codelineno-76-36 href=#__codelineno-76-36></a>            }
<a id=__codelineno-76-37 name=__codelineno-76-37 href=#__codelineno-76-37></a>        }
<a id=__codelineno-76-38 name=__codelineno-76-38 href=#__codelineno-76-38></a>    }
<a id=__codelineno-76-39 name=__codelineno-76-39 href=#__codelineno-76-39></a>}
</code></pre></div> <h3 id=46-流水线回放功能>4.6 流水线回放功能<a class=headerlink href=#46-流水线回放功能 title="Permanent link">&para;</a></h3> <p>借助回放可以修改上次构建所使用的Jenkinsfile代码，进行更改后可以立即运行进行测试。</p> <p><img alt src=../../../assets/static/kubernetes/6/4.6-huifang.png></p> <h3 id=47-pipeline开发工具>4.7 Pipeline开发工具<a class=headerlink href=#47-pipeline开发工具 title="Permanent link">&para;</a></h3> <h4 id=片段生成器>片段生成器<a class=headerlink href=#片段生成器 title="Permanent link">&para;</a></h4> <p>流水线代码片段生成器，非常好用，在这里可以找到<code>每个插件以及Jenkins内置的方法</code>的使用方法.使用片段生成器可以根据个人需要生成方法， 有些方法来源于插件，则需要安装相关的插件才能使用哦。</p> <h4 id=声明式语法生成器>声明式语法生成器<a class=headerlink href=#声明式语法生成器 title="Permanent link">&para;</a></h4> <p>可以生成声明式流水线语法的语句块</p> <h4 id=全局变量参考>全局变量参考<a class=headerlink href=#全局变量参考 title="Permanent link">&para;</a></h4> <p>这里面是已经安装的Jenkins插件和Jenkins内置的全局变量清单。</p> <h3 id=48-dsl方法>4.8 DSL方法<a class=headerlink href=#48-dsl方法 title="Permanent link">&para;</a></h3> <h4 id=481-json数据格式解析>4.8.1 JSON数据格式解析<a class=headerlink href=#481-json数据格式解析 title="Permanent link">&para;</a></h4> <p>插件： Pipeline Utils Steps</p> <div class=highlight><pre><span></span><code><a id=__codelineno-77-1 name=__codelineno-77-1 href=#__codelineno-77-1></a>// 插件
<a id=__codelineno-77-2 name=__codelineno-77-2 href=#__codelineno-77-2></a>def response = readJSON text: &quot;${scanResult}&quot;
<a id=__codelineno-77-3 name=__codelineno-77-3 href=#__codelineno-77-3></a>println(scanResult)
<a id=__codelineno-77-4 name=__codelineno-77-4 href=#__codelineno-77-4></a>
<a id=__codelineno-77-5 name=__codelineno-77-5 href=#__codelineno-77-5></a>
<a id=__codelineno-77-6 name=__codelineno-77-6 href=#__codelineno-77-6></a>// 原生方法
<a id=__codelineno-77-7 name=__codelineno-77-7 href=#__codelineno-77-7></a>import groovy.json.*
<a id=__codelineno-77-8 name=__codelineno-77-8 href=#__codelineno-77-8></a>
<a id=__codelineno-77-9 name=__codelineno-77-9 href=#__codelineno-77-9></a>@NonCPS
<a id=__codelineno-77-10 name=__codelineno-77-10 href=#__codelineno-77-10></a>def GetJson(text){
<a id=__codelineno-77-11 name=__codelineno-77-11 href=#__codelineno-77-11></a>    def prettyJson = JsonOutput.prettyPrint(text) 
<a id=__codelineno-77-12 name=__codelineno-77-12 href=#__codelineno-77-12></a>    new JsonSlurperClassic().parseText(prettyJson)
<a id=__codelineno-77-13 name=__codelineno-77-13 href=#__codelineno-77-13></a>}
</code></pre></div> <h4 id=482-流水线中使用凭证>4.8.2 流水线中使用凭证<a class=headerlink href=#482-流水线中使用凭证 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-78-1 name=__codelineno-78-1 href=#__codelineno-78-1></a>withCredentials([string(credentialsId: &quot;xxxxx&quot;, variable: &quot;sonarToken&quot;)]) {
<a id=__codelineno-78-2 name=__codelineno-78-2 href=#__codelineno-78-2></a>    println(sonarToken)
<a id=__codelineno-78-3 name=__codelineno-78-3 href=#__codelineno-78-3></a>}
</code></pre></div> <h4 id=483-代码管理-下载代码>4.8.3 代码管理-下载代码<a class=headerlink href=#483-代码管理-下载代码 title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-79-1 name=__codelineno-79-1 href=#__codelineno-79-1></a>//Git
<a id=__codelineno-79-2 name=__codelineno-79-2 href=#__codelineno-79-2></a>checkout([$class: &#39;GitSCM&#39;, branches: [[name: &quot;brnachName&quot;]], 
<a id=__codelineno-79-3 name=__codelineno-79-3 href=#__codelineno-79-3></a>            doGenerateSubmoduleConfigurations: false, 
<a id=__codelineno-79-4 name=__codelineno-79-4 href=#__codelineno-79-4></a>            extensions: [], submoduleCfg: [], 
<a id=__codelineno-79-5 name=__codelineno-79-5 href=#__codelineno-79-5></a>            userRemoteConfigs: [[credentialsId: &quot;${credentialsId}&quot;, 
<a id=__codelineno-79-6 name=__codelineno-79-6 href=#__codelineno-79-6></a>            url: &quot;${srcUrl}&quot;]]])
<a id=__codelineno-79-7 name=__codelineno-79-7 href=#__codelineno-79-7></a>//Svn
<a id=__codelineno-79-8 name=__codelineno-79-8 href=#__codelineno-79-8></a>checkout([$class: &#39;SubversionSCM&#39;, additionalCredentials: [], 
<a id=__codelineno-79-9 name=__codelineno-79-9 href=#__codelineno-79-9></a>            filterChangelog: false, ignoreDirPropChanges: false, 
<a id=__codelineno-79-10 name=__codelineno-79-10 href=#__codelineno-79-10></a>            locations: [[credentialsId: &quot;${credentialsId}&quot;, 
<a id=__codelineno-79-11 name=__codelineno-79-11 href=#__codelineno-79-11></a>            depthOption: &#39;infinity&#39;, ignoreExternalsOption: true, 
<a id=__codelineno-79-12 name=__codelineno-79-12 href=#__codelineno-79-12></a>            remote: &quot;${svnUrl}&quot;]], workspaceUpdater: [$class: &#39;CheckoutUpdater&#39;]]
<a id=__codelineno-79-13 name=__codelineno-79-13 href=#__codelineno-79-13></a>)
</code></pre></div> <p>拉取仓库分支</p> <div class=highlight><pre><span></span><code><a id=__codelineno-80-1 name=__codelineno-80-1 href=#__codelineno-80-1></a>stage(&#39;pull master code&#39;) {
<a id=__codelineno-80-2 name=__codelineno-80-2 href=#__codelineno-80-2></a>    options { retry(3) }
<a id=__codelineno-80-3 name=__codelineno-80-3 href=#__codelineno-80-3></a>    steps {
<a id=__codelineno-80-4 name=__codelineno-80-4 href=#__codelineno-80-4></a>        checkout([$class: &#39;GitSCM&#39;, branches: [[name: &quot;${RELEASE_VERSION}&quot;]], 
<a id=__codelineno-80-5 name=__codelineno-80-5 href=#__codelineno-80-5></a>        extensions: [
<a id=__codelineno-80-6 name=__codelineno-80-6 href=#__codelineno-80-6></a>          [$class: &#39;CleanBeforeCheckout&#39;, deleteUntrackedNestedRepositories: true]],
<a id=__codelineno-80-7 name=__codelineno-80-7 href=#__codelineno-80-7></a>        userRemoteConfigs: [[credentialsId: &quot;${GIT_AUTH}&quot;, url: &quot;${GIT_ADDRESS}&quot;]]])
<a id=__codelineno-80-8 name=__codelineno-80-8 href=#__codelineno-80-8></a>        }
<a id=__codelineno-80-9 name=__codelineno-80-9 href=#__codelineno-80-9></a>}
</code></pre></div> <p>拉取仓库pull-request分支下的目录或者文件</p> <div class=highlight><pre><span></span><code><a id=__codelineno-81-1 name=__codelineno-81-1 href=#__codelineno-81-1></a>stage(&#39;pull pr branch config&#39;) {
<a id=__codelineno-81-2 name=__codelineno-81-2 href=#__codelineno-81-2></a>  options { retry(3) }
<a id=__codelineno-81-3 name=__codelineno-81-3 href=#__codelineno-81-3></a>  steps {
<a id=__codelineno-81-4 name=__codelineno-81-4 href=#__codelineno-81-4></a>      checkout([$class: &#39;GitSCM&#39;,
<a id=__codelineno-81-5 name=__codelineno-81-5 href=#__codelineno-81-5></a>          branches: [[name: &quot;pull/${giteePullRequestIid}/MERGE&quot;]], doGenerateSubmoduleConfigurations: false, submoduleCfg: [],
<a id=__codelineno-81-6 name=__codelineno-81-6 href=#__codelineno-81-6></a>          extensions: [
<a id=__codelineno-81-7 name=__codelineno-81-7 href=#__codelineno-81-7></a>              [$class: &#39;CleanBeforeCheckout&#39;, deleteUntrackedNestedRepositories: true],
<a id=__codelineno-81-8 name=__codelineno-81-8 href=#__codelineno-81-8></a>              [$class: &#39;SparseCheckoutPaths&#39;, sparseCheckoutPaths:[[$class:&#39;SparseCheckoutPath&#39;, path:&#39;config/&#39;]]],
<a id=__codelineno-81-9 name=__codelineno-81-9 href=#__codelineno-81-9></a>              [$class: &#39;CloneOption&#39;, depth: 1, noTags: true, shallow: true, honorRefspec: true]],
<a id=__codelineno-81-10 name=__codelineno-81-10 href=#__codelineno-81-10></a>          userRemoteConfigs: [[credentialsId: &quot;${GIT_AUTH}&quot;, name: &#39;origin&#39;, refspec: &#39;+refs/pull/${giteePullRequestIid}/MERGE:refs/pull/${giteePullRequestIid}/MERGE&#39;, url: &quot;${GIT_ADDRESS}&quot;]]
<a id=__codelineno-81-11 name=__codelineno-81-11 href=#__codelineno-81-11></a>      ])
<a id=__codelineno-81-12 name=__codelineno-81-12 href=#__codelineno-81-12></a>  }
<a id=__codelineno-81-13 name=__codelineno-81-13 href=#__codelineno-81-13></a>}
</code></pre></div> <p>使用git插件拉取指定分支代码</p> <div class=highlight><pre><span></span><code><a id=__codelineno-82-1 name=__codelineno-82-1 href=#__codelineno-82-1></a>stage(&quot;Checkout SCM&quot;){
<a id=__codelineno-82-2 name=__codelineno-82-2 href=#__codelineno-82-2></a>  when{
<a id=__codelineno-82-3 name=__codelineno-82-3 href=#__codelineno-82-3></a>    expression {return ! params.SKIP_IMAGE_BUILD }
<a id=__codelineno-82-4 name=__codelineno-82-4 href=#__codelineno-82-4></a>  }
<a id=__codelineno-82-5 name=__codelineno-82-5 href=#__codelineno-82-5></a>  steps{
<a id=__codelineno-82-6 name=__codelineno-82-6 href=#__codelineno-82-6></a>    git branch: &quot;${BRANCH}&quot;, credentialsId: &#39;gitee-ci-bot&#39;, url: &#39;https://gitee.com/oschina/gitee-ent-web.git&#39;
<a id=__codelineno-82-7 name=__codelineno-82-7 href=#__codelineno-82-7></a>    script{
<a id=__codelineno-82-8 name=__codelineno-82-8 href=#__codelineno-82-8></a>      env.OSC_GIT_COMMIT=sh(returnStdout: true, script: &#39;git rev-parse --short HEAD&#39;).trim().substring(0,7)
<a id=__codelineno-82-9 name=__codelineno-82-9 href=#__codelineno-82-9></a>    }
<a id=__codelineno-82-10 name=__codelineno-82-10 href=#__codelineno-82-10></a>    sh &quot;printenv OSC_GIT_COMMIT&quot;
<a id=__codelineno-82-11 name=__codelineno-82-11 href=#__codelineno-82-11></a>  }
<a id=__codelineno-82-12 name=__codelineno-82-12 href=#__codelineno-82-12></a>}
</code></pre></div> <h3 id=49-groovy编程>4.9 Groovy编程<a class=headerlink href=#49-groovy编程 title="Permanent link">&para;</a></h3> <div class="admonition example"> <p class=admonition-title>参考文档</p> <p><a href=http://docs.groovy-lang.org/docs/latest/html/documentation/#_map_coercion>http://docs.groovy-lang.org/docs/latest/html/documentation/#_map_coercion</a></p> <p><a href=http://groovy-lang.org/groovy-dev-kit.html>http://groovy-lang.org/groovy-dev-kit.html</a></p> </div> <p>Groovy是一种功能强大，可选类型和动态语言，支持Java平台。旨在提高开发人员的生产力得益于简洁，熟悉且简单易学的语法。</p> <p>可以与任何Java程序顺利集成，并立即为您的应用程序提供强大的功能，包括脚本编写功能，特定领域语言编写，运行时和编译时元编程以及函数式编程。</p> <h4 id=1安装>1.安装<a class=headerlink href=#1安装 title="Permanent link">&para;</a></h4> <ul> <li>下载安装包(先安装JDK)</li> <li>解压安装包 获取安装包bin目录 </li> <li>设置环境变量写入/etc/profile文件</li> </ul> <blockquote> <p>安装包下载地址： <a href=https://groovy.apache.org/download.html>https://groovy.apache.org/download.html</a></p> </blockquote> <p>JDK安装</p> <p>JDK(Java Development Kit)是Sun Microsystems针对Java开发员的产品。 自从Java推出以来，JDK已经成为使用最广泛的Java SDK. JDK是整个Java的核心，包括了Java运行环境，Java工具和Java基础的类库。</p> <p>JDK下载面页：</p> <blockquote> <p><a href=http://www.oracle.com/technetwork/java/javase/downloads/index.html>http://www.oracle.com/technetwork/java/javase/downloads/index.html</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-83-1 name=__codelineno-83-1 href=#__codelineno-83-1></a><span class=c1># Linux中使用wget下载的方法如下：</span>
<a id=__codelineno-83-2 name=__codelineno-83-2 href=#__codelineno-83-2></a>wget<span class=w> </span>--no-cookies<span class=w> </span>--no-check-certificate<span class=w> </span>--header<span class=w> </span><span class=s2>&quot;Cookie: gpw_e24=http%3A%2F%2Fwww.oracle.com%2F; oraclelicense=accept-securebackup-cookie&quot;</span><span class=w> </span><span class=s2>&quot;http://download.oracle.com/otn-pub/java/jdk/8u141-b15/336fa29ff2bb4ef291e347e091f7f4a7/jdk-8u141-linux-x64.tar.gz&quot;</span>
<a id=__codelineno-83-3 name=__codelineno-83-3 href=#__codelineno-83-3></a><span class=c1># 或</span>
<a id=__codelineno-83-4 name=__codelineno-83-4 href=#__codelineno-83-4></a>wget<span class=w> </span>ftp://biguser:www.jb51.net@gw.086o2i.cn:8021/201704/tools/jdk-linux-x64.tar.gz
<a id=__codelineno-83-5 name=__codelineno-83-5 href=#__codelineno-83-5></a>tar<span class=w> </span>zxvf<span class=w> </span>jdk-linux-x64.tar.gz
<a id=__codelineno-83-6 name=__codelineno-83-6 href=#__codelineno-83-6></a>mv<span class=w> </span>jdk1.8.0_131/<span class=w> </span>/usr/local/jdk1.8
<a id=__codelineno-83-7 name=__codelineno-83-7 href=#__codelineno-83-7></a>
<a id=__codelineno-83-8 name=__codelineno-83-8 href=#__codelineno-83-8></a><span class=c1># 设置环境变量</span>
<a id=__codelineno-83-9 name=__codelineno-83-9 href=#__codelineno-83-9></a>
<a id=__codelineno-83-10 name=__codelineno-83-10 href=#__codelineno-83-10></a>vim<span class=w> </span>/etc/profile
<a id=__codelineno-83-11 name=__codelineno-83-11 href=#__codelineno-83-11></a><span class=c1># 在末尾输入以下内容:</span>
<a id=__codelineno-83-12 name=__codelineno-83-12 href=#__codelineno-83-12></a><span class=nb>export</span><span class=w> </span><span class=nv>JAVA_HOME</span><span class=o>=</span>/usr/local/jdk1.8
<a id=__codelineno-83-13 name=__codelineno-83-13 href=#__codelineno-83-13></a><span class=nb>export</span><span class=w> </span><span class=nv>CLASSPATH</span><span class=o>=</span><span class=nv>$CLASSPATH</span>:<span class=nv>$JAVA_HOME</span>/lib:<span class=nv>$JAVA_HOME</span>/jre/lib
<a id=__codelineno-83-14 name=__codelineno-83-14 href=#__codelineno-83-14></a><span class=nb>export</span><span class=w> </span><span class=nv>PATH</span><span class=o>=</span><span class=nv>$JAVA_HOME</span>/bin:<span class=nv>$JAVA_HOME</span>/jre/bin:<span class=nv>$PATH</span>:<span class=nv>$HOMR</span>/bin
<a id=__codelineno-83-15 name=__codelineno-83-15 href=#__codelineno-83-15></a>
<a id=__codelineno-83-16 name=__codelineno-83-16 href=#__codelineno-83-16></a><span class=c1># 保存文件后，使其生效:</span>
<a id=__codelineno-83-17 name=__codelineno-83-17 href=#__codelineno-83-17></a><span class=nb>source</span><span class=w> </span>/etc/profile
<a id=__codelineno-83-18 name=__codelineno-83-18 href=#__codelineno-83-18></a>
<a id=__codelineno-83-19 name=__codelineno-83-19 href=#__codelineno-83-19></a><span class=c1># 检测是否设置正确:</span>
<a id=__codelineno-83-20 name=__codelineno-83-20 href=#__codelineno-83-20></a>java<span class=w> </span>-versio
</code></pre></div> <p>配置Groovy环境变量</p> <div class=highlight><pre><span></span><code><a id=__codelineno-84-1 name=__codelineno-84-1 href=#__codelineno-84-1></a>vi<span class=w> </span>/etc/profile
<a id=__codelineno-84-2 name=__codelineno-84-2 href=#__codelineno-84-2></a><span class=nb>export</span><span class=w> </span><span class=nv>GROOVY_HOME</span><span class=o>=</span>/usr/local/groovy-3.0.7/
<a id=__codelineno-84-3 name=__codelineno-84-3 href=#__codelineno-84-3></a><span class=nb>export</span><span class=w> </span><span class=nv>PATH</span><span class=o>=</span><span class=nv>$PATH</span>:<span class=nv>$GROOVY_HOME</span>/bin
<a id=__codelineno-84-4 name=__codelineno-84-4 href=#__codelineno-84-4></a>
<a id=__codelineno-84-5 name=__codelineno-84-5 href=#__codelineno-84-5></a><span class=nb>source</span><span class=w> </span>/etc/profile
<a id=__codelineno-84-6 name=__codelineno-84-6 href=#__codelineno-84-6></a>groovysh
</code></pre></div> <div class="admonition example"> <p class=admonition-title>参考文献</p> <p><a href=https://www.linux98.com/archives/jenkins08>Jenkins系列08-Pipeline</a></p> </div> <h2 id=5-devops平台建设>5. DevOps平台建设<a class=headerlink href=#5-devops平台建设 title="Permanent link">&para;</a></h2> <p>本节介绍持续集成、持续部署的步骤及过程，主要讲解如何基于Kubernetes和Jenkins搭建DevOps平台、如何在Kubernetes中发版、DevOps平 台用到的工具的安装以及基于Kubernetes和Jenkins的CI/CD过程。</p> <p>在Kubernetes中进行CI/CD的过程，一般的步骤如下：</p> <ol> <li> <p>在GitLab中创建对应的项目。</p> </li> <li> <p>配置Jenkins集成Kubernetes集群 ， 后期Jenkins的Slave为在Kubernetes中动态创建的Slave。</p> </li> <li> <p>Jenkins创建对应的任务(Job)，集成该项目的Git地址和Kubernetes集群。</p> </li> <li> <p>开发者将代码提交到GitLab。</p> </li> <li> <p>若配置了钩子，则推送（Push）代码会自动触发Jenkins构建，若没有配置钩子，则需要手动构建。</p> </li> <li> <p>Jenkins控制Kubernetes（使用的是Kubernetes插件）创建JenkinsSlave（Pod形式）。</p> </li> <li> <p>Jenkins Slave根据流水线定义的步骤执行构建。</p> </li> <li> <p>通过Dockerfile生成镜像。</p> </li> <li> <p>将镜像提送到私有Harbor（或者其他的镜像仓库）。</p> </li> <li> <p>Jenkins再次控制Kubernetes进行最新的镜像部署。</p> </li> <li> <p>流水线结束，删除Jenkins Slave。</p> </li> </ol> <p>上述为比较常用的步骤，中间还可能涉及自动化测试等其他步骤，可自行根据业务场景添加或删除。</p> <p>上述流水线步骤一般写在Jenkinsfile中，Jenkins会自动读取该文件，同时Jenkinsfile和Dockerfile可一并和代码放 置于GitLab中，可以和代码一样实现版本控制，单独配置也可以</p> <p>下图是我们当前示例的流程图</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-1.png></p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-2.png></p> <p>生产环境CICD流程</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-3.png></p> <p>了解了基于Kubernetes和Jenkins的发版流程后，接下来需要一步一步安装所需要的工具，之后即可开始CI/CD的学习。如果公司内已经有可以用来联系的平台，可以不安装这些工具。</p> <p>建设DevOps平台需要建设如下服务</p> <ul> <li>Jenkins </li> <li>GitLab </li> <li>Harbor </li> <li>Coredns</li> </ul> <p>可以安装在Kubernetes集群中，也可以单独部署，</p> <p>生产环境建议选择直接在单独的机器上部署，这是企业常用的一种方式。</p> <h3 id=51-安装jenkins>5.1 安装Jenkins<a class=headerlink href=#51-安装jenkins title="Permanent link">&para;</a></h3> <h4 id=1-服务方式>1. 服务方式<a class=headerlink href=#1-服务方式 title="Permanent link">&para;</a></h4> <div class="tabbed-set tabbed-alternate" data-tabs=1:4><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><input id=__tabbed_1_3 name=__tabbed_1 type=radio><input id=__tabbed_1_4 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>centos</label><label for=__tabbed_1_2>debian/ubuntu</label><label for=__tabbed_1_3>war</label><label for=__tabbed_1_4>docker</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code><a id=__codelineno-85-1 name=__codelineno-85-1 href=#__codelineno-85-1></a><span class=c1># Step 1: Install Java</span>
<a id=__codelineno-85-2 name=__codelineno-85-2 href=#__codelineno-85-2></a>$<span class=w> </span>sudo<span class=w> </span>yum<span class=w> </span>install<span class=w> </span>fontconfig<span class=w> </span>java-11-openjdk
<a id=__codelineno-85-3 name=__codelineno-85-3 href=#__codelineno-85-3></a>
<a id=__codelineno-85-4 name=__codelineno-85-4 href=#__codelineno-85-4></a><span class=c1># Step 2: Add Jenkins Repository</span>
<a id=__codelineno-85-5 name=__codelineno-85-5 href=#__codelineno-85-5></a>$<span class=w> </span>sudo<span class=w> </span>rpm<span class=w> </span>--import<span class=w> </span>https://pkg.jenkins.io/redhat/jenkins.io.key
<a id=__codelineno-85-6 name=__codelineno-85-6 href=#__codelineno-85-6></a>
<a id=__codelineno-85-7 name=__codelineno-85-7 href=#__codelineno-85-7></a><span class=c1># Step 3: Add Jenkins repo to the system</span>
<a id=__codelineno-85-8 name=__codelineno-85-8 href=#__codelineno-85-8></a>$<span class=w> </span>sudo<span class=w> </span>cat<span class=w> </span><span class=s>&lt;&lt;EOF &gt; /etc/yum.repos.d/jenkins.repo</span>
<a id=__codelineno-85-9 name=__codelineno-85-9 href=#__codelineno-85-9></a><span class=s>[jenkins]</span>
<a id=__codelineno-85-10 name=__codelineno-85-10 href=#__codelineno-85-10></a><span class=s>name=Jenkins</span>
<a id=__codelineno-85-11 name=__codelineno-85-11 href=#__codelineno-85-11></a><span class=s>baseurl=http://pkg.jenkins.io/redhat-stable</span>
<a id=__codelineno-85-12 name=__codelineno-85-12 href=#__codelineno-85-12></a><span class=s>gpgcheck=1</span>
<a id=__codelineno-85-13 name=__codelineno-85-13 href=#__codelineno-85-13></a><span class=s>EOF</span>
<a id=__codelineno-85-14 name=__codelineno-85-14 href=#__codelineno-85-14></a>
<a id=__codelineno-85-15 name=__codelineno-85-15 href=#__codelineno-85-15></a><span class=c1># Step 4: Install Jenkins</span>
<a id=__codelineno-85-16 name=__codelineno-85-16 href=#__codelineno-85-16></a>$<span class=w> </span>sudo<span class=w> </span>yum<span class=w> </span>install<span class=w> </span>Jenkins
<a id=__codelineno-85-17 name=__codelineno-85-17 href=#__codelineno-85-17></a>
<a id=__codelineno-85-18 name=__codelineno-85-18 href=#__codelineno-85-18></a><span class=c1># Step 5: Verify installation</span>
<a id=__codelineno-85-19 name=__codelineno-85-19 href=#__codelineno-85-19></a>$<span class=w> </span>sudo<span class=w> </span>systemctl<span class=w> </span>status<span class=w> </span>Jenkins
<a id=__codelineno-85-20 name=__codelineno-85-20 href=#__codelineno-85-20></a>
<a id=__codelineno-85-21 name=__codelineno-85-21 href=#__codelineno-85-21></a><span class=c1># Step 6: Once Jenkins is up and running, access it from the link:</span>
<a id=__codelineno-85-22 name=__codelineno-85-22 href=#__codelineno-85-22></a><span class=c1># http://localhost:8080</span>
</code></pre></div> </div> <div class=tabbed-block> <div class=highlight><pre><span></span><code><a id=__codelineno-86-1 name=__codelineno-86-1 href=#__codelineno-86-1></a><span class=c1># Step 1: Install Java</span>
<a id=__codelineno-86-2 name=__codelineno-86-2 href=#__codelineno-86-2></a>$<span class=w> </span>sudo<span class=w> </span>apt<span class=w> </span>update
<a id=__codelineno-86-3 name=__codelineno-86-3 href=#__codelineno-86-3></a>$<span class=w> </span>sudo<span class=w> </span>apt<span class=w> </span>install<span class=w> </span>fontconfig<span class=w> </span>openjdk-11-jre
<a id=__codelineno-86-4 name=__codelineno-86-4 href=#__codelineno-86-4></a>
<a id=__codelineno-86-5 name=__codelineno-86-5 href=#__codelineno-86-5></a><span class=c1># Step 2: Add Jenkins Repository</span>
<a id=__codelineno-86-6 name=__codelineno-86-6 href=#__codelineno-86-6></a>$<span class=w> </span>curl<span class=w> </span>-fsSL<span class=w> </span>https://pkg.jenkins.io/debian-stable/jenkins.io.key<span class=w> </span><span class=p>|</span><span class=w> </span>sudo<span class=w> </span>tee<span class=w> </span><span class=se>\</span>
<a id=__codelineno-86-7 name=__codelineno-86-7 href=#__codelineno-86-7></a><span class=w>  </span>/usr/share/keyrings/jenkins-keyring.asc<span class=w> </span>&gt;<span class=w> </span>/dev/null
<a id=__codelineno-86-8 name=__codelineno-86-8 href=#__codelineno-86-8></a>
<a id=__codelineno-86-9 name=__codelineno-86-9 href=#__codelineno-86-9></a><span class=c1># Step 3: Add Jenkins repo to the system</span>
<a id=__codelineno-86-10 name=__codelineno-86-10 href=#__codelineno-86-10></a>$<span class=w> </span><span class=nb>echo</span><span class=w> </span>deb<span class=w> </span><span class=o>[</span>signed-by<span class=o>=</span>/usr/share/keyrings/jenkins-keyring.asc<span class=o>]</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-86-11 name=__codelineno-86-11 href=#__codelineno-86-11></a><span class=w>  </span>https://pkg.jenkins.io/debian-stable<span class=w> </span>binary/<span class=w> </span><span class=p>|</span><span class=w> </span>sudo<span class=w> </span>tee<span class=w> </span><span class=se>\</span>
<a id=__codelineno-86-12 name=__codelineno-86-12 href=#__codelineno-86-12></a><span class=w>  </span>/etc/apt/sources.list.d/jenkins.list<span class=w> </span>&gt;<span class=w> </span>/dev/null
<a id=__codelineno-86-13 name=__codelineno-86-13 href=#__codelineno-86-13></a>
<a id=__codelineno-86-14 name=__codelineno-86-14 href=#__codelineno-86-14></a><span class=c1># Step 4: Install Jenkins</span>
<a id=__codelineno-86-15 name=__codelineno-86-15 href=#__codelineno-86-15></a>$<span class=w> </span>sudo<span class=w> </span>apt<span class=w> </span>update
<a id=__codelineno-86-16 name=__codelineno-86-16 href=#__codelineno-86-16></a>$<span class=w> </span>sudo<span class=w> </span>apt<span class=w> </span>install<span class=w> </span>Jenkins
<a id=__codelineno-86-17 name=__codelineno-86-17 href=#__codelineno-86-17></a>
<a id=__codelineno-86-18 name=__codelineno-86-18 href=#__codelineno-86-18></a><span class=c1># Step 5: Verify installation</span>
<a id=__codelineno-86-19 name=__codelineno-86-19 href=#__codelineno-86-19></a>$<span class=w> </span>systemctl<span class=w> </span>status<span class=w> </span>Jenkins
<a id=__codelineno-86-20 name=__codelineno-86-20 href=#__codelineno-86-20></a>
<a id=__codelineno-86-21 name=__codelineno-86-21 href=#__codelineno-86-21></a><span class=c1># Step 6: Once Jenkins is up and running, access it from the link:</span>
<a id=__codelineno-86-22 name=__codelineno-86-22 href=#__codelineno-86-22></a><span class=c1># http://localhost:8080</span>
</code></pre></div> </div> <div class=tabbed-block> <div class=highlight><pre><span></span><code><a id=__codelineno-87-1 name=__codelineno-87-1 href=#__codelineno-87-1></a>$<span class=w> </span>sudo<span class=w> </span>yum<span class=w> </span>install<span class=w> </span>fontconfig<span class=w> </span>java-11-openjdk
<a id=__codelineno-87-2 name=__codelineno-87-2 href=#__codelineno-87-2></a>$<span class=w> </span>sudo<span class=w> </span>wget<span class=w> </span>https://get.jenkins.io/war-stable/2.375.1/jenkins.war
<a id=__codelineno-87-3 name=__codelineno-87-3 href=#__codelineno-87-3></a>$<span class=w> </span>sudo<span class=w> </span>java<span class=w> </span>-jar<span class=w> </span>jenkins.war
<a id=__codelineno-87-4 name=__codelineno-87-4 href=#__codelineno-87-4></a>
<a id=__codelineno-87-5 name=__codelineno-87-5 href=#__codelineno-87-5></a><span class=c1># http://localhost:8080</span>
</code></pre></div> </div> <div class=tabbed-block> <div class=highlight><pre><span></span><code><a id=__codelineno-88-1 name=__codelineno-88-1 href=#__codelineno-88-1></a>$<span class=w> </span>sudo<span class=w> </span>mkdir<span class=w> </span>-p<span class=w> </span>/data/jenkins
<a id=__codelineno-88-2 name=__codelineno-88-2 href=#__codelineno-88-2></a>$<span class=w> </span>sudo<span class=w> </span>docker<span class=w> </span>run<span class=w> </span><span class=se>\</span>
<a id=__codelineno-88-3 name=__codelineno-88-3 href=#__codelineno-88-3></a><span class=w>  </span>--name<span class=w> </span>jenkins<span class=w> </span><span class=se>\</span>
<a id=__codelineno-88-4 name=__codelineno-88-4 href=#__codelineno-88-4></a><span class=w>  </span>-p<span class=w> </span><span class=m>8080</span>:8080<span class=w> </span><span class=se>\</span>
<a id=__codelineno-88-5 name=__codelineno-88-5 href=#__codelineno-88-5></a><span class=w>  </span>-p<span class=w> </span><span class=m>50000</span>:50000<span class=w> </span><span class=se>\</span>
<a id=__codelineno-88-6 name=__codelineno-88-6 href=#__codelineno-88-6></a><span class=w>  </span>--env<span class=w> </span><span class=nv>JENKINS_ADMIN_ID</span><span class=o>=</span>admin<span class=w> </span><span class=se>\</span>
<a id=__codelineno-88-7 name=__codelineno-88-7 href=#__codelineno-88-7></a><span class=w>  </span>--env<span class=w> </span><span class=nv>JENKINS_ADMIN_PASSWORD</span><span class=o>=</span>password<span class=w> </span><span class=se>\</span>
<a id=__codelineno-88-8 name=__codelineno-88-8 href=#__codelineno-88-8></a><span class=w>  </span>--restart<span class=w> </span>always<span class=w> </span><span class=se>\</span>
<a id=__codelineno-88-9 name=__codelineno-88-9 href=#__codelineno-88-9></a><span class=w>   </span>-v<span class=w> </span>/data/jenkins:/var/jenkins_home<span class=w> </span><span class=se>\</span>
<a id=__codelineno-88-10 name=__codelineno-88-10 href=#__codelineno-88-10></a><span class=w>  </span>jenkins:jenkins
<a id=__codelineno-88-11 name=__codelineno-88-11 href=#__codelineno-88-11></a>
<a id=__codelineno-88-12 name=__codelineno-88-12 href=#__codelineno-88-12></a><span class=c1># http://localhost:8080</span>
</code></pre></div> </div> </div> </div> <h4 id=2-docker-master-slave方式部推荐>2. docker-master-slave方式部(推荐)<a class=headerlink href=#2-docker-master-slave方式部推荐 title="Permanent link">&para;</a></h4> <p>首先需要一个Linux服务器，配置不低于2核CPU、4GB内存和40GB的硬盘。首先安装docker和docker-compose</p> <p>docker安装</p> <div class=highlight><pre><span></span><code><a id=__codelineno-89-1 name=__codelineno-89-1 href=#__codelineno-89-1></a>$<span class=w> </span>wget<span class=w> </span>https://download.docker.com/linux/static/stable/aarch64/docker-20.10.9.tgz
<a id=__codelineno-89-2 name=__codelineno-89-2 href=#__codelineno-89-2></a>$<span class=w> </span>tar<span class=w> </span>zxf<span class=w> </span>docker-20.10.9.tgz
<a id=__codelineno-89-3 name=__codelineno-89-3 href=#__codelineno-89-3></a>$<span class=w> </span>cp<span class=w> </span>docker/*<span class=w> </span>/usr/bin
<a id=__codelineno-89-4 name=__codelineno-89-4 href=#__codelineno-89-4></a>$<span class=w> </span>cat<span class=w> </span>&gt;/lib/systemd/system/docker.service<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-89-5 name=__codelineno-89-5 href=#__codelineno-89-5></a><span class=s>[Unit]</span>
<a id=__codelineno-89-6 name=__codelineno-89-6 href=#__codelineno-89-6></a><span class=s>Description=Docker Application Container Engine</span>
<a id=__codelineno-89-7 name=__codelineno-89-7 href=#__codelineno-89-7></a><span class=s>Documentation=https://docs.docker.com</span>
<a id=__codelineno-89-8 name=__codelineno-89-8 href=#__codelineno-89-8></a><span class=s>After=network-online.target firewalld.service</span>
<a id=__codelineno-89-9 name=__codelineno-89-9 href=#__codelineno-89-9></a><span class=s>Wants=network-online.target</span>
<a id=__codelineno-89-10 name=__codelineno-89-10 href=#__codelineno-89-10></a><span class=s>[Service]</span>
<a id=__codelineno-89-11 name=__codelineno-89-11 href=#__codelineno-89-11></a><span class=s>Type=notify</span>
<a id=__codelineno-89-12 name=__codelineno-89-12 href=#__codelineno-89-12></a><span class=s>ExecStart=/usr/bin/dockerd</span>
<a id=__codelineno-89-13 name=__codelineno-89-13 href=#__codelineno-89-13></a><span class=s>ExecReload=/bin/kill -s HUP $MAINPID</span>
<a id=__codelineno-89-14 name=__codelineno-89-14 href=#__codelineno-89-14></a><span class=s>LimitNOFILE=infinity</span>
<a id=__codelineno-89-15 name=__codelineno-89-15 href=#__codelineno-89-15></a><span class=s>LimitNPROC=infinity</span>
<a id=__codelineno-89-16 name=__codelineno-89-16 href=#__codelineno-89-16></a><span class=s>TimeoutStartSec=0</span>
<a id=__codelineno-89-17 name=__codelineno-89-17 href=#__codelineno-89-17></a><span class=s>Delegate=yes</span>
<a id=__codelineno-89-18 name=__codelineno-89-18 href=#__codelineno-89-18></a><span class=s>KillMode=process</span>
<a id=__codelineno-89-19 name=__codelineno-89-19 href=#__codelineno-89-19></a><span class=s>Restart=on-failure</span>
<a id=__codelineno-89-20 name=__codelineno-89-20 href=#__codelineno-89-20></a><span class=s>StartLimitBurst=3</span>
<a id=__codelineno-89-21 name=__codelineno-89-21 href=#__codelineno-89-21></a><span class=s>StartLimitInterval=60s</span>
<a id=__codelineno-89-22 name=__codelineno-89-22 href=#__codelineno-89-22></a><span class=s>[Install]</span>
<a id=__codelineno-89-23 name=__codelineno-89-23 href=#__codelineno-89-23></a><span class=s>WantedBy=multi-user.target</span>
<a id=__codelineno-89-24 name=__codelineno-89-24 href=#__codelineno-89-24></a><span class=s>EOF</span>
<a id=__codelineno-89-25 name=__codelineno-89-25 href=#__codelineno-89-25></a>
<a id=__codelineno-89-26 name=__codelineno-89-26 href=#__codelineno-89-26></a>$<span class=w> </span>systemctl<span class=w> </span>daemon-reload
<a id=__codelineno-89-27 name=__codelineno-89-27 href=#__codelineno-89-27></a>$<span class=w> </span>systemctl<span class=w> </span>start<span class=w> </span>docker<span class=w> </span>
<a id=__codelineno-89-28 name=__codelineno-89-28 href=#__codelineno-89-28></a>
<a id=__codelineno-89-29 name=__codelineno-89-29 href=#__codelineno-89-29></a>$<span class=w> </span>docker<span class=w> </span>version
<a id=__codelineno-89-30 name=__codelineno-89-30 href=#__codelineno-89-30></a>
<a id=__codelineno-89-31 name=__codelineno-89-31 href=#__codelineno-89-31></a><span class=c1># 如果镜像仓库未配置证书，则需要配置insecure-registry：</span>
<a id=__codelineno-89-32 name=__codelineno-89-32 href=#__codelineno-89-32></a>$<span class=w> </span>cat<span class=w> </span>&gt;<span class=w> </span>/etc/docker/daemon.json<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39;</span>
<a id=__codelineno-89-33 name=__codelineno-89-33 href=#__codelineno-89-33></a><span class=s>{</span>
<a id=__codelineno-89-34 name=__codelineno-89-34 href=#__codelineno-89-34></a><span class=s>  &quot;graph&quot;: &quot;/data/docker&quot;,</span>
<a id=__codelineno-89-35 name=__codelineno-89-35 href=#__codelineno-89-35></a><span class=s>  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span>
<a id=__codelineno-89-36 name=__codelineno-89-36 href=#__codelineno-89-36></a><span class=s>  &quot;insecure-registries&quot;: [&quot;hub.gitee.cc&quot;],</span>
<a id=__codelineno-89-37 name=__codelineno-89-37 href=#__codelineno-89-37></a><span class=s>  &quot;registry-mirrors&quot;: [&quot;https://25bxwt20.mirror.aliyuncs.com&quot;],</span>
<a id=__codelineno-89-38 name=__codelineno-89-38 href=#__codelineno-89-38></a><span class=s>  &quot;live-restore&quot;: true,</span>
<a id=__codelineno-89-39 name=__codelineno-89-39 href=#__codelineno-89-39></a><span class=s>  &quot;bip&quot;: &quot;172.16.200.1/24&quot;,</span>
<a id=__codelineno-89-40 name=__codelineno-89-40 href=#__codelineno-89-40></a><span class=s>  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span>
<a id=__codelineno-89-41 name=__codelineno-89-41 href=#__codelineno-89-41></a><span class=s>  &quot;hosts&quot;: [&quot;tcp://0.0.0.0:2375&quot;, &quot;unix:///var/run/docker.sock&quot;],</span>
<a id=__codelineno-89-42 name=__codelineno-89-42 href=#__codelineno-89-42></a><span class=s>  &quot;log-opts&quot;: {</span>
<a id=__codelineno-89-43 name=__codelineno-89-43 href=#__codelineno-89-43></a><span class=s>    &quot;max-size&quot;:&quot;100M&quot;,</span>
<a id=__codelineno-89-44 name=__codelineno-89-44 href=#__codelineno-89-44></a><span class=s>    &quot;max-file&quot;:&quot;3&quot;</span>
<a id=__codelineno-89-45 name=__codelineno-89-45 href=#__codelineno-89-45></a><span class=s>  }</span>
<a id=__codelineno-89-46 name=__codelineno-89-46 href=#__codelineno-89-46></a><span class=s>}</span>
<a id=__codelineno-89-47 name=__codelineno-89-47 href=#__codelineno-89-47></a><span class=s>EOF</span>
<a id=__codelineno-89-48 name=__codelineno-89-48 href=#__codelineno-89-48></a>$<span class=w> </span>systemctl<span class=w> </span>restart<span class=w> </span>docker
</code></pre></div> <p>docker-compose安装</p> <div class=highlight><pre><span></span><code><a id=__codelineno-90-1 name=__codelineno-90-1 href=#__codelineno-90-1></a>$<span class=w> </span>sudo<span class=w> </span>curl<span class=w> </span>-L<span class=w> </span>https://get.daocloud.io/docker/compose/releases/download/v2.4.1/docker-compose-<span class=sb>`</span>uname<span class=w> </span>-s<span class=sb>`</span>-<span class=sb>`</span>uname<span class=w> </span>-m<span class=sb>`</span><span class=w> </span>&gt;<span class=w> </span>/usr/local/bin/docker-compose
<a id=__codelineno-90-2 name=__codelineno-90-2 href=#__codelineno-90-2></a>
<a id=__codelineno-90-3 name=__codelineno-90-3 href=#__codelineno-90-3></a>$<span class=w> </span>sudo<span class=w> </span>chmod<span class=w> </span>+x<span class=w> </span>/usr/local/bin/docker-compose
<a id=__codelineno-90-4 name=__codelineno-90-4 href=#__codelineno-90-4></a>$<span class=w> </span>sudo<span class=w> </span>ln<span class=w> </span>-s<span class=w> </span>/usr/local/bin/docker-compose<span class=w> </span>/usr/bin/docker-compose
<a id=__codelineno-90-5 name=__codelineno-90-5 href=#__codelineno-90-5></a>
<a id=__codelineno-90-6 name=__codelineno-90-6 href=#__codelineno-90-6></a>$<span class=w> </span>docker-compose<span class=w> </span>version
<a id=__codelineno-90-7 name=__codelineno-90-7 href=#__codelineno-90-7></a>Docker<span class=w> </span>Compose<span class=w> </span>version<span class=w> </span>v2.4.1
</code></pre></div> <p><strong>组成部分</strong></p> <ul> <li>master 接收 webhook ，调度任务等</li> <li>agent 执行构建任务</li> <li>dind 构建镜像</li> </ul> <p><strong>开始部署</strong></p> <p>仓库地址： <a href=https://gitee.com/hujianli94net/simple-jenkins.git>https://gitee.com/hujianli94net/simple-jenkins.git</a></p> <p>部署 master</p> <ul> <li>修改持久化目录属主为 1000:1000</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-91-1 name=__codelineno-91-1 href=#__codelineno-91-1></a>mkdir<span class=w> </span>devops<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nb>cd</span><span class=w> </span>devops
<a id=__codelineno-91-2 name=__codelineno-91-2 href=#__codelineno-91-2></a>git<span class=w> </span>clone<span class=w> </span>https://gitee.com/hujianli94net/simple-jenkins.git
<a id=__codelineno-91-3 name=__codelineno-91-3 href=#__codelineno-91-3></a><span class=nb>cd</span><span class=w> </span>simple-jenkins/jenkins/master
<a id=__codelineno-91-4 name=__codelineno-91-4 href=#__codelineno-91-4></a>chown<span class=w> </span>-R<span class=w> </span><span class=m>1000</span>:1000<span class=w> </span>jenkins_home
<a id=__codelineno-91-5 name=__codelineno-91-5 href=#__codelineno-91-5></a>chown<span class=w> </span>-R<span class=w> </span><span class=m>1000</span>:1000<span class=w> </span>init.groovy.d
</code></pre></div> <ul> <li>执行 docker-compose 命令完成部署</li> </ul> <p>创建 docker network</p> <div class=highlight><pre><span></span><code><a id=__codelineno-92-1 name=__codelineno-92-1 href=#__codelineno-92-1></a>docker<span class=w> </span>network<span class=w> </span>create<span class=w> </span>-d<span class=w> </span>bridge<span class=w> </span>jenkins-cluster
</code></pre></div> <p>启动</p> <div class=highlight><pre><span></span><code><a id=__codelineno-93-1 name=__codelineno-93-1 href=#__codelineno-93-1></a>docker-compose up -d
</code></pre></div> <ul> <li>完成初始化并安装插件</li> </ul> <p>blueocean 镜像已包含常用插件，在首次访问 Jenkins 时，<strong>选择安装推荐插件即可。</strong></p> <p>在安装之前先配置国内的插件源，单击Advanced，将插件源更改为国内插件源(<a href=https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json>https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</a>）</p> <p>初始化完成后，登录 Jenkins ，进入“系统管理-&gt;插件管理-&gt;可选插件” 在搜索框搜索如下插件安装。</p> <blockquote> <ul> <li>Git Parameter</li> <li>Build With Parameters</li> <li>Timestamper</li> <li>Git Pipeline for Blue Ocean</li> <li>GitLab</li> <li>GitLab Authentication</li> <li>GitLab Branch Source</li> <li>Generic Webhook Trigger</li> <li>Image Tag Parameter</li> <li> <p>Workspace Cleanup</p> </li> <li> <p>Role-based Authorization Strategy</p> </li> <li>Email Extension Template</li> <li>Git Pipeline for Blue Ocean</li> <li>Pipeline: GitHub</li> <li>Blue Ocean </li> <li>Blue Ocean Pipeline Editor</li> <li>Web for Blue Ocean</li> <li>Blue Ocean Core JS</li> <li>Pipeline SCM API for Blue Ocean</li> <li>Dashboard for Blue Ocean</li> <li>Build With Parameters</li> <li>Dynamic Extended Choice Parameter Plug-In</li> <li>Extended Choice Parameter</li> <li>List Git Branches Parameter</li> <li>Pipeline</li> <li>Pipeline: Deprecated Groovy Libraries</li> <li>SSH Pipeline Steps</li> <li>Kubernetes</li> <li>Kubernetes CLI</li> <li>Kubernetes Credentials</li> <li>Kubernetes Client API</li> <li>Active Choices</li> <li>Design Language</li> <li>REST API for Blue Ocean</li> <li>REST Implementation for Blue Ocean</li> </ul> </blockquote> <p>勾选后，单击Download now and install after restart，之后可以在Installed选项卡下看到已经安装的插件。</p> <ul> <li>配置 Gitee 插件</li> </ul> <p>完成 gitee 插件安装后，进入“系统管理-&gt;系统配置”，定位到 “Gitee 配置” 部分，创建证书令牌（需要先在 <a href=https://gitee.com/profile/personal_access_tokens>Gitee</a> 创建 Gitee API V5 的私人令牌），并完成配置。</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-4.png></p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-5.png></p> <p>点击测试连接。显示成功就保存，继续往后操作</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-6.png></p> <ul> <li>新建 agent</li> </ul> <p>进入 “系统管理-&gt;节点列表” ，点击新建节点</p> <p>创建两个“固定节点”，节点配置如下</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-7.png></p> <p>创建完成后，点击节点，查看节点连接信息，部署 agent 时需要提供该连接信息</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-8.png></p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-9.png></p> <p><strong>部署 agent</strong></p> <ul> <li>构建自定义 agent 镜像</li> </ul> <p>下载 kubectl 、 docker 、 helm 二进制文件</p> <div class="admonition tip"> <p class=admonition-title>docker二进制下载地址</p> <p><a href=https://download.docker.com/linux/static/stable/x86_64/ >https://download.docker.com/linux/static/stable/x86_64/</a></p> </div> <div class=highlight><pre><span></span><code><a id=__codelineno-94-1 name=__codelineno-94-1 href=#__codelineno-94-1></a>$<span class=w> </span><span class=nb>cd</span><span class=w> </span>jenkins/agent/bin
<a id=__codelineno-94-2 name=__codelineno-94-2 href=#__codelineno-94-2></a>
<a id=__codelineno-94-3 name=__codelineno-94-3 href=#__codelineno-94-3></a><span class=c1>## 下载helm</span>
<a id=__codelineno-94-4 name=__codelineno-94-4 href=#__codelineno-94-4></a>$<span class=w> </span>wget<span class=w> </span>-c<span class=w> </span>https://repo.huaweicloud.com/helm/v3.8.0/helm-v3.8.0-linux-386.tar.gz
<a id=__codelineno-94-5 name=__codelineno-94-5 href=#__codelineno-94-5></a>
<a id=__codelineno-94-6 name=__codelineno-94-6 href=#__codelineno-94-6></a><span class=c1>## 例如，要在 Linux 中下载 v1.21.0 版本，请输入：</span>
<a id=__codelineno-94-7 name=__codelineno-94-7 href=#__codelineno-94-7></a>$<span class=w> </span>curl<span class=w> </span>-LO<span class=w> </span>https://dl.k8s.io/release/v1.21.0/bin/linux/amd64/kubectl
<a id=__codelineno-94-8 name=__codelineno-94-8 href=#__codelineno-94-8></a>
<a id=__codelineno-94-9 name=__codelineno-94-9 href=#__codelineno-94-9></a>$<span class=w> </span>chmod<span class=w> </span>+x<span class=w> </span>*
<a id=__codelineno-94-10 name=__codelineno-94-10 href=#__codelineno-94-10></a>
<a id=__codelineno-94-11 name=__codelineno-94-11 href=#__codelineno-94-11></a><span class=c1># ll</span>
<a id=__codelineno-94-12 name=__codelineno-94-12 href=#__codelineno-94-12></a>total<span class=w> </span><span class=m>134552</span>
<a id=__codelineno-94-13 name=__codelineno-94-13 href=#__codelineno-94-13></a>-rwxr-xr-x<span class=w> </span><span class=m>1</span><span class=w> </span>root<span class=w> </span>root<span class=w> </span><span class=m>50707288</span><span class=w> </span>Feb<span class=w> </span><span class=m>14</span><span class=w> </span><span class=m>16</span>:45<span class=w> </span>docker
<a id=__codelineno-94-14 name=__codelineno-94-14 href=#__codelineno-94-14></a>-rwxr-xr-x<span class=w> </span><span class=m>1</span><span class=w> </span><span class=m>3434</span><span class=w> </span><span class=m>3434</span><span class=w> </span><span class=m>40636416</span><span class=w> </span>Jan<span class=w> </span><span class=m>25</span><span class=w>  </span><span class=m>2022</span><span class=w> </span>helm
<a id=__codelineno-94-15 name=__codelineno-94-15 href=#__codelineno-94-15></a>-rwxr-xr-x<span class=w> </span><span class=m>1</span><span class=w> </span>root<span class=w> </span>root<span class=w> </span><span class=m>46436352</span><span class=w> </span>Feb<span class=w> </span><span class=m>14</span><span class=w> </span><span class=m>16</span>:44<span class=w> </span>kubectl
</code></pre></div> <p>准备 .kube 和 .docker 文件夹，用于授权访问 kubernetes api-server 和 harbor 镜像仓库</p> <p><code>.kube/config</code> 从 kubernetes 集群内获取,</p> <p>创建 <code>.docker/config.json</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-95-1 name=__codelineno-95-1 href=#__codelineno-95-1></a><span class=nv>harbor_addr</span><span class=o>=</span>hub.gitee.cc
<a id=__codelineno-95-2 name=__codelineno-95-2 href=#__codelineno-95-2></a><span class=nv>harbor_username</span><span class=o>=</span>admin
<a id=__codelineno-95-3 name=__codelineno-95-3 href=#__codelineno-95-3></a><span class=nv>harbor_password</span><span class=o>=</span>oschina123
<a id=__codelineno-95-4 name=__codelineno-95-4 href=#__codelineno-95-4></a><span class=nv>auth_str</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span><span class=w> </span>-ne<span class=w> </span><span class=s2>&quot;</span><span class=nv>$harbor_username</span><span class=s2>:</span><span class=nv>$harbor_password</span><span class=s2>&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>base64<span class=k>)</span>
<a id=__codelineno-95-5 name=__codelineno-95-5 href=#__codelineno-95-5></a>cat<span class=w> </span>&gt;<span class=w> </span>.docker/config.json<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-95-6 name=__codelineno-95-6 href=#__codelineno-95-6></a><span class=s>{</span>
<a id=__codelineno-95-7 name=__codelineno-95-7 href=#__codelineno-95-7></a><span class=s>        &quot;auths&quot;: {</span>
<a id=__codelineno-95-8 name=__codelineno-95-8 href=#__codelineno-95-8></a><span class=s>                &quot;$harbor_addr&quot;: {</span>
<a id=__codelineno-95-9 name=__codelineno-95-9 href=#__codelineno-95-9></a><span class=s>                        &quot;auth&quot;: &quot;$auth_str&quot;</span>
<a id=__codelineno-95-10 name=__codelineno-95-10 href=#__codelineno-95-10></a><span class=s>                }</span>
<a id=__codelineno-95-11 name=__codelineno-95-11 href=#__codelineno-95-11></a><span class=s>        }</span>
<a id=__codelineno-95-12 name=__codelineno-95-12 href=#__codelineno-95-12></a><span class=s>}</span>
<a id=__codelineno-95-13 name=__codelineno-95-13 href=#__codelineno-95-13></a><span class=s>EOF</span>
</code></pre></div> <p>docker build agent 镜像</p> <div class=highlight><pre><span></span><code><a id=__codelineno-96-1 name=__codelineno-96-1 href=#__codelineno-96-1></a>$<span class=w> </span>docker<span class=w> </span>build<span class=w> </span>-t<span class=w> </span><span class=nv>$harbor_addr</span>/jenkins/inbound-agent:4.11-1-kube<span class=w> </span>.
<a id=__codelineno-96-2 name=__codelineno-96-2 href=#__codelineno-96-2></a>
<a id=__codelineno-96-3 name=__codelineno-96-3 href=#__codelineno-96-3></a><span class=c1># 推送镜像到harbor仓库，habor仓库需要提前部署</span>
<a id=__codelineno-96-4 name=__codelineno-96-4 href=#__codelineno-96-4></a>$<span class=w> </span>docker<span class=w> </span>push<span class=w> </span><span class=nv>$harbor_addr</span>/jenkins/inbound-agent:4.11-1-kube
</code></pre></div> <ul> <li>执行 docker-compose 命令完成部署</li> </ul> <p>修改 docker-compose.yml 中的 secret 个 agent_name ，对应于上面 master 中创建的节点连接信息</p> <div class=highlight><pre><span></span><code><a id=__codelineno-97-1 name=__codelineno-97-1 href=#__codelineno-97-1></a>$<span class=w> </span>chown<span class=w> </span>-R<span class=w> </span><span class=m>1000</span>:1000<span class=w> </span>/root/devops/simple-jenkins/jenkins/agent/
<a id=__codelineno-97-2 name=__codelineno-97-2 href=#__codelineno-97-2></a>$<span class=w> </span>docker-compose<span class=w> </span>up<span class=w> </span>-d
</code></pre></div> <p><strong>部署 dind</strong></p> <ul> <li>创建 daemon.json</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-98-1 name=__codelineno-98-1 href=#__codelineno-98-1></a>$<span class=w> </span><span class=nb>cd</span><span class=w> </span>dind
<a id=__codelineno-98-2 name=__codelineno-98-2 href=#__codelineno-98-2></a>$<span class=w> </span><span class=nv>harbor_addr</span><span class=o>=</span>hub.gitee.cc
<a id=__codelineno-98-3 name=__codelineno-98-3 href=#__codelineno-98-3></a>$<span class=w> </span><span class=nv>dns_addr</span><span class=o>=</span><span class=m>192</span>.168.1.60
<a id=__codelineno-98-4 name=__codelineno-98-4 href=#__codelineno-98-4></a>$<span class=w> </span>cat<span class=w> </span>&gt;<span class=w> </span>etc/daemon.json<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-98-5 name=__codelineno-98-5 href=#__codelineno-98-5></a><span class=s>{</span>
<a id=__codelineno-98-6 name=__codelineno-98-6 href=#__codelineno-98-6></a><span class=s>  &quot;registry-mirrors&quot;: [&quot;https://gfty7g09.mirror.aliyuncs.com&quot;],</span>
<a id=__codelineno-98-7 name=__codelineno-98-7 href=#__codelineno-98-7></a><span class=s>  &quot;insecure-registries&quot;: [&quot;$harbor_addr&quot;],</span>
<a id=__codelineno-98-8 name=__codelineno-98-8 href=#__codelineno-98-8></a><span class=s>  &quot;live-restore&quot;: true,</span>
<a id=__codelineno-98-9 name=__codelineno-98-9 href=#__codelineno-98-9></a><span class=s>  &quot;default-shm-size&quot;: &quot;128M&quot;,</span>
<a id=__codelineno-98-10 name=__codelineno-98-10 href=#__codelineno-98-10></a><span class=s>  &quot;max-concurrent-downloads&quot;: 10,</span>
<a id=__codelineno-98-11 name=__codelineno-98-11 href=#__codelineno-98-11></a><span class=s>  &quot;oom-score-adjust&quot;: -1000,</span>
<a id=__codelineno-98-12 name=__codelineno-98-12 href=#__codelineno-98-12></a><span class=s>  &quot;log-driver&quot;: &quot;json-file&quot;,</span>
<a id=__codelineno-98-13 name=__codelineno-98-13 href=#__codelineno-98-13></a><span class=s>  &quot;log-opts&quot;: {</span>
<a id=__codelineno-98-14 name=__codelineno-98-14 href=#__codelineno-98-14></a><span class=s>    &quot;max-size&quot;: &quot;100m&quot;</span>
<a id=__codelineno-98-15 name=__codelineno-98-15 href=#__codelineno-98-15></a><span class=s>  },</span>
<a id=__codelineno-98-16 name=__codelineno-98-16 href=#__codelineno-98-16></a><span class=s>  &quot;dns&quot;: [</span>
<a id=__codelineno-98-17 name=__codelineno-98-17 href=#__codelineno-98-17></a><span class=s>    &quot;$dns_addr&quot;</span>
<a id=__codelineno-98-18 name=__codelineno-98-18 href=#__codelineno-98-18></a><span class=s>  ]</span>
<a id=__codelineno-98-19 name=__codelineno-98-19 href=#__codelineno-98-19></a><span class=s>}</span>
<a id=__codelineno-98-20 name=__codelineno-98-20 href=#__codelineno-98-20></a><span class=s>EOF</span>
</code></pre></div> <ul> <li>执行 docker-compose 命令完成部署</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-99-1 name=__codelineno-99-1 href=#__codelineno-99-1></a>$<span class=w> </span>docker-compose<span class=w> </span>up<span class=w> </span>-d
</code></pre></div> <p>查看所有容器</p> <div class=highlight><pre><span></span><code><a id=__codelineno-100-1 name=__codelineno-100-1 href=#__codelineno-100-1></a>$<span class=w> </span>docker<span class=w> </span>ps
<a id=__codelineno-100-2 name=__codelineno-100-2 href=#__codelineno-100-2></a>CONTAINER<span class=w> </span>ID<span class=w>   </span>IMAGE<span class=w>                                            </span>COMMAND<span class=w>                  </span>CREATED<span class=w>              </span>STATUS<span class=w>              </span>PORTS<span class=w>                                                                                      </span>NAMES
<a id=__codelineno-100-3 name=__codelineno-100-3 href=#__codelineno-100-3></a>425c73c120ec<span class=w>   </span>docker:20.10.10-dind<span class=w>                             </span><span class=s2>&quot;dockerd-entrypoint.…&quot;</span><span class=w>   </span><span class=m>36</span><span class=w> </span>seconds<span class=w> </span>ago<span class=w>       </span>Up<span class=w> </span><span class=m>16</span><span class=w> </span>seconds<span class=w>       </span><span class=m>2375</span>-2376/tcp<span class=w>                                                                              </span>dind-docker01-1
<a id=__codelineno-100-4 name=__codelineno-100-4 href=#__codelineno-100-4></a>89f9bcfd1f12<span class=w>   </span>docker:20.10.10-dind<span class=w>                             </span><span class=s2>&quot;dockerd-entrypoint.…&quot;</span><span class=w>   </span><span class=m>36</span><span class=w> </span>seconds<span class=w> </span>ago<span class=w>       </span>Up<span class=w> </span><span class=m>16</span><span class=w> </span>seconds<span class=w>       </span><span class=m>2375</span>-2376/tcp<span class=w>                                                                              </span>dind-docker02-1
<a id=__codelineno-100-5 name=__codelineno-100-5 href=#__codelineno-100-5></a>6bd628bfba16<span class=w>   </span>hub.gitee.cc/jenkins/inbound-agent:4.11-1-kube<span class=w>   </span><span class=s2>&quot;/usr/local/bin/jenk…&quot;</span><span class=w>   </span>About<span class=w> </span>a<span class=w> </span>minute<span class=w> </span>ago<span class=w>   </span>Up<span class=w> </span>About<span class=w> </span>a<span class=w> </span>minute<span class=w>                                                                                              </span>agent-agent02-1
<a id=__codelineno-100-6 name=__codelineno-100-6 href=#__codelineno-100-6></a>171340672a53<span class=w>   </span>hub.gitee.cc/jenkins/inbound-agent:4.11-1-kube<span class=w>   </span><span class=s2>&quot;/usr/local/bin/jenk…&quot;</span><span class=w>   </span>About<span class=w> </span>a<span class=w> </span>minute<span class=w> </span>ago<span class=w>   </span>Up<span class=w> </span>About<span class=w> </span>a<span class=w> </span>minute<span class=w>                                                                                              </span>agent-agent01-1
<a id=__codelineno-100-7 name=__codelineno-100-7 href=#__codelineno-100-7></a>0e4f1c2ca769<span class=w>   </span>jenkins/jenkins:2.390-jdk11<span class=w>                      </span><span class=s2>&quot;/usr/bin/tini -- /u…&quot;</span><span class=w>   </span><span class=m>11</span><span class=w> </span>minutes<span class=w> </span>ago<span class=w>       </span>Up<span class=w> </span><span class=m>11</span><span class=w> </span>minutes<span class=w>       </span><span class=m>0</span>.0.0.0:8080-&gt;8080/tcp,<span class=w> </span>:::8080-&gt;8080/tcp,<span class=w> </span><span class=m>0</span>.0.0.0:50000-&gt;50000/tcp,<span class=w> </span>:::50000-&gt;50000/tcp<span class=w>   </span>jenkins-master
</code></pre></div> <p>完成</p> <h4 id=3-helm方式部署推荐>3. helm方式部署(推荐)<a class=headerlink href=#3-helm方式部署推荐 title="Permanent link">&para;</a></h4> <h6 id=31-部署nfs>3.1 部署nfs<a class=headerlink href=#31-部署nfs title="Permanent link">&para;</a></h6> <p>准备一块&gt;2T的数据盘，格式化后挂载到/data目录下。/data目录为nfs的数据目录。</p> <p>直接命令安装，示例如下</p> <div class=highlight><pre><span></span><code><a id=__codelineno-101-1 name=__codelineno-101-1 href=#__codelineno-101-1></a>$<span class=w> </span>docker<span class=w> </span>run<span class=w> </span>-d<span class=w> </span>--name<span class=w> </span>nfs<span class=w> </span>--privileged<span class=w> </span>-v<span class=w> </span>/data:/nfsshare<span class=w> </span>-e<span class=w> </span><span class=nv>SHARED_DIRECTORY</span><span class=o>=</span>/nfsshare<span class=w> </span>itsthenetwork/nfs-server-alpine:latest
</code></pre></div> <p>docker-compose部署</p> <p><code>docker-compose.yaml</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-102-1 name=__codelineno-102-1 href=#__codelineno-102-1></a><span class=nn>---</span>
<a id=__codelineno-102-2 name=__codelineno-102-2 href=#__codelineno-102-2></a><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s>&#39;3&#39;</span>
<a id=__codelineno-102-3 name=__codelineno-102-3 href=#__codelineno-102-3></a>
<a id=__codelineno-102-4 name=__codelineno-102-4 href=#__codelineno-102-4></a><span class=nt>services</span><span class=p>:</span>
<a id=__codelineno-102-5 name=__codelineno-102-5 href=#__codelineno-102-5></a><span class=w>  </span><span class=nt>nfs</span><span class=p>:</span>
<a id=__codelineno-102-6 name=__codelineno-102-6 href=#__codelineno-102-6></a><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">atompi/nfs-server:9</span>
<a id=__codelineno-102-7 name=__codelineno-102-7 href=#__codelineno-102-7></a><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
<a id=__codelineno-102-8 name=__codelineno-102-8 href=#__codelineno-102-8></a><span class=w>    </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-102-9 name=__codelineno-102-9 href=#__codelineno-102-9></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;2049:2049&quot;</span>
<a id=__codelineno-102-10 name=__codelineno-102-10 href=#__codelineno-102-10></a><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span>
<a id=__codelineno-102-11 name=__codelineno-102-11 href=#__codelineno-102-11></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/data/nfs:/nfsshare</span>
<a id=__codelineno-102-12 name=__codelineno-102-12 href=#__codelineno-102-12></a><span class=w>    </span><span class=nt>environment</span><span class=p>:</span>
<a id=__codelineno-102-13 name=__codelineno-102-13 href=#__codelineno-102-13></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">SHARED_DIRECTORY=/nfsshare</span>
<a id=__codelineno-102-14 name=__codelineno-102-14 href=#__codelineno-102-14></a><span class=w>    </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div> <div class="admonition tip"> <p class=admonition-title>可参考文献</p> <p><a href=https://github.com/ehough/docker-nfs-server.git>https://github.com/ehough/docker-nfs-server.git</a></p> <p><a href=https://github.com/sjiveson/nfs-server-alpine>https://github.com/sjiveson/nfs-server-alpine</a></p> <p><a href=https://gitee.com/atompi/nfs-server-docker>https://gitee.com/atompi/nfs-server-docker</a></p> </div> <h6 id=32-部署storageclass>3.2 部署StorageClass<a class=headerlink href=#32-部署storageclass title="Permanent link">&para;</a></h6> <blockquote> <p>GitHub 地址：<a href=https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner>https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner</a></p> <p>Chart 仓库地址：<a href=https://artifacthub.io/packages/helm/nfs-subdir-external-provisioner/nfs-subdir-external-provisioner>https://artifacthub.io/packages/helm/nfs-subdir-external-provisioner/nfs-subdir-external-provisioner</a></p> </blockquote> <p>nfs-subdir-external-provisioner使用方法</p> <div class=highlight><pre><span></span><code><a id=__codelineno-103-1 name=__codelineno-103-1 href=#__codelineno-103-1></a>$<span class=w> </span>helm<span class=w> </span>repo<span class=w> </span>add<span class=w> </span>nfs-subdir-external-provisioner<span class=w> </span>https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/
<a id=__codelineno-103-2 name=__codelineno-103-2 href=#__codelineno-103-2></a>$<span class=w> </span>helm<span class=w> </span>repo<span class=w> </span>update
<a id=__codelineno-103-3 name=__codelineno-103-3 href=#__codelineno-103-3></a>
<a id=__codelineno-103-4 name=__codelineno-103-4 href=#__codelineno-103-4></a><span class=c1># 可以下载到本地离线安装</span>
<a id=__codelineno-103-5 name=__codelineno-103-5 href=#__codelineno-103-5></a><span class=c1># helm pull nfs-subdir-external-provisioner/nfs-subdir-external-provisioner --version 4.0.17 --untar</span>
<a id=__codelineno-103-6 name=__codelineno-103-6 href=#__codelineno-103-6></a>
<a id=__codelineno-103-7 name=__codelineno-103-7 href=#__codelineno-103-7></a><span class=c1># 默认镜像</span>
<a id=__codelineno-103-8 name=__codelineno-103-8 href=#__codelineno-103-8></a>helm<span class=w> </span>install<span class=w> </span>nfs-subdir-external-provisioner<span class=w> </span>nfs-subdir-external-provisioner/nfs-subdir-external-provisioner
<a id=__codelineno-103-9 name=__codelineno-103-9 href=#__codelineno-103-9></a>--set<span class=w> </span>nfs.server<span class=o>=</span><span class=m>172</span>.18.0.95<span class=w> </span><span class=se>\</span>
<a id=__codelineno-103-10 name=__codelineno-103-10 href=#__codelineno-103-10></a>--set<span class=w> </span>nfs.path<span class=o>=</span>/gitee<span class=w> </span><span class=se>\</span>
<a id=__codelineno-103-11 name=__codelineno-103-11 href=#__codelineno-103-11></a>--set<span class=w> </span>storageClass.name<span class=o>=</span>gitee-nfs-client<span class=w> </span><span class=se>\</span>
<a id=__codelineno-103-12 name=__codelineno-103-12 href=#__codelineno-103-12></a>--set<span class=w> </span>storageClass.reclaimPolicy<span class=o>=</span><span class=s2>&quot;Retain&quot;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-103-13 name=__codelineno-103-13 href=#__codelineno-103-13></a>--namespace<span class=w> </span>nfs-sc<span class=w> </span>--create-namespace
<a id=__codelineno-103-14 name=__codelineno-103-14 href=#__codelineno-103-14></a>
<a id=__codelineno-103-15 name=__codelineno-103-15 href=#__codelineno-103-15></a>
<a id=__codelineno-103-16 name=__codelineno-103-16 href=#__codelineno-103-16></a><span class=c1># --------------------- 认镜像下载网络受限，使用中国内部镜像 ------------------------------------</span>
<a id=__codelineno-103-17 name=__codelineno-103-17 href=#__codelineno-103-17></a>helm<span class=w> </span>install<span class=w> </span>nfs-subdir-external-provisioner<span class=w> </span>nfs-subdir-external-provisioner/nfs-subdir-external-provisioner<span class=w> </span><span class=se>\</span>
<a id=__codelineno-103-18 name=__codelineno-103-18 href=#__codelineno-103-18></a>--set<span class=w> </span>image.repository<span class=o>=</span>easzlab/nfs-subdir-external-provisioner<span class=w> </span><span class=se>\</span>
<a id=__codelineno-103-19 name=__codelineno-103-19 href=#__codelineno-103-19></a>--set<span class=w> </span>image.tag<span class=o>=</span>v4.0.2<span class=w> </span><span class=se>\</span>
<a id=__codelineno-103-20 name=__codelineno-103-20 href=#__codelineno-103-20></a>--set<span class=w> </span>nfs.server<span class=o>=</span><span class=m>192</span>.168.1.60<span class=w> </span><span class=se>\</span>
<a id=__codelineno-103-21 name=__codelineno-103-21 href=#__codelineno-103-21></a>--set<span class=w> </span>nfs.path<span class=o>=</span>/QaTest<span class=w> </span><span class=se>\</span>
<a id=__codelineno-103-22 name=__codelineno-103-22 href=#__codelineno-103-22></a>--set<span class=w> </span>storageClass.name<span class=o>=</span>gitee-nfs-client<span class=w> </span><span class=se>\</span>
<a id=__codelineno-103-23 name=__codelineno-103-23 href=#__codelineno-103-23></a>--set<span class=w> </span>storageClass.reclaimPolicy<span class=o>=</span><span class=s2>&quot;Retain&quot;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-103-24 name=__codelineno-103-24 href=#__codelineno-103-24></a>--namespace<span class=w> </span>nfs-sc<span class=w> </span>--create-namespace
</code></pre></div> <p>检查StorageClass部署状态</p> <div class=highlight><pre><span></span><code><a id=__codelineno-104-1 name=__codelineno-104-1 href=#__codelineno-104-1></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pod<span class=w> </span>-n<span class=w> </span>nfs-sc
<a id=__codelineno-104-2 name=__codelineno-104-2 href=#__codelineno-104-2></a>NAME<span class=w>                                               </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>   </span>AGE
<a id=__codelineno-104-3 name=__codelineno-104-3 href=#__codelineno-104-3></a>nfs-subdir-external-provisioner-7fdff5bfc9-q28qc<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>2m49s
<a id=__codelineno-104-4 name=__codelineno-104-4 href=#__codelineno-104-4></a>
<a id=__codelineno-104-5 name=__codelineno-104-5 href=#__codelineno-104-5></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>sc
<a id=__codelineno-104-6 name=__codelineno-104-6 href=#__codelineno-104-6></a>NAME<span class=w>               </span>PROVISIONER<span class=w>                                     </span>RECLAIMPOLICY<span class=w>   </span>VOLUMEBINDINGMODE<span class=w>   </span>ALLOWVOLUMEEXPANSION<span class=w>   </span>AGE
<a id=__codelineno-104-7 name=__codelineno-104-7 href=#__codelineno-104-7></a>gitee-nfs-client<span class=w>   </span>cluster.local/nfs-subdir-external-provisioner<span class=w>   </span>Retain<span class=w>          </span>Immediate<span class=w>           </span><span class=nb>true</span><span class=w>                   </span>2m54s
<a id=__codelineno-104-8 name=__codelineno-104-8 href=#__codelineno-104-8></a>
<a id=__codelineno-104-9 name=__codelineno-104-9 href=#__codelineno-104-9></a>$<span class=w> </span>helm<span class=w> </span>list<span class=w> </span>-n<span class=w> </span>nfs-sc
<a id=__codelineno-104-10 name=__codelineno-104-10 href=#__codelineno-104-10></a>NAME<span class=w>                            </span>NAMESPACE<span class=w>       </span>REVISION<span class=w>        </span>UPDATED<span class=w>                                 </span>STATUS<span class=w>          </span>CHART<span class=w>                                   </span>APP<span class=w> </span>VERSION
<a id=__codelineno-104-11 name=__codelineno-104-11 href=#__codelineno-104-11></a>nfs-subdir-external-provisioner<span class=w> </span>nfs-sc<span class=w>          </span><span class=m>1</span><span class=w>               </span><span class=m>2022</span>-10-18<span class=w> </span><span class=m>14</span>:41:18.070839496<span class=w> </span>+0800<span class=w> </span>CST<span class=w> </span>deployed<span class=w>        </span>nfs-subdir-external-provisioner-4.0.17<span class=w>  </span><span class=m>4</span>.0.2
</code></pre></div> <p>如上显示，表示StorageClass启动正常。</p> <h6 id=33-部署jenkins>3.3 部署jenkins<a class=headerlink href=#33-部署jenkins title="Permanent link">&para;</a></h6> <blockquote> <p>前提条件：NFS 类型的 StorageClass 来做持久化存储, StorageClass 名称<code>gitee-nfs-client</code></p> </blockquote> <p>原始仓库</p> <div class=highlight><pre><span></span><code><a id=__codelineno-105-1 name=__codelineno-105-1 href=#__codelineno-105-1></a>$<span class=w> </span>helm<span class=w> </span>repo<span class=w> </span>add<span class=w> </span>jenkins<span class=w> </span>https://charts.jenkins.io
<a id=__codelineno-105-2 name=__codelineno-105-2 href=#__codelineno-105-2></a>$<span class=w> </span>helm<span class=w> </span>repo<span class=w> </span>update
</code></pre></div> <p>Chart 仓库地址：<a href=https://hujianli94.github.io/mycharts/jenkinsci>https://hujianli94.github.io/mycharts/jenkinsci</a></p> <p>设置helm源</p> <div class=highlight><pre><span></span><code><a id=__codelineno-106-1 name=__codelineno-106-1 href=#__codelineno-106-1></a>$<span class=w> </span>helm<span class=w> </span>repo<span class=w> </span>add<span class=w> </span>mycharts<span class=w> </span>https://hujianli94.github.io/mycharts/
<a id=__codelineno-106-2 name=__codelineno-106-2 href=#__codelineno-106-2></a>$<span class=w> </span>helm<span class=w> </span>repo<span class=w> </span>update
<a id=__codelineno-106-3 name=__codelineno-106-3 href=#__codelineno-106-3></a>$<span class=w> </span>helm<span class=w> </span>search<span class=w> </span>repo<span class=w> </span>jenkinsci
<a id=__codelineno-106-4 name=__codelineno-106-4 href=#__codelineno-106-4></a>NAME<span class=w>                    </span>CHART<span class=w> </span>VERSION<span class=w>   </span>APP<span class=w> </span>VERSION<span class=w>     </span>DESCRIPTION
<a id=__codelineno-106-5 name=__codelineno-106-5 href=#__codelineno-106-5></a>mycharts/jenkinsci<span class=w>      </span><span class=m>0</span>.1.0<span class=w>           </span><span class=m>2</span>.390-jdk11<span class=w>     </span>A<span class=w> </span>Helm<span class=w> </span>chart<span class=w> </span><span class=k>for</span><span class=w> </span>Kubernetes
<a id=__codelineno-106-6 name=__codelineno-106-6 href=#__codelineno-106-6></a>
<a id=__codelineno-106-7 name=__codelineno-106-7 href=#__codelineno-106-7></a>$<span class=w> </span>helm<span class=w> </span>pull<span class=w> </span>mycharts/jenkinsci<span class=w> </span>--version<span class=o>=</span><span class=m>0</span>.1.0
<a id=__codelineno-106-8 name=__codelineno-106-8 href=#__codelineno-106-8></a>$<span class=w> </span>helm<span class=w> </span>pull<span class=w> </span>mycharts/jenkinsci<span class=w> </span>--version<span class=o>=</span><span class=m>0</span>.1.0<span class=w> </span>--untar
<a id=__codelineno-106-9 name=__codelineno-106-9 href=#__codelineno-106-9></a>
<a id=__codelineno-106-10 name=__codelineno-106-10 href=#__codelineno-106-10></a><span class=c1># 修改jenkinsci/values.yaml配置</span>
<a id=__codelineno-106-11 name=__codelineno-106-11 href=#__codelineno-106-11></a><span class=c1>## 修改storageClassName</span>
<a id=__codelineno-106-12 name=__codelineno-106-12 href=#__codelineno-106-12></a><span class=c1>## 修改nfs信息</span>
<a id=__codelineno-106-13 name=__codelineno-106-13 href=#__codelineno-106-13></a><span class=c1>## 根据要求进行修改</span>
</code></pre></div> <p>使用helm进行部署</p> <div class=highlight><pre><span></span><code><a id=__codelineno-107-1 name=__codelineno-107-1 href=#__codelineno-107-1></a>$<span class=w> </span>helm<span class=w> </span>upgrade<span class=w> </span>jenkinsci<span class=w> </span>jenkinsci<span class=w> </span>--install<span class=w> </span>--namespace<span class=w> </span>kube-ops<span class=w> </span>--create-namespace
<a id=__codelineno-107-2 name=__codelineno-107-2 href=#__codelineno-107-2></a>Release<span class=w> </span><span class=s2>&quot;jenkinsci&quot;</span><span class=w> </span>does<span class=w> </span>not<span class=w> </span>exist.<span class=w> </span>Installing<span class=w> </span>it<span class=w> </span>now.
<a id=__codelineno-107-3 name=__codelineno-107-3 href=#__codelineno-107-3></a>NAME:<span class=w> </span>jenkinsci
<a id=__codelineno-107-4 name=__codelineno-107-4 href=#__codelineno-107-4></a>LAST<span class=w> </span>DEPLOYED:<span class=w> </span>Wed<span class=w> </span>Feb<span class=w> </span><span class=m>15</span><span class=w> </span><span class=m>10</span>:04:21<span class=w> </span><span class=m>2023</span>
<a id=__codelineno-107-5 name=__codelineno-107-5 href=#__codelineno-107-5></a>NAMESPACE:<span class=w> </span>kube-ops
<a id=__codelineno-107-6 name=__codelineno-107-6 href=#__codelineno-107-6></a>STATUS:<span class=w> </span>deployed
<a id=__codelineno-107-7 name=__codelineno-107-7 href=#__codelineno-107-7></a>REVISION:<span class=w> </span><span class=m>1</span>
<a id=__codelineno-107-8 name=__codelineno-107-8 href=#__codelineno-107-8></a>NOTES:
<a id=__codelineno-107-9 name=__codelineno-107-9 href=#__codelineno-107-9></a><span class=m>1</span>.<span class=w> </span>Get<span class=w> </span>the<span class=w> </span>application<span class=w> </span>URL<span class=w> </span>by<span class=w> </span>running<span class=w> </span>these<span class=w> </span>commands:
<a id=__codelineno-107-10 name=__codelineno-107-10 href=#__codelineno-107-10></a><span class=w>  </span><span class=nb>export</span><span class=w> </span><span class=nv>NODE_PORT</span><span class=o>=</span><span class=k>$(</span>kubectl<span class=w> </span>get<span class=w> </span>--namespace<span class=w> </span>kube-ops<span class=w> </span>-o<span class=w> </span><span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&quot;{.spec.ports[0].nodePort}&quot;</span><span class=w> </span>services<span class=w> </span>jenkinsci<span class=k>)</span>
<a id=__codelineno-107-11 name=__codelineno-107-11 href=#__codelineno-107-11></a><span class=w>  </span><span class=nb>export</span><span class=w> </span><span class=nv>NODE_IP</span><span class=o>=</span><span class=k>$(</span>kubectl<span class=w> </span>get<span class=w> </span>nodes<span class=w> </span>--namespace<span class=w> </span>kube-ops<span class=w> </span>-o<span class=w> </span><span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&quot;{.items[0].status.addresses[0].address}&quot;</span><span class=k>)</span>
<a id=__codelineno-107-12 name=__codelineno-107-12 href=#__codelineno-107-12></a><span class=w>  </span><span class=nb>echo</span><span class=w> </span>http://<span class=nv>$NODE_IP</span>:<span class=nv>$NODE_PORT</span>
</code></pre></div> <p>查看部署pod的状态和日志</p> <div class=highlight><pre><span></span><code><a id=__codelineno-108-1 name=__codelineno-108-1 href=#__codelineno-108-1></a><span class=c1># kubectl get pod,svc,pvc -n kube-ops</span>
<a id=__codelineno-108-2 name=__codelineno-108-2 href=#__codelineno-108-2></a>NAME<span class=w>                             </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>   </span>AGE
<a id=__codelineno-108-3 name=__codelineno-108-3 href=#__codelineno-108-3></a>pod/jenkinsci-6465964b6d-rplhl<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>2m43s
<a id=__codelineno-108-4 name=__codelineno-108-4 href=#__codelineno-108-4></a>
<a id=__codelineno-108-5 name=__codelineno-108-5 href=#__codelineno-108-5></a>NAME<span class=w>                </span>TYPE<span class=w>       </span>CLUSTER-IP<span class=w>        </span>EXTERNAL-IP<span class=w>   </span>PORT<span class=o>(</span>S<span class=o>)</span><span class=w>                          </span>AGE
<a id=__codelineno-108-6 name=__codelineno-108-6 href=#__codelineno-108-6></a>service/jenkinsci<span class=w>   </span>NodePort<span class=w>   </span><span class=m>192</span>.168.105.182<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>8080</span>:32080/TCP,50000:32050/TCP<span class=w>   </span>2m43s
<a id=__codelineno-108-7 name=__codelineno-108-7 href=#__codelineno-108-7></a>
<a id=__codelineno-108-8 name=__codelineno-108-8 href=#__codelineno-108-8></a>NAME<span class=w>                              </span>STATUS<span class=w>   </span>VOLUME<span class=w>      </span>CAPACITY<span class=w>   </span>ACCESS<span class=w> </span>MODES<span class=w>   </span>STORAGECLASS<span class=w>       </span>AGE
<a id=__codelineno-108-9 name=__codelineno-108-9 href=#__codelineno-108-9></a>persistentvolumeclaim/jenkinsci<span class=w>   </span>Bound<span class=w>    </span>jenkinsci<span class=w>   </span>100Gi<span class=w>      </span>RWO<span class=w>            </span>gitee-nfs-client<span class=w>   </span>2m43s
<a id=__codelineno-108-10 name=__codelineno-108-10 href=#__codelineno-108-10></a>
<a id=__codelineno-108-11 name=__codelineno-108-11 href=#__codelineno-108-11></a>
<a id=__codelineno-108-12 name=__codelineno-108-12 href=#__codelineno-108-12></a><span class=c1># kubectl exec -it pod/jenkinsci-6465964b6d-rplhl  -n kube-ops -- cat /var/jenkins_home/secrets/initialAdminPassword</span>
<a id=__codelineno-108-13 name=__codelineno-108-13 href=#__codelineno-108-13></a>917475173c3746959bcd50d608fb28d7
<a id=__codelineno-108-14 name=__codelineno-108-14 href=#__codelineno-108-14></a>
<a id=__codelineno-108-15 name=__codelineno-108-15 href=#__codelineno-108-15></a><span class=c1># kubectl logs -f pod/jenkinsci-6465964b6d-rplhl -n kube-ops</span>
<a id=__codelineno-108-16 name=__codelineno-108-16 href=#__codelineno-108-16></a>.....
<a id=__codelineno-108-17 name=__codelineno-108-17 href=#__codelineno-108-17></a>Jenkins<span class=w> </span>initial<span class=w> </span>setup<span class=w> </span>is<span class=w> </span>required.<span class=w> </span>An<span class=w> </span>admin<span class=w> </span>user<span class=w> </span>has<span class=w> </span>been<span class=w> </span>created<span class=w> </span>and<span class=w> </span>a<span class=w> </span>password<span class=w> </span>generated.
<a id=__codelineno-108-18 name=__codelineno-108-18 href=#__codelineno-108-18></a>Please<span class=w> </span>use<span class=w> </span>the<span class=w> </span>following<span class=w> </span>password<span class=w> </span>to<span class=w> </span>proceed<span class=w> </span>to<span class=w> </span>installation:
<a id=__codelineno-108-19 name=__codelineno-108-19 href=#__codelineno-108-19></a>
<a id=__codelineno-108-20 name=__codelineno-108-20 href=#__codelineno-108-20></a>917475173c3746959bcd50d608fb28d7
<a id=__codelineno-108-21 name=__codelineno-108-21 href=#__codelineno-108-21></a>
<a id=__codelineno-108-22 name=__codelineno-108-22 href=#__codelineno-108-22></a>This<span class=w> </span>may<span class=w> </span>also<span class=w> </span>be<span class=w> </span>found<span class=w> </span>at:<span class=w> </span>/var/jenkins_home/secrets/initialAdminPassword
<a id=__codelineno-108-23 name=__codelineno-108-23 href=#__codelineno-108-23></a>
<a id=__codelineno-108-24 name=__codelineno-108-24 href=#__codelineno-108-24></a>*************************************************************
<a id=__codelineno-108-25 name=__codelineno-108-25 href=#__codelineno-108-25></a>*************************************************************
<a id=__codelineno-108-26 name=__codelineno-108-26 href=#__codelineno-108-26></a>*************************************************************
</code></pre></div> <p>使用Node+NodePort端口进行访问，使用初始密码登录。</p> <p>安装插件配置然后基本环境其他操作与docker部署一致。</p> <blockquote> <p>参考文献：</p> <p><a href=https://www.yuque.com/wuyuexin/bu3d95/eikxqa>https://www.yuque.com/wuyuexin/bu3d95/eikxqa</a></p> </blockquote> <h4 id=4-yaml方式部署不推荐>4. yaml方式部署(不推荐)<a class=headerlink href=#4-yaml方式部署不推荐 title="Permanent link">&para;</a></h4> <p>既然要基于 Kubernetes 来做 CI/CD，我们这里最好还是将 Jenkins 安装到 Kubernetes 集群当中，安装的方式也很多，我们这里仍然还是使用手动的方式，这样可以了解更多细节，对应的资源清单文件如下所示：</p> <p><code>jenkins-pv.yaml</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-109-1 name=__codelineno-109-1 href=#__codelineno-109-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-109-2 name=__codelineno-109-2 href=#__codelineno-109-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
<a id=__codelineno-109-3 name=__codelineno-109-3 href=#__codelineno-109-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-109-4 name=__codelineno-109-4 href=#__codelineno-109-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkinsci</span>
<a id=__codelineno-109-5 name=__codelineno-109-5 href=#__codelineno-109-5></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-109-6 name=__codelineno-109-6 href=#__codelineno-109-6></a><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkinsci</span>
<a id=__codelineno-109-7 name=__codelineno-109-7 href=#__codelineno-109-7></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-109-8 name=__codelineno-109-8 href=#__codelineno-109-8></a><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span>
<a id=__codelineno-109-9 name=__codelineno-109-9 href=#__codelineno-109-9></a><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">100Gi</span>
<a id=__codelineno-109-10 name=__codelineno-109-10 href=#__codelineno-109-10></a><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span>
<a id=__codelineno-109-11 name=__codelineno-109-11 href=#__codelineno-109-11></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
<a id=__codelineno-109-12 name=__codelineno-109-12 href=#__codelineno-109-12></a><span class=w>  </span><span class=nt>persistentVolumeReclaimPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span>
<a id=__codelineno-109-13 name=__codelineno-109-13 href=#__codelineno-109-13></a><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gitee-nfs-client</span>
<a id=__codelineno-109-14 name=__codelineno-109-14 href=#__codelineno-109-14></a><span class=w>  </span><span class=nt>mountOptions</span><span class=p>:</span>
<a id=__codelineno-109-15 name=__codelineno-109-15 href=#__codelineno-109-15></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">hard</span>
<a id=__codelineno-109-16 name=__codelineno-109-16 href=#__codelineno-109-16></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nfsvers=4.1</span>
<a id=__codelineno-109-17 name=__codelineno-109-17 href=#__codelineno-109-17></a><span class=w>  </span><span class=nt>nfs</span><span class=p>:</span>
<a id=__codelineno-109-18 name=__codelineno-109-18 href=#__codelineno-109-18></a><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.60</span>
<a id=__codelineno-109-19 name=__codelineno-109-19 href=#__codelineno-109-19></a><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/QaTest/jenkins</span>
<a id=__codelineno-109-20 name=__codelineno-109-20 href=#__codelineno-109-20></a><span class=nn>---</span>
<a id=__codelineno-109-21 name=__codelineno-109-21 href=#__codelineno-109-21></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<a id=__codelineno-109-22 name=__codelineno-109-22 href=#__codelineno-109-22></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-109-23 name=__codelineno-109-23 href=#__codelineno-109-23></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-109-24 name=__codelineno-109-24 href=#__codelineno-109-24></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins-pvc</span>
<a id=__codelineno-109-25 name=__codelineno-109-25 href=#__codelineno-109-25></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<a id=__codelineno-109-26 name=__codelineno-109-26 href=#__codelineno-109-26></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-109-27 name=__codelineno-109-27 href=#__codelineno-109-27></a><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span>
<a id=__codelineno-109-28 name=__codelineno-109-28 href=#__codelineno-109-28></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
<a id=__codelineno-109-29 name=__codelineno-109-29 href=#__codelineno-109-29></a><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gitee-nfs-client</span>
<a id=__codelineno-109-30 name=__codelineno-109-30 href=#__codelineno-109-30></a><span class=w>  </span><span class=nt>resources</span><span class=p>:</span>
<a id=__codelineno-109-31 name=__codelineno-109-31 href=#__codelineno-109-31></a><span class=w>    </span><span class=nt>requests</span><span class=p>:</span>
<a id=__codelineno-109-32 name=__codelineno-109-32 href=#__codelineno-109-32></a><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">100Gi</span>
<a id=__codelineno-109-33 name=__codelineno-109-33 href=#__codelineno-109-33></a><span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
<a id=__codelineno-109-34 name=__codelineno-109-34 href=#__codelineno-109-34></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-109-35 name=__codelineno-109-35 href=#__codelineno-109-35></a><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkinsci</span>
</code></pre></div> <p>在storageClassName的指定目录下持久化数据，设置指定名称的静态PV和PVC。</p> <p><code>jenkins.yaml</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-110-1 name=__codelineno-110-1 href=#__codelineno-110-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-110-2 name=__codelineno-110-2 href=#__codelineno-110-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<a id=__codelineno-110-3 name=__codelineno-110-3 href=#__codelineno-110-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-110-4 name=__codelineno-110-4 href=#__codelineno-110-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<a id=__codelineno-110-5 name=__codelineno-110-5 href=#__codelineno-110-5></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<a id=__codelineno-110-6 name=__codelineno-110-6 href=#__codelineno-110-6></a><span class=nn>---</span>
<a id=__codelineno-110-7 name=__codelineno-110-7 href=#__codelineno-110-7></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<a id=__codelineno-110-8 name=__codelineno-110-8 href=#__codelineno-110-8></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<a id=__codelineno-110-9 name=__codelineno-110-9 href=#__codelineno-110-9></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-110-10 name=__codelineno-110-10 href=#__codelineno-110-10></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<a id=__codelineno-110-11 name=__codelineno-110-11 href=#__codelineno-110-11></a><span class=nt>rules</span><span class=p>:</span>
<a id=__codelineno-110-12 name=__codelineno-110-12 href=#__codelineno-110-12></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;extensions&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;apps&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-13 name=__codelineno-110-13 href=#__codelineno-110-13></a><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;deployments&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;ingresses&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-14 name=__codelineno-110-14 href=#__codelineno-110-14></a><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;delete&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;watch&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;update&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-15 name=__codelineno-110-15 href=#__codelineno-110-15></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-16 name=__codelineno-110-16 href=#__codelineno-110-16></a><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;services&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-17 name=__codelineno-110-17 href=#__codelineno-110-17></a><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;delete&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;watch&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;update&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-18 name=__codelineno-110-18 href=#__codelineno-110-18></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-19 name=__codelineno-110-19 href=#__codelineno-110-19></a><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;pods&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-20 name=__codelineno-110-20 href=#__codelineno-110-20></a><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;delete&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;update&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-21 name=__codelineno-110-21 href=#__codelineno-110-21></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-22 name=__codelineno-110-22 href=#__codelineno-110-22></a><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;pods/exec&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-23 name=__codelineno-110-23 href=#__codelineno-110-23></a><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;delete&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;update&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-24 name=__codelineno-110-24 href=#__codelineno-110-24></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-25 name=__codelineno-110-25 href=#__codelineno-110-25></a><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;pods/log&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;events&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-26 name=__codelineno-110-26 href=#__codelineno-110-26></a><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-27 name=__codelineno-110-27 href=#__codelineno-110-27></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-28 name=__codelineno-110-28 href=#__codelineno-110-28></a><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;secrets&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-29 name=__codelineno-110-29 href=#__codelineno-110-29></a><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-30 name=__codelineno-110-30 href=#__codelineno-110-30></a><span class=nn>---</span>
<a id=__codelineno-110-31 name=__codelineno-110-31 href=#__codelineno-110-31></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<a id=__codelineno-110-32 name=__codelineno-110-32 href=#__codelineno-110-32></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
<a id=__codelineno-110-33 name=__codelineno-110-33 href=#__codelineno-110-33></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-110-34 name=__codelineno-110-34 href=#__codelineno-110-34></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<a id=__codelineno-110-35 name=__codelineno-110-35 href=#__codelineno-110-35></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<a id=__codelineno-110-36 name=__codelineno-110-36 href=#__codelineno-110-36></a><span class=nt>roleRef</span><span class=p>:</span>
<a id=__codelineno-110-37 name=__codelineno-110-37 href=#__codelineno-110-37></a><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<a id=__codelineno-110-38 name=__codelineno-110-38 href=#__codelineno-110-38></a><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<a id=__codelineno-110-39 name=__codelineno-110-39 href=#__codelineno-110-39></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<a id=__codelineno-110-40 name=__codelineno-110-40 href=#__codelineno-110-40></a><span class=nt>subjects</span><span class=p>:</span>
<a id=__codelineno-110-41 name=__codelineno-110-41 href=#__codelineno-110-41></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<a id=__codelineno-110-42 name=__codelineno-110-42 href=#__codelineno-110-42></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<a id=__codelineno-110-43 name=__codelineno-110-43 href=#__codelineno-110-43></a><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<a id=__codelineno-110-44 name=__codelineno-110-44 href=#__codelineno-110-44></a><span class=nn>---</span>
<a id=__codelineno-110-45 name=__codelineno-110-45 href=#__codelineno-110-45></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id=__codelineno-110-46 name=__codelineno-110-46 href=#__codelineno-110-46></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a id=__codelineno-110-47 name=__codelineno-110-47 href=#__codelineno-110-47></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-110-48 name=__codelineno-110-48 href=#__codelineno-110-48></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<a id=__codelineno-110-49 name=__codelineno-110-49 href=#__codelineno-110-49></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<a id=__codelineno-110-50 name=__codelineno-110-50 href=#__codelineno-110-50></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-110-51 name=__codelineno-110-51 href=#__codelineno-110-51></a><span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
<a id=__codelineno-110-52 name=__codelineno-110-52 href=#__codelineno-110-52></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-110-53 name=__codelineno-110-53 href=#__codelineno-110-53></a><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<a id=__codelineno-110-54 name=__codelineno-110-54 href=#__codelineno-110-54></a><span class=w>  </span><span class=nt>template</span><span class=p>:</span>
<a id=__codelineno-110-55 name=__codelineno-110-55 href=#__codelineno-110-55></a><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-110-56 name=__codelineno-110-56 href=#__codelineno-110-56></a><span class=w>      </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-110-57 name=__codelineno-110-57 href=#__codelineno-110-57></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<a id=__codelineno-110-58 name=__codelineno-110-58 href=#__codelineno-110-58></a><span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-110-59 name=__codelineno-110-59 href=#__codelineno-110-59></a><span class=w>      </span><span class=nt>serviceAccount</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<a id=__codelineno-110-60 name=__codelineno-110-60 href=#__codelineno-110-60></a><span class=w>      </span><span class=nt>initContainers</span><span class=p>:</span>
<a id=__codelineno-110-61 name=__codelineno-110-61 href=#__codelineno-110-61></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fix-permissions</span>
<a id=__codelineno-110-62 name=__codelineno-110-62 href=#__codelineno-110-62></a><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">busybox:1.35.0</span>
<a id=__codelineno-110-63 name=__codelineno-110-63 href=#__codelineno-110-63></a><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;sh&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;chown</span><span class=nv> </span><span class=s>-R</span><span class=nv> </span><span class=s>1000:1000</span><span class=nv> </span><span class=s>/var/jenkins_home&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-110-64 name=__codelineno-110-64 href=#__codelineno-110-64></a><span class=w>          </span><span class=nt>securityContext</span><span class=p>:</span>
<a id=__codelineno-110-65 name=__codelineno-110-65 href=#__codelineno-110-65></a><span class=w>            </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-110-66 name=__codelineno-110-66 href=#__codelineno-110-66></a><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-110-67 name=__codelineno-110-67 href=#__codelineno-110-67></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkinshome</span>
<a id=__codelineno-110-68 name=__codelineno-110-68 href=#__codelineno-110-68></a><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/jenkins_home</span>
<a id=__codelineno-110-69 name=__codelineno-110-69 href=#__codelineno-110-69></a><span class=w>      </span><span class=nt>containers</span><span class=p>:</span>
<a id=__codelineno-110-70 name=__codelineno-110-70 href=#__codelineno-110-70></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<a id=__codelineno-110-71 name=__codelineno-110-71 href=#__codelineno-110-71></a><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins/jenkins:2.390-jdk11</span>
<a id=__codelineno-110-72 name=__codelineno-110-72 href=#__codelineno-110-72></a><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
<a id=__codelineno-110-73 name=__codelineno-110-73 href=#__codelineno-110-73></a><span class=w>          </span><span class=nt>env</span><span class=p>:</span>
<a id=__codelineno-110-74 name=__codelineno-110-74 href=#__codelineno-110-74></a><span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">JAVA_OPTS</span>
<a id=__codelineno-110-75 name=__codelineno-110-75 href=#__codelineno-110-75></a><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">-Dhudson.model.DownloadService.noSignatureCheck=true</span>
<a id=__codelineno-110-76 name=__codelineno-110-76 href=#__codelineno-110-76></a><span class=w>          </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-110-77 name=__codelineno-110-77 href=#__codelineno-110-77></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<a id=__codelineno-110-78 name=__codelineno-110-78 href=#__codelineno-110-78></a><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<a id=__codelineno-110-79 name=__codelineno-110-79 href=#__codelineno-110-79></a><span class=w>              </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<a id=__codelineno-110-80 name=__codelineno-110-80 href=#__codelineno-110-80></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">50000</span>
<a id=__codelineno-110-81 name=__codelineno-110-81 href=#__codelineno-110-81></a><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">agent</span>
<a id=__codelineno-110-82 name=__codelineno-110-82 href=#__codelineno-110-82></a><span class=w>              </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<a id=__codelineno-110-83 name=__codelineno-110-83 href=#__codelineno-110-83></a><span class=w>          </span><span class=nt>resources</span><span class=p>:</span>
<a id=__codelineno-110-84 name=__codelineno-110-84 href=#__codelineno-110-84></a><span class=w>            </span><span class=nt>limits</span><span class=p>:</span>
<a id=__codelineno-110-85 name=__codelineno-110-85 href=#__codelineno-110-85></a><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1500m</span>
<a id=__codelineno-110-86 name=__codelineno-110-86 href=#__codelineno-110-86></a><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2048Mi</span>
<a id=__codelineno-110-87 name=__codelineno-110-87 href=#__codelineno-110-87></a><span class=w>            </span><span class=nt>requests</span><span class=p>:</span>
<a id=__codelineno-110-88 name=__codelineno-110-88 href=#__codelineno-110-88></a><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1500m</span>
<a id=__codelineno-110-89 name=__codelineno-110-89 href=#__codelineno-110-89></a><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2048Mi</span>
<a id=__codelineno-110-90 name=__codelineno-110-90 href=#__codelineno-110-90></a><span class=w>          </span><span class=nt>readinessProbe</span><span class=p>:</span>
<a id=__codelineno-110-91 name=__codelineno-110-91 href=#__codelineno-110-91></a><span class=w>            </span><span class=nt>httpGet</span><span class=p>:</span>
<a id=__codelineno-110-92 name=__codelineno-110-92 href=#__codelineno-110-92></a><span class=w>              </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/login</span>
<a id=__codelineno-110-93 name=__codelineno-110-93 href=#__codelineno-110-93></a><span class=w>              </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<a id=__codelineno-110-94 name=__codelineno-110-94 href=#__codelineno-110-94></a><span class=w>            </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<a id=__codelineno-110-95 name=__codelineno-110-95 href=#__codelineno-110-95></a><span class=w>            </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<a id=__codelineno-110-96 name=__codelineno-110-96 href=#__codelineno-110-96></a><span class=w>            </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">12</span>
<a id=__codelineno-110-97 name=__codelineno-110-97 href=#__codelineno-110-97></a><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-110-98 name=__codelineno-110-98 href=#__codelineno-110-98></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkinshome</span>
<a id=__codelineno-110-99 name=__codelineno-110-99 href=#__codelineno-110-99></a><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/jenkins_home</span>
<a id=__codelineno-110-100 name=__codelineno-110-100 href=#__codelineno-110-100></a><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span>
<a id=__codelineno-110-101 name=__codelineno-110-101 href=#__codelineno-110-101></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkinshome</span>
<a id=__codelineno-110-102 name=__codelineno-110-102 href=#__codelineno-110-102></a><span class=w>          </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span>
<a id=__codelineno-110-103 name=__codelineno-110-103 href=#__codelineno-110-103></a><span class=w>            </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins-pvc</span>
<a id=__codelineno-110-104 name=__codelineno-110-104 href=#__codelineno-110-104></a><span class=nn>---</span>
<a id=__codelineno-110-105 name=__codelineno-110-105 href=#__codelineno-110-105></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-110-106 name=__codelineno-110-106 href=#__codelineno-110-106></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<a id=__codelineno-110-107 name=__codelineno-110-107 href=#__codelineno-110-107></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-110-108 name=__codelineno-110-108 href=#__codelineno-110-108></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<a id=__codelineno-110-109 name=__codelineno-110-109 href=#__codelineno-110-109></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<a id=__codelineno-110-110 name=__codelineno-110-110 href=#__codelineno-110-110></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-110-111 name=__codelineno-110-111 href=#__codelineno-110-111></a><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<a id=__codelineno-110-112 name=__codelineno-110-112 href=#__codelineno-110-112></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-110-113 name=__codelineno-110-113 href=#__codelineno-110-113></a><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
<a id=__codelineno-110-114 name=__codelineno-110-114 href=#__codelineno-110-114></a><span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
<a id=__codelineno-110-115 name=__codelineno-110-115 href=#__codelineno-110-115></a><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<a id=__codelineno-110-116 name=__codelineno-110-116 href=#__codelineno-110-116></a><span class=w>  </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-110-117 name=__codelineno-110-117 href=#__codelineno-110-117></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<a id=__codelineno-110-118 name=__codelineno-110-118 href=#__codelineno-110-118></a><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<a id=__codelineno-110-119 name=__codelineno-110-119 href=#__codelineno-110-119></a><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<a id=__codelineno-110-120 name=__codelineno-110-120 href=#__codelineno-110-120></a><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">32080</span>
<a id=__codelineno-110-121 name=__codelineno-110-121 href=#__codelineno-110-121></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">agent</span>
<a id=__codelineno-110-122 name=__codelineno-110-122 href=#__codelineno-110-122></a><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">50000</span>
<a id=__codelineno-110-123 name=__codelineno-110-123 href=#__codelineno-110-123></a><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">agent</span>
<a id=__codelineno-110-124 name=__codelineno-110-124 href=#__codelineno-110-124></a><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">32050</span>
</code></pre></div> <p>由于我们这里使用的镜像内部运行的用户 <code>uid=1000</code>，所以我们这里挂载出来后会出现权限问题，为解决这个问题，我们同样还是用一个简单的 <code>initContainer</code> 来修改下我们挂载的数据目录。</p> <p>我们直接来创建 jenkins 的资源清单即可：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-111-1 name=__codelineno-111-1 href=#__codelineno-111-1></a>$<span class=w> </span>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>jenkins-pv.yaml
<a id=__codelineno-111-2 name=__codelineno-111-2 href=#__codelineno-111-2></a>$<span class=w> </span>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>jenkins.yaml
<a id=__codelineno-111-3 name=__codelineno-111-3 href=#__codelineno-111-3></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>all<span class=w> </span>-n<span class=w> </span>kube-ops
<a id=__codelineno-111-4 name=__codelineno-111-4 href=#__codelineno-111-4></a>NAME<span class=w>                          </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>   </span>AGE
<a id=__codelineno-111-5 name=__codelineno-111-5 href=#__codelineno-111-5></a>pod/jenkins-95db8c7dc-d9hrq<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>7m52s
<a id=__codelineno-111-6 name=__codelineno-111-6 href=#__codelineno-111-6></a>
<a id=__codelineno-111-7 name=__codelineno-111-7 href=#__codelineno-111-7></a>NAME<span class=w>              </span>TYPE<span class=w>       </span>CLUSTER-IP<span class=w>      </span>EXTERNAL-IP<span class=w>   </span>PORT<span class=o>(</span>S<span class=o>)</span><span class=w>                          </span>AGE
<a id=__codelineno-111-8 name=__codelineno-111-8 href=#__codelineno-111-8></a>service/jenkins<span class=w>   </span>NodePort<span class=w>   </span><span class=m>192</span>.168.59.29<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>8080</span>:32080/TCP,50000:32050/TCP<span class=w>   </span>7m52s
<a id=__codelineno-111-9 name=__codelineno-111-9 href=#__codelineno-111-9></a>
<a id=__codelineno-111-10 name=__codelineno-111-10 href=#__codelineno-111-10></a>NAME<span class=w>                      </span>READY<span class=w>   </span>UP-TO-DATE<span class=w>   </span>AVAILABLE<span class=w>   </span>AGE
<a id=__codelineno-111-11 name=__codelineno-111-11 href=#__codelineno-111-11></a>deployment.apps/jenkins<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span><span class=m>1</span><span class=w>            </span><span class=m>1</span><span class=w>           </span>7m52s
<a id=__codelineno-111-12 name=__codelineno-111-12 href=#__codelineno-111-12></a>
<a id=__codelineno-111-13 name=__codelineno-111-13 href=#__codelineno-111-13></a>NAME<span class=w>                                </span>DESIRED<span class=w>   </span>CURRENT<span class=w>   </span>READY<span class=w>   </span>AGE
<a id=__codelineno-111-14 name=__codelineno-111-14 href=#__codelineno-111-14></a>replicaset.apps/jenkins-95db8c7dc<span class=w>   </span><span class=m>1</span><span class=w>         </span><span class=m>1</span><span class=w>         </span><span class=m>1</span><span class=w>       </span>7m52s
</code></pre></div> <p>然后可以执行下面的命令获取解锁的管理员密码：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-112-1 name=__codelineno-112-1 href=#__codelineno-112-1></a>$<span class=w> </span>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span>pod/jenkins-95db8c7dc-d9hrq<span class=w>  </span>-n<span class=w> </span>kube-ops<span class=w> </span>--<span class=w> </span>cat<span class=w> </span>/var/jenkins_home/secrets/initialAdminPassword
<a id=__codelineno-112-2 name=__codelineno-112-2 href=#__codelineno-112-2></a>Defaulted<span class=w> </span>container<span class=w> </span><span class=s2>&quot;jenkins&quot;</span><span class=w> </span>out<span class=w> </span>of:<span class=w> </span>jenkins,<span class=w> </span>fix-permissions<span class=w> </span><span class=o>(</span>init<span class=o>)</span>
<a id=__codelineno-112-3 name=__codelineno-112-3 href=#__codelineno-112-3></a>b9a201f71e67434f828c0fe59a94e460<span class=w>  </span><span class=c1># jenkins启动日志里面也有</span>
</code></pre></div> <p>使用Node+NodePort端口进行访问，使用初始密码登录。</p> <p>安装插件配置然后基本环境其他操作与docker部署一致。</p> <h4 id=5-架构>5. 架构<a class=headerlink href=#5-架构 title="Permanent link">&para;</a></h4> <p>Jenkins 安装完成了，接下来我们不用急着就去使用，我们要了解下在 Kubernetes 环境下面使用 Jenkins 有什么好处。</p> <p>我们知道持续构建与发布是我们日常工作中必不可少的一个步骤，目前大多公司都采用 Jenkins 集群来搭建符合需求的 CI/CD 流程，然而传统的 Jenkins Slave 一主多从方式会存在一些痛点，比如：</p> <ul> <li>主 Master 发生单点故障时，整个流程都不可用了</li> <li>每个 Slave 的配置环境不一样，来完成不同语言的编译打包等操作，但是这些差异化的配置导致管理起来非常不方便，维护起来也是比较费劲</li> <li>资源分配不均衡，有的 Slave 要运行的 job 出现排队等待，而有的 Slave 处于空闲状态</li> <li>资源有浪费，每台 Slave 可能是物理机或者虚拟机，当 Slave 处于空闲状态时，也不会完全释放掉资源。</li> </ul> <p>正因为上面的这些种种痛点，我们渴望一种更高效更可靠的方式来完成这个 CI/CD 流程，而 Docker 虚拟化容器技术能很好的解决这个痛点，又特别是在 Kubernetes 集群环境下面能够更好来解决上面的问题，下图是基于 Kubernetes 搭建 Jenkins 集群的简单示意图：</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-10.png></p> <p>从图上可以看到 <code>Jenkins Master</code> 和 <code>Jenkins Slave</code> 以 Pod 形式运行在 Kubernetes 集群的 Node 上，Master 运行在其中一个节点，并且将其配置数据存储到一个 Volume 上去，Slave 运行在各个节点上，并且它不是一直处于运行状态，它会按照需求动态的创建并自动删除。</p> <p>这种方式的工作流程大致为：当 Jenkins Master 接受到 Build 请求时，会根据配置的 Label 动态创建一个运行在 Pod 中的 Jenkins Slave 并注册到 Master 上，当运行完 Job 后，这个 Slave 会被注销并且这个 Pod 也会自动删除，恢复到最初状态。</p> <p>那么我们使用这种方式带来了哪些好处呢？</p> <ul> <li><strong>服务高可用</strong>，当 Jenkins Master 出现故障时，Kubernetes 会自动创建一个新的 Jenkins Master 容器，并且将 Volume 分配给新创建的容器，保证数据不丢失，从而达到集群服务高可用。</li> <li><strong>动态伸缩</strong>，合理使用资源，每次运行 Job 时，会自动创建一个 Jenkins Slave，Job 完成后，Slave 自动注销并删除容器，资源自动释放，而且 Kubernetes 会根据每个资源的使用情况，动态分配 Slave 到空闲的节点上创建，降低出现因某节点资源利用率高，还排队等待在该节点的情况。</li> <li><strong>扩展性好</strong>，当 Kubernetes 集群的资源严重不足而导致 Job 排队等待时，可以很容易的添加一个 Kubernetes Node 到集群中，从而实现扩展。 是不是以前我们面临的种种问题在 Kubernetes 集群环境下面是不是都没有了啊？看上去非常完美。</li> </ul> <h5 id=1-配置>1. 配置<a class=headerlink href=#1-配置 title="Permanent link">&para;</a></h5> <p>接下来我们就需要来配置 Jenkins，让他能够动态的生成 Slave 的 Pod。</p> <p>第 1 步. 我们需要安装 <a href=https://github.com/jenkinsci/kubernetes-plugin>kubernetes 插件</a>， 点击 Manage Jenkins -&gt; Manage Plugins -&gt; Available -&gt; Kubernetes 勾选安装即可。</p> <p>第 2 步. 安装完毕后，进入configureClouds页面：</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-11.png></p> <p>在该页面我们可以点击 <code>Add a new cloud</code> -&gt; 选择 <code>Kubernetes</code>，首先点击 <code>Kubernetes Cloud details...</code> 按钮进行配置。</p> <p>首先配置连接 Kubernetes APIServer 的地址，由于我们的 Jenkins 运行在 Kubernetes 集群中，所以可以使用 Service 的 DNS 形式进行连接 <code>https://kubernetes.default.svc.cluster.local</code>：</p> <p>注意 namespace，我们这里填 kube-ops，凭据输入KUBECONFIG文件对应的凭证，然后点击 <code>Test Connection</code>，如果出现 <code>Connected to Kubernetes...</code> 的提示信息证明 Jenkins 已经可以和 Kubernetes 系统正常通信了。</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-12.png></p> <p>然后下方的 Jenkins URL 地址：<code>http://jenkinsci.kube-ops.svc.cluster.local:8080</code>，这里的格式为：<code>服务名.namespace.svc.cluster.local:8080</code>，根据上面创建的 jenkins 的服务名填写，包括下面的Jenkins通道，默认是50000端口（要注意是 TCP，所以不要填写 http）。</p> <p>配置jenkins-slave镜像。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-113-1 name=__codelineno-113-1 href=#__codelineno-113-1></a><span class=o>[</span>root@k8s-master01<span class=w> </span>jenkins-slave<span class=o>]</span><span class=c1># tree -a</span>
<a id=__codelineno-113-2 name=__codelineno-113-2 href=#__codelineno-113-2></a>.
<a id=__codelineno-113-3 name=__codelineno-113-3 href=#__codelineno-113-3></a>├──<span class=w> </span>bin
<a id=__codelineno-113-4 name=__codelineno-113-4 href=#__codelineno-113-4></a><span class=w>    </span>├──<span class=w> </span>docker
<a id=__codelineno-113-5 name=__codelineno-113-5 href=#__codelineno-113-5></a><span class=w>    </span>├──<span class=w> </span>helm
<a id=__codelineno-113-6 name=__codelineno-113-6 href=#__codelineno-113-6></a><span class=w>    </span>└──<span class=w> </span>kubectl
<a id=__codelineno-113-7 name=__codelineno-113-7 href=#__codelineno-113-7></a>├──<span class=w> </span>config
<a id=__codelineno-113-8 name=__codelineno-113-8 href=#__codelineno-113-8></a><span class=w>    </span>└──<span class=w> </span>config
<a id=__codelineno-113-9 name=__codelineno-113-9 href=#__codelineno-113-9></a>├──<span class=w> </span>Dockerfile
<a id=__codelineno-113-10 name=__codelineno-113-10 href=#__codelineno-113-10></a>└──<span class=w> </span>.ssh
<a id=__codelineno-113-11 name=__codelineno-113-11 href=#__codelineno-113-11></a><span class=w>    </span>├──<span class=w> </span>authorized_keys
<a id=__codelineno-113-12 name=__codelineno-113-12 href=#__codelineno-113-12></a><span class=w>    </span>├──<span class=w> </span>id_rsa
<a id=__codelineno-113-13 name=__codelineno-113-13 href=#__codelineno-113-13></a><span class=w>    </span>├──<span class=w> </span>id_rsa.pub
<a id=__codelineno-113-14 name=__codelineno-113-14 href=#__codelineno-113-14></a><span class=w>    </span>└──<span class=w> </span>known_hosts
<a id=__codelineno-113-15 name=__codelineno-113-15 href=#__codelineno-113-15></a><span class=m>3</span><span class=w> </span>directories,<span class=w> </span><span class=m>9</span><span class=w> </span>files
<a id=__codelineno-113-16 name=__codelineno-113-16 href=#__codelineno-113-16></a>
<a id=__codelineno-113-17 name=__codelineno-113-17 href=#__codelineno-113-17></a>
<a id=__codelineno-113-18 name=__codelineno-113-18 href=#__codelineno-113-18></a><span class=c1># cat Dockerfile</span>
<a id=__codelineno-113-19 name=__codelineno-113-19 href=#__codelineno-113-19></a>FROM<span class=w> </span>jenkins/jnlp-slave:4.13.3-1-jdk11
<a id=__codelineno-113-20 name=__codelineno-113-20 href=#__codelineno-113-20></a>MAINTAINER<span class=w> </span>hjl@94qq.com
<a id=__codelineno-113-21 name=__codelineno-113-21 href=#__codelineno-113-21></a>
<a id=__codelineno-113-22 name=__codelineno-113-22 href=#__codelineno-113-22></a>USER<span class=w> </span>root
<a id=__codelineno-113-23 name=__codelineno-113-23 href=#__codelineno-113-23></a>
<a id=__codelineno-113-24 name=__codelineno-113-24 href=#__codelineno-113-24></a>ENV<span class=w> </span><span class=nv>JENKINS_AGENT_WORKDIR</span><span class=o>=</span>/home/jenkins/agent
<a id=__codelineno-113-25 name=__codelineno-113-25 href=#__codelineno-113-25></a>
<a id=__codelineno-113-26 name=__codelineno-113-26 href=#__codelineno-113-26></a>RUN<span class=w> </span><span class=nb>set</span><span class=w> </span>-eux<span class=p>;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-113-27 name=__codelineno-113-27 href=#__codelineno-113-27></a><span class=w>    </span>sed<span class=w> </span>-i<span class=w> </span><span class=s1>&#39;s#http://deb.debian.org#https://mirrors.163.com#g&#39;</span><span class=w> </span>/etc/apt/sources.list<span class=w> </span><span class=se>\</span>
<a id=__codelineno-113-28 name=__codelineno-113-28 href=#__codelineno-113-28></a><span class=w>    </span><span class=o>&amp;&amp;</span><span class=w> </span>apt<span class=w> </span>update<span class=w> </span><span class=se>\</span>
<a id=__codelineno-113-29 name=__codelineno-113-29 href=#__codelineno-113-29></a><span class=w>    </span><span class=o>&amp;&amp;</span><span class=w> </span>apt<span class=w> </span>install<span class=w> </span>-y<span class=w> </span>python<span class=w>  </span><span class=se>\</span>
<a id=__codelineno-113-30 name=__codelineno-113-30 href=#__codelineno-113-30></a><span class=w>        </span>sshpass<span class=w>  </span><span class=se>\</span>
<a id=__codelineno-113-31 name=__codelineno-113-31 href=#__codelineno-113-31></a><span class=w>        </span>rsync<span class=w> </span><span class=se>\</span>
<a id=__codelineno-113-32 name=__codelineno-113-32 href=#__codelineno-113-32></a><span class=w>        </span>make<span class=w>  </span><span class=se>\</span>
<a id=__codelineno-113-33 name=__codelineno-113-33 href=#__codelineno-113-33></a><span class=w>        </span>gcc<span class=w>  </span><span class=se>\</span>
<a id=__codelineno-113-34 name=__codelineno-113-34 href=#__codelineno-113-34></a><span class=w>        </span>curl<span class=w>  </span><span class=se>\</span>
<a id=__codelineno-113-35 name=__codelineno-113-35 href=#__codelineno-113-35></a><span class=w>        </span>net-tools<span class=w>  </span><span class=se>\</span>
<a id=__codelineno-113-36 name=__codelineno-113-36 href=#__codelineno-113-36></a><span class=w>        </span>wget<span class=w>  </span><span class=se>\</span>
<a id=__codelineno-113-37 name=__codelineno-113-37 href=#__codelineno-113-37></a><span class=w>        </span>--no-install-recommends<span class=w> </span><span class=se>\</span>
<a id=__codelineno-113-38 name=__codelineno-113-38 href=#__codelineno-113-38></a><span class=w>    </span><span class=o>&amp;&amp;</span><span class=w> </span>apt-get<span class=w> </span>-y<span class=w> </span>autoremove<span class=w> </span>--purge<span class=w> </span><span class=se>\</span>
<a id=__codelineno-113-39 name=__codelineno-113-39 href=#__codelineno-113-39></a><span class=w>    </span><span class=o>&amp;&amp;</span><span class=w> </span>rm<span class=w> </span>-rf<span class=w> </span>/var/lib/apt/lists/*<span class=w> </span><span class=se>\</span>
<a id=__codelineno-113-40 name=__codelineno-113-40 href=#__codelineno-113-40></a><span class=w>    </span><span class=o>&amp;&amp;</span><span class=w> </span>mkdir<span class=w> </span>-p<span class=w> </span>/home/jenkins/.ssh
<a id=__codelineno-113-41 name=__codelineno-113-41 href=#__codelineno-113-41></a>
<a id=__codelineno-113-42 name=__codelineno-113-42 href=#__codelineno-113-42></a>ENV<span class=w> </span><span class=nv>PATH</span><span class=o>=</span>/opt/java/openjdk/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/jenkins/bin
<a id=__codelineno-113-43 name=__codelineno-113-43 href=#__codelineno-113-43></a>
<a id=__codelineno-113-44 name=__codelineno-113-44 href=#__codelineno-113-44></a>COPY<span class=w> </span>--chown<span class=o>=</span>root:root<span class=w> </span>bin<span class=w> </span>/home/jenkins/bin
<a id=__codelineno-113-45 name=__codelineno-113-45 href=#__codelineno-113-45></a>COPY<span class=w> </span>--chown<span class=o>=</span>root:root<span class=w> </span>.ssh<span class=w> </span>/root/.ssh
<a id=__codelineno-113-46 name=__codelineno-113-46 href=#__codelineno-113-46></a>
<a id=__codelineno-113-47 name=__codelineno-113-47 href=#__codelineno-113-47></a>RUN<span class=w> </span><span class=nb>set</span><span class=w> </span>-eux<span class=w> </span><span class=p>;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-113-48 name=__codelineno-113-48 href=#__codelineno-113-48></a><span class=w>    </span>chmod<span class=w> </span><span class=m>755</span><span class=w> </span>/home/jenkins/bin/*
<a id=__codelineno-113-49 name=__codelineno-113-49 href=#__codelineno-113-49></a>
<a id=__codelineno-113-50 name=__codelineno-113-50 href=#__codelineno-113-50></a><span class=c1># docker build -t hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11 .</span>
<a id=__codelineno-113-51 name=__codelineno-113-51 href=#__codelineno-113-51></a>
<a id=__codelineno-113-52 name=__codelineno-113-52 href=#__codelineno-113-52></a><span class=c1># docker push hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11</span>
<a id=__codelineno-113-53 name=__codelineno-113-53 href=#__codelineno-113-53></a>The<span class=w> </span>push<span class=w> </span>refers<span class=w> </span>to<span class=w> </span>repository<span class=w> </span><span class=o>[</span>hub.gitee.cc/kubernetes/jenkins-salve<span class=o>]</span>
<a id=__codelineno-113-54 name=__codelineno-113-54 href=#__codelineno-113-54></a>f861fb1f9735:<span class=w> </span>Pushing<span class=w> </span><span class=o>[===</span>&gt;<span class=w>                                               </span><span class=o>]</span><span class=w>  </span><span class=m>11</span>.11MB/150.2MB
<a id=__codelineno-113-55 name=__codelineno-113-55 href=#__codelineno-113-55></a>.....
</code></pre></div> <p>第 3 步. 点击最下方的 <code>Pod Templates</code> 按钮用于配置 Jenkins Slave 运行的 Pod 模板，命名空间我们同样是用 kube-ops，Labels 这里也非常重要，对于后面执行 Job 的时候需要用到该值。</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-13.png></p> <p>配置的Slave Pod中的Label名称</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-14.png></p> <p><a href=https://www.cnblogs.com/evescn/p/17573472.html>Jenkins 添加 K8S 集群</a></p> <h6 id=11-docker-in-pod推荐>1.1 docker in pod(推荐)<a class=headerlink href=#11-docker-in-pod推荐 title="Permanent link">&para;</a></h6> <p>配置容器模板</p> <p>jenkins-salve模板容器配置</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-15.png></p> <div class="admonition warning"> <p class=admonition-title>注意</p> <p>容器的名称必须是 <code>jnlp</code>，这是默认拉起的容器，另外需要将 <code>运行的命令</code> 和 <code>命令参数</code> 的值都删除掉，否则会失败。</p> </div> <p>由于jnlp容器中只是 docker cli，需要 docker daemon 才能正常使用，我们通常情况下的做法是将宿主机上的 docker sock 文件 <code>/var/run/docker.sock</code> 挂载到容器中，但是我们现在的 Kubernetes 集群使用的是 containerd 这种容器运行时，节点上没有 docker daemon。我们可以单独以 Pod 的形式在集群中跑一个 docker daemon 的服务，对应的资源清单如下所示：</p> <p>** 生产环境将docker-dind部署固定在性能好的服务器上，打上tag**</p> <p>因为<code>replicas: 1</code>，在应对多任务时会有点慢，所有如下的pod可以多部署几份。</p> <p>在Jenkinsfile中指定对应的server名称，调度对应的pod进行编译即可。</p> <p>配置hostPath存储模式</p> <p><code>docker-dind-1.yml</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-114-1 name=__codelineno-114-1 href=#__codelineno-114-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id=__codelineno-114-2 name=__codelineno-114-2 href=#__codelineno-114-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a id=__codelineno-114-3 name=__codelineno-114-3 href=#__codelineno-114-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-114-4 name=__codelineno-114-4 href=#__codelineno-114-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind-1</span>
<a id=__codelineno-114-5 name=__codelineno-114-5 href=#__codelineno-114-5></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<a id=__codelineno-114-6 name=__codelineno-114-6 href=#__codelineno-114-6></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-114-7 name=__codelineno-114-7 href=#__codelineno-114-7></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind-1</span>
<a id=__codelineno-114-8 name=__codelineno-114-8 href=#__codelineno-114-8></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-114-9 name=__codelineno-114-9 href=#__codelineno-114-9></a><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-114-10 name=__codelineno-114-10 href=#__codelineno-114-10></a><span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
<a id=__codelineno-114-11 name=__codelineno-114-11 href=#__codelineno-114-11></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-114-12 name=__codelineno-114-12 href=#__codelineno-114-12></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind-1</span>
<a id=__codelineno-114-13 name=__codelineno-114-13 href=#__codelineno-114-13></a><span class=w>  </span><span class=nt>template</span><span class=p>:</span>
<a id=__codelineno-114-14 name=__codelineno-114-14 href=#__codelineno-114-14></a><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-114-15 name=__codelineno-114-15 href=#__codelineno-114-15></a><span class=w>      </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-114-16 name=__codelineno-114-16 href=#__codelineno-114-16></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind-1</span>
<a id=__codelineno-114-17 name=__codelineno-114-17 href=#__codelineno-114-17></a><span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-114-18 name=__codelineno-114-18 href=#__codelineno-114-18></a><span class=w>      </span><span class=nt>containers</span><span class=p>:</span>
<a id=__codelineno-114-19 name=__codelineno-114-19 href=#__codelineno-114-19></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dind</span>
<a id=__codelineno-114-20 name=__codelineno-114-20 href=#__codelineno-114-20></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker:20.10.12-dind</span>
<a id=__codelineno-114-21 name=__codelineno-114-21 href=#__codelineno-114-21></a><span class=w>        </span><span class=nt>args</span><span class=p>:</span>
<a id=__codelineno-114-22 name=__codelineno-114-22 href=#__codelineno-114-22></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--insecure-registry=$(REGISTRY)</span>
<a id=__codelineno-114-23 name=__codelineno-114-23 href=#__codelineno-114-23></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--registry-mirror=https://25bxwt20.mirror.aliyuncs.com</span>
<a id=__codelineno-114-24 name=__codelineno-114-24 href=#__codelineno-114-24></a><span class=w>        </span><span class=nt>env</span><span class=p>:</span>
<a id=__codelineno-114-25 name=__codelineno-114-25 href=#__codelineno-114-25></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">REGISTRY</span>
<a id=__codelineno-114-26 name=__codelineno-114-26 href=#__codelineno-114-26></a><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http://hub.gitee.cc</span>
<a id=__codelineno-114-27 name=__codelineno-114-27 href=#__codelineno-114-27></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">DOCKER_TLS_CERTDIR</span>
<a id=__codelineno-114-28 name=__codelineno-114-28 href=#__codelineno-114-28></a><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s>&quot;&quot;</span>
<a id=__codelineno-114-29 name=__codelineno-114-29 href=#__codelineno-114-29></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">DOCKER_HOST</span>
<a id=__codelineno-114-30 name=__codelineno-114-30 href=#__codelineno-114-30></a><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">tcp://0.0.0.0:2375</span>
<a id=__codelineno-114-31 name=__codelineno-114-31 href=#__codelineno-114-31></a><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span>
<a id=__codelineno-114-32 name=__codelineno-114-32 href=#__codelineno-114-32></a><span class=w>          </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-114-33 name=__codelineno-114-33 href=#__codelineno-114-33></a><span class=w>        </span><span class=nt>tty</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-114-34 name=__codelineno-114-34 href=#__codelineno-114-34></a><span class=w>        </span><span class=nt>resources</span><span class=p>:</span>
<a id=__codelineno-114-35 name=__codelineno-114-35 href=#__codelineno-114-35></a><span class=w>          </span><span class=nt>requests</span><span class=p>:</span>
<a id=__codelineno-114-36 name=__codelineno-114-36 href=#__codelineno-114-36></a><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1000m</span>
<a id=__codelineno-114-37 name=__codelineno-114-37 href=#__codelineno-114-37></a><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">500Mi</span>
<a id=__codelineno-114-38 name=__codelineno-114-38 href=#__codelineno-114-38></a><span class=w>          </span><span class=nt>limits</span><span class=p>:</span>
<a id=__codelineno-114-39 name=__codelineno-114-39 href=#__codelineno-114-39></a><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">4096m</span>
<a id=__codelineno-114-40 name=__codelineno-114-40 href=#__codelineno-114-40></a><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8000Mi</span>
<a id=__codelineno-114-41 name=__codelineno-114-41 href=#__codelineno-114-41></a><span class=w>        </span><span class=nt>readinessProbe</span><span class=p>:</span>
<a id=__codelineno-114-42 name=__codelineno-114-42 href=#__codelineno-114-42></a><span class=w>          </span><span class=nt>exec</span><span class=p>:</span>
<a id=__codelineno-114-43 name=__codelineno-114-43 href=#__codelineno-114-43></a><span class=w>            </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;docker&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;info&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-114-44 name=__codelineno-114-44 href=#__codelineno-114-44></a><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<a id=__codelineno-114-45 name=__codelineno-114-45 href=#__codelineno-114-45></a><span class=w>          </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<a id=__codelineno-114-46 name=__codelineno-114-46 href=#__codelineno-114-46></a><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span>
<a id=__codelineno-114-47 name=__codelineno-114-47 href=#__codelineno-114-47></a><span class=w>          </span><span class=nt>exec</span><span class=p>:</span>
<a id=__codelineno-114-48 name=__codelineno-114-48 href=#__codelineno-114-48></a><span class=w>            </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;docker&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;info&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-114-49 name=__codelineno-114-49 href=#__codelineno-114-49></a><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<a id=__codelineno-114-50 name=__codelineno-114-50 href=#__codelineno-114-50></a><span class=w>          </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<a id=__codelineno-114-51 name=__codelineno-114-51 href=#__codelineno-114-51></a>
<a id=__codelineno-114-52 name=__codelineno-114-52 href=#__codelineno-114-52></a><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-114-53 name=__codelineno-114-53 href=#__codelineno-114-53></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-storage</span>
<a id=__codelineno-114-54 name=__codelineno-114-54 href=#__codelineno-114-54></a><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/docker</span>
<a id=__codelineno-114-55 name=__codelineno-114-55 href=#__codelineno-114-55></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">localtime</span>
<a id=__codelineno-114-56 name=__codelineno-114-56 href=#__codelineno-114-56></a><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/etc/localtime</span>
<a id=__codelineno-114-57 name=__codelineno-114-57 href=#__codelineno-114-57></a><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span>
<a id=__codelineno-114-58 name=__codelineno-114-58 href=#__codelineno-114-58></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-storage</span>
<a id=__codelineno-114-59 name=__codelineno-114-59 href=#__codelineno-114-59></a><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span>
<a id=__codelineno-114-60 name=__codelineno-114-60 href=#__codelineno-114-60></a><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/docker</span>
<a id=__codelineno-114-61 name=__codelineno-114-61 href=#__codelineno-114-61></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">localtime</span>
<a id=__codelineno-114-62 name=__codelineno-114-62 href=#__codelineno-114-62></a><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span>
<a id=__codelineno-114-63 name=__codelineno-114-63 href=#__codelineno-114-63></a><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/share/zoneinfo/Asia/Shanghai</span>
<a id=__codelineno-114-64 name=__codelineno-114-64 href=#__codelineno-114-64></a><span class=w>      </span><span class=nt>nodeSelector</span><span class=p>:</span>
<a id=__codelineno-114-65 name=__codelineno-114-65 href=#__codelineno-114-65></a><span class=w>        </span><span class=nt>docker-dind-1</span><span class=p>:</span><span class=w> </span><span class=s>&quot;true&quot;</span>
<a id=__codelineno-114-66 name=__codelineno-114-66 href=#__codelineno-114-66></a><span class=nn>---</span>
<a id=__codelineno-114-67 name=__codelineno-114-67 href=#__codelineno-114-67></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<a id=__codelineno-114-68 name=__codelineno-114-68 href=#__codelineno-114-68></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-114-69 name=__codelineno-114-69 href=#__codelineno-114-69></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-114-70 name=__codelineno-114-70 href=#__codelineno-114-70></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind-1</span>
<a id=__codelineno-114-71 name=__codelineno-114-71 href=#__codelineno-114-71></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<a id=__codelineno-114-72 name=__codelineno-114-72 href=#__codelineno-114-72></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-114-73 name=__codelineno-114-73 href=#__codelineno-114-73></a><span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
<a id=__codelineno-114-74 name=__codelineno-114-74 href=#__codelineno-114-74></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind-1</span>
<a id=__codelineno-114-75 name=__codelineno-114-75 href=#__codelineno-114-75></a><span class=w>  </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-114-76 name=__codelineno-114-76 href=#__codelineno-114-76></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<a id=__codelineno-114-77 name=__codelineno-114-77 href=#__codelineno-114-77></a><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2375</span>
<a id=__codelineno-114-78 name=__codelineno-114-78 href=#__codelineno-114-78></a><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2375</span>
</code></pre></div> <p>配置PVC nfs存储模式</p> <div class=highlight><pre><span></span><code><a id=__codelineno-115-1 name=__codelineno-115-1 href=#__codelineno-115-1></a><span class=nn>---</span>
<a id=__codelineno-115-2 name=__codelineno-115-2 href=#__codelineno-115-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-115-3 name=__codelineno-115-3 href=#__codelineno-115-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
<a id=__codelineno-115-4 name=__codelineno-115-4 href=#__codelineno-115-4></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-115-5 name=__codelineno-115-5 href=#__codelineno-115-5></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind-pv</span>
<a id=__codelineno-115-6 name=__codelineno-115-6 href=#__codelineno-115-6></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-115-7 name=__codelineno-115-7 href=#__codelineno-115-7></a><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind-pv</span>
<a id=__codelineno-115-8 name=__codelineno-115-8 href=#__codelineno-115-8></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-115-9 name=__codelineno-115-9 href=#__codelineno-115-9></a><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span>
<a id=__codelineno-115-10 name=__codelineno-115-10 href=#__codelineno-115-10></a><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10Gi</span>
<a id=__codelineno-115-11 name=__codelineno-115-11 href=#__codelineno-115-11></a><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span>
<a id=__codelineno-115-12 name=__codelineno-115-12 href=#__codelineno-115-12></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
<a id=__codelineno-115-13 name=__codelineno-115-13 href=#__codelineno-115-13></a><span class=w>  </span><span class=nt>persistentVolumeReclaimPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span>
<a id=__codelineno-115-14 name=__codelineno-115-14 href=#__codelineno-115-14></a><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gitee-nfs-client</span>
<a id=__codelineno-115-15 name=__codelineno-115-15 href=#__codelineno-115-15></a><span class=w>  </span><span class=nt>mountOptions</span><span class=p>:</span>
<a id=__codelineno-115-16 name=__codelineno-115-16 href=#__codelineno-115-16></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">hard</span>
<a id=__codelineno-115-17 name=__codelineno-115-17 href=#__codelineno-115-17></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nfsvers=4.1</span>
<a id=__codelineno-115-18 name=__codelineno-115-18 href=#__codelineno-115-18></a><span class=w>  </span><span class=nt>nfs</span><span class=p>:</span>
<a id=__codelineno-115-19 name=__codelineno-115-19 href=#__codelineno-115-19></a><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.60</span>
<a id=__codelineno-115-20 name=__codelineno-115-20 href=#__codelineno-115-20></a><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/QaTest/docker-dind</span>
<a id=__codelineno-115-21 name=__codelineno-115-21 href=#__codelineno-115-21></a><span class=nn>---</span>
<a id=__codelineno-115-22 name=__codelineno-115-22 href=#__codelineno-115-22></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-115-23 name=__codelineno-115-23 href=#__codelineno-115-23></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<a id=__codelineno-115-24 name=__codelineno-115-24 href=#__codelineno-115-24></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-115-25 name=__codelineno-115-25 href=#__codelineno-115-25></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-115-26 name=__codelineno-115-26 href=#__codelineno-115-26></a><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind</span>
<a id=__codelineno-115-27 name=__codelineno-115-27 href=#__codelineno-115-27></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind-data</span>
<a id=__codelineno-115-28 name=__codelineno-115-28 href=#__codelineno-115-28></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<a id=__codelineno-115-29 name=__codelineno-115-29 href=#__codelineno-115-29></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-115-30 name=__codelineno-115-30 href=#__codelineno-115-30></a><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span>
<a id=__codelineno-115-31 name=__codelineno-115-31 href=#__codelineno-115-31></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
<a id=__codelineno-115-32 name=__codelineno-115-32 href=#__codelineno-115-32></a><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gitee-nfs-client</span>
<a id=__codelineno-115-33 name=__codelineno-115-33 href=#__codelineno-115-33></a><span class=w>  </span><span class=nt>resources</span><span class=p>:</span>
<a id=__codelineno-115-34 name=__codelineno-115-34 href=#__codelineno-115-34></a><span class=w>    </span><span class=nt>requests</span><span class=p>:</span>
<a id=__codelineno-115-35 name=__codelineno-115-35 href=#__codelineno-115-35></a><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10Gi</span>
<a id=__codelineno-115-36 name=__codelineno-115-36 href=#__codelineno-115-36></a><span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
<a id=__codelineno-115-37 name=__codelineno-115-37 href=#__codelineno-115-37></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-115-38 name=__codelineno-115-38 href=#__codelineno-115-38></a><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind-pv</span>
<a id=__codelineno-115-39 name=__codelineno-115-39 href=#__codelineno-115-39></a>
<a id=__codelineno-115-40 name=__codelineno-115-40 href=#__codelineno-115-40></a><span class=nn>---</span>
<a id=__codelineno-115-41 name=__codelineno-115-41 href=#__codelineno-115-41></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id=__codelineno-115-42 name=__codelineno-115-42 href=#__codelineno-115-42></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a id=__codelineno-115-43 name=__codelineno-115-43 href=#__codelineno-115-43></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-115-44 name=__codelineno-115-44 href=#__codelineno-115-44></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind</span>
<a id=__codelineno-115-45 name=__codelineno-115-45 href=#__codelineno-115-45></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<a id=__codelineno-115-46 name=__codelineno-115-46 href=#__codelineno-115-46></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-115-47 name=__codelineno-115-47 href=#__codelineno-115-47></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind</span>
<a id=__codelineno-115-48 name=__codelineno-115-48 href=#__codelineno-115-48></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-115-49 name=__codelineno-115-49 href=#__codelineno-115-49></a><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-115-50 name=__codelineno-115-50 href=#__codelineno-115-50></a><span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
<a id=__codelineno-115-51 name=__codelineno-115-51 href=#__codelineno-115-51></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-115-52 name=__codelineno-115-52 href=#__codelineno-115-52></a><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind</span>
<a id=__codelineno-115-53 name=__codelineno-115-53 href=#__codelineno-115-53></a><span class=w>  </span><span class=nt>template</span><span class=p>:</span>
<a id=__codelineno-115-54 name=__codelineno-115-54 href=#__codelineno-115-54></a><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-115-55 name=__codelineno-115-55 href=#__codelineno-115-55></a><span class=w>      </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-115-56 name=__codelineno-115-56 href=#__codelineno-115-56></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind</span>
<a id=__codelineno-115-57 name=__codelineno-115-57 href=#__codelineno-115-57></a><span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-115-58 name=__codelineno-115-58 href=#__codelineno-115-58></a><span class=w>      </span><span class=nt>containers</span><span class=p>:</span>
<a id=__codelineno-115-59 name=__codelineno-115-59 href=#__codelineno-115-59></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dind</span>
<a id=__codelineno-115-60 name=__codelineno-115-60 href=#__codelineno-115-60></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker:20.10.12-dind</span>
<a id=__codelineno-115-61 name=__codelineno-115-61 href=#__codelineno-115-61></a><span class=w>        </span><span class=nt>args</span><span class=p>:</span>
<a id=__codelineno-115-62 name=__codelineno-115-62 href=#__codelineno-115-62></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--insecure-registry=$(REGISTRY)</span>
<a id=__codelineno-115-63 name=__codelineno-115-63 href=#__codelineno-115-63></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--registry-mirror=https://25bxwt20.mirror.aliyuncs.com</span>
<a id=__codelineno-115-64 name=__codelineno-115-64 href=#__codelineno-115-64></a><span class=w>        </span><span class=nt>env</span><span class=p>:</span>
<a id=__codelineno-115-65 name=__codelineno-115-65 href=#__codelineno-115-65></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">REGISTRY</span>
<a id=__codelineno-115-66 name=__codelineno-115-66 href=#__codelineno-115-66></a><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http://hub.gitee.cc</span>
<a id=__codelineno-115-67 name=__codelineno-115-67 href=#__codelineno-115-67></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">DOCKER_TLS_CERTDIR</span>
<a id=__codelineno-115-68 name=__codelineno-115-68 href=#__codelineno-115-68></a><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s>&quot;&quot;</span>
<a id=__codelineno-115-69 name=__codelineno-115-69 href=#__codelineno-115-69></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">DOCKER_HOST</span>
<a id=__codelineno-115-70 name=__codelineno-115-70 href=#__codelineno-115-70></a><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">tcp://0.0.0.0:2375</span>
<a id=__codelineno-115-71 name=__codelineno-115-71 href=#__codelineno-115-71></a><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span>
<a id=__codelineno-115-72 name=__codelineno-115-72 href=#__codelineno-115-72></a><span class=w>          </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-115-73 name=__codelineno-115-73 href=#__codelineno-115-73></a><span class=w>        </span><span class=nt>tty</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-115-74 name=__codelineno-115-74 href=#__codelineno-115-74></a><span class=w>        </span><span class=nt>resources</span><span class=p>:</span>
<a id=__codelineno-115-75 name=__codelineno-115-75 href=#__codelineno-115-75></a><span class=w>          </span><span class=nt>requests</span><span class=p>:</span>
<a id=__codelineno-115-76 name=__codelineno-115-76 href=#__codelineno-115-76></a><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1000m</span>
<a id=__codelineno-115-77 name=__codelineno-115-77 href=#__codelineno-115-77></a><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">500Mi</span>
<a id=__codelineno-115-78 name=__codelineno-115-78 href=#__codelineno-115-78></a><span class=w>          </span><span class=nt>limits</span><span class=p>:</span>
<a id=__codelineno-115-79 name=__codelineno-115-79 href=#__codelineno-115-79></a><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">4096m</span>
<a id=__codelineno-115-80 name=__codelineno-115-80 href=#__codelineno-115-80></a><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8000Mi</span>
<a id=__codelineno-115-81 name=__codelineno-115-81 href=#__codelineno-115-81></a><span class=w>        </span><span class=nt>readinessProbe</span><span class=p>:</span>
<a id=__codelineno-115-82 name=__codelineno-115-82 href=#__codelineno-115-82></a><span class=w>          </span><span class=nt>exec</span><span class=p>:</span>
<a id=__codelineno-115-83 name=__codelineno-115-83 href=#__codelineno-115-83></a><span class=w>            </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;docker&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;info&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-115-84 name=__codelineno-115-84 href=#__codelineno-115-84></a><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<a id=__codelineno-115-85 name=__codelineno-115-85 href=#__codelineno-115-85></a><span class=w>          </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<a id=__codelineno-115-86 name=__codelineno-115-86 href=#__codelineno-115-86></a><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span>
<a id=__codelineno-115-87 name=__codelineno-115-87 href=#__codelineno-115-87></a><span class=w>          </span><span class=nt>exec</span><span class=p>:</span>
<a id=__codelineno-115-88 name=__codelineno-115-88 href=#__codelineno-115-88></a><span class=w>            </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;docker&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;info&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-115-89 name=__codelineno-115-89 href=#__codelineno-115-89></a><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<a id=__codelineno-115-90 name=__codelineno-115-90 href=#__codelineno-115-90></a><span class=w>          </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<a id=__codelineno-115-91 name=__codelineno-115-91 href=#__codelineno-115-91></a>
<a id=__codelineno-115-92 name=__codelineno-115-92 href=#__codelineno-115-92></a><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-115-93 name=__codelineno-115-93 href=#__codelineno-115-93></a><span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind-data-vol</span>
<a id=__codelineno-115-94 name=__codelineno-115-94 href=#__codelineno-115-94></a><span class=w>            </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/docker/</span>
<a id=__codelineno-115-95 name=__codelineno-115-95 href=#__codelineno-115-95></a><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span>
<a id=__codelineno-115-96 name=__codelineno-115-96 href=#__codelineno-115-96></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind-data-vol</span>
<a id=__codelineno-115-97 name=__codelineno-115-97 href=#__codelineno-115-97></a><span class=w>          </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span>
<a id=__codelineno-115-98 name=__codelineno-115-98 href=#__codelineno-115-98></a><span class=w>            </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind-data</span>
<a id=__codelineno-115-99 name=__codelineno-115-99 href=#__codelineno-115-99></a><span class=w>      </span><span class=nt>nodeSelector</span><span class=p>:</span>
<a id=__codelineno-115-100 name=__codelineno-115-100 href=#__codelineno-115-100></a><span class=w>        </span><span class=nt>build</span><span class=p>:</span><span class=w> </span><span class=s>&quot;true&quot;</span>
<a id=__codelineno-115-101 name=__codelineno-115-101 href=#__codelineno-115-101></a><span class=nn>---</span>
<a id=__codelineno-115-102 name=__codelineno-115-102 href=#__codelineno-115-102></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<a id=__codelineno-115-103 name=__codelineno-115-103 href=#__codelineno-115-103></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-115-104 name=__codelineno-115-104 href=#__codelineno-115-104></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-115-105 name=__codelineno-115-105 href=#__codelineno-115-105></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind</span>
<a id=__codelineno-115-106 name=__codelineno-115-106 href=#__codelineno-115-106></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<a id=__codelineno-115-107 name=__codelineno-115-107 href=#__codelineno-115-107></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-115-108 name=__codelineno-115-108 href=#__codelineno-115-108></a><span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
<a id=__codelineno-115-109 name=__codelineno-115-109 href=#__codelineno-115-109></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker-dind</span>
<a id=__codelineno-115-110 name=__codelineno-115-110 href=#__codelineno-115-110></a><span class=w>  </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-115-111 name=__codelineno-115-111 href=#__codelineno-115-111></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<a id=__codelineno-115-112 name=__codelineno-115-112 href=#__codelineno-115-112></a><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2375</span>
<a id=__codelineno-115-113 name=__codelineno-115-113 href=#__codelineno-115-113></a><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2375</span>
</code></pre></div> <p>直接创建上面的资源对象即可：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-116-1 name=__codelineno-116-1 href=#__codelineno-116-1></a>$<span class=w> </span>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>docker-dind.yaml
<a id=__codelineno-116-2 name=__codelineno-116-2 href=#__codelineno-116-2></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>kube-ops<span class=w> </span>-l<span class=w> </span><span class=nv>app</span><span class=o>=</span>docker-dind
<a id=__codelineno-116-3 name=__codelineno-116-3 href=#__codelineno-116-3></a>NAME<span class=w>                           </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>   </span>AGE
<a id=__codelineno-116-4 name=__codelineno-116-4 href=#__codelineno-116-4></a>docker-dind-86d95bfc49-wq248<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>17s
<a id=__codelineno-116-5 name=__codelineno-116-5 href=#__codelineno-116-5></a>
<a id=__codelineno-116-6 name=__codelineno-116-6 href=#__codelineno-116-6></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>svc<span class=w> </span>-n<span class=w> </span>kube-ops<span class=w> </span>-l<span class=w> </span><span class=nv>app</span><span class=o>=</span>docker-dind
<a id=__codelineno-116-7 name=__codelineno-116-7 href=#__codelineno-116-7></a>NAME<span class=w>          </span>TYPE<span class=w>        </span>CLUSTER-IP<span class=w>        </span>EXTERNAL-IP<span class=w>   </span>PORT<span class=o>(</span>S<span class=o>)</span><span class=w>    </span>AGE
<a id=__codelineno-116-8 name=__codelineno-116-8 href=#__codelineno-116-8></a>docker-dind<span class=w>   </span>ClusterIP<span class=w>   </span><span class=m>192</span>.168.172.137<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>2375</span>/TCP<span class=w>   </span>6m3s
</code></pre></div> <div class="admonition abstract"> <p class=admonition-title>扩展参考文献</p> <p><a href=https://github.com/jenkinsci/docker-inbound-agent>github-jenkins-agent-docker</a></p> <p><a href=https://wnote.com/post/cicd-jenkins-agent-docker-kubectl-helm/ >自定义Jenkins Agent集成docker和kubectl工具</a></p> <p><a href=https://wnote.com/post/cicd-jenkins-in-kubernetes/#back-to-top>kubernetes环境下部署Jenkins</a></p> <p><a href=https://mp.weixin.qq.com/s/ndy3qKEuokX-Oi8e-rSwPw>Jenkins 基于 Kubernetes 的动态和静态节点</a></p> <p><a href=https://blog.csdn.net/alex_yangchuansheng/article/details/123564347>流水线中使用 docker in pod 方式构建容器镜像</a></p> <p><a href=https://mp.weixin.qq.com/s/qCYCDWXFMnC8flYiTioVPg>基于K8s插件版的Jenkins动态节点实践【内含最佳实践】</a></p> <p><a href=https://blog.51cto.com/devopsvip/5521288>基于K8s插件版的Jenkins动态节点实践【内含最佳实践】</a></p> </div> <h6 id=12-物理机build推荐>1.2 物理机build(推荐)<a class=headerlink href=#12-物理机build推荐 title="Permanent link">&para;</a></h6> <p>选择一台有SSD性能好的物理服务器作为编译镜像打包服务器。</p> <p>在命令行上来创建 Secret提供私有仓库拉取凭证。这样<code>hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11</code>私有镜像就能正常拉取了。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-117-1 name=__codelineno-117-1 href=#__codelineno-117-1></a>$<span class=w> </span>kubectl<span class=w> </span>-n<span class=w> </span>kube-ops<span class=w> </span>create<span class=w> </span>secret<span class=w> </span>docker-registry<span class=w> </span>regcred<span class=w> </span><span class=se>\</span>
<a id=__codelineno-117-2 name=__codelineno-117-2 href=#__codelineno-117-2></a>--docker-server<span class=o>=</span>http://hub.gitee.cc<span class=w> </span><span class=se>\</span>
<a id=__codelineno-117-3 name=__codelineno-117-3 href=#__codelineno-117-3></a>--docker-username<span class=o>=</span>admin<span class=w> </span><span class=se>\</span>
<a id=__codelineno-117-4 name=__codelineno-117-4 href=#__codelineno-117-4></a>--docker-password<span class=o>=</span>oschina123<span class=w> </span><span class=se>\</span>
<a id=__codelineno-117-5 name=__codelineno-117-5 href=#__codelineno-117-5></a>--docker-email<span class=o>=</span><span class=m>1</span>@1.com
</code></pre></div> <p>参考：<a href=https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/pull-image-private-registry/ >https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/pull-image-private-registry/</a></p> <p>在图形界面中设置拉取凭证信息。</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-16.png></p> <div class="admonition warning"> <p class=admonition-title>注意</p> <p>如果读者的Kubernetes集群采用的是Containerd作为Runtime，配置insecure-registry只需要在Containerd配置文件的mirrors下添加自己的镜像仓库地址即可</p> </div> <p><strong>vim /etc/containerd/config.toml</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-118-1 name=__codelineno-118-1 href=#__codelineno-118-1></a>    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry]
<a id=__codelineno-118-2 name=__codelineno-118-2 href=#__codelineno-118-2></a>      config_path = &quot;&quot;
<a id=__codelineno-118-3 name=__codelineno-118-3 href=#__codelineno-118-3></a>
<a id=__codelineno-118-4 name=__codelineno-118-4 href=#__codelineno-118-4></a>      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.auths]
<a id=__codelineno-118-5 name=__codelineno-118-5 href=#__codelineno-118-5></a>
<a id=__codelineno-118-6 name=__codelineno-118-6 href=#__codelineno-118-6></a>      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs]
<a id=__codelineno-118-7 name=__codelineno-118-7 href=#__codelineno-118-7></a>        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;hub.gitee.cc&quot;.tls]
<a id=__codelineno-118-8 name=__codelineno-118-8 href=#__codelineno-118-8></a>          insecure_skip_verify = true
<a id=__codelineno-118-9 name=__codelineno-118-9 href=#__codelineno-118-9></a>        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;hub.gitee.cc&quot;.auth]
<a id=__codelineno-118-10 name=__codelineno-118-10 href=#__codelineno-118-10></a>      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.headers]
<a id=__codelineno-118-11 name=__codelineno-118-11 href=#__codelineno-118-11></a>
<a id=__codelineno-118-12 name=__codelineno-118-12 href=#__codelineno-118-12></a>      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors]
<a id=__codelineno-118-13 name=__codelineno-118-13 href=#__codelineno-118-13></a>        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]
<a id=__codelineno-118-14 name=__codelineno-118-14 href=#__codelineno-118-14></a>          endpoint = [&quot;https://pooj3a7i.mirror.aliyuncs.com&quot;]
<a id=__codelineno-118-15 name=__codelineno-118-15 href=#__codelineno-118-15></a>        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;hub.gitee.cc&quot;]
<a id=__codelineno-118-16 name=__codelineno-118-16 href=#__codelineno-118-16></a>          endpoint = [&quot;http://hub.gitee.cc&quot;]
</code></pre></div> <p>配置完成后，重启Containerd，之后进行pull测试：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-119-1 name=__codelineno-119-1 href=#__codelineno-119-1></a>$<span class=w> </span>systemctl<span class=w> </span>restart<span class=w> </span>containerd
<a id=__codelineno-119-2 name=__codelineno-119-2 href=#__codelineno-119-2></a>$<span class=w> </span>ctr<span class=w> </span>-n<span class=w> </span>k8s.io<span class=w> </span>image<span class=w> </span>pull<span class=w> </span>hub.gitee.cc/kubernetes/webkubectl:latest<span class=w> </span>--plain-http<span class=w> </span>--user<span class=w> </span>admin:oschina123<span class=w> </span>
</code></pre></div> <p>然后我们可以通过设置环境变量 <code>DOCKER_HOST: tcp://docker-dind:2375</code> 去连接 docker dind 服务。</p> <p>另外需要将文件 <code>/root/.kube/config</code> 挂载到容器的 <code>/root/.kube/</code> 目录下面，这是为了让我们能够在 Pod 的容器中能够使用 <code>kubectl</code> 工具来访问我们的Kubernetes集群，方便我们后面在 <code>Slave Pod</code> 部署 Kubernetes 应用。</p> <p>首先在master上创建cm文件，cm文件位于kube-ops名称空间下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-120-1 name=__codelineno-120-1 href=#__codelineno-120-1></a>$<span class=w> </span>kubectl<span class=w> </span>create<span class=w> </span>configmap<span class=w> </span>kubeconfig<span class=w> </span>--from-file<span class=o>=</span>/root/.kube/config<span class=w> </span>-n<span class=w> </span>kube-ops
<a id=__codelineno-120-2 name=__codelineno-120-2 href=#__codelineno-120-2></a>$<span class=w> </span>k<span class=w> </span>get<span class=w> </span>cm<span class=w> </span>-n<span class=w> </span>kube-ops
<a id=__codelineno-120-3 name=__codelineno-120-3 href=#__codelineno-120-3></a>NAME<span class=w>               </span>DATA<span class=w>   </span>AGE
<a id=__codelineno-120-4 name=__codelineno-120-4 href=#__codelineno-120-4></a>kube-root-ca.crt<span class=w>   </span><span class=m>1</span><span class=w>      </span>2d
<a id=__codelineno-120-5 name=__codelineno-120-5 href=#__codelineno-120-5></a>kubeconfig<span class=w>         </span><span class=m>1</span><span class=w>      </span>6m4s
</code></pre></div> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-17.png></p> <p>另外如果在配置了后运行 Slave Pod 的时候出现了权限问题，这是因为Jenkins Slave Pod中没有配置权限，所以需要配置上 ServiceAccount， 在Slave Pod配置的地方点击下面的高级，添加上对应的 ServiceAccount 即可：</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-18.png></p> <p>到这里我们的 Kubernetes 插件就算配置完成了，记得保存。</p> <h5 id=2-测试>2. 测试<a class=headerlink href=#2-测试 title="Permanent link">&para;</a></h5> <p>Kubernetes 插件的配置工作完成了，接下来我们就来添加一个Job任务，看是否能够在Slave Pod中执行，任务执行完成后看Pod是否会被销毁。</p> <h6 id=21-自由风格的流水线>2.1 自由风格的流水线<a class=headerlink href=#21-自由风格的流水线 title="Permanent link">&para;</a></h6> <p>在 Jenkins 首页点击 <code>新建任务</code>，创建一个测试的任务，输入任务名称，然后我们选择 <code>构建一个自由风格的软件项目</code> 类型的任务，注意在下面的 <code>Label Expression</code> 这里要填入 <code>jenkins-jnlp</code>，就是前面我们配置的 Slave Pod 中的 Label，这两个地方必须保持一致：</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-19.png></p> <p>然后往下拉，在 <code>构建</code> 区域选择 <code>执行 shell</code>：</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-20.png></p> <p>然后输入我们测试命令</p> <div class=highlight><pre><span></span><code><a id=__codelineno-121-1 name=__codelineno-121-1 href=#__codelineno-121-1></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;测试 Kubernetes 动态生成 jenkins slave&quot;</span>
<a id=__codelineno-121-2 name=__codelineno-121-2 href=#__codelineno-121-2></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;==============docker in docker===========&quot;</span>
<a id=__codelineno-121-3 name=__codelineno-121-3 href=#__codelineno-121-3></a>docker<span class=w> </span>version
<a id=__codelineno-121-4 name=__codelineno-121-4 href=#__codelineno-121-4></a>
<a id=__codelineno-121-5 name=__codelineno-121-5 href=#__codelineno-121-5></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;=============kubectl=============&quot;</span>
<a id=__codelineno-121-6 name=__codelineno-121-6 href=#__codelineno-121-6></a>kubectl<span class=w> </span>get<span class=w> </span>pods
</code></pre></div> <p>最后点击保存。</p> <p>现在我们直接在页面点击左侧的 <code>立即构建</code> 触发构建即可，然后观察 Kubernetes 集群中 Pod 的变化：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-122-1 name=__codelineno-122-1 href=#__codelineno-122-1></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>kube-ops
<a id=__codelineno-122-2 name=__codelineno-122-2 href=#__codelineno-122-2></a>NAME<span class=w>                          </span>READY<span class=w>   </span>STATUS<span class=w>              </span>RESTARTS<span class=w>   </span>AGE
<a id=__codelineno-122-3 name=__codelineno-122-3 href=#__codelineno-122-3></a>jenkins-556cd59c8c-2vl8m<span class=w>    </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>             </span><span class=m>0</span><span class=w>          </span>64m
<a id=__codelineno-122-4 name=__codelineno-122-4 href=#__codelineno-122-4></a>jenkins-agent-rb8hk<span class=w>           </span><span class=m>0</span>/1<span class=w>     </span>ContainerCreating<span class=w>   </span><span class=m>0</span><span class=w>          </span>8s
</code></pre></div> <p>我们可以看到在我们点击立刻构建的时候可以看到一个新的 Pod：<code>jenkins-agent-rb8hk</code> 被创建了，这就是我们的 Jenkins Slave。任务执行完成后我们可以看到任务信息:</p> <p>到这里证明我们的任务已经构建完成，然后这个时候我们再去集群查看我们的 Pod 列表，发现 kube-ops 这个 namespace 下面已经没有之前的 Slave 这个 Pod 了。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-123-1 name=__codelineno-123-1 href=#__codelineno-123-1></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>kube-ops
<a id=__codelineno-123-2 name=__codelineno-123-2 href=#__codelineno-123-2></a>NAME<span class=w>                                           </span>READY<span class=w>   </span>STATUS<span class=w>              </span>RESTARTS<span class=w>   </span>AGE
<a id=__codelineno-123-3 name=__codelineno-123-3 href=#__codelineno-123-3></a>jenkins-556cd59c8c-2vl8m<span class=w>                       </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>             </span><span class=m>0</span><span class=w>          </span>12h
</code></pre></div> <p>到这里我们就完成了使用 Kubernetes 动态生成 Jenkins Slave 的方法。</p> <h6 id=22-pipeline流水线>2.2 pipeline流水线<a class=headerlink href=#22-pipeline流水线 title="Permanent link">&para;</a></h6> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-21.png></p> <p>使用物理机用于build。物理机可以安装负载均衡、反向代理（haproxy、nginx）软件，制作一个docker build 分发池，分摊build构建压力。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-124-1 name=__codelineno-124-1 href=#__codelineno-124-1></a>pipeline{
<a id=__codelineno-124-2 name=__codelineno-124-2 href=#__codelineno-124-2></a>    environment {
<a id=__codelineno-124-3 name=__codelineno-124-3 href=#__codelineno-124-3></a>        VERSION = &quot;v5.0.0&quot;
<a id=__codelineno-124-4 name=__codelineno-124-4 href=#__codelineno-124-4></a>        RELEASE_VERSION = &quot;master&quot;
<a id=__codelineno-124-5 name=__codelineno-124-5 href=#__codelineno-124-5></a>        GIT_ADDRESS = &quot;https://gitee.com/oschina/gitee.git&quot;
<a id=__codelineno-124-6 name=__codelineno-124-6 href=#__codelineno-124-6></a>
<a id=__codelineno-124-7 name=__codelineno-124-7 href=#__codelineno-124-7></a>    }
<a id=__codelineno-124-8 name=__codelineno-124-8 href=#__codelineno-124-8></a>
<a id=__codelineno-124-9 name=__codelineno-124-9 href=#__codelineno-124-9></a>    options {
<a id=__codelineno-124-10 name=__codelineno-124-10 href=#__codelineno-124-10></a>      parallelsAlwaysFailFast()
<a id=__codelineno-124-11 name=__codelineno-124-11 href=#__codelineno-124-11></a>      disableResume()
<a id=__codelineno-124-12 name=__codelineno-124-12 href=#__codelineno-124-12></a>      skipDefaultCheckout()
<a id=__codelineno-124-13 name=__codelineno-124-13 href=#__codelineno-124-13></a>      quietPeriod(1)
<a id=__codelineno-124-14 name=__codelineno-124-14 href=#__codelineno-124-14></a>      preserveStashes(buildCount: 5)
<a id=__codelineno-124-15 name=__codelineno-124-15 href=#__codelineno-124-15></a>      timestamps()
<a id=__codelineno-124-16 name=__codelineno-124-16 href=#__codelineno-124-16></a>      buildDiscarder(logRotator(numToKeepStr: &#39;100&#39;))
<a id=__codelineno-124-17 name=__codelineno-124-17 href=#__codelineno-124-17></a>      timeout(time: 60, unit: &#39;MINUTES&#39;)
<a id=__codelineno-124-18 name=__codelineno-124-18 href=#__codelineno-124-18></a>    }
<a id=__codelineno-124-19 name=__codelineno-124-19 href=#__codelineno-124-19></a>
<a id=__codelineno-124-20 name=__codelineno-124-20 href=#__codelineno-124-20></a>    agent {
<a id=__codelineno-124-21 name=__codelineno-124-21 href=#__codelineno-124-21></a>        kubernetes {
<a id=__codelineno-124-22 name=__codelineno-124-22 href=#__codelineno-124-22></a>            cloud &#39;kubernetes&#39;
<a id=__codelineno-124-23 name=__codelineno-124-23 href=#__codelineno-124-23></a>            slaveConnectTimeout 1200
<a id=__codelineno-124-24 name=__codelineno-124-24 href=#__codelineno-124-24></a>            workspaceVolume nfsWorkspaceVolume(serverAddress: &quot;192.168.1.60&quot;, serverPath: &quot;/QaTest/jenkins-salve&quot;, readOnly: &quot;false&quot;)
<a id=__codelineno-124-25 name=__codelineno-124-25 href=#__codelineno-124-25></a>            yaml &#39;&#39;&#39;
<a id=__codelineno-124-26 name=__codelineno-124-26 href=#__codelineno-124-26></a>
<a id=__codelineno-124-27 name=__codelineno-124-27 href=#__codelineno-124-27></a>---
<a id=__codelineno-124-28 name=__codelineno-124-28 href=#__codelineno-124-28></a>apiVersion: &quot;v1&quot;
<a id=__codelineno-124-29 name=__codelineno-124-29 href=#__codelineno-124-29></a>kind: &quot;Pod&quot;
<a id=__codelineno-124-30 name=__codelineno-124-30 href=#__codelineno-124-30></a>metadata:
<a id=__codelineno-124-31 name=__codelineno-124-31 href=#__codelineno-124-31></a>  labels:
<a id=__codelineno-124-32 name=__codelineno-124-32 href=#__codelineno-124-32></a>    jenkins: &quot;slave&quot;
<a id=__codelineno-124-33 name=__codelineno-124-33 href=#__codelineno-124-33></a>    jenkins/label: &quot;jenkins-jnlp&quot;
<a id=__codelineno-124-34 name=__codelineno-124-34 href=#__codelineno-124-34></a>  name: &quot;jenkins-slave&quot;
<a id=__codelineno-124-35 name=__codelineno-124-35 href=#__codelineno-124-35></a>  namespace: &quot;kube-ops&quot;
<a id=__codelineno-124-36 name=__codelineno-124-36 href=#__codelineno-124-36></a>
<a id=__codelineno-124-37 name=__codelineno-124-37 href=#__codelineno-124-37></a>spec:
<a id=__codelineno-124-38 name=__codelineno-124-38 href=#__codelineno-124-38></a>  containers:
<a id=__codelineno-124-39 name=__codelineno-124-39 href=#__codelineno-124-39></a>  - env:
<a id=__codelineno-124-40 name=__codelineno-124-40 href=#__codelineno-124-40></a>    - name: &quot;DOCKER_HOST&quot;
<a id=__codelineno-124-41 name=__codelineno-124-41 href=#__codelineno-124-41></a>      value: &quot;tcp://192.168.1.141:2375&quot;
<a id=__codelineno-124-42 name=__codelineno-124-42 href=#__codelineno-124-42></a>
<a id=__codelineno-124-43 name=__codelineno-124-43 href=#__codelineno-124-43></a>    - name: &quot;JENKINS_AGENT_WORKDIR&quot;
<a id=__codelineno-124-44 name=__codelineno-124-44 href=#__codelineno-124-44></a>      value: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-124-45 name=__codelineno-124-45 href=#__codelineno-124-45></a>
<a id=__codelineno-124-46 name=__codelineno-124-46 href=#__codelineno-124-46></a>    image: &quot;hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11&quot;
<a id=__codelineno-124-47 name=__codelineno-124-47 href=#__codelineno-124-47></a>    imagePullPolicy: &quot;IfNotPresent&quot;
<a id=__codelineno-124-48 name=__codelineno-124-48 href=#__codelineno-124-48></a>    name: &quot;jnlp&quot;
<a id=__codelineno-124-49 name=__codelineno-124-49 href=#__codelineno-124-49></a>    tty: true
<a id=__codelineno-124-50 name=__codelineno-124-50 href=#__codelineno-124-50></a>    resources:
<a id=__codelineno-124-51 name=__codelineno-124-51 href=#__codelineno-124-51></a>      limits:
<a id=__codelineno-124-52 name=__codelineno-124-52 href=#__codelineno-124-52></a>        cpu: 1000m
<a id=__codelineno-124-53 name=__codelineno-124-53 href=#__codelineno-124-53></a>        memory: 2000Mi
<a id=__codelineno-124-54 name=__codelineno-124-54 href=#__codelineno-124-54></a>      requests:
<a id=__codelineno-124-55 name=__codelineno-124-55 href=#__codelineno-124-55></a>        cpu: 200m
<a id=__codelineno-124-56 name=__codelineno-124-56 href=#__codelineno-124-56></a>        memory: 400Mi
<a id=__codelineno-124-57 name=__codelineno-124-57 href=#__codelineno-124-57></a>
<a id=__codelineno-124-58 name=__codelineno-124-58 href=#__codelineno-124-58></a>
<a id=__codelineno-124-59 name=__codelineno-124-59 href=#__codelineno-124-59></a>    volumeMounts:
<a id=__codelineno-124-60 name=__codelineno-124-60 href=#__codelineno-124-60></a>    - mountPath: &quot;/root/.kube/config&quot;
<a id=__codelineno-124-61 name=__codelineno-124-61 href=#__codelineno-124-61></a>      name: &quot;volume-0&quot;
<a id=__codelineno-124-62 name=__codelineno-124-62 href=#__codelineno-124-62></a>      readOnly: false
<a id=__codelineno-124-63 name=__codelineno-124-63 href=#__codelineno-124-63></a>      subPath: &quot;config&quot;
<a id=__codelineno-124-64 name=__codelineno-124-64 href=#__codelineno-124-64></a>
<a id=__codelineno-124-65 name=__codelineno-124-65 href=#__codelineno-124-65></a>    - name: localtime
<a id=__codelineno-124-66 name=__codelineno-124-66 href=#__codelineno-124-66></a>      mountPath: /etc/localtime
<a id=__codelineno-124-67 name=__codelineno-124-67 href=#__codelineno-124-67></a>
<a id=__codelineno-124-68 name=__codelineno-124-68 href=#__codelineno-124-68></a>    - mountPath: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-124-69 name=__codelineno-124-69 href=#__codelineno-124-69></a>      name: &quot;workspace-volume&quot;
<a id=__codelineno-124-70 name=__codelineno-124-70 href=#__codelineno-124-70></a>      readOnly: false
<a id=__codelineno-124-71 name=__codelineno-124-71 href=#__codelineno-124-71></a>    workingDir: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-124-72 name=__codelineno-124-72 href=#__codelineno-124-72></a>
<a id=__codelineno-124-73 name=__codelineno-124-73 href=#__codelineno-124-73></a>  hostNetwork: false
<a id=__codelineno-124-74 name=__codelineno-124-74 href=#__codelineno-124-74></a>  imagePullSecrets:
<a id=__codelineno-124-75 name=__codelineno-124-75 href=#__codelineno-124-75></a>  - name: &quot;regcred&quot;
<a id=__codelineno-124-76 name=__codelineno-124-76 href=#__codelineno-124-76></a>  nodeSelector:
<a id=__codelineno-124-77 name=__codelineno-124-77 href=#__codelineno-124-77></a>    kubernetes.io/os: &quot;linux&quot;
<a id=__codelineno-124-78 name=__codelineno-124-78 href=#__codelineno-124-78></a>
<a id=__codelineno-124-79 name=__codelineno-124-79 href=#__codelineno-124-79></a>  restartPolicy: &quot;Never&quot;
<a id=__codelineno-124-80 name=__codelineno-124-80 href=#__codelineno-124-80></a>  volumes:
<a id=__codelineno-124-81 name=__codelineno-124-81 href=#__codelineno-124-81></a>  - name: localtime
<a id=__codelineno-124-82 name=__codelineno-124-82 href=#__codelineno-124-82></a>    hostPath:
<a id=__codelineno-124-83 name=__codelineno-124-83 href=#__codelineno-124-83></a>      path: /usr/share/zoneinfo/Asia/Shanghai
<a id=__codelineno-124-84 name=__codelineno-124-84 href=#__codelineno-124-84></a>
<a id=__codelineno-124-85 name=__codelineno-124-85 href=#__codelineno-124-85></a>  - configMap:
<a id=__codelineno-124-86 name=__codelineno-124-86 href=#__codelineno-124-86></a>      name: &quot;kubeconfig&quot;
<a id=__codelineno-124-87 name=__codelineno-124-87 href=#__codelineno-124-87></a>      optional: false
<a id=__codelineno-124-88 name=__codelineno-124-88 href=#__codelineno-124-88></a>    name: &quot;volume-0&quot;
<a id=__codelineno-124-89 name=__codelineno-124-89 href=#__codelineno-124-89></a>
<a id=__codelineno-124-90 name=__codelineno-124-90 href=#__codelineno-124-90></a>  - emptyDir:
<a id=__codelineno-124-91 name=__codelineno-124-91 href=#__codelineno-124-91></a>      medium: &quot;&quot;
<a id=__codelineno-124-92 name=__codelineno-124-92 href=#__codelineno-124-92></a>    name: &quot;workspace-volume&quot;
<a id=__codelineno-124-93 name=__codelineno-124-93 href=#__codelineno-124-93></a>            &#39;&#39;&#39;
<a id=__codelineno-124-94 name=__codelineno-124-94 href=#__codelineno-124-94></a>        }
<a id=__codelineno-124-95 name=__codelineno-124-95 href=#__codelineno-124-95></a>    }
<a id=__codelineno-124-96 name=__codelineno-124-96 href=#__codelineno-124-96></a>
<a id=__codelineno-124-97 name=__codelineno-124-97 href=#__codelineno-124-97></a>    stages {
<a id=__codelineno-124-98 name=__codelineno-124-98 href=#__codelineno-124-98></a>      stage(&#39;Build&#39;) {
<a id=__codelineno-124-99 name=__codelineno-124-99 href=#__codelineno-124-99></a>        steps {
<a id=__codelineno-124-100 name=__codelineno-124-100 href=#__codelineno-124-100></a>          sh &#39;&#39;&#39;#!/bin/bash
<a id=__codelineno-124-101 name=__codelineno-124-101 href=#__codelineno-124-101></a>                set -eu
<a id=__codelineno-124-102 name=__codelineno-124-102 href=#__codelineno-124-102></a>                echo &#39;Build&#39;
<a id=__codelineno-124-103 name=__codelineno-124-103 href=#__codelineno-124-103></a>                echo
<a id=__codelineno-124-104 name=__codelineno-124-104 href=#__codelineno-124-104></a>                docker version
<a id=__codelineno-124-105 name=__codelineno-124-105 href=#__codelineno-124-105></a>                echo
<a id=__codelineno-124-106 name=__codelineno-124-106 href=#__codelineno-124-106></a>             &#39;&#39;&#39;
<a id=__codelineno-124-107 name=__codelineno-124-107 href=#__codelineno-124-107></a>        }
<a id=__codelineno-124-108 name=__codelineno-124-108 href=#__codelineno-124-108></a>      }
<a id=__codelineno-124-109 name=__codelineno-124-109 href=#__codelineno-124-109></a>      stage(&#39;Test&#39;) {
<a id=__codelineno-124-110 name=__codelineno-124-110 href=#__codelineno-124-110></a>        steps {
<a id=__codelineno-124-111 name=__codelineno-124-111 href=#__codelineno-124-111></a>          echo &#39;Test&#39;
<a id=__codelineno-124-112 name=__codelineno-124-112 href=#__codelineno-124-112></a>        }
<a id=__codelineno-124-113 name=__codelineno-124-113 href=#__codelineno-124-113></a>      }
<a id=__codelineno-124-114 name=__codelineno-124-114 href=#__codelineno-124-114></a>      stage(&#39;Deploy&#39;) {
<a id=__codelineno-124-115 name=__codelineno-124-115 href=#__codelineno-124-115></a>        steps {
<a id=__codelineno-124-116 name=__codelineno-124-116 href=#__codelineno-124-116></a>            sh &#39;&#39;&#39;#!/bin/bash
<a id=__codelineno-124-117 name=__codelineno-124-117 href=#__codelineno-124-117></a>                set -eu
<a id=__codelineno-124-118 name=__codelineno-124-118 href=#__codelineno-124-118></a>                echo &#39;Deploy&#39;
<a id=__codelineno-124-119 name=__codelineno-124-119 href=#__codelineno-124-119></a>                echo
<a id=__codelineno-124-120 name=__codelineno-124-120 href=#__codelineno-124-120></a>                kubectl get nodes
<a id=__codelineno-124-121 name=__codelineno-124-121 href=#__codelineno-124-121></a>                echo
<a id=__codelineno-124-122 name=__codelineno-124-122 href=#__codelineno-124-122></a>             &#39;&#39;&#39;
<a id=__codelineno-124-123 name=__codelineno-124-123 href=#__codelineno-124-123></a>      }
<a id=__codelineno-124-124 name=__codelineno-124-124 href=#__codelineno-124-124></a>    }
<a id=__codelineno-124-125 name=__codelineno-124-125 href=#__codelineno-124-125></a>  }
<a id=__codelineno-124-126 name=__codelineno-124-126 href=#__codelineno-124-126></a>}
</code></pre></div> <h3 id=52-安装gitlab>5.2 安装GitLab<a class=headerlink href=#52-安装gitlab title="Permanent link">&para;</a></h3> <p>GitLab在企业内经常用于代码的版本控制，是DevOps平台中尤为重要的一个工具。接下来在另一台服务器（40GB以上）上安装GitLab（如果有可用 的GitLab，也无须安装）。</p> <h4 id=1-服务方式部署推荐>1. 服务方式部署(推荐)<a class=headerlink href=#1-服务方式部署推荐 title="Permanent link">&para;</a></h4> <p>首先在GitLab国内源下载GitLab的安装包：<a href=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/ >https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/</a>。 将下载后的RPM包上传到服务器，之后通过yum直接安装即可：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-125-1 name=__codelineno-125-1 href=#__codelineno-125-1></a>$<span class=w> </span>mkdir<span class=w> </span>gitlab
<a id=__codelineno-125-2 name=__codelineno-125-2 href=#__codelineno-125-2></a>$<span class=w> </span><span class=nb>cd</span><span class=w> </span>gitlab/
<a id=__codelineno-125-3 name=__codelineno-125-3 href=#__codelineno-125-3></a>$<span class=w> </span>wget<span class=w> </span>-c<span class=w> </span>https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-15.8.2-ce.0.el7.x86_64.rpm
<a id=__codelineno-125-4 name=__codelineno-125-4 href=#__codelineno-125-4></a>$<span class=w> </span>yum<span class=w> </span>install<span class=w> </span>gitlab-ce-14.2.3-ce.0.el7.x86_64.rpm<span class=w> </span>-y
</code></pre></div> <p>安装完成后，需要更改几处配置： <div class=highlight><pre><span></span><code><a id=__codelineno-126-1 name=__codelineno-126-1 href=#__codelineno-126-1></a>vim /etc/gitlab/gitlab.rb
</code></pre></div></p> <p>将external_url更改为自己的发布地址，可以是服务器的IP，也可以是一个可被解析的域名，更改完成后需要重新加载配置文件：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-127-1 name=__codelineno-127-1 href=#__codelineno-127-1></a># gitlab-ctl reconfigure
</code></pre></div> <p>之后可以通过浏览器访问GitLab ， 账号为root ，默认密码在/etc/gitlab/initial_root_password。</p> <h4 id=2-docker方式部署推荐>2. docker方式部署(推荐)<a class=headerlink href=#2-docker方式部署推荐 title="Permanent link">&para;</a></h4> <p>gitlab-ce 有两个不同的容器化镜像，sameersbn/gitlab 和 gitlab/gitlab-ce， 前者是第三方维护的，用户广泛，年代久远，通过注入环境变量来自动修改配置文件，就是版本一般会落后官方。后者是官方的镜像，更新及时。</p> <h5 id=21-sameersbngitlab>2.1 sameersbn/gitlab<a class=headerlink href=#21-sameersbngitlab title="Permanent link">&para;</a></h5> <div class="admonition example"> <p class=admonition-title>仓库地址</p> <blockquote> <p><a href=https://github.com/sameersbn/docker-gitlab>https://github.com/sameersbn/docker-gitlab</a></p> <p><a href=https://www.jianshu.com/p/abd406052677>https://www.jianshu.com/p/abd406052677</a></p> <p><a href=https://www.jianshu.com/p/ee0c8ed4795e>https://www.jianshu.com/p/ee0c8ed4795e</a></p> </blockquote> </div> <h5 id=22-gitlabgitlab-ce>2.2 gitlab/gitlab-ce<a class=headerlink href=#22-gitlabgitlab-ce title="Permanent link">&para;</a></h5> <p>创建安装目录、拉取镜像</p> <div class=highlight><pre><span></span><code><a id=__codelineno-128-1 name=__codelineno-128-1 href=#__codelineno-128-1></a>$<span class=w> </span>docker<span class=w> </span>pull<span class=w> </span>gitlab/gitlab-ce
<a id=__codelineno-128-2 name=__codelineno-128-2 href=#__codelineno-128-2></a>
<a id=__codelineno-128-3 name=__codelineno-128-3 href=#__codelineno-128-3></a>$<span class=w> </span>mkdir<span class=w> </span>-p<span class=w> </span>/root/wokerdir/gitlab
</code></pre></div> <p><code>docker-compose.yaml</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-129-1 name=__codelineno-129-1 href=#__codelineno-129-1></a><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s>&#39;3.1&#39;</span>
<a id=__codelineno-129-2 name=__codelineno-129-2 href=#__codelineno-129-2></a><span class=nt>services</span><span class=p>:</span>
<a id=__codelineno-129-3 name=__codelineno-129-3 href=#__codelineno-129-3></a><span class=w>  </span><span class=nt>gitlab</span><span class=p>:</span>
<a id=__codelineno-129-4 name=__codelineno-129-4 href=#__codelineno-129-4></a><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s>&#39;gitlab/gitlab-ce:latest&#39;</span>
<a id=__codelineno-129-5 name=__codelineno-129-5 href=#__codelineno-129-5></a><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gitlab</span>
<a id=__codelineno-129-6 name=__codelineno-129-6 href=#__codelineno-129-6></a><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
<a id=__codelineno-129-7 name=__codelineno-129-7 href=#__codelineno-129-7></a><span class=w>    </span><span class=nt>environment</span><span class=p>:</span>
<a id=__codelineno-129-8 name=__codelineno-129-8 href=#__codelineno-129-8></a><span class=w>      </span><span class=nt>GITLAB_OMNIBUS_CONFIG</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span>
<a id=__codelineno-129-9 name=__codelineno-129-9 href=#__codelineno-129-9></a><span class=w>        </span><span class=no>external_url &#39;http://gitlab.runjs.cn:8929&#39;</span>
<a id=__codelineno-129-10 name=__codelineno-129-10 href=#__codelineno-129-10></a><span class=w>        </span><span class=no>gitlab_rails[&#39;gitlab_shell_ssh_port&#39;] = 2224</span>
<a id=__codelineno-129-11 name=__codelineno-129-11 href=#__codelineno-129-11></a><span class=w>    </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-129-12 name=__codelineno-129-12 href=#__codelineno-129-12></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;8929:8929&#39;</span>
<a id=__codelineno-129-13 name=__codelineno-129-13 href=#__codelineno-129-13></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;2224:22&#39;</span>
<a id=__codelineno-129-14 name=__codelineno-129-14 href=#__codelineno-129-14></a><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span>
<a id=__codelineno-129-15 name=__codelineno-129-15 href=#__codelineno-129-15></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;./config:/etc/gitlab&#39;</span>
<a id=__codelineno-129-16 name=__codelineno-129-16 href=#__codelineno-129-16></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;./logs:/var/log/gitlab&#39;</span>
<a id=__codelineno-129-17 name=__codelineno-129-17 href=#__codelineno-129-17></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;./data:/var/opt/gitlab&#39;</span>
<a id=__codelineno-129-18 name=__codelineno-129-18 href=#__codelineno-129-18></a><span class=w>    </span><span class=nt>shm_size</span><span class=p>:</span><span class=w> </span><span class=s>&#39;256m&#39;</span>
</code></pre></div> <blockquote> <ol> <li>指定三个端口,22为ssh端口,80为http端口,443为https端口,分别映射到宿主机的7022、8080和7443端口</li> <li> <p>通过--volume指定目录映射,其中</p> </li> <li> <p>/etc/gitlab表示gitlab的配置目录,映射到宿主机的/opt/gitlab/config目录.</p> </li> <li>/var/log/gitlab表示gitlab的日志目录,映射到宿主机的/opt/gitlab/logs目录.</li> <li> <p>/var/opt/gitlab表示gitlab的数据目录,映射到宿主机的/opt/gitlab/data目录.</p> </li> <li> <p>目录说明</p> </li> <li> <p>/opt/gitlab/config 存储 GitLab 配置信息</p> </li> <li>/opt/gitlab/data 存储数据库</li> <li>/opt/gitlab/logs 存储日志</li> </ol> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-130-1 name=__codelineno-130-1 href=#__codelineno-130-1></a>$<span class=w> </span>docker-compose<span class=w> </span>up<span class=w> </span>-d
<a id=__codelineno-130-2 name=__codelineno-130-2 href=#__codelineno-130-2></a>
<a id=__codelineno-130-3 name=__codelineno-130-3 href=#__codelineno-130-3></a><span class=c1>## 重启gitlab容器</span>
<a id=__codelineno-130-4 name=__codelineno-130-4 href=#__codelineno-130-4></a>$<span class=w> </span>docker<span class=w> </span>restart<span class=w> </span>gitlab
</code></pre></div> <p>启动容器（需要稍等一小会……）</p> <p><strong>重启配置服务（出现问题）</strong> </p> <p>由于我们运行是使用数据卷参数进行运行的，宿主机的gitlab.rb文件修改了，gitlab的文件会跟着改，但是容器的文件不会跟着生效，必须要进去容器里面进行命令执行，重置配置文件比较耗费时间，需要耐心等待，如果时间比较短说明成功率不高，而且进去容器之后就退出啦。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-131-1 name=__codelineno-131-1 href=#__codelineno-131-1></a>$<span class=w> </span>docker<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span>gitlab<span class=w> </span>/bin/bash<span class=w>  </span><span class=c1>#进去gitlab容器的命令</span>
<a id=__codelineno-131-2 name=__codelineno-131-2 href=#__codelineno-131-2></a>$<span class=w> </span>gitlab-ctl<span class=w> </span>reconfigure<span class=w>        </span><span class=c1>#重置gitlab客户端的命令</span>
<a id=__codelineno-131-3 name=__codelineno-131-3 href=#__codelineno-131-3></a>$<span class=w> </span>gitlab-ctrl<span class=w> </span>restart
</code></pre></div> <p>查看root登录密码</p> <div class=highlight><pre><span></span><code><a id=__codelineno-132-1 name=__codelineno-132-1 href=#__codelineno-132-1></a>$<span class=w> </span>docker<span class=w> </span><span class=nb>exec</span><span class=w>  </span><span class=k>$(</span>docker<span class=w> </span>ps<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>gitlab<span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span><span class=w> </span>grep<span class=w> </span><span class=s1>&#39;Password:&#39;</span><span class=w> </span>/etc/gitlab/initial_root_password
<a id=__codelineno-132-2 name=__codelineno-132-2 href=#__codelineno-132-2></a>Password:<span class=w> </span><span class=nv>lB7RIXsS41R7on31KPHAzJ0FE736mBMPxTdjOt4g2Lo</span><span class=o>=</span>
</code></pre></div> <p><strong>重置管理员密码</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-133-1 name=__codelineno-133-1 href=#__codelineno-133-1></a>root@docker-node141:~/gitlab#<span class=w> </span>docker<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span>gitlab<span class=w> </span>/bin/bash
<a id=__codelineno-133-2 name=__codelineno-133-2 href=#__codelineno-133-2></a>root@192:/#<span class=w> </span>gitlab-rails<span class=w> </span>console<span class=w> </span>-e<span class=w> </span>production
<a id=__codelineno-133-3 name=__codelineno-133-3 href=#__codelineno-133-3></a>--------------------------------------------------------------------------------
<a id=__codelineno-133-4 name=__codelineno-133-4 href=#__codelineno-133-4></a><span class=w> </span>Ruby:<span class=w>         </span>ruby<span class=w> </span><span class=m>2</span>.7.5p203<span class=w> </span><span class=o>(</span><span class=m>2021</span>-11-24<span class=w> </span>revision<span class=w> </span>f69aeb8314<span class=o>)</span><span class=w> </span><span class=o>[</span>x86_64-linux<span class=o>]</span>
<a id=__codelineno-133-5 name=__codelineno-133-5 href=#__codelineno-133-5></a><span class=w> </span>GitLab:<span class=w>       </span><span class=m>14</span>.6.1<span class=w> </span><span class=o>(</span>661d663ab2b<span class=o>)</span><span class=w> </span>FOSS
<a id=__codelineno-133-6 name=__codelineno-133-6 href=#__codelineno-133-6></a><span class=w> </span>GitLab<span class=w> </span>Shell:<span class=w> </span><span class=m>13</span>.22.1
<a id=__codelineno-133-7 name=__codelineno-133-7 href=#__codelineno-133-7></a><span class=w> </span>PostgreSQL:<span class=w>   </span><span class=m>12</span>.7
<a id=__codelineno-133-8 name=__codelineno-133-8 href=#__codelineno-133-8></a>--------------------------------------------------------------------------------
<a id=__codelineno-133-9 name=__codelineno-133-9 href=#__codelineno-133-9></a>Loading<span class=w> </span>production<span class=w> </span>environment<span class=w> </span><span class=o>(</span>Rails<span class=w> </span><span class=m>6</span>.1.4.1<span class=o>)</span>
<a id=__codelineno-133-10 name=__codelineno-133-10 href=#__codelineno-133-10></a>irb<span class=o>(</span>main<span class=o>)</span>:001:0&gt;<span class=w> </span><span class=nv>user</span><span class=w> </span><span class=o>=</span><span class=w> </span>User.where<span class=o>(</span>id:<span class=w> </span><span class=m>1</span><span class=o>)</span>.first
<a id=__codelineno-133-11 name=__codelineno-133-11 href=#__codelineno-133-11></a><span class=o>=</span>&gt;<span class=w> </span><span class=c1>#&lt;User id:1 @root&gt;</span>
<a id=__codelineno-133-12 name=__codelineno-133-12 href=#__codelineno-133-12></a>irb<span class=o>(</span>main<span class=o>)</span>:002:0&gt;<span class=w> </span>user.password<span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;oschina123&#39;</span>
<a id=__codelineno-133-13 name=__codelineno-133-13 href=#__codelineno-133-13></a><span class=o>=</span>&gt;<span class=w> </span><span class=s2>&quot;oschina123&quot;</span>
<a id=__codelineno-133-14 name=__codelineno-133-14 href=#__codelineno-133-14></a>irb<span class=o>(</span>main<span class=o>)</span>:003:0&gt;<span class=w> </span>user.password_confirmation<span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;oschina123&#39;</span>
<a id=__codelineno-133-15 name=__codelineno-133-15 href=#__codelineno-133-15></a><span class=o>=</span>&gt;<span class=w> </span><span class=s2>&quot;oschina123&quot;</span>
<a id=__codelineno-133-16 name=__codelineno-133-16 href=#__codelineno-133-16></a>irb<span class=o>(</span>main<span class=o>)</span>:004:0&gt;<span class=w> </span>user.save!
<a id=__codelineno-133-17 name=__codelineno-133-17 href=#__codelineno-133-17></a><span class=o>=</span>&gt;<span class=w> </span><span class=nb>true</span>
<a id=__codelineno-133-18 name=__codelineno-133-18 href=#__codelineno-133-18></a>irb<span class=o>(</span>main<span class=o>)</span>:005:0&gt;<span class=w> </span><span class=nb>exit</span>
</code></pre></div> <p><strong>常用命令</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-134-1 name=__codelineno-134-1 href=#__codelineno-134-1></a><span class=c1># 进入容器</span>
<a id=__codelineno-134-2 name=__codelineno-134-2 href=#__codelineno-134-2></a>docker<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span>gitlab<span class=w> </span>/bin/bash
<a id=__codelineno-134-3 name=__codelineno-134-3 href=#__codelineno-134-3></a>
<a id=__codelineno-134-4 name=__codelineno-134-4 href=#__codelineno-134-4></a><span class=c1># 启动所有gitlab组件</span>
<a id=__codelineno-134-5 name=__codelineno-134-5 href=#__codelineno-134-5></a>gitlab-ctl<span class=w> </span>start
<a id=__codelineno-134-6 name=__codelineno-134-6 href=#__codelineno-134-6></a>
<a id=__codelineno-134-7 name=__codelineno-134-7 href=#__codelineno-134-7></a><span class=c1># 查看gitlab状态</span>
<a id=__codelineno-134-8 name=__codelineno-134-8 href=#__codelineno-134-8></a>gitlab-ctl<span class=w> </span>status
<a id=__codelineno-134-9 name=__codelineno-134-9 href=#__codelineno-134-9></a>
<a id=__codelineno-134-10 name=__codelineno-134-10 href=#__codelineno-134-10></a><span class=c1># 重新启用配置</span>
<a id=__codelineno-134-11 name=__codelineno-134-11 href=#__codelineno-134-11></a>gitlab-ctl<span class=w> </span>reconfigure
<a id=__codelineno-134-12 name=__codelineno-134-12 href=#__codelineno-134-12></a>
<a id=__codelineno-134-13 name=__codelineno-134-13 href=#__codelineno-134-13></a><span class=c1># 重启gitlab</span>
<a id=__codelineno-134-14 name=__codelineno-134-14 href=#__codelineno-134-14></a>docker<span class=w> </span>restart<span class=w> </span>gitlab
</code></pre></div> <p>登录后，可以创建一个测试项目，进行一些简单的测试。首先创建一个组。组名为kubernetes，类型为Private，之后单击Create group</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-22.png></p> <p>选择创建一个空的项目，输入项目名称test-project，然后单击Create project如图 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-23.png></p> <p>之后可以将Jenkins服务器的key导入GitLab，首先生成密钥（如有可以不生成）：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-135-1 name=__codelineno-135-1 href=#__codelineno-135-1></a>$<span class=w> </span>ssh-keygen<span class=w> </span>-t<span class=w> </span>rsa<span class=w> </span>-C<span class=w> </span><span class=s2>&quot;YOUR_EMAIL@ADDRESS.COM&quot;</span>
</code></pre></div> <p>将公钥的内容放在GitLab中：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-136-1 name=__codelineno-136-1 href=#__codelineno-136-1></a>$<span class=w> </span>cat<span class=w> </span>~/.ssh/id_rsa.pub
<a id=__codelineno-136-2 name=__codelineno-136-2 href=#__codelineno-136-2></a>ssh-rsa<span class=w> </span>AAAAB3NzaC1yc2EAAAADAQABAAABgQDAipO4jkJioJBW57Nv25i95yAiWNCeaySwvtFViOqtcX644WbN81SDwMscYCvKNcdgPmXkzBaKWBzehAVZ9RhVN1gqp9/BvnGzhyz6IpYXMgQfsDLIakARM4uJjxKt9LCTVugUL3kA5p+fsNsaMwpSy/+scnfUsuKCTqDuCBBGbdRkBIjC2ZuXzXs2ei2jWwVavJbxSZwMxPT2pNeHG7GxiyIBVwR6kbdDQNqzDBOBSATKSFp8XKhdc+7Mu3f6cUD64i+TxBgqqG1rA29yb4xn0iB1IHxsOCc5RO4WrfwrYQxMsMiB2cxQK2sKhrNrggeQ4LQhsWRWQWxTaDEB5TbvMsdKoEAivGE8OjUyyz/3VTPFqMtLEeAB5RDjOwFKeJBB6aYNOqOYlI7nm1g9oLm4OtiSjeSxz2MvO0N4KPMBgX6qW5lecYbD6VrJC2RVic05NouViRWoJPJEIUn9c3wNd0lDYMYhDVAOfW4PPx0B6gf1b40+aTlUxoUPLAhTocs<span class=o>=</span><span class=w> </span><span class=m>1879324764</span>@qq.com
</code></pre></div> <p>在GitLab找到Profile，之后在SSH Keys添加公钥，如图 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-24.png></p> <p>创建几个文件，然后提交测试：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-137-1 name=__codelineno-137-1 href=#__codelineno-137-1></a>$<span class=w> </span>git<span class=w> </span>clone<span class=w> </span>ssh://git@gitlab.runjs.cn:7022/kubernetes/test-project.git
<a id=__codelineno-137-2 name=__codelineno-137-2 href=#__codelineno-137-2></a>$<span class=w> </span><span class=nb>cd</span><span class=w> </span>test-project/
<a id=__codelineno-137-3 name=__codelineno-137-3 href=#__codelineno-137-3></a>$<span class=w> </span>touch<span class=w> </span>aaa<span class=o>{</span><span class=m>1</span>..3<span class=o>}</span>.py
<a id=__codelineno-137-4 name=__codelineno-137-4 href=#__codelineno-137-4></a>root@docker-node141:~/gitlab/test-project#<span class=w> </span><span class=nb>echo</span><span class=w> </span><span class=s1>&#39;aaa&#39;</span><span class=w> </span>&gt;<span class=w> </span>aaa1.py
<a id=__codelineno-137-5 name=__codelineno-137-5 href=#__codelineno-137-5></a>root@docker-node141:~/gitlab/test-project#<span class=w> </span>git<span class=w> </span>add<span class=w> </span>.
<a id=__codelineno-137-6 name=__codelineno-137-6 href=#__codelineno-137-6></a>
<a id=__codelineno-137-7 name=__codelineno-137-7 href=#__codelineno-137-7></a>root@docker-node141:~/gitlab/test-project#<span class=w> </span>git<span class=w> </span>config<span class=w> </span>--global<span class=w> </span>user.email<span class=w> </span><span class=s2>&quot;18793247642qq.com&quot;</span>
<a id=__codelineno-137-8 name=__codelineno-137-8 href=#__codelineno-137-8></a>root@docker-node141:~/gitlab/test-project#<span class=w> </span>git<span class=w> </span>config<span class=w> </span>--global<span class=w> </span>user.name<span class=w> </span><span class=s2>&quot;hujianli&quot;</span>
<a id=__codelineno-137-9 name=__codelineno-137-9 href=#__codelineno-137-9></a>root@docker-node141:~/gitlab/test-project#<span class=w> </span>git<span class=w> </span>commit<span class=w> </span>-m<span class=w> </span><span class=s2>&quot;first commit&quot;</span>
<a id=__codelineno-137-10 name=__codelineno-137-10 href=#__codelineno-137-10></a><span class=o>[</span>main<span class=w> </span>515ab18<span class=o>]</span><span class=w> </span>first<span class=w> </span>commit
<a id=__codelineno-137-11 name=__codelineno-137-11 href=#__codelineno-137-11></a><span class=w> </span><span class=m>3</span><span class=w> </span>files<span class=w> </span>changed,<span class=w> </span><span class=m>1</span><span class=w> </span>insertion<span class=o>(</span>+<span class=o>)</span>
<a id=__codelineno-137-12 name=__codelineno-137-12 href=#__codelineno-137-12></a><span class=w> </span>create<span class=w> </span>mode<span class=w> </span><span class=m>100644</span><span class=w> </span>aaa1.py
<a id=__codelineno-137-13 name=__codelineno-137-13 href=#__codelineno-137-13></a><span class=w> </span>create<span class=w> </span>mode<span class=w> </span><span class=m>100644</span><span class=w> </span>aaa2.py
<a id=__codelineno-137-14 name=__codelineno-137-14 href=#__codelineno-137-14></a><span class=w> </span>create<span class=w> </span>mode<span class=w> </span><span class=m>100644</span><span class=w> </span>aaa3.py
<a id=__codelineno-137-15 name=__codelineno-137-15 href=#__codelineno-137-15></a>
<a id=__codelineno-137-16 name=__codelineno-137-16 href=#__codelineno-137-16></a>root@docker-node141:~/gitlab/test-project#<span class=w> </span>git<span class=w> </span>push<span class=w> </span>origin<span class=w> </span>main
<a id=__codelineno-137-17 name=__codelineno-137-17 href=#__codelineno-137-17></a>Warning:<span class=w> </span>Permanently<span class=w> </span>added<span class=w> </span><span class=s1>&#39;[gitlab.runjs.cn]:7022,[192.168.1.141]:7022&#39;</span><span class=w> </span><span class=o>(</span>ECDSA<span class=o>)</span><span class=w> </span>to<span class=w> </span>the<span class=w> </span>list<span class=w> </span>of<span class=w> </span>known<span class=w> </span>hosts.
<a id=__codelineno-137-18 name=__codelineno-137-18 href=#__codelineno-137-18></a>Enumerating<span class=w> </span>objects:<span class=w> </span><span class=m>5</span>,<span class=w> </span><span class=k>done</span>.
<a id=__codelineno-137-19 name=__codelineno-137-19 href=#__codelineno-137-19></a>Counting<span class=w> </span>objects:<span class=w> </span><span class=m>100</span>%<span class=w> </span><span class=o>(</span><span class=m>5</span>/5<span class=o>)</span>,<span class=w> </span><span class=k>done</span>.
<a id=__codelineno-137-20 name=__codelineno-137-20 href=#__codelineno-137-20></a>Delta<span class=w> </span>compression<span class=w> </span>using<span class=w> </span>up<span class=w> </span>to<span class=w> </span><span class=m>8</span><span class=w> </span>threads
<a id=__codelineno-137-21 name=__codelineno-137-21 href=#__codelineno-137-21></a>Compressing<span class=w> </span>objects:<span class=w> </span><span class=m>100</span>%<span class=w> </span><span class=o>(</span><span class=m>2</span>/2<span class=o>)</span>,<span class=w> </span><span class=k>done</span>.
<a id=__codelineno-137-22 name=__codelineno-137-22 href=#__codelineno-137-22></a>Writing<span class=w> </span>objects:<span class=w> </span><span class=m>100</span>%<span class=w> </span><span class=o>(</span><span class=m>4</span>/4<span class=o>)</span>,<span class=w> </span><span class=m>313</span><span class=w> </span>bytes<span class=w> </span><span class=p>|</span><span class=w> </span><span class=m>313</span>.00<span class=w> </span>KiB/s,<span class=w> </span><span class=k>done</span>.
<a id=__codelineno-137-23 name=__codelineno-137-23 href=#__codelineno-137-23></a>Total<span class=w> </span><span class=m>4</span><span class=w> </span><span class=o>(</span>delta<span class=w> </span><span class=m>0</span><span class=o>)</span>,<span class=w> </span>reused<span class=w> </span><span class=m>0</span><span class=w> </span><span class=o>(</span>delta<span class=w> </span><span class=m>0</span><span class=o>)</span>
<a id=__codelineno-137-24 name=__codelineno-137-24 href=#__codelineno-137-24></a>To<span class=w> </span>ssh://gitlab.runjs.cn:7022/kubernetes/test-project.git
<a id=__codelineno-137-25 name=__codelineno-137-25 href=#__codelineno-137-25></a><span class=w>   </span>b77d308..515ab18<span class=w>  </span>main<span class=w> </span>-&gt;<span class=w> </span>main
</code></pre></div> <div class="admonition example"> <p class=admonition-title>参考文献</p> <p><a href=https://www.cnblogs.com/linanjie/p/13932352.html>https://www.cnblogs.com/linanjie/p/13932352.html</a></p> <p><a href=https://wtl4it.blog.csdn.net/article/details/125019372>https://wtl4it.blog.csdn.net/article/details/125019372</a></p> <p><a href=https://www.cnblogs.com/wei325/p/17106525.html>企业级GitLab在Docker部署使用</a></p> </div> <div class="admonition abstract"> <p class=admonition-title>官方文档</p> <p><a href=https://docs.gitlab.com/ee/install/docker.html>https://docs.gitlab.com/ee/install/docker.html</a></p> </div> <h4 id=3-yaml方式部署不推荐>3. yaml方式部署(不推荐)<a class=headerlink href=#3-yaml方式部署不推荐 title="Permanent link">&para;</a></h4> <div class="admonition example"> <p class=admonition-title>参考文献</p> <p><a href=https://www.qikqiak.com/k8strain2/devops/gitlab/ >https://www.qikqiak.com/k8strain2/devops/gitlab/</a></p> </div> <h4 id=4-helm3安装gitlab不推荐>4. helm3安装gitlab(不推荐)<a class=headerlink href=#4-helm3安装gitlab不推荐 title="Permanent link">&para;</a></h4> <div class="admonition example"> <p class=admonition-title>参考文献</p> <p><a href=https://blog.51cto.com/u_14268033/2456991>https://blog.51cto.com/u_14268033/2456991</a></p> </div> <h3 id=53-安装harbor>5.3 安装Harbor<a class=headerlink href=#53-安装harbor title="Permanent link">&para;</a></h3> <p>在使用容器或者Kubernetes发布服务时，都是以镜像为基准发布的，而镜像的存储需要镜像仓库来支持，目前比较常用的有Harbor、Nexus、JFrog Artifactory等。</p> <p>本小节将演示Harbor的安装和使用，这也是企业内比较常用的镜像仓库。</p> <div class="admonition warning"> <p class=admonition-title>注意</p> <p>推荐使用docker-compose的方式部署，节省kubernetes资源，单独镜像仓库环境</p> </div> <h5 id=1-docker方式部署推荐>1. docker方式部署(推荐)<a class=headerlink href=#1-docker方式部署推荐 title="Permanent link">&para;</a></h5> <p>首先在GitHub下载新的Harbor离线包，并上传至Harbor服务器，官方下载地址：<a href=https://github.com/goharbor/harbor/releases/ >https://github.com/goharbor/harbor/releases/</a>。 由于Harbor是采用docker-compose一键部署的，因此Harbor服务器也需要安装Docker</p> <blockquote> <p>Harbor 高可用搭建(docker-compose)</p> </blockquote> <div class="admonition example"> <p class=admonition-title>参考文献</p> <p><a href=https://clay-wangzhi.com/cloudnative/kubernetes/docker-harbor-ha.html#summary>https://clay-wangzhi.com/cloudnative/kubernetes/docker-harbor-ha.html#summary</a></p> </div> <p>Harbor 是一个主流的镜像仓库系统，在 v1.6 版本以后的 harbor 中新增加了 helm charts 的管理功能，可以存储Chart文件。</p> <div class="admonition example"> <p class=admonition-title>参考文献</p> <blockquote> <p>部署仓库地址：<a href=https://gitee.com/autom-studio/simple-harbor>https://gitee.com/autom-studio/simple-harbor</a></p> </blockquote> </div> <p>离线包：harbor-offline-installer-v240.tgz</p> <div class=highlight><pre><span></span><code><a id=__codelineno-138-1 name=__codelineno-138-1 href=#__codelineno-138-1></a>$<span class=w> </span>wget<span class=w> </span>https://github.com/goharbor/harbor/releases/download/v2.4.2/harbor-online-installer-v2.4.2.tgz
<a id=__codelineno-138-2 name=__codelineno-138-2 href=#__codelineno-138-2></a>
<a id=__codelineno-138-3 name=__codelineno-138-3 href=#__codelineno-138-3></a><span class=c1># 上传安装包到服务器/root/wokerdir/harbor目录下</span>
<a id=__codelineno-138-4 name=__codelineno-138-4 href=#__codelineno-138-4></a>$<span class=w> </span><span class=nb>cd</span><span class=w> </span>/root/wokerdir/harbor
<a id=__codelineno-138-5 name=__codelineno-138-5 href=#__codelineno-138-5></a>$<span class=w> </span>tar<span class=w> </span>-zxf<span class=w> </span>harbor-online-installer-v2.4.2.tgz
<a id=__codelineno-138-6 name=__codelineno-138-6 href=#__codelineno-138-6></a>$<span class=w> </span><span class=nb>cd</span><span class=w> </span>/root/wokerdir/harbor/harbor
<a id=__codelineno-138-7 name=__codelineno-138-7 href=#__codelineno-138-7></a>
<a id=__codelineno-138-8 name=__codelineno-138-8 href=#__codelineno-138-8></a><span class=c1>## 复制 harbor 配置模板</span>
<a id=__codelineno-138-9 name=__codelineno-138-9 href=#__codelineno-138-9></a>$<span class=w> </span>cp<span class=w> </span>harbor.yml.tmpl<span class=w> </span>harbor.yml
</code></pre></div> <p>解压并修改配置文件，只需修改 harbor.yml ，修改项如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-139-1 name=__codelineno-139-1 href=#__codelineno-139-1></a>hostname: hub.gitee.cc  # 访问域名或IP地址
<a id=__codelineno-139-2 name=__codelineno-139-2 href=#__codelineno-139-2></a>
<a id=__codelineno-139-3 name=__codelineno-139-3 href=#__codelineno-139-3></a># 如果没有ssl证书，则注释掉 https 字段
<a id=__codelineno-139-4 name=__codelineno-139-4 href=#__codelineno-139-4></a>harbor_admin_password: admin123    # 初始管理员密码
<a id=__codelineno-139-5 name=__codelineno-139-5 href=#__codelineno-139-5></a>data_volume: /data/harbor    # 镜像文件存储路径，需要指定一个空文件夹且空间足够
<a id=__codelineno-139-6 name=__codelineno-139-6 href=#__codelineno-139-6></a>
<a id=__codelineno-139-7 name=__codelineno-139-7 href=#__codelineno-139-7></a>external_url: http://hub.gitee.cc
</code></pre></div> <p>执行安装命令</p> <div class=highlight><pre><span></span><code><a id=__codelineno-140-1 name=__codelineno-140-1 href=#__codelineno-140-1></a><span class=c1>## 同时开启 helm chart 仓库支持</span>
<a id=__codelineno-140-2 name=__codelineno-140-2 href=#__codelineno-140-2></a>$<span class=w> </span>sudo<span class=w> </span>./install.sh<span class=w> </span>--with-chartmuseum
</code></pre></div> <p>完成</p> <p>成功启动后，即可通过配置的地址或域名访问。</p> <p>如果配置不是HTTPS协议，所有的Kubernetes节点的Docker（如果是containerd作为Runtime，可以参考下文配置insecure-registry）都需要添 加insecure-registries配置：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-141-1 name=__codelineno-141-1 href=#__codelineno-141-1></a>$<span class=w> </span>cat<span class=w> </span>&gt;/etc/docker/daemon.json<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-141-2 name=__codelineno-141-2 href=#__codelineno-141-2></a><span class=s>{</span>
<a id=__codelineno-141-3 name=__codelineno-141-3 href=#__codelineno-141-3></a><span class=s>  &quot;insecure-registries&quot;: [&quot;http://hub.gitee.cc&quot;],</span>
<a id=__codelineno-141-4 name=__codelineno-141-4 href=#__codelineno-141-4></a><span class=s>  &quot;registry-mirrors&quot;: [&quot;https://25bxwt20.mirror.aliyuncs.com&quot;],</span>
<a id=__codelineno-141-5 name=__codelineno-141-5 href=#__codelineno-141-5></a><span class=s>  &quot;live-restore&quot;: true,</span>
<a id=__codelineno-141-6 name=__codelineno-141-6 href=#__codelineno-141-6></a><span class=s>  &quot;default-shm-size&quot;: &quot;128M&quot;,</span>
<a id=__codelineno-141-7 name=__codelineno-141-7 href=#__codelineno-141-7></a><span class=s>  &quot;max-concurrent-downloads&quot;: 10,</span>
<a id=__codelineno-141-8 name=__codelineno-141-8 href=#__codelineno-141-8></a><span class=s>  &quot;oom-score-adjust&quot;: -1000,</span>
<a id=__codelineno-141-9 name=__codelineno-141-9 href=#__codelineno-141-9></a><span class=s>  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span>
<a id=__codelineno-141-10 name=__codelineno-141-10 href=#__codelineno-141-10></a><span class=s>  &quot;hosts&quot;: [&quot;tcp://0.0.0.0:2375&quot;, &quot;unix:///var/run/docker.sock&quot;],</span>
<a id=__codelineno-141-11 name=__codelineno-141-11 href=#__codelineno-141-11></a><span class=s>  &quot;log-driver&quot;: &quot;json-file&quot;,</span>
<a id=__codelineno-141-12 name=__codelineno-141-12 href=#__codelineno-141-12></a><span class=s>  &quot;log-opts&quot;: {</span>
<a id=__codelineno-141-13 name=__codelineno-141-13 href=#__codelineno-141-13></a><span class=s>    &quot;max-size&quot;: &quot;100m&quot;,</span>
<a id=__codelineno-141-14 name=__codelineno-141-14 href=#__codelineno-141-14></a><span class=s>    &quot;max-file&quot;:&quot;3&quot;</span>
<a id=__codelineno-141-15 name=__codelineno-141-15 href=#__codelineno-141-15></a><span class=s>  }</span>
<a id=__codelineno-141-16 name=__codelineno-141-16 href=#__codelineno-141-16></a><span class=s>}</span>
<a id=__codelineno-141-17 name=__codelineno-141-17 href=#__codelineno-141-17></a><span class=s>EOF</span>
<a id=__codelineno-141-18 name=__codelineno-141-18 href=#__codelineno-141-18></a>
<a id=__codelineno-141-19 name=__codelineno-141-19 href=#__codelineno-141-19></a>$<span class=w> </span>systemctl<span class=w> </span>daemon-reload
<a id=__codelineno-141-20 name=__codelineno-141-20 href=#__codelineno-141-20></a>$<span class=w> </span>systemctl<span class=w> </span>restart<span class=w> </span>docker
</code></pre></div> <div class="admonition info"> <p class=admonition-title>部署完成后如果需要修改harbor.yml ，需要在修改后重新初始化配置，流程如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-142-1 name=__codelineno-142-1 href=#__codelineno-142-1></a>docker-compose<span class=w> </span>down<span class=w> </span>-v
<a id=__codelineno-142-2 name=__codelineno-142-2 href=#__codelineno-142-2></a>vim<span class=w> </span>harbor.yml
<a id=__codelineno-142-3 name=__codelineno-142-3 href=#__codelineno-142-3></a>sudo<span class=w> </span>./prepare<span class=w> </span>--with-chartmuseum
<a id=__codelineno-142-4 name=__codelineno-142-4 href=#__codelineno-142-4></a>docker-compose<span class=w> </span>up<span class=w> </span>-d
</code></pre></div> </div> <p>创建external nginx 配置文件</p> <div class="admonition warning"> <p class=admonition-title>根据实际环境配置</p> </div> <div class=highlight><pre><span></span><code><a id=__codelineno-143-1 name=__codelineno-143-1 href=#__codelineno-143-1></a>upstream harbor {
<a id=__codelineno-143-2 name=__codelineno-143-2 href=#__codelineno-143-2></a>    server 192.168.1.188:8080;
<a id=__codelineno-143-3 name=__codelineno-143-3 href=#__codelineno-143-3></a>    keepalive 32;
<a id=__codelineno-143-4 name=__codelineno-143-4 href=#__codelineno-143-4></a>}
<a id=__codelineno-143-5 name=__codelineno-143-5 href=#__codelineno-143-5></a>
<a id=__codelineno-143-6 name=__codelineno-143-6 href=#__codelineno-143-6></a>server {
<a id=__codelineno-143-7 name=__codelineno-143-7 href=#__codelineno-143-7></a>    listen 80;
<a id=__codelineno-143-8 name=__codelineno-143-8 href=#__codelineno-143-8></a>    server_name hub.gitee.com;
<a id=__codelineno-143-9 name=__codelineno-143-9 href=#__codelineno-143-9></a>    access_log /var/log/nginx/hub_302_access.log main;
<a id=__codelineno-143-10 name=__codelineno-143-10 href=#__codelineno-143-10></a>    error_log /var/log/nginx/hub_302_error.log;
<a id=__codelineno-143-11 name=__codelineno-143-11 href=#__codelineno-143-11></a>    return 302 https://$server_name$request_uri;
<a id=__codelineno-143-12 name=__codelineno-143-12 href=#__codelineno-143-12></a>}
<a id=__codelineno-143-13 name=__codelineno-143-13 href=#__codelineno-143-13></a>
<a id=__codelineno-143-14 name=__codelineno-143-14 href=#__codelineno-143-14></a>server {
<a id=__codelineno-143-15 name=__codelineno-143-15 href=#__codelineno-143-15></a>    include ssl.d/ssl.conf;
<a id=__codelineno-143-16 name=__codelineno-143-16 href=#__codelineno-143-16></a>    server_name hub.gitee.com;
<a id=__codelineno-143-17 name=__codelineno-143-17 href=#__codelineno-143-17></a>    access_log /var/log/nginx/hub_access.log main;
<a id=__codelineno-143-18 name=__codelineno-143-18 href=#__codelineno-143-18></a>    error_log /var/log/nginx/hub_error.log;
<a id=__codelineno-143-19 name=__codelineno-143-19 href=#__codelineno-143-19></a>
<a id=__codelineno-143-20 name=__codelineno-143-20 href=#__codelineno-143-20></a>    location / {
<a id=__codelineno-143-21 name=__codelineno-143-21 href=#__codelineno-143-21></a>        proxy_set_header Connection &quot;&quot;;
<a id=__codelineno-143-22 name=__codelineno-143-22 href=#__codelineno-143-22></a>        proxy_set_header Host $http_host;
<a id=__codelineno-143-23 name=__codelineno-143-23 href=#__codelineno-143-23></a>        proxy_set_header X-Real-IP $remote_addr;
<a id=__codelineno-143-24 name=__codelineno-143-24 href=#__codelineno-143-24></a>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
<a id=__codelineno-143-25 name=__codelineno-143-25 href=#__codelineno-143-25></a>        proxy_set_header X-Forwarded-Proto $scheme;
<a id=__codelineno-143-26 name=__codelineno-143-26 href=#__codelineno-143-26></a>        proxy_set_header X-Frame-Options SAMEORIGIN;
<a id=__codelineno-143-27 name=__codelineno-143-27 href=#__codelineno-143-27></a>        proxy_buffers 256 16k;
<a id=__codelineno-143-28 name=__codelineno-143-28 href=#__codelineno-143-28></a>        proxy_buffer_size 16k;
<a id=__codelineno-143-29 name=__codelineno-143-29 href=#__codelineno-143-29></a>        proxy_read_timeout 600s;
<a id=__codelineno-143-30 name=__codelineno-143-30 href=#__codelineno-143-30></a>        proxy_cache_revalidate on;
<a id=__codelineno-143-31 name=__codelineno-143-31 href=#__codelineno-143-31></a>        proxy_cache_min_uses 2;
<a id=__codelineno-143-32 name=__codelineno-143-32 href=#__codelineno-143-32></a>        proxy_cache_use_stale timeout;
<a id=__codelineno-143-33 name=__codelineno-143-33 href=#__codelineno-143-33></a>        proxy_cache_lock on;
<a id=__codelineno-143-34 name=__codelineno-143-34 href=#__codelineno-143-34></a>        proxy_http_version 1.1;
<a id=__codelineno-143-35 name=__codelineno-143-35 href=#__codelineno-143-35></a>        proxy_pass http://harbor;
<a id=__codelineno-143-36 name=__codelineno-143-36 href=#__codelineno-143-36></a>    }
<a id=__codelineno-143-37 name=__codelineno-143-37 href=#__codelineno-143-37></a>
<a id=__codelineno-143-38 name=__codelineno-143-38 href=#__codelineno-143-38></a>    error_page 500 502 503 504 /50x.html;
<a id=__codelineno-143-39 name=__codelineno-143-39 href=#__codelineno-143-39></a>    location = /50x.html {
<a id=__codelineno-143-40 name=__codelineno-143-40 href=#__codelineno-143-40></a>        root /usr/share/nginx/html;
<a id=__codelineno-143-41 name=__codelineno-143-41 href=#__codelineno-143-41></a>    }
<a id=__codelineno-143-42 name=__codelineno-143-42 href=#__codelineno-143-42></a>}
</code></pre></div> <p>登录测试：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-144-1 name=__codelineno-144-1 href=#__codelineno-144-1></a>$<span class=w> </span>docker<span class=w> </span>login<span class=w> </span>http://hub.gitee.cc
<a id=__codelineno-144-2 name=__codelineno-144-2 href=#__codelineno-144-2></a>Username:<span class=w> </span>admin
<a id=__codelineno-144-3 name=__codelineno-144-3 href=#__codelineno-144-3></a>Password:
<a id=__codelineno-144-4 name=__codelineno-144-4 href=#__codelineno-144-4></a>WARNING!<span class=w> </span>Your<span class=w> </span>password<span class=w> </span>will<span class=w> </span>be<span class=w> </span>stored<span class=w> </span>unencrypted<span class=w> </span><span class=k>in</span><span class=w> </span>/root/.docker/config.json.
<a id=__codelineno-144-5 name=__codelineno-144-5 href=#__codelineno-144-5></a>Configure<span class=w> </span>a<span class=w> </span>credential<span class=w> </span>helper<span class=w> </span>to<span class=w> </span>remove<span class=w> </span>this<span class=w> </span>warning.<span class=w> </span>See
<a id=__codelineno-144-6 name=__codelineno-144-6 href=#__codelineno-144-6></a>https://docs.docker.com/engine/reference/commandline/login/#credentials-store
<a id=__codelineno-144-7 name=__codelineno-144-7 href=#__codelineno-144-7></a>
<a id=__codelineno-144-8 name=__codelineno-144-8 href=#__codelineno-144-8></a>Login<span class=w> </span>Succeeded
</code></pre></div> <p>接下来在Harbor上创建一个Project，如下图所示。创建一个名为kubernetes的Project</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-25.png></p> <p>之后在服务器上找任意一个镜像，修改tag为Harbor的地址，并进行push测试：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-145-1 name=__codelineno-145-1 href=#__codelineno-145-1></a>$<span class=w> </span>docker<span class=w> </span>tag<span class=w> </span>kubeoperator/webkubectl:latest<span class=w> </span>hub.gitee.cc/kubernetes/webkubectl:latest
<a id=__codelineno-145-2 name=__codelineno-145-2 href=#__codelineno-145-2></a>$<span class=w> </span>docker<span class=w> </span>push<span class=w> </span>hub.gitee.cc/kubernetes/webkubectl:latest
<a id=__codelineno-145-3 name=__codelineno-145-3 href=#__codelineno-145-3></a>The<span class=w> </span>push<span class=w> </span>refers<span class=w> </span>to<span class=w> </span>repository<span class=w> </span><span class=o>[</span>hub.gitee.cc/kubernetes/webkubectl<span class=o>]</span>
<a id=__codelineno-145-4 name=__codelineno-145-4 href=#__codelineno-145-4></a>99b13cfbfb0f:<span class=w> </span>Pushed
<a id=__codelineno-145-5 name=__codelineno-145-5 href=#__codelineno-145-5></a>0e658bc0176b:<span class=w> </span>Pushed
<a id=__codelineno-145-6 name=__codelineno-145-6 href=#__codelineno-145-6></a>9eba8e5bc7c8:<span class=w> </span>Pushed
<a id=__codelineno-145-7 name=__codelineno-145-7 href=#__codelineno-145-7></a>adc0cdf505f7:<span class=w> </span>Pushed
<a id=__codelineno-145-8 name=__codelineno-145-8 href=#__codelineno-145-8></a>ad4e41a7f1d3:<span class=w> </span>Pushed
<a id=__codelineno-145-9 name=__codelineno-145-9 href=#__codelineno-145-9></a>7ba699eb6203:<span class=w> </span>Pushed
<a id=__codelineno-145-10 name=__codelineno-145-10 href=#__codelineno-145-10></a>b4c5273b6d27:<span class=w> </span>Pushed
<a id=__codelineno-145-11 name=__codelineno-145-11 href=#__codelineno-145-11></a>e5e13b0c77cb:<span class=w> </span>Mounted<span class=w> </span>from<span class=w> </span>library/mailcat
<a id=__codelineno-145-12 name=__codelineno-145-12 href=#__codelineno-145-12></a>latest:<span class=w> </span>digest:<span class=w> </span>sha256:51cacad0e26ebacc59de84ba71fb50e161ff3e1b8337e39d448c91d6cd048062<span class=w> </span>size:<span class=w> </span><span class=m>1990</span>
</code></pre></div> <p>之后就可以在Harbor查看该镜像，如图</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-26.png></p> <p>如果读者的Kubernetes集群采用的是Containerd作为Runtime，配置insecure-registry只需要在Containerd配置文件的mirrors下添加自己的镜像仓库地址即可。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-146-1 name=__codelineno-146-1 href=#__codelineno-146-1></a><span class=c1>## Containerd配置insecure仓库</span>
<a id=__codelineno-146-2 name=__codelineno-146-2 href=#__codelineno-146-2></a>$<span class=w> </span>vim<span class=w> </span>/etc/containerd/config.toml
<a id=__codelineno-146-3 name=__codelineno-146-3 href=#__codelineno-146-3></a><span class=w>   </span><span class=o>[</span>plugins.<span class=s2>&quot;io.containerd.grpc.v1.cri&quot;</span>.registry<span class=o>]</span>
<a id=__codelineno-146-4 name=__codelineno-146-4 href=#__codelineno-146-4></a><span class=w>      </span><span class=nv>config_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&quot;</span>
<a id=__codelineno-146-5 name=__codelineno-146-5 href=#__codelineno-146-5></a>
<a id=__codelineno-146-6 name=__codelineno-146-6 href=#__codelineno-146-6></a><span class=w>      </span><span class=o>[</span>plugins.<span class=s2>&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.auths<span class=o>]</span>
<a id=__codelineno-146-7 name=__codelineno-146-7 href=#__codelineno-146-7></a>
<a id=__codelineno-146-8 name=__codelineno-146-8 href=#__codelineno-146-8></a><span class=w>      </span><span class=o>[</span>plugins.<span class=s2>&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs<span class=o>]</span>
<a id=__codelineno-146-9 name=__codelineno-146-9 href=#__codelineno-146-9></a><span class=w>        </span><span class=o>[</span>plugins.<span class=s2>&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs.<span class=s2>&quot;hub.gitee.cc&quot;</span>.tls<span class=o>]</span>
<a id=__codelineno-146-10 name=__codelineno-146-10 href=#__codelineno-146-10></a><span class=w>          </span><span class=nv>insecure_skip_verify</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span>
<a id=__codelineno-146-11 name=__codelineno-146-11 href=#__codelineno-146-11></a><span class=w>        </span><span class=o>[</span>plugins.<span class=s2>&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs.<span class=s2>&quot;hub.gitee.cc&quot;</span>.auth<span class=o>]</span>
<a id=__codelineno-146-12 name=__codelineno-146-12 href=#__codelineno-146-12></a>
<a id=__codelineno-146-13 name=__codelineno-146-13 href=#__codelineno-146-13></a><span class=w>      </span><span class=o>[</span>plugins.<span class=s2>&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.headers<span class=o>]</span>
<a id=__codelineno-146-14 name=__codelineno-146-14 href=#__codelineno-146-14></a>
<a id=__codelineno-146-15 name=__codelineno-146-15 href=#__codelineno-146-15></a><span class=w>      </span><span class=o>[</span>plugins.<span class=s2>&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors<span class=o>]</span>
<a id=__codelineno-146-16 name=__codelineno-146-16 href=#__codelineno-146-16></a><span class=w>        </span><span class=o>[</span>plugins.<span class=s2>&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class=s2>&quot;docker.io&quot;</span><span class=o>]</span>
<a id=__codelineno-146-17 name=__codelineno-146-17 href=#__codelineno-146-17></a><span class=w>          </span><span class=nv>endpoint</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>[</span><span class=s2>&quot;https://pooj3a7i.mirror.aliyuncs.com&quot;</span><span class=o>]</span>
<a id=__codelineno-146-18 name=__codelineno-146-18 href=#__codelineno-146-18></a><span class=w>        </span><span class=o>[</span>plugins.<span class=s2>&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class=s2>&quot;hub.gitee.cc&quot;</span><span class=o>]</span>
<a id=__codelineno-146-19 name=__codelineno-146-19 href=#__codelineno-146-19></a><span class=w>          </span><span class=nv>endpoint</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>[</span><span class=s2>&quot;http://hub.gitee.cc&quot;</span><span class=o>]</span>
<a id=__codelineno-146-20 name=__codelineno-146-20 href=#__codelineno-146-20></a>.....
</code></pre></div> <p>配置完成后，重启Containerd，之后进行pull测试：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-147-1 name=__codelineno-147-1 href=#__codelineno-147-1></a>$<span class=w> </span>systemctl<span class=w> </span>restart<span class=w> </span>containerd
<a id=__codelineno-147-2 name=__codelineno-147-2 href=#__codelineno-147-2></a>$<span class=w> </span>ctr<span class=w> </span>-n<span class=w> </span>k8s.io<span class=w> </span>image<span class=w> </span>pull<span class=w> </span>hub.gitee.cc/kubernetes/webkubectl:latest<span class=w> </span>--plain-http<span class=w> </span>--user<span class=w> </span>admin:oschina123<span class=w> </span>
</code></pre></div> <p>至此，用到的工具都已经安装完成。接下来需要进行一些配置。</p> <div class="admonition example"> <p class=admonition-title>参考文献</p> <p><a href=https://www.cnblogs.com/zhangmingcheng/p/14167615.html>Harbor配合Nginx配置公网域名</a></p> </div> <h5 id=2-helm方式部署>2. helm方式部署<a class=headerlink href=#2-helm方式部署 title="Permanent link">&para;</a></h5> <blockquote> <p>前提条件：NFS 类型的 StorageClass 来做持久化存储, StorageClass 名称<code>gitee-nfs-client</code></p> </blockquote> <p>Chart 仓库地址：<a href=https://helm.goharbor.io>https://helm.goharbor.io</a></p> <p>由于 Harbor 涉及的组件太多了，所以我们这里用更加便捷的 Helm 来进行安装。首先添加 Chart 仓库地址：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-148-1 name=__codelineno-148-1 href=#__codelineno-148-1></a><span class=c1># 添加 Chart 仓库</span>
<a id=__codelineno-148-2 name=__codelineno-148-2 href=#__codelineno-148-2></a>$<span class=w> </span>helm<span class=w> </span>repo<span class=w> </span>add<span class=w> </span>harbor<span class=w> </span>https://helm.goharbor.io
<a id=__codelineno-148-3 name=__codelineno-148-3 href=#__codelineno-148-3></a>
<a id=__codelineno-148-4 name=__codelineno-148-4 href=#__codelineno-148-4></a><span class=c1># 更新</span>
<a id=__codelineno-148-5 name=__codelineno-148-5 href=#__codelineno-148-5></a>$<span class=w> </span>helm<span class=w> </span>repo<span class=w> </span>update
</code></pre></div> <p>我们使用定制的 values 文件来进行安装了，完整定制的 values 文件如下所示：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-149-1 name=__codelineno-149-1 href=#__codelineno-149-1></a><span class=c1># 拉取1.10.1版本并解压</span>
<a id=__codelineno-149-2 name=__codelineno-149-2 href=#__codelineno-149-2></a>$<span class=w> </span>helm<span class=w> </span>pull<span class=w> </span>harbor/harbor<span class=w> </span>--version<span class=w> </span><span class=m>1</span>.10.1
<a id=__codelineno-149-3 name=__codelineno-149-3 href=#__codelineno-149-3></a>$<span class=w> </span>helm<span class=w> </span>pull<span class=w> </span>harbor/harbor<span class=w> </span>--untar<span class=w> </span>--version<span class=w> </span><span class=m>1</span>.10.1
<a id=__codelineno-149-4 name=__codelineno-149-4 href=#__codelineno-149-4></a>
<a id=__codelineno-149-5 name=__codelineno-149-5 href=#__codelineno-149-5></a>$<span class=w> </span>cat<span class=w> </span>&gt;<span class=w> </span>values-prod.yaml<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39;</span>
<a id=__codelineno-149-6 name=__codelineno-149-6 href=#__codelineno-149-6></a><span class=s># 外网访问IP</span>
<a id=__codelineno-149-7 name=__codelineno-149-7 href=#__codelineno-149-7></a><span class=s>externalURL: http://106.12.45.72:30002</span>
<a id=__codelineno-149-8 name=__codelineno-149-8 href=#__codelineno-149-8></a><span class=s>harborAdminPassword: Harbor12345</span>
<a id=__codelineno-149-9 name=__codelineno-149-9 href=#__codelineno-149-9></a><span class=s>logLevel: debug</span>
<a id=__codelineno-149-10 name=__codelineno-149-10 href=#__codelineno-149-10></a>
<a id=__codelineno-149-11 name=__codelineno-149-11 href=#__codelineno-149-11></a><span class=s>expose:</span>
<a id=__codelineno-149-12 name=__codelineno-149-12 href=#__codelineno-149-12></a><span class=s>  type: nodePort</span>
<a id=__codelineno-149-13 name=__codelineno-149-13 href=#__codelineno-149-13></a><span class=s>  tls:</span>
<a id=__codelineno-149-14 name=__codelineno-149-14 href=#__codelineno-149-14></a><span class=s>    enabled: false</span>
<a id=__codelineno-149-15 name=__codelineno-149-15 href=#__codelineno-149-15></a><span class=s>  nodePort:</span>
<a id=__codelineno-149-16 name=__codelineno-149-16 href=#__codelineno-149-16></a><span class=s>    name: harbor</span>
<a id=__codelineno-149-17 name=__codelineno-149-17 href=#__codelineno-149-17></a><span class=s>    ports:</span>
<a id=__codelineno-149-18 name=__codelineno-149-18 href=#__codelineno-149-18></a><span class=s>      http:</span>
<a id=__codelineno-149-19 name=__codelineno-149-19 href=#__codelineno-149-19></a><span class=s>        port: 80</span>
<a id=__codelineno-149-20 name=__codelineno-149-20 href=#__codelineno-149-20></a><span class=s>        nodePort: 30002</span>
<a id=__codelineno-149-21 name=__codelineno-149-21 href=#__codelineno-149-21></a><span class=s>      https:</span>
<a id=__codelineno-149-22 name=__codelineno-149-22 href=#__codelineno-149-22></a><span class=s>        port: 443</span>
<a id=__codelineno-149-23 name=__codelineno-149-23 href=#__codelineno-149-23></a><span class=s>        nodePort: 30003</span>
<a id=__codelineno-149-24 name=__codelineno-149-24 href=#__codelineno-149-24></a><span class=s>      notary:</span>
<a id=__codelineno-149-25 name=__codelineno-149-25 href=#__codelineno-149-25></a><span class=s>        port: 4443</span>
<a id=__codelineno-149-26 name=__codelineno-149-26 href=#__codelineno-149-26></a><span class=s>        nodePort: 30004</span>
<a id=__codelineno-149-27 name=__codelineno-149-27 href=#__codelineno-149-27></a><span class=s>persistence:</span>
<a id=__codelineno-149-28 name=__codelineno-149-28 href=#__codelineno-149-28></a><span class=s>  enabled: true</span>
<a id=__codelineno-149-29 name=__codelineno-149-29 href=#__codelineno-149-29></a><span class=s>  resourcePolicy: &quot;keep&quot;</span>
<a id=__codelineno-149-30 name=__codelineno-149-30 href=#__codelineno-149-30></a><span class=s>  persistentVolumeClaim:</span>
<a id=__codelineno-149-31 name=__codelineno-149-31 href=#__codelineno-149-31></a><span class=s>    registry:</span>
<a id=__codelineno-149-32 name=__codelineno-149-32 href=#__codelineno-149-32></a><span class=s>      storageClass: &quot;gitee-nfs-client&quot;</span>
<a id=__codelineno-149-33 name=__codelineno-149-33 href=#__codelineno-149-33></a><span class=s>      # 如果是高可用的，多个副本组件需要使用 ReadWriteMany，默认为 ReadWriteOnce</span>
<a id=__codelineno-149-34 name=__codelineno-149-34 href=#__codelineno-149-34></a><span class=s>      accessMode: ReadWriteMany</span>
<a id=__codelineno-149-35 name=__codelineno-149-35 href=#__codelineno-149-35></a><span class=s>      size: 500Gi</span>
<a id=__codelineno-149-36 name=__codelineno-149-36 href=#__codelineno-149-36></a><span class=s>    chartmuseum:</span>
<a id=__codelineno-149-37 name=__codelineno-149-37 href=#__codelineno-149-37></a><span class=s>      storageClass: &quot;gitee-nfs-client&quot;</span>
<a id=__codelineno-149-38 name=__codelineno-149-38 href=#__codelineno-149-38></a><span class=s>      accessMode: ReadWriteMany</span>
<a id=__codelineno-149-39 name=__codelineno-149-39 href=#__codelineno-149-39></a><span class=s>      size: 20Gi</span>
<a id=__codelineno-149-40 name=__codelineno-149-40 href=#__codelineno-149-40></a><span class=s>    jobservice:</span>
<a id=__codelineno-149-41 name=__codelineno-149-41 href=#__codelineno-149-41></a><span class=s>      storageClass: &quot;gitee-nfs-client&quot;</span>
<a id=__codelineno-149-42 name=__codelineno-149-42 href=#__codelineno-149-42></a><span class=s>      accessMode: ReadWriteMany</span>
<a id=__codelineno-149-43 name=__codelineno-149-43 href=#__codelineno-149-43></a><span class=s>      size: 10Gi</span>
<a id=__codelineno-149-44 name=__codelineno-149-44 href=#__codelineno-149-44></a><span class=s>    database:</span>
<a id=__codelineno-149-45 name=__codelineno-149-45 href=#__codelineno-149-45></a><span class=s>      storageClass: &quot;gitee-nfs-client&quot;</span>
<a id=__codelineno-149-46 name=__codelineno-149-46 href=#__codelineno-149-46></a><span class=s>      accessMode: ReadWriteMany</span>
<a id=__codelineno-149-47 name=__codelineno-149-47 href=#__codelineno-149-47></a><span class=s>      size: 20Gi</span>
<a id=__codelineno-149-48 name=__codelineno-149-48 href=#__codelineno-149-48></a><span class=s>    redis:</span>
<a id=__codelineno-149-49 name=__codelineno-149-49 href=#__codelineno-149-49></a><span class=s>      storageClass: &quot;gitee-nfs-client&quot;</span>
<a id=__codelineno-149-50 name=__codelineno-149-50 href=#__codelineno-149-50></a><span class=s>      accessMode: ReadWriteMany</span>
<a id=__codelineno-149-51 name=__codelineno-149-51 href=#__codelineno-149-51></a><span class=s>      size: 8Gi</span>
<a id=__codelineno-149-52 name=__codelineno-149-52 href=#__codelineno-149-52></a><span class=s>    trivy:</span>
<a id=__codelineno-149-53 name=__codelineno-149-53 href=#__codelineno-149-53></a><span class=s>      storageClass: &quot;gitee-nfs-client&quot;</span>
<a id=__codelineno-149-54 name=__codelineno-149-54 href=#__codelineno-149-54></a><span class=s>      accessMode: ReadWriteMany</span>
<a id=__codelineno-149-55 name=__codelineno-149-55 href=#__codelineno-149-55></a><span class=s>      size: 10Gi</span>
<a id=__codelineno-149-56 name=__codelineno-149-56 href=#__codelineno-149-56></a>
<a id=__codelineno-149-57 name=__codelineno-149-57 href=#__codelineno-149-57></a><span class=s># 使用Harboar内置的PostgreSQL和redis数据库</span>
<a id=__codelineno-149-58 name=__codelineno-149-58 href=#__codelineno-149-58></a><span class=s>database:</span>
<a id=__codelineno-149-59 name=__codelineno-149-59 href=#__codelineno-149-59></a><span class=s>  type: internal</span>
<a id=__codelineno-149-60 name=__codelineno-149-60 href=#__codelineno-149-60></a><span class=s>  internal:</span>
<a id=__codelineno-149-61 name=__codelineno-149-61 href=#__codelineno-149-61></a><span class=s>    serviceAccountName: &quot;&quot;</span>
<a id=__codelineno-149-62 name=__codelineno-149-62 href=#__codelineno-149-62></a><span class=s>    image:</span>
<a id=__codelineno-149-63 name=__codelineno-149-63 href=#__codelineno-149-63></a><span class=s>      repository: goharbor/harbor-db</span>
<a id=__codelineno-149-64 name=__codelineno-149-64 href=#__codelineno-149-64></a><span class=s>      tag: v2.2.2</span>
<a id=__codelineno-149-65 name=__codelineno-149-65 href=#__codelineno-149-65></a><span class=s>    password: &quot;oschina123&quot;</span>
<a id=__codelineno-149-66 name=__codelineno-149-66 href=#__codelineno-149-66></a>
<a id=__codelineno-149-67 name=__codelineno-149-67 href=#__codelineno-149-67></a><span class=s>redis:</span>
<a id=__codelineno-149-68 name=__codelineno-149-68 href=#__codelineno-149-68></a><span class=s>  type: internal</span>
<a id=__codelineno-149-69 name=__codelineno-149-69 href=#__codelineno-149-69></a><span class=s>  internal:</span>
<a id=__codelineno-149-70 name=__codelineno-149-70 href=#__codelineno-149-70></a><span class=s>    serviceAccountName: &quot;&quot;</span>
<a id=__codelineno-149-71 name=__codelineno-149-71 href=#__codelineno-149-71></a><span class=s>    image:</span>
<a id=__codelineno-149-72 name=__codelineno-149-72 href=#__codelineno-149-72></a><span class=s>      repository: goharbor/redis-photon</span>
<a id=__codelineno-149-73 name=__codelineno-149-73 href=#__codelineno-149-73></a><span class=s>      tag: v2.2.2</span>
<a id=__codelineno-149-74 name=__codelineno-149-74 href=#__codelineno-149-74></a>
<a id=__codelineno-149-75 name=__codelineno-149-75 href=#__codelineno-149-75></a><span class=s>portal:</span>
<a id=__codelineno-149-76 name=__codelineno-149-76 href=#__codelineno-149-76></a><span class=s>  replicas: 2</span>
<a id=__codelineno-149-77 name=__codelineno-149-77 href=#__codelineno-149-77></a><span class=s>core:</span>
<a id=__codelineno-149-78 name=__codelineno-149-78 href=#__codelineno-149-78></a><span class=s>  replicas: 2</span>
<a id=__codelineno-149-79 name=__codelineno-149-79 href=#__codelineno-149-79></a><span class=s>jobservice:</span>
<a id=__codelineno-149-80 name=__codelineno-149-80 href=#__codelineno-149-80></a><span class=s>  replicas: 2</span>
<a id=__codelineno-149-81 name=__codelineno-149-81 href=#__codelineno-149-81></a><span class=s>registry:</span>
<a id=__codelineno-149-82 name=__codelineno-149-82 href=#__codelineno-149-82></a><span class=s>  replicas: 2</span>
<a id=__codelineno-149-83 name=__codelineno-149-83 href=#__codelineno-149-83></a><span class=s>chartmuseum:</span>
<a id=__codelineno-149-84 name=__codelineno-149-84 href=#__codelineno-149-84></a><span class=s>  replicas: 2</span>
<a id=__codelineno-149-85 name=__codelineno-149-85 href=#__codelineno-149-85></a><span class=s>clair:</span>
<a id=__codelineno-149-86 name=__codelineno-149-86 href=#__codelineno-149-86></a><span class=s>  replicas: </span>
<a id=__codelineno-149-87 name=__codelineno-149-87 href=#__codelineno-149-87></a><span class=s>notary:</span>
<a id=__codelineno-149-88 name=__codelineno-149-88 href=#__codelineno-149-88></a><span class=s>  server:</span>
<a id=__codelineno-149-89 name=__codelineno-149-89 href=#__codelineno-149-89></a><span class=s>    replicas: 2</span>
<a id=__codelineno-149-90 name=__codelineno-149-90 href=#__codelineno-149-90></a><span class=s>  signer:</span>
<a id=__codelineno-149-91 name=__codelineno-149-91 href=#__codelineno-149-91></a><span class=s>    replicas: 2</span>
<a id=__codelineno-149-92 name=__codelineno-149-92 href=#__codelineno-149-92></a><span class=s>EOF</span>
<a id=__codelineno-149-93 name=__codelineno-149-93 href=#__codelineno-149-93></a>
<a id=__codelineno-149-94 name=__codelineno-149-94 href=#__codelineno-149-94></a>$<span class=w> </span>helm<span class=w> </span>install<span class=w> </span>-f<span class=w> </span>values-prod.yaml<span class=w> </span>harbor<span class=w> </span>harbor<span class=w> </span>--namespace<span class=w> </span>pub-comm<span class=w> </span>--create-namespace
</code></pre></div> <p>正常情况下隔一会儿就可以安装成功了：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-150-1 name=__codelineno-150-1 href=#__codelineno-150-1></a>$<span class=w> </span>helm<span class=w> </span>ls<span class=w> </span>-n<span class=w> </span>pub-comm
<a id=__codelineno-150-2 name=__codelineno-150-2 href=#__codelineno-150-2></a>NAME<span class=w>            </span>NAMESPACE<span class=w>       </span>REVISION<span class=w>        </span>UPDATED<span class=w>                                 </span>STATUS<span class=w>          </span>CHART<span class=w>                   </span>APP<span class=w> </span>VERSION
<a id=__codelineno-150-3 name=__codelineno-150-3 href=#__codelineno-150-3></a>harbor<span class=w>          </span>pub-comm<span class=w>        </span><span class=m>1</span><span class=w>               </span><span class=m>2022</span>-10-19<span class=w> </span><span class=m>09</span>:41:55.531221406<span class=w> </span>+0800<span class=w> </span>CST<span class=w> </span>deployed<span class=w>        </span>harbor-1.6.2<span class=w>            </span><span class=m>2</span>.2.2
<a id=__codelineno-150-4 name=__codelineno-150-4 href=#__codelineno-150-4></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>pub-comm<span class=w> </span>-l<span class=w> </span><span class=nv>app</span><span class=o>=</span>harbor
<a id=__codelineno-150-5 name=__codelineno-150-5 href=#__codelineno-150-5></a>harbor-harbor-chartmuseum-5d5dc4c5fc-75qx2<span class=w>     </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>3m24s
<a id=__codelineno-150-6 name=__codelineno-150-6 href=#__codelineno-150-6></a>harbor-harbor-chartmuseum-5d5dc4c5fc-xsngf<span class=w>     </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>3m24s
<a id=__codelineno-150-7 name=__codelineno-150-7 href=#__codelineno-150-7></a>harbor-harbor-core-5559c6b95d-wqcgb<span class=w>            </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>2</span><span class=w>          </span>3m24s
<a id=__codelineno-150-8 name=__codelineno-150-8 href=#__codelineno-150-8></a>harbor-harbor-core-5559c6b95d-xlxpd<span class=w>            </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>2</span><span class=w>          </span>3m24s
<a id=__codelineno-150-9 name=__codelineno-150-9 href=#__codelineno-150-9></a>harbor-harbor-database-0<span class=w>                       </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>3m24s
<a id=__codelineno-150-10 name=__codelineno-150-10 href=#__codelineno-150-10></a>harbor-harbor-jobservice-7599dc87cd-95z8v<span class=w>      </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>2</span><span class=w>          </span>3m24s
<a id=__codelineno-150-11 name=__codelineno-150-11 href=#__codelineno-150-11></a>harbor-harbor-jobservice-7599dc87cd-np8jr<span class=w>      </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>3m24s
<a id=__codelineno-150-12 name=__codelineno-150-12 href=#__codelineno-150-12></a>harbor-harbor-nginx-9bc874c4c-xfgrc<span class=w>            </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>3m24s
<a id=__codelineno-150-13 name=__codelineno-150-13 href=#__codelineno-150-13></a>harbor-harbor-notary-server-7788bcd6c4-wbgdn<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>3</span><span class=w>          </span>3m24s
<a id=__codelineno-150-14 name=__codelineno-150-14 href=#__codelineno-150-14></a>harbor-harbor-notary-server-7788bcd6c4-z2hxq<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>3</span><span class=w>          </span>3m24s
<a id=__codelineno-150-15 name=__codelineno-150-15 href=#__codelineno-150-15></a>harbor-harbor-notary-signer-58894fb464-59k6z<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>3</span><span class=w>          </span>3m24s
<a id=__codelineno-150-16 name=__codelineno-150-16 href=#__codelineno-150-16></a>harbor-harbor-notary-signer-58894fb464-vr6t6<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>3m24s
<a id=__codelineno-150-17 name=__codelineno-150-17 href=#__codelineno-150-17></a>harbor-harbor-portal-559c4d4bfd-kmdnx<span class=w>          </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>3m24s
<a id=__codelineno-150-18 name=__codelineno-150-18 href=#__codelineno-150-18></a>harbor-harbor-portal-559c4d4bfd-v8vqx<span class=w>          </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>3m24s
<a id=__codelineno-150-19 name=__codelineno-150-19 href=#__codelineno-150-19></a>harbor-harbor-redis-0<span class=w>                          </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>3m24s
<a id=__codelineno-150-20 name=__codelineno-150-20 href=#__codelineno-150-20></a>harbor-harbor-registry-9b46998cf-kd969<span class=w>         </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>3m24s
<a id=__codelineno-150-21 name=__codelineno-150-21 href=#__codelineno-150-21></a>harbor-harbor-registry-9b46998cf-kmjmq<span class=w>         </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>3m24s
<a id=__codelineno-150-22 name=__codelineno-150-22 href=#__codelineno-150-22></a>harbor-harbor-trivy-0<span class=w>                          </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>3m23s
<a id=__codelineno-150-23 name=__codelineno-150-23 href=#__codelineno-150-23></a>
<a id=__codelineno-150-24 name=__codelineno-150-24 href=#__codelineno-150-24></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>svc<span class=w> </span>-n<span class=w> </span>pub-comm<span class=w> </span>-l<span class=w> </span><span class=nv>app</span><span class=o>=</span>harbor
<a id=__codelineno-150-25 name=__codelineno-150-25 href=#__codelineno-150-25></a>NAME<span class=w>                          </span>TYPE<span class=w>        </span>CLUSTER-IP<span class=w>       </span>EXTERNAL-IP<span class=w>   </span>PORT<span class=o>(</span>S<span class=o>)</span><span class=w>                       </span>AGE
<a id=__codelineno-150-26 name=__codelineno-150-26 href=#__codelineno-150-26></a>harbor<span class=w>                        </span>NodePort<span class=w>    </span><span class=m>172</span>.24.58.77<span class=w>     </span>&lt;none&gt;<span class=w>        </span><span class=m>80</span>:30002/TCP,4443:30004/TCP<span class=w>   </span>5m16s
<a id=__codelineno-150-27 name=__codelineno-150-27 href=#__codelineno-150-27></a>harbor-harbor-chartmuseum<span class=w>     </span>ClusterIP<span class=w>   </span><span class=m>172</span>.24.99.83<span class=w>     </span>&lt;none&gt;<span class=w>        </span><span class=m>80</span>/TCP<span class=w>                        </span>5m16s
<a id=__codelineno-150-28 name=__codelineno-150-28 href=#__codelineno-150-28></a>harbor-harbor-core<span class=w>            </span>ClusterIP<span class=w>   </span><span class=m>172</span>.24.117.61<span class=w>    </span>&lt;none&gt;<span class=w>        </span><span class=m>80</span>/TCP<span class=w>                        </span>5m16s
<a id=__codelineno-150-29 name=__codelineno-150-29 href=#__codelineno-150-29></a>harbor-harbor-database<span class=w>        </span>ClusterIP<span class=w>   </span><span class=m>172</span>.24.252.137<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>5432</span>/TCP<span class=w>                      </span>5m16s
<a id=__codelineno-150-30 name=__codelineno-150-30 href=#__codelineno-150-30></a>harbor-harbor-jobservice<span class=w>      </span>ClusterIP<span class=w>   </span><span class=m>172</span>.24.51.73<span class=w>     </span>&lt;none&gt;<span class=w>        </span><span class=m>80</span>/TCP<span class=w>                        </span>5m16s
<a id=__codelineno-150-31 name=__codelineno-150-31 href=#__codelineno-150-31></a>harbor-harbor-notary-server<span class=w>   </span>ClusterIP<span class=w>   </span><span class=m>172</span>.24.241.2<span class=w>     </span>&lt;none&gt;<span class=w>        </span><span class=m>4443</span>/TCP<span class=w>                      </span>5m16s
<a id=__codelineno-150-32 name=__codelineno-150-32 href=#__codelineno-150-32></a>harbor-harbor-notary-signer<span class=w>   </span>ClusterIP<span class=w>   </span><span class=m>172</span>.24.177.134<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>7899</span>/TCP<span class=w>                      </span>5m16s
<a id=__codelineno-150-33 name=__codelineno-150-33 href=#__codelineno-150-33></a>harbor-harbor-portal<span class=w>          </span>ClusterIP<span class=w>   </span><span class=m>172</span>.24.192.233<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>80</span>/TCP<span class=w>                        </span>5m16s
<a id=__codelineno-150-34 name=__codelineno-150-34 href=#__codelineno-150-34></a>harbor-harbor-redis<span class=w>           </span>ClusterIP<span class=w>   </span><span class=m>172</span>.24.242.178<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>6379</span>/TCP<span class=w>                      </span>5m16s
<a id=__codelineno-150-35 name=__codelineno-150-35 href=#__codelineno-150-35></a>harbor-harbor-registry<span class=w>        </span>ClusterIP<span class=w>   </span><span class=m>172</span>.24.182.141<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>5000</span>/TCP,8080/TCP<span class=w>             </span>5m16s
<a id=__codelineno-150-36 name=__codelineno-150-36 href=#__codelineno-150-36></a>harbor-harbor-trivy<span class=w>           </span>ClusterIP<span class=w>   </span><span class=m>172</span>.24.251.45<span class=w>    </span>&lt;none&gt;<span class=w>        </span><span class=m>8080</span>/TCP<span class=w>                      </span>5m16s
</code></pre></div> <p>如上状态所示表示harbor部署完成，访问使用externalURL: <a href=http://106.12.45.72:30002进行访问>http://106.12.45.72:30002进行访问</a>，用户名使用默认的 admin，密码则是上面配置的默认 <code>Harbor12345</code>。</p> <div class="admonition example"> <p class=admonition-title>参考文献</p> <blockquote> <p><a href=https://clay-wangzhi.com/cloudnative/kubernetes/harbor.html>Harbor 安装配置(k8s)</a></p> <p><a href=https://blog.51cto.com/zhaochengsheng/5969396>Kubernetes部署Harbor</a></p> </blockquote> </div> <h3 id=54-jenkins凭证credentials>5.4 Jenkins凭证Credentials<a class=headerlink href=#54-jenkins凭证credentials title="Permanent link">&para;</a></h3> <p>在使用Jenkins、GitLab、Harbor、Kubernetes打造DevOps平台实现CI/CD时，需要涉及很多证书、账号和密码、公钥和私钥的配置，这些凭证需 要放在一个统一的地方管理，并且能在整个流水线中使用，而Jenkins提供的Credentials插件可以满足以上要求，并且在流水线中也不会泄露相关的加密 信息。</p> <p>所以Harbor的账号和密码、GitLab的私钥、Kubernetes的证书均使用Jenkins的Credentials管理。</p> <h4 id=1-配置kubernetes证书>1. 配置Kubernetes证书<a class=headerlink href=#1-配置kubernetes证书 title="Permanent link">&para;</a></h4> <p>在安装和维护Kubernetes集群时，都是使用kubectl操作集群，而kubectl操作集群需要一个KUBECONFIG文件，我们使用Jenkins控制Kubernetes时，也是使用该文件，所以该文件需要放置在Credentials中，之后可以被Jenkins的Kubernetes插件使用。</p> <p>首先需要找到集群中的KUBECONFIG，一般是kubectl节点的~/.kube/config文件，或者是KUBECONFIG环境变量所指向的文件。</p> <p>接下来只需要把证书文件放置于Jenkins的Credentials中即可。首先单击Manage Jenkins，之后单击Manage Credentials。</p> <p>然后单击Global的下拉选项，之后单击Add Credentials。 在打开添加凭证页面时，需要将凭证类型改为Secret file，如图所示。</p> <ul> <li>File：KUBECONFIG文件或其他加密文件。</li> <li>ID：该凭证的ID。</li> <li>Description：证书的描述。</li> </ul> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-27.png></p> <p>添加Kubernetes的kubeconfig</p> <p>只需要简单的几步， 就可以添加Kubernetes的KUBECONFIG文件至Jenkins，之后就可以使用前面讲过的Jenkins语法引用该凭证。</p> <h4 id=2-配置harbor账号和密码>2. 配置Harbor账号和密码<a class=headerlink href=#2-配置harbor账号和密码 title="Permanent link">&para;</a></h4> <p>对于账号、密码和Key类型的凭证，配置步骤是一致的，只是选择的凭证类型不一样。接下来通过Jenkins凭证管理Harbor的账号和密码。</p> <p>在同样的位置单击Add Credentials</p> <p>选择类型为Username with password，如图</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-28.png></p> <ul> <li>Username：Harbor或者其他平台的用户名。</li> <li>Password：Harbor或者其他平台的密码。</li> <li>ID：该凭证的ID，harbor-user-passwd。</li> <li>Description：证书的描述</li> </ul> <p>之后单击OK按钮保存即可，然后在流水线中即可通过类似environment这样的指令引用该凭证。</p> <h4 id=3-配置gitlab-key>3. 配置GitLab Key<a class=headerlink href=#3-配置gitlab-key title="Permanent link">&para;</a></h4> <p>在搭建GitLab时，将Jenkins服务器的公钥放在GitLab中，之后Jenkins就可以通过自己的私钥登录GitLab，然后下载和上传代码。</p> <p>在流水线的执行过程中，往往第一个过程就是下载代码，所以Jenkins的流水线需要有下载代码的权限。此时可以将Jenkins的私钥保存至Jenkins凭 证中，之后在流水线中引用即可。</p> <p>单击Add Credentials，类型选择为SSH Username with private key，如图</p> <ul> <li>Username：用户名，无强制性。</li> <li>Private Key：Jenkins服务器的私钥，一般位于~/.ssh/id_rsa</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-151-1 name=__codelineno-151-1 href=#__codelineno-151-1></a><span class=c1># tree -a</span>
<a id=__codelineno-151-2 name=__codelineno-151-2 href=#__codelineno-151-2></a>.
<a id=__codelineno-151-3 name=__codelineno-151-3 href=#__codelineno-151-3></a>├──<span class=w> </span>bin
<a id=__codelineno-151-4 name=__codelineno-151-4 href=#__codelineno-151-4></a><span class=w>    </span>├──<span class=w> </span>docker<span class=w> </span>
<a id=__codelineno-151-5 name=__codelineno-151-5 href=#__codelineno-151-5></a><span class=w>    </span>├──<span class=w> </span>helm
<a id=__codelineno-151-6 name=__codelineno-151-6 href=#__codelineno-151-6></a><span class=w>    </span>└──<span class=w> </span>kubectl
<a id=__codelineno-151-7 name=__codelineno-151-7 href=#__codelineno-151-7></a>├──<span class=w> </span>config
<a id=__codelineno-151-8 name=__codelineno-151-8 href=#__codelineno-151-8></a><span class=w>    </span>└──<span class=w> </span>config
<a id=__codelineno-151-9 name=__codelineno-151-9 href=#__codelineno-151-9></a>├──<span class=w> </span>Dockerfile
<a id=__codelineno-151-10 name=__codelineno-151-10 href=#__codelineno-151-10></a>└──<span class=w> </span>.ssh
<a id=__codelineno-151-11 name=__codelineno-151-11 href=#__codelineno-151-11></a><span class=w>    </span>├──<span class=w> </span>authorized_keys
<a id=__codelineno-151-12 name=__codelineno-151-12 href=#__codelineno-151-12></a><span class=w>    </span>├──<span class=w> </span>id_rsa
<a id=__codelineno-151-13 name=__codelineno-151-13 href=#__codelineno-151-13></a><span class=w>    </span>├──<span class=w> </span>id_rsa.pub
<a id=__codelineno-151-14 name=__codelineno-151-14 href=#__codelineno-151-14></a><span class=w>    </span>└──<span class=w> </span>known_hosts
<a id=__codelineno-151-15 name=__codelineno-151-15 href=#__codelineno-151-15></a>
<a id=__codelineno-151-16 name=__codelineno-151-16 href=#__codelineno-151-16></a><span class=c1>## 我们已经将Jenkins服务器的私钥放入jenkins-slave容器中</span>
</code></pre></div> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-29.png></p> <h4 id=4-配置gitlab账号密码>4. 配置GitLab账号密码<a class=headerlink href=#4-配置gitlab账号密码 title="Permanent link">&para;</a></h4> <p>由于我们是在一个 Slave Pod 中去进行构建，所以如果使用 SSH 的方式去访问 Gitlab 代码仓库的话就需要频繁的去更新 <code>SSH-KEY</code>，所以我们这里采用直接使用用户名和密码的形式来方式。</p> <p>在 <code>Credentials</code> 区域点击添加按钮添加我们访问 Gitlab 的用户名和密码：</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-30.png></p> <p>通过上述4种类型凭证的配置，就可以对Kubernetes证书、Harbor账号和密码以及GitLab Key或者账号密码进行管理。</p> <p>需要说明的是，除Jenkins的凭证外，其他类型的凭证也可以在Jenkins中管理。</p> <h3 id=55-配置agent>5.5 配置Agent<a class=headerlink href=#55-配置agent title="Permanent link">&para;</a></h3> <p>通常情况下，Jenkins Slave会通过Jenkins Master节点的50000端口与之通信，所以需要开启Agent的50000端口。</p> <p>单击Manage Jenkins，然后单击Configure Global Security，在安全配置下方找到Agents，单击Fixed，输入50000即可，如图：</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-31.png></p> <p>实际使用时，没有必要把整个Kubernetes集群的节点都充当创建Jenkins Slave Pod的节点，可以选择任意一个或多个节点作为创建Slave Pod的节 点。</p> <p>接下来选择一个或多个节点作为Kubernetes创建Jenkins Slave Pod的节点，只需要配置一个标签即可，之后Jenkinsfile的agent会根据标签创建 Slave Pod。假设k8s-node01作为Slave节点：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-152-1 name=__codelineno-152-1 href=#__codelineno-152-1></a><span class=c1># kubectl label node k8s-node01 build=true</span>
<a id=__codelineno-152-2 name=__codelineno-152-2 href=#__codelineno-152-2></a>
<a id=__codelineno-152-3 name=__codelineno-152-3 href=#__codelineno-152-3></a><span class=c1># kubectl get nodes k8s-node01 --show-labels</span>
<a id=__codelineno-152-4 name=__codelineno-152-4 href=#__codelineno-152-4></a>NAME<span class=w>         </span>STATUS<span class=w>   </span>ROLES<span class=w>     </span>AGE<span class=w>     </span>VERSION<span class=w>   </span>LABELS
<a id=__codelineno-152-5 name=__codelineno-152-5 href=#__codelineno-152-5></a>k8s-node01<span class=w>   </span>Ready<span class=w>    </span>ingress<span class=w>   </span>7d18h<span class=w>   </span>v1.25.6<span class=w>   </span>beta.kubernetes.io/arch<span class=o>=</span>amd64,beta.kubernetes.io/os<span class=o>=</span>linux,build<span class=o>=</span>true,kubernetes.io/arch<span class=o>=</span>amd64,kubernetes.io/hostname<span class=o>=</span>k8s-node01,kubernetes.io/os<span class=o>=</span>linux,node-role.kubernetes.io/ingress<span class=o>=</span><span class=nb>true</span>
</code></pre></div> <p>自由风格里面配置 Cloud中配置如下：</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-32.png></p> <p>pipeline流水线中配置如下</p> <div class=highlight><pre><span></span><code><a id=__codelineno-153-1 name=__codelineno-153-1 href=#__codelineno-153-1></a>pipeline{
<a id=__codelineno-153-2 name=__codelineno-153-2 href=#__codelineno-153-2></a>......
<a id=__codelineno-153-3 name=__codelineno-153-3 href=#__codelineno-153-3></a>
<a id=__codelineno-153-4 name=__codelineno-153-4 href=#__codelineno-153-4></a>    agent {
<a id=__codelineno-153-5 name=__codelineno-153-5 href=#__codelineno-153-5></a>        kubernetes {
<a id=__codelineno-153-6 name=__codelineno-153-6 href=#__codelineno-153-6></a>            cloud &#39;kubernetes&#39;
<a id=__codelineno-153-7 name=__codelineno-153-7 href=#__codelineno-153-7></a>            slaveConnectTimeout 1200
<a id=__codelineno-153-8 name=__codelineno-153-8 href=#__codelineno-153-8></a>            workspaceVolume nfsWorkspaceVolume(serverAddress: &quot;192.168.1.60&quot;, serverPath: &quot;/QaTest/jenkins-salve&quot;, readOnly: &quot;false&quot;)
<a id=__codelineno-153-9 name=__codelineno-153-9 href=#__codelineno-153-9></a>            yaml &#39;&#39;&#39;
<a id=__codelineno-153-10 name=__codelineno-153-10 href=#__codelineno-153-10></a>
<a id=__codelineno-153-11 name=__codelineno-153-11 href=#__codelineno-153-11></a>---
<a id=__codelineno-153-12 name=__codelineno-153-12 href=#__codelineno-153-12></a>apiVersion: &quot;v1&quot;
<a id=__codelineno-153-13 name=__codelineno-153-13 href=#__codelineno-153-13></a>kind: &quot;Pod&quot;
<a id=__codelineno-153-14 name=__codelineno-153-14 href=#__codelineno-153-14></a>metadata:
<a id=__codelineno-153-15 name=__codelineno-153-15 href=#__codelineno-153-15></a>  labels:
<a id=__codelineno-153-16 name=__codelineno-153-16 href=#__codelineno-153-16></a>    jenkins: &quot;slave&quot;
<a id=__codelineno-153-17 name=__codelineno-153-17 href=#__codelineno-153-17></a>    jenkins/label: &quot;jenkins-jnlp&quot;
<a id=__codelineno-153-18 name=__codelineno-153-18 href=#__codelineno-153-18></a>  name: &quot;jenkins-slave&quot;
<a id=__codelineno-153-19 name=__codelineno-153-19 href=#__codelineno-153-19></a>  namespace: &quot;kube-ops&quot;
<a id=__codelineno-153-20 name=__codelineno-153-20 href=#__codelineno-153-20></a>
<a id=__codelineno-153-21 name=__codelineno-153-21 href=#__codelineno-153-21></a>spec:
<a id=__codelineno-153-22 name=__codelineno-153-22 href=#__codelineno-153-22></a>  containers:
<a id=__codelineno-153-23 name=__codelineno-153-23 href=#__codelineno-153-23></a>  - env:
<a id=__codelineno-153-24 name=__codelineno-153-24 href=#__codelineno-153-24></a>    - name: &quot;DOCKER_HOST&quot;
<a id=__codelineno-153-25 name=__codelineno-153-25 href=#__codelineno-153-25></a>      value: &quot;tcp://docker-dind:2375&quot;
<a id=__codelineno-153-26 name=__codelineno-153-26 href=#__codelineno-153-26></a>
<a id=__codelineno-153-27 name=__codelineno-153-27 href=#__codelineno-153-27></a>    - name: &quot;JENKINS_AGENT_WORKDIR&quot;
<a id=__codelineno-153-28 name=__codelineno-153-28 href=#__codelineno-153-28></a>      value: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-153-29 name=__codelineno-153-29 href=#__codelineno-153-29></a>
<a id=__codelineno-153-30 name=__codelineno-153-30 href=#__codelineno-153-30></a>    image: &quot;hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11&quot;
<a id=__codelineno-153-31 name=__codelineno-153-31 href=#__codelineno-153-31></a>    imagePullPolicy: &quot;IfNotPresent&quot;
<a id=__codelineno-153-32 name=__codelineno-153-32 href=#__codelineno-153-32></a>    .....
<a id=__codelineno-153-33 name=__codelineno-153-33 href=#__codelineno-153-33></a>  hostNetwork: false
<a id=__codelineno-153-34 name=__codelineno-153-34 href=#__codelineno-153-34></a>  imagePullSecrets:
<a id=__codelineno-153-35 name=__codelineno-153-35 href=#__codelineno-153-35></a>  - name: &quot;regcred&quot;
<a id=__codelineno-153-36 name=__codelineno-153-36 href=#__codelineno-153-36></a>  nodeSelector:
<a id=__codelineno-153-37 name=__codelineno-153-37 href=#__codelineno-153-37></a>    build: &quot;true&quot;
<a id=__codelineno-153-38 name=__codelineno-153-38 href=#__codelineno-153-38></a>......
<a id=__codelineno-153-39 name=__codelineno-153-39 href=#__codelineno-153-39></a> }
</code></pre></div> <p>读者的Kubernetes集群可能并非使用Docker作为Runtime，但是由于构建镜像时需要使用Docker，因此该节点需要安装Docker：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-154-1 name=__codelineno-154-1 href=#__codelineno-154-1></a>$<span class=w> </span>wget<span class=w> </span>https://download.docker.com/linux/static/stable/aarch64/docker-20.10.9.tgz
<a id=__codelineno-154-2 name=__codelineno-154-2 href=#__codelineno-154-2></a>$<span class=w> </span>tar<span class=w> </span>zxf<span class=w> </span>docker-20.10.9.tgz
<a id=__codelineno-154-3 name=__codelineno-154-3 href=#__codelineno-154-3></a>$<span class=w> </span>cp<span class=w> </span>docker/*<span class=w> </span>/usr/bin
<a id=__codelineno-154-4 name=__codelineno-154-4 href=#__codelineno-154-4></a>$<span class=w> </span>cat<span class=w> </span>&gt;/lib/systemd/system/docker.service<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<a id=__codelineno-154-5 name=__codelineno-154-5 href=#__codelineno-154-5></a><span class=s>[Unit]</span>
<a id=__codelineno-154-6 name=__codelineno-154-6 href=#__codelineno-154-6></a><span class=s>Description=Docker Application Container Engine</span>
<a id=__codelineno-154-7 name=__codelineno-154-7 href=#__codelineno-154-7></a><span class=s>Documentation=https://docs.docker.com</span>
<a id=__codelineno-154-8 name=__codelineno-154-8 href=#__codelineno-154-8></a><span class=s>After=network-online.target firewalld.service</span>
<a id=__codelineno-154-9 name=__codelineno-154-9 href=#__codelineno-154-9></a><span class=s>Wants=network-online.target</span>
<a id=__codelineno-154-10 name=__codelineno-154-10 href=#__codelineno-154-10></a><span class=s>[Service]</span>
<a id=__codelineno-154-11 name=__codelineno-154-11 href=#__codelineno-154-11></a><span class=s>Type=notify</span>
<a id=__codelineno-154-12 name=__codelineno-154-12 href=#__codelineno-154-12></a><span class=s>ExecStart=/usr/bin/dockerd</span>
<a id=__codelineno-154-13 name=__codelineno-154-13 href=#__codelineno-154-13></a><span class=s>ExecReload=/bin/kill -s HUP $MAINPID</span>
<a id=__codelineno-154-14 name=__codelineno-154-14 href=#__codelineno-154-14></a><span class=s>LimitNOFILE=infinity</span>
<a id=__codelineno-154-15 name=__codelineno-154-15 href=#__codelineno-154-15></a><span class=s>LimitNPROC=infinity</span>
<a id=__codelineno-154-16 name=__codelineno-154-16 href=#__codelineno-154-16></a><span class=s>TimeoutStartSec=0</span>
<a id=__codelineno-154-17 name=__codelineno-154-17 href=#__codelineno-154-17></a><span class=s>Delegate=yes</span>
<a id=__codelineno-154-18 name=__codelineno-154-18 href=#__codelineno-154-18></a><span class=s>KillMode=process</span>
<a id=__codelineno-154-19 name=__codelineno-154-19 href=#__codelineno-154-19></a><span class=s>Restart=on-failure</span>
<a id=__codelineno-154-20 name=__codelineno-154-20 href=#__codelineno-154-20></a><span class=s>StartLimitBurst=3</span>
<a id=__codelineno-154-21 name=__codelineno-154-21 href=#__codelineno-154-21></a><span class=s>StartLimitInterval=60s</span>
<a id=__codelineno-154-22 name=__codelineno-154-22 href=#__codelineno-154-22></a><span class=s>[Install]</span>
<a id=__codelineno-154-23 name=__codelineno-154-23 href=#__codelineno-154-23></a><span class=s>WantedBy=multi-user.target</span>
<a id=__codelineno-154-24 name=__codelineno-154-24 href=#__codelineno-154-24></a><span class=s>EOF</span>
<a id=__codelineno-154-25 name=__codelineno-154-25 href=#__codelineno-154-25></a>
<a id=__codelineno-154-26 name=__codelineno-154-26 href=#__codelineno-154-26></a>$<span class=w> </span>systemctl<span class=w> </span>daemon-reload
<a id=__codelineno-154-27 name=__codelineno-154-27 href=#__codelineno-154-27></a>$<span class=w> </span>systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>--now<span class=w> </span>docker<span class=w> </span>
<a id=__codelineno-154-28 name=__codelineno-154-28 href=#__codelineno-154-28></a>
<a id=__codelineno-154-29 name=__codelineno-154-29 href=#__codelineno-154-29></a>$<span class=w> </span>docker<span class=w> </span>version
<a id=__codelineno-154-30 name=__codelineno-154-30 href=#__codelineno-154-30></a>
<a id=__codelineno-154-31 name=__codelineno-154-31 href=#__codelineno-154-31></a>
<a id=__codelineno-154-32 name=__codelineno-154-32 href=#__codelineno-154-32></a><span class=c1># 如果镜像仓库未配置证书，则需要配置insecure-registry：</span>
<a id=__codelineno-154-33 name=__codelineno-154-33 href=#__codelineno-154-33></a>$<span class=w> </span>cat<span class=w> </span>&gt;<span class=w> </span>/etc/docker/daemon.json<span class=w> </span><span class=s>&lt;&lt;&#39;EOF&#39;</span>
<a id=__codelineno-154-34 name=__codelineno-154-34 href=#__codelineno-154-34></a><span class=s>{</span>
<a id=__codelineno-154-35 name=__codelineno-154-35 href=#__codelineno-154-35></a><span class=s>  &quot;graph&quot;: &quot;/data/docker&quot;,</span>
<a id=__codelineno-154-36 name=__codelineno-154-36 href=#__codelineno-154-36></a><span class=s>  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span>
<a id=__codelineno-154-37 name=__codelineno-154-37 href=#__codelineno-154-37></a><span class=s>  &quot;insecure-registries&quot;: [&quot;hub.gitee.cc&quot;],</span>
<a id=__codelineno-154-38 name=__codelineno-154-38 href=#__codelineno-154-38></a><span class=s>  &quot;registry-mirrors&quot;: [&quot;https://25bxwt20.mirror.aliyuncs.com&quot;],</span>
<a id=__codelineno-154-39 name=__codelineno-154-39 href=#__codelineno-154-39></a><span class=s>  &quot;live-restore&quot;: true,</span>
<a id=__codelineno-154-40 name=__codelineno-154-40 href=#__codelineno-154-40></a><span class=s>  &quot;bip&quot;: &quot;172.16.200.1/24&quot;,</span>
<a id=__codelineno-154-41 name=__codelineno-154-41 href=#__codelineno-154-41></a><span class=s>  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span>
<a id=__codelineno-154-42 name=__codelineno-154-42 href=#__codelineno-154-42></a><span class=s>  &quot;hosts&quot;: [&quot;tcp://0.0.0.0:2375&quot;, &quot;unix:///var/run/docker.sock&quot;],</span>
<a id=__codelineno-154-43 name=__codelineno-154-43 href=#__codelineno-154-43></a><span class=s>  &quot;log-opts&quot;: {</span>
<a id=__codelineno-154-44 name=__codelineno-154-44 href=#__codelineno-154-44></a><span class=s>    &quot;max-size&quot;:&quot;100M&quot;,</span>
<a id=__codelineno-154-45 name=__codelineno-154-45 href=#__codelineno-154-45></a><span class=s>    &quot;max-file&quot;:&quot;3&quot;</span>
<a id=__codelineno-154-46 name=__codelineno-154-46 href=#__codelineno-154-46></a><span class=s>  }</span>
<a id=__codelineno-154-47 name=__codelineno-154-47 href=#__codelineno-154-47></a><span class=s>}</span>
<a id=__codelineno-154-48 name=__codelineno-154-48 href=#__codelineno-154-48></a><span class=s>EOF</span>
<a id=__codelineno-154-49 name=__codelineno-154-49 href=#__codelineno-154-49></a>$<span class=w> </span>systemctl<span class=w> </span>restart<span class=w> </span>docker
</code></pre></div> <h3 id=56-jenkins配置kubernetes多集群>5.6 Jenkins配置Kubernetes多集群<a class=headerlink href=#56-jenkins配置kubernetes多集群 title="Permanent link">&para;</a></h3> <p>本书讲解的Pipeline采用的Agent为在Kubernetes集群中创建的Pod，所以Jenkins要控制Kubernetes集群创建Pod充当Jenkins的Slave。</p> <p>之前我们添加了Kubernetes的证书至Jenkins凭证，接下来在Jenkins中配置Kubernetes直接引用该证书。</p> <p>首先单击Manage Jenkins，之后单击Configure Clouds，如图所示。</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-11.png></p> <p>单击Add a new cloud，选择Kubernetes</p> <p>之后在Name字段输入集群的名称，一般输入可识别的名称即可，比如现在是学习环 境 的 Kubernetes ， 可 以 叫 作 kubernetes。 </p> <p>之后单击Kubernetes Cloud details，如图</p> <p>然后在Credentials处选择之前添加的Kubernetes证书，选择后单击Test Connection，最后在凭证下方即可看到能否正常连接的结果。</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-12.png></p> <p>最后单击Save即可，添加完Kubernetes后，在Jenkinsfile的Agent中就可以选择该集群作为创建Slave的集群。</p> <p><strong>如果想要添加多个集群，重复上述步骤即可。首先添加Kubernetes凭证，然后添加Cloud即可。</strong></p> <h2 id=6-自动化构建java应用>6. 自动化构建Java应用<a class=headerlink href=#6-自动化构建java应用 title="Permanent link">&para;</a></h2> <p>本节将演示自动化构建Java应用，使用Spring Cloud的Eureka进行演示，其他Spring Boot或者Java应用基本上都是同样的步骤。</p> <h3 id=61-部署kubernetes应用>6.1 部署Kubernetes应用<a class=headerlink href=#61-部署kubernetes应用 title="Permanent link">&para;</a></h3> <p>上面我们已经知道了如何在 Jenkins Slave 中构建任务了，那么如何来部署一个原生的 Kubernetes 应用呢？ 要部署 Kubernetes 应用，我们就得对我们之前部署应用的流程要非常熟悉才行，我们之前的流程是怎样的：</p> <ul> <li>编写代码</li> <li>测试</li> <li>编写 Dockerfile</li> <li>构建打包 Docker 镜像</li> <li>推送 Docker 镜像到仓库</li> <li>编写 Kubernetes YAML 文件</li> <li>更改 YAML 文件中 Docker 镜像 TAG</li> <li>利用 kubectl 工具部署应用</li> </ul> <h3 id=62-创建java测试用例>6.2 创建Java测试用例<a class=headerlink href=#62-创建java测试用例 title="Permanent link">&para;</a></h3> <p>本书为读者准备了一个简单的Java测试用例，用于读者的学习，可以从https://gitee.com/dukuan/spring-boot-project.git找到该项目（也可以 使用公司的Java项目）。</p> <p>接下来将该项目导入自己的GitLab中。首先找到之前创建的Kubernetes组，然后单击New project，如图 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-33.png></p> <p>在Git repository URL中输入示例地址，然后单击Create project，如图 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-34.png></p> <p>导入后，结果如图 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-35.png></p> <h3 id=63-定义jenkinsfile>6.3 定义Jenkinsfile<a class=headerlink href=#63-定义jenkinsfile title="Permanent link">&para;</a></h3> <p>先将镜像上传到harbor私有仓库</p> <div class=highlight><pre><span></span><code><a id=__codelineno-155-1 name=__codelineno-155-1 href=#__codelineno-155-1></a><span class=c1># docker pull registry.cn-beijing.aliyuncs.com/citools/maven:3.5.3</span>
<a id=__codelineno-155-2 name=__codelineno-155-2 href=#__codelineno-155-2></a><span class=c1># docker tag registry.cn-beijing.aliyuncs.com/citools/maven:3.5.3 hub.gitee.cc/kubernetes/maven:3.5.3</span>
<a id=__codelineno-155-3 name=__codelineno-155-3 href=#__codelineno-155-3></a><span class=c1># docker push hub.gitee.cc/kubernetes/maven:3.5.3</span>
</code></pre></div> <p>Jenkinsfile定义流水线的步骤包括拉取代码、执行构建、生成镜像、更新Kubernetes资源等。</p> <p>本书将Jenkinsfile放置于项目源代码一并管理，也可以单独放置于一个Git仓库进行管理。</p> <p>接下来在GitLab的源代码中添加Jenkinsfile。首先单击代码首页的“+”，然后单击New file，</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-36.png></p> <p>在窗口中添加如下内容：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-156-1 name=__codelineno-156-1 href=#__codelineno-156-1></a>pipeline{
<a id=__codelineno-156-2 name=__codelineno-156-2 href=#__codelineno-156-2></a>    // 定义一些全局的环境变量
<a id=__codelineno-156-3 name=__codelineno-156-3 href=#__codelineno-156-3></a>    environment {
<a id=__codelineno-156-4 name=__codelineno-156-4 href=#__codelineno-156-4></a>        COMMIT_ID = &quot;&quot;
<a id=__codelineno-156-5 name=__codelineno-156-5 href=#__codelineno-156-5></a>        // harbor地址
<a id=__codelineno-156-6 name=__codelineno-156-6 href=#__codelineno-156-6></a>        HARBOR_ADDRESS = &quot;hub.gitee.cc&quot;
<a id=__codelineno-156-7 name=__codelineno-156-7 href=#__codelineno-156-7></a>        // harbor的项目目录
<a id=__codelineno-156-8 name=__codelineno-156-8 href=#__codelineno-156-8></a>        REGISTRY_DIR = &quot;kubernetes&quot;
<a id=__codelineno-156-9 name=__codelineno-156-9 href=#__codelineno-156-9></a>        // 镜像名称
<a id=__codelineno-156-10 name=__codelineno-156-10 href=#__codelineno-156-10></a>        IMAGE_NAME = &quot;spring-boot-project&quot;
<a id=__codelineno-156-11 name=__codelineno-156-11 href=#__codelineno-156-11></a>        // kubernetes中的名称空间
<a id=__codelineno-156-12 name=__codelineno-156-12 href=#__codelineno-156-12></a>        NAMESPACE = &quot;kubernetes&quot;
<a id=__codelineno-156-13 name=__codelineno-156-13 href=#__codelineno-156-13></a>        // 镜像的分支，由BUILD_TAG+COMMIT_ID组成
<a id=__codelineno-156-14 name=__codelineno-156-14 href=#__codelineno-156-14></a>        TAG = &quot;&quot;
<a id=__codelineno-156-15 name=__codelineno-156-15 href=#__codelineno-156-15></a>        // gitlab账号密码认证
<a id=__codelineno-156-16 name=__codelineno-156-16 href=#__codelineno-156-16></a>        GITLAB_AUTH = &quot;gitlab-auth&quot;
<a id=__codelineno-156-17 name=__codelineno-156-17 href=#__codelineno-156-17></a>        // harbor账号密码认证
<a id=__codelineno-156-18 name=__codelineno-156-18 href=#__codelineno-156-18></a>        HARBOR_AUTH = &quot;harbor-user-passwd&quot;
<a id=__codelineno-156-19 name=__codelineno-156-19 href=#__codelineno-156-19></a>    }
<a id=__codelineno-156-20 name=__codelineno-156-20 href=#__codelineno-156-20></a>  parameters {
<a id=__codelineno-156-21 name=__codelineno-156-21 href=#__codelineno-156-21></a>    // 使用GitParameter插件，该字段会在jenkins页面生成一个选择分支的选项
<a id=__codelineno-156-22 name=__codelineno-156-22 href=#__codelineno-156-22></a>    gitParameter(branch: &#39;&#39;, branchFilter: &#39;origin/(.*)&#39;, defaultValue: &#39;master&#39;, description: &#39;Branch for build and deploy&#39;, name: &#39;BRANCH&#39;, quickFilterEnabled: false, selectedValue: &#39;NONE&#39;, sortMode: &#39;NONE&#39;, tagFilter: &#39;*&#39;, type: &#39;PT_BRANCH&#39;)
<a id=__codelineno-156-23 name=__codelineno-156-23 href=#__codelineno-156-23></a>  }
<a id=__codelineno-156-24 name=__codelineno-156-24 href=#__codelineno-156-24></a>
<a id=__codelineno-156-25 name=__codelineno-156-25 href=#__codelineno-156-25></a>    options {
<a id=__codelineno-156-26 name=__codelineno-156-26 href=#__codelineno-156-26></a>      parallelsAlwaysFailFast()
<a id=__codelineno-156-27 name=__codelineno-156-27 href=#__codelineno-156-27></a>      disableResume()
<a id=__codelineno-156-28 name=__codelineno-156-28 href=#__codelineno-156-28></a>      quietPeriod(1)
<a id=__codelineno-156-29 name=__codelineno-156-29 href=#__codelineno-156-29></a>      preserveStashes(buildCount: 5)
<a id=__codelineno-156-30 name=__codelineno-156-30 href=#__codelineno-156-30></a>      timestamps()
<a id=__codelineno-156-31 name=__codelineno-156-31 href=#__codelineno-156-31></a>      buildDiscarder(logRotator(numToKeepStr: &#39;100&#39;))
<a id=__codelineno-156-32 name=__codelineno-156-32 href=#__codelineno-156-32></a>      timeout(time: 60, unit: &#39;MINUTES&#39;)
<a id=__codelineno-156-33 name=__codelineno-156-33 href=#__codelineno-156-33></a>    }
<a id=__codelineno-156-34 name=__codelineno-156-34 href=#__codelineno-156-34></a>
<a id=__codelineno-156-35 name=__codelineno-156-35 href=#__codelineno-156-35></a>    agent {
<a id=__codelineno-156-36 name=__codelineno-156-36 href=#__codelineno-156-36></a>        // 定义kubernetes作为agent
<a id=__codelineno-156-37 name=__codelineno-156-37 href=#__codelineno-156-37></a>        kubernetes {
<a id=__codelineno-156-38 name=__codelineno-156-38 href=#__codelineno-156-38></a>            // 选择的云为之前配置的名称
<a id=__codelineno-156-39 name=__codelineno-156-39 href=#__codelineno-156-39></a>            cloud &#39;kubernetes&#39;
<a id=__codelineno-156-40 name=__codelineno-156-40 href=#__codelineno-156-40></a>            slaveConnectTimeout 1200
<a id=__codelineno-156-41 name=__codelineno-156-41 href=#__codelineno-156-41></a>            // 存储为nfs方式持久化挂载
<a id=__codelineno-156-42 name=__codelineno-156-42 href=#__codelineno-156-42></a>            workspaceVolume nfsWorkspaceVolume(serverAddress: &quot;192.168.1.60&quot;, serverPath: &quot;/QaTest/jenkins-salve&quot;, readOnly: &quot;false&quot;)
<a id=__codelineno-156-43 name=__codelineno-156-43 href=#__codelineno-156-43></a>            yaml &#39;&#39;&#39;
<a id=__codelineno-156-44 name=__codelineno-156-44 href=#__codelineno-156-44></a>apiVersion: v1
<a id=__codelineno-156-45 name=__codelineno-156-45 href=#__codelineno-156-45></a>kind: Pod
<a id=__codelineno-156-46 name=__codelineno-156-46 href=#__codelineno-156-46></a>metadata:
<a id=__codelineno-156-47 name=__codelineno-156-47 href=#__codelineno-156-47></a>  name: &quot;jenkins-slave&quot;
<a id=__codelineno-156-48 name=__codelineno-156-48 href=#__codelineno-156-48></a>  namespace: &quot;kube-ops&quot;
<a id=__codelineno-156-49 name=__codelineno-156-49 href=#__codelineno-156-49></a>  labels:
<a id=__codelineno-156-50 name=__codelineno-156-50 href=#__codelineno-156-50></a>    jenkins: &quot;slave&quot;
<a id=__codelineno-156-51 name=__codelineno-156-51 href=#__codelineno-156-51></a>    jenkins/label: &quot;jenkins-jnlp&quot;
<a id=__codelineno-156-52 name=__codelineno-156-52 href=#__codelineno-156-52></a>spec:
<a id=__codelineno-156-53 name=__codelineno-156-53 href=#__codelineno-156-53></a>  containers:
<a id=__codelineno-156-54 name=__codelineno-156-54 href=#__codelineno-156-54></a>  # jnlp容器，和jenkins主节点通信。包含kubectl命令、helm命令、docker命令
<a id=__codelineno-156-55 name=__codelineno-156-55 href=#__codelineno-156-55></a>  - name: &quot;jnlp&quot;
<a id=__codelineno-156-56 name=__codelineno-156-56 href=#__codelineno-156-56></a>    image: &quot;hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11&quot;
<a id=__codelineno-156-57 name=__codelineno-156-57 href=#__codelineno-156-57></a>    imagePullPolicy: &quot;IfNotPresent&quot;
<a id=__codelineno-156-58 name=__codelineno-156-58 href=#__codelineno-156-58></a>    tty: true
<a id=__codelineno-156-59 name=__codelineno-156-59 href=#__codelineno-156-59></a>    resources:
<a id=__codelineno-156-60 name=__codelineno-156-60 href=#__codelineno-156-60></a>      limits:
<a id=__codelineno-156-61 name=__codelineno-156-61 href=#__codelineno-156-61></a>        cpu: 1000m
<a id=__codelineno-156-62 name=__codelineno-156-62 href=#__codelineno-156-62></a>        memory: 2000Mi
<a id=__codelineno-156-63 name=__codelineno-156-63 href=#__codelineno-156-63></a>      requests:
<a id=__codelineno-156-64 name=__codelineno-156-64 href=#__codelineno-156-64></a>        cpu: 200m
<a id=__codelineno-156-65 name=__codelineno-156-65 href=#__codelineno-156-65></a>        memory: 400Mi
<a id=__codelineno-156-66 name=__codelineno-156-66 href=#__codelineno-156-66></a>    env:
<a id=__codelineno-156-67 name=__codelineno-156-67 href=#__codelineno-156-67></a>    - name: &quot;DOCKER_HOST&quot;
<a id=__codelineno-156-68 name=__codelineno-156-68 href=#__codelineno-156-68></a>      value: &quot;tcp://192.168.1.141:2375&quot;
<a id=__codelineno-156-69 name=__codelineno-156-69 href=#__codelineno-156-69></a>    - name: &quot;JENKINS_AGENT_WORKDIR&quot;
<a id=__codelineno-156-70 name=__codelineno-156-70 href=#__codelineno-156-70></a>      value: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-156-71 name=__codelineno-156-71 href=#__codelineno-156-71></a>    volumeMounts:
<a id=__codelineno-156-72 name=__codelineno-156-72 href=#__codelineno-156-72></a>    - mountPath: &quot;/root/.kube/config&quot;
<a id=__codelineno-156-73 name=__codelineno-156-73 href=#__codelineno-156-73></a>      name: &quot;volume-0&quot;
<a id=__codelineno-156-74 name=__codelineno-156-74 href=#__codelineno-156-74></a>      readOnly: false
<a id=__codelineno-156-75 name=__codelineno-156-75 href=#__codelineno-156-75></a>      subPath: &quot;config&quot;
<a id=__codelineno-156-76 name=__codelineno-156-76 href=#__codelineno-156-76></a>    - name: localtime
<a id=__codelineno-156-77 name=__codelineno-156-77 href=#__codelineno-156-77></a>      mountPath: /etc/localtime
<a id=__codelineno-156-78 name=__codelineno-156-78 href=#__codelineno-156-78></a>
<a id=__codelineno-156-79 name=__codelineno-156-79 href=#__codelineno-156-79></a>    - mountPath: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-156-80 name=__codelineno-156-80 href=#__codelineno-156-80></a>      name: &quot;workspace-volume&quot;
<a id=__codelineno-156-81 name=__codelineno-156-81 href=#__codelineno-156-81></a>      readOnly: false
<a id=__codelineno-156-82 name=__codelineno-156-82 href=#__codelineno-156-82></a>    workingDir: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-156-83 name=__codelineno-156-83 href=#__codelineno-156-83></a>
<a id=__codelineno-156-84 name=__codelineno-156-84 href=#__codelineno-156-84></a>  # build容器，包含构建的命令，java需要maven构建，需要一个maven镜像
<a id=__codelineno-156-85 name=__codelineno-156-85 href=#__codelineno-156-85></a>  - name: &quot;build&quot;
<a id=__codelineno-156-86 name=__codelineno-156-86 href=#__codelineno-156-86></a>    image: &quot;hub.gitee.cc/kubernetes/maven:3.5.3&quot;
<a id=__codelineno-156-87 name=__codelineno-156-87 href=#__codelineno-156-87></a>    imagePullPolicy: &quot;IfNotPresent&quot;
<a id=__codelineno-156-88 name=__codelineno-156-88 href=#__codelineno-156-88></a>    tty: true
<a id=__codelineno-156-89 name=__codelineno-156-89 href=#__codelineno-156-89></a>    volumeMounts:
<a id=__codelineno-156-90 name=__codelineno-156-90 href=#__codelineno-156-90></a>      - name: localtime
<a id=__codelineno-156-91 name=__codelineno-156-91 href=#__codelineno-156-91></a>        mountPath: /etc/localtime
<a id=__codelineno-156-92 name=__codelineno-156-92 href=#__codelineno-156-92></a>      # Pod单独创建了一个缓存的volume，将其挂载到了maven插件的缓存目录，默认是/root/.m2
<a id=__codelineno-156-93 name=__codelineno-156-93 href=#__codelineno-156-93></a>      - name:  cachedir
<a id=__codelineno-156-94 name=__codelineno-156-94 href=#__codelineno-156-94></a>        mountPath: &quot;/root/.m2/&quot;
<a id=__codelineno-156-95 name=__codelineno-156-95 href=#__codelineno-156-95></a>        readOnly: false
<a id=__codelineno-156-96 name=__codelineno-156-96 href=#__codelineno-156-96></a>    command:
<a id=__codelineno-156-97 name=__codelineno-156-97 href=#__codelineno-156-97></a>      - &quot;cat&quot;
<a id=__codelineno-156-98 name=__codelineno-156-98 href=#__codelineno-156-98></a>    env:
<a id=__codelineno-156-99 name=__codelineno-156-99 href=#__codelineno-156-99></a>      - name: &quot;LANGUAGE&quot;
<a id=__codelineno-156-100 name=__codelineno-156-100 href=#__codelineno-156-100></a>        value: &quot;en_US:en&quot;
<a id=__codelineno-156-101 name=__codelineno-156-101 href=#__codelineno-156-101></a>      - name: &quot;LC_ALL&quot;
<a id=__codelineno-156-102 name=__codelineno-156-102 href=#__codelineno-156-102></a>        value: &quot;en_US.UTF-8&quot;
<a id=__codelineno-156-103 name=__codelineno-156-103 href=#__codelineno-156-103></a>      - name: &quot;LANG&quot;
<a id=__codelineno-156-104 name=__codelineno-156-104 href=#__codelineno-156-104></a>        value: &quot;en_US.UTF-8&quot;
<a id=__codelineno-156-105 name=__codelineno-156-105 href=#__codelineno-156-105></a>
<a id=__codelineno-156-106 name=__codelineno-156-106 href=#__codelineno-156-106></a>  volumes:
<a id=__codelineno-156-107 name=__codelineno-156-107 href=#__codelineno-156-107></a>    - name: localtime
<a id=__codelineno-156-108 name=__codelineno-156-108 href=#__codelineno-156-108></a>      hostPath:
<a id=__codelineno-156-109 name=__codelineno-156-109 href=#__codelineno-156-109></a>        path: /usr/share/zoneinfo/Asia/Shanghai
<a id=__codelineno-156-110 name=__codelineno-156-110 href=#__codelineno-156-110></a>
<a id=__codelineno-156-111 name=__codelineno-156-111 href=#__codelineno-156-111></a>    - configMap:
<a id=__codelineno-156-112 name=__codelineno-156-112 href=#__codelineno-156-112></a>        name: &quot;kubeconfig&quot;
<a id=__codelineno-156-113 name=__codelineno-156-113 href=#__codelineno-156-113></a>        optional: false
<a id=__codelineno-156-114 name=__codelineno-156-114 href=#__codelineno-156-114></a>      name: &quot;volume-0&quot;
<a id=__codelineno-156-115 name=__codelineno-156-115 href=#__codelineno-156-115></a>    # 缓存目录
<a id=__codelineno-156-116 name=__codelineno-156-116 href=#__codelineno-156-116></a>    - name: &quot;cachedir&quot;
<a id=__codelineno-156-117 name=__codelineno-156-117 href=#__codelineno-156-117></a>      hostPath:
<a id=__codelineno-156-118 name=__codelineno-156-118 href=#__codelineno-156-118></a>        path: &quot;/opt/m2&quot;
<a id=__codelineno-156-119 name=__codelineno-156-119 href=#__codelineno-156-119></a>
<a id=__codelineno-156-120 name=__codelineno-156-120 href=#__codelineno-156-120></a>    - emptyDir:
<a id=__codelineno-156-121 name=__codelineno-156-121 href=#__codelineno-156-121></a>        medium: &quot;&quot;
<a id=__codelineno-156-122 name=__codelineno-156-122 href=#__codelineno-156-122></a>      name: &quot;workspace-volume&quot;
<a id=__codelineno-156-123 name=__codelineno-156-123 href=#__codelineno-156-123></a>  restartPolicy: Always
<a id=__codelineno-156-124 name=__codelineno-156-124 href=#__codelineno-156-124></a>  hostNetwork: false
<a id=__codelineno-156-125 name=__codelineno-156-125 href=#__codelineno-156-125></a>  imagePullSecrets:
<a id=__codelineno-156-126 name=__codelineno-156-126 href=#__codelineno-156-126></a>  - name: &quot;regcred&quot;
<a id=__codelineno-156-127 name=__codelineno-156-127 href=#__codelineno-156-127></a>  # 固定节点部署
<a id=__codelineno-156-128 name=__codelineno-156-128 href=#__codelineno-156-128></a>  nodeSelector:
<a id=__codelineno-156-129 name=__codelineno-156-129 href=#__codelineno-156-129></a>    build: &quot;true&quot;
<a id=__codelineno-156-130 name=__codelineno-156-130 href=#__codelineno-156-130></a>
<a id=__codelineno-156-131 name=__codelineno-156-131 href=#__codelineno-156-131></a>            &#39;&#39;&#39;
<a id=__codelineno-156-132 name=__codelineno-156-132 href=#__codelineno-156-132></a>        }
<a id=__codelineno-156-133 name=__codelineno-156-133 href=#__codelineno-156-133></a>    }
<a id=__codelineno-156-134 name=__codelineno-156-134 href=#__codelineno-156-134></a>
<a id=__codelineno-156-135 name=__codelineno-156-135 href=#__codelineno-156-135></a>    stages {
<a id=__codelineno-156-136 name=__codelineno-156-136 href=#__codelineno-156-136></a>      stage(&#39;Pulling Code&#39;) {
<a id=__codelineno-156-137 name=__codelineno-156-137 href=#__codelineno-156-137></a>        parallel {
<a id=__codelineno-156-138 name=__codelineno-156-138 href=#__codelineno-156-138></a>        stage(&#39;Pulling Code by Jenkins&#39;) {
<a id=__codelineno-156-139 name=__codelineno-156-139 href=#__codelineno-156-139></a>          when {
<a id=__codelineno-156-140 name=__codelineno-156-140 href=#__codelineno-156-140></a>            expression {
<a id=__codelineno-156-141 name=__codelineno-156-141 href=#__codelineno-156-141></a>              // 若env.gitlabBranch为空，则为手动触发执行手动 stage,若不为空，之前同级的另外一个stage
<a id=__codelineno-156-142 name=__codelineno-156-142 href=#__codelineno-156-142></a>              env.gitlabBranch == null
<a id=__codelineno-156-143 name=__codelineno-156-143 href=#__codelineno-156-143></a>            }
<a id=__codelineno-156-144 name=__codelineno-156-144 href=#__codelineno-156-144></a>
<a id=__codelineno-156-145 name=__codelineno-156-145 href=#__codelineno-156-145></a>          }
<a id=__codelineno-156-146 name=__codelineno-156-146 href=#__codelineno-156-146></a>          steps {
<a id=__codelineno-156-147 name=__codelineno-156-147 href=#__codelineno-156-147></a>            git(changelog: true, poll: true, url: &#39;http://gitlab.runjs.cn:8929/kubernetes/spring-boot-project.git&#39;, branch: &quot;${BRANCH}&quot;, credentialsId: &quot;${GITLAB_AUTH}&quot;)
<a id=__codelineno-156-148 name=__codelineno-156-148 href=#__codelineno-156-148></a>            script {
<a id=__codelineno-156-149 name=__codelineno-156-149 href=#__codelineno-156-149></a>              // 定义变量用于生成镜像的Tag
<a id=__codelineno-156-150 name=__codelineno-156-150 href=#__codelineno-156-150></a>              // 获取最近一次提交的Commit ID
<a id=__codelineno-156-151 name=__codelineno-156-151 href=#__codelineno-156-151></a>              COMMIT_ID = sh(returnStdout: true, script: &quot;git log -n 1 --pretty=format:&#39;%h&#39;&quot;).trim()
<a id=__codelineno-156-152 name=__codelineno-156-152 href=#__codelineno-156-152></a>              // 赋值给TAG变量，后面的docker build可以获取到该TAG的值
<a id=__codelineno-156-153 name=__codelineno-156-153 href=#__codelineno-156-153></a>              TAG = BUILD_TAG + &#39;-&#39; + COMMIT_ID
<a id=__codelineno-156-154 name=__codelineno-156-154 href=#__codelineno-156-154></a>              println &quot;Current branch is ${BRANCH}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}&quot;
<a id=__codelineno-156-155 name=__codelineno-156-155 href=#__codelineno-156-155></a>
<a id=__codelineno-156-156 name=__codelineno-156-156 href=#__codelineno-156-156></a>            }
<a id=__codelineno-156-157 name=__codelineno-156-157 href=#__codelineno-156-157></a>
<a id=__codelineno-156-158 name=__codelineno-156-158 href=#__codelineno-156-158></a>          }
<a id=__codelineno-156-159 name=__codelineno-156-159 href=#__codelineno-156-159></a>        }
<a id=__codelineno-156-160 name=__codelineno-156-160 href=#__codelineno-156-160></a>        stage(&#39;Pulling Code by trigger&#39;) {
<a id=__codelineno-156-161 name=__codelineno-156-161 href=#__codelineno-156-161></a>          when {
<a id=__codelineno-156-162 name=__codelineno-156-162 href=#__codelineno-156-162></a>            expression {
<a id=__codelineno-156-163 name=__codelineno-156-163 href=#__codelineno-156-163></a>              // 若env.gitlabBranch不为空，则为webook触发的执行webook stage。上面的stage不执行，此时BRANCH变量为空
<a id=__codelineno-156-164 name=__codelineno-156-164 href=#__codelineno-156-164></a>              env.gitlabBranch != null
<a id=__codelineno-156-165 name=__codelineno-156-165 href=#__codelineno-156-165></a>            }
<a id=__codelineno-156-166 name=__codelineno-156-166 href=#__codelineno-156-166></a>
<a id=__codelineno-156-167 name=__codelineno-156-167 href=#__codelineno-156-167></a>          }
<a id=__codelineno-156-168 name=__codelineno-156-168 href=#__codelineno-156-168></a>          steps {
<a id=__codelineno-156-169 name=__codelineno-156-169 href=#__codelineno-156-169></a>            git(url: &#39;http://gitlab.runjs.cn:8929/kubernetes/spring-boot-project.git&#39;, branch: env.gitlabBranch, changelog: true, poll: true, credentialsId: &quot;${GITLAB_AUTH}&quot;)
<a id=__codelineno-156-170 name=__codelineno-156-170 href=#__codelineno-156-170></a>            script {
<a id=__codelineno-156-171 name=__codelineno-156-171 href=#__codelineno-156-171></a>              COMMIT_ID = sh(returnStdout: true, script: &quot;git log -n 1 --pretty=format:&#39;%h&#39;&quot;).trim()
<a id=__codelineno-156-172 name=__codelineno-156-172 href=#__codelineno-156-172></a>              TAG = BUILD_TAG + &#39;-&#39; + COMMIT_ID
<a id=__codelineno-156-173 name=__codelineno-156-173 href=#__codelineno-156-173></a>              println &quot;Current branch is ${env.gitlabBranch}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}&quot;
<a id=__codelineno-156-174 name=__codelineno-156-174 href=#__codelineno-156-174></a>              }
<a id=__codelineno-156-175 name=__codelineno-156-175 href=#__codelineno-156-175></a>            }
<a id=__codelineno-156-176 name=__codelineno-156-176 href=#__codelineno-156-176></a>          }
<a id=__codelineno-156-177 name=__codelineno-156-177 href=#__codelineno-156-177></a>        }
<a id=__codelineno-156-178 name=__codelineno-156-178 href=#__codelineno-156-178></a>      }
<a id=__codelineno-156-179 name=__codelineno-156-179 href=#__codelineno-156-179></a>
<a id=__codelineno-156-180 name=__codelineno-156-180 href=#__codelineno-156-180></a>    stage(&#39;Building&#39;) {
<a id=__codelineno-156-181 name=__codelineno-156-181 href=#__codelineno-156-181></a>      steps {
<a id=__codelineno-156-182 name=__codelineno-156-182 href=#__codelineno-156-182></a>        container(name: &#39;build&#39;) {
<a id=__codelineno-156-183 name=__codelineno-156-183 href=#__codelineno-156-183></a>            sh &quot;&quot;&quot;
<a id=__codelineno-156-184 name=__codelineno-156-184 href=#__codelineno-156-184></a>              # 编译命令，需要根据自己的实际情况进行修改，可能会不一致
<a id=__codelineno-156-185 name=__codelineno-156-185 href=#__codelineno-156-185></a>              mvn clean install -DskipTests
<a id=__codelineno-156-186 name=__codelineno-156-186 href=#__codelineno-156-186></a>              # 完成构建后一般会在target目录生产jar包
<a id=__codelineno-156-187 name=__codelineno-156-187 href=#__codelineno-156-187></a>              ls target/*
<a id=__codelineno-156-188 name=__codelineno-156-188 href=#__codelineno-156-188></a>            &quot;&quot;&quot;
<a id=__codelineno-156-189 name=__codelineno-156-189 href=#__codelineno-156-189></a>        }
<a id=__codelineno-156-190 name=__codelineno-156-190 href=#__codelineno-156-190></a>      }
<a id=__codelineno-156-191 name=__codelineno-156-191 href=#__codelineno-156-191></a>    }
<a id=__codelineno-156-192 name=__codelineno-156-192 href=#__codelineno-156-192></a>
<a id=__codelineno-156-193 name=__codelineno-156-193 href=#__codelineno-156-193></a>    stage(&#39;Docker build for creating image&#39;) {
<a id=__codelineno-156-194 name=__codelineno-156-194 href=#__codelineno-156-194></a>      steps {
<a id=__codelineno-156-195 name=__codelineno-156-195 href=#__codelineno-156-195></a>        withCredentials([[$class: &#39;UsernamePasswordMultiBinding&#39;,
<a id=__codelineno-156-196 name=__codelineno-156-196 href=#__codelineno-156-196></a>        credentialsId: &quot;${HARBOR_AUTH}&quot;,
<a id=__codelineno-156-197 name=__codelineno-156-197 href=#__codelineno-156-197></a>        usernameVariable: &#39;Harbor_user&#39;,
<a id=__codelineno-156-198 name=__codelineno-156-198 href=#__codelineno-156-198></a>        passwordVariable: &#39;Harbor_password&#39;]]) {
<a id=__codelineno-156-199 name=__codelineno-156-199 href=#__codelineno-156-199></a>            sh &quot;&quot;&quot;#!/bin/bash
<a id=__codelineno-156-200 name=__codelineno-156-200 href=#__codelineno-156-200></a>              set -eux
<a id=__codelineno-156-201 name=__codelineno-156-201 href=#__codelineno-156-201></a>              # 登录Harbor
<a id=__codelineno-156-202 name=__codelineno-156-202 href=#__codelineno-156-202></a>              docker login -u ${Harbor_user} -p ${Harbor_password} ${HARBOR_ADDRESS}
<a id=__codelineno-156-203 name=__codelineno-156-203 href=#__codelineno-156-203></a>
<a id=__codelineno-156-204 name=__codelineno-156-204 href=#__codelineno-156-204></a>              # Dockerfile放在代码仓和Jenkinsfile同级
<a id=__codelineno-156-205 name=__codelineno-156-205 href=#__codelineno-156-205></a>              docker build --no-cache -t ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG} .
<a id=__codelineno-156-206 name=__codelineno-156-206 href=#__codelineno-156-206></a>
<a id=__codelineno-156-207 name=__codelineno-156-207 href=#__codelineno-156-207></a>              # 推送镜像至私有harbor仓库
<a id=__codelineno-156-208 name=__codelineno-156-208 href=#__codelineno-156-208></a>              docker push ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG}
<a id=__codelineno-156-209 name=__codelineno-156-209 href=#__codelineno-156-209></a>              &quot;&quot;&quot;
<a id=__codelineno-156-210 name=__codelineno-156-210 href=#__codelineno-156-210></a>        }
<a id=__codelineno-156-211 name=__codelineno-156-211 href=#__codelineno-156-211></a>      }
<a id=__codelineno-156-212 name=__codelineno-156-212 href=#__codelineno-156-212></a>    }
<a id=__codelineno-156-213 name=__codelineno-156-213 href=#__codelineno-156-213></a>
<a id=__codelineno-156-214 name=__codelineno-156-214 href=#__codelineno-156-214></a>    stage(&#39;Deploying to K8s&#39;) {
<a id=__codelineno-156-215 name=__codelineno-156-215 href=#__codelineno-156-215></a>      steps {
<a id=__codelineno-156-216 name=__codelineno-156-216 href=#__codelineno-156-216></a>           sh &quot;&quot;&quot;#!/bin/bash
<a id=__codelineno-156-217 name=__codelineno-156-217 href=#__codelineno-156-217></a>           set -ux
<a id=__codelineno-156-218 name=__codelineno-156-218 href=#__codelineno-156-218></a>
<a id=__codelineno-156-219 name=__codelineno-156-219 href=#__codelineno-156-219></a>           # set更新deployment镜像
<a id=__codelineno-156-220 name=__codelineno-156-220 href=#__codelineno-156-220></a>           kubectl set image deploy -l app=${IMAGE_NAME} ${IMAGE_NAME}=${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG} -n $NAMESPACE
<a id=__codelineno-156-221 name=__codelineno-156-221 href=#__codelineno-156-221></a>           &quot;&quot;&quot;
<a id=__codelineno-156-222 name=__codelineno-156-222 href=#__codelineno-156-222></a>      }
<a id=__codelineno-156-223 name=__codelineno-156-223 href=#__codelineno-156-223></a>    }
<a id=__codelineno-156-224 name=__codelineno-156-224 href=#__codelineno-156-224></a>  }
<a id=__codelineno-156-225 name=__codelineno-156-225 href=#__codelineno-156-225></a>}
</code></pre></div> <h3 id=64-jenkinsfile详解>6.4 Jenkinsfile详解<a class=headerlink href=#64-jenkinsfile详解 title="Permanent link">&para;</a></h3> <p>首先是顶层的agent，定义Kubernetes的Pod作为Jenkins的Slave：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-157-1 name=__codelineno-157-1 href=#__codelineno-157-1></a>    agent {
<a id=__codelineno-157-2 name=__codelineno-157-2 href=#__codelineno-157-2></a>        // 定义kubernetes作为agent
<a id=__codelineno-157-3 name=__codelineno-157-3 href=#__codelineno-157-3></a>        kubernetes {
<a id=__codelineno-157-4 name=__codelineno-157-4 href=#__codelineno-157-4></a>            // 选择的云为之前配置的名称
<a id=__codelineno-157-5 name=__codelineno-157-5 href=#__codelineno-157-5></a>            cloud &#39;kubernetes&#39;
<a id=__codelineno-157-6 name=__codelineno-157-6 href=#__codelineno-157-6></a>            slaveConnectTimeout 1200
<a id=__codelineno-157-7 name=__codelineno-157-7 href=#__codelineno-157-7></a>            // 存储为nfs方式持久化挂载
<a id=__codelineno-157-8 name=__codelineno-157-8 href=#__codelineno-157-8></a>            workspaceVolume nfsWorkspaceVolume(serverAddress: &quot;192.168.1.60&quot;, serverPath: &quot;/QaTest/jenkins-salve&quot;, readOnly: &quot;false&quot;)
<a id=__codelineno-157-9 name=__codelineno-157-9 href=#__codelineno-157-9></a>            yaml &#39;&#39;&#39;
<a id=__codelineno-157-10 name=__codelineno-157-10 href=#__codelineno-157-10></a>apiVersion: v1
<a id=__codelineno-157-11 name=__codelineno-157-11 href=#__codelineno-157-11></a>kind: Pod
<a id=__codelineno-157-12 name=__codelineno-157-12 href=#__codelineno-157-12></a>metadata:
<a id=__codelineno-157-13 name=__codelineno-157-13 href=#__codelineno-157-13></a>  name: &quot;jenkins-slave&quot;
<a id=__codelineno-157-14 name=__codelineno-157-14 href=#__codelineno-157-14></a>  namespace: &quot;kube-ops&quot;
<a id=__codelineno-157-15 name=__codelineno-157-15 href=#__codelineno-157-15></a>  labels:
<a id=__codelineno-157-16 name=__codelineno-157-16 href=#__codelineno-157-16></a>    jenkins: &quot;slave&quot;
<a id=__codelineno-157-17 name=__codelineno-157-17 href=#__codelineno-157-17></a>    jenkins/label: &quot;jenkins-jnlp&quot;
<a id=__codelineno-157-18 name=__codelineno-157-18 href=#__codelineno-157-18></a>spec:
<a id=__codelineno-157-19 name=__codelineno-157-19 href=#__codelineno-157-19></a>  containers:
<a id=__codelineno-157-20 name=__codelineno-157-20 href=#__codelineno-157-20></a>  # jnlp容器，和jenkins主节点通信。包含kubectl命令、helm命令、docker命令
<a id=__codelineno-157-21 name=__codelineno-157-21 href=#__codelineno-157-21></a>  - name: &quot;jnlp&quot;
<a id=__codelineno-157-22 name=__codelineno-157-22 href=#__codelineno-157-22></a>    image: &quot;hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11&quot;
<a id=__codelineno-157-23 name=__codelineno-157-23 href=#__codelineno-157-23></a>    imagePullPolicy: &quot;IfNotPresent&quot;
<a id=__codelineno-157-24 name=__codelineno-157-24 href=#__codelineno-157-24></a>    tty: true
<a id=__codelineno-157-25 name=__codelineno-157-25 href=#__codelineno-157-25></a>    resources:
<a id=__codelineno-157-26 name=__codelineno-157-26 href=#__codelineno-157-26></a>      limits:
<a id=__codelineno-157-27 name=__codelineno-157-27 href=#__codelineno-157-27></a>        cpu: 1000m
<a id=__codelineno-157-28 name=__codelineno-157-28 href=#__codelineno-157-28></a>        memory: 2000Mi
<a id=__codelineno-157-29 name=__codelineno-157-29 href=#__codelineno-157-29></a>      requests:
<a id=__codelineno-157-30 name=__codelineno-157-30 href=#__codelineno-157-30></a>        cpu: 200m
<a id=__codelineno-157-31 name=__codelineno-157-31 href=#__codelineno-157-31></a>        memory: 400Mi
<a id=__codelineno-157-32 name=__codelineno-157-32 href=#__codelineno-157-32></a>    env:
<a id=__codelineno-157-33 name=__codelineno-157-33 href=#__codelineno-157-33></a>    - name: &quot;DOCKER_HOST&quot;
<a id=__codelineno-157-34 name=__codelineno-157-34 href=#__codelineno-157-34></a>      value: &quot;tcp://192.168.1.141:2375&quot;
<a id=__codelineno-157-35 name=__codelineno-157-35 href=#__codelineno-157-35></a>    - name: &quot;JENKINS_AGENT_WORKDIR&quot;
<a id=__codelineno-157-36 name=__codelineno-157-36 href=#__codelineno-157-36></a>      value: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-157-37 name=__codelineno-157-37 href=#__codelineno-157-37></a>    volumeMounts:
<a id=__codelineno-157-38 name=__codelineno-157-38 href=#__codelineno-157-38></a>    # 挂载kubeconfig文件
<a id=__codelineno-157-39 name=__codelineno-157-39 href=#__codelineno-157-39></a>    - mountPath: &quot;/root/.kube/config&quot;
<a id=__codelineno-157-40 name=__codelineno-157-40 href=#__codelineno-157-40></a>      name: &quot;volume-0&quot;
<a id=__codelineno-157-41 name=__codelineno-157-41 href=#__codelineno-157-41></a>      readOnly: false
<a id=__codelineno-157-42 name=__codelineno-157-42 href=#__codelineno-157-42></a>      subPath: &quot;config&quot;
<a id=__codelineno-157-43 name=__codelineno-157-43 href=#__codelineno-157-43></a>    - name: localtime
<a id=__codelineno-157-44 name=__codelineno-157-44 href=#__codelineno-157-44></a>      mountPath: /etc/localtime
<a id=__codelineno-157-45 name=__codelineno-157-45 href=#__codelineno-157-45></a>
<a id=__codelineno-157-46 name=__codelineno-157-46 href=#__codelineno-157-46></a>    - mountPath: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-157-47 name=__codelineno-157-47 href=#__codelineno-157-47></a>      name: &quot;workspace-volume&quot;
<a id=__codelineno-157-48 name=__codelineno-157-48 href=#__codelineno-157-48></a>      readOnly: false
<a id=__codelineno-157-49 name=__codelineno-157-49 href=#__codelineno-157-49></a>    workingDir: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-157-50 name=__codelineno-157-50 href=#__codelineno-157-50></a>
<a id=__codelineno-157-51 name=__codelineno-157-51 href=#__codelineno-157-51></a>  # build容器，包含构建的命令，java需要maven构建，需要一个maven镜像
<a id=__codelineno-157-52 name=__codelineno-157-52 href=#__codelineno-157-52></a>  - name: &quot;build&quot;
<a id=__codelineno-157-53 name=__codelineno-157-53 href=#__codelineno-157-53></a>    image: &quot;registry.cn-beijing.aliyuncs.com/citools/maven:3.5.3&quot;
<a id=__codelineno-157-54 name=__codelineno-157-54 href=#__codelineno-157-54></a>    imagePullPolicy: &quot;IfNotPresent&quot;
<a id=__codelineno-157-55 name=__codelineno-157-55 href=#__codelineno-157-55></a>    tty: true
<a id=__codelineno-157-56 name=__codelineno-157-56 href=#__codelineno-157-56></a>    volumeMounts:
<a id=__codelineno-157-57 name=__codelineno-157-57 href=#__codelineno-157-57></a>      - name: localtime
<a id=__codelineno-157-58 name=__codelineno-157-58 href=#__codelineno-157-58></a>        mountPath: /etc/localtime
<a id=__codelineno-157-59 name=__codelineno-157-59 href=#__codelineno-157-59></a>      # Pod单独创建了一个缓存的volume，将其挂载到了maven插件的缓存目录，默认是/root/.m2
<a id=__codelineno-157-60 name=__codelineno-157-60 href=#__codelineno-157-60></a>      - name:  cachedir
<a id=__codelineno-157-61 name=__codelineno-157-61 href=#__codelineno-157-61></a>        mountPath: &quot;/root/.m2/&quot;
<a id=__codelineno-157-62 name=__codelineno-157-62 href=#__codelineno-157-62></a>        readOnly: false
<a id=__codelineno-157-63 name=__codelineno-157-63 href=#__codelineno-157-63></a>    command:
<a id=__codelineno-157-64 name=__codelineno-157-64 href=#__codelineno-157-64></a>      - &quot;cat&quot;
<a id=__codelineno-157-65 name=__codelineno-157-65 href=#__codelineno-157-65></a>    env:
<a id=__codelineno-157-66 name=__codelineno-157-66 href=#__codelineno-157-66></a>      - name: &quot;LANGUAGE&quot;
<a id=__codelineno-157-67 name=__codelineno-157-67 href=#__codelineno-157-67></a>        value: &quot;en_US:en&quot;
<a id=__codelineno-157-68 name=__codelineno-157-68 href=#__codelineno-157-68></a>      - name: &quot;LC_ALL&quot;
<a id=__codelineno-157-69 name=__codelineno-157-69 href=#__codelineno-157-69></a>        value: &quot;en_US.UTF-8&quot;
<a id=__codelineno-157-70 name=__codelineno-157-70 href=#__codelineno-157-70></a>      - name: &quot;LANG&quot;
<a id=__codelineno-157-71 name=__codelineno-157-71 href=#__codelineno-157-71></a>        value: &quot;en_US.UTF-8&quot;
<a id=__codelineno-157-72 name=__codelineno-157-72 href=#__codelineno-157-72></a>
<a id=__codelineno-157-73 name=__codelineno-157-73 href=#__codelineno-157-73></a>  volumes:
<a id=__codelineno-157-74 name=__codelineno-157-74 href=#__codelineno-157-74></a>    - name: localtime
<a id=__codelineno-157-75 name=__codelineno-157-75 href=#__codelineno-157-75></a>      hostPath:
<a id=__codelineno-157-76 name=__codelineno-157-76 href=#__codelineno-157-76></a>        path: /usr/share/zoneinfo/Asia/Shanghai
<a id=__codelineno-157-77 name=__codelineno-157-77 href=#__codelineno-157-77></a>
<a id=__codelineno-157-78 name=__codelineno-157-78 href=#__codelineno-157-78></a>    - configMap:
<a id=__codelineno-157-79 name=__codelineno-157-79 href=#__codelineno-157-79></a>        name: &quot;kubeconfig&quot;
<a id=__codelineno-157-80 name=__codelineno-157-80 href=#__codelineno-157-80></a>        optional: false
<a id=__codelineno-157-81 name=__codelineno-157-81 href=#__codelineno-157-81></a>      name: &quot;volume-0&quot;
<a id=__codelineno-157-82 name=__codelineno-157-82 href=#__codelineno-157-82></a>    # 缓存目录
<a id=__codelineno-157-83 name=__codelineno-157-83 href=#__codelineno-157-83></a>    - name: &quot;cachedir&quot;
<a id=__codelineno-157-84 name=__codelineno-157-84 href=#__codelineno-157-84></a>      hostPath:
<a id=__codelineno-157-85 name=__codelineno-157-85 href=#__codelineno-157-85></a>        path: &quot;/opt/m2&quot;
<a id=__codelineno-157-86 name=__codelineno-157-86 href=#__codelineno-157-86></a>
<a id=__codelineno-157-87 name=__codelineno-157-87 href=#__codelineno-157-87></a>    - emptyDir:
<a id=__codelineno-157-88 name=__codelineno-157-88 href=#__codelineno-157-88></a>        medium: &quot;&quot;
<a id=__codelineno-157-89 name=__codelineno-157-89 href=#__codelineno-157-89></a>      name: &quot;workspace-volume&quot;
<a id=__codelineno-157-90 name=__codelineno-157-90 href=#__codelineno-157-90></a>  restartPolicy: Always
<a id=__codelineno-157-91 name=__codelineno-157-91 href=#__codelineno-157-91></a>  hostNetwork: false
<a id=__codelineno-157-92 name=__codelineno-157-92 href=#__codelineno-157-92></a>  imagePullSecrets:
<a id=__codelineno-157-93 name=__codelineno-157-93 href=#__codelineno-157-93></a>  - name: &quot;regcred&quot;
<a id=__codelineno-157-94 name=__codelineno-157-94 href=#__codelineno-157-94></a>  # 固定节点部署
<a id=__codelineno-157-95 name=__codelineno-157-95 href=#__codelineno-157-95></a>  nodeSelector:
<a id=__codelineno-157-96 name=__codelineno-157-96 href=#__codelineno-157-96></a>    build: &quot;true&quot;
<a id=__codelineno-157-97 name=__codelineno-157-97 href=#__codelineno-157-97></a>
<a id=__codelineno-157-98 name=__codelineno-157-98 href=#__codelineno-157-98></a>            &#39;&#39;&#39;
<a id=__codelineno-157-99 name=__codelineno-157-99 href=#__codelineno-157-99></a>        }
<a id=__codelineno-157-100 name=__codelineno-157-100 href=#__codelineno-157-100></a>    }
</code></pre></div> <p>之后看一下Jenkinsfile最后的环境变量和parameters的配置：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-158-1 name=__codelineno-158-1 href=#__codelineno-158-1></a>    // 定义一些全局的环境变量
<a id=__codelineno-158-2 name=__codelineno-158-2 href=#__codelineno-158-2></a>    environment {
<a id=__codelineno-158-3 name=__codelineno-158-3 href=#__codelineno-158-3></a>        COMMIT_ID = &quot;&quot;
<a id=__codelineno-158-4 name=__codelineno-158-4 href=#__codelineno-158-4></a>        // harbor地址
<a id=__codelineno-158-5 name=__codelineno-158-5 href=#__codelineno-158-5></a>        HARBOR_ADDRESS = &quot;hub.gitee.cc&quot;
<a id=__codelineno-158-6 name=__codelineno-158-6 href=#__codelineno-158-6></a>        // harbor的项目目录
<a id=__codelineno-158-7 name=__codelineno-158-7 href=#__codelineno-158-7></a>        REGISTRY_DIR = &quot;kubernetes&quot;
<a id=__codelineno-158-8 name=__codelineno-158-8 href=#__codelineno-158-8></a>        // 镜像名称
<a id=__codelineno-158-9 name=__codelineno-158-9 href=#__codelineno-158-9></a>        IMAGE_NAME = &quot;spring-boot-project&quot;
<a id=__codelineno-158-10 name=__codelineno-158-10 href=#__codelineno-158-10></a>        // kubernetes中的名称空间
<a id=__codelineno-158-11 name=__codelineno-158-11 href=#__codelineno-158-11></a>        NAMESPACE = &quot;kubernetes&quot;
<a id=__codelineno-158-12 name=__codelineno-158-12 href=#__codelineno-158-12></a>        // 镜像的分支，由BUILD_TAG+COMMIT_ID组成
<a id=__codelineno-158-13 name=__codelineno-158-13 href=#__codelineno-158-13></a>        TAG = &quot;&quot;
<a id=__codelineno-158-14 name=__codelineno-158-14 href=#__codelineno-158-14></a>        // gitlab账号密码认证
<a id=__codelineno-158-15 name=__codelineno-158-15 href=#__codelineno-158-15></a>        GITLAB_AUTH = &quot;gitlab-auth&quot;
<a id=__codelineno-158-16 name=__codelineno-158-16 href=#__codelineno-158-16></a>        // harbor账号密码认证
<a id=__codelineno-158-17 name=__codelineno-158-17 href=#__codelineno-158-17></a>        HARBOR_AUTH = &quot;harbor-user-passwd&quot;
<a id=__codelineno-158-18 name=__codelineno-158-18 href=#__codelineno-158-18></a>    }
<a id=__codelineno-158-19 name=__codelineno-158-19 href=#__codelineno-158-19></a>  parameters {
<a id=__codelineno-158-20 name=__codelineno-158-20 href=#__codelineno-158-20></a>    // 使用GitParameter插件，该字段会在jenkins页面生成一个选择分支的选项
<a id=__codelineno-158-21 name=__codelineno-158-21 href=#__codelineno-158-21></a>    gitParameter(branch: &#39;&#39;, branchFilter: &#39;origin/(.*)&#39;, defaultValue: &#39;master&#39;, description: &#39;Branch for build and deploy&#39;, name: &#39;BRANCH&#39;, quickFilterEnabled: false, selectedValue: &#39;NONE&#39;, sortMode: &#39;NONE&#39;, tagFilter: &#39;*&#39;, type: &#39;PT_BRANCH&#39;)
<a id=__codelineno-158-22 name=__codelineno-158-22 href=#__codelineno-158-22></a>  }
</code></pre></div> <p>接下来是拉取代码的stage，这个stage是一个并行的stage，因为考虑了该流水线是手动触发还是自动触发：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-159-1 name=__codelineno-159-1 href=#__codelineno-159-1></a>      stage(&#39;Pulling Code&#39;) {
<a id=__codelineno-159-2 name=__codelineno-159-2 href=#__codelineno-159-2></a>        parallel {
<a id=__codelineno-159-3 name=__codelineno-159-3 href=#__codelineno-159-3></a>        stage(&#39;Pulling Code by Jenkins&#39;) {
<a id=__codelineno-159-4 name=__codelineno-159-4 href=#__codelineno-159-4></a>          when {
<a id=__codelineno-159-5 name=__codelineno-159-5 href=#__codelineno-159-5></a>            expression {
<a id=__codelineno-159-6 name=__codelineno-159-6 href=#__codelineno-159-6></a>              // 若env.gitlabBranch为空，则为手动触发执行手动 stage,若不为空，之前同级的另外一个stage
<a id=__codelineno-159-7 name=__codelineno-159-7 href=#__codelineno-159-7></a>              env.gitlabBranch == null
<a id=__codelineno-159-8 name=__codelineno-159-8 href=#__codelineno-159-8></a>            }
<a id=__codelineno-159-9 name=__codelineno-159-9 href=#__codelineno-159-9></a>
<a id=__codelineno-159-10 name=__codelineno-159-10 href=#__codelineno-159-10></a>          }
<a id=__codelineno-159-11 name=__codelineno-159-11 href=#__codelineno-159-11></a>          steps {
<a id=__codelineno-159-12 name=__codelineno-159-12 href=#__codelineno-159-12></a>            git(changelog: true, poll: true, url: &#39;http://gitlab.runjs.cn:8929/kubernetes/spring-boot-project.git&#39;, branch: &quot;${BRANCH}&quot;, credentialsId: &quot;${GITLAB_AUTH}&quot;)
<a id=__codelineno-159-13 name=__codelineno-159-13 href=#__codelineno-159-13></a>            script {
<a id=__codelineno-159-14 name=__codelineno-159-14 href=#__codelineno-159-14></a>              // 定义变量用于生成镜像的Tag
<a id=__codelineno-159-15 name=__codelineno-159-15 href=#__codelineno-159-15></a>              // 获取最近一次提交的Commit ID
<a id=__codelineno-159-16 name=__codelineno-159-16 href=#__codelineno-159-16></a>              COMMIT_ID = sh(returnStdout: true, script: &quot;git log -n 1 --pretty=format:&#39;%h&#39;&quot;).trim()
<a id=__codelineno-159-17 name=__codelineno-159-17 href=#__codelineno-159-17></a>              // 赋值给TAG变量，后面的docker build可以获取到该TAG的值
<a id=__codelineno-159-18 name=__codelineno-159-18 href=#__codelineno-159-18></a>              TAG = BUILD_TAG + &#39;-&#39; + COMMIT_ID
<a id=__codelineno-159-19 name=__codelineno-159-19 href=#__codelineno-159-19></a>              println &quot;Current branch is ${BRANCH}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}&quot;
<a id=__codelineno-159-20 name=__codelineno-159-20 href=#__codelineno-159-20></a>
<a id=__codelineno-159-21 name=__codelineno-159-21 href=#__codelineno-159-21></a>            }
<a id=__codelineno-159-22 name=__codelineno-159-22 href=#__codelineno-159-22></a>
<a id=__codelineno-159-23 name=__codelineno-159-23 href=#__codelineno-159-23></a>          }
<a id=__codelineno-159-24 name=__codelineno-159-24 href=#__codelineno-159-24></a>        }
<a id=__codelineno-159-25 name=__codelineno-159-25 href=#__codelineno-159-25></a>        stage(&#39;Pulling Code by trigger&#39;) {
<a id=__codelineno-159-26 name=__codelineno-159-26 href=#__codelineno-159-26></a>          when {
<a id=__codelineno-159-27 name=__codelineno-159-27 href=#__codelineno-159-27></a>            expression {
<a id=__codelineno-159-28 name=__codelineno-159-28 href=#__codelineno-159-28></a>              // 若env.gitlabBranch不为空，则为webook触发的执行webook stage。上面的stage不执行，此时BRANCH变量为空
<a id=__codelineno-159-29 name=__codelineno-159-29 href=#__codelineno-159-29></a>              env.gitlabBranch != null
<a id=__codelineno-159-30 name=__codelineno-159-30 href=#__codelineno-159-30></a>            }
<a id=__codelineno-159-31 name=__codelineno-159-31 href=#__codelineno-159-31></a>
<a id=__codelineno-159-32 name=__codelineno-159-32 href=#__codelineno-159-32></a>          }
<a id=__codelineno-159-33 name=__codelineno-159-33 href=#__codelineno-159-33></a>          steps {
<a id=__codelineno-159-34 name=__codelineno-159-34 href=#__codelineno-159-34></a>            git(url: &#39;http://gitlab.runjs.cn:8929/kubernetes/spring-boot-project.git&#39;, branch: env.gitlabBranch, changelog: true, poll: true, credentialsId: &quot;${GITLAB_AUTH}&quot;)
<a id=__codelineno-159-35 name=__codelineno-159-35 href=#__codelineno-159-35></a>            script {
<a id=__codelineno-159-36 name=__codelineno-159-36 href=#__codelineno-159-36></a>              COMMIT_ID = sh(returnStdout: true, script: &quot;git log -n 1 --pretty=format:&#39;%h&#39;&quot;).trim()
<a id=__codelineno-159-37 name=__codelineno-159-37 href=#__codelineno-159-37></a>              TAG = BUILD_TAG + &#39;-&#39; + COMMIT_ID
<a id=__codelineno-159-38 name=__codelineno-159-38 href=#__codelineno-159-38></a>              println &quot;Current branch is ${env.gitlabBranch}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}&quot;
<a id=__codelineno-159-39 name=__codelineno-159-39 href=#__codelineno-159-39></a>              }
<a id=__codelineno-159-40 name=__codelineno-159-40 href=#__codelineno-159-40></a>            }
<a id=__codelineno-159-41 name=__codelineno-159-41 href=#__codelineno-159-41></a>          }
<a id=__codelineno-159-42 name=__codelineno-159-42 href=#__codelineno-159-42></a>        }
<a id=__codelineno-159-43 name=__codelineno-159-43 href=#__codelineno-159-43></a>      }
</code></pre></div> <p>代码拉下来后，就可以执行构建命令，由于本次实验是Java示例，因此需要使用mvn命令进行构建：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-160-1 name=__codelineno-160-1 href=#__codelineno-160-1></a>    stage(&#39;Building&#39;) {
<a id=__codelineno-160-2 name=__codelineno-160-2 href=#__codelineno-160-2></a>      steps {
<a id=__codelineno-160-3 name=__codelineno-160-3 href=#__codelineno-160-3></a>        # 使用pod模板里面build容器进行构建
<a id=__codelineno-160-4 name=__codelineno-160-4 href=#__codelineno-160-4></a>        container(name: &#39;build&#39;) {
<a id=__codelineno-160-5 name=__codelineno-160-5 href=#__codelineno-160-5></a>            sh &quot;&quot;&quot; 
<a id=__codelineno-160-6 name=__codelineno-160-6 href=#__codelineno-160-6></a>              # 编译命令，需要根据自己的实际情况进行修改
<a id=__codelineno-160-7 name=__codelineno-160-7 href=#__codelineno-160-7></a>              mvn clean install -DskipTests
<a id=__codelineno-160-8 name=__codelineno-160-8 href=#__codelineno-160-8></a>              # 完成构建后一般会在target目录生产jar包
<a id=__codelineno-160-9 name=__codelineno-160-9 href=#__codelineno-160-9></a>              ls target/*
<a id=__codelineno-160-10 name=__codelineno-160-10 href=#__codelineno-160-10></a>            &quot;&quot;&quot;
<a id=__codelineno-160-11 name=__codelineno-160-11 href=#__codelineno-160-11></a>        }
<a id=__codelineno-160-12 name=__codelineno-160-12 href=#__codelineno-160-12></a>      }
<a id=__codelineno-160-13 name=__codelineno-160-13 href=#__codelineno-160-13></a>    }
</code></pre></div> <p>生成编译产物后，需要根据该产物生成对应的镜像,并将镜像推送到harbor私有仓库：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-161-1 name=__codelineno-161-1 href=#__codelineno-161-1></a>    stage(&#39;Docker build for creating image&#39;) {
<a id=__codelineno-161-2 name=__codelineno-161-2 href=#__codelineno-161-2></a>      steps {
<a id=__codelineno-161-3 name=__codelineno-161-3 href=#__codelineno-161-3></a>        withCredentials([[$class: &#39;UsernamePasswordMultiBinding&#39;,
<a id=__codelineno-161-4 name=__codelineno-161-4 href=#__codelineno-161-4></a>        credentialsId: &quot;${HARBOR_AUTH}&quot;,
<a id=__codelineno-161-5 name=__codelineno-161-5 href=#__codelineno-161-5></a>        usernameVariable: &#39;Harbor_user&#39;,
<a id=__codelineno-161-6 name=__codelineno-161-6 href=#__codelineno-161-6></a>        passwordVariable: &#39;Harbor_password&#39;]]) {
<a id=__codelineno-161-7 name=__codelineno-161-7 href=#__codelineno-161-7></a>            sh &quot;&quot;&quot;#!/bin/bash
<a id=__codelineno-161-8 name=__codelineno-161-8 href=#__codelineno-161-8></a>              set -eux
<a id=__codelineno-161-9 name=__codelineno-161-9 href=#__codelineno-161-9></a>              # 登录Harbor
<a id=__codelineno-161-10 name=__codelineno-161-10 href=#__codelineno-161-10></a>              docker login -u ${Harbor_user} -p ${Harbor_password} ${HARBOR_ADDRESS}
<a id=__codelineno-161-11 name=__codelineno-161-11 href=#__codelineno-161-11></a>
<a id=__codelineno-161-12 name=__codelineno-161-12 href=#__codelineno-161-12></a>              # Dockerfile放在代码仓和Jenkinsfile同级
<a id=__codelineno-161-13 name=__codelineno-161-13 href=#__codelineno-161-13></a>              docker build --no-cache -t ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG} .
<a id=__codelineno-161-14 name=__codelineno-161-14 href=#__codelineno-161-14></a>
<a id=__codelineno-161-15 name=__codelineno-161-15 href=#__codelineno-161-15></a>              # 推送镜像至私有harbor仓库
<a id=__codelineno-161-16 name=__codelineno-161-16 href=#__codelineno-161-16></a>              docker push ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG}
<a id=__codelineno-161-17 name=__codelineno-161-17 href=#__codelineno-161-17></a>              docker rmi -f ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG}
<a id=__codelineno-161-18 name=__codelineno-161-18 href=#__codelineno-161-18></a>              &quot;&quot;&quot;
<a id=__codelineno-161-19 name=__codelineno-161-19 href=#__codelineno-161-19></a>        }
<a id=__codelineno-161-20 name=__codelineno-161-20 href=#__codelineno-161-20></a>      }
<a id=__codelineno-161-21 name=__codelineno-161-21 href=#__codelineno-161-21></a>    }
</code></pre></div> <p>最后一步就是将该镜像发版至Kubernetes集群中，此时使用的是包含kubectl命令的容器：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-162-1 name=__codelineno-162-1 href=#__codelineno-162-1></a>    stage(&#39;Deploying to K8s&#39;) {
<a id=__codelineno-162-2 name=__codelineno-162-2 href=#__codelineno-162-2></a>      steps {
<a id=__codelineno-162-3 name=__codelineno-162-3 href=#__codelineno-162-3></a>           sh &quot;&quot;&quot;#!/bin/bash
<a id=__codelineno-162-4 name=__codelineno-162-4 href=#__codelineno-162-4></a>           set -ux
<a id=__codelineno-162-5 name=__codelineno-162-5 href=#__codelineno-162-5></a>
<a id=__codelineno-162-6 name=__codelineno-162-6 href=#__codelineno-162-6></a>           # set更新deployment镜像
<a id=__codelineno-162-7 name=__codelineno-162-7 href=#__codelineno-162-7></a>           kubectl set image deploy -l app=${IMAGE_NAME} ${IMAGE_NAME}=${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG} -n $NAMESPACE
<a id=__codelineno-162-8 name=__codelineno-162-8 href=#__codelineno-162-8></a>           &quot;&quot;&quot;
<a id=__codelineno-162-9 name=__codelineno-162-9 href=#__codelineno-162-9></a>      }
<a id=__codelineno-162-10 name=__codelineno-162-10 href=#__codelineno-162-10></a>    }
</code></pre></div> <ul> <li>Java项目部署到kubernetes示例代码</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-163-1 name=__codelineno-163-1 href=#__codelineno-163-1></a>// 公共
<a id=__codelineno-163-2 name=__codelineno-163-2 href=#__codelineno-163-2></a>def registry = &quot;wangzilong.top:9003&quot;
<a id=__codelineno-163-3 name=__codelineno-163-3 href=#__codelineno-163-3></a>// 项目
<a id=__codelineno-163-4 name=__codelineno-163-4 href=#__codelineno-163-4></a>def project = &quot;library&quot;
<a id=__codelineno-163-5 name=__codelineno-163-5 href=#__codelineno-163-5></a>def app_name = &quot;java-demo&quot;
<a id=__codelineno-163-6 name=__codelineno-163-6 href=#__codelineno-163-6></a>def image_name = &quot;${registry}/${project}/${app_name}:${BUILD_NUMBER}&quot;
<a id=__codelineno-163-7 name=__codelineno-163-7 href=#__codelineno-163-7></a>def git_address = &quot;https://gitee.com/wangzilong9570/devopsdemo.git&quot;
<a id=__codelineno-163-8 name=__codelineno-163-8 href=#__codelineno-163-8></a>// 认证
<a id=__codelineno-163-9 name=__codelineno-163-9 href=#__codelineno-163-9></a>def secret_name = &quot;registry-auth&quot;
<a id=__codelineno-163-10 name=__codelineno-163-10 href=#__codelineno-163-10></a>def harbor_auth = &quot;e59aef57-3631-487c-9af4-0432a4581d83&quot;
<a id=__codelineno-163-11 name=__codelineno-163-11 href=#__codelineno-163-11></a>def git_auth = &quot;b6d473b8-a8bc-4029-979e-07c0b386c798&quot;
<a id=__codelineno-163-12 name=__codelineno-163-12 href=#__codelineno-163-12></a>def k8s_auth = &quot;76b249bf-f2e1-4ca7-9620-860c111ed0c3&quot;
<a id=__codelineno-163-13 name=__codelineno-163-13 href=#__codelineno-163-13></a>
<a id=__codelineno-163-14 name=__codelineno-163-14 href=#__codelineno-163-14></a>pipeline {
<a id=__codelineno-163-15 name=__codelineno-163-15 href=#__codelineno-163-15></a>  agent { 
<a id=__codelineno-163-16 name=__codelineno-163-16 href=#__codelineno-163-16></a>      label &quot;jenkins-slave&quot; 
<a id=__codelineno-163-17 name=__codelineno-163-17 href=#__codelineno-163-17></a>      }
<a id=__codelineno-163-18 name=__codelineno-163-18 href=#__codelineno-163-18></a>    parameters {    
<a id=__codelineno-163-19 name=__codelineno-163-19 href=#__codelineno-163-19></a>        gitParameter branch: &#39;&#39;, branchFilter: &#39;.*&#39;, defaultValue: &#39;master&#39;, description: &#39;选择发布的分支&#39;, name: &#39;Branch&#39;, quickFilterEnabled: false, selectedValue: &#39;NONE&#39;, sortMode: &#39;NONE&#39;, tagFilter: &#39;*&#39;, type: &#39;PT_BRANCH&#39;
<a id=__codelineno-163-20 name=__codelineno-163-20 href=#__codelineno-163-20></a>        choice (choices: [&#39;1&#39;, &#39;3&#39;, &#39;5&#39;, &#39;7&#39;], description: &#39;副本数&#39;, name: &#39;ReplicaCount&#39;)
<a id=__codelineno-163-21 name=__codelineno-163-21 href=#__codelineno-163-21></a>        choice (choices: [&#39;default&#39;,&#39;dev&#39;,&#39;test&#39;,&#39;prod&#39;], description: &#39;命名空间&#39;, name: &#39;Namespace&#39;)
<a id=__codelineno-163-22 name=__codelineno-163-22 href=#__codelineno-163-22></a>    }
<a id=__codelineno-163-23 name=__codelineno-163-23 href=#__codelineno-163-23></a>    stages {
<a id=__codelineno-163-24 name=__codelineno-163-24 href=#__codelineno-163-24></a>        stage(&#39;拉取代码&#39;){
<a id=__codelineno-163-25 name=__codelineno-163-25 href=#__codelineno-163-25></a>            steps {
<a id=__codelineno-163-26 name=__codelineno-163-26 href=#__codelineno-163-26></a>                container(&#39;jenkins-build&#39;){
<a id=__codelineno-163-27 name=__codelineno-163-27 href=#__codelineno-163-27></a>                    checkout([$class: &#39;GitSCM&#39;, 
<a id=__codelineno-163-28 name=__codelineno-163-28 href=#__codelineno-163-28></a>                    branches: [[name: &quot;${params.Branch}&quot;]], 
<a id=__codelineno-163-29 name=__codelineno-163-29 href=#__codelineno-163-29></a>                    doGenerateSubmoduleConfigurations: false, 
<a id=__codelineno-163-30 name=__codelineno-163-30 href=#__codelineno-163-30></a>                    extensions: [], submoduleCfg: [], 
<a id=__codelineno-163-31 name=__codelineno-163-31 href=#__codelineno-163-31></a>                    userRemoteConfigs: [[credentialsId: &quot;${git_auth}&quot;, url: &quot;${git_address}&quot;]]
<a id=__codelineno-163-32 name=__codelineno-163-32 href=#__codelineno-163-32></a>                    ])
<a id=__codelineno-163-33 name=__codelineno-163-33 href=#__codelineno-163-33></a>                }
<a id=__codelineno-163-34 name=__codelineno-163-34 href=#__codelineno-163-34></a>            }
<a id=__codelineno-163-35 name=__codelineno-163-35 href=#__codelineno-163-35></a>        }
<a id=__codelineno-163-36 name=__codelineno-163-36 href=#__codelineno-163-36></a>
<a id=__codelineno-163-37 name=__codelineno-163-37 href=#__codelineno-163-37></a>        stage(&#39;代码编译&#39;){
<a id=__codelineno-163-38 name=__codelineno-163-38 href=#__codelineno-163-38></a>           steps {
<a id=__codelineno-163-39 name=__codelineno-163-39 href=#__codelineno-163-39></a>             container(&#39;jenkins-build&#39;){
<a id=__codelineno-163-40 name=__codelineno-163-40 href=#__codelineno-163-40></a>               sh &quot;&quot;&quot;
<a id=__codelineno-163-41 name=__codelineno-163-41 href=#__codelineno-163-41></a>                  mvn clean package -Dmaven.test.skip=true
<a id=__codelineno-163-42 name=__codelineno-163-42 href=#__codelineno-163-42></a>                  &quot;&quot;&quot; 
<a id=__codelineno-163-43 name=__codelineno-163-43 href=#__codelineno-163-43></a>                }
<a id=__codelineno-163-44 name=__codelineno-163-44 href=#__codelineno-163-44></a>                        }
<a id=__codelineno-163-45 name=__codelineno-163-45 href=#__codelineno-163-45></a>        }
<a id=__codelineno-163-46 name=__codelineno-163-46 href=#__codelineno-163-46></a>
<a id=__codelineno-163-47 name=__codelineno-163-47 href=#__codelineno-163-47></a>        stage(&#39;构建镜像&#39;){
<a id=__codelineno-163-48 name=__codelineno-163-48 href=#__codelineno-163-48></a>           steps {
<a id=__codelineno-163-49 name=__codelineno-163-49 href=#__codelineno-163-49></a>                container(&#39;jenkins-build&#39;){
<a id=__codelineno-163-50 name=__codelineno-163-50 href=#__codelineno-163-50></a>                withCredentials([usernamePassword(credentialsId: &quot;${harbor_auth}&quot;, passwordVariable: &#39;password&#39;, usernameVariable: &#39;username&#39;)]) {
<a id=__codelineno-163-51 name=__codelineno-163-51 href=#__codelineno-163-51></a>                sh &quot;&quot;&quot;
<a id=__codelineno-163-52 name=__codelineno-163-52 href=#__codelineno-163-52></a>                  unzip target/*.war -d target/ROOT  
<a id=__codelineno-163-53 name=__codelineno-163-53 href=#__codelineno-163-53></a>                  echo &#39;
<a id=__codelineno-163-54 name=__codelineno-163-54 href=#__codelineno-163-54></a>                    FROM lizhenliang/tomcat
<a id=__codelineno-163-55 name=__codelineno-163-55 href=#__codelineno-163-55></a>                    LABEL maitainer wangzilong
<a id=__codelineno-163-56 name=__codelineno-163-56 href=#__codelineno-163-56></a>                    ADD target/ROOT /usr/local/tomcat/webapps/ROOT
<a id=__codelineno-163-57 name=__codelineno-163-57 href=#__codelineno-163-57></a>                  &#39; &gt; Dockerfile
<a id=__codelineno-163-58 name=__codelineno-163-58 href=#__codelineno-163-58></a>                  docker build -t ${image_name} .
<a id=__codelineno-163-59 name=__codelineno-163-59 href=#__codelineno-163-59></a>                  docker login -u ${username} -p &#39;${password}&#39; ${registry}
<a id=__codelineno-163-60 name=__codelineno-163-60 href=#__codelineno-163-60></a>                  docker push ${image_name}
<a id=__codelineno-163-61 name=__codelineno-163-61 href=#__codelineno-163-61></a>                &quot;&quot;&quot;
<a id=__codelineno-163-62 name=__codelineno-163-62 href=#__codelineno-163-62></a>                }
<a id=__codelineno-163-63 name=__codelineno-163-63 href=#__codelineno-163-63></a>                            }
<a id=__codelineno-163-64 name=__codelineno-163-64 href=#__codelineno-163-64></a>           } 
<a id=__codelineno-163-65 name=__codelineno-163-65 href=#__codelineno-163-65></a>        }
<a id=__codelineno-163-66 name=__codelineno-163-66 href=#__codelineno-163-66></a>        stage(&#39;部署到K8S平台&#39;){
<a id=__codelineno-163-67 name=__codelineno-163-67 href=#__codelineno-163-67></a>          steps {
<a id=__codelineno-163-68 name=__codelineno-163-68 href=#__codelineno-163-68></a>                container(&#39;jenkins-build&#39;){
<a id=__codelineno-163-69 name=__codelineno-163-69 href=#__codelineno-163-69></a>              configFileProvider([configFile(fileId: &quot;${k8s_auth}&quot;, targetLocation: &quot;admin.kubeconfig&quot;)]){
<a id=__codelineno-163-70 name=__codelineno-163-70 href=#__codelineno-163-70></a>                sh &quot;&quot;&quot;
<a id=__codelineno-163-71 name=__codelineno-163-71 href=#__codelineno-163-71></a>                  sed -i &#39;s#IMAGE_NAME#${image_name}#&#39; deployment.yaml
<a id=__codelineno-163-72 name=__codelineno-163-72 href=#__codelineno-163-72></a>                  sed -i &#39;s#SECRET_NAME#${secret_name}#&#39; deployment.yaml
<a id=__codelineno-163-73 name=__codelineno-163-73 href=#__codelineno-163-73></a>                  sed -i &#39;s#REPLICAS#${ReplicaCount}#&#39; deployment.yaml
<a id=__codelineno-163-74 name=__codelineno-163-74 href=#__codelineno-163-74></a>                  chmod u+x /usr/bin/kubectl
<a id=__codelineno-163-75 name=__codelineno-163-75 href=#__codelineno-163-75></a>                  kubectl apply -f deployment.yaml -n ${Namespace} --kubeconfig=admin.kubeconfig
<a id=__codelineno-163-76 name=__codelineno-163-76 href=#__codelineno-163-76></a>                &quot;&quot;&quot;
<a id=__codelineno-163-77 name=__codelineno-163-77 href=#__codelineno-163-77></a>              }
<a id=__codelineno-163-78 name=__codelineno-163-78 href=#__codelineno-163-78></a>                        }
<a id=__codelineno-163-79 name=__codelineno-163-79 href=#__codelineno-163-79></a>          }
<a id=__codelineno-163-80 name=__codelineno-163-80 href=#__codelineno-163-80></a>        }
<a id=__codelineno-163-81 name=__codelineno-163-81 href=#__codelineno-163-81></a>    }
<a id=__codelineno-163-82 name=__codelineno-163-82 href=#__codelineno-163-82></a>}
</code></pre></div> <h3 id=65-定义dockerfile>6.5 定义Dockerfile<a class=headerlink href=#65-定义dockerfile title="Permanent link">&para;</a></h3> <p>在执行流水线过程时，需要将代码的编译产物做成镜像。Dockerfile主要写的是如何生成公司业务的镜像，而本示例是Java项目，只需要把JAR包放在有JRE环境的镜像中，然后启动该JAR包即可：</p> <p><code>Dockerfile</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-164-1 name=__codelineno-164-1 href=#__codelineno-164-1></a><span class=c># 基础镜像可以按需修改，可以更改为公司自有的镜像</span>
<a id=__codelineno-164-2 name=__codelineno-164-2 href=#__codelineno-164-2></a><span class=k>FROM</span><span class=w> </span><span class=s>registry.cn-beijing.aliyuncs.com/dotbalo/jre:8u211-data</span>
<a id=__codelineno-164-3 name=__codelineno-164-3 href=#__codelineno-164-3></a>
<a id=__codelineno-164-4 name=__codelineno-164-4 href=#__codelineno-164-4></a><span class=c># JAR包名称改成实际的名称，本示例为spring-cloud-eureka-0.0.1-SNAPSHOT.jar</span>
<a id=__codelineno-164-5 name=__codelineno-164-5 href=#__codelineno-164-5></a><span class=k>COPY</span><span class=w> </span>target/spring-cloud-eureka-0.0.1-SNAPSHOT.jar<span class=w> </span>./
<a id=__codelineno-164-6 name=__codelineno-164-6 href=#__codelineno-164-6></a>
<a id=__codelineno-164-7 name=__codelineno-164-7 href=#__codelineno-164-7></a><span class=c># 启动JAR包</span>
<a id=__codelineno-164-8 name=__codelineno-164-8 href=#__codelineno-164-8></a><span class=k>CMD</span><span class=w> </span>java<span class=w> </span>-jar<span class=w> </span>spring-cloud-eureka-0.0.1-SNAPSHOT.jar
</code></pre></div> <h3 id=66-定义kubernetes资源>6.6 定义Kubernetes资源<a class=headerlink href=#66-定义kubernetes资源 title="Permanent link">&para;</a></h3> <p>本书的示例在GitLab创建的Group为kubernetes，可以认为其是一个项目，同一个项目可以部署至Kubernetes集群中的同一个Namespace中，本示例 为kubernetes命名空间。由于使用的是私有仓库，因此需要先配置拉取私有仓库镜像的密钥：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-165-1 name=__codelineno-165-1 href=#__codelineno-165-1></a><span class=c1># kubectl create ns kubernetes</span>
<a id=__codelineno-165-2 name=__codelineno-165-2 href=#__codelineno-165-2></a>namespace/kubernetes<span class=w> </span>created
<a id=__codelineno-165-3 name=__codelineno-165-3 href=#__codelineno-165-3></a><span class=c1># kubectl -n kubernetes create secret docker-registry harborkey \</span>
<a id=__codelineno-165-4 name=__codelineno-165-4 href=#__codelineno-165-4></a>--docker-server<span class=o>=</span>http://hub.gitee.cc<span class=w> </span><span class=se>\</span>
<a id=__codelineno-165-5 name=__codelineno-165-5 href=#__codelineno-165-5></a>--docker-username<span class=o>=</span>admin<span class=w> </span><span class=se>\</span>
<a id=__codelineno-165-6 name=__codelineno-165-6 href=#__codelineno-165-6></a>--docker-password<span class=o>=</span>oschina123<span class=w> </span><span class=se>\</span>
<a id=__codelineno-165-7 name=__codelineno-165-7 href=#__codelineno-165-7></a>--docker-email<span class=o>=</span><span class=m>1</span>@2.com
</code></pre></div> <p>配置该应用的Deployment（部分内容），需要注意文件的文字注释部分：</p> <p><code>deployment.yaml</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-166-1 name=__codelineno-166-1 href=#__codelineno-166-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id=__codelineno-166-2 name=__codelineno-166-2 href=#__codelineno-166-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a id=__codelineno-166-3 name=__codelineno-166-3 href=#__codelineno-166-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-166-4 name=__codelineno-166-4 href=#__codelineno-166-4></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-166-5 name=__codelineno-166-5 href=#__codelineno-166-5></a><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">spring-boot-project</span>
<a id=__codelineno-166-6 name=__codelineno-166-6 href=#__codelineno-166-6></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">spring-boot-project</span>
<a id=__codelineno-166-7 name=__codelineno-166-7 href=#__codelineno-166-7></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
<a id=__codelineno-166-8 name=__codelineno-166-8 href=#__codelineno-166-8></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-166-9 name=__codelineno-166-9 href=#__codelineno-166-9></a><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-166-10 name=__codelineno-166-10 href=#__codelineno-166-10></a><span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
<a id=__codelineno-166-11 name=__codelineno-166-11 href=#__codelineno-166-11></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-166-12 name=__codelineno-166-12 href=#__codelineno-166-12></a><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">spring-boot-project</span>
<a id=__codelineno-166-13 name=__codelineno-166-13 href=#__codelineno-166-13></a><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span>
<a id=__codelineno-166-14 name=__codelineno-166-14 href=#__codelineno-166-14></a><span class=w>    </span><span class=nt>rollingUpdate</span><span class=p>:</span>
<a id=__codelineno-166-15 name=__codelineno-166-15 href=#__codelineno-166-15></a><span class=w>      </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-166-16 name=__codelineno-166-16 href=#__codelineno-166-16></a><span class=w>      </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<a id=__codelineno-166-17 name=__codelineno-166-17 href=#__codelineno-166-17></a><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
<a id=__codelineno-166-18 name=__codelineno-166-18 href=#__codelineno-166-18></a><span class=w>  </span><span class=nt>template</span><span class=p>:</span>
<a id=__codelineno-166-19 name=__codelineno-166-19 href=#__codelineno-166-19></a><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-166-20 name=__codelineno-166-20 href=#__codelineno-166-20></a><span class=w>      </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-166-21 name=__codelineno-166-21 href=#__codelineno-166-21></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">spring-boot-project</span>
<a id=__codelineno-166-22 name=__codelineno-166-22 href=#__codelineno-166-22></a><span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-166-23 name=__codelineno-166-23 href=#__codelineno-166-23></a><span class=w>      </span><span class=nt>containers</span><span class=p>:</span>
<a id=__codelineno-166-24 name=__codelineno-166-24 href=#__codelineno-166-24></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>env</span><span class=p>:</span>
<a id=__codelineno-166-25 name=__codelineno-166-25 href=#__codelineno-166-25></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TZ</span>
<a id=__codelineno-166-26 name=__codelineno-166-26 href=#__codelineno-166-26></a><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Asia/Shanghai</span>
<a id=__codelineno-166-27 name=__codelineno-166-27 href=#__codelineno-166-27></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">LANG</span>
<a id=__codelineno-166-28 name=__codelineno-166-28 href=#__codelineno-166-28></a><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">C.UTF-8</span>
<a id=__codelineno-166-29 name=__codelineno-166-29 href=#__codelineno-166-29></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">hub.gitee.cc/kubernetes/spring-boot-project:jenkins-spring-boot-project-2-e9ddd5d</span>
<a id=__codelineno-166-30 name=__codelineno-166-30 href=#__codelineno-166-30></a><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
<a id=__codelineno-166-31 name=__codelineno-166-31 href=#__codelineno-166-31></a><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span>
<a id=__codelineno-166-32 name=__codelineno-166-32 href=#__codelineno-166-32></a><span class=w>          </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a id=__codelineno-166-33 name=__codelineno-166-33 href=#__codelineno-166-33></a><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<a id=__codelineno-166-34 name=__codelineno-166-34 href=#__codelineno-166-34></a><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<a id=__codelineno-166-35 name=__codelineno-166-35 href=#__codelineno-166-35></a><span class=w>          </span><span class=nt>successThreshold</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-166-36 name=__codelineno-166-36 href=#__codelineno-166-36></a><span class=w>          </span><span class=nt>tcpSocket</span><span class=p>:</span>
<a id=__codelineno-166-37 name=__codelineno-166-37 href=#__codelineno-166-37></a><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8761</span>
<a id=__codelineno-166-38 name=__codelineno-166-38 href=#__codelineno-166-38></a><span class=w>          </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a id=__codelineno-166-39 name=__codelineno-166-39 href=#__codelineno-166-39></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">spring-boot-project</span>
<a id=__codelineno-166-40 name=__codelineno-166-40 href=#__codelineno-166-40></a><span class=w>        </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-166-41 name=__codelineno-166-41 href=#__codelineno-166-41></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8761</span>
<a id=__codelineno-166-42 name=__codelineno-166-42 href=#__codelineno-166-42></a><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<a id=__codelineno-166-43 name=__codelineno-166-43 href=#__codelineno-166-43></a><span class=w>          </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<a id=__codelineno-166-44 name=__codelineno-166-44 href=#__codelineno-166-44></a><span class=w>        </span><span class=nt>resources</span><span class=p>:</span>
<a id=__codelineno-166-45 name=__codelineno-166-45 href=#__codelineno-166-45></a><span class=w>          </span><span class=nt>limits</span><span class=p>:</span>
<a id=__codelineno-166-46 name=__codelineno-166-46 href=#__codelineno-166-46></a><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">994m</span>
<a id=__codelineno-166-47 name=__codelineno-166-47 href=#__codelineno-166-47></a><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2170Mi</span>
<a id=__codelineno-166-48 name=__codelineno-166-48 href=#__codelineno-166-48></a><span class=w>          </span><span class=nt>requests</span><span class=p>:</span>
<a id=__codelineno-166-49 name=__codelineno-166-49 href=#__codelineno-166-49></a><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10m</span>
<a id=__codelineno-166-50 name=__codelineno-166-50 href=#__codelineno-166-50></a><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">55Mi</span>
<a id=__codelineno-166-51 name=__codelineno-166-51 href=#__codelineno-166-51></a><span class=w>      </span><span class=nt>dnsPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterFirst</span>
<a id=__codelineno-166-52 name=__codelineno-166-52 href=#__codelineno-166-52></a><span class=w>      </span><span class=nt>imagePullSecrets</span><span class=p>:</span>
<a id=__codelineno-166-53 name=__codelineno-166-53 href=#__codelineno-166-53></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">harborkey</span>
<a id=__codelineno-166-54 name=__codelineno-166-54 href=#__codelineno-166-54></a><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<a id=__codelineno-166-55 name=__codelineno-166-55 href=#__codelineno-166-55></a><span class=w>      </span><span class=nt>securityContext</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span>
<a id=__codelineno-166-56 name=__codelineno-166-56 href=#__codelineno-166-56></a><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</code></pre></div> <p>定义该应用的Service和Ingress：</p> <p><code>spring-boot-project-svc-ingress.yaml</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-167-1 name=__codelineno-167-1 href=#__codelineno-167-1></a><span class=nn>---</span>
<a id=__codelineno-167-2 name=__codelineno-167-2 href=#__codelineno-167-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-167-3 name=__codelineno-167-3 href=#__codelineno-167-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<a id=__codelineno-167-4 name=__codelineno-167-4 href=#__codelineno-167-4></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-167-5 name=__codelineno-167-5 href=#__codelineno-167-5></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-167-6 name=__codelineno-167-6 href=#__codelineno-167-6></a><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">spring-boot-project</span>
<a id=__codelineno-167-7 name=__codelineno-167-7 href=#__codelineno-167-7></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">spring-boot-project</span>
<a id=__codelineno-167-8 name=__codelineno-167-8 href=#__codelineno-167-8></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
<a id=__codelineno-167-9 name=__codelineno-167-9 href=#__codelineno-167-9></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-167-10 name=__codelineno-167-10 href=#__codelineno-167-10></a><span class=w>  </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-167-11 name=__codelineno-167-11 href=#__codelineno-167-11></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<a id=__codelineno-167-12 name=__codelineno-167-12 href=#__codelineno-167-12></a><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8761</span>
<a id=__codelineno-167-13 name=__codelineno-167-13 href=#__codelineno-167-13></a><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<a id=__codelineno-167-14 name=__codelineno-167-14 href=#__codelineno-167-14></a><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8761</span>
<a id=__codelineno-167-15 name=__codelineno-167-15 href=#__codelineno-167-15></a><span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
<a id=__codelineno-167-16 name=__codelineno-167-16 href=#__codelineno-167-16></a><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">spring-boot-project</span>
<a id=__codelineno-167-17 name=__codelineno-167-17 href=#__codelineno-167-17></a><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
<a id=__codelineno-167-18 name=__codelineno-167-18 href=#__codelineno-167-18></a><span class=nn>---</span>
<a id=__codelineno-167-19 name=__codelineno-167-19 href=#__codelineno-167-19></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<a id=__codelineno-167-20 name=__codelineno-167-20 href=#__codelineno-167-20></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<a id=__codelineno-167-21 name=__codelineno-167-21 href=#__codelineno-167-21></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-167-22 name=__codelineno-167-22 href=#__codelineno-167-22></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">spring-boot-project</span>
<a id=__codelineno-167-23 name=__codelineno-167-23 href=#__codelineno-167-23></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
<a id=__codelineno-167-24 name=__codelineno-167-24 href=#__codelineno-167-24></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-167-25 name=__codelineno-167-25 href=#__codelineno-167-25></a><span class=w>  </span><span class=nt>ingressClassName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id=__codelineno-167-26 name=__codelineno-167-26 href=#__codelineno-167-26></a><span class=w>  </span><span class=nt>rules</span><span class=p>:</span>
<a id=__codelineno-167-27 name=__codelineno-167-27 href=#__codelineno-167-27></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">spring-boot-project.test.com</span>
<a id=__codelineno-167-28 name=__codelineno-167-28 href=#__codelineno-167-28></a><span class=w>    </span><span class=nt>http</span><span class=p>:</span>
<a id=__codelineno-167-29 name=__codelineno-167-29 href=#__codelineno-167-29></a><span class=w>      </span><span class=nt>paths</span><span class=p>:</span>
<a id=__codelineno-167-30 name=__codelineno-167-30 href=#__codelineno-167-30></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>backend</span><span class=p>:</span>
<a id=__codelineno-167-31 name=__codelineno-167-31 href=#__codelineno-167-31></a><span class=w>          </span><span class=nt>service</span><span class=p>:</span>
<a id=__codelineno-167-32 name=__codelineno-167-32 href=#__codelineno-167-32></a><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">spring-boot-project</span>
<a id=__codelineno-167-33 name=__codelineno-167-33 href=#__codelineno-167-33></a><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span>
<a id=__codelineno-167-34 name=__codelineno-167-34 href=#__codelineno-167-34></a><span class=w>              </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8761</span>
<a id=__codelineno-167-35 name=__codelineno-167-35 href=#__codelineno-167-35></a><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<a id=__codelineno-167-36 name=__codelineno-167-36 href=#__codelineno-167-36></a><span class=w>        </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ImplementationSpecific</span>
</code></pre></div> <p>需要注意的是，在实际使用时，Java一般是后台应用，不需要使用Ingress暴露出去，只需要配置Service即可。</p> <p>如果需要被集群外部的用户直接访问，需要配置Ingress，通过域名发布。</p> <p>创建该资源：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-168-1 name=__codelineno-168-1 href=#__codelineno-168-1></a>$<span class=w> </span>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>deployment.yaml
<a id=__codelineno-168-2 name=__codelineno-168-2 href=#__codelineno-168-2></a>$<span class=w> </span>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>spring-boot-project-svc-ingress.yaml
<a id=__codelineno-168-3 name=__codelineno-168-3 href=#__codelineno-168-3></a>service/spring-boot-project<span class=w> </span>created
<a id=__codelineno-168-4 name=__codelineno-168-4 href=#__codelineno-168-4></a>ingress.networking.k8s.io/spring-boot-project<span class=w> </span>created
</code></pre></div> <div class="admonition tip"> <p class=admonition-title>提示</p> <blockquote> <p>由于在Harbor已经配置了Kubernetes的项目目录，在此不再重复创建，如果需要将镜像推送至其他目录，按照同样的步 骤创建即可。</p> </blockquote> </div> <h3 id=67-创建jenkins任务>6.7 创建Jenkins任务<a class=headerlink href=#67-创建jenkins任务 title="Permanent link">&para;</a></h3> <p>单击首页的创建任务（Job）选项（或者New Item）并配置任务信息，输入Job的名称（一般和GitLab的仓库名字一致，以便于区分），类型为Pipeline，最后单击OK。</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-37.png></p> <p>在新页面单击Pipeline，输入Git仓库地址，选择之前配置的GitLab 账号密码Key，分支为master，单击Save。</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-38.png></p> <p>第一次构建也会失败，第二次可以选择分支构建，之后单击Build，然后单击Build History的进度条，即可查看构建日志。</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-39.png></p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-40.png></p> <p>构建日志上部分为创建Pod的日志，可以看到Pod为Agent指定的Pod，如图</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-41.png></p> <p>如果是Java应用，可以看到BUILD SUCCESS，说明mvn编译已经通过，如图 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-42.png></p> <p>编译结束后，可以看到制作镜像的日志，之后镜像被推送至Harbor，最后发版至Kubernetes。 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-43.png></p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-44.png></p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-45.png></p> <p>出现Finished：SUCCESS说明该流水线正常结束。接下来可以查看Deployment的镜像：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-169-1 name=__codelineno-169-1 href=#__codelineno-169-1></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>deploy<span class=w> </span>-n<span class=w> </span>kubernetes<span class=w> </span>spring-boot-project<span class=w> </span>-o<span class=w> </span>yaml<span class=p>|</span>grep<span class=w> </span><span class=s2>&quot;image: &quot;</span>
<a id=__codelineno-169-2 name=__codelineno-169-2 href=#__codelineno-169-2></a><span class=w>        </span>image:<span class=w> </span>hub.gitee.cc/kubernetes/spring-boot-project:jenkins-spring-boot-project-5-adf694c
<a id=__codelineno-169-3 name=__codelineno-169-3 href=#__codelineno-169-3></a>
<a id=__codelineno-169-4 name=__codelineno-169-4 href=#__codelineno-169-4></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pod<span class=w> </span>-n<span class=w> </span>kubernetes
<a id=__codelineno-169-5 name=__codelineno-169-5 href=#__codelineno-169-5></a>NAME<span class=w>                                   </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>        </span>AGE
<a id=__codelineno-169-6 name=__codelineno-169-6 href=#__codelineno-169-6></a>spring-boot-project-65f88c8f6b-l89sl<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>1</span><span class=w> </span><span class=o>(</span>7m34s<span class=w> </span>ago<span class=o>)</span><span class=w>   </span>8m24s
</code></pre></div> <p><strong>注意</strong></p> <blockquote> <p>该示例只是用Eureka的代码作为测试应用，如果是生产环境的Eureka，最好使用StatefulSet创建Eureka集群，因为StatefulSet会有一个固定的识符 ， 此时在Eureka的defaultZone配置如下：</p> <p>defaultZone:<a href=http://eureka-0.eureka:8761/eureka/ >http://eureka-0.eureka:8761/eureka/</a> 、 <a href=http://eureka-1.eureka:8761/eureka/ >http://eureka-1.eureka:8761/eureka/</a>、<a href=http://eureka-2.eureka:8761/eureka/ >http://eureka-2.eureka:8761/eureka/</a>，即可形成集群。</p> <p>其他的Spring Cloud模块可以通过该地址进行注册。</p> </blockquote> <h3 id=68-webhook自动触发构建>6.8 Webhook自动触发构建<a class=headerlink href=#68-webhook自动触发构建 title="Permanent link">&para;</a></h3> <p>之前的构建都是手动选择分支进行构建的，在实际使用时，项目可能有很多，如果都是手动触发，可能比较消耗人力。</p> <p>所以推荐按需配置自动触发，即提交代码后自动触发Jenkins构建任务。</p> <p>本次用Java项目进行演示。首先找到Java项目的Job，单击Configure，之后选择Build Triggers，勾选Build when a change…，</p> <p>记录webhook URL，之后单击Advanced，选择Allow all branches to trigger this job，</p> <p>如果不想任何分支都可以触发该流水线，可以选择Filter进行条件匹配。之后单击Generate生成Secret token，最后单击Save即可。</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-46.png></p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-47.png></p> <p>接下来配置GitLab，首先单击Menu→Admin选择Settings→Network，之后允许访问外部的请求。 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-48.png></p> <p>在Integrations配置页的相应输入框中粘贴上一步中Jenkins暴露的webhook及相应的Secret token如下：</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-49.png></p> <p>测试整个链路是否通了。在GitLab上添加好这个webhook后，可以跳到表单下方，有一个已添加的webhook列表，找到我们刚刚创建的webbook。单击“Test”按钮，选择“Pushevents”，GitLab就会向该webhook发送一个event。</p> <p>添加之后，可以点击一下test看看流程是否能够走通，如果走通，那么我们以后开发的时候直接推送代码即可触发构建。</p> <p>正常状态返回如下：</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-50.png></p> <p>也可以通过Blue Ocean看到是自动触发的stage被执行，如图</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-51.png></p> <p>新建Pull Request分支，提交代码测试CI触发。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-170-1 name=__codelineno-170-1 href=#__codelineno-170-1></a>$<span class=w> </span>git<span class=w> </span>clone<span class=w> </span>ssh://git@gitlab.runjs.cn:2224/kubernetes/spring-boot-project.git
<a id=__codelineno-170-2 name=__codelineno-170-2 href=#__codelineno-170-2></a>$<span class=w> </span><span class=nb>cd</span><span class=w> </span>spring-boot-project/
<a id=__codelineno-170-3 name=__codelineno-170-3 href=#__codelineno-170-3></a>$<span class=w> </span>git<span class=w> </span>checkout<span class=w> </span>-b<span class=w> </span>dev-hu
<a id=__codelineno-170-4 name=__codelineno-170-4 href=#__codelineno-170-4></a>$<span class=w> </span><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;test=hu&quot;</span><span class=w> </span>&gt;&gt;<span class=w> </span>README.md
<a id=__codelineno-170-5 name=__codelineno-170-5 href=#__codelineno-170-5></a>$<span class=w> </span>git<span class=w> </span>add<span class=w> </span>.
<a id=__codelineno-170-6 name=__codelineno-170-6 href=#__codelineno-170-6></a>$<span class=w> </span>git<span class=w> </span>commit<span class=w> </span>-m<span class=w> </span><span class=s2>&quot;hujianli test&quot;</span>
<a id=__codelineno-170-7 name=__codelineno-170-7 href=#__codelineno-170-7></a>$<span class=w> </span>git<span class=w> </span>push<span class=w> </span>--set-upstream<span class=w> </span>origin<span class=w> </span>dev-hu
</code></pre></div> <p>触发后手工执行中，出现可以选择Pull Request版本的信息。</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-52.png></p> <p>以上就是通过GitLab的事件触发Jenkins任务，在实际使用时，此功能非常常用，一般会用于开发、测试等环境，省去了手动构建的过程。</p> <p><mark>而在UAT和生产环境，一般不需要再次构建，而是选择其他环境产生的镜像进行发版。</mark></p> <h3 id=69-构建状态信息推送到gitlab>6.9 构建状态信息推送到GitLab<a class=headerlink href=#69-构建状态信息推送到gitlab title="Permanent link">&para;</a></h3> <p>先生成一个访问令牌，用于在jenkins的系统配置去配置连接gitlab的选项 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-53.png></p> <p>生成个人访问令牌。 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-54.png></p> <p>首先在jenkins上创建一个gitlab api token的凭证 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-55.png></p> <p>首先在<code>系统管理</code>-<code>系统配置</code>中配置好连接Gitlab的信息如下</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-56.png></p> <p><strong>在pipeline的post部分，将构建结果更新到GitLab的相应commit记录上</strong>。</p> <p>除此之外，还需要在**options部分加入gitLabConnection配置，同时传入"gitlab"参数**。"gitlab"就是<code>Connection name</code>的值。</p> <p>核心代码</p> <div class=highlight><pre><span></span><code><a id=__codelineno-171-1 name=__codelineno-171-1 href=#__codelineno-171-1></a>pipeline {
<a id=__codelineno-171-2 name=__codelineno-171-2 href=#__codelineno-171-2></a>    agent any
<a id=__codelineno-171-3 name=__codelineno-171-3 href=#__codelineno-171-3></a>    triggers {
<a id=__codelineno-171-4 name=__codelineno-171-4 href=#__codelineno-171-4></a>        gitlab(triggerOnPush: true,
<a id=__codelineno-171-5 name=__codelineno-171-5 href=#__codelineno-171-5></a>            triggerOnMergeRequest: true,
<a id=__codelineno-171-6 name=__codelineno-171-6 href=#__codelineno-171-6></a>            branchFilterType: &quot;All&quot;,
<a id=__codelineno-171-7 name=__codelineno-171-7 href=#__codelineno-171-7></a>            secretToken: &quot;t8vcxwuza023ehzcftzr5a74vkpto6xr&quot;)
<a id=__codelineno-171-8 name=__codelineno-171-8 href=#__codelineno-171-8></a>    }
<a id=__codelineno-171-9 name=__codelineno-171-9 href=#__codelineno-171-9></a>    stages {
<a id=__codelineno-171-10 name=__codelineno-171-10 href=#__codelineno-171-10></a>        stage(&#39;build&#39;) {
<a id=__codelineno-171-11 name=__codelineno-171-11 href=#__codelineno-171-11></a>            steps {
<a id=__codelineno-171-12 name=__codelineno-171-12 href=#__codelineno-171-12></a>                echo &#39;Hello World from gitlab trigger&#39;
<a id=__codelineno-171-13 name=__codelineno-171-13 href=#__codelineno-171-13></a>            }
<a id=__codelineno-171-14 name=__codelineno-171-14 href=#__codelineno-171-14></a>        }
<a id=__codelineno-171-15 name=__codelineno-171-15 href=#__codelineno-171-15></a>    }
<a id=__codelineno-171-16 name=__codelineno-171-16 href=#__codelineno-171-16></a>    post {
<a id=__codelineno-171-17 name=__codelineno-171-17 href=#__codelineno-171-17></a>        failure {
<a id=__codelineno-171-18 name=__codelineno-171-18 href=#__codelineno-171-18></a>            updateGitlabCommitStatus name: &quot;build&quot;, state: &quot;failed&quot;
<a id=__codelineno-171-19 name=__codelineno-171-19 href=#__codelineno-171-19></a>        }
<a id=__codelineno-171-20 name=__codelineno-171-20 href=#__codelineno-171-20></a>        success {
<a id=__codelineno-171-21 name=__codelineno-171-21 href=#__codelineno-171-21></a>            updateGitlabCommitStatus name: &quot;build&quot;, state: &quot;success&quot;
<a id=__codelineno-171-22 name=__codelineno-171-22 href=#__codelineno-171-22></a>        }
<a id=__codelineno-171-23 name=__codelineno-171-23 href=#__codelineno-171-23></a>    }
<a id=__codelineno-171-24 name=__codelineno-171-24 href=#__codelineno-171-24></a>    options {
<a id=__codelineno-171-25 name=__codelineno-171-25 href=#__codelineno-171-25></a>        gitLabConnection(&quot;gitlab&quot;)
<a id=__codelineno-171-26 name=__codelineno-171-26 href=#__codelineno-171-26></a>    }
<a id=__codelineno-171-27 name=__codelineno-171-27 href=#__codelineno-171-27></a>}
</code></pre></div> <p>提交代码后，需要手动触发一次构建，pipeline才会生效。</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-57.png></p> <div class="admonition example"> <p class=admonition-title>参考文献</p> <p>jenkins返回构建状态到gitlab</p> <p><a href=https://www.cnblogs.com/shipment/p/14690649.html>https://www.cnblogs.com/shipment/p/14690649.html</a></p> <p><a href=https://blog.51cto.com/ygqygq2/2461766>https://blog.51cto.com/ygqygq2/2461766</a></p> <p><a href=https://www.jianshu.com/p/d2af2915cfea>https://www.jianshu.com/p/d2af2915cfea</a></p> </div> <h2 id=7-自动化构建vueh5前端应用>7. 自动化构建Vue/H5前端应用<a class=headerlink href=#7-自动化构建vueh5前端应用 title="Permanent link">&para;</a></h2> <p>本节介绍自动化构建Vue/H5应用，其构建方式和自动化构建Java基本相同，重点是更改Deployment、Jenkinsfile和Dockerfile。</p> <p>同样，前端应用也为读者准备了一个测试项目(项目地址：<a href=https://gitee.com/dukuan/vue-project.git),可以按照创建Java测试用例的方式导入前端项目到GitLab中>https://gitee.com/dukuan/vue-project.git),可以按照创建Java测试用例的方式导入前端项目到GitLab中</a>，当然也可以使用公司自己的项目。</p> <h3 id=71-定义jenkinsfile>7.1 定义Jenkinsfile<a class=headerlink href=#71-定义jenkinsfile title="Permanent link">&para;</a></h3> <p>先将镜像上传到harbor私有仓库</p> <div class=highlight><pre><span></span><code><a id=__codelineno-172-1 name=__codelineno-172-1 href=#__codelineno-172-1></a>$<span class=w> </span>docker<span class=w> </span>pull<span class=w> </span>registry.cn-beijing.aliyuncs.com/citools/node:lts
<a id=__codelineno-172-2 name=__codelineno-172-2 href=#__codelineno-172-2></a>$<span class=w> </span>docker<span class=w> </span>tag<span class=w> </span>registry.cn-beijing.aliyuncs.com/citools/node:lts<span class=w> </span>hub.gitee.cc/kubernetes/node:lts
<a id=__codelineno-172-3 name=__codelineno-172-3 href=#__codelineno-172-3></a>$<span class=w> </span>docker<span class=w> </span>push<span class=w> </span>hub.gitee.cc/kubernetes/node:lts
</code></pre></div> <p>Jenkinsfile和Java项目并无太大区别，需要更改的位置如下（展示部分代码）：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-173-1 name=__codelineno-173-1 href=#__codelineno-173-1></a>pipeline{
<a id=__codelineno-173-2 name=__codelineno-173-2 href=#__codelineno-173-2></a>    environment {
<a id=__codelineno-173-3 name=__codelineno-173-3 href=#__codelineno-173-3></a>        COMMIT_ID = &quot;&quot;
<a id=__codelineno-173-4 name=__codelineno-173-4 href=#__codelineno-173-4></a>        HARBOR_ADDRESS = &quot;hub.gitee.cc&quot;
<a id=__codelineno-173-5 name=__codelineno-173-5 href=#__codelineno-173-5></a>        REGISTRY_DIR = &quot;kubernetes&quot;
<a id=__codelineno-173-6 name=__codelineno-173-6 href=#__codelineno-173-6></a>        IMAGE_NAME = &quot;vue-project&quot;
<a id=__codelineno-173-7 name=__codelineno-173-7 href=#__codelineno-173-7></a>        NAMESPACE = &quot;kubernetes&quot;
<a id=__codelineno-173-8 name=__codelineno-173-8 href=#__codelineno-173-8></a>        TAG = &quot;&quot;
<a id=__codelineno-173-9 name=__codelineno-173-9 href=#__codelineno-173-9></a>        GITLAB_AUTH = &quot;gitlab-auth&quot;
<a id=__codelineno-173-10 name=__codelineno-173-10 href=#__codelineno-173-10></a>        HARBOR_AUTH = &quot;harbor-user-passwd&quot;
<a id=__codelineno-173-11 name=__codelineno-173-11 href=#__codelineno-173-11></a>    }
<a id=__codelineno-173-12 name=__codelineno-173-12 href=#__codelineno-173-12></a>  parameters {
<a id=__codelineno-173-13 name=__codelineno-173-13 href=#__codelineno-173-13></a>    gitParameter(branch: &#39;&#39;, branchFilter: &#39;origin/(.*)&#39;, defaultValue: &#39;master&#39;, description: &#39;Branch for build and deploy&#39;,
<a id=__codelineno-173-14 name=__codelineno-173-14 href=#__codelineno-173-14></a>                name: &#39;BRANCH&#39;, quickFilterEnabled: false, selectedValue: &#39;NONE&#39;, sortMode: &#39;NONE&#39;, tagFilter: &#39;*&#39;, type: &#39;PT_BRANCH&#39;)
<a id=__codelineno-173-15 name=__codelineno-173-15 href=#__codelineno-173-15></a>  }
<a id=__codelineno-173-16 name=__codelineno-173-16 href=#__codelineno-173-16></a>
<a id=__codelineno-173-17 name=__codelineno-173-17 href=#__codelineno-173-17></a>    options {
<a id=__codelineno-173-18 name=__codelineno-173-18 href=#__codelineno-173-18></a>      parallelsAlwaysFailFast()
<a id=__codelineno-173-19 name=__codelineno-173-19 href=#__codelineno-173-19></a>      disableResume()
<a id=__codelineno-173-20 name=__codelineno-173-20 href=#__codelineno-173-20></a>      quietPeriod(1)
<a id=__codelineno-173-21 name=__codelineno-173-21 href=#__codelineno-173-21></a>      preserveStashes(buildCount: 5)
<a id=__codelineno-173-22 name=__codelineno-173-22 href=#__codelineno-173-22></a>      timestamps()
<a id=__codelineno-173-23 name=__codelineno-173-23 href=#__codelineno-173-23></a>      buildDiscarder(logRotator(numToKeepStr: &#39;100&#39;))
<a id=__codelineno-173-24 name=__codelineno-173-24 href=#__codelineno-173-24></a>      timeout(time: 60, unit: &#39;MINUTES&#39;)
<a id=__codelineno-173-25 name=__codelineno-173-25 href=#__codelineno-173-25></a>      gitLabConnection(&quot;gitlab&quot;)
<a id=__codelineno-173-26 name=__codelineno-173-26 href=#__codelineno-173-26></a>    }
<a id=__codelineno-173-27 name=__codelineno-173-27 href=#__codelineno-173-27></a>
<a id=__codelineno-173-28 name=__codelineno-173-28 href=#__codelineno-173-28></a>    agent {
<a id=__codelineno-173-29 name=__codelineno-173-29 href=#__codelineno-173-29></a>        kubernetes {
<a id=__codelineno-173-30 name=__codelineno-173-30 href=#__codelineno-173-30></a>            cloud &#39;kubernetes&#39;
<a id=__codelineno-173-31 name=__codelineno-173-31 href=#__codelineno-173-31></a>            slaveConnectTimeout 1200
<a id=__codelineno-173-32 name=__codelineno-173-32 href=#__codelineno-173-32></a>            workspaceVolume nfsWorkspaceVolume(serverAddress: &quot;192.168.1.60&quot;, serverPath: &quot;/QaTest/jenkins-salve&quot;, readOnly: &quot;false&quot;)
<a id=__codelineno-173-33 name=__codelineno-173-33 href=#__codelineno-173-33></a>            yaml &#39;&#39;&#39;
<a id=__codelineno-173-34 name=__codelineno-173-34 href=#__codelineno-173-34></a>apiVersion: v1
<a id=__codelineno-173-35 name=__codelineno-173-35 href=#__codelineno-173-35></a>kind: Pod
<a id=__codelineno-173-36 name=__codelineno-173-36 href=#__codelineno-173-36></a>metadata:
<a id=__codelineno-173-37 name=__codelineno-173-37 href=#__codelineno-173-37></a>  name: &quot;jenkins-slave&quot;
<a id=__codelineno-173-38 name=__codelineno-173-38 href=#__codelineno-173-38></a>  namespace: &quot;kube-ops&quot;
<a id=__codelineno-173-39 name=__codelineno-173-39 href=#__codelineno-173-39></a>  labels:
<a id=__codelineno-173-40 name=__codelineno-173-40 href=#__codelineno-173-40></a>    jenkins: &quot;slave&quot;
<a id=__codelineno-173-41 name=__codelineno-173-41 href=#__codelineno-173-41></a>    jenkins/label: &quot;jenkins-jnlp&quot;
<a id=__codelineno-173-42 name=__codelineno-173-42 href=#__codelineno-173-42></a>spec:
<a id=__codelineno-173-43 name=__codelineno-173-43 href=#__codelineno-173-43></a>  containers:
<a id=__codelineno-173-44 name=__codelineno-173-44 href=#__codelineno-173-44></a>  - name: &quot;jnlp&quot;
<a id=__codelineno-173-45 name=__codelineno-173-45 href=#__codelineno-173-45></a>    image: &quot;hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11&quot;
<a id=__codelineno-173-46 name=__codelineno-173-46 href=#__codelineno-173-46></a>    imagePullPolicy: &quot;IfNotPresent&quot;
<a id=__codelineno-173-47 name=__codelineno-173-47 href=#__codelineno-173-47></a>    tty: true
<a id=__codelineno-173-48 name=__codelineno-173-48 href=#__codelineno-173-48></a>    resources:
<a id=__codelineno-173-49 name=__codelineno-173-49 href=#__codelineno-173-49></a>      limits:
<a id=__codelineno-173-50 name=__codelineno-173-50 href=#__codelineno-173-50></a>        cpu: 1000m
<a id=__codelineno-173-51 name=__codelineno-173-51 href=#__codelineno-173-51></a>        memory: 2000Mi
<a id=__codelineno-173-52 name=__codelineno-173-52 href=#__codelineno-173-52></a>      requests:
<a id=__codelineno-173-53 name=__codelineno-173-53 href=#__codelineno-173-53></a>        cpu: 200m
<a id=__codelineno-173-54 name=__codelineno-173-54 href=#__codelineno-173-54></a>        memory: 400Mi
<a id=__codelineno-173-55 name=__codelineno-173-55 href=#__codelineno-173-55></a>    env:
<a id=__codelineno-173-56 name=__codelineno-173-56 href=#__codelineno-173-56></a>    - name: &quot;DOCKER_HOST&quot;
<a id=__codelineno-173-57 name=__codelineno-173-57 href=#__codelineno-173-57></a>      value: &quot;tcp://192.168.1.141:2375&quot;
<a id=__codelineno-173-58 name=__codelineno-173-58 href=#__codelineno-173-58></a>    - name: &quot;JENKINS_AGENT_WORKDIR&quot;
<a id=__codelineno-173-59 name=__codelineno-173-59 href=#__codelineno-173-59></a>      value: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-173-60 name=__codelineno-173-60 href=#__codelineno-173-60></a>    volumeMounts:
<a id=__codelineno-173-61 name=__codelineno-173-61 href=#__codelineno-173-61></a>    - mountPath: &quot;/root/.kube/config&quot;
<a id=__codelineno-173-62 name=__codelineno-173-62 href=#__codelineno-173-62></a>      name: &quot;volume-0&quot;
<a id=__codelineno-173-63 name=__codelineno-173-63 href=#__codelineno-173-63></a>      readOnly: false
<a id=__codelineno-173-64 name=__codelineno-173-64 href=#__codelineno-173-64></a>      subPath: &quot;config&quot;
<a id=__codelineno-173-65 name=__codelineno-173-65 href=#__codelineno-173-65></a>    - name: localtime
<a id=__codelineno-173-66 name=__codelineno-173-66 href=#__codelineno-173-66></a>      mountPath: /etc/localtime
<a id=__codelineno-173-67 name=__codelineno-173-67 href=#__codelineno-173-67></a>
<a id=__codelineno-173-68 name=__codelineno-173-68 href=#__codelineno-173-68></a>    - mountPath: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-173-69 name=__codelineno-173-69 href=#__codelineno-173-69></a>      name: &quot;workspace-volume&quot;
<a id=__codelineno-173-70 name=__codelineno-173-70 href=#__codelineno-173-70></a>      readOnly: false
<a id=__codelineno-173-71 name=__codelineno-173-71 href=#__codelineno-173-71></a>    workingDir: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-173-72 name=__codelineno-173-72 href=#__codelineno-173-72></a>
<a id=__codelineno-173-73 name=__codelineno-173-73 href=#__codelineno-173-73></a>  - name: &quot;build&quot;
<a id=__codelineno-173-74 name=__codelineno-173-74 href=#__codelineno-173-74></a>    image: &quot;hub.gitee.cc/kubernetes/node:lts&quot;
<a id=__codelineno-173-75 name=__codelineno-173-75 href=#__codelineno-173-75></a>    imagePullPolicy: &quot;IfNotPresent&quot;
<a id=__codelineno-173-76 name=__codelineno-173-76 href=#__codelineno-173-76></a>    tty: true
<a id=__codelineno-173-77 name=__codelineno-173-77 href=#__codelineno-173-77></a>    volumeMounts:
<a id=__codelineno-173-78 name=__codelineno-173-78 href=#__codelineno-173-78></a>      - name: localtime
<a id=__codelineno-173-79 name=__codelineno-173-79 href=#__codelineno-173-79></a>        mountPath: /etc/localtime
<a id=__codelineno-173-80 name=__codelineno-173-80 href=#__codelineno-173-80></a>    command:
<a id=__codelineno-173-81 name=__codelineno-173-81 href=#__codelineno-173-81></a>      - &quot;cat&quot;
<a id=__codelineno-173-82 name=__codelineno-173-82 href=#__codelineno-173-82></a>    env:
<a id=__codelineno-173-83 name=__codelineno-173-83 href=#__codelineno-173-83></a>      - name: &quot;LANGUAGE&quot;
<a id=__codelineno-173-84 name=__codelineno-173-84 href=#__codelineno-173-84></a>        value: &quot;en_US:en&quot;
<a id=__codelineno-173-85 name=__codelineno-173-85 href=#__codelineno-173-85></a>      - name: &quot;LC_ALL&quot;
<a id=__codelineno-173-86 name=__codelineno-173-86 href=#__codelineno-173-86></a>        value: &quot;en_US.UTF-8&quot;
<a id=__codelineno-173-87 name=__codelineno-173-87 href=#__codelineno-173-87></a>      - name: &quot;LANG&quot;
<a id=__codelineno-173-88 name=__codelineno-173-88 href=#__codelineno-173-88></a>        value: &quot;en_US.UTF-8&quot;
<a id=__codelineno-173-89 name=__codelineno-173-89 href=#__codelineno-173-89></a>
<a id=__codelineno-173-90 name=__codelineno-173-90 href=#__codelineno-173-90></a>  volumes:
<a id=__codelineno-173-91 name=__codelineno-173-91 href=#__codelineno-173-91></a>    - name: localtime
<a id=__codelineno-173-92 name=__codelineno-173-92 href=#__codelineno-173-92></a>      hostPath:
<a id=__codelineno-173-93 name=__codelineno-173-93 href=#__codelineno-173-93></a>        path: /usr/share/zoneinfo/Asia/Shanghai
<a id=__codelineno-173-94 name=__codelineno-173-94 href=#__codelineno-173-94></a>
<a id=__codelineno-173-95 name=__codelineno-173-95 href=#__codelineno-173-95></a>    - configMap:
<a id=__codelineno-173-96 name=__codelineno-173-96 href=#__codelineno-173-96></a>        name: &quot;kubeconfig&quot;
<a id=__codelineno-173-97 name=__codelineno-173-97 href=#__codelineno-173-97></a>        optional: false
<a id=__codelineno-173-98 name=__codelineno-173-98 href=#__codelineno-173-98></a>      name: &quot;volume-0&quot;
<a id=__codelineno-173-99 name=__codelineno-173-99 href=#__codelineno-173-99></a>
<a id=__codelineno-173-100 name=__codelineno-173-100 href=#__codelineno-173-100></a>    - emptyDir:
<a id=__codelineno-173-101 name=__codelineno-173-101 href=#__codelineno-173-101></a>        medium: &quot;&quot;
<a id=__codelineno-173-102 name=__codelineno-173-102 href=#__codelineno-173-102></a>      name: &quot;workspace-volume&quot;
<a id=__codelineno-173-103 name=__codelineno-173-103 href=#__codelineno-173-103></a>  restartPolicy: Always
<a id=__codelineno-173-104 name=__codelineno-173-104 href=#__codelineno-173-104></a>  hostNetwork: false
<a id=__codelineno-173-105 name=__codelineno-173-105 href=#__codelineno-173-105></a>  imagePullSecrets:
<a id=__codelineno-173-106 name=__codelineno-173-106 href=#__codelineno-173-106></a>  - name: &quot;regcred&quot;
<a id=__codelineno-173-107 name=__codelineno-173-107 href=#__codelineno-173-107></a>  # 固定节点部署
<a id=__codelineno-173-108 name=__codelineno-173-108 href=#__codelineno-173-108></a>  nodeSelector:
<a id=__codelineno-173-109 name=__codelineno-173-109 href=#__codelineno-173-109></a>    build: &quot;true&quot;
<a id=__codelineno-173-110 name=__codelineno-173-110 href=#__codelineno-173-110></a>
<a id=__codelineno-173-111 name=__codelineno-173-111 href=#__codelineno-173-111></a>            &#39;&#39;&#39;
<a id=__codelineno-173-112 name=__codelineno-173-112 href=#__codelineno-173-112></a>        }
<a id=__codelineno-173-113 name=__codelineno-173-113 href=#__codelineno-173-113></a>    }
<a id=__codelineno-173-114 name=__codelineno-173-114 href=#__codelineno-173-114></a>
<a id=__codelineno-173-115 name=__codelineno-173-115 href=#__codelineno-173-115></a>    stages {
<a id=__codelineno-173-116 name=__codelineno-173-116 href=#__codelineno-173-116></a>      stage(&#39;Pulling Code&#39;) {
<a id=__codelineno-173-117 name=__codelineno-173-117 href=#__codelineno-173-117></a>        parallel {
<a id=__codelineno-173-118 name=__codelineno-173-118 href=#__codelineno-173-118></a>        stage(&#39;Pulling Code by Jenkins&#39;) {
<a id=__codelineno-173-119 name=__codelineno-173-119 href=#__codelineno-173-119></a>          when {
<a id=__codelineno-173-120 name=__codelineno-173-120 href=#__codelineno-173-120></a>            expression {
<a id=__codelineno-173-121 name=__codelineno-173-121 href=#__codelineno-173-121></a>              env.gitlabBranch == null
<a id=__codelineno-173-122 name=__codelineno-173-122 href=#__codelineno-173-122></a>            }
<a id=__codelineno-173-123 name=__codelineno-173-123 href=#__codelineno-173-123></a>
<a id=__codelineno-173-124 name=__codelineno-173-124 href=#__codelineno-173-124></a>          }
<a id=__codelineno-173-125 name=__codelineno-173-125 href=#__codelineno-173-125></a>          steps {
<a id=__codelineno-173-126 name=__codelineno-173-126 href=#__codelineno-173-126></a>            git(changelog: true, poll: true, url: &#39;http://gitlab.runjs.cn:8929/kubernetes/vue-project.git&#39;, branch: &quot;${BRANCH}&quot;, credentialsId: &quot;${GITLAB_AUTH}&quot;)
<a id=__codelineno-173-127 name=__codelineno-173-127 href=#__codelineno-173-127></a>            script {
<a id=__codelineno-173-128 name=__codelineno-173-128 href=#__codelineno-173-128></a>              COMMIT_ID = sh(returnStdout: true, script: &quot;git log -n 1 --pretty=format:&#39;%h&#39;&quot;).trim()
<a id=__codelineno-173-129 name=__codelineno-173-129 href=#__codelineno-173-129></a>              TAG = BUILD_TAG + &#39;-&#39; + COMMIT_ID
<a id=__codelineno-173-130 name=__codelineno-173-130 href=#__codelineno-173-130></a>              println &quot;Current branch is ${BRANCH}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}&quot;
<a id=__codelineno-173-131 name=__codelineno-173-131 href=#__codelineno-173-131></a>
<a id=__codelineno-173-132 name=__codelineno-173-132 href=#__codelineno-173-132></a>            }
<a id=__codelineno-173-133 name=__codelineno-173-133 href=#__codelineno-173-133></a>
<a id=__codelineno-173-134 name=__codelineno-173-134 href=#__codelineno-173-134></a>          }
<a id=__codelineno-173-135 name=__codelineno-173-135 href=#__codelineno-173-135></a>        }
<a id=__codelineno-173-136 name=__codelineno-173-136 href=#__codelineno-173-136></a>        stage(&#39;Pulling Code by trigger&#39;) {
<a id=__codelineno-173-137 name=__codelineno-173-137 href=#__codelineno-173-137></a>          when {
<a id=__codelineno-173-138 name=__codelineno-173-138 href=#__codelineno-173-138></a>            expression {
<a id=__codelineno-173-139 name=__codelineno-173-139 href=#__codelineno-173-139></a>              env.gitlabBranch != null
<a id=__codelineno-173-140 name=__codelineno-173-140 href=#__codelineno-173-140></a>            }
<a id=__codelineno-173-141 name=__codelineno-173-141 href=#__codelineno-173-141></a>
<a id=__codelineno-173-142 name=__codelineno-173-142 href=#__codelineno-173-142></a>          }
<a id=__codelineno-173-143 name=__codelineno-173-143 href=#__codelineno-173-143></a>          steps {
<a id=__codelineno-173-144 name=__codelineno-173-144 href=#__codelineno-173-144></a>            git(url: &#39;http://gitlab.runjs.cn:8929/kubernetes/vue-project.git&#39;, branch: env.gitlabBranch, changelog: true, poll: true, credentialsId: &quot;${GITLAB_AUTH}&quot;)
<a id=__codelineno-173-145 name=__codelineno-173-145 href=#__codelineno-173-145></a>            script {
<a id=__codelineno-173-146 name=__codelineno-173-146 href=#__codelineno-173-146></a>              COMMIT_ID = sh(returnStdout: true, script: &quot;git log -n 1 --pretty=format:&#39;%h&#39;&quot;).trim()
<a id=__codelineno-173-147 name=__codelineno-173-147 href=#__codelineno-173-147></a>              TAG = BUILD_TAG + &#39;-&#39; + COMMIT_ID
<a id=__codelineno-173-148 name=__codelineno-173-148 href=#__codelineno-173-148></a>              println &quot;Current branch is ${env.gitlabBranch}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}&quot;
<a id=__codelineno-173-149 name=__codelineno-173-149 href=#__codelineno-173-149></a>              }
<a id=__codelineno-173-150 name=__codelineno-173-150 href=#__codelineno-173-150></a>            }
<a id=__codelineno-173-151 name=__codelineno-173-151 href=#__codelineno-173-151></a>          }
<a id=__codelineno-173-152 name=__codelineno-173-152 href=#__codelineno-173-152></a>        }
<a id=__codelineno-173-153 name=__codelineno-173-153 href=#__codelineno-173-153></a>      }
<a id=__codelineno-173-154 name=__codelineno-173-154 href=#__codelineno-173-154></a>
<a id=__codelineno-173-155 name=__codelineno-173-155 href=#__codelineno-173-155></a>    stage(&#39;Building&#39;) {
<a id=__codelineno-173-156 name=__codelineno-173-156 href=#__codelineno-173-156></a>      steps {
<a id=__codelineno-173-157 name=__codelineno-173-157 href=#__codelineno-173-157></a>        container(name: &#39;build&#39;) {
<a id=__codelineno-173-158 name=__codelineno-173-158 href=#__codelineno-173-158></a>            sh &quot;&quot;&quot;
<a id=__codelineno-173-159 name=__codelineno-173-159 href=#__codelineno-173-159></a>              npm install --registry=https://registry.npm.taobao.org
<a id=__codelineno-173-160 name=__codelineno-173-160 href=#__codelineno-173-160></a>              npm run build
<a id=__codelineno-173-161 name=__codelineno-173-161 href=#__codelineno-173-161></a>            &quot;&quot;&quot;
<a id=__codelineno-173-162 name=__codelineno-173-162 href=#__codelineno-173-162></a>        }
<a id=__codelineno-173-163 name=__codelineno-173-163 href=#__codelineno-173-163></a>      }
<a id=__codelineno-173-164 name=__codelineno-173-164 href=#__codelineno-173-164></a>    }
<a id=__codelineno-173-165 name=__codelineno-173-165 href=#__codelineno-173-165></a>
<a id=__codelineno-173-166 name=__codelineno-173-166 href=#__codelineno-173-166></a>    stage(&#39;Docker build for creating image&#39;) {
<a id=__codelineno-173-167 name=__codelineno-173-167 href=#__codelineno-173-167></a>      steps {
<a id=__codelineno-173-168 name=__codelineno-173-168 href=#__codelineno-173-168></a>        withCredentials([[$class: &#39;UsernamePasswordMultiBinding&#39;,
<a id=__codelineno-173-169 name=__codelineno-173-169 href=#__codelineno-173-169></a>        credentialsId: &quot;${HARBOR_AUTH}&quot;,
<a id=__codelineno-173-170 name=__codelineno-173-170 href=#__codelineno-173-170></a>        usernameVariable: &#39;Harbor_user&#39;,
<a id=__codelineno-173-171 name=__codelineno-173-171 href=#__codelineno-173-171></a>        passwordVariable: &#39;Harbor_password&#39;]]) {
<a id=__codelineno-173-172 name=__codelineno-173-172 href=#__codelineno-173-172></a>            sh &quot;&quot;&quot;#!/bin/bash
<a id=__codelineno-173-173 name=__codelineno-173-173 href=#__codelineno-173-173></a>              set -eux
<a id=__codelineno-173-174 name=__codelineno-173-174 href=#__codelineno-173-174></a>
<a id=__codelineno-173-175 name=__codelineno-173-175 href=#__codelineno-173-175></a>              docker login -u ${Harbor_user} -p ${Harbor_password} ${HARBOR_ADDRESS}
<a id=__codelineno-173-176 name=__codelineno-173-176 href=#__codelineno-173-176></a>              docker build --no-cache -t ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG} .
<a id=__codelineno-173-177 name=__codelineno-173-177 href=#__codelineno-173-177></a>              docker push ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG}
<a id=__codelineno-173-178 name=__codelineno-173-178 href=#__codelineno-173-178></a>              docker rmi -f ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG}
<a id=__codelineno-173-179 name=__codelineno-173-179 href=#__codelineno-173-179></a>              &quot;&quot;&quot;
<a id=__codelineno-173-180 name=__codelineno-173-180 href=#__codelineno-173-180></a>        }
<a id=__codelineno-173-181 name=__codelineno-173-181 href=#__codelineno-173-181></a>      }
<a id=__codelineno-173-182 name=__codelineno-173-182 href=#__codelineno-173-182></a>    }
<a id=__codelineno-173-183 name=__codelineno-173-183 href=#__codelineno-173-183></a>
<a id=__codelineno-173-184 name=__codelineno-173-184 href=#__codelineno-173-184></a>    stage(&#39;Deploying to K8s&#39;) {
<a id=__codelineno-173-185 name=__codelineno-173-185 href=#__codelineno-173-185></a>      steps {
<a id=__codelineno-173-186 name=__codelineno-173-186 href=#__codelineno-173-186></a>           sh &quot;&quot;&quot;#!/bin/bash
<a id=__codelineno-173-187 name=__codelineno-173-187 href=#__codelineno-173-187></a>           set -ux
<a id=__codelineno-173-188 name=__codelineno-173-188 href=#__codelineno-173-188></a>
<a id=__codelineno-173-189 name=__codelineno-173-189 href=#__codelineno-173-189></a>           # set更新deployment镜像
<a id=__codelineno-173-190 name=__codelineno-173-190 href=#__codelineno-173-190></a>           kubectl set image deploy -l app=${IMAGE_NAME} ${IMAGE_NAME}=${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG} -n $NAMESPACE
<a id=__codelineno-173-191 name=__codelineno-173-191 href=#__codelineno-173-191></a>           &quot;&quot;&quot;
<a id=__codelineno-173-192 name=__codelineno-173-192 href=#__codelineno-173-192></a>      }
<a id=__codelineno-173-193 name=__codelineno-173-193 href=#__codelineno-173-193></a>    }
<a id=__codelineno-173-194 name=__codelineno-173-194 href=#__codelineno-173-194></a>  }
<a id=__codelineno-173-195 name=__codelineno-173-195 href=#__codelineno-173-195></a>      post {
<a id=__codelineno-173-196 name=__codelineno-173-196 href=#__codelineno-173-196></a>        failure {
<a id=__codelineno-173-197 name=__codelineno-173-197 href=#__codelineno-173-197></a>            updateGitlabCommitStatus name: &quot;build&quot;, state: &quot;failed&quot;
<a id=__codelineno-173-198 name=__codelineno-173-198 href=#__codelineno-173-198></a>        }
<a id=__codelineno-173-199 name=__codelineno-173-199 href=#__codelineno-173-199></a>        success {
<a id=__codelineno-173-200 name=__codelineno-173-200 href=#__codelineno-173-200></a>            updateGitlabCommitStatus name: &quot;build&quot;, state: &quot;success&quot;
<a id=__codelineno-173-201 name=__codelineno-173-201 href=#__codelineno-173-201></a>        }
<a id=__codelineno-173-202 name=__codelineno-173-202 href=#__codelineno-173-202></a>    }
<a id=__codelineno-173-203 name=__codelineno-173-203 href=#__codelineno-173-203></a>}
</code></pre></div> <p>可以看到对于不同的项目，只是构建的镜像和构建命令不一致，整个流水线的过程基本一致，所以在定义了一个Jenkinsfile后，稍加修改即可实现 其他语言的自动化构建。</p> <h3 id=72-定义dockerfile>7.2 定义Dockerfile<a class=headerlink href=#72-定义dockerfile title="Permanent link">&para;</a></h3> <p>前端应用构建后一般会在项目根目录下的dist文件下产生HTML文件，只需要复制到nginx的根目录下即可：</p> <p><code>Dockerfile</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-174-1 name=__codelineno-174-1 href=#__codelineno-174-1></a><span class=k>FROM</span><span class=w> </span><span class=s>registry.cn-beijing.aliyuncs.com/dotbalo/nginx:1.15.12</span>
<a id=__codelineno-174-2 name=__codelineno-174-2 href=#__codelineno-174-2></a><span class=k>COPY</span><span class=w> </span>dist/*<span class=w> </span>/usr/share/nginx/html/
</code></pre></div> <p>Jenkinsfile和Dockerfile文件添加到仓库代码同级目录下，如下图所示</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-58.png></p> <h3 id=73-定义kubernetes资源>7,3 定义Kubernetes资源<a class=headerlink href=#73-定义kubernetes资源 title="Permanent link">&para;</a></h3> <p>对于Kubernetes的资源也是类似的，只需要更改资源名称和端口号即可：</p> <p><code>deployment.yaml</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-175-1 name=__codelineno-175-1 href=#__codelineno-175-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id=__codelineno-175-2 name=__codelineno-175-2 href=#__codelineno-175-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a id=__codelineno-175-3 name=__codelineno-175-3 href=#__codelineno-175-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-175-4 name=__codelineno-175-4 href=#__codelineno-175-4></a><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<a id=__codelineno-175-5 name=__codelineno-175-5 href=#__codelineno-175-5></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-175-6 name=__codelineno-175-6 href=#__codelineno-175-6></a><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">vue-project</span>
<a id=__codelineno-175-7 name=__codelineno-175-7 href=#__codelineno-175-7></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">vue-project</span>
<a id=__codelineno-175-8 name=__codelineno-175-8 href=#__codelineno-175-8></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
<a id=__codelineno-175-9 name=__codelineno-175-9 href=#__codelineno-175-9></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-175-10 name=__codelineno-175-10 href=#__codelineno-175-10></a><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-175-11 name=__codelineno-175-11 href=#__codelineno-175-11></a><span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
<a id=__codelineno-175-12 name=__codelineno-175-12 href=#__codelineno-175-12></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-175-13 name=__codelineno-175-13 href=#__codelineno-175-13></a><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">vue-project</span>
<a id=__codelineno-175-14 name=__codelineno-175-14 href=#__codelineno-175-14></a><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span>
<a id=__codelineno-175-15 name=__codelineno-175-15 href=#__codelineno-175-15></a><span class=w>    </span><span class=nt>rollingUpdate</span><span class=p>:</span>
<a id=__codelineno-175-16 name=__codelineno-175-16 href=#__codelineno-175-16></a><span class=w>      </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-175-17 name=__codelineno-175-17 href=#__codelineno-175-17></a><span class=w>      </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<a id=__codelineno-175-18 name=__codelineno-175-18 href=#__codelineno-175-18></a><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
<a id=__codelineno-175-19 name=__codelineno-175-19 href=#__codelineno-175-19></a><span class=w>  </span><span class=nt>template</span><span class=p>:</span>
<a id=__codelineno-175-20 name=__codelineno-175-20 href=#__codelineno-175-20></a><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-175-21 name=__codelineno-175-21 href=#__codelineno-175-21></a><span class=w>      </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<a id=__codelineno-175-22 name=__codelineno-175-22 href=#__codelineno-175-22></a><span class=w>      </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-175-23 name=__codelineno-175-23 href=#__codelineno-175-23></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">vue-project</span>
<a id=__codelineno-175-24 name=__codelineno-175-24 href=#__codelineno-175-24></a><span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-175-25 name=__codelineno-175-25 href=#__codelineno-175-25></a><span class=w>      </span><span class=nt>containers</span><span class=p>:</span>
<a id=__codelineno-175-26 name=__codelineno-175-26 href=#__codelineno-175-26></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>env</span><span class=p>:</span>
<a id=__codelineno-175-27 name=__codelineno-175-27 href=#__codelineno-175-27></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TZ</span>
<a id=__codelineno-175-28 name=__codelineno-175-28 href=#__codelineno-175-28></a><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Asia/Shanghai</span>
<a id=__codelineno-175-29 name=__codelineno-175-29 href=#__codelineno-175-29></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">LANG</span>
<a id=__codelineno-175-30 name=__codelineno-175-30 href=#__codelineno-175-30></a><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">C.UTF-8</span>
<a id=__codelineno-175-31 name=__codelineno-175-31 href=#__codelineno-175-31></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id=__codelineno-175-32 name=__codelineno-175-32 href=#__codelineno-175-32></a><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
<a id=__codelineno-175-33 name=__codelineno-175-33 href=#__codelineno-175-33></a><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span>
<a id=__codelineno-175-34 name=__codelineno-175-34 href=#__codelineno-175-34></a><span class=w>          </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a id=__codelineno-175-35 name=__codelineno-175-35 href=#__codelineno-175-35></a><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<a id=__codelineno-175-36 name=__codelineno-175-36 href=#__codelineno-175-36></a><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<a id=__codelineno-175-37 name=__codelineno-175-37 href=#__codelineno-175-37></a><span class=w>          </span><span class=nt>successThreshold</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-175-38 name=__codelineno-175-38 href=#__codelineno-175-38></a><span class=w>          </span><span class=nt>tcpSocket</span><span class=p>:</span>
<a id=__codelineno-175-39 name=__codelineno-175-39 href=#__codelineno-175-39></a><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<a id=__codelineno-175-40 name=__codelineno-175-40 href=#__codelineno-175-40></a><span class=w>          </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a id=__codelineno-175-41 name=__codelineno-175-41 href=#__codelineno-175-41></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">vue-project</span>
<a id=__codelineno-175-42 name=__codelineno-175-42 href=#__codelineno-175-42></a><span class=w>        </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-175-43 name=__codelineno-175-43 href=#__codelineno-175-43></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<a id=__codelineno-175-44 name=__codelineno-175-44 href=#__codelineno-175-44></a><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<a id=__codelineno-175-45 name=__codelineno-175-45 href=#__codelineno-175-45></a><span class=w>          </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<a id=__codelineno-175-46 name=__codelineno-175-46 href=#__codelineno-175-46></a><span class=w>        </span><span class=nt>resources</span><span class=p>:</span>
<a id=__codelineno-175-47 name=__codelineno-175-47 href=#__codelineno-175-47></a><span class=w>          </span><span class=nt>limits</span><span class=p>:</span>
<a id=__codelineno-175-48 name=__codelineno-175-48 href=#__codelineno-175-48></a><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">994m</span>
<a id=__codelineno-175-49 name=__codelineno-175-49 href=#__codelineno-175-49></a><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1170Mi</span>
<a id=__codelineno-175-50 name=__codelineno-175-50 href=#__codelineno-175-50></a><span class=w>          </span><span class=nt>requests</span><span class=p>:</span>
<a id=__codelineno-175-51 name=__codelineno-175-51 href=#__codelineno-175-51></a><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10m</span>
<a id=__codelineno-175-52 name=__codelineno-175-52 href=#__codelineno-175-52></a><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">55Mi</span>
<a id=__codelineno-175-53 name=__codelineno-175-53 href=#__codelineno-175-53></a><span class=w>      </span><span class=nt>dnsPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterFirst</span>
<a id=__codelineno-175-54 name=__codelineno-175-54 href=#__codelineno-175-54></a><span class=w>      </span><span class=nt>imagePullSecrets</span><span class=p>:</span>
<a id=__codelineno-175-55 name=__codelineno-175-55 href=#__codelineno-175-55></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">harborkey</span>
<a id=__codelineno-175-56 name=__codelineno-175-56 href=#__codelineno-175-56></a><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<a id=__codelineno-175-57 name=__codelineno-175-57 href=#__codelineno-175-57></a><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</code></pre></div> <p>定义该应用的Service和Ingress：</p> <p><code>vue-project-svc-ingress.yaml</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-176-1 name=__codelineno-176-1 href=#__codelineno-176-1></a><span class=nn>---</span>
<a id=__codelineno-176-2 name=__codelineno-176-2 href=#__codelineno-176-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-176-3 name=__codelineno-176-3 href=#__codelineno-176-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<a id=__codelineno-176-4 name=__codelineno-176-4 href=#__codelineno-176-4></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-176-5 name=__codelineno-176-5 href=#__codelineno-176-5></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-176-6 name=__codelineno-176-6 href=#__codelineno-176-6></a><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">vue-project</span>
<a id=__codelineno-176-7 name=__codelineno-176-7 href=#__codelineno-176-7></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">vue-project</span>
<a id=__codelineno-176-8 name=__codelineno-176-8 href=#__codelineno-176-8></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
<a id=__codelineno-176-9 name=__codelineno-176-9 href=#__codelineno-176-9></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-176-10 name=__codelineno-176-10 href=#__codelineno-176-10></a><span class=w>  </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-176-11 name=__codelineno-176-11 href=#__codelineno-176-11></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<a id=__codelineno-176-12 name=__codelineno-176-12 href=#__codelineno-176-12></a><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<a id=__codelineno-176-13 name=__codelineno-176-13 href=#__codelineno-176-13></a><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<a id=__codelineno-176-14 name=__codelineno-176-14 href=#__codelineno-176-14></a><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<a id=__codelineno-176-15 name=__codelineno-176-15 href=#__codelineno-176-15></a><span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
<a id=__codelineno-176-16 name=__codelineno-176-16 href=#__codelineno-176-16></a><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">vue-project</span>
<a id=__codelineno-176-17 name=__codelineno-176-17 href=#__codelineno-176-17></a><span class=w>  </span><span class=nt>sessionAffinity</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">None</span>
<a id=__codelineno-176-18 name=__codelineno-176-18 href=#__codelineno-176-18></a><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
<a id=__codelineno-176-19 name=__codelineno-176-19 href=#__codelineno-176-19></a>
<a id=__codelineno-176-20 name=__codelineno-176-20 href=#__codelineno-176-20></a><span class=nn>---</span>
<a id=__codelineno-176-21 name=__codelineno-176-21 href=#__codelineno-176-21></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<a id=__codelineno-176-22 name=__codelineno-176-22 href=#__codelineno-176-22></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<a id=__codelineno-176-23 name=__codelineno-176-23 href=#__codelineno-176-23></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-176-24 name=__codelineno-176-24 href=#__codelineno-176-24></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">vue-project</span>
<a id=__codelineno-176-25 name=__codelineno-176-25 href=#__codelineno-176-25></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
<a id=__codelineno-176-26 name=__codelineno-176-26 href=#__codelineno-176-26></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-176-27 name=__codelineno-176-27 href=#__codelineno-176-27></a><span class=w>  </span><span class=nt>ingressClassName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id=__codelineno-176-28 name=__codelineno-176-28 href=#__codelineno-176-28></a><span class=w>  </span><span class=nt>rules</span><span class=p>:</span>
<a id=__codelineno-176-29 name=__codelineno-176-29 href=#__codelineno-176-29></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">vue-project.test.com</span>
<a id=__codelineno-176-30 name=__codelineno-176-30 href=#__codelineno-176-30></a><span class=w>    </span><span class=nt>http</span><span class=p>:</span>
<a id=__codelineno-176-31 name=__codelineno-176-31 href=#__codelineno-176-31></a><span class=w>      </span><span class=nt>paths</span><span class=p>:</span>
<a id=__codelineno-176-32 name=__codelineno-176-32 href=#__codelineno-176-32></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>backend</span><span class=p>:</span>
<a id=__codelineno-176-33 name=__codelineno-176-33 href=#__codelineno-176-33></a><span class=w>          </span><span class=nt>service</span><span class=p>:</span>
<a id=__codelineno-176-34 name=__codelineno-176-34 href=#__codelineno-176-34></a><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">vue-project</span>
<a id=__codelineno-176-35 name=__codelineno-176-35 href=#__codelineno-176-35></a><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span>
<a id=__codelineno-176-36 name=__codelineno-176-36 href=#__codelineno-176-36></a><span class=w>              </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<a id=__codelineno-176-37 name=__codelineno-176-37 href=#__codelineno-176-37></a><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<a id=__codelineno-176-38 name=__codelineno-176-38 href=#__codelineno-176-38></a><span class=w>        </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ImplementationSpecific</span>
</code></pre></div> <p>创建该资源：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-177-1 name=__codelineno-177-1 href=#__codelineno-177-1></a>$<span class=w> </span>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>deployment.yaml
<a id=__codelineno-177-2 name=__codelineno-177-2 href=#__codelineno-177-2></a>$<span class=w> </span>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>vue-project-svc-ingress.yaml
</code></pre></div> <h3 id=74-创建jenkins-job>7.4 创建Jenkins Job<a class=headerlink href=#74-创建jenkins-job title="Permanent link">&para;</a></h3> <p>创建Jenkins Job和上一小节类似，并无太大区别。首先创建Pipeline类型的Job，名称为vue-project，同样在Pipeline栏填写地址、Key和分支，如图</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-59.png></p> <p>同样，第一次构建也会失败，第二次可以选择分支构建.当出现SUCCESS时，表示构建结束。</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-60.png></p> <p>接下来可以查看Deployment的镜像：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-178-1 name=__codelineno-178-1 href=#__codelineno-178-1></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>deploy<span class=w> </span>vue-project<span class=w> </span>-o<span class=w> </span>yaml<span class=w> </span>-n<span class=w> </span>kubernetes<span class=p>|</span>grep<span class=w> </span><span class=s2>&quot;image:&quot;</span>
<a id=__codelineno-178-2 name=__codelineno-178-2 href=#__codelineno-178-2></a><span class=w>        </span>image:<span class=w> </span>hub.gitee.cc/kubernetes/vue-project:jenkins-vue-project-4-9256578
<a id=__codelineno-178-3 name=__codelineno-178-3 href=#__codelineno-178-3></a>
<a id=__codelineno-178-4 name=__codelineno-178-4 href=#__codelineno-178-4></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pod<span class=w> </span>-n<span class=w> </span>kubernetes
<a id=__codelineno-178-5 name=__codelineno-178-5 href=#__codelineno-178-5></a>NAME<span class=w>                          </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>   </span>AGE
<a id=__codelineno-178-6 name=__codelineno-178-6 href=#__codelineno-178-6></a>vue-project-f56dcdb95-zwbl5<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>29m
</code></pre></div> <p>部署更新镜像完毕之后可以在浏览器访问该域名。</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-61.png></p> <h3 id=75-webhook自动触发>7.5 Webhook自动触发<a class=headerlink href=#75-webhook自动触发 title="Permanent link">&para;</a></h3> <p>同6.8设置相同。参考上面设置内容。</p> <h2 id=8-自动化构建golang项目>8. 自动化构建Golang项目<a class=headerlink href=#8-自动化构建golang项目 title="Permanent link">&para;</a></h2> <p>前面演示了Java和前端应用的自动化，接下来演示对于Golang的自动化构建，本示例的代码地址为https://gitee.com/dukuan/go-project.git。</p> <p>可以按照创建Java测试用例的方式导入前端项目到GitLab中，当然也可以使用公司自己的项目。</p> <h3 id=81-定义jenkinsfile>8.1 定义Jenkinsfile<a class=headerlink href=#81-定义jenkinsfile title="Permanent link">&para;</a></h3> <p>先将镜像上传到harbor私有仓库</p> <div class=highlight><pre><span></span><code><a id=__codelineno-179-1 name=__codelineno-179-1 href=#__codelineno-179-1></a>$<span class=w> </span>docker<span class=w> </span>pull<span class=w> </span>registry.cn-beijing.aliyuncs.com/citools/golang:1.15
<a id=__codelineno-179-2 name=__codelineno-179-2 href=#__codelineno-179-2></a>$<span class=w> </span>docker<span class=w> </span>tag<span class=w> </span>registry.cn-beijing.aliyuncs.com/citools/golang:1.15<span class=w> </span>hub.gitee.cc/kubernetes/golang:1.15
<a id=__codelineno-179-3 name=__codelineno-179-3 href=#__codelineno-179-3></a>$<span class=w> </span>docker<span class=w> </span>push<span class=w> </span>hub.gitee.cc/kubernetes/golang:1.15
</code></pre></div> <p>本示例的Jenkinsfile和之前的没有太大区别，需要更改的位置是构建容器的镜像、缓存目录、Git地址和项目名称：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-180-1 name=__codelineno-180-1 href=#__codelineno-180-1></a>pipeline{
<a id=__codelineno-180-2 name=__codelineno-180-2 href=#__codelineno-180-2></a>    environment {
<a id=__codelineno-180-3 name=__codelineno-180-3 href=#__codelineno-180-3></a>        COMMIT_ID = &quot;&quot;
<a id=__codelineno-180-4 name=__codelineno-180-4 href=#__codelineno-180-4></a>        HARBOR_ADDRESS = &quot;hub.gitee.cc&quot;
<a id=__codelineno-180-5 name=__codelineno-180-5 href=#__codelineno-180-5></a>        REGISTRY_DIR = &quot;kubernetes&quot;
<a id=__codelineno-180-6 name=__codelineno-180-6 href=#__codelineno-180-6></a>        IMAGE_NAME = &quot;go-project&quot;
<a id=__codelineno-180-7 name=__codelineno-180-7 href=#__codelineno-180-7></a>        NAMESPACE = &quot;kubernetes&quot;
<a id=__codelineno-180-8 name=__codelineno-180-8 href=#__codelineno-180-8></a>        TAG = &quot;&quot;
<a id=__codelineno-180-9 name=__codelineno-180-9 href=#__codelineno-180-9></a>        GITLAB_AUTH = &quot;gitlab-auth&quot;
<a id=__codelineno-180-10 name=__codelineno-180-10 href=#__codelineno-180-10></a>        HARBOR_AUTH = &quot;harbor-user-passwd&quot;
<a id=__codelineno-180-11 name=__codelineno-180-11 href=#__codelineno-180-11></a>    }
<a id=__codelineno-180-12 name=__codelineno-180-12 href=#__codelineno-180-12></a>  parameters {
<a id=__codelineno-180-13 name=__codelineno-180-13 href=#__codelineno-180-13></a>    gitParameter(branch: &#39;&#39;, branchFilter: &#39;origin/(.*)&#39;, defaultValue: &#39;master&#39;, description: &#39;Branch for build and deploy&#39;, name: &#39;BRANCH&#39;, quickFilterEnabled: false, selectedValue: &#39;NONE&#39;, sortMode: &#39;NONE&#39;, tagFilter: &#39;*&#39;, type: &#39;PT_BRANCH&#39;)
<a id=__codelineno-180-14 name=__codelineno-180-14 href=#__codelineno-180-14></a>  }
<a id=__codelineno-180-15 name=__codelineno-180-15 href=#__codelineno-180-15></a>
<a id=__codelineno-180-16 name=__codelineno-180-16 href=#__codelineno-180-16></a>    options {
<a id=__codelineno-180-17 name=__codelineno-180-17 href=#__codelineno-180-17></a>      parallelsAlwaysFailFast()
<a id=__codelineno-180-18 name=__codelineno-180-18 href=#__codelineno-180-18></a>      disableResume()
<a id=__codelineno-180-19 name=__codelineno-180-19 href=#__codelineno-180-19></a>      quietPeriod(1)
<a id=__codelineno-180-20 name=__codelineno-180-20 href=#__codelineno-180-20></a>      preserveStashes(buildCount: 5)
<a id=__codelineno-180-21 name=__codelineno-180-21 href=#__codelineno-180-21></a>      timestamps()
<a id=__codelineno-180-22 name=__codelineno-180-22 href=#__codelineno-180-22></a>      buildDiscarder(logRotator(numToKeepStr: &#39;100&#39;))
<a id=__codelineno-180-23 name=__codelineno-180-23 href=#__codelineno-180-23></a>      timeout(time: 60, unit: &#39;MINUTES&#39;)
<a id=__codelineno-180-24 name=__codelineno-180-24 href=#__codelineno-180-24></a>      gitLabConnection(&quot;gitlab&quot;)
<a id=__codelineno-180-25 name=__codelineno-180-25 href=#__codelineno-180-25></a>    }
<a id=__codelineno-180-26 name=__codelineno-180-26 href=#__codelineno-180-26></a>
<a id=__codelineno-180-27 name=__codelineno-180-27 href=#__codelineno-180-27></a>    agent {
<a id=__codelineno-180-28 name=__codelineno-180-28 href=#__codelineno-180-28></a>        kubernetes {
<a id=__codelineno-180-29 name=__codelineno-180-29 href=#__codelineno-180-29></a>            cloud &#39;kubernetes&#39;
<a id=__codelineno-180-30 name=__codelineno-180-30 href=#__codelineno-180-30></a>            slaveConnectTimeout 1200
<a id=__codelineno-180-31 name=__codelineno-180-31 href=#__codelineno-180-31></a>            workspaceVolume nfsWorkspaceVolume(serverAddress: &quot;192.168.1.60&quot;, serverPath: &quot;/QaTest/jenkins-salve&quot;, readOnly: &quot;false&quot;)
<a id=__codelineno-180-32 name=__codelineno-180-32 href=#__codelineno-180-32></a>            yaml &#39;&#39;&#39;
<a id=__codelineno-180-33 name=__codelineno-180-33 href=#__codelineno-180-33></a>apiVersion: v1
<a id=__codelineno-180-34 name=__codelineno-180-34 href=#__codelineno-180-34></a>kind: Pod
<a id=__codelineno-180-35 name=__codelineno-180-35 href=#__codelineno-180-35></a>metadata:
<a id=__codelineno-180-36 name=__codelineno-180-36 href=#__codelineno-180-36></a>  name: &quot;jenkins-slave&quot;
<a id=__codelineno-180-37 name=__codelineno-180-37 href=#__codelineno-180-37></a>  namespace: &quot;kube-ops&quot;
<a id=__codelineno-180-38 name=__codelineno-180-38 href=#__codelineno-180-38></a>  labels:
<a id=__codelineno-180-39 name=__codelineno-180-39 href=#__codelineno-180-39></a>    jenkins: &quot;slave&quot;
<a id=__codelineno-180-40 name=__codelineno-180-40 href=#__codelineno-180-40></a>    jenkins/label: &quot;jenkins-jnlp&quot;
<a id=__codelineno-180-41 name=__codelineno-180-41 href=#__codelineno-180-41></a>spec:
<a id=__codelineno-180-42 name=__codelineno-180-42 href=#__codelineno-180-42></a>  containers:
<a id=__codelineno-180-43 name=__codelineno-180-43 href=#__codelineno-180-43></a>  - name: &quot;jnlp&quot;
<a id=__codelineno-180-44 name=__codelineno-180-44 href=#__codelineno-180-44></a>    image: &quot;hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11&quot;
<a id=__codelineno-180-45 name=__codelineno-180-45 href=#__codelineno-180-45></a>    imagePullPolicy: &quot;IfNotPresent&quot;
<a id=__codelineno-180-46 name=__codelineno-180-46 href=#__codelineno-180-46></a>    tty: true
<a id=__codelineno-180-47 name=__codelineno-180-47 href=#__codelineno-180-47></a>    resources:
<a id=__codelineno-180-48 name=__codelineno-180-48 href=#__codelineno-180-48></a>      limits:
<a id=__codelineno-180-49 name=__codelineno-180-49 href=#__codelineno-180-49></a>        cpu: 1000m
<a id=__codelineno-180-50 name=__codelineno-180-50 href=#__codelineno-180-50></a>        memory: 2000Mi
<a id=__codelineno-180-51 name=__codelineno-180-51 href=#__codelineno-180-51></a>      requests:
<a id=__codelineno-180-52 name=__codelineno-180-52 href=#__codelineno-180-52></a>        cpu: 200m
<a id=__codelineno-180-53 name=__codelineno-180-53 href=#__codelineno-180-53></a>        memory: 400Mi
<a id=__codelineno-180-54 name=__codelineno-180-54 href=#__codelineno-180-54></a>    env:
<a id=__codelineno-180-55 name=__codelineno-180-55 href=#__codelineno-180-55></a>    - name: &quot;DOCKER_HOST&quot;
<a id=__codelineno-180-56 name=__codelineno-180-56 href=#__codelineno-180-56></a>      value: &quot;tcp://192.168.1.141:2375&quot;
<a id=__codelineno-180-57 name=__codelineno-180-57 href=#__codelineno-180-57></a>    - name: &quot;JENKINS_AGENT_WORKDIR&quot;
<a id=__codelineno-180-58 name=__codelineno-180-58 href=#__codelineno-180-58></a>      value: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-180-59 name=__codelineno-180-59 href=#__codelineno-180-59></a>    volumeMounts:
<a id=__codelineno-180-60 name=__codelineno-180-60 href=#__codelineno-180-60></a>    - mountPath: &quot;/root/.kube/config&quot;
<a id=__codelineno-180-61 name=__codelineno-180-61 href=#__codelineno-180-61></a>      name: &quot;volume-0&quot;
<a id=__codelineno-180-62 name=__codelineno-180-62 href=#__codelineno-180-62></a>      readOnly: false
<a id=__codelineno-180-63 name=__codelineno-180-63 href=#__codelineno-180-63></a>      subPath: &quot;config&quot;
<a id=__codelineno-180-64 name=__codelineno-180-64 href=#__codelineno-180-64></a>    - name: localtime
<a id=__codelineno-180-65 name=__codelineno-180-65 href=#__codelineno-180-65></a>      mountPath: /etc/localtime
<a id=__codelineno-180-66 name=__codelineno-180-66 href=#__codelineno-180-66></a>
<a id=__codelineno-180-67 name=__codelineno-180-67 href=#__codelineno-180-67></a>    - mountPath: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-180-68 name=__codelineno-180-68 href=#__codelineno-180-68></a>      name: &quot;workspace-volume&quot;
<a id=__codelineno-180-69 name=__codelineno-180-69 href=#__codelineno-180-69></a>      readOnly: false
<a id=__codelineno-180-70 name=__codelineno-180-70 href=#__codelineno-180-70></a>    workingDir: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-180-71 name=__codelineno-180-71 href=#__codelineno-180-71></a>
<a id=__codelineno-180-72 name=__codelineno-180-72 href=#__codelineno-180-72></a>  - name: &quot;build&quot;
<a id=__codelineno-180-73 name=__codelineno-180-73 href=#__codelineno-180-73></a>    image: &quot;hub.gitee.cc/kubernetes/golang:1.15&quot;
<a id=__codelineno-180-74 name=__codelineno-180-74 href=#__codelineno-180-74></a>    imagePullPolicy: &quot;IfNotPresent&quot;
<a id=__codelineno-180-75 name=__codelineno-180-75 href=#__codelineno-180-75></a>    tty: true
<a id=__codelineno-180-76 name=__codelineno-180-76 href=#__codelineno-180-76></a>    volumeMounts:
<a id=__codelineno-180-77 name=__codelineno-180-77 href=#__codelineno-180-77></a>      - name: localtime
<a id=__codelineno-180-78 name=__codelineno-180-78 href=#__codelineno-180-78></a>        mountPath: /etc/localtime
<a id=__codelineno-180-79 name=__codelineno-180-79 href=#__codelineno-180-79></a>      - name:  cachedir
<a id=__codelineno-180-80 name=__codelineno-180-80 href=#__codelineno-180-80></a>        mountPath: &quot;/go/pkg/&quot;
<a id=__codelineno-180-81 name=__codelineno-180-81 href=#__codelineno-180-81></a>        readOnly: false
<a id=__codelineno-180-82 name=__codelineno-180-82 href=#__codelineno-180-82></a>    command:
<a id=__codelineno-180-83 name=__codelineno-180-83 href=#__codelineno-180-83></a>      - &quot;cat&quot;
<a id=__codelineno-180-84 name=__codelineno-180-84 href=#__codelineno-180-84></a>    env:
<a id=__codelineno-180-85 name=__codelineno-180-85 href=#__codelineno-180-85></a>      - name: &quot;LANGUAGE&quot;
<a id=__codelineno-180-86 name=__codelineno-180-86 href=#__codelineno-180-86></a>        value: &quot;en_US:en&quot;
<a id=__codelineno-180-87 name=__codelineno-180-87 href=#__codelineno-180-87></a>      - name: &quot;LC_ALL&quot;
<a id=__codelineno-180-88 name=__codelineno-180-88 href=#__codelineno-180-88></a>        value: &quot;en_US.UTF-8&quot;
<a id=__codelineno-180-89 name=__codelineno-180-89 href=#__codelineno-180-89></a>      - name: &quot;LANG&quot;
<a id=__codelineno-180-90 name=__codelineno-180-90 href=#__codelineno-180-90></a>        value: &quot;en_US.UTF-8&quot;
<a id=__codelineno-180-91 name=__codelineno-180-91 href=#__codelineno-180-91></a>
<a id=__codelineno-180-92 name=__codelineno-180-92 href=#__codelineno-180-92></a>  volumes:
<a id=__codelineno-180-93 name=__codelineno-180-93 href=#__codelineno-180-93></a>    - name: localtime
<a id=__codelineno-180-94 name=__codelineno-180-94 href=#__codelineno-180-94></a>      hostPath:
<a id=__codelineno-180-95 name=__codelineno-180-95 href=#__codelineno-180-95></a>        path: /usr/share/zoneinfo/Asia/Shanghai
<a id=__codelineno-180-96 name=__codelineno-180-96 href=#__codelineno-180-96></a>
<a id=__codelineno-180-97 name=__codelineno-180-97 href=#__codelineno-180-97></a>    - configMap:
<a id=__codelineno-180-98 name=__codelineno-180-98 href=#__codelineno-180-98></a>        name: &quot;kubeconfig&quot;
<a id=__codelineno-180-99 name=__codelineno-180-99 href=#__codelineno-180-99></a>        optional: false
<a id=__codelineno-180-100 name=__codelineno-180-100 href=#__codelineno-180-100></a>      name: &quot;volume-0&quot;
<a id=__codelineno-180-101 name=__codelineno-180-101 href=#__codelineno-180-101></a>    # 缓存目录
<a id=__codelineno-180-102 name=__codelineno-180-102 href=#__codelineno-180-102></a>    - name: &quot;cachedir&quot;
<a id=__codelineno-180-103 name=__codelineno-180-103 href=#__codelineno-180-103></a>      hostPath:
<a id=__codelineno-180-104 name=__codelineno-180-104 href=#__codelineno-180-104></a>        path: &quot;/opt/gopkg&quot;
<a id=__codelineno-180-105 name=__codelineno-180-105 href=#__codelineno-180-105></a>
<a id=__codelineno-180-106 name=__codelineno-180-106 href=#__codelineno-180-106></a>    - emptyDir:
<a id=__codelineno-180-107 name=__codelineno-180-107 href=#__codelineno-180-107></a>        medium: &quot;&quot;
<a id=__codelineno-180-108 name=__codelineno-180-108 href=#__codelineno-180-108></a>      name: &quot;workspace-volume&quot;
<a id=__codelineno-180-109 name=__codelineno-180-109 href=#__codelineno-180-109></a>  restartPolicy: Always
<a id=__codelineno-180-110 name=__codelineno-180-110 href=#__codelineno-180-110></a>  hostNetwork: false
<a id=__codelineno-180-111 name=__codelineno-180-111 href=#__codelineno-180-111></a>  imagePullSecrets:
<a id=__codelineno-180-112 name=__codelineno-180-112 href=#__codelineno-180-112></a>  - name: &quot;regcred&quot;
<a id=__codelineno-180-113 name=__codelineno-180-113 href=#__codelineno-180-113></a>  # 固定节点部署
<a id=__codelineno-180-114 name=__codelineno-180-114 href=#__codelineno-180-114></a>  nodeSelector:
<a id=__codelineno-180-115 name=__codelineno-180-115 href=#__codelineno-180-115></a>    build: &quot;true&quot;
<a id=__codelineno-180-116 name=__codelineno-180-116 href=#__codelineno-180-116></a>
<a id=__codelineno-180-117 name=__codelineno-180-117 href=#__codelineno-180-117></a>            &#39;&#39;&#39;
<a id=__codelineno-180-118 name=__codelineno-180-118 href=#__codelineno-180-118></a>        }
<a id=__codelineno-180-119 name=__codelineno-180-119 href=#__codelineno-180-119></a>    }
<a id=__codelineno-180-120 name=__codelineno-180-120 href=#__codelineno-180-120></a>
<a id=__codelineno-180-121 name=__codelineno-180-121 href=#__codelineno-180-121></a>    stages {
<a id=__codelineno-180-122 name=__codelineno-180-122 href=#__codelineno-180-122></a>      stage(&#39;Pulling Code&#39;) {
<a id=__codelineno-180-123 name=__codelineno-180-123 href=#__codelineno-180-123></a>        parallel {
<a id=__codelineno-180-124 name=__codelineno-180-124 href=#__codelineno-180-124></a>        stage(&#39;Pulling Code by Jenkins&#39;) {
<a id=__codelineno-180-125 name=__codelineno-180-125 href=#__codelineno-180-125></a>          when {
<a id=__codelineno-180-126 name=__codelineno-180-126 href=#__codelineno-180-126></a>            expression {
<a id=__codelineno-180-127 name=__codelineno-180-127 href=#__codelineno-180-127></a>              env.gitlabBranch == null
<a id=__codelineno-180-128 name=__codelineno-180-128 href=#__codelineno-180-128></a>            }
<a id=__codelineno-180-129 name=__codelineno-180-129 href=#__codelineno-180-129></a>
<a id=__codelineno-180-130 name=__codelineno-180-130 href=#__codelineno-180-130></a>          }
<a id=__codelineno-180-131 name=__codelineno-180-131 href=#__codelineno-180-131></a>          steps {
<a id=__codelineno-180-132 name=__codelineno-180-132 href=#__codelineno-180-132></a>            git(changelog: true, poll: true, url: &#39;http://gitlab.runjs.cn:8929/kubernetes/go-project.git&#39;, branch: &quot;${BRANCH}&quot;, credentialsId: &quot;${GITLAB_AUTH}&quot;)
<a id=__codelineno-180-133 name=__codelineno-180-133 href=#__codelineno-180-133></a>            script {
<a id=__codelineno-180-134 name=__codelineno-180-134 href=#__codelineno-180-134></a>              COMMIT_ID = sh(returnStdout: true, script: &quot;git log -n 1 --pretty=format:&#39;%h&#39;&quot;).trim()
<a id=__codelineno-180-135 name=__codelineno-180-135 href=#__codelineno-180-135></a>              TAG = BUILD_TAG + &#39;-&#39; + COMMIT_ID
<a id=__codelineno-180-136 name=__codelineno-180-136 href=#__codelineno-180-136></a>              println &quot;Current branch is ${BRANCH}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}&quot;
<a id=__codelineno-180-137 name=__codelineno-180-137 href=#__codelineno-180-137></a>
<a id=__codelineno-180-138 name=__codelineno-180-138 href=#__codelineno-180-138></a>            }
<a id=__codelineno-180-139 name=__codelineno-180-139 href=#__codelineno-180-139></a>
<a id=__codelineno-180-140 name=__codelineno-180-140 href=#__codelineno-180-140></a>          }
<a id=__codelineno-180-141 name=__codelineno-180-141 href=#__codelineno-180-141></a>        }
<a id=__codelineno-180-142 name=__codelineno-180-142 href=#__codelineno-180-142></a>        stage(&#39;Pulling Code by trigger&#39;) {
<a id=__codelineno-180-143 name=__codelineno-180-143 href=#__codelineno-180-143></a>          when {
<a id=__codelineno-180-144 name=__codelineno-180-144 href=#__codelineno-180-144></a>            expression {
<a id=__codelineno-180-145 name=__codelineno-180-145 href=#__codelineno-180-145></a>              env.gitlabBranch != null
<a id=__codelineno-180-146 name=__codelineno-180-146 href=#__codelineno-180-146></a>            }
<a id=__codelineno-180-147 name=__codelineno-180-147 href=#__codelineno-180-147></a>
<a id=__codelineno-180-148 name=__codelineno-180-148 href=#__codelineno-180-148></a>          }
<a id=__codelineno-180-149 name=__codelineno-180-149 href=#__codelineno-180-149></a>          steps {
<a id=__codelineno-180-150 name=__codelineno-180-150 href=#__codelineno-180-150></a>            git(url: &#39;http://gitlab.runjs.cn:8929/kubernetes/go-project.git&#39;, branch: env.gitlabBranch, changelog: true, poll: true, credentialsId: &quot;${GITLAB_AUTH}&quot;)
<a id=__codelineno-180-151 name=__codelineno-180-151 href=#__codelineno-180-151></a>            script {
<a id=__codelineno-180-152 name=__codelineno-180-152 href=#__codelineno-180-152></a>              COMMIT_ID = sh(returnStdout: true, script: &quot;git log -n 1 --pretty=format:&#39;%h&#39;&quot;).trim()
<a id=__codelineno-180-153 name=__codelineno-180-153 href=#__codelineno-180-153></a>              TAG = BUILD_TAG + &#39;-&#39; + COMMIT_ID
<a id=__codelineno-180-154 name=__codelineno-180-154 href=#__codelineno-180-154></a>              println &quot;Current branch is ${env.gitlabBranch}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}&quot;
<a id=__codelineno-180-155 name=__codelineno-180-155 href=#__codelineno-180-155></a>              }
<a id=__codelineno-180-156 name=__codelineno-180-156 href=#__codelineno-180-156></a>            }
<a id=__codelineno-180-157 name=__codelineno-180-157 href=#__codelineno-180-157></a>          }
<a id=__codelineno-180-158 name=__codelineno-180-158 href=#__codelineno-180-158></a>        }
<a id=__codelineno-180-159 name=__codelineno-180-159 href=#__codelineno-180-159></a>      }
<a id=__codelineno-180-160 name=__codelineno-180-160 href=#__codelineno-180-160></a>
<a id=__codelineno-180-161 name=__codelineno-180-161 href=#__codelineno-180-161></a>    stage(&#39;Building&#39;) {
<a id=__codelineno-180-162 name=__codelineno-180-162 href=#__codelineno-180-162></a>      steps {
<a id=__codelineno-180-163 name=__codelineno-180-163 href=#__codelineno-180-163></a>        container(name: &#39;build&#39;) {
<a id=__codelineno-180-164 name=__codelineno-180-164 href=#__codelineno-180-164></a>            sh &quot;&quot;&quot;
<a id=__codelineno-180-165 name=__codelineno-180-165 href=#__codelineno-180-165></a>               export GO111MODULE=on
<a id=__codelineno-180-166 name=__codelineno-180-166 href=#__codelineno-180-166></a>               go env -w GOPROXY=https://goproxy.cn,direct
<a id=__codelineno-180-167 name=__codelineno-180-167 href=#__codelineno-180-167></a>               go build
<a id=__codelineno-180-168 name=__codelineno-180-168 href=#__codelineno-180-168></a>            &quot;&quot;&quot;
<a id=__codelineno-180-169 name=__codelineno-180-169 href=#__codelineno-180-169></a>        }
<a id=__codelineno-180-170 name=__codelineno-180-170 href=#__codelineno-180-170></a>      }
<a id=__codelineno-180-171 name=__codelineno-180-171 href=#__codelineno-180-171></a>    }
<a id=__codelineno-180-172 name=__codelineno-180-172 href=#__codelineno-180-172></a>
<a id=__codelineno-180-173 name=__codelineno-180-173 href=#__codelineno-180-173></a>    stage(&#39;Docker build for creating image&#39;) {
<a id=__codelineno-180-174 name=__codelineno-180-174 href=#__codelineno-180-174></a>      steps {
<a id=__codelineno-180-175 name=__codelineno-180-175 href=#__codelineno-180-175></a>        withCredentials([[$class: &#39;UsernamePasswordMultiBinding&#39;,
<a id=__codelineno-180-176 name=__codelineno-180-176 href=#__codelineno-180-176></a>        credentialsId: &quot;${HARBOR_AUTH}&quot;,
<a id=__codelineno-180-177 name=__codelineno-180-177 href=#__codelineno-180-177></a>        usernameVariable: &#39;Harbor_user&#39;,
<a id=__codelineno-180-178 name=__codelineno-180-178 href=#__codelineno-180-178></a>        passwordVariable: &#39;Harbor_password&#39;]]) {
<a id=__codelineno-180-179 name=__codelineno-180-179 href=#__codelineno-180-179></a>            sh &quot;&quot;&quot;#!/bin/bash
<a id=__codelineno-180-180 name=__codelineno-180-180 href=#__codelineno-180-180></a>              set -eux
<a id=__codelineno-180-181 name=__codelineno-180-181 href=#__codelineno-180-181></a>              docker login -u ${Harbor_user} -p ${Harbor_password} ${HARBOR_ADDRESS}
<a id=__codelineno-180-182 name=__codelineno-180-182 href=#__codelineno-180-182></a>
<a id=__codelineno-180-183 name=__codelineno-180-183 href=#__codelineno-180-183></a>              docker build --no-cache -t ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG} .
<a id=__codelineno-180-184 name=__codelineno-180-184 href=#__codelineno-180-184></a>
<a id=__codelineno-180-185 name=__codelineno-180-185 href=#__codelineno-180-185></a>              docker push ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG}
<a id=__codelineno-180-186 name=__codelineno-180-186 href=#__codelineno-180-186></a>              docker rmi -f ${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG}
<a id=__codelineno-180-187 name=__codelineno-180-187 href=#__codelineno-180-187></a>              &quot;&quot;&quot;
<a id=__codelineno-180-188 name=__codelineno-180-188 href=#__codelineno-180-188></a>        }
<a id=__codelineno-180-189 name=__codelineno-180-189 href=#__codelineno-180-189></a>      }
<a id=__codelineno-180-190 name=__codelineno-180-190 href=#__codelineno-180-190></a>    }
<a id=__codelineno-180-191 name=__codelineno-180-191 href=#__codelineno-180-191></a>
<a id=__codelineno-180-192 name=__codelineno-180-192 href=#__codelineno-180-192></a>    stage(&#39;Deploying to K8s&#39;) {
<a id=__codelineno-180-193 name=__codelineno-180-193 href=#__codelineno-180-193></a>      steps {
<a id=__codelineno-180-194 name=__codelineno-180-194 href=#__codelineno-180-194></a>           sh &quot;&quot;&quot;#!/bin/bash
<a id=__codelineno-180-195 name=__codelineno-180-195 href=#__codelineno-180-195></a>           set -ux
<a id=__codelineno-180-196 name=__codelineno-180-196 href=#__codelineno-180-196></a>           kubectl set image deploy -l app=${IMAGE_NAME} ${IMAGE_NAME}=${HARBOR_ADDRESS}/${REGISTRY_DIR}/${IMAGE_NAME}:${TAG} -n $NAMESPACE
<a id=__codelineno-180-197 name=__codelineno-180-197 href=#__codelineno-180-197></a>           &quot;&quot;&quot;
<a id=__codelineno-180-198 name=__codelineno-180-198 href=#__codelineno-180-198></a>      }
<a id=__codelineno-180-199 name=__codelineno-180-199 href=#__codelineno-180-199></a>    }
<a id=__codelineno-180-200 name=__codelineno-180-200 href=#__codelineno-180-200></a>  }
<a id=__codelineno-180-201 name=__codelineno-180-201 href=#__codelineno-180-201></a>    post {
<a id=__codelineno-180-202 name=__codelineno-180-202 href=#__codelineno-180-202></a>        failure {
<a id=__codelineno-180-203 name=__codelineno-180-203 href=#__codelineno-180-203></a>            updateGitlabCommitStatus name: &quot;build&quot;, state: &quot;failed&quot;
<a id=__codelineno-180-204 name=__codelineno-180-204 href=#__codelineno-180-204></a>        }
<a id=__codelineno-180-205 name=__codelineno-180-205 href=#__codelineno-180-205></a>        success {
<a id=__codelineno-180-206 name=__codelineno-180-206 href=#__codelineno-180-206></a>            updateGitlabCommitStatus name: &quot;build&quot;, state: &quot;success&quot;
<a id=__codelineno-180-207 name=__codelineno-180-207 href=#__codelineno-180-207></a>        }
<a id=__codelineno-180-208 name=__codelineno-180-208 href=#__codelineno-180-208></a>    }
<a id=__codelineno-180-209 name=__codelineno-180-209 href=#__codelineno-180-209></a>}
</code></pre></div> <h3 id=82-定义dockerfile>8.2 定义Dockerfile<a class=headerlink href=#82-定义dockerfile title="Permanent link">&para;</a></h3> <p>和之前不一样的地方是，Golang编译后生成的是一个二进制文件，可以直接执行，所以底层镜像设置为alpine或者其他的小镜像即可：</p> <p><code>Dockerfile</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-181-1 name=__codelineno-181-1 href=#__codelineno-181-1></a><span class=k>FROM</span><span class=w> </span><span class=s>registry.cn-beijing.aliyuncs.com/dotbalo/alpine-glibc:alpine-3.9</span>
<a id=__codelineno-181-2 name=__codelineno-181-2 href=#__codelineno-181-2></a>
<a id=__codelineno-181-3 name=__codelineno-181-3 href=#__codelineno-181-3></a><span class=c># 如果定义了单独的配置文件，可能需要拷贝到镜像中</span>
<a id=__codelineno-181-4 name=__codelineno-181-4 href=#__codelineno-181-4></a><span class=k>COPY</span><span class=w> </span>conf/<span class=w>  </span>./conf<span class=w> </span>
<a id=__codelineno-181-5 name=__codelineno-181-5 href=#__codelineno-181-5></a><span class=c># 包名按照实际情况进行修改</span>
<a id=__codelineno-181-6 name=__codelineno-181-6 href=#__codelineno-181-6></a><span class=k>COPY</span><span class=w> </span>./go-project<span class=w> </span>./<span class=w> </span>
<a id=__codelineno-181-7 name=__codelineno-181-7 href=#__codelineno-181-7></a><span class=k>EXPOSE</span><span class=w> </span><span class=s>8080</span>
<a id=__codelineno-181-8 name=__codelineno-181-8 href=#__codelineno-181-8></a>
<a id=__codelineno-181-9 name=__codelineno-181-9 href=#__codelineno-181-9></a><span class=k>ENTRYPOINT</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&quot;./go-project&quot;</span><span class=p>]</span><span class=w> </span>#<span class=w> </span>启动该应用
</code></pre></div> <h3 id=83-定义kubernets资源>8.3 定义Kubernets资源<a class=headerlink href=#83-定义kubernets资源 title="Permanent link">&para;</a></h3> <p><code>go-project-deployment.yaml</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-182-1 name=__codelineno-182-1 href=#__codelineno-182-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id=__codelineno-182-2 name=__codelineno-182-2 href=#__codelineno-182-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a id=__codelineno-182-3 name=__codelineno-182-3 href=#__codelineno-182-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-182-4 name=__codelineno-182-4 href=#__codelineno-182-4></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-182-5 name=__codelineno-182-5 href=#__codelineno-182-5></a><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">go-project</span>
<a id=__codelineno-182-6 name=__codelineno-182-6 href=#__codelineno-182-6></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">go-project</span>
<a id=__codelineno-182-7 name=__codelineno-182-7 href=#__codelineno-182-7></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
<a id=__codelineno-182-8 name=__codelineno-182-8 href=#__codelineno-182-8></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-182-9 name=__codelineno-182-9 href=#__codelineno-182-9></a><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-182-10 name=__codelineno-182-10 href=#__codelineno-182-10></a><span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
<a id=__codelineno-182-11 name=__codelineno-182-11 href=#__codelineno-182-11></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-182-12 name=__codelineno-182-12 href=#__codelineno-182-12></a><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">go-project</span>
<a id=__codelineno-182-13 name=__codelineno-182-13 href=#__codelineno-182-13></a><span class=w>  </span><span class=nt>template</span><span class=p>:</span>
<a id=__codelineno-182-14 name=__codelineno-182-14 href=#__codelineno-182-14></a><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-182-15 name=__codelineno-182-15 href=#__codelineno-182-15></a><span class=w>      </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-182-16 name=__codelineno-182-16 href=#__codelineno-182-16></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">go-project</span>
<a id=__codelineno-182-17 name=__codelineno-182-17 href=#__codelineno-182-17></a><span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-182-18 name=__codelineno-182-18 href=#__codelineno-182-18></a><span class=w>      </span><span class=nt>containers</span><span class=p>:</span>
<a id=__codelineno-182-19 name=__codelineno-182-19 href=#__codelineno-182-19></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>env</span><span class=p>:</span>
<a id=__codelineno-182-20 name=__codelineno-182-20 href=#__codelineno-182-20></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TZ</span>
<a id=__codelineno-182-21 name=__codelineno-182-21 href=#__codelineno-182-21></a><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Asia/Shanghai</span>
<a id=__codelineno-182-22 name=__codelineno-182-22 href=#__codelineno-182-22></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">LANG</span>
<a id=__codelineno-182-23 name=__codelineno-182-23 href=#__codelineno-182-23></a><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">C.UTF-8</span>
<a id=__codelineno-182-24 name=__codelineno-182-24 href=#__codelineno-182-24></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id=__codelineno-182-25 name=__codelineno-182-25 href=#__codelineno-182-25></a><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
<a id=__codelineno-182-26 name=__codelineno-182-26 href=#__codelineno-182-26></a><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span>
<a id=__codelineno-182-27 name=__codelineno-182-27 href=#__codelineno-182-27></a><span class=w>          </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a id=__codelineno-182-28 name=__codelineno-182-28 href=#__codelineno-182-28></a><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<a id=__codelineno-182-29 name=__codelineno-182-29 href=#__codelineno-182-29></a><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<a id=__codelineno-182-30 name=__codelineno-182-30 href=#__codelineno-182-30></a><span class=w>          </span><span class=nt>successThreshold</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-182-31 name=__codelineno-182-31 href=#__codelineno-182-31></a><span class=w>          </span><span class=nt>tcpSocket</span><span class=p>:</span>
<a id=__codelineno-182-32 name=__codelineno-182-32 href=#__codelineno-182-32></a><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<a id=__codelineno-182-33 name=__codelineno-182-33 href=#__codelineno-182-33></a><span class=w>          </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a id=__codelineno-182-34 name=__codelineno-182-34 href=#__codelineno-182-34></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">go-project</span>
<a id=__codelineno-182-35 name=__codelineno-182-35 href=#__codelineno-182-35></a><span class=w>        </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-182-36 name=__codelineno-182-36 href=#__codelineno-182-36></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<a id=__codelineno-182-37 name=__codelineno-182-37 href=#__codelineno-182-37></a><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<a id=__codelineno-182-38 name=__codelineno-182-38 href=#__codelineno-182-38></a><span class=w>          </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<a id=__codelineno-182-39 name=__codelineno-182-39 href=#__codelineno-182-39></a><span class=w>        </span><span class=nt>resources</span><span class=p>:</span>
<a id=__codelineno-182-40 name=__codelineno-182-40 href=#__codelineno-182-40></a><span class=w>          </span><span class=nt>limits</span><span class=p>:</span>
<a id=__codelineno-182-41 name=__codelineno-182-41 href=#__codelineno-182-41></a><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">994m</span>
<a id=__codelineno-182-42 name=__codelineno-182-42 href=#__codelineno-182-42></a><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1170Mi</span>
<a id=__codelineno-182-43 name=__codelineno-182-43 href=#__codelineno-182-43></a><span class=w>          </span><span class=nt>requests</span><span class=p>:</span>
<a id=__codelineno-182-44 name=__codelineno-182-44 href=#__codelineno-182-44></a><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10m</span>
<a id=__codelineno-182-45 name=__codelineno-182-45 href=#__codelineno-182-45></a><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">55Mi</span>
<a id=__codelineno-182-46 name=__codelineno-182-46 href=#__codelineno-182-46></a><span class=w>      </span><span class=nt>dnsPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterFirst</span>
<a id=__codelineno-182-47 name=__codelineno-182-47 href=#__codelineno-182-47></a><span class=w>      </span><span class=nt>imagePullSecrets</span><span class=p>:</span>
<a id=__codelineno-182-48 name=__codelineno-182-48 href=#__codelineno-182-48></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">harborkey</span>
<a id=__codelineno-182-49 name=__codelineno-182-49 href=#__codelineno-182-49></a><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<a id=__codelineno-182-50 name=__codelineno-182-50 href=#__codelineno-182-50></a><span class=w>      </span><span class=nt>securityContext</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span>
<a id=__codelineno-182-51 name=__codelineno-182-51 href=#__codelineno-182-51></a><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</code></pre></div> <p><code>go-project-svc-ingress.yaml</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-183-1 name=__codelineno-183-1 href=#__codelineno-183-1></a><span class=nn>---</span>
<a id=__codelineno-183-2 name=__codelineno-183-2 href=#__codelineno-183-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-183-3 name=__codelineno-183-3 href=#__codelineno-183-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<a id=__codelineno-183-4 name=__codelineno-183-4 href=#__codelineno-183-4></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-183-5 name=__codelineno-183-5 href=#__codelineno-183-5></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-183-6 name=__codelineno-183-6 href=#__codelineno-183-6></a><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">go-project</span>
<a id=__codelineno-183-7 name=__codelineno-183-7 href=#__codelineno-183-7></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">go-project</span>
<a id=__codelineno-183-8 name=__codelineno-183-8 href=#__codelineno-183-8></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
<a id=__codelineno-183-9 name=__codelineno-183-9 href=#__codelineno-183-9></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-183-10 name=__codelineno-183-10 href=#__codelineno-183-10></a><span class=w>  </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-183-11 name=__codelineno-183-11 href=#__codelineno-183-11></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<a id=__codelineno-183-12 name=__codelineno-183-12 href=#__codelineno-183-12></a><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<a id=__codelineno-183-13 name=__codelineno-183-13 href=#__codelineno-183-13></a><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<a id=__codelineno-183-14 name=__codelineno-183-14 href=#__codelineno-183-14></a><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<a id=__codelineno-183-15 name=__codelineno-183-15 href=#__codelineno-183-15></a><span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
<a id=__codelineno-183-16 name=__codelineno-183-16 href=#__codelineno-183-16></a><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">go-project</span>
<a id=__codelineno-183-17 name=__codelineno-183-17 href=#__codelineno-183-17></a><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
<a id=__codelineno-183-18 name=__codelineno-183-18 href=#__codelineno-183-18></a>
<a id=__codelineno-183-19 name=__codelineno-183-19 href=#__codelineno-183-19></a><span class=nn>---</span>
<a id=__codelineno-183-20 name=__codelineno-183-20 href=#__codelineno-183-20></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<a id=__codelineno-183-21 name=__codelineno-183-21 href=#__codelineno-183-21></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<a id=__codelineno-183-22 name=__codelineno-183-22 href=#__codelineno-183-22></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-183-23 name=__codelineno-183-23 href=#__codelineno-183-23></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">go-project</span>
<a id=__codelineno-183-24 name=__codelineno-183-24 href=#__codelineno-183-24></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
<a id=__codelineno-183-25 name=__codelineno-183-25 href=#__codelineno-183-25></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-183-26 name=__codelineno-183-26 href=#__codelineno-183-26></a><span class=w>  </span><span class=nt>ingressClassName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id=__codelineno-183-27 name=__codelineno-183-27 href=#__codelineno-183-27></a><span class=w>  </span><span class=nt>rules</span><span class=p>:</span>
<a id=__codelineno-183-28 name=__codelineno-183-28 href=#__codelineno-183-28></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">go-project.test.com</span>
<a id=__codelineno-183-29 name=__codelineno-183-29 href=#__codelineno-183-29></a><span class=w>    </span><span class=nt>http</span><span class=p>:</span>
<a id=__codelineno-183-30 name=__codelineno-183-30 href=#__codelineno-183-30></a><span class=w>      </span><span class=nt>paths</span><span class=p>:</span>
<a id=__codelineno-183-31 name=__codelineno-183-31 href=#__codelineno-183-31></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>backend</span><span class=p>:</span>
<a id=__codelineno-183-32 name=__codelineno-183-32 href=#__codelineno-183-32></a><span class=w>          </span><span class=nt>service</span><span class=p>:</span>
<a id=__codelineno-183-33 name=__codelineno-183-33 href=#__codelineno-183-33></a><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">go-project</span>
<a id=__codelineno-183-34 name=__codelineno-183-34 href=#__codelineno-183-34></a><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span>
<a id=__codelineno-183-35 name=__codelineno-183-35 href=#__codelineno-183-35></a><span class=w>              </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<a id=__codelineno-183-36 name=__codelineno-183-36 href=#__codelineno-183-36></a><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<a id=__codelineno-183-37 name=__codelineno-183-37 href=#__codelineno-183-37></a><span class=w>        </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ImplementationSpecific</span>
</code></pre></div> <p>创建该资源：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-184-1 name=__codelineno-184-1 href=#__codelineno-184-1></a>$<span class=w> </span>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>go-project-deployment.yaml
<a id=__codelineno-184-2 name=__codelineno-184-2 href=#__codelineno-184-2></a>deployment.apps/go-project<span class=w> </span>created
<a id=__codelineno-184-3 name=__codelineno-184-3 href=#__codelineno-184-3></a>
<a id=__codelineno-184-4 name=__codelineno-184-4 href=#__codelineno-184-4></a>$<span class=w> </span>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>go-project-svc-ingress.yaml
<a id=__codelineno-184-5 name=__codelineno-184-5 href=#__codelineno-184-5></a>service/go-project<span class=w> </span>created
<a id=__codelineno-184-6 name=__codelineno-184-6 href=#__codelineno-184-6></a>ingress.networking.k8s.io/go-project<span class=w> </span>created
<a id=__codelineno-184-7 name=__codelineno-184-7 href=#__codelineno-184-7></a>
<a id=__codelineno-184-8 name=__codelineno-184-8 href=#__codelineno-184-8></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pod<span class=w> </span>-n<span class=w> </span>kubernetes
<a id=__codelineno-184-9 name=__codelineno-184-9 href=#__codelineno-184-9></a>NAME<span class=w>                          </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>      </span>AGE
<a id=__codelineno-184-10 name=__codelineno-184-10 href=#__codelineno-184-10></a>go-project-5b47cfcc8f-rbmm8<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>1</span><span class=w> </span><span class=o>(</span>19s<span class=w> </span>ago<span class=o>)</span><span class=w>   </span>72s
</code></pre></div> <h3 id=84-创建jenkins-job>8.4 创建Jenkins Job<a class=headerlink href=#84-创建jenkins-job title="Permanent link">&para;</a></h3> <p>创建Jenkins Job和前面也没有区别，在此不再重复演示。</p> <p>接下来可以查看Deployment的镜像：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-185-1 name=__codelineno-185-1 href=#__codelineno-185-1></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>deployment<span class=w> </span>-o<span class=w> </span>yaml<span class=w> </span>-n<span class=w> </span>kubernetes<span class=w> </span><span class=p>|</span>grep<span class=w> </span><span class=s2>&quot;image: &quot;</span>
<a id=__codelineno-185-2 name=__codelineno-185-2 href=#__codelineno-185-2></a><span class=w>          </span>image:<span class=w> </span>hub.gitee.cc/kubernetes/go-project:jenkins-go-project-2-2cd059f
<a id=__codelineno-185-3 name=__codelineno-185-3 href=#__codelineno-185-3></a>
<a id=__codelineno-185-4 name=__codelineno-185-4 href=#__codelineno-185-4></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pod<span class=w> </span>-n<span class=w> </span>kubernetes
<a id=__codelineno-185-5 name=__codelineno-185-5 href=#__codelineno-185-5></a>NAME<span class=w>                          </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>   </span>AGE
<a id=__codelineno-185-6 name=__codelineno-185-6 href=#__codelineno-185-6></a>go-project-6d8f6bddd6-jd5l7<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>94s
</code></pre></div> <p>之后即可访问该应用（如果是后端项目，则无须创建Ingress暴露服务）</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-62.png></p> <p>之后在创建Pod的节点可以看到缓存目录：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-186-1 name=__codelineno-186-1 href=#__codelineno-186-1></a>$<span class=w> </span><span class=nb>cd</span><span class=w> </span>/opt/gopkg/
<a id=__codelineno-186-2 name=__codelineno-186-2 href=#__codelineno-186-2></a><span class=o>[</span>root@k8s-node01<span class=w> </span>gopkg<span class=o>]</span><span class=c1># ll</span>
<a id=__codelineno-186-3 name=__codelineno-186-3 href=#__codelineno-186-3></a>total<span class=w> </span><span class=m>0</span>
<a id=__codelineno-186-4 name=__codelineno-186-4 href=#__codelineno-186-4></a>drwxr-xr-x<span class=w> </span><span class=m>7</span><span class=w> </span>root<span class=w> </span>root<span class=w> </span><span class=m>96</span><span class=w> </span>Feb<span class=w> </span><span class=m>22</span><span class=w> </span><span class=m>15</span>:49<span class=w> </span>mod
<a id=__codelineno-186-5 name=__codelineno-186-5 href=#__codelineno-186-5></a>drwxr-xr-x<span class=w> </span><span class=m>3</span><span class=w> </span>root<span class=w> </span>root<span class=w> </span><span class=m>28</span><span class=w> </span>Feb<span class=w> </span><span class=m>22</span><span class=w> </span><span class=m>15</span>:49<span class=w> </span>sumdb
</code></pre></div> <p>编写代码，更新代码到gitlab仓库中。 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-63.png></p> <p>重新触发jenkins pipeline。 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-64.png></p> <p>查看代码发布更新状态。 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-65.png></p> <h2 id=9-uat及生产环境流水线设计>9. UAT及生产环境流水线设计<a class=headerlink href=#9-uat及生产环境流水线设计 title="Permanent link">&para;</a></h2> <p>上述演示示例都包含构建过程，一般会用在首次提交代码，然后构建，并发布至第一个项目的环境中，一般是开发环境或者测试环境。这类环境采 用这种模式没有问题，因为构建和产生镜像的步骤是必需的。</p> <p>但是在其他环境，比如Sit、UAT、生产环境，其实是没有必要重复构建的，可以直接选择镜像进行发版，当然这种模式和代码本身的设计有关系， 也就是要做到配置分离和构建与代码配置无关才行。</p> <p>如果读者的项目符合此类条件，可以将第一次构建的镜像发布到任意环境，可以采用镜像的方式进行发版，也可以使用该流水线进行回滚操作。</p> <p>假如我们有一个go-project的UAT环境，该环境的发版不需要构建，只需要选择测试环境的镜像即可，此时UAT环境（选择镜像发版）的Jenkins Job 配置如下。</p> <p>创建一个新的Job，名字为go-project-uat，类型为Pipeline，如图 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-66.png></p> <p>勾选页面上的This project is parameterized（参数化构建），选择参数类型为Image Tag Parameter（需要安装Image Tag插件），之后定义Name为变量的名称，Image Name为Harbor的目录和镜像名称，如图</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-67.png></p> <p>添加Image Tag参数 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-68.png></p> <p>配置Harbor地址 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-69.png></p> <p>之后可以先单击Save，然后测试能否获取到Tag，如下图所示，保存后单击Build with Parameters。 <img alt class=zoom src=../../../assets/static/kubernetes/6/6-70.png></p> <p>之后单击Configure，添加Pipeline脚本：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-187-1 name=__codelineno-187-1 href=#__codelineno-187-1></a>pipeline{
<a id=__codelineno-187-2 name=__codelineno-187-2 href=#__codelineno-187-2></a>    environment {
<a id=__codelineno-187-3 name=__codelineno-187-3 href=#__codelineno-187-3></a>        HARBOR_ADDRESS = &quot;hub.gitee.cc&quot;
<a id=__codelineno-187-4 name=__codelineno-187-4 href=#__codelineno-187-4></a>        NAMESPACE = &quot;kubernetes&quot;
<a id=__codelineno-187-5 name=__codelineno-187-5 href=#__codelineno-187-5></a>        IMAGE_NAME = &quot;go-project&quot;
<a id=__codelineno-187-6 name=__codelineno-187-6 href=#__codelineno-187-6></a>        TAG = &quot;&quot;
<a id=__codelineno-187-7 name=__codelineno-187-7 href=#__codelineno-187-7></a>    }
<a id=__codelineno-187-8 name=__codelineno-187-8 href=#__codelineno-187-8></a>
<a id=__codelineno-187-9 name=__codelineno-187-9 href=#__codelineno-187-9></a>    options {
<a id=__codelineno-187-10 name=__codelineno-187-10 href=#__codelineno-187-10></a>      parallelsAlwaysFailFast()
<a id=__codelineno-187-11 name=__codelineno-187-11 href=#__codelineno-187-11></a>      disableResume()
<a id=__codelineno-187-12 name=__codelineno-187-12 href=#__codelineno-187-12></a>      quietPeriod(1)
<a id=__codelineno-187-13 name=__codelineno-187-13 href=#__codelineno-187-13></a>      preserveStashes(buildCount: 5)
<a id=__codelineno-187-14 name=__codelineno-187-14 href=#__codelineno-187-14></a>      timestamps()
<a id=__codelineno-187-15 name=__codelineno-187-15 href=#__codelineno-187-15></a>      buildDiscarder(logRotator(numToKeepStr: &#39;100&#39;))
<a id=__codelineno-187-16 name=__codelineno-187-16 href=#__codelineno-187-16></a>      timeout(time: 60, unit: &#39;MINUTES&#39;)
<a id=__codelineno-187-17 name=__codelineno-187-17 href=#__codelineno-187-17></a>    }
<a id=__codelineno-187-18 name=__codelineno-187-18 href=#__codelineno-187-18></a>
<a id=__codelineno-187-19 name=__codelineno-187-19 href=#__codelineno-187-19></a>    agent {
<a id=__codelineno-187-20 name=__codelineno-187-20 href=#__codelineno-187-20></a>        kubernetes {
<a id=__codelineno-187-21 name=__codelineno-187-21 href=#__codelineno-187-21></a>            cloud &#39;kubernetes&#39;
<a id=__codelineno-187-22 name=__codelineno-187-22 href=#__codelineno-187-22></a>            slaveConnectTimeout 1200
<a id=__codelineno-187-23 name=__codelineno-187-23 href=#__codelineno-187-23></a>            workspaceVolume nfsWorkspaceVolume(serverAddress: &quot;192.168.1.60&quot;, serverPath: &quot;/QaTest/jenkins-salve&quot;, readOnly: &quot;false&quot;)
<a id=__codelineno-187-24 name=__codelineno-187-24 href=#__codelineno-187-24></a>            yaml &#39;&#39;&#39;
<a id=__codelineno-187-25 name=__codelineno-187-25 href=#__codelineno-187-25></a>apiVersion: v1
<a id=__codelineno-187-26 name=__codelineno-187-26 href=#__codelineno-187-26></a>kind: Pod
<a id=__codelineno-187-27 name=__codelineno-187-27 href=#__codelineno-187-27></a>metadata:
<a id=__codelineno-187-28 name=__codelineno-187-28 href=#__codelineno-187-28></a>  name: &quot;jenkins-slave&quot;
<a id=__codelineno-187-29 name=__codelineno-187-29 href=#__codelineno-187-29></a>  namespace: &quot;kube-ops&quot;
<a id=__codelineno-187-30 name=__codelineno-187-30 href=#__codelineno-187-30></a>  labels:
<a id=__codelineno-187-31 name=__codelineno-187-31 href=#__codelineno-187-31></a>    jenkins: &quot;slave&quot;
<a id=__codelineno-187-32 name=__codelineno-187-32 href=#__codelineno-187-32></a>    jenkins/label: &quot;jenkins-jnlp&quot;
<a id=__codelineno-187-33 name=__codelineno-187-33 href=#__codelineno-187-33></a>spec:
<a id=__codelineno-187-34 name=__codelineno-187-34 href=#__codelineno-187-34></a>  containers:
<a id=__codelineno-187-35 name=__codelineno-187-35 href=#__codelineno-187-35></a>  - name: &quot;jnlp&quot;
<a id=__codelineno-187-36 name=__codelineno-187-36 href=#__codelineno-187-36></a>    image: &quot;hub.gitee.cc/kubernetes/jenkins-salve:latet-jdk11&quot;
<a id=__codelineno-187-37 name=__codelineno-187-37 href=#__codelineno-187-37></a>    imagePullPolicy: &quot;IfNotPresent&quot;
<a id=__codelineno-187-38 name=__codelineno-187-38 href=#__codelineno-187-38></a>    tty: true
<a id=__codelineno-187-39 name=__codelineno-187-39 href=#__codelineno-187-39></a>    resources:
<a id=__codelineno-187-40 name=__codelineno-187-40 href=#__codelineno-187-40></a>      limits:
<a id=__codelineno-187-41 name=__codelineno-187-41 href=#__codelineno-187-41></a>        cpu: 1000m
<a id=__codelineno-187-42 name=__codelineno-187-42 href=#__codelineno-187-42></a>        memory: 2000Mi
<a id=__codelineno-187-43 name=__codelineno-187-43 href=#__codelineno-187-43></a>      requests:
<a id=__codelineno-187-44 name=__codelineno-187-44 href=#__codelineno-187-44></a>        cpu: 200m
<a id=__codelineno-187-45 name=__codelineno-187-45 href=#__codelineno-187-45></a>        memory: 400Mi
<a id=__codelineno-187-46 name=__codelineno-187-46 href=#__codelineno-187-46></a>    env:
<a id=__codelineno-187-47 name=__codelineno-187-47 href=#__codelineno-187-47></a>    - name: &quot;DOCKER_HOST&quot;
<a id=__codelineno-187-48 name=__codelineno-187-48 href=#__codelineno-187-48></a>      value: &quot;tcp://192.168.1.141:2375&quot;
<a id=__codelineno-187-49 name=__codelineno-187-49 href=#__codelineno-187-49></a>    - name: &quot;JENKINS_AGENT_WORKDIR&quot;
<a id=__codelineno-187-50 name=__codelineno-187-50 href=#__codelineno-187-50></a>      value: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-187-51 name=__codelineno-187-51 href=#__codelineno-187-51></a>    volumeMounts:
<a id=__codelineno-187-52 name=__codelineno-187-52 href=#__codelineno-187-52></a>    - mountPath: &quot;/root/.kube/config&quot;
<a id=__codelineno-187-53 name=__codelineno-187-53 href=#__codelineno-187-53></a>      name: &quot;volume-0&quot;
<a id=__codelineno-187-54 name=__codelineno-187-54 href=#__codelineno-187-54></a>      readOnly: false
<a id=__codelineno-187-55 name=__codelineno-187-55 href=#__codelineno-187-55></a>      subPath: &quot;config&quot;
<a id=__codelineno-187-56 name=__codelineno-187-56 href=#__codelineno-187-56></a>    - name: localtime
<a id=__codelineno-187-57 name=__codelineno-187-57 href=#__codelineno-187-57></a>      mountPath: /etc/localtime
<a id=__codelineno-187-58 name=__codelineno-187-58 href=#__codelineno-187-58></a>
<a id=__codelineno-187-59 name=__codelineno-187-59 href=#__codelineno-187-59></a>    - mountPath: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-187-60 name=__codelineno-187-60 href=#__codelineno-187-60></a>      name: &quot;workspace-volume&quot;
<a id=__codelineno-187-61 name=__codelineno-187-61 href=#__codelineno-187-61></a>      readOnly: false
<a id=__codelineno-187-62 name=__codelineno-187-62 href=#__codelineno-187-62></a>    workingDir: &quot;/home/jenkins/agent&quot;
<a id=__codelineno-187-63 name=__codelineno-187-63 href=#__codelineno-187-63></a>
<a id=__codelineno-187-64 name=__codelineno-187-64 href=#__codelineno-187-64></a>  volumes:
<a id=__codelineno-187-65 name=__codelineno-187-65 href=#__codelineno-187-65></a>    - name: localtime
<a id=__codelineno-187-66 name=__codelineno-187-66 href=#__codelineno-187-66></a>      hostPath:
<a id=__codelineno-187-67 name=__codelineno-187-67 href=#__codelineno-187-67></a>        path: /usr/share/zoneinfo/Asia/Shanghai
<a id=__codelineno-187-68 name=__codelineno-187-68 href=#__codelineno-187-68></a>
<a id=__codelineno-187-69 name=__codelineno-187-69 href=#__codelineno-187-69></a>    - configMap:
<a id=__codelineno-187-70 name=__codelineno-187-70 href=#__codelineno-187-70></a>        name: &quot;kubeconfig&quot;
<a id=__codelineno-187-71 name=__codelineno-187-71 href=#__codelineno-187-71></a>        optional: false
<a id=__codelineno-187-72 name=__codelineno-187-72 href=#__codelineno-187-72></a>      name: &quot;volume-0&quot;
<a id=__codelineno-187-73 name=__codelineno-187-73 href=#__codelineno-187-73></a>
<a id=__codelineno-187-74 name=__codelineno-187-74 href=#__codelineno-187-74></a>    - emptyDir:
<a id=__codelineno-187-75 name=__codelineno-187-75 href=#__codelineno-187-75></a>        medium: &quot;&quot;
<a id=__codelineno-187-76 name=__codelineno-187-76 href=#__codelineno-187-76></a>      name: &quot;workspace-volume&quot;
<a id=__codelineno-187-77 name=__codelineno-187-77 href=#__codelineno-187-77></a>  restartPolicy: Always
<a id=__codelineno-187-78 name=__codelineno-187-78 href=#__codelineno-187-78></a>  hostNetwork: false
<a id=__codelineno-187-79 name=__codelineno-187-79 href=#__codelineno-187-79></a>  imagePullSecrets:
<a id=__codelineno-187-80 name=__codelineno-187-80 href=#__codelineno-187-80></a>  - name: &quot;regcred&quot;
<a id=__codelineno-187-81 name=__codelineno-187-81 href=#__codelineno-187-81></a>  nodeSelector:
<a id=__codelineno-187-82 name=__codelineno-187-82 href=#__codelineno-187-82></a>    build: &quot;true&quot;
<a id=__codelineno-187-83 name=__codelineno-187-83 href=#__codelineno-187-83></a>            &#39;&#39;&#39;
<a id=__codelineno-187-84 name=__codelineno-187-84 href=#__codelineno-187-84></a>        }
<a id=__codelineno-187-85 name=__codelineno-187-85 href=#__codelineno-187-85></a>    }
<a id=__codelineno-187-86 name=__codelineno-187-86 href=#__codelineno-187-86></a>
<a id=__codelineno-187-87 name=__codelineno-187-87 href=#__codelineno-187-87></a>    stages {
<a id=__codelineno-187-88 name=__codelineno-187-88 href=#__codelineno-187-88></a>        stage(&#39;Deploying to K8s&#39;) {
<a id=__codelineno-187-89 name=__codelineno-187-89 href=#__codelineno-187-89></a>          steps {
<a id=__codelineno-187-90 name=__codelineno-187-90 href=#__codelineno-187-90></a>            container(name: &#39;jnlp&#39;) {
<a id=__codelineno-187-91 name=__codelineno-187-91 href=#__codelineno-187-91></a>               sh &quot;&quot;&quot;#!/bin/bash
<a id=__codelineno-187-92 name=__codelineno-187-92 href=#__codelineno-187-92></a>                   set -ux
<a id=__codelineno-187-93 name=__codelineno-187-93 href=#__codelineno-187-93></a>                   # 该变量即为前台选择的镜像
<a id=__codelineno-187-94 name=__codelineno-187-94 href=#__codelineno-187-94></a>                   echo ${IMAGE_TAG}
<a id=__codelineno-187-95 name=__codelineno-187-95 href=#__codelineno-187-95></a>                   kubectl set image deployment -l app=${IMAGE_NAME} ${IMAGE_NAME}=${HARBOR_ADDRESS}/${IMAGE_TAG} -n ${NAMESPACE}
<a id=__codelineno-187-96 name=__codelineno-187-96 href=#__codelineno-187-96></a>                   kubectl get pod  -l app=${IMAGE_NAME} -n ${NAMESPACE}
<a id=__codelineno-187-97 name=__codelineno-187-97 href=#__codelineno-187-97></a>                   kubectl get deploy/${IMAGE_NAME} -o yaml  -n ${NAMESPACE}|grep &quot;image: &quot;
<a id=__codelineno-187-98 name=__codelineno-187-98 href=#__codelineno-187-98></a>               &quot;&quot;&quot;
<a id=__codelineno-187-99 name=__codelineno-187-99 href=#__codelineno-187-99></a>          }
<a id=__codelineno-187-100 name=__codelineno-187-100 href=#__codelineno-187-100></a>        }
<a id=__codelineno-187-101 name=__codelineno-187-101 href=#__codelineno-187-101></a>     }
<a id=__codelineno-187-102 name=__codelineno-187-102 href=#__codelineno-187-102></a>  }
<a id=__codelineno-187-103 name=__codelineno-187-103 href=#__codelineno-187-103></a>}
</code></pre></div> <p>保存后，选择一个镜像，单击Build，结果如下图所示。</p> <p>可以看到是直接将镜像版本更新至Kubernetes，并无构建过程，可以省下很多时间。该流水线也可以选择之前的版本进行回滚操作。</p> <p>查看部署过程</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/6/6-71.png></p> <div class="admonition info"> <p class=admonition-title>参考文献</p> <p><a href=https://zhangzhuo.ltd/articles/2022/06/04/1654333328076.html>基于k8s的DevOps环境构建</a></p> <p><a href=https://zhangzhuo.ltd/articles/2022/06/04/1654333399919.html>Jenkins的流水线详解</a></p> <p><a href=https://zhangzhuo.ltd/articles/2022/06/05/1654424805227.html>DevOps自动化构建应用</a></p> </div> <h2 id=10-vscode-jenkins插件分享>10. vscode Jenkins插件分享<a class=headerlink href=#10-vscode-jenkins插件分享 title="Permanent link">&para;</a></h2> <p>Jenkins Pipeline Linter Connector</p> <p>安装方式：在Vscode扩展商店当中直接搜索即可安装。</p> <p>功能说明：Jenkinsfile 语法检测，非常方便。</p> <h3 id=101-在vscode中校验您的jenkinsfile>10.1 在VSCode中校验您的Jenkinsfile<a class=headerlink href=#101-在vscode中校验您的jenkinsfile title="Permanent link">&para;</a></h3> <p>您可以在 VS Code 插件浏览器中或听过下面的地址 url: <a href="https://marketplace.visualstudio.com/items?itemName=janjoerke.jenkins-pipeline-linter-connector">https://marketplace.visualstudio.com/items?itemName=janjoerke.jenkins-pipeline-linter-connector</a> 找到插件。</p> <p>该插件会在 VS Code 中添加四项配置，您需要配置用来执行检验的 Jenkins 。 - jenkins.pipeline.linter.connector.url 是您的 Jenkins 期待的 POST 请求地址，包含您要校验的 Jenkinsfile 文件。通常为<code>http://&lt;your_jenkins_server:port&gt;/pipeline-model-converter/validate</code>。</p> <ul> <li> <p>jenkins.pipeline.linter.connector.user 允许您指定您的 Jenkins 用户名。</p> </li> <li> <p>jenkins.pipeline.linter.connector.pass 允许您指定您的 Jenkins 密码。</p> </li> <li> <p>jenkins.pipeline.linter.connector.crumbUrl 当您的 Jenkins 启用了 CRSF 时必须指定。通常为<code>http://&lt;your_jenkins_server:port&gt;/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,%22:%22,//crumb)</code>。</p> </li> </ul> <div class="admonition 参考文献"> <p class=admonition-title>在 VS Code 中校验您的 Jenkinsfile </p> <p><a href=https://mp.weixin.qq.com/s/DTssLecwkNwaNoXUxGSLYg>VScode本地进行Jenkinsfile语法验证</a></p> <p><a href=https://www.jenkins.io/zh/blog/2018/11/07/Validate-Jenkinsfile>在 VS Code 中校验您的 Jenkinsfile </a></p> </div> <h2 id=11-小结>11. 小结<a class=headerlink href=#11-小结 title="Permanent link">&para;</a></h2> <p>本章主要演示了Java、Vue前端、Golang的自动化构建配置，演示了容器化业务部署的不同方式，均使用Jenkins新特性声明式流水线进行持续集成和 持续部署，在实际使用时不一定非要使用流水线进行构建，也可以根据自己的业务场景选择其他风格的构建方式。</p> <p>通过多个例子可以看出，使用流水线进行构建时，大致流程是类似的，主要是编译方式、基础镜像和编译命令不一样，可以按照自己的业务场景和 需求进行修改。</p> <p>为了使Jenkinsfile更加灵活和统一，可以对Jenkinsfile完全参数化，将Jenkinsfile所有可变的赋值都改为变量，然后在Jenkins上配 置对应的变量即可，这样可以使Jenkins的构建变得更加灵活，也使得同一个Jenkinsfile适用于所有的项目。</p> <h2 id=参考文献>参考文献<a class=headerlink href=#参考文献 title="Permanent link">&para;</a></h2> <p><a href=https://www.putianhui.cn/posts/f5b12f59c480/ >Jenkins常用的优化功能 | Mr.Pu 个站博客 (putianhui.cn)</a></p> <p><a href=https://www.putianhui.cn/posts/7041616304b2/ >Jenkins自动化部署dev-uat-preprd-prd环境服务，并实现发布失败回滚。 | Mr.Pu 个站博客 (putianhui.cn)</a></p> <p><a href=https://www.putianhui.cn/posts/fa563716f116/ >Jenkinsfile解读详解 | Mr.Pu 个站博客 (putianhui.cn)</a></p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最后更新> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">January 1, 2024 21:46:13</span> </span> <span class=md-source-file__fact> <span class=md-icon title=创建日期> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">March 23, 2023 18:59:28</span> </span> </aside> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> Was this page helpful? </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title="This page was helpful" data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title="This page could be improved" data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> Thanks for your feedback! </div> <div data-md-value=0 hidden> Thanks for your feedback! Help us improve this page by using our <a href="https://github.com/hujianli94/hujianli94.github.io/issues/new/?title=[Feedback]+DevOps%E5%AE%9E%E8%B7%B5+-+/Kubernetes/6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/" target=_blank>feedback form</a>. </div> </div> </div> </fieldset> </form> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=页脚> <a href=../../5.%E8%BF%90%E7%BB%B4%E7%AF%87/16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/ class="md-footer__link md-footer__link--prev" aria-label="上一页: 服务发布Ingress进阶"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> 上一页 </span> <div class=md-ellipsis> 服务发布Ingress进阶 </div> </div> </a> <a href=../../../Docker/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Docker/ class="md-footer__link md-footer__link--next" aria-label="下一页: Docker"> <div class=md-footer__title> <span class=md-footer__direction> 下一页 </span> <div class=md-ellipsis> Docker </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2023 - 2024 hujainli94 </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/hujianli94 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://kaliarch-bucket-1251990360.cos.ap-beijing.myqcloud.com/blog_img/20220125122524.png target=_blank rel=noopener title=kaliarch-bucket-1251990360.cos.ap-beijing.myqcloud.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M385.2 167.6c6.4 0 12.6.3 18.8 1.1C387.4 90.3 303.3 32 207.7 32 100.5 32 13 104.8 13 197.4c0 53.4 29.3 97.5 77.9 131.6l-19.3 58.6 68-34.1c24.4 4.8 43.8 9.7 68.2 9.7 6.2 0 12.1-.3 18.3-.8-4-12.9-6.2-26.6-6.2-40.8-.1-84.9 72.9-154 165.3-154zm-104.5-52.9c14.5 0 24.2 9.7 24.2 24.4 0 14.5-9.7 24.2-24.2 24.2-14.8 0-29.3-9.7-29.3-24.2.1-14.7 14.6-24.4 29.3-24.4zm-136.4 48.6c-14.5 0-29.3-9.7-29.3-24.2 0-14.8 14.8-24.4 29.3-24.4 14.8 0 24.4 9.7 24.4 24.4 0 14.6-9.6 24.2-24.4 24.2zM563 319.4c0-77.9-77.9-141.3-165.4-141.3-92.7 0-165.4 63.4-165.4 141.3S305 460.7 397.6 460.7c19.3 0 38.9-5.1 58.6-9.9l53.4 29.3-14.8-48.6C534 402.1 563 363.2 563 319.4zm-219.1-24.5c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.8 0 24.4 9.7 24.4 19.3 0 10-9.7 19.6-24.4 19.6zm107.1 0c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.5 0 24.4 9.7 24.4 19.3.1 10-9.9 19.6-24.4 19.6z"/></svg> </a> <a href="mailto:<1879324764@qq.com>" target=_blank rel=noopener title=发送邮件 class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.7l167.6-182.9c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">同意</button> <label class=md-button for=__settings>管理设定</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script> <script id=__config type=application/json>{"base": "../../..", "features": ["content.action.edit", "content.action.view", "content.code.copy", "content.code.annotate", "navigation.indexes", "navigation.footer", "navigation.indexes", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../../assets/javascripts/bundle.5cfa9459.min.js></script> <script src=../../../javascripts/extra.js></script> <script src=https://file.cdn.shafish.cn/blog/js/video.min.js></script> </body> </html>