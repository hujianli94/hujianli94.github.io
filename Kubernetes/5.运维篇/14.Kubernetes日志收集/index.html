<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="stay hungry,stay foolish"><meta name=author content=hujainli94><link href=https://hujianli94.github.io/Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/14.Kubernetes%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/ rel=canonical><link href=../../4.%E9%AB%98%E7%BA%A7%E7%AF%87/13.%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%B9%E5%99%A8%E5%8C%96/ rel=prev><link href=../15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/ rel=next><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.2, mkdocs-material-9.1.21"><title>Kubernetes日志收集 - DevOps运维开发</title><link rel=stylesheet href=../../../assets/stylesheets/main.eebd395e.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.ecc896b0.min.css><style>:root{--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.752 1.752 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25ZM6 5a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"/></svg>');--md-admonition-icon--abstract:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.5 1.75v11.5c0 .138.112.25.25.25h3.17a.75.75 0 0 1 0 1.5H2.75A1.75 1.75 0 0 1 1 13.25V1.75C1 .784 1.784 0 2.75 0h8.5C12.216 0 13 .784 13 1.75v7.736a.75.75 0 0 1-1.5 0V1.75a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25Zm13.274 9.537v-.001l-4.557 4.45a.75.75 0 0 1-1.055-.008l-1.943-1.95a.75.75 0 0 1 1.062-1.058l1.419 1.425 4.026-3.932a.75.75 0 1 1 1.048 1.074ZM4.75 4h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM4 7.75A.75.75 0 0 1 4.75 7h2a.75.75 0 0 1 0 1.5h-2A.75.75 0 0 1 4 7.75Z"/></svg>');--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>');--md-admonition-icon--tip:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M3.499.75a.75.75 0 0 1 1.5 0v.996C5.9 2.903 6.793 3.65 7.662 4.376l.24.202c-.036-.694.055-1.422.426-2.163C9.1.873 10.794-.045 12.622.26 14.408.558 16 1.94 16 4.25c0 1.278-.954 2.575-2.44 2.734l.146.508.065.22c.203.701.412 1.455.476 2.226.142 1.707-.4 3.03-1.487 3.898C11.714 14.671 10.27 15 8.75 15h-6a.75.75 0 0 1 0-1.5h1.376a4.484 4.484 0 0 1-.563-1.191 3.835 3.835 0 0 1-.05-2.063 4.647 4.647 0 0 1-2.025-.293.75.75 0 0 1 .525-1.406c1.357.507 2.376-.006 2.698-.318l.009-.01a.747.747 0 0 1 1.06 0 .748.748 0 0 1-.012 1.074c-.912.92-.992 1.835-.768 2.586.221.74.745 1.337 1.196 1.621H8.75c1.343 0 2.398-.296 3.074-.836.635-.507 1.036-1.31.928-2.602-.05-.603-.216-1.224-.422-1.93l-.064-.221c-.12-.407-.246-.84-.353-1.29a2.425 2.425 0 0 1-.507-.441 3.075 3.075 0 0 1-.633-1.248.75.75 0 0 1 1.455-.364c.046.185.144.436.31.627.146.168.353.305.712.305.738 0 1.25-.615 1.25-1.25 0-1.47-.95-2.315-2.123-2.51-1.172-.196-2.227.387-2.706 1.345-.46.92-.27 1.774.019 3.062l.042.19a.884.884 0 0 1 .01.05c.348.443.666.949.94 1.553a.75.75 0 1 1-1.365.62c-.553-1.217-1.32-1.94-2.3-2.768L6.7 5.527c-.814-.68-1.75-1.462-2.692-2.619a3.737 3.737 0 0 0-1.023.88c-.406.495-.663 1.036-.722 1.508.116.122.306.21.591.239.388.038.797-.06 1.032-.19a.75.75 0 0 1 .728 1.31c-.515.287-1.23.439-1.906.373-.682-.067-1.473-.38-1.879-1.193L.75 5.677V5.5c0-.984.48-1.94 1.077-2.664.46-.559 1.05-1.055 1.673-1.353V.75Z"/></svg>');--md-admonition-icon--success:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg>');--md-admonition-icon--question:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.92 6.085h.001a.749.749 0 1 1-1.342-.67c.169-.339.436-.701.849-.977C6.845 4.16 7.369 4 8 4a2.756 2.756 0 0 1 1.637.525c.503.377.863.965.863 1.725 0 .448-.115.83-.329 1.15-.205.307-.47.513-.692.662-.109.072-.22.138-.313.195l-.006.004a6.24 6.24 0 0 0-.26.16.952.952 0 0 0-.276.245.75.75 0 0 1-1.248-.832c.184-.264.42-.489.692-.661.103-.067.207-.132.313-.195l.007-.004c.1-.061.182-.11.258-.161a.969.969 0 0 0 .277-.245C8.96 6.514 9 6.427 9 6.25a.612.612 0 0 0-.262-.525A1.27 1.27 0 0 0 8 5.5c-.369 0-.595.09-.74.187a1.01 1.01 0 0 0-.34.398ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>');--md-admonition-icon--warning:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>');--md-admonition-icon--failure:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.344 2.343h-.001a8 8 0 0 1 11.314 11.314A8.002 8.002 0 0 1 .234 10.089a8 8 0 0 1 2.11-7.746Zm1.06 10.253a6.5 6.5 0 1 0 9.108-9.275 6.5 6.5 0 0 0-9.108 9.275ZM6.03 4.97 8 6.94l1.97-1.97a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l1.97 1.97a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-1.97 1.97a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L6.94 8 4.97 6.03a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018Z"/></svg>');--md-admonition-icon--danger:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M9.504.43a1.516 1.516 0 0 1 2.437 1.713L10.415 5.5h2.123c1.57 0 2.346 1.909 1.22 3.004l-7.34 7.142a1.249 1.249 0 0 1-.871.354h-.302a1.25 1.25 0 0 1-1.157-1.723L5.633 10.5H3.462c-1.57 0-2.346-1.909-1.22-3.004L9.503.429Zm1.047 1.074L3.286 8.571A.25.25 0 0 0 3.462 9H6.75a.75.75 0 0 1 .694 1.034l-1.713 4.188 6.982-6.793A.25.25 0 0 0 12.538 7H9.25a.75.75 0 0 1-.683-1.06l2.008-4.418.003-.006a.036.036 0 0 0-.004-.009l-.006-.006-.008-.001c-.003 0-.006.002-.009.004Z"/></svg>');--md-admonition-icon--bug:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M4.72.22a.75.75 0 0 1 1.06 0l1 .999a3.488 3.488 0 0 1 2.441 0l.999-1a.748.748 0 0 1 1.265.332.75.75 0 0 1-.205.729l-.775.776c.616.63.995 1.493.995 2.444v.327c0 .1-.009.197-.025.292.408.14.764.392 1.029.722l1.968-.787a.75.75 0 0 1 .556 1.392L13 7.258V9h2.25a.75.75 0 0 1 0 1.5H13v.5c0 .409-.049.806-.141 1.186l2.17.868a.75.75 0 0 1-.557 1.392l-2.184-.873A4.997 4.997 0 0 1 8 16a4.997 4.997 0 0 1-4.288-2.427l-2.183.873a.75.75 0 0 1-.558-1.392l2.17-.868A5.036 5.036 0 0 1 3 11v-.5H.75a.75.75 0 0 1 0-1.5H3V7.258L.971 6.446a.75.75 0 0 1 .558-1.392l1.967.787c.265-.33.62-.583 1.03-.722a1.677 1.677 0 0 1-.026-.292V4.5c0-.951.38-1.814.995-2.444L4.72 1.28a.75.75 0 0 1 0-1.06Zm.53 6.28a.75.75 0 0 0-.75.75V11a3.5 3.5 0 1 0 7 0V7.25a.75.75 0 0 0-.75-.75ZM6.173 5h3.654A.172.172 0 0 0 10 4.827V4.5a2 2 0 1 0-4 0v.327c0 .096.077.173.173.173Z"/></svg>');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M5 5.782V2.5h-.25a.75.75 0 0 1 0-1.5h6.5a.75.75 0 0 1 0 1.5H11v3.282l3.666 5.76C15.619 13.04 14.543 15 12.767 15H3.233c-1.776 0-2.852-1.96-1.899-3.458Zm-2.4 6.565a.75.75 0 0 0 .633 1.153h9.534a.75.75 0 0 0 .633-1.153L12.225 10.5h-8.45ZM9.5 2.5h-3V6c0 .143-.04.283-.117.403L4.73 9h6.54L9.617 6.403A.746.746 0 0 1 9.5 6Z"/></svg>');--md-admonition-icon--quote:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1.75 2.5h10.5a.75.75 0 0 1 0 1.5H1.75a.75.75 0 0 1 0-1.5Zm4 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5Zm0 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5ZM2.5 7.75v6a.75.75 0 0 1-1.5 0v-6a.75.75 0 0 1 1.5 0Z"/></svg>');}</style><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../stylesheets/extra.css><link rel=stylesheet href=https://file.cdn.shafish.cn/blog/css/vssue.css><link rel=stylesheet href=https://file.cdn.shafish.cn/blog/css/video-js.min.css><link rel=stylesheet href=https://file.cdn.shafish.cn/blog/css/video.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#kubernetes日志收集 class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../.. title=DevOps运维开发 class="md-header__button md-logo" aria-label=DevOps运维开发 data-md-component=logo> <img src=../../../assets/images/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> DevOps运维开发 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Kubernetes日志收集 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label=切换至深色模式 type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title=切换至深色模式 for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=blue aria-label=切换至浅色模式 type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title=切换至浅色模式 for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=查找> <a href=javascript:void(0) class="md-search__icon md-icon" title=分享 aria-label=分享 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/hujianli94/hujianli94.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> hujianli94.github.io </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> 首页 </a> </li> <li class=md-tabs__item> <a href=../../0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Kubernetes/ class="md-tabs__link md-tabs__link--active"> Kubernetes </a> </li> <li class=md-tabs__item> <a href=../../../Docker/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Docker/ class=md-tabs__link> Docker </a> </li> <li class=md-tabs__item> <a href=../../../Golang/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Go-Web%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/ class=md-tabs__link> Golang </a> </li> <li class=md-tabs__item> <a href=../../../Python/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Pythjon-auto-ops/ class=md-tabs__link> Python </a> </li> <li class=md-tabs__item> <a href=../../../Python-vs-Go/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Python-vs-Go/ class=md-tabs__link> Python-vs-Go </a> </li> <li class=md-tabs__item> <a href=../../../Linux/shell/Shell%E7%AE%80%E4%BB%8B/ class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../../Other/tools/1.PicGo%E5%9B%BE%E5%BA%8A/ class=md-tabs__link> Other </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=DevOps运维开发 class="md-nav__button md-logo" aria-label=DevOps运维开发 data-md-component=logo> <img src=../../../assets/images/logo.png alt=logo> </a> DevOps运维开发 </label> <div class=md-nav__source> <a href=https://github.com/hujianli94/hujianli94.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> hujianli94.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> 首页 </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1> <label class=md-nav__link for=__nav_2_1 id=__nav_2_1_label tabindex=0> 0.学习线路 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> 0.学习线路 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Kubernetes/ class=md-nav__link> Kubernetes </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex=0> 1.安装篇 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> 1.安装篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../1.%E5%AE%89%E8%A3%85%E7%AF%87/1.Kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/ class=md-nav__link> Kubeadm安装高可用集群 </a> </li> <li class=md-nav__item> <a href=../../1.%E5%AE%89%E8%A3%85%E7%AF%87/2.%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8K8s%E9%9B%86%E7%BE%A4/ class=md-nav__link> 二进制安装高可用K8s集群 </a> </li> <li class=md-nav__item> <a href=../../1.%E5%AE%89%E8%A3%85%E7%AF%87/3.%E5%AE%89%E8%A3%85%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/ class=md-nav__link> 安装常用工具 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> 2.基础篇 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> 2.基础篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Docker%E5%9F%BA%E7%A1%80/ class=md-nav__link> Docker基础 </a> </li> <li class=md-nav__item> <a href=../../2.%E5%9F%BA%E7%A1%80%E7%AF%87/4.Kubernetes%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/ class=md-nav__link> Kubernetes的基础概念 </a> </li> <li class=md-nav__item> <a href=../../2.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Kubernetes%E8%B0%83%E5%BA%A6%E5%9F%BA%E7%A1%80/ class=md-nav__link> Kubernetes调度基础 </a> </li> <li class=md-nav__item> <a href=../../2.%E5%9F%BA%E7%A1%80%E7%AF%87/6.Kubernetes%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E5%9F%BA%E7%A1%80/ class=md-nav__link> Kubernetes服务发布基础 </a> </li> <li class=md-nav__item> <a href=../../2.%E5%9F%BA%E7%A1%80%E7%AF%87/7.Kubernetes%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/ class=md-nav__link> Kubernetes配置管理 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4 id=__nav_2_4_label tabindex=0> 3.进阶篇 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> 3.进阶篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../3.%E8%BF%9B%E9%98%B6%E7%AF%87/8.Kubernetes%E5%AD%98%E5%82%A8%E5%85%A5%E9%97%A8/ class=md-nav__link> Kubernetes存储入门 </a> </li> <li class=md-nav__item> <a href=../../3.%E8%BF%9B%E9%98%B6%E7%AF%87/9.Kubernetes%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6/ class=md-nav__link> Kubernetes高级调度 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_5> <label class=md-nav__link for=__nav_2_5 id=__nav_2_5_label tabindex=0> 4.高级篇 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_5_label aria-expanded=false> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> 4.高级篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../4.%E9%AB%98%E7%BA%A7%E7%AF%87/12.%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AD%98%E5%82%A8Rook/ class=md-nav__link> 云原生存储Rook </a> </li> <li class=md-nav__item> <a href=../../4.%E9%AB%98%E7%BA%A7%E7%AF%87/13.%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%B9%E5%99%A8%E5%8C%96/ class=md-nav__link> 中间件容器化 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_6 checked> <label class=md-nav__link for=__nav_2_6 id=__nav_2_6_label tabindex=0> 5.运维篇 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_6_label aria-expanded=true> <label class=md-nav__title for=__nav_2_6> <span class="md-nav__icon md-icon"></span> 5.运维篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Kubernetes日志收集 <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Kubernetes日志收集 </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1-日志收集架构 class=md-nav__link> 1. 日志收集架构 </a> <nav class=md-nav aria-label="1. 日志收集架构"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#11-kubernetes-中的基本日志 class=md-nav__link> 1.1 Kubernetes 中的基本日志 </a> </li> <li class=md-nav__item> <a href=#12-kubernetes-日志收集 class=md-nav__link> 1.2 Kubernetes 日志收集 </a> <nav class=md-nav aria-label="1.2 Kubernetes 日志收集"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#121-节点日志采集代理 class=md-nav__link> 1.2.1 节点日志采集代理 </a> </li> <li class=md-nav__item> <a href=#122-以-sidecar-容器收集日志 class=md-nav__link> 1.2.2 以 sidecar 容器收集日志 </a> </li> <li class=md-nav__item> <a href=#123-直接从应用程序收集日志 class=md-nav__link> 1.2.3 直接从应用程序收集日志 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-搭建-efk-日志系统 class=md-nav__link> 2. 搭建 EFK 日志系统 </a> <nav class=md-nav aria-label="2. 搭建 EFK 日志系统"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-安装-elasticsearch-集群 class=md-nav__link> 2.1 安装 Elasticsearch 集群 </a> <nav class=md-nav aria-label="2.1 安装 Elasticsearch 集群"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#211-环境准备 class=md-nav__link> 2.1.1 环境准备 </a> </li> <li class=md-nav__item> <a href=#212-安装-es-集群 class=md-nav__link> 2.1.2 安装 ES 集群 </a> </li> <li class=md-nav__item> <a href=#213-安装-kibana class=md-nav__link> 2.1.3 安装 Kibana </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#22-部署-fluentd class=md-nav__link> 2.2 部署 Fluentd </a> <nav class=md-nav aria-label="2.2 部署 Fluentd"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#221-工作原理 class=md-nav__link> 2.2.1 工作原理 </a> </li> <li class=md-nav__item> <a href=#222-配置 class=md-nav__link> 2.2.2 配置 </a> </li> <li class=md-nav__item> <a href=#223-安装 class=md-nav__link> 2.2.3 安装 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#23-安装-kafka class=md-nav__link> 2.3 安装 Kafka </a> </li> <li class=md-nav__item> <a href=#24-fluentd-配置-kafka class=md-nav__link> 2.4 Fluentd 配置 Kafka </a> </li> <li class=md-nav__item> <a href=#25-安装-logstash class=md-nav__link> 2.5 安装 Logstash </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-参考文献 class=md-nav__link> 3. 参考文献 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/ class=md-nav__link> Kubernetes监控告警 </a> </li> <li class=md-nav__item> <a href=../16.%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83Ingress%E8%BF%9B%E9%98%B6/ class=md-nav__link> 服务发布Ingress进阶 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_7> <label class=md-nav__link for=__nav_2_7 id=__nav_2_7_label tabindex=0> 6.DevOps篇 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_7_label aria-expanded=false> <label class=md-nav__title for=__nav_2_7> <span class="md-nav__icon md-icon"></span> 6.DevOps篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../6.DevOps%E7%AF%87/17.DevOps%E5%AE%9E%E8%B7%B5/ class=md-nav__link> DevOps实践 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> Docker <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1> <label class=md-nav__link for=__nav_3_1 id=__nav_3_1_label tabindex=0> 0.学习线路 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> 0.学习线路 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Docker/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Docker/ class=md-nav__link> Docker </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex=0> 1.基础 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> 1.基础 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/1.%E5%AE%89%E8%A3%85Docker/ class=md-nav__link> 1.安装Docker </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/2.Docker%E9%95%9C%E5%83%8F/ class=md-nav__link> 2.Docker镜像 </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/3.Docker%E5%AE%B9%E5%99%A8/ class=md-nav__link> 3.Docker容器 </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/4.%E4%BC%81%E4%B8%9A%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93harbor/ class=md-nav__link> 4.企业私有仓库harbor </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/5.Docker%E6%95%B0%E6%8D%AE/ class=md-nav__link> 5.Docker数据 </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/6.Docker%E7%BD%91%E7%BB%9C/ class=md-nav__link> 6.Docker网络 </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/7.Dockerfile/ class=md-nav__link> 7.Dockerfile </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/8.docker-compose/ class=md-nav__link> 8.docker-compose </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/9.Docker%E7%9B%B8%E5%85%B3%E8%84%9A%E6%9C%AC/ class=md-nav__link> 9.Docker相关脚本 </a> </li> <li class=md-nav__item> <a href=../../../Docker/1.%E5%9F%BA%E7%A1%80/10.Docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/ class=md-nav__link> 10.Docker常用命令 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex=0> 2.实战案例 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> 2.实战案例 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Docker/2.%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/1.%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/ class=md-nav__link> 1.操作系统 </a> </li> <li class=md-nav__item> <a href=../../../Docker/2.%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/2.Web%E6%9C%8D%E5%8A%A1%E4%B8%8E%E5%BA%94%E7%94%A8/ class=md-nav__link> 2.Web服务与应用 </a> </li> <li class=md-nav__item> <a href=../../../Docker/2.%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/3.%E6%8C%81%E7%BB%AD%E5%BC%80%E5%8F%91%E4%B8%8E%E7%AE%A1%E7%90%86/ class=md-nav__link> 3.持续开发与管理 </a> </li> <li class=md-nav__item> <a href=../../../Docker/2.%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/4.%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BA%94%E7%94%A8/ class=md-nav__link> 4.数据库应用 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex=0> 3.Devops <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> 3.Devops </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Docker/3.Devops/1.ConfCenter/ class=md-nav__link> ConfCenter </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/2.CoreDNS/ class=md-nav__link> Coredns </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/3.Harbor/ class=md-nav__link> Harbor </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/4.Python%E6%93%8D%E4%BD%9CDocker/ class=md-nav__link> Python操作Docker </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/5.Haproxy/ class=md-nav__link> Haproxy </a> </li> <li class=md-nav__item> <a href=../../../Docker/3.Devops/6.Nexus/ class=md-nav__link> Nexus </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> Golang <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Golang </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1 id=__nav_4_1_label tabindex=0> 0.学习线路 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> 0.学习线路 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Go-Web%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/ class=md-nav__link> Go Web开发实战 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex=0> 1.Go基础 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> 1.Go基础 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/1.Go%E5%9F%BA%E7%A1%80/1.%E5%AE%89%E8%A3%85Go/ class=md-nav__link> 安装Go </a> </li> <li class=md-nav__item> <a href=../../../Golang/1.Go%E5%9F%BA%E7%A1%80/2.%E7%AC%AC%E4%B8%80%E4%B8%AAGo%E7%A8%8B%E5%BA%8F/ class=md-nav__link> 第一个Go程序 </a> </li> <li class=md-nav__item> <a href=../../../Golang/1.Go%E5%9F%BA%E7%A1%80/3.Go%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/ class=md-nav__link> Go基础语法 </a> </li> <li class=md-nav__item> <a href=../../../Golang/1.Go%E5%9F%BA%E7%A1%80/4.Go-Module%E6%95%99%E7%A8%8B/ class=md-nav__link> Go Module教程 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3 id=__nav_4_3_label tabindex=0> 2.Go-Web基础 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> 2.Go-Web基础 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/2.Go-Web%E5%9F%BA%E7%A1%80/5.%E7%AC%AC%E4%B8%80%E4%B8%AAGo-Web%E7%A8%8B%E5%BA%8F/ class=md-nav__link> 第一个Go Web程序 </a> </li> <li class=md-nav__item> <a href=../../../Golang/2.Go-Web%E5%9F%BA%E7%A1%80/6.Web%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86%E7%AE%80%E4%BB%8B/ class=md-nav__link> Web程序运行原理简介 </a> </li> <li class=md-nav__item> <a href=../../../Golang/2.Go-Web%E5%9F%BA%E7%A1%80/7.net-http%E5%8C%85/ class=md-nav__link> net/http包 </a> </li> <li class=md-nav__item> <a href=../../../Golang/2.Go-Web%E5%9F%BA%E7%A1%80/8.html-template%E5%8C%85/ class=md-nav__link> html/template包 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4 id=__nav_4_4_label tabindex=0> 3.Go-Web请求处理 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> 3.Go-Web请求处理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/3.Go-Web%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86/9.%E7%AE%80%E5%8D%95Web%E6%9C%8D%E5%8A%A1%E5%99%A8/ class=md-nav__link> 简单Web服务器 </a> </li> <li class=md-nav__item> <a href=../../../Golang/3.Go-Web%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86/10.%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82/ class=md-nav__link> 处理请求 </a> </li> <li class=md-nav__item> <a href=../../../Golang/3.Go-Web%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86/11.session%E5%92%8Ccookie/ class=md-nav__link> session和cookie </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_5> <label class=md-nav__link for=__nav_4_5 id=__nav_4_5_label tabindex=0> 4.Go访问数据库 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_5_label aria-expanded=false> <label class=md-nav__title for=__nav_4_5> <span class="md-nav__icon md-icon"></span> 4.Go访问数据库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/4.Go%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93/12.Go%E6%93%8D%E4%BD%9CMySQL/ class=md-nav__link> Go操作MySQL </a> </li> <li class=md-nav__item> <a href=../../../Golang/4.Go%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93/13.Go%E6%93%8D%E4%BD%9CRedis/ class=md-nav__link> Go操作Redis </a> </li> <li class=md-nav__item> <a href=../../../Golang/4.Go%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93/14.Go%E6%93%8D%E4%BD%9CMongoDB/ class=md-nav__link> Go操作MongoDB </a> </li> <li class=md-nav__item> <a href=../../../Golang/4.Go%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93/15.Go%E7%9A%84%E5%B8%B8%E8%A7%81ORM%E5%BA%93/ class=md-nav__link> Go的常见ORM库 </a> </li> <li class=md-nav__item> <a href=../../../Golang/4.Go%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93/16.Go%E6%93%8D%E4%BD%9CSQLite/ class=md-nav__link> Go操作SQLite </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_6> <label class=md-nav__link for=__nav_4_6 id=__nav_4_6_label tabindex=0> 5.Go高级网络编程 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_6_label aria-expanded=false> <label class=md-nav__title for=__nav_4_6> <span class="md-nav__icon md-icon"></span> 5.Go高级网络编程 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/5.Go%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/17.Go-Socket%E7%BC%96%E7%A8%8B/ class=md-nav__link> Go Socket编程 </a> </li> <li class=md-nav__item> <a href=../../../Golang/5.Go%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/18.Go-RPC%E7%BC%96%E7%A8%8B/ class=md-nav__link> Go RPC编程 </a> </li> <li class=md-nav__item> <a href=../../../Golang/5.Go%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/19.Go-%E5%BE%AE%E6%9C%8D%E5%8A%A1/ class=md-nav__link> Go 微服务 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_7> <label class=md-nav__link for=__nav_4_7 id=__nav_4_7_label tabindex=0> 6.Go文件处理 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_7_label aria-expanded=false> <label class=md-nav__title for=__nav_4_7> <span class="md-nav__icon md-icon"></span> 6.Go文件处理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/20.%E5%A4%84%E7%90%86%E7%9B%AE%E5%BD%95%E4%B8%8E%E6%96%87%E4%BB%B6/ class=md-nav__link> 处理目录与文件 </a> </li> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/21.%E5%A4%84%E7%90%86XML%E6%96%87%E4%BB%B6/ class=md-nav__link> 处理XML文件 </a> </li> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/22.%E5%A4%84%E7%90%86JSON%E6%96%87%E4%BB%B6/ class=md-nav__link> 处理JSON文件 </a> </li> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/23.%E5%A4%84%E7%90%86CSV%E6%96%87%E4%BB%B6/ class=md-nav__link> 处理CSV文件 </a> </li> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/24.%E5%A4%84%E7%90%86Go%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95/ class=md-nav__link> 处理Go日志记录 </a> </li> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/25.%E5%A4%84%E7%90%86%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/ class=md-nav__link> 处理正则表达式 </a> </li> <li class=md-nav__item> <a href=../../../Golang/6.Go%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/26.%E5%A4%84%E7%90%86Excel%E6%96%87%E4%BB%B6/ class=md-nav__link> 处理Excel文件 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_8> <label class=md-nav__link for=__nav_4_8 id=__nav_4_8_label tabindex=0> 7.Go并发编程 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_8_label aria-expanded=false> <label class=md-nav__title for=__nav_4_8> <span class="md-nav__icon md-icon"></span> 7.Go并发编程 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/26.%E5%B9%B6%E5%8F%91-%E5%B9%B6%E8%A1%8C/ class=md-nav__link> 并发 并行 </a> </li> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/27.%E8%BF%9B%E7%A8%8B-%E7%BA%BF%E7%A8%8B-%E5%8D%8F%E7%A8%8B/ class=md-nav__link> 进程 线程 协程 </a> </li> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/28.Go%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/ class=md-nav__link> Go并发模型 </a> </li> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/29.goroutine%E5%92%8Cchannel/ class=md-nav__link> goroutine和channel </a> </li> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/30.sync%E5%AE%9E%E7%8E%B0%E5%B9%B6%E5%8F%91/ class=md-nav__link> sync实现并发 </a> </li> <li class=md-nav__item> <a href=../../../Golang/7.Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/31.Go%E5%B9%B6%E5%8F%91%E7%9A%84Web%E5%BA%94%E7%94%A8/ class=md-nav__link> Go并发的Web应用 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_9> <label class=md-nav__link for=__nav_4_9 id=__nav_4_9_label tabindex=0> 8.Go标准库 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_9_label aria-expanded=false> <label class=md-nav__title for=__nav_4_9> <span class="md-nav__icon md-icon"></span> 8.Go标准库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/32.time/ class=md-nav__link> time </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/33.strings/ class=md-nav__link> strings </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/34.bytes/ class=md-nav__link> bytes </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/35.json/ class=md-nav__link> json </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/36.io-bufio/ class=md-nav__link> io/bufio </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/37.fmt/ class=md-nav__link> fmt </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/38.strconv/ class=md-nav__link> strconv </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/39.regexp/ class=md-nav__link> regexp </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/40.log/ class=md-nav__link> log </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/41.reflect-unsafe/ class=md-nav__link> reflect/unsafe </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/42.os-path-filepath/ class=md-nav__link> os/path/filepath </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/43.unicode/ class=md-nav__link> unicode </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/44.flag/ class=md-nav__link> flag </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/45.net-url/ class=md-nav__link> net/url </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/46.net-http/ class=md-nav__link> net/http </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/47.sort/ class=md-nav__link> sort </a> </li> <li class=md-nav__item> <a href=../../../Golang/8.Go%E6%A0%87%E5%87%86%E5%BA%93/48.errors/ class=md-nav__link> errors </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_10> <label class=md-nav__link for=__nav_4_10 id=__nav_4_10_label tabindex=0> 9.Go三方库 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_10_label aria-expanded=false> <label class=md-nav__title for=__nav_4_10> <span class="md-nav__icon md-icon"></span> 9.Go三方库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/0.%E5%BC%80%E6%BA%90%E8%87%AA%E5%B7%B1%E7%9A%84Go%E5%BA%93/ class=md-nav__link> 开源自己的Go库 </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/1.cobra/ class=md-nav__link> Cobra </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/2.viper/ class=md-nav__link> Viper </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/3.mahonia/ class=md-nav__link> mahonia </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/4.ssh/ class=md-nav__link> ssh </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/5.fsnotify/ class=md-nav__link> fsnotify </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/6.yaml/ class=md-nav__link> yaml </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/7.tail/ class=md-nav__link> tail </a> </li> <li class=md-nav__item> <a href=../../../Golang/9.Go%E4%B8%89%E6%96%B9%E5%BA%93/8.gopsutil/ class=md-nav__link> gopsutil </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> Python <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_1> <label class=md-nav__link for=__nav_5_1 id=__nav_5_1_label tabindex=0> 0.学习线路 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_1_label aria-expanded=false> <label class=md-nav__title for=__nav_5_1> <span class="md-nav__icon md-icon"></span> 0.学习线路 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Pythjon-auto-ops/ class=md-nav__link> Python Linux管理与自动化运维 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_2> <label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex=0> 1.基础篇 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=false> <label class=md-nav__title for=__nav_5_2> <span class="md-nav__icon md-icon"></span> 1.基础篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python/1.%E5%9F%BA%E7%A1%80%E7%AF%87/1.Python%E7%94%9F%E6%80%81%E5%B7%A5%E5%85%B7/ class=md-nav__link> 1.Python生态工具 </a> </li> <li class=md-nav__item> <a href=../../../Python/1.%E5%9F%BA%E7%A1%80%E7%AF%87/2.Python%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E5%AE%89%E8%A3%85/ class=md-nav__link> 2.Python第三方库安装 </a> </li> <li class=md-nav__item> <a href=../../../Python/1.%E5%9F%BA%E7%A1%80%E7%AF%87/3.Python%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83%E7%AE%A1%E7%90%86/ class=md-nav__link> 3.Python工作环境管理 </a> </li> <li class=md-nav__item> <a href=../../../Python/1.%E5%9F%BA%E7%A1%80%E7%AF%87/4.VSCode%E4%B8%ADPython%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/ class=md-nav__link> 4.VSCode中Python环境配置 </a> </li> <li class=md-nav__item> <a href=../../../Python/1.%E5%9F%BA%E7%A1%80%E7%AF%87/5.Python%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/ class=md-nav__link> 5.Python开发环境 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_3> <label class=md-nav__link for=__nav_5_3 id=__nav_5_3_label tabindex=0> 2.高级篇 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_3_label aria-expanded=false> <label class=md-nav__title for=__nav_5_3> <span class="md-nav__icon md-icon"></span> 2.高级篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python/2.%E9%AB%98%E7%BA%A7%E7%AF%87/6.%E6%89%93%E9%80%A0%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7/ class=md-nav__link> 6.打造命令行工具 </a> </li> <li class=md-nav__item> <a href=../../../Python/2.%E9%AB%98%E7%BA%A7%E7%AF%87/7.%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86/ class=md-nav__link> 7.文本处理 </a> </li> <li class=md-nav__item> <a href=../../../Python/2.%E9%AB%98%E7%BA%A7%E7%AF%87/8.Linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86/ class=md-nav__link> 8.Linux系统管理 </a> </li> <li class=md-nav__item> <a href=../../../Python/2.%E9%AB%98%E7%BA%A7%E7%AF%87/9.%E7%9B%91%E6%8E%A7Linux/ class=md-nav__link> 9.监控Linux </a> </li> <li class=md-nav__item> <a href=../../../Python/2.%E9%AB%98%E7%BA%A7%E7%AF%87/10.%E6%96%87%E6%A1%A3%E4%B8%8E%E6%8A%A5%E5%91%8A/ class=md-nav__link> 10.文档与报告 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> Python-vs-Go <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Python-vs-Go </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_1> <label class=md-nav__link for=__nav_6_1 id=__nav_6_1_label tabindex=0> 0.学习线路 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_1_label aria-expanded=false> <label class=md-nav__title for=__nav_6_1> <span class="md-nav__icon md-icon"></span> 0.学习线路 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python-vs-Go/0.%E5%AD%A6%E4%B9%A0%E7%BA%BF%E8%B7%AF/0.Python-vs-Go/ class=md-nav__link> Python-vs-Go </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_2> <label class=md-nav__link for=__nav_6_2 id=__nav_6_2_label tabindex=0> 1.对比学习 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_2_label aria-expanded=false> <label class=md-nav__title for=__nav_6_2> <span class="md-nav__icon md-icon"></span> 1.对比学习 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/1.Hello-World/ class=md-nav__link> Hello-World </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/2.Print/ class=md-nav__link> Print </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/3.%E6%B3%A8%E9%87%8A/ class=md-nav__link> 注释 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/4.%E5%A4%9A%E8%A1%8C%E5%AD%97%E7%AC%A6%E4%B8%B2/ class=md-nav__link> 多行字符串 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/5.Lists/ class=md-nav__link> Lists </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/6.Map/ class=md-nav__link> Map </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/7.Booleans/ class=md-nav__link> Booleans </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/8.Forloop/ class=md-nav__link> Forloop </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/9.Range/ class=md-nav__link> Range </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/10.Switch/ class=md-nav__link> Switch </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/11.%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0%E5%87%BD%E6%95%B0/ class=md-nav__link> 可变参数函数 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/12.%E6%97%B6%E9%97%B4%E8%AE%A1%E7%AE%97/ class=md-nav__link> 时间计算 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/13.%E5%87%BD%E6%95%B0%E7%9A%84%E9%97%AD%E5%8C%85/ class=md-nav__link> 函数的闭包 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/14.%E9%80%80%E5%87%BA%E5%A4%84%E7%90%86/ class=md-nav__link> 退出处理 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/15.%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7/ class=md-nav__link> 异常捕获 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/16.%E5%8F%AF%E5%8F%98%E9%A1%B9/ class=md-nav__link> 可变项 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/17.%E7%B1%BB/ class=md-nav__link> 类 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/18.%E6%96%B9%E6%B3%95/ class=md-nav__link> 方法 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/19.%E5%B9%B6%E5%8F%91/ class=md-nav__link> 并发 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/20.Args/ class=md-nav__link> Args </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/21.%E5%AF%BC%E5%85%A5%E6%A8%A1%E5%9D%97%E5%88%AB%E5%90%8D/ class=md-nav__link> 导入模块别名 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/22.%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%A0%BC%E5%BC%8F%E5%8C%96/ class=md-nav__link> 字符串格式化 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/23.%E5%8E%BB%E9%87%8D/ class=md-nav__link> 去重 </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/1.%E5%AF%B9%E6%AF%94%E5%AD%A6%E4%B9%A0/24.%E5%B8%A6%E9%A2%9C%E8%89%B2%E6%89%93%E5%8D%B0/ class=md-nav__link> 带颜色打印 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_3> <label class=md-nav__link for=__nav_6_3 id=__nav_6_3_label tabindex=0> 2.进阶 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_3_label aria-expanded=false> <label class=md-nav__title for=__nav_6_3> <span class="md-nav__icon md-icon"></span> 2.进阶 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Python-vs-Go/2.%E8%BF%9B%E9%98%B6/1.%E4%BD%BF%E7%94%A8RPC/ class=md-nav__link> 使用RPC </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/2.%E8%BF%9B%E9%98%B6/2.%E4%BD%BF%E7%94%A8MySQL/ class=md-nav__link> 使用MySQL </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/2.%E8%BF%9B%E9%98%B6/3.%E4%BD%BF%E7%94%A8Redis/ class=md-nav__link> 使用Redis </a> </li> <li class=md-nav__item> <a href=../../../Python-vs-Go/2.%E8%BF%9B%E9%98%B6/4.%E4%BD%BF%E7%94%A8MongoDB/ class=md-nav__link> 使用MongoDB </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> Linux <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_1> <label class=md-nav__link for=__nav_7_1 id=__nav_7_1_label tabindex=0> Shell <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_1_label aria-expanded=false> <label class=md-nav__title for=__nav_7_1> <span class="md-nav__icon md-icon"></span> Shell </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Linux/shell/Shell%E7%AE%80%E4%BB%8B/ class=md-nav__link> Shell 教程概述 </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/1.%E7%AC%AC%E4%B8%80%E4%B8%AAshell%E7%A8%8B%E5%BA%8F/ class=md-nav__link> 1.第一个 Shell 程序 </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/2.Shell%E5%8F%98%E9%87%8F/ class=md-nav__link> 2.Shell 变量 </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/3.Shell%E5%8F%82%E6%95%B0/ class=md-nav__link> 3.Shell 参数 </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/4.Shell%E6%95%B0%E7%BB%84/ class=md-nav__link> 4.Shell数组 </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/5.Shell%E8%BF%90%E7%AE%97%E7%AC%A6/ class=md-nav__link> 5.Shell 运算符 </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/6.Shell-echo_printf%E5%91%BD%E4%BB%A4/ class=md-nav__link> 6.Shell echo/printf 命令 </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/7.Shell-test命令.md class=md-nav__link> None </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/8.Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/ class=md-nav__link> 8.Shell 流程控制 </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/9.Shell%E5%87%BD%E6%95%B0/ class=md-nav__link> 8.Shell 函数 </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/10.Shell%E8%BE%93%E5%85%A5_%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/ class=md-nav__link> 10.Shell输入/输出重定向 </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/11.Shell%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/ class=md-nav__link> 11.Shell正则表达式 </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/12.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/ class=md-nav__link> 12.Shell三剑客之grep </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/13.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/ class=md-nav__link> 13.Shell三剑客之sed </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/14.Shell%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/ class=md-nav__link> 14.Shell三剑客之awk </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/15.Shell%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/ class=md-nav__link> 15.Shell常用工具 </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/16.Shell%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/ class=md-nav__link> 16.Shell实战项目 </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/17.Shell%E8%84%9A%E6%9C%AC%E7%A4%BA%E4%BE%8B/ class=md-nav__link> 17.Shell脚本示例 </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/18.Shell%E8%84%9A%E6%9C%AC%E7%9A%84%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%B7%A5%E5%85%B7/ class=md-nav__link> 18.Shell脚本的参数解析工具 </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/19.10%E4%B8%AA%E5%AE%9E%E7%94%A8Linux-Shell%E8%84%9A%E6%9C%AC%E6%A1%88%E4%BE%8B/ class=md-nav__link> 19.10个实用Linux Shell脚本案例 </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/20.Shell%E8%84%9A%E6%9C%AC%E7%9A%84%E8%A7%84%E8%8C%83/ class=md-nav__link> 20.Shell脚本的规范 </a> </li> <li class=md-nav__item> <a href=../../../Linux/shell/21.DevOps%E4%B8%8B%E7%9A%84Shell%E8%84%9A%E6%9C%AC/ class=md-nav__link> 21.DevOps下的Shell脚本 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_2> <label class=md-nav__link for=__nav_7_2 id=__nav_7_2_label tabindex=0> Ansible <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_2_label aria-expanded=false> <label class=md-nav__title for=__nav_7_2> <span class="md-nav__icon md-icon"></span> Ansible </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Linux/Ansible/1.Ansible%E5%85%A5%E9%97%A8%E5%92%8C%E5%AE%9E%E8%B7%B5/ class=md-nav__link> 1.Ansible入门和实践 </a> </li> <li class=md-nav__item> <a href=../../../Linux/Ansible/2.Ansible-wiki/ class=md-nav__link> 2.Ansible-wiki </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_3> <label class=md-nav__link for=__nav_7_3 id=__nav_7_3_label tabindex=0> Git <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_3_label aria-expanded=false> <label class=md-nav__title for=__nav_7_3> <span class="md-nav__icon md-icon"></span> Git </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Linux/Git/1.GitHub%E7%9A%84%E9%AB%98%E7%BA%A7%E6%90%9C%E7%B4%A2/ class=md-nav__link> 1.GitHub的高级搜索 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_4> <label class=md-nav__link for=__nav_7_4 id=__nav_7_4_label tabindex=0> system <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_4_label aria-expanded=false> <label class=md-nav__title for=__nav_7_4> <span class="md-nav__icon md-icon"></span> system </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Linux/system/0.Linux%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F%E4%B8%8B%E8%BD%BD/ class=md-nav__link> Linux系统镜像下载 </a> </li> <li class=md-nav__item> <a href=../../../Linux/system/1.Linux%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/ class=md-nav__link> Linux安全加固 </a> </li> <li class=md-nav__item> <a href=../../../Linux/system/2.Systemd/ class=md-nav__link> Systemd </a> </li> <li class=md-nav__item> <a href=../../../Linux/system/3.Superivisor/ class=md-nav__link> Superivisor </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_5> <label class=md-nav__link for=__nav_7_5 id=__nav_7_5_label tabindex=0> serveices <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_5_label aria-expanded=false> <label class=md-nav__title for=__nav_7_5> <span class="md-nav__icon md-icon"></span> serveices </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Linux/serveices/0.ubuntu-desktop-vmware/ class=md-nav__link> ubuntu-desktop-vmware </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex=0> Other <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Other </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8_1> <label class=md-nav__link for=__nav_8_1 id=__nav_8_1_label tabindex=0> tools <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_8_1_label aria-expanded=false> <label class=md-nav__title for=__nav_8_1> <span class="md-nav__icon md-icon"></span> tools </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Other/tools/1.PicGo%E5%9B%BE%E5%BA%8A/ class=md-nav__link> 1.PicGo图床 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1-日志收集架构 class=md-nav__link> 1. 日志收集架构 </a> <nav class=md-nav aria-label="1. 日志收集架构"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#11-kubernetes-中的基本日志 class=md-nav__link> 1.1 Kubernetes 中的基本日志 </a> </li> <li class=md-nav__item> <a href=#12-kubernetes-日志收集 class=md-nav__link> 1.2 Kubernetes 日志收集 </a> <nav class=md-nav aria-label="1.2 Kubernetes 日志收集"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#121-节点日志采集代理 class=md-nav__link> 1.2.1 节点日志采集代理 </a> </li> <li class=md-nav__item> <a href=#122-以-sidecar-容器收集日志 class=md-nav__link> 1.2.2 以 sidecar 容器收集日志 </a> </li> <li class=md-nav__item> <a href=#123-直接从应用程序收集日志 class=md-nav__link> 1.2.3 直接从应用程序收集日志 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-搭建-efk-日志系统 class=md-nav__link> 2. 搭建 EFK 日志系统 </a> <nav class=md-nav aria-label="2. 搭建 EFK 日志系统"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-安装-elasticsearch-集群 class=md-nav__link> 2.1 安装 Elasticsearch 集群 </a> <nav class=md-nav aria-label="2.1 安装 Elasticsearch 集群"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#211-环境准备 class=md-nav__link> 2.1.1 环境准备 </a> </li> <li class=md-nav__item> <a href=#212-安装-es-集群 class=md-nav__link> 2.1.2 安装 ES 集群 </a> </li> <li class=md-nav__item> <a href=#213-安装-kibana class=md-nav__link> 2.1.3 安装 Kibana </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#22-部署-fluentd class=md-nav__link> 2.2 部署 Fluentd </a> <nav class=md-nav aria-label="2.2 部署 Fluentd"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#221-工作原理 class=md-nav__link> 2.2.1 工作原理 </a> </li> <li class=md-nav__item> <a href=#222-配置 class=md-nav__link> 2.2.2 配置 </a> </li> <li class=md-nav__item> <a href=#223-安装 class=md-nav__link> 2.2.3 安装 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#23-安装-kafka class=md-nav__link> 2.3 安装 Kafka </a> </li> <li class=md-nav__item> <a href=#24-fluentd-配置-kafka class=md-nav__link> 2.4 Fluentd 配置 Kafka </a> </li> <li class=md-nav__item> <a href=#25-安装-logstash class=md-nav__link> 2.5 安装 Logstash </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-参考文献 class=md-nav__link> 3. 参考文献 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=kubernetes日志收集>Kubernetes日志收集<a class=headerlink href=#kubernetes日志收集 title="Permanent link">&para;</a></h1> <h2 id=1-日志收集架构>1. 日志收集架构<a class=headerlink href=#1-日志收集架构 title="Permanent link">&para;</a></h2> <p>前面我们学习了 Kubernetes 集群中监控系统的搭建，除了对集群的监控报警之外，还有一项运维工作是非常重要的，那就是日志的收集。</p> <p>应用程序和系统日志可以帮助我们了解集群内部的运行情况，日志对于我们调试问题和监视集群情况也是非常有用的。而且大部分的应用都会有日志记录，对于传统的应用大部分都会写入到本地的日志文件之中。对于容器化应用程序来说则更简单，只需要将日志信息写入到 stdout 和 stderr 即可，容器默认情况下就会把这些日志输出到宿主机上的一个 JSON 文件之中，同样我们也可以通过 <code>docker logs</code> 或者 <code>kubectl logs</code> 来查看到对应的日志信息。</p> <p>但是，通常来说容器引擎或运行时提供的功能不足以记录完整的日志信息，比如，如果容器崩溃了、Pod 被驱逐了或者节点挂掉了，我们仍然也希望访问应用程序的日志。所以，日志应该独立于节点、Pod 或容器的生命周期，这种设计方式被称为 <code>cluster-level-logging</code>，即完全独立于 Kubernetes 系统，需要自己提供单独的日志后端存储、分析和查询工具。</p> <h3 id=11-kubernetes-中的基本日志>1.1 Kubernetes 中的基本日志<a class=headerlink href=#11-kubernetes-中的基本日志 title="Permanent link">&para;</a></h3> <p>下面这个示例是 Kubernetes 中的一个基本日志记录的示例，直接将数据输出到标准输出流，如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">counter</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=w>  </span><span class=nt>containers</span><span class=p>:</span>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">count</span>
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=w>      </span><span class=nt>args</span><span class=p>:</span>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=w>        </span><span class="p p-Indicator">[</span>
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=w>          </span><span class=nv>/bin/sh</span><span class="p p-Indicator">,</span>
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=w>          </span><span class=nv>-c</span><span class="p p-Indicator">,</span>
<a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=w>          </span><span class=s>&#39;i=0;</span><span class=nv> </span><span class=s>while</span><span class=nv> </span><span class=s>true;</span><span class=nv> </span><span class=s>do</span><span class=nv> </span><span class=s>echo</span><span class=nv> </span><span class=s>&quot;$i:</span><span class=nv> </span><span class=s>$(date)&quot;;</span><span class=nv> </span><span class=s>i=$((i+1));</span><span class=nv> </span><span class=s>sleep</span><span class=nv> </span><span class=s>1;</span><span class=nv> </span><span class=s>done&#39;</span><span class="p p-Indicator">,</span>
<a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=w>        </span><span class="p p-Indicator">]</span>
</code></pre></div> <p>将上面文件保存为 counter-pod.yaml，该 Pod 每秒输出一些文本信息，创建这个 Pod：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>$<span class=w> </span>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>counter-pod.yaml
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>pod<span class=w> </span><span class=s2>&quot;counter&quot;</span><span class=w> </span>created
</code></pre></div> <p>创建完成后，可以使用 <code>kubectl logs</code> 命令查看日志信息：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>$<span class=w> </span>kubectl<span class=w> </span>logs<span class=w> </span>counter
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=m>0</span>:<span class=w> </span>Thu<span class=w> </span>Dec<span class=w> </span><span class=m>27</span><span class=w> </span><span class=m>15</span>:47:04<span class=w> </span>UTC<span class=w> </span><span class=m>2018</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=m>1</span>:<span class=w> </span>Thu<span class=w> </span>Dec<span class=w> </span><span class=m>27</span><span class=w> </span><span class=m>15</span>:47:05<span class=w> </span>UTC<span class=w> </span><span class=m>2018</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=m>2</span>:<span class=w> </span>Thu<span class=w> </span>Dec<span class=w> </span><span class=m>27</span><span class=w> </span><span class=m>15</span>:47:06<span class=w> </span>UTC<span class=w> </span><span class=m>2018</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=m>3</span>:<span class=w> </span>Thu<span class=w> </span>Dec<span class=w> </span><span class=m>27</span><span class=w> </span><span class=m>15</span>:47:07<span class=w> </span>UTC<span class=w> </span><span class=m>2018</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>......
</code></pre></div> <h3 id=12-kubernetes-日志收集>1.2 Kubernetes 日志收集<a class=headerlink href=#12-kubernetes-日志收集 title="Permanent link">&para;</a></h3> <p>Kubernetes 集群本身不提供日志收集的解决方案，一般来说有主要的 3 种方案来做日志收集：</p> <ul> <li>在节点上运行一个 agent 来收集日志</li> <li>在 Pod 中包含一个 sidecar 容器来收集应用日志</li> <li>直接在应用程序中将日志信息推送到采集后端</li> </ul> <h4 id=121-节点日志采集代理>1.2.1 节点日志采集代理<a class=headerlink href=#121-节点日志采集代理 title="Permanent link">&para;</a></h4> <p><img alt class=zoom src=../../../assets/static/kubernetes/5/log-agent.png></p> <p>通过在每个节点上运行一个日志收集的 agent 来采集日志数据，日志采集 agent 是一种专用工具，用于将日志数据推送到统一的后端。</p> <p>一般来说，这种 agent 用一个容器来运行，可以访问该节点上所有应用程序容器的日志文件所在目录。</p> <p>由于这种 agent 必须在每个节点上运行，所以直接使用 DaemonSet 控制器运行该应用程序即可。</p> <p>在节点上运行一个日志收集的 agent 这种方式是最常见的一种方法，因为它只需要在每个节点上运行一个代理程序，并不需要对节点上运行的应用程序进行更改，对应用程序没有任何侵入性，但是这种方法也仅仅适用于收集输出到 stdout 和 stderr 的应用程序日志。</p> <h4 id=122-以-sidecar-容器收集日志>1.2.2 以 sidecar 容器收集日志<a class=headerlink href=#122-以-sidecar-容器收集日志 title="Permanent link">&para;</a></h4> <p>我们看上面的图可以看到有一个明显的问题就是我们采集的日志都是通过输出到容器的 stdout 和 stderr 里面的信息，这些信息会在本地的容器对应目录中保留成 JSON 日志文件，所以直接在节点上运行一个 agent 就可以采集到日志。但是如果我们的应用程序的日志是输出到容器中的某个日志文件的话呢？这种日志数据显然只通过上面的方案是采集不到的了。</p> <p><strong>用 sidecar 容器重新输出日志</strong></p> <p><img alt class=zoom src=../../../assets/static/kubernetes/5/sidecar-agent1.png></p> <p>对于上面这种情况我们可以直接在 Pod 中启动另外一个 sidecar 容器，直接将应用程序的日志通过这个容器重新输出到 stdout，这样是不是通过上面的节点日志收集方案又可以完成了。</p> <p>由于这个 sidecar 容器的主要逻辑就是将应用程序中的日志进行重定向打印，所以背后的逻辑非常简单，开销很小，而且由于输出到了 stdout 或者 stderr，所以我们也可以使用 kubectl logs 来查看日志了。</p> <p>下面的示例是在 Pod 中将日志记录在了容器的两个本地文件之中： <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">counter</span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=w>  </span><span class=nt>containers</span><span class=p>:</span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">count</span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=w>      </span><span class=nt>args</span><span class=p>:</span>
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/bin/sh</span>
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">-c</span>
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="p p-Indicator">&gt;</span>
<a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=w>          </span><span class=no>i=0;</span>
<a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=w>          </span><span class=no>while true;</span>
<a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=w>          </span><span class=no>do</span>
<a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=w>            </span><span class=no>echo &quot;$i: $(date)&quot; &gt;&gt; /var/log/1.log;</span>
<a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a><span class=w>            </span><span class=no>echo &quot;$(date) INFO $i&quot; &gt;&gt; /var/log/2.log;</span>
<a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=w>            </span><span class=no>i=$((i+1));</span>
<a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=w>            </span><span class=no>sleep 1;</span>
<a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a><span class=w>          </span><span class=no>done</span>
<a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">varlog</span>
<a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/log</span>
<a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span>
<a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">varlog</span>
<a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a><span class=w>      </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span>
</code></pre></div></p> <p>由于 Pod 中容器的特性，我们可以利用另外一个 sidecar 容器去获取到另外容器中的日志文件，然后将日志重定向到自己的 stdout 流中，可以将上面的 YAML 文件做如下修改：（two-files-counter-pod-streaming-sidecar.yaml）</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">counter</span>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>  </span><span class=nt>containers</span><span class=p>:</span>
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">count</span>
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=w>      </span><span class=nt>args</span><span class=p>:</span>
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/bin/sh</span>
<a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">-c</span>
<a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="p p-Indicator">&gt;</span>
<a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=w>          </span><span class=no>i=0;</span>
<a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=w>          </span><span class=no>while true;</span>
<a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=w>          </span><span class=no>do</span>
<a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=w>            </span><span class=no>echo &quot;$i: $(date)&quot; &gt;&gt; /var/log/1.log;</span>
<a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=w>            </span><span class=no>echo &quot;$(date) INFO $i&quot; &gt;&gt; /var/log/2.log;</span>
<a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a><span class=w>            </span><span class=no>i=$((i+1));</span>
<a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=w>            </span><span class=no>sleep 1;</span>
<a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a><span class=w>          </span><span class=no>done</span>
<a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">varlog</span>
<a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/log</span>
<a id=__codelineno-4-24 name=__codelineno-4-24 href=#__codelineno-4-24></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">count-log-1</span>
<a id=__codelineno-4-25 name=__codelineno-4-25 href=#__codelineno-4-25></a><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<a id=__codelineno-4-26 name=__codelineno-4-26 href=#__codelineno-4-26></a><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>/bin/sh</span><span class="p p-Indicator">,</span><span class=w> </span><span class=nv>-c</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;tail</span><span class=nv> </span><span class=s>-n+1</span><span class=nv> </span><span class=s>-f</span><span class=nv> </span><span class=s>/var/log/1.log&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-4-27 name=__codelineno-4-27 href=#__codelineno-4-27></a><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-4-28 name=__codelineno-4-28 href=#__codelineno-4-28></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">varlog</span>
<a id=__codelineno-4-29 name=__codelineno-4-29 href=#__codelineno-4-29></a><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/log</span>
<a id=__codelineno-4-30 name=__codelineno-4-30 href=#__codelineno-4-30></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">count-log-2</span>
<a id=__codelineno-4-31 name=__codelineno-4-31 href=#__codelineno-4-31></a><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<a id=__codelineno-4-32 name=__codelineno-4-32 href=#__codelineno-4-32></a><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>/bin/sh</span><span class="p p-Indicator">,</span><span class=w> </span><span class=nv>-c</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;tail</span><span class=nv> </span><span class=s>-n+1</span><span class=nv> </span><span class=s>-f</span><span class=nv> </span><span class=s>/var/log/2.log&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-4-33 name=__codelineno-4-33 href=#__codelineno-4-33></a><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-4-34 name=__codelineno-4-34 href=#__codelineno-4-34></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">varlog</span>
<a id=__codelineno-4-35 name=__codelineno-4-35 href=#__codelineno-4-35></a><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/log</span>
<a id=__codelineno-4-36 name=__codelineno-4-36 href=#__codelineno-4-36></a><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span>
<a id=__codelineno-4-37 name=__codelineno-4-37 href=#__codelineno-4-37></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">varlog</span>
<a id=__codelineno-4-38 name=__codelineno-4-38 href=#__codelineno-4-38></a><span class=w>      </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span>
</code></pre></div> <p>直接创建上面的 Pod： <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>$<span class=w> </span>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>two-files-counter-pod-streaming-sidecar.yaml
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>pod<span class=w> </span><span class=s2>&quot;counter&quot;</span><span class=w> </span>created
</code></pre></div></p> <p>运行成功后，我们可以通过下面的命令来查看日志的信息： <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>$<span class=w> </span>kubectl<span class=w> </span>logs<span class=w> </span>counter<span class=w> </span>count-log-1
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=m>0</span>:<span class=w> </span>Mon<span class=w> </span>Jan<span class=w>  </span><span class=m>1</span><span class=w> </span><span class=m>00</span>:00:00<span class=w> </span>UTC<span class=w> </span><span class=m>2001</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=m>1</span>:<span class=w> </span>Mon<span class=w> </span>Jan<span class=w>  </span><span class=m>1</span><span class=w> </span><span class=m>00</span>:00:01<span class=w> </span>UTC<span class=w> </span><span class=m>2001</span>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=m>2</span>:<span class=w> </span>Mon<span class=w> </span>Jan<span class=w>  </span><span class=m>1</span><span class=w> </span><span class=m>00</span>:00:02<span class=w> </span>UTC<span class=w> </span><span class=m>2001</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>...
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>$<span class=w> </span>kubectl<span class=w> </span>logs<span class=w> </span>counter<span class=w> </span>count-log-2
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>Mon<span class=w> </span>Jan<span class=w>  </span><span class=m>1</span><span class=w> </span><span class=m>00</span>:00:00<span class=w> </span>UTC<span class=w> </span><span class=m>2001</span><span class=w> </span>INFO<span class=w> </span><span class=m>0</span>
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>Mon<span class=w> </span>Jan<span class=w>  </span><span class=m>1</span><span class=w> </span><span class=m>00</span>:00:01<span class=w> </span>UTC<span class=w> </span><span class=m>2001</span><span class=w> </span>INFO<span class=w> </span><span class=m>1</span>
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>Mon<span class=w> </span>Jan<span class=w>  </span><span class=m>1</span><span class=w> </span><span class=m>00</span>:00:02<span class=w> </span>UTC<span class=w> </span><span class=m>2001</span><span class=w> </span>INFO<span class=w> </span><span class=m>2</span>
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>...
</code></pre></div> 这样前面节点上的日志采集 agent 就可以自动获取这些日志信息，而不需要其他配置。</p> <p>这种方法虽然可以解决上面的问题，但是也有一个明显的缺陷，就是日志不仅会在原容器文件中保留下来，还会通过 stdout 输出后占用磁盘空间，这样无形中就增加了一倍磁盘空间。</p> <p><strong>使用 sidecar 运行日志采集 agent</strong></p> <p><img alt class=zoom src=../../../assets/static/kubernetes/5/sidecar-agent2.png></p> <p>如果你觉得在节点上运行一个日志采集的代理不够灵活的话，那么你也可以创建一个单独的日志采集代理程序的 sidecar 容器，不过需要单独配置和应用程序一起运行。</p> <p>不过这样虽然更加灵活，但是在 sidecar 容器中运行日志采集代理程序会导致大量资源消耗，因为你有多少个要采集的 Pod，就需要运行多少个采集代理程序，另外还无法使用 kubectl logs 命令来访问这些日志，因为它们不受 kubelet 控制。</p> <p>举个例子，你可以使用的 Stackdriver，它使用 fluentd 作为记录剂。以下是两个可用于实现此方法的配置文件。第一个文件包含配置流利的 ConfigMap。</p> <p>下面是 Kubernetes 官方的一个 fluentd 的配置文件示例，使用 ConfigMap 对象来保存： <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-config</span>
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=nt>data</span><span class=p>:</span>
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=w>  </span><span class=nt>fluentd.conf</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span>
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=w>    </span><span class=no>&lt;source&gt;</span>
<a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=w>      </span><span class=no>type tail</span>
<a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=w>      </span><span class=no>format none</span>
<a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=w>      </span><span class=no>path /var/log/1.log</span>
<a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=w>      </span><span class=no>pos_file /var/log/1.log.pos</span>
<a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=w>      </span><span class=no>tag count.format1</span>
<a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=w>    </span><span class=no>&lt;/source&gt;</span>
<a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a>
<a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a><span class=w>    </span><span class=no>&lt;source&gt;</span>
<a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a><span class=w>      </span><span class=no>type tail</span>
<a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a><span class=w>      </span><span class=no>format none</span>
<a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a><span class=w>      </span><span class=no>path /var/log/2.log</span>
<a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a><span class=w>      </span><span class=no>pos_file /var/log/2.log.pos</span>
<a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a><span class=w>      </span><span class=no>tag count.format2</span>
<a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a><span class=w>    </span><span class=no>&lt;/source&gt;</span>
<a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a>
<a id=__codelineno-7-23 name=__codelineno-7-23 href=#__codelineno-7-23></a><span class=w>    </span><span class=no>&lt;match **&gt;</span>
<a id=__codelineno-7-24 name=__codelineno-7-24 href=#__codelineno-7-24></a><span class=w>      </span><span class=no>type google_cloud</span>
<a id=__codelineno-7-25 name=__codelineno-7-25 href=#__codelineno-7-25></a><span class=w>    </span><span class=no>&lt;/match&gt;</span>
</code></pre></div></p> <p>上面的配置文件是配置收集原文件 /var/log/1.log 和 /var/log/2.log 的日志数据，然后通过 google_cloud 这个插件将数据推送到 Stackdriver 后端去。</p> <p>下面是我们使用上面的配置文件在应用程序中运行一个 fluentd 的容器来读取日志数据：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">counter</span>
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=w>  </span><span class=nt>containers</span><span class=p>:</span>
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">count</span>
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=w>      </span><span class=nt>args</span><span class=p>:</span>
<a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/bin/sh</span>
<a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">-c</span>
<a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="p p-Indicator">&gt;</span>
<a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=w>          </span><span class=no>i=0;</span>
<a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a><span class=w>          </span><span class=no>while true;</span>
<a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a><span class=w>          </span><span class=no>do</span>
<a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a><span class=w>            </span><span class=no>echo &quot;$i: $(date)&quot; &gt;&gt; /var/log/1.log;</span>
<a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a><span class=w>            </span><span class=no>echo &quot;$(date) INFO $i&quot; &gt;&gt; /var/log/2.log;</span>
<a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a><span class=w>            </span><span class=no>i=$((i+1));</span>
<a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a><span class=w>            </span><span class=no>sleep 1;</span>
<a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a><span class=w>          </span><span class=no>done</span>
<a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">varlog</span>
<a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/log</span>
<a id=__codelineno-8-24 name=__codelineno-8-24 href=#__codelineno-8-24></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">count-agent</span>
<a id=__codelineno-8-25 name=__codelineno-8-25 href=#__codelineno-8-25></a><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">k8s.gcr.io/fluentd-gcp:1.30</span>
<a id=__codelineno-8-26 name=__codelineno-8-26 href=#__codelineno-8-26></a><span class=w>      </span><span class=nt>env</span><span class=p>:</span>
<a id=__codelineno-8-27 name=__codelineno-8-27 href=#__codelineno-8-27></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">FLUENTD_ARGS</span>
<a id=__codelineno-8-28 name=__codelineno-8-28 href=#__codelineno-8-28></a><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">-c /etc/fluentd-config/fluentd.conf</span>
<a id=__codelineno-8-29 name=__codelineno-8-29 href=#__codelineno-8-29></a><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-8-30 name=__codelineno-8-30 href=#__codelineno-8-30></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">varlog</span>
<a id=__codelineno-8-31 name=__codelineno-8-31 href=#__codelineno-8-31></a><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/log</span>
<a id=__codelineno-8-32 name=__codelineno-8-32 href=#__codelineno-8-32></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">config-volume</span>
<a id=__codelineno-8-33 name=__codelineno-8-33 href=#__codelineno-8-33></a><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/etc/fluentd-config</span>
<a id=__codelineno-8-34 name=__codelineno-8-34 href=#__codelineno-8-34></a><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span>
<a id=__codelineno-8-35 name=__codelineno-8-35 href=#__codelineno-8-35></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">varlog</span>
<a id=__codelineno-8-36 name=__codelineno-8-36 href=#__codelineno-8-36></a><span class=w>      </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span>
<a id=__codelineno-8-37 name=__codelineno-8-37 href=#__codelineno-8-37></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">config-volume</span>
<a id=__codelineno-8-38 name=__codelineno-8-38 href=#__codelineno-8-38></a><span class=w>      </span><span class=nt>configMap</span><span class=p>:</span>
<a id=__codelineno-8-39 name=__codelineno-8-39 href=#__codelineno-8-39></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-config</span>
</code></pre></div> <p>上面的 Pod 创建完成后，容器 count-agent 就会将 count 容器中的日志进行收集然后上传。</p> <p>当然，这只是一个简单的示例，我们也完全可以使用其他的任何日志采集工具来替换 fluentd，比如 logstash、fluent-bit 等等。</p> <h4 id=123-直接从应用程序收集日志>1.2.3 直接从应用程序收集日志<a class=headerlink href=#123-直接从应用程序收集日志 title="Permanent link">&para;</a></h4> <p>除了上面的几种方案之外，我们也完全可以通过直接在应用程序中去显示的将日志推送到日志后端，但是这种方式需要代码层面的实现，也超出了 Kubernetes 本身的范围。</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/5/app-logs.png></p> <h2 id=2-搭建-efk-日志系统>2. 搭建 EFK 日志系统<a class=headerlink href=#2-搭建-efk-日志系统 title="Permanent link">&para;</a></h2> <p>前面大家介绍了 Kubernetes 集群中的几种日志收集方案，Kubernetes 中比较流行的日志收集解决方案是 Elasticsearch、Fluentd 和 Kibana（EFK）技术栈，也是官方现在比较推荐的一种方案。</p> <p>Elasticsearch 是一个实时的、分布式的可扩展的搜索引擎，允许进行全文、结构化搜索，它通常用于索引和搜索大量日志数据，也可用于搜索许多不同类型的文档。</p> <p>Elasticsearch 通常与 Kibana 一起部署，Kibana 是 Elasticsearch 的一个功能强大的数据可视化 Dashboard，Kibana 允许你通过 web 界面来浏览 Elasticsearch 日志数据。</p> <p>Fluentd是一个流行的开源数据收集器，我们将在 Kubernetes 集群节点上安装 Fluentd，通过获取容器日志文件、过滤和转换日志数据，然后将数据传递到 Elasticsearch 集群，在该集群中对其进行索引和存储。</p> <p>我们先来配置启动一个可扩展的 Elasticsearch 集群，然后在 Kubernetes 集群中创建一个 Kibana 应用，最后通过 DaemonSet 来运行 Fluentd，以便它在每个 Kubernetes 工作节点上都可以运行一个 Pod。</p> <h3 id=21-安装-elasticsearch-集群>2.1 安装 Elasticsearch 集群<a class=headerlink href=#21-安装-elasticsearch-集群 title="Permanent link">&para;</a></h3> <p>在创建 Elasticsearch 集群之前，我们先创建一个命名空间，我们将在其中安装所有日志相关的资源对象。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>$<span class=w> </span>kubectl<span class=w> </span>create<span class=w> </span>ns<span class=w> </span>logging
</code></pre></div> <h4 id=211-环境准备>2.1.1 环境准备<a class=headerlink href=#211-环境准备 title="Permanent link">&para;</a></h4> <p>ElasticSearch 安装有最低安装要求，如果安装后 Pod 无法正常启动，请检查是否符合最低要求的配置，要求如下：</p> <table> <thead> <tr> <th>节点名称</th> <th style="text-align: center;">节点类型</th> <th style="text-align: center;">CPU 配置</th> <th style="text-align: center;">Memory 配置</th> </tr> </thead> <tbody> <tr> <td>k8s-master</td> <td style="text-align: center;">master</td> <td style="text-align: center;">4C</td> <td style="text-align: center;">4Gi</td> </tr> <tr> <td>k8s-node-2-12</td> <td style="text-align: center;">worker</td> <td style="text-align: center;">8C</td> <td style="text-align: center;">8Gi</td> </tr> <tr> <td>k8s-node-2-13</td> <td style="text-align: center;">worker</td> <td style="text-align: center;">8C</td> <td style="text-align: center;">8Gi</td> </tr> <tr> <td>k8s-node-2-14</td> <td style="text-align: center;">worker</td> <td style="text-align: center;">8C</td> <td style="text-align: center;">8Gi</td> </tr> </tbody> </table> <p>es集群要求</p> <table> <thead> <tr> <th>ElasticSearch节点</th> <th style="text-align: center;">CPU最小要求</th> <th style="text-align: center;">Memory 最小要求</th> </tr> </thead> <tbody> <tr> <td>elasticsearch-master</td> <td style="text-align: center;">&gt;2核</td> <td style="text-align: center;">&gt;2Gi</td> </tr> <tr> <td>elasticsearch-data</td> <td style="text-align: center;">&gt;1核</td> <td style="text-align: center;">&gt;2Gi</td> </tr> <tr> <td>elasticsearch-client</td> <td style="text-align: center;">&gt;1核</td> <td style="text-align: center;">&gt;2Gi</td> </tr> </tbody> </table> <p>这里我们要安装的 ES 集群环境信息如下所示：</p> <table> <thead> <tr> <th>集群名称</th> <th style="text-align: center;">节点类型</th> <th style="text-align: center;">副本数目</th> <th style="text-align: center;">存储大小</th> <th style="text-align: center;">网络模式</th> <th>描述</th> </tr> </thead> <tbody> <tr> <td>elasticsearch</td> <td style="text-align: center;">Master</td> <td style="text-align: center;">3</td> <td style="text-align: center;">5Gi</td> <td style="text-align: center;">ClusterIP</td> <td>主节点</td> </tr> <tr> <td>elasticsearch</td> <td style="text-align: center;">Data</td> <td style="text-align: center;">3</td> <td style="text-align: center;">50Gi</td> <td style="text-align: center;">ClusterIP</td> <td>数据节点</td> </tr> <tr> <td>elasticsearch</td> <td style="text-align: center;">Client</td> <td style="text-align: center;">2</td> <td style="text-align: center;">无</td> <td style="text-align: center;">NodePort</td> <td>处理用户请求、转发</td> </tr> </tbody> </table> <p>这里我们使用一个 NFS 类型的 StorageClass 来做持久化存储，当然如果你是线上环境建议使用 Local PV 或者 Ceph RBD 之类的存储来持久化 Elasticsearch 的数据。</p> <p>安装nfs-storageClass存储 <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>$<span class=w> </span>helm<span class=w> </span>repo<span class=w> </span>add<span class=w> </span>azure<span class=w> </span>http://mirror.azure.cn/kubernetes/charts/
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>$<span class=w> </span>helm<span class=w> </span>repo<span class=w> </span>update
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=c1># 或者下载到本地再安装</span>
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>$<span class=w> </span>helm<span class=w> </span>pull<span class=w> </span>azure/nfs-client-provisioner
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>$<span class=w> </span>tar<span class=w> </span>xvf<span class=w> </span>nfs-client-provisioner-*.tgz
<a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a>
<a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a>$<span class=w> </span>kubectl<span class=w> </span>create<span class=w> </span>ns<span class=w> </span>nfs
<a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a>
<a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a>$<span class=w> </span>helm<span class=w> </span>install<span class=w> </span>efk-nfs-storage<span class=w> </span>-n<span class=w> </span>nfs<span class=w> </span><span class=se>\</span>
<a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a>--set<span class=w> </span>nfs.server<span class=o>=</span><span class=m>192</span>.168.1.46<span class=w> </span><span class=se>\</span>
<a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a>--set<span class=w> </span>nfs.path<span class=o>=</span>/efk<span class=w>  </span><span class=se>\</span>
<a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a>--set<span class=w> </span>storageClass.name<span class=o>=</span>efk-nfs,storageClass.reclaimPolicy<span class=o>=</span>Retain<span class=w> </span><span class=se>\</span>
<a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a>--set<span class=w> </span>storageClass.defaultClass<span class=o>=</span><span class=nb>true</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a>nfs-client-provisioner
</code></pre></div></p> <p>此外由于 ElasticSearch 7.x 版本默认安装了 X-Pack 插件，并且部分功能免费，需要我们配置一些安全证书文件。</p> <p><strong>1、生成证书文件</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=c1># 运行容器生成证书</span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>$<span class=w> </span>docker<span class=w> </span>run<span class=w> </span>--name<span class=w> </span>elastic-certs<span class=w> </span>-i<span class=w> </span>-w<span class=w> </span>/app<span class=w> </span>elasticsearch:7.12.0<span class=w> </span>/bin/sh<span class=w> </span>-c<span class=w>  </span><span class=se>\</span>
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=w>  </span><span class=s2>&quot;elasticsearch-certutil ca --out /app/elastic-stack-ca.p12 --pass &#39;&#39; &amp;&amp; \</span>
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=s2>    elasticsearch-certutil cert --name security-master --dns \</span>
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=s2>    security-master --ca /app/elastic-stack-ca.p12 --pass &#39;&#39; --ca-pass &#39;&#39; --out /app/elastic-certificates.p12&quot;</span>
<a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>
<a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=c1># 从容器中将生成的证书拷贝出来</span>
<a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a>$<span class=w> </span>docker<span class=w> </span>cp<span class=w> </span>elastic-certs:/app/elastic-certificates.p12<span class=w> </span>.
<a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a>
<a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=c1># 删除容器</span>
<a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a>$<span class=w> </span>docker<span class=w> </span>rm<span class=w> </span>-f<span class=w> </span>elastic-certs
<a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a>
<a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=c1># 将 pcks12 中的信息分离出来，写入文件</span>
<a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a>$<span class=w> </span>openssl<span class=w> </span>pkcs12<span class=w> </span>-nodes<span class=w> </span>-passin<span class=w> </span>pass:<span class=s1>&#39;&#39;</span><span class=w> </span>-in<span class=w> </span>elastic-certificates.p12<span class=w> </span>-out<span class=w> </span>elastic-certificate.pem
</code></pre></div> <p><strong>2、添加证书到 Kubernetes</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=c1># 添加证书</span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>$<span class=w> </span>kubectl<span class=w> </span>create<span class=w> </span>secret<span class=w> </span>-n<span class=w> </span>logging<span class=w> </span>generic<span class=w> </span>elastic-certs<span class=w> </span>--from-file<span class=o>=</span>elastic-certificates.p12
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=c1># 设置集群用户名密码</span>
<a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>$<span class=w> </span>kubectl<span class=w> </span>create<span class=w> </span>secret<span class=w> </span>-n<span class=w> </span>logging<span class=w> </span>generic<span class=w> </span>elastic-auth<span class=w> </span>--from-literal<span class=o>=</span><span class=nv>username</span><span class=o>=</span>elastic<span class=w> </span>--from-literal<span class=o>=</span><span class=nv>password</span><span class=o>=</span>oschina
</code></pre></div> <h4 id=212-安装-es-集群>2.1.2 安装 ES 集群<a class=headerlink href=#212-安装-es-集群 title="Permanent link">&para;</a></h4> <p>首先添加 ELastic 的 Helm 仓库： <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>$<span class=w> </span>helm<span class=w> </span>repo<span class=w> </span>add<span class=w> </span>elastic<span class=w> </span>https://helm.elastic.co
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>$<span class=w> </span>helm<span class=w> </span>repo<span class=w> </span>update
</code></pre></div> ElaticSearch 安装需要安装三次，分别安装 Master、Data、Client 节点，Master 节点负责集群间的管理工作；Data 节点负责存储数据；Client 节点负责代理 ElasticSearch Cluster 集群，负载均衡。</p> <p>首先使用 helm pull 拉取 Chart 并解压： <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a>$<span class=w> </span>helm<span class=w> </span>pull<span class=w> </span>elastic/elasticsearch<span class=w> </span>--untar<span class=w> </span>--version<span class=w> </span><span class=m>7</span>.17.3
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>$<span class=w> </span><span class=nb>cd</span><span class=w> </span>elasticsearch
</code></pre></div></p> <p>在 Chart 目录下面创建用于 Master 节点安装配置的 values 文件：</p> <p><code>values-master.yaml</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=c1># values-master.yaml</span>
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=c1>## 设置集群名称</span>
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=nt>clusterName</span><span class=p>:</span><span class=w> </span><span class=s>&quot;elasticsearch&quot;</span>
<a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=c1>## 设置节点名称</span>
<a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=nt>nodeGroup</span><span class=p>:</span><span class=w> </span><span class=s>&quot;master&quot;</span>
<a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a>
<a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=c1>## 设置角色</span>
<a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=nt>roles</span><span class=p>:</span>
<a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a><span class=w>  </span><span class=nt>master</span><span class=p>:</span><span class=w> </span><span class=s>&quot;true&quot;</span>
<a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=w>  </span><span class=nt>ingest</span><span class=p>:</span><span class=w> </span><span class=s>&quot;false&quot;</span>
<a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a><span class=w>  </span><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class=s>&quot;false&quot;</span>
<a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a>
<a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a><span class=c1># ============镜像配置============</span>
<a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a><span class=c1>## 指定镜像与镜像版本</span>
<a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s>&quot;elasticsearch&quot;</span>
<a id=__codelineno-15-16 name=__codelineno-15-16 href=#__codelineno-15-16></a><span class=nt>imageTag</span><span class=p>:</span><span class=w> </span><span class=s>&quot;7.17.3&quot;</span>
<a id=__codelineno-15-17 name=__codelineno-15-17 href=#__codelineno-15-17></a><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=s>&quot;IfNotPresent&quot;</span>
<a id=__codelineno-15-18 name=__codelineno-15-18 href=#__codelineno-15-18></a>
<a id=__codelineno-15-19 name=__codelineno-15-19 href=#__codelineno-15-19></a><span class=c1>## 副本数</span>
<a id=__codelineno-15-20 name=__codelineno-15-20 href=#__codelineno-15-20></a><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id=__codelineno-15-21 name=__codelineno-15-21 href=#__codelineno-15-21></a>
<a id=__codelineno-15-22 name=__codelineno-15-22 href=#__codelineno-15-22></a><span class=c1># ============资源配置============</span>
<a id=__codelineno-15-23 name=__codelineno-15-23 href=#__codelineno-15-23></a><span class=c1>## JVM 配置参数</span>
<a id=__codelineno-15-24 name=__codelineno-15-24 href=#__codelineno-15-24></a><span class=nt>esJavaOpts</span><span class=p>:</span><span class=w> </span><span class=s>&quot;-Xmx1g</span><span class=nv> </span><span class=s>-Xms1g&quot;</span>
<a id=__codelineno-15-25 name=__codelineno-15-25 href=#__codelineno-15-25></a><span class=c1>## 部署资源配置(生成环境要设置大些)</span>
<a id=__codelineno-15-26 name=__codelineno-15-26 href=#__codelineno-15-26></a><span class=nt>resources</span><span class=p>:</span>
<a id=__codelineno-15-27 name=__codelineno-15-27 href=#__codelineno-15-27></a><span class=w>  </span><span class=nt>requests</span><span class=p>:</span>
<a id=__codelineno-15-28 name=__codelineno-15-28 href=#__codelineno-15-28></a><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s>&quot;2000m&quot;</span>
<a id=__codelineno-15-29 name=__codelineno-15-29 href=#__codelineno-15-29></a><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s>&quot;2Gi&quot;</span>
<a id=__codelineno-15-30 name=__codelineno-15-30 href=#__codelineno-15-30></a><span class=w>  </span><span class=nt>limits</span><span class=p>:</span>
<a id=__codelineno-15-31 name=__codelineno-15-31 href=#__codelineno-15-31></a><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s>&quot;2000m&quot;</span>
<a id=__codelineno-15-32 name=__codelineno-15-32 href=#__codelineno-15-32></a><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s>&quot;2Gi&quot;</span>
<a id=__codelineno-15-33 name=__codelineno-15-33 href=#__codelineno-15-33></a><span class=c1>## 数据持久卷配置</span>
<a id=__codelineno-15-34 name=__codelineno-15-34 href=#__codelineno-15-34></a><span class=nt>persistence</span><span class=p>:</span>
<a id=__codelineno-15-35 name=__codelineno-15-35 href=#__codelineno-15-35></a><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-15-36 name=__codelineno-15-36 href=#__codelineno-15-36></a><span class=c1>## 存储数据大小配置</span>
<a id=__codelineno-15-37 name=__codelineno-15-37 href=#__codelineno-15-37></a><span class=nt>volumeClaimTemplate</span><span class=p>:</span>
<a id=__codelineno-15-38 name=__codelineno-15-38 href=#__codelineno-15-38></a><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">efk-nfs</span>
<a id=__codelineno-15-39 name=__codelineno-15-39 href=#__codelineno-15-39></a><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;ReadWriteOnce&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-15-40 name=__codelineno-15-40 href=#__codelineno-15-40></a><span class=w>  </span><span class=nt>resources</span><span class=p>:</span>
<a id=__codelineno-15-41 name=__codelineno-15-41 href=#__codelineno-15-41></a><span class=w>    </span><span class=nt>requests</span><span class=p>:</span>
<a id=__codelineno-15-42 name=__codelineno-15-42 href=#__codelineno-15-42></a><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">50Gi</span>
<a id=__codelineno-15-43 name=__codelineno-15-43 href=#__codelineno-15-43></a>
<a id=__codelineno-15-44 name=__codelineno-15-44 href=#__codelineno-15-44></a><span class=c1># ============安全配置============</span>
<a id=__codelineno-15-45 name=__codelineno-15-45 href=#__codelineno-15-45></a><span class=c1>## 设置协议，可配置为 http、https</span>
<a id=__codelineno-15-46 name=__codelineno-15-46 href=#__codelineno-15-46></a><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<a id=__codelineno-15-47 name=__codelineno-15-47 href=#__codelineno-15-47></a><span class=c1>## 证书挂载配置，这里我们挂入上面创建的证书</span>
<a id=__codelineno-15-48 name=__codelineno-15-48 href=#__codelineno-15-48></a><span class=nt>secretMounts</span><span class=p>:</span>
<a id=__codelineno-15-49 name=__codelineno-15-49 href=#__codelineno-15-49></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">elastic-certs</span>
<a id=__codelineno-15-50 name=__codelineno-15-50 href=#__codelineno-15-50></a><span class=w>    </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">elastic-certs</span>
<a id=__codelineno-15-51 name=__codelineno-15-51 href=#__codelineno-15-51></a><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/share/elasticsearch/config/certs</span>
<a id=__codelineno-15-52 name=__codelineno-15-52 href=#__codelineno-15-52></a><span class=w>    </span><span class=nt>defaultMode</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">0755</span>
<a id=__codelineno-15-53 name=__codelineno-15-53 href=#__codelineno-15-53></a>
<a id=__codelineno-15-54 name=__codelineno-15-54 href=#__codelineno-15-54></a><span class=c1>## 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml、log4j2.properties</span>
<a id=__codelineno-15-55 name=__codelineno-15-55 href=#__codelineno-15-55></a><span class=c1>## ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下</span>
<a id=__codelineno-15-56 name=__codelineno-15-56 href=#__codelineno-15-56></a><span class=c1>## 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https</span>
<a id=__codelineno-15-57 name=__codelineno-15-57 href=#__codelineno-15-57></a><span class=nt>esConfig</span><span class=p>:</span>
<a id=__codelineno-15-58 name=__codelineno-15-58 href=#__codelineno-15-58></a><span class=w>  </span><span class=nt>elasticsearch.yml</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span>
<a id=__codelineno-15-59 name=__codelineno-15-59 href=#__codelineno-15-59></a><span class=w>    </span><span class=no>xpack.security.enabled: true</span>
<a id=__codelineno-15-60 name=__codelineno-15-60 href=#__codelineno-15-60></a><span class=w>    </span><span class=no>xpack.security.transport.ssl.enabled: true</span>
<a id=__codelineno-15-61 name=__codelineno-15-61 href=#__codelineno-15-61></a><span class=w>    </span><span class=no>xpack.security.transport.ssl.verification_mode: certificate</span>
<a id=__codelineno-15-62 name=__codelineno-15-62 href=#__codelineno-15-62></a><span class=w>    </span><span class=no>xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
<a id=__codelineno-15-63 name=__codelineno-15-63 href=#__codelineno-15-63></a><span class=w>    </span><span class=no>xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
<a id=__codelineno-15-64 name=__codelineno-15-64 href=#__codelineno-15-64></a><span class=w>    </span><span class=no># xpack.security.http.ssl.enabled: true</span>
<a id=__codelineno-15-65 name=__codelineno-15-65 href=#__codelineno-15-65></a><span class=w>    </span><span class=no># xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
<a id=__codelineno-15-66 name=__codelineno-15-66 href=#__codelineno-15-66></a><span class=w>    </span><span class=no># xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
<a id=__codelineno-15-67 name=__codelineno-15-67 href=#__codelineno-15-67></a><span class=c1>## 环境变量配置，这里引入上面设置的用户名、密码 secret 文件</span>
<a id=__codelineno-15-68 name=__codelineno-15-68 href=#__codelineno-15-68></a><span class=nt>extraEnvs</span><span class=p>:</span>
<a id=__codelineno-15-69 name=__codelineno-15-69 href=#__codelineno-15-69></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ELASTIC_USERNAME</span>
<a id=__codelineno-15-70 name=__codelineno-15-70 href=#__codelineno-15-70></a><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span>
<a id=__codelineno-15-71 name=__codelineno-15-71 href=#__codelineno-15-71></a><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span>
<a id=__codelineno-15-72 name=__codelineno-15-72 href=#__codelineno-15-72></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">elastic-auth</span>
<a id=__codelineno-15-73 name=__codelineno-15-73 href=#__codelineno-15-73></a><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">username</span>
<a id=__codelineno-15-74 name=__codelineno-15-74 href=#__codelineno-15-74></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ELASTIC_PASSWORD</span>
<a id=__codelineno-15-75 name=__codelineno-15-75 href=#__codelineno-15-75></a><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span>
<a id=__codelineno-15-76 name=__codelineno-15-76 href=#__codelineno-15-76></a><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span>
<a id=__codelineno-15-77 name=__codelineno-15-77 href=#__codelineno-15-77></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">elastic-auth</span>
<a id=__codelineno-15-78 name=__codelineno-15-78 href=#__codelineno-15-78></a><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">password</span>
<a id=__codelineno-15-79 name=__codelineno-15-79 href=#__codelineno-15-79></a>
<a id=__codelineno-15-80 name=__codelineno-15-80 href=#__codelineno-15-80></a><span class=c1># ============调度配置============</span>
<a id=__codelineno-15-81 name=__codelineno-15-81 href=#__codelineno-15-81></a><span class=c1>## 设置调度策略</span>
<a id=__codelineno-15-82 name=__codelineno-15-82 href=#__codelineno-15-82></a><span class=c1>## - hard：只有当有足够的节点时 Pod 才会被调度，并且它们永远不会出现在同一个节点上</span>
<a id=__codelineno-15-83 name=__codelineno-15-83 href=#__codelineno-15-83></a><span class=c1>## - soft：尽最大努力调度</span>
<a id=__codelineno-15-84 name=__codelineno-15-84 href=#__codelineno-15-84></a><span class=nt>antiAffinity</span><span class=p>:</span><span class=w> </span><span class=s>&quot;soft&quot;</span>
<a id=__codelineno-15-85 name=__codelineno-15-85 href=#__codelineno-15-85></a><span class=c1># tolerations:</span>
<a id=__codelineno-15-86 name=__codelineno-15-86 href=#__codelineno-15-86></a><span class=c1>#   - operator: &quot;Exists&quot; ##容忍全部污点</span>
</code></pre></div> <p>然后创建用于 Data 节点安装的 values 文件：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=c1># values-data.yaml</span>
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=c1># ============设置集群名称============</span>
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=c1>## 设置集群名称</span>
<a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=nt>clusterName</span><span class=p>:</span><span class=w> </span><span class=s>&quot;elasticsearch&quot;</span>
<a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=c1>## 设置节点名称</span>
<a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=nt>nodeGroup</span><span class=p>:</span><span class=w> </span><span class=s>&quot;data&quot;</span>
<a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=c1>## 设置角色</span>
<a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=nt>roles</span><span class=p>:</span>
<a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=w>  </span><span class=nt>master</span><span class=p>:</span><span class=w> </span><span class=s>&quot;false&quot;</span>
<a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=w>  </span><span class=nt>ingest</span><span class=p>:</span><span class=w> </span><span class=s>&quot;true&quot;</span>
<a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=w>  </span><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class=s>&quot;true&quot;</span>
<a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a>
<a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a><span class=c1># ============镜像配置============</span>
<a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a><span class=c1>## 指定镜像与镜像版本</span>
<a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s>&quot;elasticsearch&quot;</span>
<a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a><span class=nt>imageTag</span><span class=p>:</span><span class=w> </span><span class=s>&quot;7.17.3&quot;</span>
<a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a><span class=c1>## 副本数(建议设置为3，我这里资源不足只用了1个副本)</span>
<a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a>
<a id=__codelineno-16-20 name=__codelineno-16-20 href=#__codelineno-16-20></a><span class=c1># ============资源配置============</span>
<a id=__codelineno-16-21 name=__codelineno-16-21 href=#__codelineno-16-21></a><span class=c1>## JVM 配置参数</span>
<a id=__codelineno-16-22 name=__codelineno-16-22 href=#__codelineno-16-22></a><span class=nt>esJavaOpts</span><span class=p>:</span><span class=w> </span><span class=s>&quot;-Xmx1g</span><span class=nv> </span><span class=s>-Xms1g&quot;</span>
<a id=__codelineno-16-23 name=__codelineno-16-23 href=#__codelineno-16-23></a><span class=c1>## 部署资源配置(生成环境一定要设置大些)</span>
<a id=__codelineno-16-24 name=__codelineno-16-24 href=#__codelineno-16-24></a><span class=nt>resources</span><span class=p>:</span>
<a id=__codelineno-16-25 name=__codelineno-16-25 href=#__codelineno-16-25></a><span class=w>  </span><span class=nt>requests</span><span class=p>:</span>
<a id=__codelineno-16-26 name=__codelineno-16-26 href=#__codelineno-16-26></a><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s>&quot;1000m&quot;</span>
<a id=__codelineno-16-27 name=__codelineno-16-27 href=#__codelineno-16-27></a><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s>&quot;2Gi&quot;</span>
<a id=__codelineno-16-28 name=__codelineno-16-28 href=#__codelineno-16-28></a><span class=w>  </span><span class=nt>limits</span><span class=p>:</span>
<a id=__codelineno-16-29 name=__codelineno-16-29 href=#__codelineno-16-29></a><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s>&quot;1000m&quot;</span>
<a id=__codelineno-16-30 name=__codelineno-16-30 href=#__codelineno-16-30></a><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s>&quot;2Gi&quot;</span>
<a id=__codelineno-16-31 name=__codelineno-16-31 href=#__codelineno-16-31></a><span class=c1>## 数据持久卷配置</span>
<a id=__codelineno-16-32 name=__codelineno-16-32 href=#__codelineno-16-32></a><span class=nt>persistence</span><span class=p>:</span>
<a id=__codelineno-16-33 name=__codelineno-16-33 href=#__codelineno-16-33></a><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-16-34 name=__codelineno-16-34 href=#__codelineno-16-34></a><span class=c1>## 存储数据大小配置</span>
<a id=__codelineno-16-35 name=__codelineno-16-35 href=#__codelineno-16-35></a><span class=nt>volumeClaimTemplate</span><span class=p>:</span>
<a id=__codelineno-16-36 name=__codelineno-16-36 href=#__codelineno-16-36></a><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">efk-nfs</span>
<a id=__codelineno-16-37 name=__codelineno-16-37 href=#__codelineno-16-37></a><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;ReadWriteOnce&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-16-38 name=__codelineno-16-38 href=#__codelineno-16-38></a><span class=w>  </span><span class=nt>resources</span><span class=p>:</span>
<a id=__codelineno-16-39 name=__codelineno-16-39 href=#__codelineno-16-39></a><span class=w>    </span><span class=nt>requests</span><span class=p>:</span>
<a id=__codelineno-16-40 name=__codelineno-16-40 href=#__codelineno-16-40></a><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">200Gi</span>
<a id=__codelineno-16-41 name=__codelineno-16-41 href=#__codelineno-16-41></a>
<a id=__codelineno-16-42 name=__codelineno-16-42 href=#__codelineno-16-42></a><span class=c1># ============安全配置============</span>
<a id=__codelineno-16-43 name=__codelineno-16-43 href=#__codelineno-16-43></a><span class=c1>## 设置协议，可配置为 http、https</span>
<a id=__codelineno-16-44 name=__codelineno-16-44 href=#__codelineno-16-44></a><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<a id=__codelineno-16-45 name=__codelineno-16-45 href=#__codelineno-16-45></a><span class=c1>## 证书挂载配置，这里我们挂入上面创建的证书</span>
<a id=__codelineno-16-46 name=__codelineno-16-46 href=#__codelineno-16-46></a><span class=nt>secretMounts</span><span class=p>:</span>
<a id=__codelineno-16-47 name=__codelineno-16-47 href=#__codelineno-16-47></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">elastic-certs</span>
<a id=__codelineno-16-48 name=__codelineno-16-48 href=#__codelineno-16-48></a><span class=w>    </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">elastic-certs</span>
<a id=__codelineno-16-49 name=__codelineno-16-49 href=#__codelineno-16-49></a><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/share/elasticsearch/config/certs</span>
<a id=__codelineno-16-50 name=__codelineno-16-50 href=#__codelineno-16-50></a><span class=c1>## 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml</span>
<a id=__codelineno-16-51 name=__codelineno-16-51 href=#__codelineno-16-51></a><span class=c1>## ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下</span>
<a id=__codelineno-16-52 name=__codelineno-16-52 href=#__codelineno-16-52></a><span class=c1>## 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https</span>
<a id=__codelineno-16-53 name=__codelineno-16-53 href=#__codelineno-16-53></a><span class=nt>esConfig</span><span class=p>:</span>
<a id=__codelineno-16-54 name=__codelineno-16-54 href=#__codelineno-16-54></a><span class=w>  </span><span class=nt>elasticsearch.yml</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span>
<a id=__codelineno-16-55 name=__codelineno-16-55 href=#__codelineno-16-55></a><span class=w>    </span><span class=no>xpack.security.enabled: true</span>
<a id=__codelineno-16-56 name=__codelineno-16-56 href=#__codelineno-16-56></a><span class=w>    </span><span class=no>xpack.security.transport.ssl.enabled: true</span>
<a id=__codelineno-16-57 name=__codelineno-16-57 href=#__codelineno-16-57></a><span class=w>    </span><span class=no>xpack.security.transport.ssl.verification_mode: certificate</span>
<a id=__codelineno-16-58 name=__codelineno-16-58 href=#__codelineno-16-58></a><span class=w>    </span><span class=no>xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
<a id=__codelineno-16-59 name=__codelineno-16-59 href=#__codelineno-16-59></a><span class=w>    </span><span class=no>xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
<a id=__codelineno-16-60 name=__codelineno-16-60 href=#__codelineno-16-60></a><span class=w>    </span><span class=no># xpack.security.http.ssl.enabled: true</span>
<a id=__codelineno-16-61 name=__codelineno-16-61 href=#__codelineno-16-61></a><span class=w>    </span><span class=no># xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
<a id=__codelineno-16-62 name=__codelineno-16-62 href=#__codelineno-16-62></a><span class=w>    </span><span class=no># xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
<a id=__codelineno-16-63 name=__codelineno-16-63 href=#__codelineno-16-63></a><span class=c1>## 环境变量配置，这里引入上面设置的用户名、密码 secret 文件</span>
<a id=__codelineno-16-64 name=__codelineno-16-64 href=#__codelineno-16-64></a><span class=nt>extraEnvs</span><span class=p>:</span>
<a id=__codelineno-16-65 name=__codelineno-16-65 href=#__codelineno-16-65></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ELASTIC_USERNAME</span>
<a id=__codelineno-16-66 name=__codelineno-16-66 href=#__codelineno-16-66></a><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span>
<a id=__codelineno-16-67 name=__codelineno-16-67 href=#__codelineno-16-67></a><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span>
<a id=__codelineno-16-68 name=__codelineno-16-68 href=#__codelineno-16-68></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">elastic-auth</span>
<a id=__codelineno-16-69 name=__codelineno-16-69 href=#__codelineno-16-69></a><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">username</span>
<a id=__codelineno-16-70 name=__codelineno-16-70 href=#__codelineno-16-70></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ELASTIC_PASSWORD</span>
<a id=__codelineno-16-71 name=__codelineno-16-71 href=#__codelineno-16-71></a><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span>
<a id=__codelineno-16-72 name=__codelineno-16-72 href=#__codelineno-16-72></a><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span>
<a id=__codelineno-16-73 name=__codelineno-16-73 href=#__codelineno-16-73></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">elastic-auth</span>
<a id=__codelineno-16-74 name=__codelineno-16-74 href=#__codelineno-16-74></a><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">password</span>
<a id=__codelineno-16-75 name=__codelineno-16-75 href=#__codelineno-16-75></a>
<a id=__codelineno-16-76 name=__codelineno-16-76 href=#__codelineno-16-76></a><span class=c1># ============调度配置============</span>
<a id=__codelineno-16-77 name=__codelineno-16-77 href=#__codelineno-16-77></a><span class=c1>## 设置调度策略</span>
<a id=__codelineno-16-78 name=__codelineno-16-78 href=#__codelineno-16-78></a><span class=c1>## - hard：只有当有足够的节点时 Pod 才会被调度，并且它们永远不会出现在同一个节点上</span>
<a id=__codelineno-16-79 name=__codelineno-16-79 href=#__codelineno-16-79></a><span class=c1>## - soft：尽最大努力调度</span>
<a id=__codelineno-16-80 name=__codelineno-16-80 href=#__codelineno-16-80></a><span class=nt>antiAffinity</span><span class=p>:</span><span class=w> </span><span class=s>&quot;soft&quot;</span>
<a id=__codelineno-16-81 name=__codelineno-16-81 href=#__codelineno-16-81></a><span class=c1>## 容忍配置</span>
<a id=__codelineno-16-82 name=__codelineno-16-82 href=#__codelineno-16-82></a><span class=c1># tolerations:</span>
<a id=__codelineno-16-83 name=__codelineno-16-83 href=#__codelineno-16-83></a><span class=c1>#   - operator: &quot;Exists&quot; ##容忍全部污点</span>
</code></pre></div> <p>最后一个是用于创建 Client 节点的 values 文件：</p> <p><code>values-client.yaml</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=c1># values-client.yaml</span>
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=c1># ============设置集群名称============</span>
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=c1>## 设置集群名称</span>
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=nt>clusterName</span><span class=p>:</span><span class=w> </span><span class=s>&quot;elasticsearch&quot;</span>
<a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=c1>## 设置节点名称</span>
<a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=nt>nodeGroup</span><span class=p>:</span><span class=w> </span><span class=s>&quot;client&quot;</span>
<a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=c1>## 设置角色</span>
<a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=nt>roles</span><span class=p>:</span>
<a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=w>  </span><span class=nt>master</span><span class=p>:</span><span class=w> </span><span class=s>&quot;false&quot;</span>
<a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a><span class=w>  </span><span class=nt>ingest</span><span class=p>:</span><span class=w> </span><span class=s>&quot;false&quot;</span>
<a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a><span class=w>  </span><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class=s>&quot;false&quot;</span>
<a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a>
<a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a><span class=c1># ============镜像配置============</span>
<a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a><span class=c1>## 指定镜像与镜像版本</span>
<a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s>&quot;elasticsearch&quot;</span>
<a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a><span class=nt>imageTag</span><span class=p>:</span><span class=w> </span><span class=s>&quot;7.17.3&quot;</span>
<a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a><span class=c1>## 副本数</span>
<a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id=__codelineno-17-19 name=__codelineno-17-19 href=#__codelineno-17-19></a>
<a id=__codelineno-17-20 name=__codelineno-17-20 href=#__codelineno-17-20></a><span class=c1># ============资源配置============</span>
<a id=__codelineno-17-21 name=__codelineno-17-21 href=#__codelineno-17-21></a><span class=c1>## JVM 配置参数</span>
<a id=__codelineno-17-22 name=__codelineno-17-22 href=#__codelineno-17-22></a><span class=nt>esJavaOpts</span><span class=p>:</span><span class=w> </span><span class=s>&quot;-Xmx1g</span><span class=nv> </span><span class=s>-Xms1g&quot;</span>
<a id=__codelineno-17-23 name=__codelineno-17-23 href=#__codelineno-17-23></a><span class=c1>## 部署资源配置(生成环境一定要设置大些)</span>
<a id=__codelineno-17-24 name=__codelineno-17-24 href=#__codelineno-17-24></a><span class=nt>resources</span><span class=p>:</span>
<a id=__codelineno-17-25 name=__codelineno-17-25 href=#__codelineno-17-25></a><span class=w>  </span><span class=nt>requests</span><span class=p>:</span>
<a id=__codelineno-17-26 name=__codelineno-17-26 href=#__codelineno-17-26></a><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s>&quot;1000m&quot;</span>
<a id=__codelineno-17-27 name=__codelineno-17-27 href=#__codelineno-17-27></a><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s>&quot;2Gi&quot;</span>
<a id=__codelineno-17-28 name=__codelineno-17-28 href=#__codelineno-17-28></a><span class=w>  </span><span class=nt>limits</span><span class=p>:</span>
<a id=__codelineno-17-29 name=__codelineno-17-29 href=#__codelineno-17-29></a><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s>&quot;1000m&quot;</span>
<a id=__codelineno-17-30 name=__codelineno-17-30 href=#__codelineno-17-30></a><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s>&quot;2Gi&quot;</span>
<a id=__codelineno-17-31 name=__codelineno-17-31 href=#__codelineno-17-31></a><span class=c1>## 数据持久卷配置</span>
<a id=__codelineno-17-32 name=__codelineno-17-32 href=#__codelineno-17-32></a><span class=nt>persistence</span><span class=p>:</span>
<a id=__codelineno-17-33 name=__codelineno-17-33 href=#__codelineno-17-33></a><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id=__codelineno-17-34 name=__codelineno-17-34 href=#__codelineno-17-34></a>
<a id=__codelineno-17-35 name=__codelineno-17-35 href=#__codelineno-17-35></a><span class=c1># ============安全配置============</span>
<a id=__codelineno-17-36 name=__codelineno-17-36 href=#__codelineno-17-36></a><span class=c1>## 设置协议，可配置为 http、https</span>
<a id=__codelineno-17-37 name=__codelineno-17-37 href=#__codelineno-17-37></a><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<a id=__codelineno-17-38 name=__codelineno-17-38 href=#__codelineno-17-38></a><span class=c1>## 证书挂载配置，这里我们挂入上面创建的证书</span>
<a id=__codelineno-17-39 name=__codelineno-17-39 href=#__codelineno-17-39></a><span class=nt>secretMounts</span><span class=p>:</span>
<a id=__codelineno-17-40 name=__codelineno-17-40 href=#__codelineno-17-40></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">elastic-certs</span>
<a id=__codelineno-17-41 name=__codelineno-17-41 href=#__codelineno-17-41></a><span class=w>    </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">elastic-certs</span>
<a id=__codelineno-17-42 name=__codelineno-17-42 href=#__codelineno-17-42></a><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/usr/share/elasticsearch/config/certs</span>
<a id=__codelineno-17-43 name=__codelineno-17-43 href=#__codelineno-17-43></a><span class=c1>## 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml</span>
<a id=__codelineno-17-44 name=__codelineno-17-44 href=#__codelineno-17-44></a><span class=c1>## ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下</span>
<a id=__codelineno-17-45 name=__codelineno-17-45 href=#__codelineno-17-45></a><span class=c1>## 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https</span>
<a id=__codelineno-17-46 name=__codelineno-17-46 href=#__codelineno-17-46></a><span class=nt>esConfig</span><span class=p>:</span>
<a id=__codelineno-17-47 name=__codelineno-17-47 href=#__codelineno-17-47></a><span class=w>  </span><span class=nt>elasticsearch.yml</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span>
<a id=__codelineno-17-48 name=__codelineno-17-48 href=#__codelineno-17-48></a><span class=w>    </span><span class=no>xpack.security.enabled: true</span>
<a id=__codelineno-17-49 name=__codelineno-17-49 href=#__codelineno-17-49></a><span class=w>    </span><span class=no>xpack.security.transport.ssl.enabled: true</span>
<a id=__codelineno-17-50 name=__codelineno-17-50 href=#__codelineno-17-50></a><span class=w>    </span><span class=no>xpack.security.transport.ssl.verification_mode: certificate</span>
<a id=__codelineno-17-51 name=__codelineno-17-51 href=#__codelineno-17-51></a><span class=w>    </span><span class=no>xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
<a id=__codelineno-17-52 name=__codelineno-17-52 href=#__codelineno-17-52></a><span class=w>    </span><span class=no>xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
<a id=__codelineno-17-53 name=__codelineno-17-53 href=#__codelineno-17-53></a><span class=w>    </span><span class=no># xpack.security.http.ssl.enabled: true</span>
<a id=__codelineno-17-54 name=__codelineno-17-54 href=#__codelineno-17-54></a><span class=w>    </span><span class=no># xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
<a id=__codelineno-17-55 name=__codelineno-17-55 href=#__codelineno-17-55></a><span class=w>    </span><span class=no># xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
<a id=__codelineno-17-56 name=__codelineno-17-56 href=#__codelineno-17-56></a><span class=c1>## 环境变量配置，这里引入上面设置的用户名、密码 secret 文件</span>
<a id=__codelineno-17-57 name=__codelineno-17-57 href=#__codelineno-17-57></a><span class=nt>extraEnvs</span><span class=p>:</span>
<a id=__codelineno-17-58 name=__codelineno-17-58 href=#__codelineno-17-58></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ELASTIC_USERNAME</span>
<a id=__codelineno-17-59 name=__codelineno-17-59 href=#__codelineno-17-59></a><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span>
<a id=__codelineno-17-60 name=__codelineno-17-60 href=#__codelineno-17-60></a><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span>
<a id=__codelineno-17-61 name=__codelineno-17-61 href=#__codelineno-17-61></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">elastic-auth</span>
<a id=__codelineno-17-62 name=__codelineno-17-62 href=#__codelineno-17-62></a><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">username</span>
<a id=__codelineno-17-63 name=__codelineno-17-63 href=#__codelineno-17-63></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ELASTIC_PASSWORD</span>
<a id=__codelineno-17-64 name=__codelineno-17-64 href=#__codelineno-17-64></a><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span>
<a id=__codelineno-17-65 name=__codelineno-17-65 href=#__codelineno-17-65></a><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span>
<a id=__codelineno-17-66 name=__codelineno-17-66 href=#__codelineno-17-66></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">elastic-auth</span>
<a id=__codelineno-17-67 name=__codelineno-17-67 href=#__codelineno-17-67></a><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">password</span>
<a id=__codelineno-17-68 name=__codelineno-17-68 href=#__codelineno-17-68></a>
<a id=__codelineno-17-69 name=__codelineno-17-69 href=#__codelineno-17-69></a><span class=c1># ============Service 配置============</span>
<a id=__codelineno-17-70 name=__codelineno-17-70 href=#__codelineno-17-70></a><span class=nt>service</span><span class=p>:</span>
<a id=__codelineno-17-71 name=__codelineno-17-71 href=#__codelineno-17-71></a><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
<a id=__codelineno-17-72 name=__codelineno-17-72 href=#__codelineno-17-72></a><span class=w>  </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=s>&quot;30200&quot;</span>
</code></pre></div> <p>现在用上面的 values 文件来安装：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=c1># 安装 master 节点</span>
<a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>$<span class=w> </span>helm<span class=w> </span>upgrade<span class=w> </span>--install<span class=w> </span>es-master<span class=w> </span>-f<span class=w> </span>values-master.yaml<span class=w> </span>--namespace<span class=w> </span>logging<span class=w> </span>.
<a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=c1># 安装 data 节点</span>
<a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a>$<span class=w> </span>helm<span class=w> </span>upgrade<span class=w> </span>--install<span class=w> </span>es-data<span class=w> </span>-f<span class=w> </span>values-data.yaml<span class=w> </span>--namespace<span class=w> </span>logging<span class=w> </span>.
<a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=c1># 安装 client 节点</span>
<a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a>$<span class=w> </span>helm<span class=w> </span>upgrade<span class=w> </span>--install<span class=w> </span>es-client<span class=w> </span>-f<span class=w> </span>values-client.yaml<span class=w> </span>--namespace<span class=w> </span>logging<span class=w> </span>.
</code></pre></div> <blockquote> <p>在安装 Master 节点后 Pod 启动时候会抛出异常，就绪探针探活失败，这是个正常现象。在执行安装 Data 节点后 Master 节点 Pod 就会恢复正常。</p> </blockquote> <h4 id=213-安装-kibana>2.1.3 安装 Kibana<a class=headerlink href=#213-安装-kibana title="Permanent link">&para;</a></h4> <p>Elasticsearch 集群安装完成后接下来配置安装 Kibana</p> <p>使用 helm pull 命令拉取 Kibana Chart 包并解压：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a>$<span class=w> </span>helm<span class=w> </span>pull<span class=w> </span>elastic/kibana<span class=w> </span>--untar<span class=w> </span>--version<span class=w> </span><span class=m>7</span>.17.3
<a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a>$<span class=w> </span><span class=nb>cd</span><span class=w> </span>kibana
</code></pre></div> <p>创建用于安装 Kibana 的 values 文件： <code>values-prod.yaml</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=c1># values-prod.yaml</span>
<a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=c1>## 指定镜像与镜像版本</span>
<a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s>&quot;kibana&quot;</span>
<a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=nt>imageTag</span><span class=p>:</span><span class=w> </span><span class=s>&quot;7.17.3&quot;</span>
<a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a>
<a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a><span class=c1>## 配置 ElasticSearch 地址</span>
<a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a><span class=nt>elasticsearchHosts</span><span class=p>:</span><span class=w> </span><span class=s>&quot;http://elasticsearch-client:9200&quot;</span>
<a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a>
<a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a><span class=c1># ============环境变量配置============</span>
<a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a><span class=c1>## 环境变量配置，这里引入上面设置的用户名、密码 secret 文件</span>
<a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a><span class=nt>extraEnvs</span><span class=p>:</span>
<a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;ELASTICSEARCH_USERNAME&quot;</span>
<a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span>
<a id=__codelineno-20-14 name=__codelineno-20-14 href=#__codelineno-20-14></a><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span>
<a id=__codelineno-20-15 name=__codelineno-20-15 href=#__codelineno-20-15></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">elastic-auth</span>
<a id=__codelineno-20-16 name=__codelineno-20-16 href=#__codelineno-20-16></a><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">username</span>
<a id=__codelineno-20-17 name=__codelineno-20-17 href=#__codelineno-20-17></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;ELASTICSEARCH_PASSWORD&quot;</span>
<a id=__codelineno-20-18 name=__codelineno-20-18 href=#__codelineno-20-18></a><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span>
<a id=__codelineno-20-19 name=__codelineno-20-19 href=#__codelineno-20-19></a><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span>
<a id=__codelineno-20-20 name=__codelineno-20-20 href=#__codelineno-20-20></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">elastic-auth</span>
<a id=__codelineno-20-21 name=__codelineno-20-21 href=#__codelineno-20-21></a><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">password</span>
<a id=__codelineno-20-22 name=__codelineno-20-22 href=#__codelineno-20-22></a>
<a id=__codelineno-20-23 name=__codelineno-20-23 href=#__codelineno-20-23></a><span class=c1># ============资源配置============</span>
<a id=__codelineno-20-24 name=__codelineno-20-24 href=#__codelineno-20-24></a><span class=nt>resources</span><span class=p>:</span>
<a id=__codelineno-20-25 name=__codelineno-20-25 href=#__codelineno-20-25></a><span class=w>  </span><span class=nt>requests</span><span class=p>:</span>
<a id=__codelineno-20-26 name=__codelineno-20-26 href=#__codelineno-20-26></a><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s>&quot;500m&quot;</span>
<a id=__codelineno-20-27 name=__codelineno-20-27 href=#__codelineno-20-27></a><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s>&quot;1Gi&quot;</span>
<a id=__codelineno-20-28 name=__codelineno-20-28 href=#__codelineno-20-28></a><span class=w>  </span><span class=nt>limits</span><span class=p>:</span>
<a id=__codelineno-20-29 name=__codelineno-20-29 href=#__codelineno-20-29></a><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s>&quot;500m&quot;</span>
<a id=__codelineno-20-30 name=__codelineno-20-30 href=#__codelineno-20-30></a><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s>&quot;1Gi&quot;</span>
<a id=__codelineno-20-31 name=__codelineno-20-31 href=#__codelineno-20-31></a>
<a id=__codelineno-20-32 name=__codelineno-20-32 href=#__codelineno-20-32></a><span class=c1># ============配置 Kibana 参数============</span>
<a id=__codelineno-20-33 name=__codelineno-20-33 href=#__codelineno-20-33></a><span class=c1>## kibana 配置中添加语言配置，设置 kibana 为中文</span>
<a id=__codelineno-20-34 name=__codelineno-20-34 href=#__codelineno-20-34></a><span class=nt>kibanaConfig</span><span class=p>:</span>
<a id=__codelineno-20-35 name=__codelineno-20-35 href=#__codelineno-20-35></a><span class=w>  </span><span class=nt>kibana.yml</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span>
<a id=__codelineno-20-36 name=__codelineno-20-36 href=#__codelineno-20-36></a><span class=w>    </span><span class=no>i18n.locale: &quot;zh-CN&quot;</span>
<a id=__codelineno-20-37 name=__codelineno-20-37 href=#__codelineno-20-37></a>
<a id=__codelineno-20-38 name=__codelineno-20-38 href=#__codelineno-20-38></a><span class=c1># ============Service 配置============</span>
<a id=__codelineno-20-39 name=__codelineno-20-39 href=#__codelineno-20-39></a><span class=nt>service</span><span class=p>:</span>
<a id=__codelineno-20-40 name=__codelineno-20-40 href=#__codelineno-20-40></a><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
<a id=__codelineno-20-41 name=__codelineno-20-41 href=#__codelineno-20-41></a><span class=w>  </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=s>&quot;30601&quot;</span>
</code></pre></div> <p>使用上面的配置直接安装即可：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a>$<span class=w> </span>helm<span class=w> </span>install<span class=w> </span>kibana<span class=w> </span>-f<span class=w> </span>values-prod.yaml<span class=w> </span>--namespace<span class=w> </span>logging<span class=w> </span>.
</code></pre></div> <p>下面是安装完成后的 ES 集群和 Kibana 资源：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>logging
<a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a>NAME<span class=w>                            </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>   </span>AGE
<a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a>elasticsearch-client-0<span class=w>          </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>12m
<a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a>elasticsearch-data-0<span class=w>            </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>12m
<a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a>elasticsearch-data-1<span class=w>            </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>12m
<a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a>elasticsearch-data-2<span class=w>            </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>12m
<a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a>elasticsearch-master-0<span class=w>          </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>13m
<a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a>elasticsearch-master-1<span class=w>          </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>13m
<a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a>elasticsearch-master-2<span class=w>          </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>13m
<a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a>kibana-kibana-f76c9758d-9ndrn<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>5m34s
<a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a>
<a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a>
<a id=__codelineno-22-13 name=__codelineno-22-13 href=#__codelineno-22-13></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>svc<span class=w> </span>-n<span class=w> </span>logging
<a id=__codelineno-22-14 name=__codelineno-22-14 href=#__codelineno-22-14></a>NAME<span class=w>                            </span>TYPE<span class=w>        </span>CLUSTER-IP<span class=w>       </span>EXTERNAL-IP<span class=w>   </span>PORT<span class=o>(</span>S<span class=o>)</span><span class=w>                         </span>AGE
<a id=__codelineno-22-15 name=__codelineno-22-15 href=#__codelineno-22-15></a>elasticsearch-client<span class=w>            </span>NodePort<span class=w>    </span><span class=m>172</span>.16.131.20<span class=w>    </span>&lt;none&gt;<span class=w>        </span><span class=m>9200</span>:30200/TCP,9300:31868/TCP<span class=w>   </span>10m
<a id=__codelineno-22-16 name=__codelineno-22-16 href=#__codelineno-22-16></a>elasticsearch-client-headless<span class=w>   </span>ClusterIP<span class=w>   </span>None<span class=w>             </span>&lt;none&gt;<span class=w>        </span><span class=m>9200</span>/TCP,9300/TCP<span class=w>               </span>10m
<a id=__codelineno-22-17 name=__codelineno-22-17 href=#__codelineno-22-17></a>elasticsearch-data<span class=w>              </span>ClusterIP<span class=w>   </span><span class=m>172</span>.16.180.25<span class=w>    </span>&lt;none&gt;<span class=w>        </span><span class=m>9200</span>/TCP,9300/TCP<span class=w>               </span>10m
<a id=__codelineno-22-18 name=__codelineno-22-18 href=#__codelineno-22-18></a>elasticsearch-data-headless<span class=w>     </span>ClusterIP<span class=w>   </span>None<span class=w>             </span>&lt;none&gt;<span class=w>        </span><span class=m>9200</span>/TCP,9300/TCP<span class=w>               </span>10m
<a id=__codelineno-22-19 name=__codelineno-22-19 href=#__codelineno-22-19></a>elasticsearch-master<span class=w>            </span>ClusterIP<span class=w>   </span><span class=m>172</span>.16.182.14<span class=w>    </span>&lt;none&gt;<span class=w>        </span><span class=m>9200</span>/TCP,9300/TCP<span class=w>               </span>10m
<a id=__codelineno-22-20 name=__codelineno-22-20 href=#__codelineno-22-20></a>elasticsearch-master-headless<span class=w>   </span>ClusterIP<span class=w>   </span>None<span class=w>             </span>&lt;none&gt;<span class=w>        </span><span class=m>9200</span>/TCP,9300/TCP<span class=w>               </span>10m
<a id=__codelineno-22-21 name=__codelineno-22-21 href=#__codelineno-22-21></a>kibana-kibana<span class=w>                   </span>NodePort<span class=w>    </span><span class=m>172</span>.16.244.211<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>5601</span>:30601/TCP<span class=w>                  </span>2m4s
</code></pre></div> <p>上面我们安装 Kibana 的时候指定了 30601 的 NodePort 端口，所以我们可以从任意节点 <a href=http://IP:30601>http://IP:30601</a> 来访问 Kibana。</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/5/elastic-01.png> 我们可以看到会跳转到登录页面，让我们输出用户名、密码，这里我们输入上面配置的用户名 elastic、密码 oschina进行登录。</p> <p>登录成功后点击自己浏览，进入如下所示的 Kibana 主页： <img alt class=zoom src=../../../assets/static/kubernetes/5/elastic-02.png></p> <h3 id=22-部署-fluentd>2.2 部署 Fluentd<a class=headerlink href=#22-部署-fluentd title="Permanent link">&para;</a></h3> <p>Fluentd 是一个高效的日志聚合器，是用 Ruby 编写的，并且可以很好地扩展。 对于大部分企业来说，Fluentd 足够高效并且消耗的资源相对较少，另外一个工具 Fluent-bit 更轻量级，占用资源更少， 但是插件相对 Fluentd 来说不够丰富，所以整体来说，Fluentd 更加成熟，使用更加广泛，所以这里我们使用 Fluentd 来作为日志收集工具。</p> <h4 id=221-工作原理>2.2.1 工作原理<a class=headerlink href=#221-工作原理 title="Permanent link">&para;</a></h4> <p>Fluentd 通过一组给定的数据源抓取日志数据，处理后（转换成结构化的数据格式）将它们转发给其他服务，比如 Elasticsearch、对象存储等等。Fluentd 支持超过 300 个日志存储和分析服务，所以在这方面是非常灵活的。主要运行步骤如下：</p> <ul> <li>首先 Fluentd 从多个日志源获取数据 </li> <li>结构化并且标记这些数据 </li> <li>然后根据匹配的标签将数据发送到多个目标服务去</li> </ul> <p><img alt class=zoom src=../../../assets/static/kubernetes/5/fluentd-01.png></p> <h4 id=222-配置>2.2.2 配置<a class=headerlink href=#222-配置 title="Permanent link">&para;</a></h4> <p>一般来说我们是通过一个配置文件来告诉 Fluentd 如何采集、处理数据的，下面简单和大家介绍下 Fluentd 的配置方法。</p> <p><strong>日志源配置</strong> 比如我们这里为了收集 Kubernetes 节点上的所有容器日志，就需要做如下的日志源配置： <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class="l l-Scalar l-Scalar-Plain">&lt;source&gt;</span>
<a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">@id fluentd-containers.log</span>
<a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">@type tail</span><span class=w>                             </span><span class=c1># Fluentd 内置的输入方式，其原理是不停地从源文件中获取新的日志。</span>
<a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">path /var/log/containers/*.log</span><span class=w>         </span><span class=c1># 挂载的宿主机容器日志地址</span>
<a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">pos_file /var/log/es-containers.log.pos</span>
<a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">tag raw.kubernetes.*</span><span class=w>                   </span><span class=c1># 设置日志标签</span>
<a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">read_from_head true</span>
<a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">&lt;parse&gt;</span><span class=w>                                </span><span class=c1># 多行格式化成JSON</span>
<a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a><span class=w>    </span><span class=err>@</span><span class="l l-Scalar l-Scalar-Plain">type multi_format</span><span class=w>                   </span><span class=c1># 使用 multi-format-parser 解析器插件</span>
<a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">&lt;pattern&gt;</span>
<a id=__codelineno-23-11 name=__codelineno-23-11 href=#__codelineno-23-11></a><span class=w>      </span><span class="l l-Scalar l-Scalar-Plain">format json</span><span class=w>                        </span><span class=c1># JSON 解析器</span>
<a id=__codelineno-23-12 name=__codelineno-23-12 href=#__codelineno-23-12></a><span class=w>      </span><span class="l l-Scalar l-Scalar-Plain">time_key time</span><span class=w>                      </span><span class=c1># 指定事件时间的时间字段</span>
<a id=__codelineno-23-13 name=__codelineno-23-13 href=#__codelineno-23-13></a><span class=w>      </span><span class="l l-Scalar l-Scalar-Plain">time_format %Y-%m-%dT%H:%M:%S.%NZ</span><span class=w>  </span><span class=c1># 时间格式</span>
<a id=__codelineno-23-14 name=__codelineno-23-14 href=#__codelineno-23-14></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">&lt;/pattern&gt;</span>
<a id=__codelineno-23-15 name=__codelineno-23-15 href=#__codelineno-23-15></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">&lt;pattern&gt;</span>
<a id=__codelineno-23-16 name=__codelineno-23-16 href=#__codelineno-23-16></a><span class=w>      </span><span class="l l-Scalar l-Scalar-Plain">format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/</span>
<a id=__codelineno-23-17 name=__codelineno-23-17 href=#__codelineno-23-17></a><span class=w>      </span><span class="l l-Scalar l-Scalar-Plain">time_format %Y-%m-%dT%H:%M:%S.%N%:z</span>
<a id=__codelineno-23-18 name=__codelineno-23-18 href=#__codelineno-23-18></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">&lt;/pattern&gt;</span>
<a id=__codelineno-23-19 name=__codelineno-23-19 href=#__codelineno-23-19></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">&lt;/parse&gt;</span>
<a id=__codelineno-23-20 name=__codelineno-23-20 href=#__codelineno-23-20></a><span class="l l-Scalar l-Scalar-Plain">&lt;/source&gt;</span>
</code></pre></div></p> <p>上面配置部分参数说明如下：</p> <ul> <li>id：表示引用该日志源的唯一标识符，该标识可用于进一步过滤和路由结构化日志数据 </li> <li>type：Fluentd 内置的指令，tail 表示 Fluentd 从上次读取的位置通过 tail 不断获取数据，另外一个是 http 表示通过一个 GET 请求来收集数据。 </li> <li>path：tail 类型下的特定参数，告诉 Fluentd 采集 /var/log/containers 目录下的所有日志，这是 docker 在 Kubernetes 节点上用来存储运行容器 stdout 输出日志数据的目录。 </li> <li>pos_file：检查点，如果 Fluentd 程序重新启动了，它将使用此文件中的位置来恢复日志数据收集。 </li> <li>tag：用来将日志源与目标或者过滤器匹配的自定义字符串，Fluentd 匹配源/目标标签来路由日志数据。</li> </ul> <p><strong>路由配置</strong></p> <p>上面是日志源的配置，接下来看看如何将日志数据发送到 Elasticsearch：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class="l l-Scalar l-Scalar-Plain">&lt;match **&gt;</span>
<a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">@id elasticsearch</span>
<a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">@type elasticsearch</span>
<a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">@log_level info</span>
<a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">include_tag_key true</span>
<a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">type_name fluentd</span>
<a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">host &quot;#{ENV[&#39;OUTPUT_HOST&#39;]}&quot;</span>
<a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">port &quot;#{ENV[&#39;OUTPUT_PORT&#39;]}&quot;</span>
<a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">logstash_format true</span>
<a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">&lt;buffer&gt;</span>
<a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">@type file</span>
<a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">path /var/log/fluentd-buffers/kubernetes.system.buffer</span>
<a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">flush_mode interval</span>
<a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">retry_type exponential_backoff</span>
<a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">flush_thread_count 2</span>
<a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">flush_interval 5s</span>
<a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">retry_forever</span>
<a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">retry_max_interval 30</span>
<a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">chunk_limit_size &quot;#{ENV[&#39;OUTPUT_BUFFER_CHUNK_LIMIT&#39;]}&quot;</span>
<a id=__codelineno-24-20 name=__codelineno-24-20 href=#__codelineno-24-20></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">queue_limit_length &quot;#{ENV[&#39;OUTPUT_BUFFER_QUEUE_LIMIT&#39;]}&quot;</span>
<a id=__codelineno-24-21 name=__codelineno-24-21 href=#__codelineno-24-21></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">overflow_action block</span>
<a id=__codelineno-24-22 name=__codelineno-24-22 href=#__codelineno-24-22></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">&lt;/buffer&gt;</span>
<a id=__codelineno-24-23 name=__codelineno-24-23 href=#__codelineno-24-23></a><span class="l l-Scalar l-Scalar-Plain">&lt;/match&gt;</span>
</code></pre></div> <ul> <li>match：标识一个目标标签，后面是一个匹配日志源的正则表达式，我们这里想要捕获所有的日志并将它们发送给 Elasticsearch，所以需要配置成**。 </li> <li>id：目标的一个唯一标识符。 </li> <li>type：支持的输出插件标识符，我们这里要输出到 Elasticsearch，所以配置成 elasticsearch，这是 Fluentd 的一个内置插件。 </li> <li>log_level：指定要捕获的日志级别，我们这里配置成 info，表示任何该级别或者该级别以上（INFO、WARNING、ERROR）的日志都将被路由到 Elsasticsearch。 </li> <li>host/port：定义 Elasticsearch 的地址，也可以配置认证信息，我们的 Elasticsearch 不需要认证，所以这里直接指定 host 和 port 即可。 </li> <li>logstash_format：Elasticsearch 服务对日志数据构建反向索引进行搜索，将 logstash_format 设置为 true，Fluentd 将会以 logstash 格式来转发结构化的日志数据。 </li> <li>Buffer： Fluentd 允许在目标不可用时进行缓存，比如，如果网络出现故障或者 Elasticsearch 不可用的时候。缓冲区配置也有助于降低磁盘的 IO。</li> </ul> <p><strong>过滤</strong> 由于 Kubernetes 集群中应用太多，也还有很多历史数据，所以我们可以只将某些应用的日志进行收集，比如我们只采集具有 logging=true 这个 Label 标签的 Pod 日志，这个时候就需要使用 filter，如下所示：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=c1># 删除无用的属性</span>
<a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class="l l-Scalar l-Scalar-Plain">&lt;filter kubernetes.**&gt;</span>
<a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">@type record_transformer</span>
<a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash</span>
<a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class="l l-Scalar l-Scalar-Plain">&lt;/filter&gt;</span>
<a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class="l l-Scalar l-Scalar-Plain"># 只保留具有logging=true标签的Pod日志</span>
<a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class="l l-Scalar l-Scalar-Plain">&lt;filter kubernetes.**&gt;</span>
<a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">@id filter_log</span>
<a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">@type grep</span>
<a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">&lt;regexp&gt;</span>
<a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">key $.kubernetes.labels.logging</span>
<a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">pattern ^true$</span>
<a id=__codelineno-25-13 name=__codelineno-25-13 href=#__codelineno-25-13></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">&lt;/regexp&gt;</span>
<a id=__codelineno-25-14 name=__codelineno-25-14 href=#__codelineno-25-14></a><span class="l l-Scalar l-Scalar-Plain">&lt;/filter&gt;</span>
</code></pre></div> <h4 id=223-安装>2.2.3 安装<a class=headerlink href=#223-安装 title="Permanent link">&para;</a></h4> <p>要收集 Kubernetes 集群的日志，直接用 DasemonSet 控制器来部署 Fluentd 应用，这样，它就可以从 Kubernetes 节点上采集日志，确保在集群中的每个节点上始终运行一个 Fluentd 容器。 当然可以直接使用 Helm 来进行一键安装，为了能够了解更多实现细节，我们这里还是采用手动方法来进行安装。</p> <blockquote> <p>可以直接使用官方的对于 Kubernetes 集群的安装文档: <a href=https://docs.fluentd.org/container-deployment/kubernetes>https://docs.fluentd.org/container-deployment/kubernetes</a>。</p> </blockquote> <p>首先，我们通过 ConfigMap 对象来指定 Fluentd 配置文件，新建 fluentd-configmap.yaml 文件，文件内容如下： <code>fluentd-configmap.yaml</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-conf</span>
<a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">logging</span>
<a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=nt>data</span><span class=p>:</span>
<a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=w>  </span><span class=c1># 容器日志</span>
<a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=w>  </span><span class=nt>containers.input.conf</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|-</span>
<a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=w>    </span><span class=no>&lt;source&gt;</span>
<a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a><span class=w>      </span><span class=no>@id fluentd-containers.log</span>
<a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=w>      </span><span class=no>@type tail</span>
<a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a><span class=w>      </span><span class=no>path /var/log/containers/*.log</span>
<a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a><span class=w>      </span><span class=no>pos_file /var/log/es-containers.log.pos</span>
<a id=__codelineno-26-14 name=__codelineno-26-14 href=#__codelineno-26-14></a><span class=w>      </span><span class=no>tag raw.kubernetes.*</span>
<a id=__codelineno-26-15 name=__codelineno-26-15 href=#__codelineno-26-15></a><span class=w>      </span><span class=no>read_from_head true</span>
<a id=__codelineno-26-16 name=__codelineno-26-16 href=#__codelineno-26-16></a><span class=w>      </span><span class=no>&lt;parse&gt;</span>
<a id=__codelineno-26-17 name=__codelineno-26-17 href=#__codelineno-26-17></a><span class=w>        </span><span class=no>@type multi_format</span>
<a id=__codelineno-26-18 name=__codelineno-26-18 href=#__codelineno-26-18></a><span class=w>        </span><span class=no>&lt;pattern&gt;</span>
<a id=__codelineno-26-19 name=__codelineno-26-19 href=#__codelineno-26-19></a><span class=w>          </span><span class=no>format json</span>
<a id=__codelineno-26-20 name=__codelineno-26-20 href=#__codelineno-26-20></a><span class=w>          </span><span class=no>time_key time</span>
<a id=__codelineno-26-21 name=__codelineno-26-21 href=#__codelineno-26-21></a><span class=w>          </span><span class=no>time_format %Y-%m-%dT%H:%M:%S.%NZ</span>
<a id=__codelineno-26-22 name=__codelineno-26-22 href=#__codelineno-26-22></a><span class=w>        </span><span class=no>&lt;/pattern&gt;</span>
<a id=__codelineno-26-23 name=__codelineno-26-23 href=#__codelineno-26-23></a><span class=w>        </span><span class=no>&lt;pattern&gt;</span>
<a id=__codelineno-26-24 name=__codelineno-26-24 href=#__codelineno-26-24></a><span class=w>          </span><span class=no>format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/</span>
<a id=__codelineno-26-25 name=__codelineno-26-25 href=#__codelineno-26-25></a><span class=w>          </span><span class=no>time_format %Y-%m-%dT%H:%M:%S.%N%:z</span>
<a id=__codelineno-26-26 name=__codelineno-26-26 href=#__codelineno-26-26></a><span class=w>        </span><span class=no>&lt;/pattern&gt;</span>
<a id=__codelineno-26-27 name=__codelineno-26-27 href=#__codelineno-26-27></a><span class=w>      </span><span class=no>&lt;/parse&gt;</span>
<a id=__codelineno-26-28 name=__codelineno-26-28 href=#__codelineno-26-28></a><span class=w>    </span><span class=no>&lt;/source&gt;</span>
<a id=__codelineno-26-29 name=__codelineno-26-29 href=#__codelineno-26-29></a>
<a id=__codelineno-26-30 name=__codelineno-26-30 href=#__codelineno-26-30></a><span class=w>    </span><span class=no># 在日志输出中检测异常(多行日志)，并将其作为一条日志转发</span>
<a id=__codelineno-26-31 name=__codelineno-26-31 href=#__codelineno-26-31></a><span class=w>    </span><span class=no># https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions</span>
<a id=__codelineno-26-32 name=__codelineno-26-32 href=#__codelineno-26-32></a><span class=w>    </span><span class=no>&lt;match raw.kubernetes.**&gt;</span>
<a id=__codelineno-26-33 name=__codelineno-26-33 href=#__codelineno-26-33></a><span class=w>      </span><span class=no>@id raw.kubernetes</span>
<a id=__codelineno-26-34 name=__codelineno-26-34 href=#__codelineno-26-34></a><span class=w>      </span><span class=no>@type detect_exceptions</span>
<a id=__codelineno-26-35 name=__codelineno-26-35 href=#__codelineno-26-35></a><span class=w>      </span><span class=no>remove_tag_prefix raw</span>
<a id=__codelineno-26-36 name=__codelineno-26-36 href=#__codelineno-26-36></a><span class=w>      </span><span class=no>message log</span>
<a id=__codelineno-26-37 name=__codelineno-26-37 href=#__codelineno-26-37></a><span class=w>      </span><span class=no>multiline_flush_interval 5</span>
<a id=__codelineno-26-38 name=__codelineno-26-38 href=#__codelineno-26-38></a><span class=w>    </span><span class=no>&lt;/match&gt;</span>
<a id=__codelineno-26-39 name=__codelineno-26-39 href=#__codelineno-26-39></a>
<a id=__codelineno-26-40 name=__codelineno-26-40 href=#__codelineno-26-40></a><span class=w>    </span><span class=no>&lt;filter **&gt;</span>
<a id=__codelineno-26-41 name=__codelineno-26-41 href=#__codelineno-26-41></a><span class=w>      </span><span class=no>@id filter_concat</span>
<a id=__codelineno-26-42 name=__codelineno-26-42 href=#__codelineno-26-42></a><span class=w>      </span><span class=no>@type concat</span>
<a id=__codelineno-26-43 name=__codelineno-26-43 href=#__codelineno-26-43></a><span class=w>      </span><span class=no>key message</span>
<a id=__codelineno-26-44 name=__codelineno-26-44 href=#__codelineno-26-44></a><span class=w>      </span><span class=no>multiline_end_regexp /\n$/</span>
<a id=__codelineno-26-45 name=__codelineno-26-45 href=#__codelineno-26-45></a><span class=w>      </span><span class=no>separator &quot;&quot;</span>
<a id=__codelineno-26-46 name=__codelineno-26-46 href=#__codelineno-26-46></a><span class=w>    </span><span class=no>&lt;/filter&gt;</span>
<a id=__codelineno-26-47 name=__codelineno-26-47 href=#__codelineno-26-47></a>
<a id=__codelineno-26-48 name=__codelineno-26-48 href=#__codelineno-26-48></a><span class=w>    </span><span class=no># 添加 Kubernetes metadata 数据</span>
<a id=__codelineno-26-49 name=__codelineno-26-49 href=#__codelineno-26-49></a><span class=w>    </span><span class=no>&lt;filter kubernetes.**&gt;</span>
<a id=__codelineno-26-50 name=__codelineno-26-50 href=#__codelineno-26-50></a><span class=w>      </span><span class=no>@id filter_kubernetes_metadata</span>
<a id=__codelineno-26-51 name=__codelineno-26-51 href=#__codelineno-26-51></a><span class=w>      </span><span class=no>@type kubernetes_metadata</span>
<a id=__codelineno-26-52 name=__codelineno-26-52 href=#__codelineno-26-52></a><span class=w>    </span><span class=no>&lt;/filter&gt;</span>
<a id=__codelineno-26-53 name=__codelineno-26-53 href=#__codelineno-26-53></a>
<a id=__codelineno-26-54 name=__codelineno-26-54 href=#__codelineno-26-54></a><span class=w>    </span><span class=no># 修复 ES 中的 JSON 字段</span>
<a id=__codelineno-26-55 name=__codelineno-26-55 href=#__codelineno-26-55></a><span class=w>    </span><span class=no># 插件地址：https://github.com/repeatedly/fluent-plugin-multi-format-parser</span>
<a id=__codelineno-26-56 name=__codelineno-26-56 href=#__codelineno-26-56></a><span class=w>    </span><span class=no>&lt;filter kubernetes.**&gt;</span>
<a id=__codelineno-26-57 name=__codelineno-26-57 href=#__codelineno-26-57></a><span class=w>      </span><span class=no>@id filter_parser</span>
<a id=__codelineno-26-58 name=__codelineno-26-58 href=#__codelineno-26-58></a><span class=w>      </span><span class=no>@type parser</span>
<a id=__codelineno-26-59 name=__codelineno-26-59 href=#__codelineno-26-59></a><span class=w>      </span><span class=no>key_name log</span>
<a id=__codelineno-26-60 name=__codelineno-26-60 href=#__codelineno-26-60></a><span class=w>      </span><span class=no>reserve_data true</span>
<a id=__codelineno-26-61 name=__codelineno-26-61 href=#__codelineno-26-61></a><span class=w>      </span><span class=no>remove_key_name_field true</span>
<a id=__codelineno-26-62 name=__codelineno-26-62 href=#__codelineno-26-62></a><span class=w>      </span><span class=no>&lt;parse&gt;</span>
<a id=__codelineno-26-63 name=__codelineno-26-63 href=#__codelineno-26-63></a><span class=w>        </span><span class=no>@type multi_format</span>
<a id=__codelineno-26-64 name=__codelineno-26-64 href=#__codelineno-26-64></a><span class=w>        </span><span class=no>&lt;pattern&gt;</span>
<a id=__codelineno-26-65 name=__codelineno-26-65 href=#__codelineno-26-65></a><span class=w>          </span><span class=no>format json</span>
<a id=__codelineno-26-66 name=__codelineno-26-66 href=#__codelineno-26-66></a><span class=w>        </span><span class=no>&lt;/pattern&gt;</span>
<a id=__codelineno-26-67 name=__codelineno-26-67 href=#__codelineno-26-67></a><span class=w>        </span><span class=no>&lt;pattern&gt;</span>
<a id=__codelineno-26-68 name=__codelineno-26-68 href=#__codelineno-26-68></a><span class=w>          </span><span class=no>format none</span>
<a id=__codelineno-26-69 name=__codelineno-26-69 href=#__codelineno-26-69></a><span class=w>        </span><span class=no>&lt;/pattern&gt;</span>
<a id=__codelineno-26-70 name=__codelineno-26-70 href=#__codelineno-26-70></a><span class=w>      </span><span class=no>&lt;/parse&gt;</span>
<a id=__codelineno-26-71 name=__codelineno-26-71 href=#__codelineno-26-71></a><span class=w>    </span><span class=no>&lt;/filter&gt;</span>
<a id=__codelineno-26-72 name=__codelineno-26-72 href=#__codelineno-26-72></a>
<a id=__codelineno-26-73 name=__codelineno-26-73 href=#__codelineno-26-73></a><span class=w>    </span><span class=no># 删除一些多余的属性</span>
<a id=__codelineno-26-74 name=__codelineno-26-74 href=#__codelineno-26-74></a><span class=w>    </span><span class=no>&lt;filter kubernetes.**&gt;</span>
<a id=__codelineno-26-75 name=__codelineno-26-75 href=#__codelineno-26-75></a><span class=w>      </span><span class=no>@type record_transformer</span>
<a id=__codelineno-26-76 name=__codelineno-26-76 href=#__codelineno-26-76></a><span class=w>      </span><span class=no>remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash</span>
<a id=__codelineno-26-77 name=__codelineno-26-77 href=#__codelineno-26-77></a><span class=w>    </span><span class=no>&lt;/filter&gt;</span>
<a id=__codelineno-26-78 name=__codelineno-26-78 href=#__codelineno-26-78></a>
<a id=__codelineno-26-79 name=__codelineno-26-79 href=#__codelineno-26-79></a><span class=c1>##   我注释掉这里的用意就是所有pod的日志都进行采集</span>
<a id=__codelineno-26-80 name=__codelineno-26-80 href=#__codelineno-26-80></a><span class=c1>#    ##只保留具有logging=true标签的Pod日志</span>
<a id=__codelineno-26-81 name=__codelineno-26-81 href=#__codelineno-26-81></a><span class=c1>#    &lt;filter kubernetes.**&gt;</span>
<a id=__codelineno-26-82 name=__codelineno-26-82 href=#__codelineno-26-82></a><span class=c1>#      @id filter_log</span>
<a id=__codelineno-26-83 name=__codelineno-26-83 href=#__codelineno-26-83></a><span class=c1>#      @type grep</span>
<a id=__codelineno-26-84 name=__codelineno-26-84 href=#__codelineno-26-84></a><span class=c1>#      &lt;regexp&gt;</span>
<a id=__codelineno-26-85 name=__codelineno-26-85 href=#__codelineno-26-85></a><span class=c1>#        key $.kubernetes.labels.logging</span>
<a id=__codelineno-26-86 name=__codelineno-26-86 href=#__codelineno-26-86></a><span class=c1>#        pattern ^true$</span>
<a id=__codelineno-26-87 name=__codelineno-26-87 href=#__codelineno-26-87></a><span class=c1>#      &lt;/regexp&gt;</span>
<a id=__codelineno-26-88 name=__codelineno-26-88 href=#__codelineno-26-88></a><span class=c1>#    &lt;/filter&gt;</span>
<a id=__codelineno-26-89 name=__codelineno-26-89 href=#__codelineno-26-89></a>
<a id=__codelineno-26-90 name=__codelineno-26-90 href=#__codelineno-26-90></a><span class=w>  </span><span class=c1>###### 监听配置，一般用于日志聚合用 ######</span>
<a id=__codelineno-26-91 name=__codelineno-26-91 href=#__codelineno-26-91></a><span class=w>  </span><span class=nt>forward.input.conf</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|-</span>
<a id=__codelineno-26-92 name=__codelineno-26-92 href=#__codelineno-26-92></a><span class=w>    </span><span class=no># 监听通过TCP发送的消息</span>
<a id=__codelineno-26-93 name=__codelineno-26-93 href=#__codelineno-26-93></a><span class=w>    </span><span class=no>&lt;source&gt;</span>
<a id=__codelineno-26-94 name=__codelineno-26-94 href=#__codelineno-26-94></a><span class=w>      </span><span class=no>@id forward</span>
<a id=__codelineno-26-95 name=__codelineno-26-95 href=#__codelineno-26-95></a><span class=w>      </span><span class=no>@type forward</span>
<a id=__codelineno-26-96 name=__codelineno-26-96 href=#__codelineno-26-96></a><span class=w>    </span><span class=no>&lt;/source&gt;</span>
<a id=__codelineno-26-97 name=__codelineno-26-97 href=#__codelineno-26-97></a>
<a id=__codelineno-26-98 name=__codelineno-26-98 href=#__codelineno-26-98></a><span class=w>  </span><span class=nt>output.conf</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|-</span>
<a id=__codelineno-26-99 name=__codelineno-26-99 href=#__codelineno-26-99></a><span class=w>    </span><span class=no>&lt;match **&gt;</span>
<a id=__codelineno-26-100 name=__codelineno-26-100 href=#__codelineno-26-100></a><span class=w>      </span><span class=no>@id elasticsearch</span>
<a id=__codelineno-26-101 name=__codelineno-26-101 href=#__codelineno-26-101></a><span class=w>      </span><span class=no>@type elasticsearch</span>
<a id=__codelineno-26-102 name=__codelineno-26-102 href=#__codelineno-26-102></a><span class=w>      </span><span class=no>@log_level info</span>
<a id=__codelineno-26-103 name=__codelineno-26-103 href=#__codelineno-26-103></a><span class=w>      </span><span class=no>include_tag_key true</span>
<a id=__codelineno-26-104 name=__codelineno-26-104 href=#__codelineno-26-104></a><span class=w>      </span><span class=no>host elasticsearch-client</span>
<a id=__codelineno-26-105 name=__codelineno-26-105 href=#__codelineno-26-105></a><span class=w>      </span><span class=no>port 9200</span>
<a id=__codelineno-26-106 name=__codelineno-26-106 href=#__codelineno-26-106></a><span class=w>      </span><span class=no>user elastic</span>
<a id=__codelineno-26-107 name=__codelineno-26-107 href=#__codelineno-26-107></a><span class=w>      </span><span class=no>password oschina</span>
<a id=__codelineno-26-108 name=__codelineno-26-108 href=#__codelineno-26-108></a><span class=w>      </span><span class=no>logstash_format true</span>
<a id=__codelineno-26-109 name=__codelineno-26-109 href=#__codelineno-26-109></a><span class=w>      </span><span class=no>logstash_prefix k8s</span>
<a id=__codelineno-26-110 name=__codelineno-26-110 href=#__codelineno-26-110></a><span class=w>      </span><span class=no>request_timeout 30s</span>
<a id=__codelineno-26-111 name=__codelineno-26-111 href=#__codelineno-26-111></a><span class=w>      </span><span class=no>&lt;buffer&gt;</span>
<a id=__codelineno-26-112 name=__codelineno-26-112 href=#__codelineno-26-112></a><span class=w>        </span><span class=no>@type file</span>
<a id=__codelineno-26-113 name=__codelineno-26-113 href=#__codelineno-26-113></a><span class=w>        </span><span class=no>path /var/log/fluentd-buffers/kubernetes.system.buffer</span>
<a id=__codelineno-26-114 name=__codelineno-26-114 href=#__codelineno-26-114></a><span class=w>        </span><span class=no>flush_mode interval</span>
<a id=__codelineno-26-115 name=__codelineno-26-115 href=#__codelineno-26-115></a><span class=w>        </span><span class=no>retry_type exponential_backoff</span>
<a id=__codelineno-26-116 name=__codelineno-26-116 href=#__codelineno-26-116></a><span class=w>        </span><span class=no>flush_thread_count 2</span>
<a id=__codelineno-26-117 name=__codelineno-26-117 href=#__codelineno-26-117></a><span class=w>        </span><span class=no>flush_interval 5s</span>
<a id=__codelineno-26-118 name=__codelineno-26-118 href=#__codelineno-26-118></a><span class=w>        </span><span class=no>retry_forever</span>
<a id=__codelineno-26-119 name=__codelineno-26-119 href=#__codelineno-26-119></a><span class=w>        </span><span class=no>retry_max_interval 30</span>
<a id=__codelineno-26-120 name=__codelineno-26-120 href=#__codelineno-26-120></a><span class=w>        </span><span class=no>chunk_limit_size 2M</span>
<a id=__codelineno-26-121 name=__codelineno-26-121 href=#__codelineno-26-121></a><span class=w>        </span><span class=no>queue_limit_length 8</span>
<a id=__codelineno-26-122 name=__codelineno-26-122 href=#__codelineno-26-122></a><span class=w>        </span><span class=no>overflow_action block</span>
<a id=__codelineno-26-123 name=__codelineno-26-123 href=#__codelineno-26-123></a><span class=w>      </span><span class=no>&lt;/buffer&gt;</span>
<a id=__codelineno-26-124 name=__codelineno-26-124 href=#__codelineno-26-124></a><span class=w>    </span><span class=no>&lt;/match&gt;</span>
</code></pre></div> <p>上面配置文件中我们只配置了 docker 容器日志目录，收集到数据经过处理后发送到 elasticsearch-client:9200 服务。</p> <p>然后新建一个 <code>fluentd-daemonset.yaml</code> 的文件，文件内容如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-es</span>
<a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">logging</span>
<a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=w>    </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-es</span>
<a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=w>    </span><span class=nt>kubernetes.io/cluster-service</span><span class=p>:</span><span class=w> </span><span class=s>&quot;true&quot;</span>
<a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=w>    </span><span class=nt>addonmanager.kubernetes.io/mode</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Reconcile</span>
<a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=nn>---</span>
<a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-es</span>
<a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a><span class=w>    </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-es</span>
<a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a><span class=w>    </span><span class=nt>kubernetes.io/cluster-service</span><span class=p>:</span><span class=w> </span><span class=s>&quot;true&quot;</span>
<a id=__codelineno-27-18 name=__codelineno-27-18 href=#__codelineno-27-18></a><span class=w>    </span><span class=nt>addonmanager.kubernetes.io/mode</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Reconcile</span>
<a id=__codelineno-27-19 name=__codelineno-27-19 href=#__codelineno-27-19></a><span class=nt>rules</span><span class=p>:</span>
<a id=__codelineno-27-20 name=__codelineno-27-20 href=#__codelineno-27-20></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span>
<a id=__codelineno-27-21 name=__codelineno-27-21 href=#__codelineno-27-21></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;&quot;</span>
<a id=__codelineno-27-22 name=__codelineno-27-22 href=#__codelineno-27-22></a><span class=w>    </span><span class=nt>resources</span><span class=p>:</span>
<a id=__codelineno-27-23 name=__codelineno-27-23 href=#__codelineno-27-23></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;namespaces&quot;</span>
<a id=__codelineno-27-24 name=__codelineno-27-24 href=#__codelineno-27-24></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;pods&quot;</span>
<a id=__codelineno-27-25 name=__codelineno-27-25 href=#__codelineno-27-25></a><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span>
<a id=__codelineno-27-26 name=__codelineno-27-26 href=#__codelineno-27-26></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;get&quot;</span>
<a id=__codelineno-27-27 name=__codelineno-27-27 href=#__codelineno-27-27></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;watch&quot;</span>
<a id=__codelineno-27-28 name=__codelineno-27-28 href=#__codelineno-27-28></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;list&quot;</span>
<a id=__codelineno-27-29 name=__codelineno-27-29 href=#__codelineno-27-29></a><span class=nn>---</span>
<a id=__codelineno-27-30 name=__codelineno-27-30 href=#__codelineno-27-30></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
<a id=__codelineno-27-31 name=__codelineno-27-31 href=#__codelineno-27-31></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<a id=__codelineno-27-32 name=__codelineno-27-32 href=#__codelineno-27-32></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-27-33 name=__codelineno-27-33 href=#__codelineno-27-33></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-es</span>
<a id=__codelineno-27-34 name=__codelineno-27-34 href=#__codelineno-27-34></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-27-35 name=__codelineno-27-35 href=#__codelineno-27-35></a><span class=w>    </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-es</span>
<a id=__codelineno-27-36 name=__codelineno-27-36 href=#__codelineno-27-36></a><span class=w>    </span><span class=nt>kubernetes.io/cluster-service</span><span class=p>:</span><span class=w> </span><span class=s>&quot;true&quot;</span>
<a id=__codelineno-27-37 name=__codelineno-27-37 href=#__codelineno-27-37></a><span class=w>    </span><span class=nt>addonmanager.kubernetes.io/mode</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Reconcile</span>
<a id=__codelineno-27-38 name=__codelineno-27-38 href=#__codelineno-27-38></a><span class=nt>subjects</span><span class=p>:</span>
<a id=__codelineno-27-39 name=__codelineno-27-39 href=#__codelineno-27-39></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<a id=__codelineno-27-40 name=__codelineno-27-40 href=#__codelineno-27-40></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-es</span>
<a id=__codelineno-27-41 name=__codelineno-27-41 href=#__codelineno-27-41></a><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">logging</span>
<a id=__codelineno-27-42 name=__codelineno-27-42 href=#__codelineno-27-42></a><span class=w>    </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=s>&quot;&quot;</span>
<a id=__codelineno-27-43 name=__codelineno-27-43 href=#__codelineno-27-43></a><span class=nt>roleRef</span><span class=p>:</span>
<a id=__codelineno-27-44 name=__codelineno-27-44 href=#__codelineno-27-44></a><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<a id=__codelineno-27-45 name=__codelineno-27-45 href=#__codelineno-27-45></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-es</span>
<a id=__codelineno-27-46 name=__codelineno-27-46 href=#__codelineno-27-46></a><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=s>&quot;&quot;</span>
<a id=__codelineno-27-47 name=__codelineno-27-47 href=#__codelineno-27-47></a><span class=nn>---</span>
<a id=__codelineno-27-48 name=__codelineno-27-48 href=#__codelineno-27-48></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id=__codelineno-27-49 name=__codelineno-27-49 href=#__codelineno-27-49></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
<a id=__codelineno-27-50 name=__codelineno-27-50 href=#__codelineno-27-50></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-27-51 name=__codelineno-27-51 href=#__codelineno-27-51></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
<a id=__codelineno-27-52 name=__codelineno-27-52 href=#__codelineno-27-52></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">logging</span>
<a id=__codelineno-27-53 name=__codelineno-27-53 href=#__codelineno-27-53></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-27-54 name=__codelineno-27-54 href=#__codelineno-27-54></a><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
<a id=__codelineno-27-55 name=__codelineno-27-55 href=#__codelineno-27-55></a><span class=w>    </span><span class=nt>kubernetes.io/cluster-service</span><span class=p>:</span><span class=w> </span><span class=s>&quot;true&quot;</span>
<a id=__codelineno-27-56 name=__codelineno-27-56 href=#__codelineno-27-56></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-27-57 name=__codelineno-27-57 href=#__codelineno-27-57></a><span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
<a id=__codelineno-27-58 name=__codelineno-27-58 href=#__codelineno-27-58></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<a id=__codelineno-27-59 name=__codelineno-27-59 href=#__codelineno-27-59></a><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
<a id=__codelineno-27-60 name=__codelineno-27-60 href=#__codelineno-27-60></a><span class=w>  </span><span class=nt>template</span><span class=p>:</span>
<a id=__codelineno-27-61 name=__codelineno-27-61 href=#__codelineno-27-61></a><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-27-62 name=__codelineno-27-62 href=#__codelineno-27-62></a><span class=w>      </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-27-63 name=__codelineno-27-63 href=#__codelineno-27-63></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
<a id=__codelineno-27-64 name=__codelineno-27-64 href=#__codelineno-27-64></a><span class=w>        </span><span class=nt>kubernetes.io/cluster-service</span><span class=p>:</span><span class=w> </span><span class=s>&quot;true&quot;</span>
<a id=__codelineno-27-65 name=__codelineno-27-65 href=#__codelineno-27-65></a><span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-27-66 name=__codelineno-27-66 href=#__codelineno-27-66></a><span class=w>      </span><span class=nt>tolerations</span><span class=p>:</span>
<a id=__codelineno-27-67 name=__codelineno-27-67 href=#__codelineno-27-67></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">node-role.kubernetes.io/master</span>
<a id=__codelineno-27-68 name=__codelineno-27-68 href=#__codelineno-27-68></a><span class=w>          </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">NoSchedule</span>
<a id=__codelineno-27-69 name=__codelineno-27-69 href=#__codelineno-27-69></a><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-es</span>
<a id=__codelineno-27-70 name=__codelineno-27-70 href=#__codelineno-27-70></a><span class=w>      </span><span class=nt>containers</span><span class=p>:</span>
<a id=__codelineno-27-71 name=__codelineno-27-71 href=#__codelineno-27-71></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
<a id=__codelineno-27-72 name=__codelineno-27-72 href=#__codelineno-27-72></a><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">quay.io/fluentd_elasticsearch/fluentd:v3.4.0</span>
<a id=__codelineno-27-73 name=__codelineno-27-73 href=#__codelineno-27-73></a><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-27-74 name=__codelineno-27-74 href=#__codelineno-27-74></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentconfig</span>
<a id=__codelineno-27-75 name=__codelineno-27-75 href=#__codelineno-27-75></a><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/etc/fluent/config.d</span>
<a id=__codelineno-27-76 name=__codelineno-27-76 href=#__codelineno-27-76></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">varlog</span>
<a id=__codelineno-27-77 name=__codelineno-27-77 href=#__codelineno-27-77></a><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/log</span>
<a id=__codelineno-27-78 name=__codelineno-27-78 href=#__codelineno-27-78></a><span class=w>      </span><span class=nt>nodeSelector</span><span class=p>:</span>
<a id=__codelineno-27-79 name=__codelineno-27-79 href=#__codelineno-27-79></a><span class=w>        </span><span class=nt>beta.kubernetes.io/fluentd-ds-ready</span><span class=p>:</span><span class=w> </span><span class=s>&quot;true&quot;</span>
<a id=__codelineno-27-80 name=__codelineno-27-80 href=#__codelineno-27-80></a><span class=w>      </span><span class=nt>terminationGracePeriodSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<a id=__codelineno-27-81 name=__codelineno-27-81 href=#__codelineno-27-81></a><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span>
<a id=__codelineno-27-82 name=__codelineno-27-82 href=#__codelineno-27-82></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentconfig</span>
<a id=__codelineno-27-83 name=__codelineno-27-83 href=#__codelineno-27-83></a><span class=w>          </span><span class=nt>configMap</span><span class=p>:</span>
<a id=__codelineno-27-84 name=__codelineno-27-84 href=#__codelineno-27-84></a><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-conf</span>
<a id=__codelineno-27-85 name=__codelineno-27-85 href=#__codelineno-27-85></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">varlog</span>
<a id=__codelineno-27-86 name=__codelineno-27-86 href=#__codelineno-27-86></a><span class=w>          </span><span class=nt>hostPath</span><span class=p>:</span>
<a id=__codelineno-27-87 name=__codelineno-27-87 href=#__codelineno-27-87></a><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/log</span>
</code></pre></div> <p>我们将上面创建的 fluentd-config 这个 ConfigMap 对象通过 volumes 挂载到了 Fluentd 容器中，另外为了能够灵活控制哪些节点的日志可以被收集，还可以添加了一个 nodSelector 属性：</p> <p><div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=nt>nodeSelector</span><span class=p>:</span>
<a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=w>  </span><span class=nt>beta.kubernetes.io/fluentd-ds-ready</span><span class=p>:</span><span class=w> </span><span class=s>&quot;true&quot;</span>
</code></pre></div> 意思就是要想采集节点的日志，那么我们就需要给节点打上上面的标签。</p> <div class="admonition info"> <p class=admonition-title>提示</p> <p>如果你需要在其他节点上采集日志，则需要给对应节点打上标签，使用如下命令：kubectl label nodes node名 beta.kubernetes.io/fluentd-ds-ready=true。</p> </div> <div class=highlight><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a>$<span class=w> </span>kubectl<span class=w> </span>label<span class=w> </span>nodes<span class=w> </span>giteego-k8s-n1<span class=w> </span>beta.kubernetes.io/fluentd-ds-ready<span class=o>=</span><span class=nb>true</span>
<a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a>$<span class=w> </span>kubectl<span class=w> </span>label<span class=w> </span>nodes<span class=w> </span>giteego-k8s-n2<span class=w> </span>beta.kubernetes.io/fluentd-ds-ready<span class=o>=</span><span class=nb>true</span>
<a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a>$<span class=w> </span>kubectl<span class=w> </span>label<span class=w> </span>nodes<span class=w> </span>giteego-k8s-n3<span class=w> </span>beta.kubernetes.io/fluentd-ds-ready<span class=o>=</span><span class=nb>true</span>
<a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a>$<span class=w> </span>kubectl<span class=w> </span>label<span class=w> </span>nodes<span class=w> </span>giteego-k8s-n4<span class=w> </span>beta.kubernetes.io/fluentd-ds-ready<span class=o>=</span><span class=nb>true</span>
</code></pre></div> <p>另外由于我们的集群使用的是 kubeadm 搭建的，默认情况下 master 节点有污点，所以如果要想也收集 master 节点的日志，则需要添加上容忍：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=nt>tolerations</span><span class=p>:</span>
<a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Exists</span>
</code></pre></div> <div class="admonition warning"> <p class=admonition-title>注意</p> <p>另外需要注意的地方是，如果更改了 docker 的根目录，则在 volumes 和 volumeMount 里面都需要更改，保持一致</p> </div> <div class="admonition info"> <p class=admonition-title>举例</p> <div class=highlight><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=w>  </span><span class=nt>containers</span><span class=p>:</span>
<a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
<a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">quay.io/fluentd_elasticsearch/fluentd:v3.4.0</span>
<a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span>
<a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentconfig</span>
<a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/etc/fluent/config.d</span>
<a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">varlog</span>
<a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/log</span>
<a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">varlibdockercontainers</span>
<a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/home/cce/docker/containers</span>
<a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a><span class=w>          </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-31-12 name=__codelineno-31-12 href=#__codelineno-31-12></a><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span>
<a id=__codelineno-31-13 name=__codelineno-31-13 href=#__codelineno-31-13></a><span class=w>    </span><span class=nt>beta.kubernetes.io/fluentd-ds-ready</span><span class=p>:</span><span class=w> </span><span class=s>&quot;true&quot;</span>
<a id=__codelineno-31-14 name=__codelineno-31-14 href=#__codelineno-31-14></a><span class=w>  </span><span class=nt>terminationGracePeriodSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<a id=__codelineno-31-15 name=__codelineno-31-15 href=#__codelineno-31-15></a><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span>
<a id=__codelineno-31-16 name=__codelineno-31-16 href=#__codelineno-31-16></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentconfig</span>
<a id=__codelineno-31-17 name=__codelineno-31-17 href=#__codelineno-31-17></a><span class=w>      </span><span class=nt>configMap</span><span class=p>:</span>
<a id=__codelineno-31-18 name=__codelineno-31-18 href=#__codelineno-31-18></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-conf</span>
<a id=__codelineno-31-19 name=__codelineno-31-19 href=#__codelineno-31-19></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">varlog</span>
<a id=__codelineno-31-20 name=__codelineno-31-20 href=#__codelineno-31-20></a><span class=w>      </span><span class=nt>hostPath</span><span class=p>:</span>
<a id=__codelineno-31-21 name=__codelineno-31-21 href=#__codelineno-31-21></a><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/log</span>
<a id=__codelineno-31-22 name=__codelineno-31-22 href=#__codelineno-31-22></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">varlibdockercontainers</span>
<a id=__codelineno-31-23 name=__codelineno-31-23 href=#__codelineno-31-23></a><span class=w>      </span><span class=nt>hostPath</span><span class=p>:</span>
<a id=__codelineno-31-24 name=__codelineno-31-24 href=#__codelineno-31-24></a><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/home/cce/docker/containers</span>
</code></pre></div> </div> <p>分别创建上面的 ConfigMap 对象和 DaemonSet：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a>$<span class=w> </span>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>fluentd-configmap.yaml
<a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a>configmap<span class=w> </span><span class=s2>&quot;fluentd-conf&quot;</span><span class=w> </span>created
<a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a>$<span class=w> </span>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>fluentd-daemonset.yaml
<a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a>serviceaccount<span class=w> </span><span class=s2>&quot;fluentd-es&quot;</span><span class=w> </span>created
<a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a>clusterrole.rbac.authorization.k8s.io<span class=w> </span><span class=s2>&quot;fluentd-es&quot;</span><span class=w> </span>created
<a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a>clusterrolebinding.rbac.authorization.k8s.io<span class=w> </span><span class=s2>&quot;fluentd-es&quot;</span><span class=w> </span>created
<a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a>daemonset.apps<span class=w> </span><span class=s2>&quot;fluentd&quot;</span><span class=w> </span>created
</code></pre></div> <p>创建完成后，查看对应的 Pods 列表，检查是否部署成功： <div class=highlight><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pod<span class=w> </span>-n<span class=w> </span>logging
<a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a>NAME<span class=w>                            </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>   </span>AGE
<a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a>elasticsearch-client-0<span class=w>          </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>38m
<a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a>elasticsearch-data-0<span class=w>            </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>38m
<a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a>elasticsearch-data-1<span class=w>            </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>38m
<a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a>elasticsearch-data-2<span class=w>            </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>38m
<a id=__codelineno-33-7 name=__codelineno-33-7 href=#__codelineno-33-7></a>elasticsearch-master-0<span class=w>          </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>39m
<a id=__codelineno-33-8 name=__codelineno-33-8 href=#__codelineno-33-8></a>elasticsearch-master-1<span class=w>          </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>39m
<a id=__codelineno-33-9 name=__codelineno-33-9 href=#__codelineno-33-9></a>elasticsearch-master-2<span class=w>          </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>39m
<a id=__codelineno-33-10 name=__codelineno-33-10 href=#__codelineno-33-10></a>fluentd-hmg9k<span class=w>                   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>56s
<a id=__codelineno-33-11 name=__codelineno-33-11 href=#__codelineno-33-11></a>fluentd-hpmmh<span class=w>                   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>56s
<a id=__codelineno-33-12 name=__codelineno-33-12 href=#__codelineno-33-12></a>fluentd-j6nws<span class=w>                   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>56s
<a id=__codelineno-33-13 name=__codelineno-33-13 href=#__codelineno-33-13></a>fluentd-v969z<span class=w>                   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>56s
<a id=__codelineno-33-14 name=__codelineno-33-14 href=#__codelineno-33-14></a>kibana-kibana-f76c9758d-9ndrn<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>31m
</code></pre></div> Fluentd 启动成功后，这个时候就可以发送日志到 ES 了，但是我们这里是过滤了只采集具有 logging=true 标签的 Pod 日志，所以现在还没有任何数据会被采集。</p> <p>下面我们部署一个简单的测试应用， 新建 <code>counter.yaml</code> 文件，文件内容如下： <div class=highlight><pre><span></span><code><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">counter</span>
<a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a><span class=w>    </span><span class=nt>logging</span><span class=p>:</span><span class=w> </span><span class=s>&quot;true&quot;</span>
<a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a><span class=w>  </span><span class=nt>containers</span><span class=p>:</span>
<a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">count</span>
<a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a><span class=w>      </span><span class=nt>args</span><span class=p>:</span>
<a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a><span class=w>        </span><span class="p p-Indicator">[</span>
<a id=__codelineno-34-13 name=__codelineno-34-13 href=#__codelineno-34-13></a><span class=w>          </span><span class=nv>/bin/sh</span><span class="p p-Indicator">,</span>
<a id=__codelineno-34-14 name=__codelineno-34-14 href=#__codelineno-34-14></a><span class=w>          </span><span class=nv>-c</span><span class="p p-Indicator">,</span>
<a id=__codelineno-34-15 name=__codelineno-34-15 href=#__codelineno-34-15></a><span class=w>          </span><span class=s>&#39;i=0;</span><span class=nv> </span><span class=s>while</span><span class=nv> </span><span class=s>true;</span><span class=nv> </span><span class=s>do</span><span class=nv> </span><span class=s>echo</span><span class=nv> </span><span class=s>&quot;$i:</span><span class=nv> </span><span class=s>$(date)&quot;;</span><span class=nv> </span><span class=s>i=$((i+1));</span><span class=nv> </span><span class=s>sleep</span><span class=nv> </span><span class=s>1;</span><span class=nv> </span><span class=s>done&#39;</span><span class="p p-Indicator">,</span>
<a id=__codelineno-34-16 name=__codelineno-34-16 href=#__codelineno-34-16></a><span class=w>        </span><span class="p p-Indicator">]</span>
</code></pre></div></p> <p>该 Pod 只是简单将日志信息打印到 stdout，所以正常来说 Fluentd 会收集到这个日志数据，在 Kibana 中也就可以找到对应的日志数据了，使用 kubectl 工具创建该 Pod：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a>$<span class=w> </span>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>counter.yaml
<a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pods
<a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a>NAME<span class=w>                             </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>   </span>AGE
<a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a>counter<span class=w>                          </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>9h
</code></pre></div> <p>Pod 创建并运行后，回到 Kibana Dashboard 页面，点击左侧最下面的 Management -&gt; Stack Management，进入管理页面，点击左侧 Kibana 下面的 索引模式，点击 创建索引模式 开始导入索引数据： <img alt class=zoom src=../../../assets/static/kubernetes/5/elastic-sy01.png></p> <p>在这里可以配置我们需要的 Elasticsearch 索引，前面 Fluentd 配置文件中我们采集的日志使用的是 logstash 格式，定义了一个 k8s 的前缀， 所以这里只需要在文本框中输入 <code>k8s-*</code> 即可匹配到 Elasticsearch 集群中采集的 Kubernetes 集群日志数据，然后点击下一步，进入以下页面： <img alt class=zoom src=../../../assets/static/kubernetes/5/elastic-sy02.png></p> <p>在该页面中配置使用哪个字段按时间过滤日志数据，在下拉列表中，选择@timestamp字段，然后点击 创建索引模式，创建完成后， 点击左侧导航菜单中的 Discover，然后就可以看到一些直方图和最近采集到的日志数据了：</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/5/elastic-sy03.png></p> <p>现在的数据就是上面 Counter 应用的日志，如果还有其他的应用，我们也可以筛选过滤：</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/5/elastic-sy04.png></p> <p>我们也可以通过其他元数据来过滤日志数据，比如您可以单击任何日志条目以查看其他元数据，如容器名称，Kubernetes 节点，命名空间等。</p> <h3 id=23-安装-kafka>2.3 安装 Kafka<a class=headerlink href=#23-安装-kafka title="Permanent link">&para;</a></h3> <p>对于大规模集群来说，日志数据量是非常巨大的，如果直接通过 Fluentd 将日志打入 Elasticsearch，对 ES 来说压力是非常巨大的，我们可以在中间加一层消息中间件来缓解 ES 的压力，一般情况下我们会使用 Kafka，然后可以直接使用 kafka-connect-elasticsearch 这样的工具将数据直接打入 ES，也可以在加一层 Logstash 去消费 Kafka 的数据，然后通过 Logstash 把数据存入 ES，这里我们来使用 Logstash 这种模式来对日志收集进行优化。</p> <p>首先在 Kubernetes 集群中安装 Kafka，同样这里使用 Helm 进行安装： <div class=highlight><pre><span></span><code><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a>$<span class=w> </span>helm<span class=w> </span>repo<span class=w> </span>add<span class=w> </span>bitnami<span class=w> </span>https://charts.bitnami.com/bitnami
<a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a>$<span class=w> </span>helm<span class=w> </span>repo<span class=w> </span>update
</code></pre></div> 首先使用 helm pull 拉取 Chart 并解压：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a>$<span class=w> </span>helm<span class=w> </span>pull<span class=w> </span>bitnami/kafka<span class=w> </span>--untar<span class=w> </span>--version<span class=w> </span><span class=m>17</span>.2.3
<a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a>$<span class=w> </span><span class=nb>cd</span><span class=w> </span>kafka
</code></pre></div> <p>这里面我们指定使用一个 StorageClass 来提供持久化存储，在 Chart 目录下面创建用于安装的 values 文件： <code>values-prod.yaml</code></p> <p><div class=highlight><pre><span></span><code><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=c1># values-prod.yaml</span>
<a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=c1>## @section Persistence parameters</span>
<a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=nt>persistence</span><span class=p>:</span>
<a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a><span class=w>  </span><span class=nt>storageClass</span><span class=p>:</span><span class=w> </span><span class=s>&quot;efk-nfs&quot;</span>
<a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span>
<a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
<a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a><span class=w>  </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8Gi</span>
<a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a>
<a id=__codelineno-38-10 name=__codelineno-38-10 href=#__codelineno-38-10></a><span class=w>  </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/bitnami/kafka</span>
<a id=__codelineno-38-11 name=__codelineno-38-11 href=#__codelineno-38-11></a>
<a id=__codelineno-38-12 name=__codelineno-38-12 href=#__codelineno-38-12></a><span class=c1># 配置zk volumes</span>
<a id=__codelineno-38-13 name=__codelineno-38-13 href=#__codelineno-38-13></a><span class=nt>zookeeper</span><span class=p>:</span>
<a id=__codelineno-38-14 name=__codelineno-38-14 href=#__codelineno-38-14></a><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-38-15 name=__codelineno-38-15 href=#__codelineno-38-15></a><span class=w>  </span><span class=nt>persistence</span><span class=p>:</span>
<a id=__codelineno-38-16 name=__codelineno-38-16 href=#__codelineno-38-16></a><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-38-17 name=__codelineno-38-17 href=#__codelineno-38-17></a><span class=w>    </span><span class=nt>storageClass</span><span class=p>:</span><span class=w> </span><span class=s>&quot;efk-nfs&quot;</span>
<a id=__codelineno-38-18 name=__codelineno-38-18 href=#__codelineno-38-18></a><span class=w>    </span><span class=nt>accessModes</span><span class=p>:</span>
<a id=__codelineno-38-19 name=__codelineno-38-19 href=#__codelineno-38-19></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
<a id=__codelineno-38-20 name=__codelineno-38-20 href=#__codelineno-38-20></a><span class=w>    </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8Gi</span>
</code></pre></div> 直接使用上面的 values 文件安装 kafka： <div class=highlight><pre><span></span><code><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a>$<span class=w> </span>helm<span class=w> </span>upgrade<span class=w> </span>--install<span class=w> </span>kafka<span class=w> </span>-f<span class=w> </span>values-prod.yaml<span class=w> </span>--namespace<span class=w> </span>logging<span class=w> </span>.
<a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a>Release<span class=w> </span><span class=s2>&quot;kafka&quot;</span><span class=w> </span>does<span class=w> </span>not<span class=w> </span>exist.<span class=w> </span>Installing<span class=w> </span>it<span class=w> </span>now.
<a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a>NAME:<span class=w> </span>kafka
<a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a>LAST<span class=w> </span>DEPLOYED:<span class=w> </span>Thu<span class=w> </span>Jun<span class=w>  </span><span class=m>9</span><span class=w> </span><span class=m>14</span>:02:01<span class=w> </span><span class=m>2022</span>
<a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a>NAMESPACE:<span class=w> </span>logging
<a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a>STATUS:<span class=w> </span>deployed
<a id=__codelineno-39-7 name=__codelineno-39-7 href=#__codelineno-39-7></a>REVISION:<span class=w> </span><span class=m>1</span>
<a id=__codelineno-39-8 name=__codelineno-39-8 href=#__codelineno-39-8></a>TEST<span class=w> </span>SUITE:<span class=w> </span>None
<a id=__codelineno-39-9 name=__codelineno-39-9 href=#__codelineno-39-9></a>NOTES:
<a id=__codelineno-39-10 name=__codelineno-39-10 href=#__codelineno-39-10></a>CHART<span class=w> </span>NAME:<span class=w> </span>kafka
<a id=__codelineno-39-11 name=__codelineno-39-11 href=#__codelineno-39-11></a>CHART<span class=w> </span>VERSION:<span class=w> </span><span class=m>17</span>.2.3
<a id=__codelineno-39-12 name=__codelineno-39-12 href=#__codelineno-39-12></a>APP<span class=w> </span>VERSION:<span class=w> </span><span class=m>3</span>.2.0
<a id=__codelineno-39-13 name=__codelineno-39-13 href=#__codelineno-39-13></a>
<a id=__codelineno-39-14 name=__codelineno-39-14 href=#__codelineno-39-14></a>**<span class=w> </span>Please<span class=w> </span>be<span class=w> </span>patient<span class=w> </span><span class=k>while</span><span class=w> </span>the<span class=w> </span>chart<span class=w> </span>is<span class=w> </span>being<span class=w> </span>deployed<span class=w> </span>**
<a id=__codelineno-39-15 name=__codelineno-39-15 href=#__codelineno-39-15></a>
<a id=__codelineno-39-16 name=__codelineno-39-16 href=#__codelineno-39-16></a>Kafka<span class=w> </span>can<span class=w> </span>be<span class=w> </span>accessed<span class=w> </span>by<span class=w> </span>consumers<span class=w> </span>via<span class=w> </span>port<span class=w> </span><span class=m>9092</span><span class=w> </span>on<span class=w> </span>the<span class=w> </span>following<span class=w> </span>DNS<span class=w> </span>name<span class=w> </span>from<span class=w> </span>within<span class=w> </span>your<span class=w> </span>cluster:
<a id=__codelineno-39-17 name=__codelineno-39-17 href=#__codelineno-39-17></a>
<a id=__codelineno-39-18 name=__codelineno-39-18 href=#__codelineno-39-18></a><span class=w>    </span>kafka.logging.svc.cluster.local
<a id=__codelineno-39-19 name=__codelineno-39-19 href=#__codelineno-39-19></a>
<a id=__codelineno-39-20 name=__codelineno-39-20 href=#__codelineno-39-20></a>Each<span class=w> </span>Kafka<span class=w> </span>broker<span class=w> </span>can<span class=w> </span>be<span class=w> </span>accessed<span class=w> </span>by<span class=w> </span>producers<span class=w> </span>via<span class=w> </span>port<span class=w> </span><span class=m>9092</span><span class=w> </span>on<span class=w> </span>the<span class=w> </span>following<span class=w> </span>DNS<span class=w> </span>name<span class=o>(</span>s<span class=o>)</span><span class=w> </span>from<span class=w> </span>within<span class=w> </span>your<span class=w> </span>cluster:
<a id=__codelineno-39-21 name=__codelineno-39-21 href=#__codelineno-39-21></a>
<a id=__codelineno-39-22 name=__codelineno-39-22 href=#__codelineno-39-22></a><span class=w>    </span>kafka-0.kafka-headless.logging.svc.cluster.local:9092
<a id=__codelineno-39-23 name=__codelineno-39-23 href=#__codelineno-39-23></a>
<a id=__codelineno-39-24 name=__codelineno-39-24 href=#__codelineno-39-24></a>To<span class=w> </span>create<span class=w> </span>a<span class=w> </span>pod<span class=w> </span>that<span class=w> </span>you<span class=w> </span>can<span class=w> </span>use<span class=w> </span>as<span class=w> </span>a<span class=w> </span>Kafka<span class=w> </span>client<span class=w> </span>run<span class=w> </span>the<span class=w> </span>following<span class=w> </span>commands:
<a id=__codelineno-39-25 name=__codelineno-39-25 href=#__codelineno-39-25></a>
<a id=__codelineno-39-26 name=__codelineno-39-26 href=#__codelineno-39-26></a><span class=w>    </span>kubectl<span class=w> </span>run<span class=w> </span>kafka-client<span class=w> </span>--restart<span class=o>=</span><span class=s1>&#39;Never&#39;</span><span class=w> </span>--image<span class=w> </span>docker.io/bitnami/kafka:3.2.0-debian-10-r4<span class=w> </span>--namespace<span class=w> </span>logging<span class=w> </span>--command<span class=w> </span>--<span class=w> </span>sleep<span class=w> </span>infinity
<a id=__codelineno-39-27 name=__codelineno-39-27 href=#__codelineno-39-27></a><span class=w>    </span>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>--tty<span class=w> </span>-i<span class=w> </span>kafka-client<span class=w> </span>--namespace<span class=w> </span>logging<span class=w> </span>--<span class=w> </span>bash
<a id=__codelineno-39-28 name=__codelineno-39-28 href=#__codelineno-39-28></a>
<a id=__codelineno-39-29 name=__codelineno-39-29 href=#__codelineno-39-29></a><span class=w>    </span>PRODUCER:
<a id=__codelineno-39-30 name=__codelineno-39-30 href=#__codelineno-39-30></a><span class=w>        </span>kafka-console-producer.sh<span class=w> </span><span class=se>\</span>
<a id=__codelineno-39-31 name=__codelineno-39-31 href=#__codelineno-39-31></a>
<a id=__codelineno-39-32 name=__codelineno-39-32 href=#__codelineno-39-32></a><span class=w>            </span>--broker-list<span class=w> </span>kafka-0.kafka-headless.logging.svc.cluster.local:9092<span class=w> </span><span class=se>\</span>
<a id=__codelineno-39-33 name=__codelineno-39-33 href=#__codelineno-39-33></a><span class=w>            </span>--topic<span class=w> </span><span class=nb>test</span>
<a id=__codelineno-39-34 name=__codelineno-39-34 href=#__codelineno-39-34></a>
<a id=__codelineno-39-35 name=__codelineno-39-35 href=#__codelineno-39-35></a><span class=w>    </span>CONSUMER:
<a id=__codelineno-39-36 name=__codelineno-39-36 href=#__codelineno-39-36></a><span class=w>        </span>kafka-console-consumer.sh<span class=w> </span><span class=se>\</span>
<a id=__codelineno-39-37 name=__codelineno-39-37 href=#__codelineno-39-37></a>
<a id=__codelineno-39-38 name=__codelineno-39-38 href=#__codelineno-39-38></a><span class=w>            </span>--bootstrap-server<span class=w> </span>kafka.logging.svc.cluster.local:9092<span class=w> </span><span class=se>\</span>
<a id=__codelineno-39-39 name=__codelineno-39-39 href=#__codelineno-39-39></a><span class=w>            </span>--topic<span class=w> </span><span class=nb>test</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-39-40 name=__codelineno-39-40 href=#__codelineno-39-40></a><span class=w>            </span>--from-beginning
</code></pre></div></p> <p>安装完成后我们可以使用上面的提示来检查 Kafka 是否正常运行：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>logging<span class=w> </span>-l<span class=w> </span>app.kubernetes.io/instance<span class=o>=</span>kafka
<a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a>kafka-0<span class=w>             </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>7m58s
<a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a>kafka-zookeeper-0<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>7m58s
</code></pre></div> <p>用下面的命令创建一个 Kafka 的测试客户端 Pod： <div class=highlight><pre><span></span><code><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a>$<span class=w> </span>kubectl<span class=w> </span>run<span class=w> </span>kafka-client<span class=w> </span>--restart<span class=o>=</span><span class=s1>&#39;Never&#39;</span><span class=w> </span>--image<span class=w> </span>docker.io/bitnami/kafka:3.2.0-debian-10-r4<span class=w> </span>--namespace<span class=w> </span>logging<span class=w> </span>--command<span class=w> </span>--<span class=w> </span>sleep<span class=w> </span>infinity
<a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a>pod/kafka-client<span class=w> </span>created
</code></pre></div> 然后启动一个终端进入容器内部生产消息： <div class=highlight><pre><span></span><code><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=c1># 生产者</span>
<a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a>$<span class=w> </span>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>--tty<span class=w> </span>-i<span class=w> </span>kafka-client<span class=w> </span>--namespace<span class=w> </span>logging<span class=w> </span>--<span class=w> </span>bash
<a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a>I<span class=w> </span>have<span class=w> </span>no<span class=w> </span>name!@kafka-client:/$<span class=w> </span>kafka-console-producer.sh<span class=w> </span>--broker-list<span class=w> </span>kafka-0.kafka-headless.logging.svc.cluster.local:9092<span class=w> </span>--topic<span class=w> </span><span class=nb>test</span>
<a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a>&gt;hello<span class=w> </span>kafka<span class=w> </span>on<span class=w> </span>k8s
<a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a>&gt;
</code></pre></div></p> <p>启动另外一个终端进入容器内部消费消息： <div class=highlight><pre><span></span><code><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a><span class=c1># 消费者</span>
<a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a>$<span class=w> </span>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>--tty<span class=w> </span>-i<span class=w> </span>kafka-client<span class=w> </span>--namespace<span class=w> </span>logging<span class=w> </span>--<span class=w> </span>bash
<a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a>I<span class=w> </span>have<span class=w> </span>no<span class=w> </span>name!@kafka-client:/$<span class=w> </span>kafka-console-consumer.sh<span class=w> </span>--bootstrap-server<span class=w> </span>kafka.logging.svc.cluster.local:9092<span class=w> </span>--topic<span class=w> </span><span class=nb>test</span><span class=w> </span>--from-beginning
<a id=__codelineno-43-4 name=__codelineno-43-4 href=#__codelineno-43-4></a>hello<span class=w> </span>kafka<span class=w> </span>on<span class=w> </span>k8s
</code></pre></div></p> <p>如果在消费端看到了生产的消息数据证明我们的 Kafka 已经运行成功了。</p> <h3 id=24-fluentd-配置-kafka>2.4 Fluentd 配置 Kafka<a class=headerlink href=#24-fluentd-配置-kafka title="Permanent link">&para;</a></h3> <p>现在有了 Kafka，我们就可以将 Fluentd 的日志数据输出到 Kafka 了，只需要将 Fluentd 配置中的 <match> 更改为使用 Kafka 插件即可，但是在 Fluentd 中输出到 Kafka， 需要使用到 fluent-plugin-kafka 插件，所以需要我们自定义下 Docker 镜像，最简单的做法就是在上面 Fluentd 镜像的基础上新增 kafka 插件即可，Dockerfile 文件如下所示：</p> <p><code>Dockerfile</code> <div class=highlight><pre><span></span><code><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a>FROM quay.io/fluentd_elasticsearch/fluentd:v3.4.0
<a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a>RUN echo &quot;source &#39;https://mirrors.tuna.tsinghua.edu.cn/rubygems/&#39;&quot; &gt; Gemfile &amp;&amp; gem install bundler
<a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a>RUN gem install fluent-plugin-kafka -v 0.17.5 --no-document
</code></pre></div></p> <div class=highlight><pre><span></span><code><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a>$<span class=w> </span>docker<span class=w> </span>build<span class=w> </span>-t<span class=w> </span>giteeops/fluentd-kafka:v0.17.5<span class=w> </span>.
<a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a>$<span class=w> </span>docker<span class=w> </span>push<span class=w> </span>giteeops/fluentd-kafka:v0.17.5
</code></pre></div> <p>使用上面的 Dockerfile 文件构建一个 Docker 镜像即可，我这里构建过后的镜像名为 <code>giteeops/fluentd-kafka:v0.17.5</code>。接下来替换 Fluentd 的 Configmap 对象中的 <match> 部分，如下所示：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a><span class=c1># fluentd-configmap.yaml</span>
<a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-conf</span>
<a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">logging</span>
<a id=__codelineno-46-7 name=__codelineno-46-7 href=#__codelineno-46-7></a><span class=nt>data</span><span class=p>:</span>
<a id=__codelineno-46-8 name=__codelineno-46-8 href=#__codelineno-46-8></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">......</span>
<a id=__codelineno-46-9 name=__codelineno-46-9 href=#__codelineno-46-9></a><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">output.conf</span><span class="p p-Indicator">:</span><span class=w> </span><span class="p p-Indicator">|-</span>
<a id=__codelineno-46-10 name=__codelineno-46-10 href=#__codelineno-46-10></a><span class=w>    </span><span class=no>&lt;match **&gt;</span>
<a id=__codelineno-46-11 name=__codelineno-46-11 href=#__codelineno-46-11></a><span class=w>      </span><span class=no>@id kafka</span>
<a id=__codelineno-46-12 name=__codelineno-46-12 href=#__codelineno-46-12></a><span class=w>      </span><span class=no>@type kafka2</span>
<a id=__codelineno-46-13 name=__codelineno-46-13 href=#__codelineno-46-13></a><span class=w>      </span><span class=no>@log_level info</span>
<a id=__codelineno-46-14 name=__codelineno-46-14 href=#__codelineno-46-14></a>
<a id=__codelineno-46-15 name=__codelineno-46-15 href=#__codelineno-46-15></a><span class=w>      </span><span class=no># list of seed brokers</span>
<a id=__codelineno-46-16 name=__codelineno-46-16 href=#__codelineno-46-16></a><span class=w>      </span><span class=no>brokers kafka-0.kafka-headless.logging.svc.cluster.local:9092</span>
<a id=__codelineno-46-17 name=__codelineno-46-17 href=#__codelineno-46-17></a><span class=w>      </span><span class=no>use_event_time true</span>
<a id=__codelineno-46-18 name=__codelineno-46-18 href=#__codelineno-46-18></a>
<a id=__codelineno-46-19 name=__codelineno-46-19 href=#__codelineno-46-19></a><span class=w>      </span><span class=no># topic settings</span>
<a id=__codelineno-46-20 name=__codelineno-46-20 href=#__codelineno-46-20></a><span class=w>      </span><span class=no>topic_key k8slog</span>
<a id=__codelineno-46-21 name=__codelineno-46-21 href=#__codelineno-46-21></a><span class=w>      </span><span class=no>default_topic messages  # 注意，kafka中消费使用的是这个topic</span>
<a id=__codelineno-46-22 name=__codelineno-46-22 href=#__codelineno-46-22></a><span class=w>      </span><span class=no># buffer settings</span>
<a id=__codelineno-46-23 name=__codelineno-46-23 href=#__codelineno-46-23></a><span class=w>      </span><span class=no>&lt;buffer k8slog&gt;</span>
<a id=__codelineno-46-24 name=__codelineno-46-24 href=#__codelineno-46-24></a><span class=w>        </span><span class=no>@type file</span>
<a id=__codelineno-46-25 name=__codelineno-46-25 href=#__codelineno-46-25></a><span class=w>        </span><span class=no>path /var/log/td-agent/buffer/td</span>
<a id=__codelineno-46-26 name=__codelineno-46-26 href=#__codelineno-46-26></a><span class=w>        </span><span class=no>flush_interval 3s</span>
<a id=__codelineno-46-27 name=__codelineno-46-27 href=#__codelineno-46-27></a><span class=w>      </span><span class=no>&lt;/buffer&gt;</span>
<a id=__codelineno-46-28 name=__codelineno-46-28 href=#__codelineno-46-28></a>
<a id=__codelineno-46-29 name=__codelineno-46-29 href=#__codelineno-46-29></a><span class=w>      </span><span class=no># data type settings</span>
<a id=__codelineno-46-30 name=__codelineno-46-30 href=#__codelineno-46-30></a><span class=w>      </span><span class=no>&lt;format&gt;</span>
<a id=__codelineno-46-31 name=__codelineno-46-31 href=#__codelineno-46-31></a><span class=w>        </span><span class=no>@type json</span>
<a id=__codelineno-46-32 name=__codelineno-46-32 href=#__codelineno-46-32></a><span class=w>      </span><span class=no>&lt;/format&gt;</span>
<a id=__codelineno-46-33 name=__codelineno-46-33 href=#__codelineno-46-33></a>
<a id=__codelineno-46-34 name=__codelineno-46-34 href=#__codelineno-46-34></a><span class=w>      </span><span class=no># producer settings</span>
<a id=__codelineno-46-35 name=__codelineno-46-35 href=#__codelineno-46-35></a><span class=w>      </span><span class=no>required_acks -1</span>
<a id=__codelineno-46-36 name=__codelineno-46-36 href=#__codelineno-46-36></a><span class=w>      </span><span class=no>compression_codec gzip</span>
<a id=__codelineno-46-37 name=__codelineno-46-37 href=#__codelineno-46-37></a>
<a id=__codelineno-46-38 name=__codelineno-46-38 href=#__codelineno-46-38></a><span class=w>    </span><span class=no>&lt;/match&gt;</span>
</code></pre></div> <div class="admonition warning"> <p class=admonition-title>注意</p> <p>node节点会创建一个/var/log/td-agent/buffer/td目录。此目录数据很大，考虑到磁盘空间的问题，可以将buffer settings为memory的方式</p> </div> <div class=highlight><pre><span></span><code><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=w>  </span><span class=nt>output.conf</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|-</span>
<a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a><span class=w>    </span><span class=no>&lt;match **&gt;</span>
<a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a><span class=w>      </span><span class=no>@id kafka</span>
<a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a><span class=w>      </span><span class=no>@type kafka2</span>
<a id=__codelineno-47-5 name=__codelineno-47-5 href=#__codelineno-47-5></a><span class=w>      </span><span class=no>@log_level info</span>
<a id=__codelineno-47-6 name=__codelineno-47-6 href=#__codelineno-47-6></a>
<a id=__codelineno-47-7 name=__codelineno-47-7 href=#__codelineno-47-7></a><span class=w>      </span><span class=no># list of seed brokers</span>
<a id=__codelineno-47-8 name=__codelineno-47-8 href=#__codelineno-47-8></a><span class=w>      </span><span class=no>brokers kafka-0.kafka-headless.logging.svc.cluster.local:9092</span>
<a id=__codelineno-47-9 name=__codelineno-47-9 href=#__codelineno-47-9></a><span class=w>      </span><span class=no>use_event_time true</span>
<a id=__codelineno-47-10 name=__codelineno-47-10 href=#__codelineno-47-10></a>
<a id=__codelineno-47-11 name=__codelineno-47-11 href=#__codelineno-47-11></a><span class=w>      </span><span class=no># topic settings</span>
<a id=__codelineno-47-12 name=__codelineno-47-12 href=#__codelineno-47-12></a><span class=w>      </span><span class=no>topic_key k8slog</span>
<a id=__codelineno-47-13 name=__codelineno-47-13 href=#__codelineno-47-13></a><span class=w>      </span><span class=no>default_topic messages  # 注意，kafka中消费使用的是这个topic</span>
<a id=__codelineno-47-14 name=__codelineno-47-14 href=#__codelineno-47-14></a><span class=w>      </span><span class=no># buffer settings</span>
<a id=__codelineno-47-15 name=__codelineno-47-15 href=#__codelineno-47-15></a><span class=w>      </span><span class=no>&lt;buffer k8slog&gt;</span>
<a id=__codelineno-47-16 name=__codelineno-47-16 href=#__codelineno-47-16></a><span class=w>        </span><span class=no>@type memory</span>
<a id=__codelineno-47-17 name=__codelineno-47-17 href=#__codelineno-47-17></a><span class=w>        </span><span class=no>path /var/log/td-agent/buffer/td</span>
<a id=__codelineno-47-18 name=__codelineno-47-18 href=#__codelineno-47-18></a><span class=w>        </span><span class=no>flush_interval 3s</span>
<a id=__codelineno-47-19 name=__codelineno-47-19 href=#__codelineno-47-19></a><span class=w>      </span><span class=no>&lt;/buffer&gt;</span>
<a id=__codelineno-47-20 name=__codelineno-47-20 href=#__codelineno-47-20></a>
<a id=__codelineno-47-21 name=__codelineno-47-21 href=#__codelineno-47-21></a><span class=w>      </span><span class=no># data type settings</span>
<a id=__codelineno-47-22 name=__codelineno-47-22 href=#__codelineno-47-22></a><span class=w>      </span><span class=no>&lt;format&gt;</span>
<a id=__codelineno-47-23 name=__codelineno-47-23 href=#__codelineno-47-23></a><span class=w>        </span><span class=no>@type json</span>
<a id=__codelineno-47-24 name=__codelineno-47-24 href=#__codelineno-47-24></a><span class=w>      </span><span class=no>&lt;/format&gt;</span>
<a id=__codelineno-47-25 name=__codelineno-47-25 href=#__codelineno-47-25></a>
<a id=__codelineno-47-26 name=__codelineno-47-26 href=#__codelineno-47-26></a><span class=w>      </span><span class=no># producer settings</span>
<a id=__codelineno-47-27 name=__codelineno-47-27 href=#__codelineno-47-27></a><span class=w>      </span><span class=no>required_acks -1</span>
<a id=__codelineno-47-28 name=__codelineno-47-28 href=#__codelineno-47-28></a><span class=w>      </span><span class=no>compression_codec gzip</span>
<a id=__codelineno-47-29 name=__codelineno-47-29 href=#__codelineno-47-29></a>
<a id=__codelineno-47-30 name=__codelineno-47-30 href=#__codelineno-47-30></a><span class=w>    </span><span class=no>&lt;/match&gt;</span>
</code></pre></div> <p>然后替换运行的 Fluentd 镜像： <div class=highlight><pre><span></span><code><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=c1># fluentd-daemonset.yaml</span>
<a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">giteeops/fluentd-kafka:v0.17.5</span>
</code></pre></div> 直接更新 Fluentd 的 Configmap 与 DaemonSet 资源对象即可： <div class=highlight><pre><span></span><code><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a>$<span class=w> </span>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>fluentd-configmap.yaml
<a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a>$<span class=w> </span>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>fluentd-daemonset.yaml
</code></pre></div></p> <p>更新成功后我们可以使用上面的测试 Kafka 客户端来验证是否有日志数据： <div class=highlight><pre><span></span><code><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a>$<span class=w> </span>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>--tty<span class=w> </span>-i<span class=w> </span>kafka-client<span class=w> </span>--namespace<span class=w> </span>logging<span class=w> </span>--<span class=w> </span>bash
<a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a>I<span class=w> </span>have<span class=w> </span>no<span class=w> </span>name!@kafka-client:/$<span class=w> </span>kafka-console-consumer.sh<span class=w> </span>--bootstrap-server<span class=w> </span>kafka.logging.svc.cluster.local:9092<span class=w> </span>--topic<span class=w> </span>messages<span class=w> </span>--from-beginning
<a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a><span class=o>{</span><span class=s2>&quot;stream&quot;</span>:<span class=s2>&quot;stdout&quot;</span>,<span class=s2>&quot;docker&quot;</span>:<span class=o>{}</span>,<span class=s2>&quot;kubernetes&quot;</span>:<span class=o>{</span><span class=s2>&quot;container_name&quot;</span>:<span class=s2>&quot;count&quot;</span>,<span class=s2>&quot;namespace_name&quot;</span>:<span class=s2>&quot;default&quot;</span>,<span class=s2>&quot;pod_name&quot;</span>:<span class=s2>&quot;counter&quot;</span>,<span class=s2>&quot;container_image&quot;</span>:<span class=s2>&quot;busybox:latest&quot;</span>,<span class=s2>&quot;host&quot;</span>:<span class=s2>&quot;node1&quot;</span>,<span class=s2>&quot;labels&quot;</span>:<span class=o>{</span><span class=s2>&quot;logging&quot;</span>:<span class=s2>&quot;true&quot;</span><span class=o>}}</span>,<span class=s2>&quot;message&quot;</span>:<span class=s2>&quot;43883: Tue Apr 27 12:16:30 UTC 2021\n&quot;</span><span class=o>}</span>
<a id=__codelineno-50-4 name=__codelineno-50-4 href=#__codelineno-50-4></a>......
</code></pre></div></p> <h3 id=25-安装-logstash>2.5 安装 Logstash<a class=headerlink href=#25-安装-logstash title="Permanent link">&para;</a></h3> <p>虽然数据从 Kafka 到 Elasticsearch 的方式多种多样，比如可以使用 <a href=https://github.com/confluentinc/kafka-connect-elasticsearch>Kafka Connect Elasticsearch Connector</a> 来实现，</p> <p>我们这里还是采用更加流行的 <code>Logstash</code> 方案，上面我们已经将日志从 Fluentd 采集输出到 Kafka 中去了，接下来我们使用 Logstash 来连接 Kafka 与 Elasticsearch 间的日志数据。</p> <p>首先使用 helm pull 拉取 Chart 并解压：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a>$<span class=w> </span>helm<span class=w> </span>pull<span class=w> </span>elastic/logstash<span class=w> </span>--untar<span class=w> </span>--version<span class=w> </span><span class=m>7</span>.17.3
<a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a>$<span class=w> </span><span class=nb>cd</span><span class=w> </span>logstash
</code></pre></div> <p>同样在 Chart 根目录下面创建用于安装的 Values 文件，如下所示： <div class=highlight><pre><span></span><code><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a><span class=c1># values-prod.yaml</span>
<a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a><span class=nt>fullnameOverride</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">logstash</span>
<a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a>
<a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a><span class=nt>persistence</span><span class=p>:</span>
<a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a>
<a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a><span class=nt>logstashConfig</span><span class=p>:</span>
<a id=__codelineno-52-8 name=__codelineno-52-8 href=#__codelineno-52-8></a><span class=w>  </span><span class=nt>logstash.yml</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span>
<a id=__codelineno-52-9 name=__codelineno-52-9 href=#__codelineno-52-9></a><span class=w>    </span><span class=no>http.host: 0.0.0.0</span>
<a id=__codelineno-52-10 name=__codelineno-52-10 href=#__codelineno-52-10></a><span class=w>    </span><span class=no># 如果启用了xpack，需要做如下配置</span>
<a id=__codelineno-52-11 name=__codelineno-52-11 href=#__codelineno-52-11></a><span class=w>    </span><span class=no>xpack.monitoring.enabled: true</span>
<a id=__codelineno-52-12 name=__codelineno-52-12 href=#__codelineno-52-12></a><span class=w>    </span><span class=no>xpack.monitoring.elasticsearch.hosts: [&quot;http://elasticsearch-client:9200&quot;]</span>
<a id=__codelineno-52-13 name=__codelineno-52-13 href=#__codelineno-52-13></a><span class=w>    </span><span class=no>xpack.monitoring.elasticsearch.username: &quot;elastic&quot;</span>
<a id=__codelineno-52-14 name=__codelineno-52-14 href=#__codelineno-52-14></a><span class=w>    </span><span class=no>xpack.monitoring.elasticsearch.password: &quot;oschina&quot;</span>
<a id=__codelineno-52-15 name=__codelineno-52-15 href=#__codelineno-52-15></a>
<a id=__codelineno-52-16 name=__codelineno-52-16 href=#__codelineno-52-16></a><span class=c1># 要注意下格式</span>
<a id=__codelineno-52-17 name=__codelineno-52-17 href=#__codelineno-52-17></a><span class=nt>logstashPipeline</span><span class=p>:</span>
<a id=__codelineno-52-18 name=__codelineno-52-18 href=#__codelineno-52-18></a><span class=w>  </span><span class=nt>logstash.conf</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span>
<a id=__codelineno-52-19 name=__codelineno-52-19 href=#__codelineno-52-19></a><span class=w>    </span><span class=no>input { kafka { bootstrap_servers =&gt; &quot;kafka-0.kafka-headless.logging.svc.cluster.local:9092&quot; codec =&gt; json consumer_threads =&gt; 3 topics =&gt; [&quot;messages&quot;] } }</span>
<a id=__codelineno-52-20 name=__codelineno-52-20 href=#__codelineno-52-20></a><span class=w>    </span><span class=no>filter {}  # 过滤配置（比如可以删除key、添加geoip等等）</span>
<a id=__codelineno-52-21 name=__codelineno-52-21 href=#__codelineno-52-21></a><span class=w>    </span><span class=no>output { elasticsearch { hosts =&gt; [ &quot;elasticsearch-client:9200&quot; ] user =&gt; &quot;elastic&quot; password =&gt; &quot;oschina&quot; index =&gt; &quot;logstash-k8s-%{+YYYY.MM.dd}&quot; } stdout { codec =&gt; rubydebug } }</span>
<a id=__codelineno-52-22 name=__codelineno-52-22 href=#__codelineno-52-22></a>
<a id=__codelineno-52-23 name=__codelineno-52-23 href=#__codelineno-52-23></a><span class=nt>volumeClaimTemplate</span><span class=p>:</span>
<a id=__codelineno-52-24 name=__codelineno-52-24 href=#__codelineno-52-24></a><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;ReadWriteOnce&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-52-25 name=__codelineno-52-25 href=#__codelineno-52-25></a><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">efk-nfs</span>
<a id=__codelineno-52-26 name=__codelineno-52-26 href=#__codelineno-52-26></a><span class=w>  </span><span class=nt>resources</span><span class=p>:</span>
<a id=__codelineno-52-27 name=__codelineno-52-27 href=#__codelineno-52-27></a><span class=w>    </span><span class=nt>requests</span><span class=p>:</span>
<a id=__codelineno-52-28 name=__codelineno-52-28 href=#__codelineno-52-28></a><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10Gi</span>
</code></pre></div></p> <p>其中最重要的就是通过 logstashPipeline 配置 logstash 数据流的处理配置，通过 input 指定日志源 kafka 的配置，通过 output 输出到 Elasticsearch，同样直接使用上面的 Values 文件安装 logstash 即可：</p> <p><div class=highlight><pre><span></span><code><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a>$<span class=w> </span>helm<span class=w> </span>upgrade<span class=w> </span>--install<span class=w> </span>logstash<span class=w> </span>-f<span class=w> </span>values-prod.yaml<span class=w> </span>--namespace<span class=w> </span>logging<span class=w> </span>.
<a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a>Release<span class=w> </span><span class=s2>&quot;logstash&quot;</span><span class=w> </span>does<span class=w> </span>not<span class=w> </span>exist.<span class=w> </span>Installing<span class=w> </span>it<span class=w> </span>now.
<a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a>NAME:<span class=w> </span>logstash
<a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a>LAST<span class=w> </span>DEPLOYED:<span class=w> </span>Thu<span class=w> </span>Jun<span class=w>  </span><span class=m>9</span><span class=w> </span><span class=m>15</span>:02:49<span class=w> </span><span class=m>2022</span>
<a id=__codelineno-53-5 name=__codelineno-53-5 href=#__codelineno-53-5></a>NAMESPACE:<span class=w> </span>logging
<a id=__codelineno-53-6 name=__codelineno-53-6 href=#__codelineno-53-6></a>STATUS:<span class=w> </span>deployed
<a id=__codelineno-53-7 name=__codelineno-53-7 href=#__codelineno-53-7></a>REVISION:<span class=w> </span><span class=m>1</span>
<a id=__codelineno-53-8 name=__codelineno-53-8 href=#__codelineno-53-8></a>TEST<span class=w> </span>SUITE:<span class=w> </span>None
<a id=__codelineno-53-9 name=__codelineno-53-9 href=#__codelineno-53-9></a>NOTES:
<a id=__codelineno-53-10 name=__codelineno-53-10 href=#__codelineno-53-10></a><span class=m>1</span>.<span class=w> </span>Watch<span class=w> </span>all<span class=w> </span>cluster<span class=w> </span>members<span class=w> </span>come<span class=w> </span>up.
<a id=__codelineno-53-11 name=__codelineno-53-11 href=#__codelineno-53-11></a><span class=w>  </span>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>--namespace<span class=o>=</span>logging<span class=w> </span>-l<span class=w> </span><span class=nv>app</span><span class=o>=</span>logstash<span class=w> </span>-w
</code></pre></div> 安装启动完成后可以查看 logstash 的日志：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>--namespace<span class=o>=</span>logging<span class=w> </span>-l<span class=w> </span><span class=nv>app</span><span class=o>=</span>logstash
<a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a>NAME<span class=w>         </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>   </span>AGE
<a id=__codelineno-54-3 name=__codelineno-54-3 href=#__codelineno-54-3></a>logstash-0<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>2m8s
<a id=__codelineno-54-4 name=__codelineno-54-4 href=#__codelineno-54-4></a>
<a id=__codelineno-54-5 name=__codelineno-54-5 href=#__codelineno-54-5></a>$<span class=w> </span>kubectl<span class=w> </span>logs<span class=w> </span>-f<span class=w> </span>logstash-0<span class=w> </span>-n<span class=w> </span>logging
<a id=__codelineno-54-6 name=__codelineno-54-6 href=#__codelineno-54-6></a>......
<a id=__codelineno-54-7 name=__codelineno-54-7 href=#__codelineno-54-7></a><span class=o>{</span>
<a id=__codelineno-54-8 name=__codelineno-54-8 href=#__codelineno-54-8></a><span class=w>      </span><span class=s2>&quot;@version&quot;</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=s2>&quot;1&quot;</span>,
<a id=__codelineno-54-9 name=__codelineno-54-9 href=#__codelineno-54-9></a><span class=w>        </span><span class=s2>&quot;stream&quot;</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=s2>&quot;stdout&quot;</span>,
<a id=__codelineno-54-10 name=__codelineno-54-10 href=#__codelineno-54-10></a><span class=w>    </span><span class=s2>&quot;@timestamp&quot;</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=m>2022</span>-06-09T07:09:16.889Z,
<a id=__codelineno-54-11 name=__codelineno-54-11 href=#__codelineno-54-11></a><span class=w>       </span><span class=s2>&quot;message&quot;</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=s2>&quot;4672: Thu Jun  9 07:09:15 UTC 2022&quot;</span>,
<a id=__codelineno-54-12 name=__codelineno-54-12 href=#__codelineno-54-12></a><span class=w>    </span><span class=s2>&quot;kubernetes&quot;</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span>
<a id=__codelineno-54-13 name=__codelineno-54-13 href=#__codelineno-54-13></a><span class=w>         </span><span class=s2>&quot;container_image&quot;</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=s2>&quot;docker.io/library/busybox:latest&quot;</span>,
<a id=__codelineno-54-14 name=__codelineno-54-14 href=#__codelineno-54-14></a><span class=w>          </span><span class=s2>&quot;container_name&quot;</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=s2>&quot;count&quot;</span>,
<a id=__codelineno-54-15 name=__codelineno-54-15 href=#__codelineno-54-15></a><span class=w>                  </span><span class=s2>&quot;labels&quot;</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span>
<a id=__codelineno-54-16 name=__codelineno-54-16 href=#__codelineno-54-16></a><span class=w>            </span><span class=s2>&quot;logging&quot;</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=s2>&quot;true&quot;</span>
<a id=__codelineno-54-17 name=__codelineno-54-17 href=#__codelineno-54-17></a><span class=w>        </span><span class=o>}</span>,
<a id=__codelineno-54-18 name=__codelineno-54-18 href=#__codelineno-54-18></a><span class=w>                </span><span class=s2>&quot;pod_name&quot;</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=s2>&quot;counter&quot;</span>,
<a id=__codelineno-54-19 name=__codelineno-54-19 href=#__codelineno-54-19></a><span class=w>          </span><span class=s2>&quot;namespace_name&quot;</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=s2>&quot;default&quot;</span>,
<a id=__codelineno-54-20 name=__codelineno-54-20 href=#__codelineno-54-20></a><span class=w>                  </span><span class=s2>&quot;pod_ip&quot;</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=s2>&quot;10.244.2.118&quot;</span>,
<a id=__codelineno-54-21 name=__codelineno-54-21 href=#__codelineno-54-21></a><span class=w>                    </span><span class=s2>&quot;host&quot;</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=s2>&quot;node2&quot;</span>,
<a id=__codelineno-54-22 name=__codelineno-54-22 href=#__codelineno-54-22></a><span class=w>        </span><span class=s2>&quot;namespace_labels&quot;</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{</span>
<a id=__codelineno-54-23 name=__codelineno-54-23 href=#__codelineno-54-23></a><span class=w>            </span><span class=s2>&quot;kubernetes_io/metadata_name&quot;</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=s2>&quot;default&quot;</span>
<a id=__codelineno-54-24 name=__codelineno-54-24 href=#__codelineno-54-24></a><span class=w>        </span><span class=o>}</span>
<a id=__codelineno-54-25 name=__codelineno-54-25 href=#__codelineno-54-25></a><span class=w>    </span><span class=o>}</span>,
<a id=__codelineno-54-26 name=__codelineno-54-26 href=#__codelineno-54-26></a><span class=w>        </span><span class=s2>&quot;docker&quot;</span><span class=w> </span><span class=o>=</span>&gt;<span class=w> </span><span class=o>{}</span>
<a id=__codelineno-54-27 name=__codelineno-54-27 href=#__codelineno-54-27></a><span class=o>}</span>
</code></pre></div> <p>由于我们启用了 debug 日志调试，所以我们可以在 logstash 的日志中看到我们采集的日志消息，到这里证明我们的日志数据就获取成功了。</p> <p>现在我们可以登录到 Kibana 可以看到有如下所示的索引数据了：</p> <p><img alt class=zoom src=../../../assets/static/kubernetes/5/elastic-sy05.png></p> <p>然后同样创建索引模式，匹配上面的索引即可： <img alt class=zoom src=../../../assets/static/kubernetes/5/elastic-sy06.png></p> <p>创建完成后就可以前往发现页面过滤日志数据了。</p> <p>到这里我们就实现了一个使用 Fluentd+Kafka+Logstash+Elasticsearch+Kibana 的 Kubernetes 日志收集工具栈，这里我们完整的 Pod 信息如下所示： <div class=highlight><pre><span></span><code><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>logging
<a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a>NAME<span class=w>                            </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>   </span>AGE
<a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a>elasticsearch-client-0<span class=w>          </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>128m
<a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a>elasticsearch-data-0<span class=w>            </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>128m
<a id=__codelineno-55-5 name=__codelineno-55-5 href=#__codelineno-55-5></a>elasticsearch-master-0<span class=w>          </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>128m
<a id=__codelineno-55-6 name=__codelineno-55-6 href=#__codelineno-55-6></a>fluentd-6k52h<span class=w>                   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>61m
<a id=__codelineno-55-7 name=__codelineno-55-7 href=#__codelineno-55-7></a>fluentd-cw72c<span class=w>                   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>61m
<a id=__codelineno-55-8 name=__codelineno-55-8 href=#__codelineno-55-8></a>fluentd-dn4hs<span class=w>                   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>61m
<a id=__codelineno-55-9 name=__codelineno-55-9 href=#__codelineno-55-9></a>kafka-0<span class=w>                         </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>3</span><span class=w>          </span>134m
<a id=__codelineno-55-10 name=__codelineno-55-10 href=#__codelineno-55-10></a>kafka-client<span class=w>                    </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>125m
<a id=__codelineno-55-11 name=__codelineno-55-11 href=#__codelineno-55-11></a>kafka-zookeeper-0<span class=w>               </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>134m
<a id=__codelineno-55-12 name=__codelineno-55-12 href=#__codelineno-55-12></a>kibana-kibana-66f97964b-qqjgg<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>128m
<a id=__codelineno-55-13 name=__codelineno-55-13 href=#__codelineno-55-13></a>logstash-0<span class=w>                      </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>13m
</code></pre></div></p> <p>当然在实际的工作项目中还需要我们根据实际的业务场景来进行参数性能调优以及高可用等设置，以达到系统的最优性能。</p> <p>上面我们在配置 logstash 的时候是将日志输出到 "logstash-k8s-%{+YYYY.MM.dd}" 这个索引模式的，可能有的场景下只通过日期去区分索引不是很合理， 那么我们可以根据自己的需求去修改索引名称，比如可以根据我们的服务名称来进行区分，那么这个服务名称可以怎么来定义呢？可以是 Pod 的名称或者通过 label 标签去指定， 比如我们这里去做一个规范，要求需要收集日志的 Pod 除了需要添加 logging: true 这个标签之外，还需要添加一个<code>logIndex: &lt;索引名&gt;</code>的标签。</p> <p>比如重新更新我们测试的 counter 应用： <div class=highlight><pre><span></span><code><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-56-4 name=__codelineno-56-4 href=#__codelineno-56-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">counter</span>
<a id=__codelineno-56-5 name=__codelineno-56-5 href=#__codelineno-56-5></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<a id=__codelineno-56-6 name=__codelineno-56-6 href=#__codelineno-56-6></a><span class=w>    </span><span class=nt>logging</span><span class=p>:</span><span class=w> </span><span class=s>&quot;true&quot;</span><span class=w> </span><span class=c1># 一定要具有该标签才会被采集</span>
<a id=__codelineno-56-7 name=__codelineno-56-7 href=#__codelineno-56-7></a><span class=w>    </span><span class=nt>logIndex</span><span class=p>:</span><span class=w> </span><span class=s>&quot;test&quot;</span><span class=w>  </span><span class=c1># 指定索引名称</span>
<a id=__codelineno-56-8 name=__codelineno-56-8 href=#__codelineno-56-8></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-56-9 name=__codelineno-56-9 href=#__codelineno-56-9></a><span class=w>  </span><span class=nt>containers</span><span class=p>:</span>
<a id=__codelineno-56-10 name=__codelineno-56-10 href=#__codelineno-56-10></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">count</span>
<a id=__codelineno-56-11 name=__codelineno-56-11 href=#__codelineno-56-11></a><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<a id=__codelineno-56-12 name=__codelineno-56-12 href=#__codelineno-56-12></a><span class=w>      </span><span class=nt>args</span><span class=p>:</span>
<a id=__codelineno-56-13 name=__codelineno-56-13 href=#__codelineno-56-13></a><span class=w>        </span><span class="p p-Indicator">[</span>
<a id=__codelineno-56-14 name=__codelineno-56-14 href=#__codelineno-56-14></a><span class=w>          </span><span class=nv>/bin/sh</span><span class="p p-Indicator">,</span>
<a id=__codelineno-56-15 name=__codelineno-56-15 href=#__codelineno-56-15></a><span class=w>          </span><span class=nv>-c</span><span class="p p-Indicator">,</span>
<a id=__codelineno-56-16 name=__codelineno-56-16 href=#__codelineno-56-16></a><span class=w>          </span><span class=s>&#39;i=0;</span><span class=nv> </span><span class=s>while</span><span class=nv> </span><span class=s>true;</span><span class=nv> </span><span class=s>do</span><span class=nv> </span><span class=s>echo</span><span class=nv> </span><span class=s>&quot;$i:</span><span class=nv> </span><span class=s>$(date)&quot;;</span><span class=nv> </span><span class=s>i=$((i+1));</span><span class=nv> </span><span class=s>sleep</span><span class=nv> </span><span class=s>1;</span><span class=nv> </span><span class=s>done&#39;</span><span class="p p-Indicator">,</span>
<a id=__codelineno-56-17 name=__codelineno-56-17 href=#__codelineno-56-17></a><span class=w>        </span><span class="p p-Indicator">]</span>
</code></pre></div></p> <p>然后重新更新 logstash 的配置，修改 values 配置： <div class=highlight><pre><span></span><code><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a><span class=c1># ......</span>
<a id=__codelineno-57-2 name=__codelineno-57-2 href=#__codelineno-57-2></a><span class=nt>logstashPipeline</span><span class=p>:</span>
<a id=__codelineno-57-3 name=__codelineno-57-3 href=#__codelineno-57-3></a><span class=w>  </span><span class=nt>logstash.conf</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span>
<a id=__codelineno-57-4 name=__codelineno-57-4 href=#__codelineno-57-4></a><span class=w>    </span><span class=no>input { kafka { bootstrap_servers =&gt; &quot;kafka-0.kafka-headless.logging.svc.cluster.local:9092&quot; codec =&gt; json consumer_threads =&gt; 3 topics =&gt; [&quot;messages&quot;] } }</span>
<a id=__codelineno-57-5 name=__codelineno-57-5 href=#__codelineno-57-5></a><span class=w>    </span><span class=no>filter {}  # 过滤配置（比如可以删除key、添加geoip等等）</span>
<a id=__codelineno-57-6 name=__codelineno-57-6 href=#__codelineno-57-6></a><span class=w>    </span><span class=no>output { elasticsearch { hosts =&gt; [ &quot;elasticsearch-client:9200&quot; ] user =&gt; &quot;elastic&quot; password =&gt; &quot;oschina&quot; index =&gt; &quot;k8s-%{[kubernetes][labels][logIndex]}-%{+YYYY.MM.dd}&quot; } stdout { codec =&gt; rubydebug } }</span>
<a id=__codelineno-57-7 name=__codelineno-57-7 href=#__codelineno-57-7></a><span class=c1># ......</span>
</code></pre></div></p> <p>使用上面的 values 值更新 logstash，正常更新后上面的 counter 这个 Pod 日志会输出到一个名为 k8s-test-2022.06.09 的索引去。 <img alt class=zoom src=../../../assets/static/kubernetes/5/elastic-sy07.png></p> <p>这样我们就实现了自定义索引名称，当然你也可以使用 Pod 名称、容器名称、命名空间名称来作为索引的名称，这完全取决于你自己的需求。</p> <div class="admonition example"> <p class=admonition-title>Elasticsearch集群性能优化实践</p> <p><a href=https://cloud.tencent.com/developer/article/1775059>https://cloud.tencent.com/developer/article/1775059</a></p> </div> <h2 id=3-参考文献>3. 参考文献<a class=headerlink href=#3-参考文献 title="Permanent link">&para;</a></h2> <div class="admonition abstract"> <p class=admonition-title>参考文献</p> <p><a href=https://mp.weixin.qq.com/s/lPeYavvFJ6GdivkT0iwTGw>https://mp.weixin.qq.com/s/lPeYavvFJ6GdivkT0iwTGw</a> <a href=https://docs.youdianzhishi.com/k8s/logging/efk/ >https://docs.youdianzhishi.com/k8s/logging/efk/</a></p> </div> <hr> <div class=md-source-file> <small> 最后更新: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">March 27, 2023 16:00:20</span> <br> 创建日期: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">March 23, 2023 18:59:28</span> </small> </div> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> Was this page helpful? </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title="This page was helpful" data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title="This page could be improved" data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> Thanks for your feedback! </div> <div data-md-value=0 hidden> Thanks for your feedback! Help us improve this page by using our <a href="https://github.com/hujianli94/hujianli94.github.io/issues/new/?title=[Feedback]+Kubernetes%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86+-+/Kubernetes/5.%E8%BF%90%E7%BB%B4%E7%AF%87/14.Kubernetes%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/" target=_blank>feedback form</a>. </div> </div> </div> </fieldset> </form> </article> </div> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=页脚> <a href=../../4.%E9%AB%98%E7%BA%A7%E7%AF%87/13.%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%B9%E5%99%A8%E5%8C%96/ class="md-footer__link md-footer__link--prev" aria-label="上一页: 中间件容器化" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> 上一页 </span> <div class=md-ellipsis> 中间件容器化 </div> </div> </a> <a href=../15.Kubernetes%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/ class="md-footer__link md-footer__link--next" aria-label="下一页: Kubernetes监控告警" rel=next> <div class=md-footer__title> <span class=md-footer__direction> 下一页 </span> <div class=md-ellipsis> Kubernetes监控告警 </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2023 - 2024 hujainli94 </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/hujianli94 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://kaliarch-bucket-1251990360.cos.ap-beijing.myqcloud.com/blog_img/20220125122524.png target=_blank rel=noopener title=kaliarch-bucket-1251990360.cos.ap-beijing.myqcloud.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M385.2 167.6c6.4 0 12.6.3 18.8 1.1C387.4 90.3 303.3 32 207.7 32 100.5 32 13 104.8 13 197.4c0 53.4 29.3 97.5 77.9 131.6l-19.3 58.6 68-34.1c24.4 4.8 43.8 9.7 68.2 9.7 6.2 0 12.1-.3 18.3-.8-4-12.9-6.2-26.6-6.2-40.8-.1-84.9 72.9-154 165.3-154zm-104.5-52.9c14.5 0 24.2 9.7 24.2 24.4 0 14.5-9.7 24.2-24.2 24.2-14.8 0-29.3-9.7-29.3-24.2.1-14.7 14.6-24.4 29.3-24.4zm-136.4 48.6c-14.5 0-29.3-9.7-29.3-24.2 0-14.8 14.8-24.4 29.3-24.4 14.8 0 24.4 9.7 24.4 24.4 0 14.6-9.6 24.2-24.4 24.2zM563 319.4c0-77.9-77.9-141.3-165.4-141.3-92.7 0-165.4 63.4-165.4 141.3S305 460.7 397.6 460.7c19.3 0 38.9-5.1 58.6-9.9l53.4 29.3-14.8-48.6C534 402.1 563 363.2 563 319.4zm-219.1-24.5c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.8 0 24.4 9.7 24.4 19.3 0 10-9.7 19.6-24.4 19.6zm107.1 0c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.5 0 24.4 9.7 24.4 19.3.1 10-9.9 19.6-24.4 19.6z"/></svg> </a> <a href="mailto:<1879324764@qq.com>" target=_blank rel=noopener title=发送邮件 class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.7l167.6-182.9c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">同意</button> <label class=md-button for=__settings>管理设定</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script> <script id=__config type=application/json>{"base": "../../..", "features": ["content.action.edit", "content.action.view", "content.code.copy", "content.code.annotate", "navigation.indexes", "navigation.footer", "navigation.indexes", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest"], "search": "../../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../../assets/javascripts/bundle.220ee61c.min.js></script> <script src=../../../javascripts/extra.js></script> <script src=https://file.cdn.shafish.cn/blog/js/video.min.js></script> </body> </html>