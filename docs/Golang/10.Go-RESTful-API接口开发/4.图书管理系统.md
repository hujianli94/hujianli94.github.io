# 4.图书管理系统


## 1 初始化项目环境

### 1.1 go常用项目结构


bookManage项目结构

```shell
.
├── README.md               # 项目说明（帮助你快速的属性和了解项目） 
├── config                  # 配置文件（mysql配置 ip 端口 用户名 密码，不能写死到代码中） 
├── controller              # CLD：服务入口，负责处理路由、参数校验、请求转发 
├── service                 # CLD：逻辑（服务）层，负责业务逻辑处理 
├── dao                     # CLD：负责数据与存储相关功能（mysql、redis、ES等） 
│	├── mysql 
├── model                   # 模型（定义表结构） 
├── logging                 # 日志处理 
├── main.go                 # 项目启动入口
├── middleware              # 中间件 
├── pkg                     # 公共服务（所有模块都能访问的服务） 
├── router                  # 路由（路由分发
```

### 1.2 创建数据库
```shell
mysql> create database books charset utf8;
```


### 1.3 当前项目架构

```shell
go mod init bookManage
```
图书管理服务:

1. 用户服务：登录，注册 
2. 书籍服务：对书籍的增删改查的操作

```shell
.
├── controller    # CLD：服务入口，负责处理路由、参数校验、请求转发 
│ 	├── book.go 
│ 	└── user.go 
├── dao           # CLD：负责数据与存储相关功能（mysql、redis、ES等） 
│ 	└── mysql 
│	 └── mysql.go 
├── main.go       # 项目启动入口 
├── middleware    # 中间件: token验证 
│ 	└── auth.go 
├── model         # 模型 
│	 ├── book.go 
│	 ├── user.go 
│ 	└── user_m2m_book.go 
└── router        # 路由 
  ├── api_router.go 
  ├── init_router.go 
  └── test_router.go
```


## 2 添加路由分层


### 2.1 main.go

```go
// bookManage project main.go
package main

import "bookManage/router"

/**
 * @author hujianli
 */
func main() {
	//1、初始化路由分层，将实例化router服务的方法拆分到router文件下
	r := router.InitRouter()
	r.Run(":8888")
}

```


### 2.2 router/init_router.go

```go
package router

import (
	"github.com/gin-gonic/gin"
)

/**
 * @author hujianli
 * 加载其他路由文件中的路由
 */

// 这个方法作用：初始化其他文件中的路由
func InitRouter() *gin.Engine {
	//初始化gin服务
	r := gin.Default()
	TestRouters(r)
	//SetupApiRouters(r)
	return r
}
```


### 2.3 router/test_router.go


```go
package router

import "github.com/gin-gonic/gin"

/**
 * @author hujianli
 */
func TestRouters(r *gin.Engine) {
	v1 := r.Group("/api/v1")
	v1.GET("test", TestHandler)
}

// 测试路由访问，http://127.0.0.1:8888/api/v1/test
func TestHandler(c *gin.Context) {
	c.String(200, "ok")
}
```

测试路由访问，`http://127.0.0.1:8888/api/v1/test`说明路由分组已经跑通了。



## 3 初始化mysql连接


### 3.1 main.go


```go
// bookManage project main.go
package main

import (
	"bookManage/dao/mysql"
	"bookManage/router"
)

/**
 * @author hujianli
 */
func main() {
	// 初始化mysql连接
	mysql.InitMysql()

	//初始化路由分层，将实例化router服务的方法拆分到router文件下
	r := router.InitRouter()
	r.Run(":8888")
}

```

### 3.2 dao/mysql/mysql.go

```go
// mysql project mysql.go
package mysql

import (
	"fmt"

	gmysql "gorm.io/driver/mysql"
	"gorm.io/gorm"
)

/**
 * @author hujianli
 */
var DB *gorm.DB

func InitMysql() {
	//1、连接数据库
	dsn := "root:124456@tcp(127.0.0.1:4406)/books?charset=utf8mb4&parseTime=True&loc=Local"
	db, err := gorm.Open(gmysql.Open(dsn), &gorm.Config{})
	if err != nil {
		fmt.Println("初始化mysql连接错误", err)
	}
	DB = db
}
```


## 4 定义多对多表结构

书和用户是多对多的关系。

书可以供多个用户借阅,一个用户也可以借阅过多本书，所以是多对多


### 4.1 model/user.go


```go
package model

/**
 * @author hujianli
 */
type User struct {
	Id       int64  `gorm:"primary_key" json:"id"`
	Username string `gorm:"not null" json:"username" binging:"required"`
	Password string `gorm:"not null" json:"password" binding:"required"`
	Token    string `json:"token"`
}

func (User) TableName() string {
	return "user"
}

```


### 4.2 model/book.go

```go
package model

/*
@author hujianli
*/
type Book struct {
	Id   int64  `gorm:"primary_key" json:"id"`
	Name string `gorm:"not null" json:"Name" binding:"required"`
	Desc string `json:"desc"`
	//一本书多个用户借阅过,一个用户也可以借阅过多本书，所以是多对多
	Users []User `gorm:"many2many:book_users;"`
}

func (Book) TableName() string {
	return "book"
}
```


### 4.3 model/user_m2m_book.go

```go
package model

/*
@author hujianli
*/

// 自定义第三张表
type BookUser struct {
	UserID int64 `gorm:"primaryKey"`
	BookID int64 `gorm:"primaryKey"`
}
```



### 4.4 自动生成表结构

dao/mysql/mysql.go


```go
// mysql project mysql.go
package mysql

import (
	"fmt"

	"bookManage/model"

	gmysql "gorm.io/driver/mysql"
	"gorm.io/gorm"
)

/**
 * @author hujianli
 */
var DB *gorm.DB

func InitMysql() {
	//1、连接数据库
	dsn := "root:123456@tcp(127.0.0.1:3306)/books?charset=utf8mb4&parseTime=True&loc=Local"
	db, err := gorm.Open(gmysql.Open(dsn), &gorm.Config{})
	if err != nil {
		fmt.Println("初始化mysql连接错误", err)
	}
	DB = db

	//自动创建表结构
	if err := DB.AutoMigrate(model.User{}, model.Book{}); err != nil {
		fmt.Println("自动创建表结构失败：", err)
	}
}
```

## 5 注册登录


### 5.1 router/init_router.go


```go
package router

import (
	"github.com/gin-gonic/gin"
)

/**
 * @author hujianli
 * 加载其他路由文件中的路由
 */

// 这个方法作用：初始化其他文件中的路由
func InitRouter() *gin.Engine {
	//初始化gin服务
	r := gin.Default()
	TestRouters(r)
	SetupApiRouters(r)
	return r
}
```

### 5.2 router/api_router.go


```go
package router

import (
	"bookManage/controller"

	"github.com/gin-gonic/gin"
)

/**
 * @author hujianli
 */
func SetupApiRouters(r *gin.Engine) {
	r.POST("/register", controller.RegisterHandler)
	r.POST("/login", controller.LoginHandler)
}
```


### 5.3 controller/user.go

```go
package controller

import (
	"bookManage/dao/mysql"
	"bookManage/model"
	"crypto/sha256"
	"encoding/hex"

	"github.com/gin-gonic/gin"
)

/**
@author hujianli
*/

// 密码加密函数
func encryptPassword(password string) string {
	hash := sha256.Sum256([]byte(password))
	encryptedPassword := hex.EncodeToString(hash[:])
	return encryptedPassword
}

// 比对密码函数
func comparePasswords(hashedPassword string, password string) bool {
	encryptedPassword := encryptPassword(password)
	return hashedPassword == encryptedPassword
}

// 注册
func RegisterHandler(c *gin.Context) {
	p := new(model.User)
	//参数校验
	if err := c.ShouldBindJSON(p); err != nil {
		c.JSON(400, gin.H{"err": err.Error()})
		return
	}
	// 这里应该是客户端已加密后的密码
	password := p.Password
	p.Password = encryptPassword(password)

	mysql.DB.Create(p)
	c.JSON(200, gin.H{"msg": p})
}

// 登录
func LoginHandler(c *gin.Context) {
	p := new(model.User)
	//参数校验
	if err := c.ShouldBindJSON(p); err != nil {
		c.JSON(400, gin.H{"err": err.Error()})
		return
	}

	//查找用户
	var user model.User
	result := mysql.DB.Where(&model.User{Username: p.Username}).First(&user)
	if result.Error != nil {
		c.JSON(403, gin.H{"msg": "用户名密码错误"})
		return
	}

	//比对密码
	if !comparePasswords(user.Password, p.Password) {
		c.JSON(403, gin.H{"msg": "用户名密码错误"})
		return
	}

	//生成token
	token := generateToken(user.ID)
	mysql.DB.Model(&user).Update("token", token)
	c.JSON(200, gin.H{"token": token})
}
```


### 5.4 测试注册功能

```shell
POST:http://127.0.0.1:8888/register
{ 
"username": "hujianli",
"password": "oschina"
} 
```


### 5.5 登录获取token

```shell
POST:http://127.0.0.1:8888/login
{ 
"username": "lisi", 
"password": "123456" 
}
```
