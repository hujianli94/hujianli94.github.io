# Go的常见ORM库

## 1.什么是ORM

ORM(Object--Relation Mapping,对象关系映射)的作用是在关系型数据库和对象之间做个映射。

这样在具体操作数据库时，就不需要再去和复杂的SQL语句打交道，只需要像平时操作对象一样操作它即可。

- O（Object,对象模型)：实体对象，即在程序中根据数据库表结构建立的一个个实体(Entity)。 
- R（Relation,关系型数据库的数据结构)：建立的数据库表。 
- M(Mapping,映射)：从R(数据库)到O(对象模型)的映射，常用XML文件来表示映射关系。



ORM(Object-relational mapping)，中文翻译为对象关系映射，是一种为了解决面向对象与关系数据库存在的互不匹配的现象的技术。


**简单的说，ORM是通过使用描述对象和数据库之间映射的元数据，将程序中的对象自动持久化到关系数据库中**



## 为什么要用ORM
想必有读者会想，既然G0本身就有MySQL等数据库的访问包，为什么还要做持久化和ORM设计呢？

那是因为，在程序开发中，在数据库保存的表中，字段与程序中的实体类之间是没有关联的，这样在实现持久化时就比较不方便。


那到底如何实现持久化呢？

一种简单的方案是：采用硬编码方式，为每一种可能的数据库访问操作提供单独的方法。

这种方案存在以下不足。

- 持久化层缺乏弹性。一旦出现业务需求的变更，就必须修改持久化层的接口。
- 持久化层同时与域模型和关系数据库模型绑定，不管域模型还是关系数据库模型发生变化，都要修改持久化层的相关程序代码。这增加了软件的维护难度。

ORM提供了实现持久化层的另一种模式：它采用映射元数据来描述对象关系的映射，使得 ORM中间件能在任何一个应用的业务逻辑层和数据库层之间充当桥梁。 

ORM的方法论基于以下3个核心原则。
- 简单：以最基本的形式建模数据。
- 传达性：数据库结构要使用尽可能被人理解的语言进行文档化。
- 精确性：基于数据模型创建正确标准化了的结构。

在目前的企业应用系统设计中，MVC是主要的系统架构模式。MVC中的Mod!包含了复杂的业务逻辑和数据逻辑，以及数据存取机制（如数据库的连接、SQL生成和Statement创建、 ResultSet结果集的读取等)等。


将这些复杂的业务逻辑和数据逻辑分离，可以将系统的紧耦合关系转化为松耦合关系（即解耦合)，是降低系统耦合度迫切要做的，也是持久化要做的工作。
MVC模式实现了在架构上将表现层(即View)和数据处理层（即Model)分离的解耦合，而持久化的设计则实现了数据处理层内部的业务逻辑和数据逻辑分离的解耦合。


ORM作为持久化设计中的最重要也最复杂的技术，是目前业界的热点技术。

接下来一起探究以下G0语言中常见的ORM框架。


## 3.Gorm的安装及使用

Gorm的安装 Gorm的安装方法很简单，在Liux系统中直接打开命令行终端，输入如下命令即可：


```sh
go get -u github.com/jinzhu/gorm
```


### 3.1 gorm+mysql


使用gorm和mysql连接初始化

```go
package main

import (
	_ "github.com/go-sql-driver/mysql"
	"github.com/jinzhu/gorm"
)

func main() {
	db, err := gorm.Open("mysql", "root:123456@(127.0.0.1:3306)/chapter4?"+
		"charset=utf8mb4&parseTime=True&loc=Local")
	if err != nil {
		panic(err)
	}
	defer db.Close()
	db.DB().SetMaxIdleConns(10)
	db.DB().SetMaxOpenConns(100)
}

```

使用gorm+mysql进行增删改查

```go
package main

import (
	"github.com/jinzhu/gorm"
	_ "github.com/jinzhu/gorm/dialects/mysql"
)

// User2 用户信息
type User2 struct {
	//gorm.Model
	Id    int
	Name  string
	Phone string
}

var (
	db            *gorm.DB
	sqlConnection = "root:123456@tcp(127.0.0.1:3306)/chapter4?" +
		"charset=utf8&parseTime=true"
)

//初始化
func init() {
	//打开数据库连接
	var err error
	db, err = gorm.Open("mysql", sqlConnection)
	if err != nil {
		panic("failed to connect database")
	}

	db.AutoMigrate(&User2{})
}

func main() {
	defer db.Close()
	db.DB().SetMaxIdleConns(10)
	db.DB().SetMaxOpenConns(100)

	// 自动迁移
	//db.AutoMigrate(&UserInfo{})

	u1 := &User2{3, "laoshu", "18888888888"}
	//u2 := UserInfo{7,"hunya", "18777777777"}
	// 创建记录
	db.Save(&u1)   //保存到数据库
	db.Create(&u1) //保存到数据库
	//db.Create(&u2)
	// 查询
	//var u = new(UserInfo)
	//db.First(u)
	//fmt.Printf("%#v\n", u)
	//var uu UserInfo
	//db.Find(&uu, "name=?", "laoshu")
	//fmt.Printf("%#v\n", uu)
	//// 更新
	//db.Model(&u).Update("name", "milaoshu")
	//// 删除
	//db.Delete(&u)
}
```


```go
package main

import (
	"crypto/md5"
	"encoding/hex"
	"log"
	"os"

	_ "github.com/go-sql-driver/mysql"
	"github.com/jinzhu/gorm"
)

var (
	db            *gorm.DB
	sqlConnection = "root:123456@tcp(127.0.0.1:3306)/chapter4?" +
		"charset=utf8&parseTime=true"
)

// 数据表结构体类
type GormUser struct {
	ID       uint   `json:"id"`
	Phone    string `json:"phone"`
	Name     string `json:"name"`
	Password string `json:"password"`
}

//初始化
func init() {
	//打开数据库连接
	var err error
	db, err = gorm.Open("mysql", sqlConnection)
	if err != nil {
		panic("failed to connect database")
	}

	db.AutoMigrate(&GormUser{})
}

func main() {
	defer db.Close()

	// 创建用户
	GormUser := GormUser{
		Phone:    "13888888888",
		Name:     "Shirdon",
		Password: md5Password("666666"), //用户密码
	}
	db.Save(&GormUser)   //保存到数据库
	db.Create(&GormUser) //保存到数据库

	//查询用户
	// var GormUser = new(GormUser)
	// db.Where("phone = ?", "13888888888").Find(&GormUser)
	// db.First(&GormUser, "phone = ?", "13888888888")
	// fmt.Println(GormUser)

	////更新用户
	//var GormUser = new(GormUser)
	//err:=db.Model(&GormUser).Where("phone = ?", "18888888888").
	//	Update("phone", "13888888888").Error
	//if err !=nil {
	//	//
	//}
	//
	////删除用户
	//var GormUser = new(GormUser)
	//db.Where("phone = ?", "13888888888").Delete(&GormUser)

  //// Gorm中事务的处理也很简单：用db.Begin()方法声明开启事务，用tx.Commit()方法结束事务，在异常时调用tx.Rollback()方法回滚。事务处理的示例代码如下：
	////开启事务
	//tx := db.Begin()
	//
	//GormUser := GormUser{
	//	Phone:    "18888888888",
	//	Name:     "Shirdon",
	//	Password: md5Password("666666"), //用户密码
	//}
	//if err := tx.Create(&GormUser).Error; err != nil {
	//	//事务回滚
	//	tx.Rollback()
	//	fmt.Println(err)
	//}
	//db.First(&GormUser, "phone = ?", "18888888888")
	////事务提交
	//tx.Commit()

  // Gom中还可以使用如下方式设置日志输出级别，以及改变日志的输出地方：
	db.LogMode(true)
	db.SetLogger(log.New(os.Stdout, "\r\n", 0))

}

//md5加密
func md5Password(str string) string {
	h := md5.New()
	h.Write([]byte(str))
	return hex.EncodeToString(h.Sum(nil))
}
```





### 3.2 gorm+sqlite
```go
package main

import (
	_ "github.com/mattn/go-sqlite3"
	"github.com/jinzhu/gorm"
	"crypto/md5"
	"encoding/hex"
	"fmt"
	"log"
	"os"
)

// 数据表结构体类
type GormUser struct {
	ID       uint   `json:"id"`
	Phone    string `json:"phone"`
	Name     string `json:"name"`
	Password string `json:"password"`
}

//md5加密
func md5Password(str string) string {
	h := md5.New()
	h.Write([]byte(str))
	return hex.EncodeToString(h.Sum(nil))
}

func main() {
	db, err := gorm.Open("sqlite3", `D:\soft\sqlite\gorm.db`)
	if err != nil {
		panic(err)
	}
	defer db.Close()
	
	db.DB().SetMaxIdleConns(10)
	db.DB().SetMaxOpenConns(10)
	
	db.AutoMigrate(&GormUser{})
		
	//创建用户
	GormUser := GormUser{
		Phone:    "13888888888",
		Name:     "Shirdon",
		Password: md5Password("666666"), //用户密码
	}
	db.Save(&GormUser) //保存到数据库
	//db.Create(&GormUser) //保存到数据库
	
	//删除用户
	//var GormUser = new(GormUser)
	db.Where("phone = ?", "13888888888").Delete(&GormUser)
	
	//查询用户
	//var GormUser = new(GormUser)
	db.Where("phone = ?", "18888888888").Find(&GormUser)
	//db.First(&GormUser, "phone = ?", "18888888888")
	fmt.Println(GormUser)
	
	//更新用户及错误处理
	//var GormUser = new(GormUser)
	err = db.Model(&GormUser).Where("phone = ?", "18888888888").Update("phone", "13888888888").Error
	if err != nil {
		panic(err)
	}
	
	//事务处理
	//开启事务
	tx := db.Begin()
	/*
	GormUser := GormUser{
		Phone:    "18888888888",
		Name:     "Shirdon",
		Password: md5Password("666666"), //用户密码
	}
	*/
	if err := tx.Create(&GormUser).Error; err != nil {
		//事务回滚
		tx.Rollback()
		fmt.Println(err)
	}
	db.First(&GormUser, "phone = ?", "18888888888")
	//事务提交
	tx.Commit()
	
	//日志处理
	db.LogMode(true)
	db.SetLogger(log.New(os.Stdout, "\r\n", 0))
}
```



## 4.Beego ORM-Go语言的ORM框架
