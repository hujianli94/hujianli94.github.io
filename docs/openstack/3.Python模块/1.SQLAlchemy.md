# 1.SQLAlchemy

```sh
pip install sqlalchemy
pip install mysql-connector-python
```


## 1.定义元信息，绑定到引擎

创建数据库表、初始化数据库

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Time    : 2024/4/18 14:02
# @Author  : hjl
# @Site    : 
# @File    : sample01.py
# @Software: PyCharm
# @Desc    :
# 使用sqlalchemy连接mysql
from sqlalchemy import create_engine, Column, Integer, String, ForeignKey
from sqlalchemy.orm import declarative_base
from sqlalchemy.orm import sessionmaker, relationship

# Test the connection by executing a simple query
Base = declarative_base()

# Replace 'username', 'password', 'host', 'port', and 'database_name' with your MySQL credentials
engine = create_engine('mysql+mysqlconnector://root:root@localhost:3306/testapp')
Session = sessionmaker(bind=engine)
session = Session()


class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, primary_key=True)
    name = Column(String(50))
    fullname = Column(String(50))
    nickname = Column(String(50))


class Address(Base):
    __tablename__ = 'addresses'
    id = Column(Integer, primary_key=True)
    email_address = Column(String(50))
    user_id = Column(Integer, ForeignKey('users.id'))
    user = relationship("User", backref="addresses", order_by=id)


Base.metadata.create_all(engine)
```


## 2.增删改查

### 插入数据
要插入数据，你需要创建一个对象，并将其添加到会话中，然后提交会话以将更改保存到数据库中。

```python
# 创建一个新用户
new_user = User(name='John', fullname='John Doe', nickname='johndoe')

# 添加用户到会话
session.add(new_user)

# 提交会话以将更改保存到数据库
session.commit()
```

### 查询数据
要查询数据，你可以使用查询对象执行查询，并使用 all() 方法获取所有结果或使用 first() 方法获取第一个结果。

```python
# 查询所有用户
users = session.query(User).all()

# 打印所有用户
for user in users:
    print(user.name, user.fullname, user.nickname)
```

### 更新数据
要更新数据，首先需要查询到要更新的对象，然后对其属性进行更改，并提交会话以保存更改。

```python
# 查询要更新的用户
user_to_update = session.query(User).filter_by(name='John').first()

# 更新用户的昵称
user_to_update.nickname = 'johnny'

# 提交会话以保存更改
session.commit()
```

### 删除数据

要删除数据，首先需要查询到要删除的对象，然后使用 delete() 方法将其从会话中删除，并提交会话以将更改保存到数据库中。

```python
# 查询要删除的用户
user_to_delete = session.query(User).filter_by(name='John').first()

# 从会话中删除用户
session.delete(user_to_delete)

# 提交会话以保存更改
session.commit()
```


## 3.完整示例


```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
from sqlalchemy import create_engine, Table, Column, String
from sqlalchemy.orm import sessionmaker
from sqlalchemy.orm import declarative_base

Base = declarative_base()


class User(Base):
    __tablename__ = 'users'

    user_id = Column(String(20), primary_key=True)
    user_pwd = Column(String(20))

    def __init__(self, user_id, user_pwd):
        self.user_id = user_id
        self.user_pwd = user_pwd


def init_db():
    # 创建数据库连接引擎
    engine = create_engine("mysql+mysqlconnector://root:root@localhost/chat")
    # 在数据库中创建表格
    Base.metadata.create_all(engine)

    # 创建会话类
    Session = sessionmaker(bind=engine)
    # 返回会话实例
    return Session()


class Database:
    def __init__(self, session):
        self.session = session

    def get_user(self, user_id):
        return self.session.query(User).get(user_id)

    def get_pwd(self, user_id):
        user = self.get_user(user_id)
        if user:
            return user.user_pwd
        else:
            return None

    def insert_info(self, user_id, pwd):
        user = User(user_id=user_id, user_pwd=pwd)
        self.session.add(user)
        self.session.commit()

    def delete_info(self, user_id):
        user = self.get_user(user_id)
        if user:
            self.session.delete(user)
            self.session.commit()

    def get_count(self):
        return self.session.query(User).count()

    def get_all_users(self):
        return self.session.query(User).all()

    def modify_pwd(self, user_id, pwd):
        user = self.get_user(user_id)
        if user:
            user.user_pwd = pwd
            self.session.commit()


def get_db():
    engine = init_db()
    db = Database(engine)
    return db


if __name__ == '__main__':
    db = get_db()
    db.insert_info("123", "123")
    print(db.get_pwd("123"))
```
