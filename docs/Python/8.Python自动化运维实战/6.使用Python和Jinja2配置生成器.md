# 6.使用Python和Jinja2配置生成器

## 简单示例

yaml文件：

yaml_example.yml

```yaml
---
my_datacenter:
  GW:
    eve_port: 32773
    device_template: vIOSL3_Template
    hostname: R1
    mgmt_intf: gig0/0
    mgmt_ip: 10.10.88.110
    mgmt_subnet: 255.255.255.0
    enabled_ports:
      - gig0/0
      - gig0/1
      - gig0/2


  switch1:
    eve_port: 32769
    device_template: vIOSL2_Template
    hostname: SW1
    mgmt_intf: gig0/0
    mgmt_ip: 10.10.88.111
    mgmt_subnet: 255.255.255.0

  switch2:
    eve_port: 32770
    device_template: vIOSL2_Template
    hostname: SW2
    mgmt_intf: gig0/0
    mgmt_ip: 10.10.88.112
    mgmt_subnet: 255.255.255.0
```

python脚本：读取配置文件


1.安装：输入pip install pyyaml或者pip3 install pyyaml

2.检查是否安装成功：输入python


load_yaml_file.py

```python
#!/usr/bin/python
import os
import yaml
from pprint import pprint
current_dir = os.path.dirname(os.path.abspath(__file__))
read_file = os.path.join(current_dir, 'yaml_example.yml')

with open(read_file,'r') as yaml_file:
    yaml_data = yaml.safe_load(yaml_file)  # This is to read the file content

pprint(yaml_data)
print("-"*100)
pprint(yaml_data['my_datacenter']['switch1'])
print("-"*100)
for device in yaml_data['my_datacenter']:
  print(device)
```

```sh
root@sstack:/tmp# python load_yaml_file.py
{'my_datacenter': {'GW': {'device_template': 'vIOSL3_Template',
                          'enabled_ports': ['gig0/0', 'gig0/1', 'gig0/2'],
                          'eve_port': 32773,
                          'hostname': 'R1',
                          'mgmt_intf': 'gig0/0',
                          'mgmt_ip': '10.10.88.110',
                          'mgmt_subnet': '255.255.255.0'},
                   'switch1': {'device_template': 'vIOSL2_Template',
                               'eve_port': 32769,
                               'hostname': 'SW1',
                               'mgmt_intf': 'gig0/0',
                               'mgmt_ip': '10.10.88.111',
                               'mgmt_subnet': '255.255.255.0'},
                   'switch2': {'device_template': 'vIOSL2_Template',
                               'eve_port': 32770,
                               'hostname': 'SW2',
                               'mgmt_intf': 'gig0/0',
                               'mgmt_ip': '10.10.88.112',
                               'mgmt_subnet': '255.255.255.0'}}}
root@sstack:/tmp# ^C
root@sstack:/tmp# >load_yaml_file.py
root@sstack:/tmp# vim load_yaml_file.py
root@sstack:/tmp# python load_yaml_file.py
{'my_datacenter': {'GW': {'device_template': 'vIOSL3_Template',
                          'enabled_ports': ['gig0/0', 'gig0/1', 'gig0/2'],
                          'eve_port': 32773,
                          'hostname': 'R1',
                          'mgmt_intf': 'gig0/0',
                          'mgmt_ip': '10.10.88.110',
                          'mgmt_subnet': '255.255.255.0'},
                   'switch1': {'device_template': 'vIOSL2_Template',
                               'eve_port': 32769,
                               'hostname': 'SW1',
                               'mgmt_intf': 'gig0/0',
                               'mgmt_ip': '10.10.88.111',
                               'mgmt_subnet': '255.255.255.0'},
                   'switch2': {'device_template': 'vIOSL2_Template',
                               'eve_port': 32770,
                               'hostname': 'SW2',
                               'mgmt_intf': 'gig0/0',
                               'mgmt_ip': '10.10.88.112',
                               'mgmt_subnet': '255.255.255.0'}}}
----------------------------------------------------------------------------------------------------
{'device_template': 'vIOSL2_Template',
 'eve_port': 32769,
 'hostname': 'SW1',
 'mgmt_intf': 'gig0/0',
 'mgmt_ip': '10.10.88.111',
 'mgmt_subnet': '255.255.255.0'}
----------------------------------------------------------------------------------------------------
GW
switch1
switch2
```


## 使用Jinja2 建立配置模版

```sh
pip isntall jinja2
```

模版示例

jinja2_example1.j2

```
hostname {{ hostname }}

aaa new-model
aaa session-id unique
aaa authentication login default local
aaa authorization exec default local none
vtp mode transparent
vlan 10,20,30,40,50,60,70,80,90,100,200

int {{ mgmt_intf }}
no switchport
no shut
ip address {{ mgmt_ip }} {{ mgmt_subnet }}
```

jinja2_generate.py

```python
#!/usr/bin/python
from jinja2 import Template

template = Template('''
hostname {{hostname}}

aaa new-model
aaa session-id unique
aaa authentication login default local
aaa authorization exec default local none
vtp mode transparent
vlan 10,20,30,40,50,60,70,80,90,100,200

int {{mgmt_intf}}
 no switchport
 no shut
 ip address {{mgmt_ip}} {{mgmt_subnet}}
''')

sw1 = {'hostname': 'switch1', 'mgmt_intf': 'gig0/0', 'mgmt_ip': '10.10.88.111', 'mgmt_subnet': '255.255.255.0'}
print(template.render(sw1))
```


```sh
root@sstack:/tmp# python jinja2_generate.py

hostname switch1

aaa new-model
aaa session-id unique
aaa authentication login default local
aaa authorization exec default local none
vtp mode transparent
vlan 10,20,30,40,50,60,70,80,90,100,200

int gig0/0
 no switchport
 no shut
 ip address 10.10.88.111 255.255.255.0
```


## 将yaml配置文件和jinja2模版结合


