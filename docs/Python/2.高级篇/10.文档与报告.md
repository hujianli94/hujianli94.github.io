# 10.文档与报告


## 1 使用Python处理Excel文档

### 1.1 openpyxl简介与安装


根据官方文档的介绍，openpyxl是一个读写Excel2010（xlsx/xlsm）文档的Python库，如果要处理更早格式的Excel文档，需要用到另外的库。

openpyxl是一个比较综合的工具，能够同时读取和修改Excel文档。

XlsxWriter也是一个与Excel处理相关的知名项目，仅支持创建和写入Excel文档，不支持读取Excel文档。 


openpyxl是一个开源项目，因此，在使用之前需要先进行安装：

```shell
pip install openpyxl
```


### 1.2 使用openpyxl读取Excel文档

#### 创建示例文件
首先把需要用到的数据放入至Excel当中去

```python
from openpyxl import Workbook

sales_data = {
    "苹果": {"北京": 5000, "上海": 7000, "深圳": 6000, "香港": 10000},
    "华为": {"北京": 8000, "上海": 4000, "深圳": 3000, "香港": 9000},
    "小米": {"北京": 6000, "上海": 9000, "深圳": 5000, "香港": 6000},
    "vivo": {"北京": 3000, "上海": 5000, "深圳": 4000, "香港": 7000}
}

# 创建一个新的工作簿
sales_wb = Workbook()
ws = sales_wb.active

# 重命名工作表的名称
ws.title = "Sales"

# 创建列名
column_names = ["Product Name"] + list(sales_data["苹果"].keys())
ws.append(column_names)

# 将一系列的数值都放置到工作表当中去
for product in sales_data:
    sales = list(sales_data[product].values())
    ws.append([product] + sales)

sales_wb.save("sales_data.xlsx")
```


在操作一个Excel之前，应该先创建一个Workbook对象。
对于创建一个新的Excel文档，直接进行Workbook类调用即可。
对于读取一个已有的Excel文档，可以使用openpyxl模块的load_workbook函数。

该函数接受多个参数，但只有filename参数为必传参数。filenmame可以是一个文件名，也可以是一个打开的文件对象。

```shell
In [1]: import openpyxl

In [2]: wb = openpyxl.load_workbook('sales_data.xlsx')
```

调用完load_workbook函数以后，我们就得到了一个Workbook对象。Workbook对象有很多的属性和方法，其中，大部分方法都与sheet相关。

Workbook对象的部分属性如下：

- active：获取活跃的Worksheet；

- read_only：是否以read_only模式打开Excel文档；

- encoding：文档的字符集编码；

- properties：文档的元数据，如标题，创建者，创建日期等；

- worksheets：以列表的形式返回所有的Worksheet。

```shell
In [3]: wb.active
Out[3]: <Worksheet "Sales">

In [4]: wb.read_only
Out[4]: False

In [5]: wb.encoding
Out[5]: 'utf-8'

In [6]: wb.worksheets
Out[6]: [<Worksheet "Sales">]
```

Workbook对象的方法大都与Worksheet相关。常用的方法如下：

- get_sheet_names：获取所有表格的名称；

- get_sheet_by_name：通过表格名称获取Worksheet对象；

- remove_sheet：删除一个表格；

- create_sheet：创建一个空的表格；

- copy_worksheet：在Workbook内拷贝表格。

附件的sales_data.xlsx文件中包含了一个表格。如下所示：

```shell
In [12]: wb.get_sheet_names()
Out[12]: ['Sales']

In [13]:  wb.get_sheet_by_name(u'Sales')
Out[13]: <Worksheet "Sales">
```
有了Worksheet对象以后，我们可以通过这个Worksheet对象获取表格的属性，得到单元格中的数据，修改表格中的内容。

openpyxl提供了非常灵活的方式来访问表格中的单元格和数据。常用的Worksheet属性如下：

- title：表格的标题；

- dimensions表格的大小，这里的大小是指有含有数据的表格大小。例如，对于example.xlsx文件，dimensions属性的值为'A1：E11'；

- max_row表格的最大行；

- min_row表格的最小行；

- max_column表格的最大列；

- min_column表格的最小列；

- rows按行获取单元格（Cell对象）；

- columns按列获取单元格（Cell对象）；

- freeze_panes冻结窗格；

- values按行获取表格的内容（数据）

对于附件中的sales_data.xlsx文件，其拥有的属性如下所示：

```shell
In [16]:  ws = wb.get_sheet_by_name('Sales')
  ws = wb.get_sheet_by_name('Sales')

In [17]: ws.title
Out[17]: 'Sales'

In [18]: ws.dimensions
Out[18]: 'A1:E5'

In [19]: ws.max_column
Out[19]: 5

In [20]: ws.min_column
Out[20]: 1

In [21]: ws.max_row
Out[21]: 5

In [22]: ws.min_row
Out[22]: 1

In [23]: ws.columns
Out[23]: <generator object Worksheet._cells_by_col at 0x7fa667318b30>

In [25]: ws.rows
Out[25]: <generator object Worksheet._cells_by_row at 0x7fa6803f0e40>

In [26]: ws.values
Out[26]: <generator object Worksheet.values at 0x7fa6803f0ba0>
```

下面是Worksheet常用的一些方法：

- iter_rows：按行获取所有单元格（Cell对象）；

- iter_columns：按列获取所有的单元格；

- append：在表格末尾添加数据；

- merged_cells：合并多个单元格；

- unmerge_cells：移除合并的单元格。

iter_rows方法和iter_columns方法在参数取默认值时，与rows属性和columns属性的作用相同。

区别在于，iter_rows方法和iter_columns方法可以通过函数参数限定访问表格的范围。如下所示：

```shell
In [27]: list(ws.iter_rows(min_row=2, max_row=4, min_col=1, max_col=3))
Out[27]: 
[(<Cell 'Sales'.A2>, <Cell 'Sales'.B2>, <Cell 'Sales'.C2>),
 (<Cell 'Sales'.A3>, <Cell 'Sales'.B3>, <Cell 'Sales'.C3>),
 (<Cell 'Sales'.A4>, <Cell 'Sales'.B4>, <Cell 'Sales'.C4>)]
```

从Worksheet的属性和方法的使用中可以看到，很多属性和方法返回的不是某一个具体的数值，而是一个Cell对象。

一个Cell对象就代表一个单元格，我们可以直接使用Excel坐标的方式获取Cell对象，也可以使用Worksheet的cell方法获取Cell对象。如下所示：
```shell
In [30]: ws['A1']
Out[30]: <Cell 'Sales'.A1>

In [31]: ws['A2']
Out[31]: <Cell 'Sales'.A2>

In [32]: ws.cell(row=1, column=2)
Out[32]: <Cell 'Sales'.B1>

In [33]: ws.cell(row=2, column=1)
Out[33]: <Cell 'Sales'.A2>
```

Cell对象比较简单，其常用的属性如下：

- row：单元格所在的行；

- column：单元格所在的列；

- value：单元格的取值；

- cordinate：单元格的坐标。

为了熟悉openpyxl提供的各种API，接下来我们使用4种不同的方法来打印student表中的内容。为了对数据的格式进行控制，我们使用print函数而不是print语句进行打印。

下面是通过Worksheet的values方法打印表格中的数据，这也是打印数据最简单的方法。

values通过生成器访问数据并按行返回，因此，我们使用for循环遍历表格的内容。

```shell
In [28]: for row in ws.values:
    ...:     print(*row)
    ...:
```

我们也可以使用Worksheet的rows属性来遍历表格中的数据。

rows属性按行返回Cell对象，因此，我们使用列表推导来获取每一个Cell对象的值。如下所示：
```shell
In [29]: for row in ws.rows:
    ...:     print(*[cell.value for cell in row])
    ...:
```


Worksheet的iter_rows方法在不加任何参数的情况下，与rows属性效果相同，因此，这种方法与前一种方法看起来很像。

```shell
In [34]: for row in ws.iter_rows():
    ...:     print(*[cell.value for cell in row])
    ...:
```
最后这种方式是最麻烦的方式，也是大家最容易想到的方式。我们首先获取表格的最小行数和最大行数，然后获取最小列数与最大列数，通过行和列的索引确定一个唯一单元格。

确定单元格以后，打印单元格的值。这种方式是每确定一个单元格打印一次，因此，我们在print函数中将end参数取值为空格来避免换行，并在内层for循环结束以后，显示地进行换行。如下所示 ：

```shell
In [35]: for i in range(ws.min_row, ws.max_row + 1):
    ...:     for j in range(ws.min_column, ws.max_column + 1):
    ...:         print(ws.cell(row=i, column=j).value, end=' ')
    ...:     print()
    ...:
```


```python
import openpyxl

wb = openpyxl.load_workbook('sales_data.xlsx')

ws = wb['Sales']


for row in ws.values:
    print(*row)

# for row in ws.rows:
#     print(*[cell.value for cell in row])

# for row in ws.iter_rows():
#     print(*[cell.value for cell in row])
```

### 1.3 使用openpyxl修改Excel文档

openpyxl不但可以读取Excel文档，而且还可以修改Excel文档，包括修改单元格的数据、合并单元格、修改单元格的字体、在Excel文档中画图等。
我们接下来将介绍如何使用openpyxl创建工作簿，创建和删除表格，修改单元格的数据。然后，我们通过计算sales_data.xlsx文件中的数据来演示如何修改一份Excel文档。









!!!info "扩展阅读"


        [Python 操作 Excel库对比](https://www.yuque.com/fcant/python/dgofgp#kE9F7)
        
        [Python 操作 Excel库对比总结整理](https://www.yuque.com/fcant/python/fpmbgy#4UX38)
        
        [用Python自动化操作Excel制作报表](https://www.yuque.com/fcant/python/kwuqai#KeCxK)
        
        [Python实现数据写入 Excel 的三种模块](https://www.yuque.com/fcant/python/ckep3q#EwRGy)
