# 10.文档与报告


## 1.使用csv读写CSV文件

### 1.1 写入CSV数据

- 写入元祖序列的数据

```python
#!/usr/bin/env python
# -*- coding:utf8 -*-

import csv

headers = ['ID', 'UserName', 'Password', 'Age', 'Country']
rows = [(1001, "qiye", "qiye_pass", 24, "China"),
        (1002, "Mary", "Mary_pass", 20, "USA"),
        (1003, "Jack", "Jack_pass", 20, "USA"),
        ]

with open('qiye.csv', 'w', newline="") as f:
    f_csv = csv.writer(f)
    f_csv.writerow(headers)
    f_csv.writerows(rows)
```



- 写入字典序列的数据

```python
import csv

headers = ['ID', 'UserName', 'Password', 'Age', 'Country']
rows = [{'ID': 1001, 'UserName': "qiye", 'Password': "qiye_pass", 'Age': 24, 'Country': " China"},
        {'ID': 1002, 'UserName': "Mary", 'Password': "Mary_pass", 'Age': 20, 'Country': "USA"},
        {'ID': 1003, 'UserName': "Jack", 'Password': "Jack_pass", 'Age': 20, 'Country': "USA"},
        ]

with open('qiye2.csv', 'w') as f:
    f_csv = csv.DictWriter(f, headers)
    f_csv.writeheader()
    f_csv.writerows(rows)
```


- 写入普通数据

```python
import csv

with open("sr.csv", "w") as f:
    w = csv.writer(f, delimiter=",")
    w.writerow(["one", "two", "three"])
    w.writerow(["four", "five", "six"])
```






### 1.2 读取CSV数据


```python
#!/usr/bin/env python
# -*- coding:utf8 -*-
# auther; 18793
# Date：2020/5/6 13:11
# filename: sample03.py

import csv

with open('qiye.csv') as f:
    f_csv = csv.reader(f)
    headers = next(f_csv)
    print(headers)
    for row in f_csv:
        print(row)
```


- 以列表形式输出

```python
import csv
csvfile = open('csv_test.csv', 'r')
# 
reader = csv.reader(csvfile)
for row in reader:
    if '小P' in row:
        print(row)
```


- 以字典形式输出

```python
# 以字典形式输出，第一行作为字典的键
reader = csv.DictReader(csvfile)
for row in reader:
    if row['姓名']== '小P':
        print(row)
```



### 1.3 读写csv文件

```python


import csv

with open('pingan.csv', 'r') as rf:
    reader = csv.reader(rf)
    with open('pingan2.csv', 'w') as wf:
        writer = csv.writer(wf)
        headers = next(reader)
        writer.writerow(headers)
        for row in reader:
            if row[0] < '2016-01-01':
                break
            if int(row[5]) >= int(50000000):
                writer.writerow(row)
```


读取-写入-读取

```python
# writer()函数
# 先读取csv文件，再将读取的数据处理后写入新的csv中
import csv

headers = ['编号', '书名', '作者', '出版社', '出版时间', '级别']
rows = [
    "10,软件工程1,胡建力,机械工业出版社,199407226517,2",
    "11,汇编语言1,胡建力2,北京工业大学出版社,199407126517,2",
    "12,计算机语言1,胡建力3,经济科学出版社,199417126517,1",
    "13,FLASH精选1,胡建力4,中国纺织出版社,199417126511,3",
    "14,JAVA基础1,胡建力5,电子工业出版社,199117126511,3",
    "15,JAVA程序设计1,胡建力6,世界出版社,199117126512,2",
    "16,新东方英语1,胡建力7,外语出版社,192117126512,1"
]

with open("test.csv", "r", encoding="utf-8") as rf:
    reader = csv.reader(rf)
    print("开始读取test.csv文件内容......................")
    with open("test_bak.csv", "w", newline="", encoding="utf-8") as wf:
        writer = csv.writer(wf, delimiter=",")
        header = ["|".join(headers)]
        print("开始写入标题header 到test_bak.csv文件......................")
        writer.writerow(header)
        print("开始写入文件旧数据 到test_bak.csv文件......................")
        for row in reader:
            # print(row)
            writer.writerow(row)
        rows_list = [str(row).split(",") for row in rows]
        print("开始写入新的数据 到test_bak.csv文件......................")
        for row_new in rows_list:
            writer.writerow(row_new)
    print("读写完毕，查看写入后的内容................")

with open("test_bak.csv", "r", encoding="utf-8") as rf:
    reader = csv.reader(rf)
    for info in reader:
        print("|".join(info))
```



python3写入csv文件中文乱码的解决

```python

# 加入encoding='utf-8-sig'就不会乱码了
with open("haha.csv",'w',newline='',encoding='utf-8-sig') as csvfile:
    writer = csv.writer(csvfile)
    writer.writerow(["飞机转场记录号", "登机口"])

```


csv操作函数

```python
#!/usr/bin/env python
#-*- coding:utf8 -*-
import csv

# 将数据写入csv文件
def write_csv_file(path, head, data):
    '''
    :param path: CSV文件的路径和文件名
    :param head: 生成的CSV文件的文件头
    :param data: data为需要写入CSV文件的数据，也需要传入一个列表
    :return:
    '''
    try:
        with open(path, "w", newline='') as csv_file:
            writer = csv.writer(csv_file, dialect='excel')
            if head is not None:
                writer.writerow(head)
            for row in data:
                writer.writerow(row)
            print("Write a CSV file to path %s Successful." % path)

    except Exception as e:
        print("Write an CSV file to path: %s, Case: %s" % (path, e))
```

## 2.使用Python处理Excel文档


Python操作的Excel包有`xlrd、xlwt、pyExcelerator和openpyxl`。

其中，pyExcelerator只支持2003版本，openpyxl只支持2007版本，xlrd支持Excel任何版本的读取，xlwt支持Excel任何版本的写入。


Python自带的模块中有针对xls格式的xlrd和xlwt模块，但这两个库仅仅是针对xls的操作，要操作xlsx格式文件时，则需要使用到openpyxl第三方库。

|模块|来源|读|写|支持格式|
|----|-----|----|----|------|
|xlrd|标准库|√|×|xls|
|xlwt|标准库|×|√|xls|
|openpyxl|三方库|√|√|xlsx|



**整体思路**


虽然这几个库已经把Excel的文件、表、行、列的概念完全转换为Python中的对象，但每次操作都需要遍历每一个单元格，
甚至很多时候要花费大量的时间在思考循环单元格的边界上，这本身就是在重复造轮子，因此花了半天时间整理了以下六个函数。



### 2.1 使用xlrd和xlwt读写Excel

为了版本的兼容性，大多数开发人员选择使用xlrd和xlwt操作Excel。xlrd和xlwt的安装如下：

```shell
pip install xlrd
pip install xlwt
```


完成安装后，在Python交互式命令行查看xlrd和xlwt模块的版本信息：

```shell
>>> import xlwt
>>> import xlrd
>>> xlrd.__VERSION__
'2.0.1'
>>> xlwt.__VERSION__
'1.3.0'
```

Excel的写入相对比CVS复杂，但Excel可以实现设置数据格式、合并单元格、设置公式和插入图片等功能。使用xlwt实现上述功能的代码如下：

#### 2.1.1 使用xlwt写入文件数据

数据样本

`car.txt`

```
车辆概况       车龄    全款价    原价
三菱1          2      50001   60001
三菱2          2      50002   60002
三菱3          2      50003   60003
```

```python
import xlwt

# 标题列表
columns = []
# 数据列表
datas = []

with open('car.txt', encoding='utf-8') as f:
    # 首行判断
    is_first_line = True
    for line in f:
        line = line[:-1]
        if is_first_line:
            is_first_line = False
            columns = line.split('\t')
            continue
        datas.append(line.split('\t'))


# print(columns)
#
# for data in datas:
#     print(data)


def Using_xlwt():
    """
    使用xlwt生成xls的excel文件
    :return:
    """
    workbook = xlwt.Workbook(encoding='utf-8')
    sheet = workbook.add_sheet('瓜子二手车')

    for col, column in enumerate(columns):
        sheet.write(0, col, column)

    for row, data in enumerate(datas):
        for col, column_data in enumerate(data):
            sheet.write(row + 1, col, column_data)
    workbook.save('瓜子二手车1.xls')


if __name__ == '__main__':
    Using_xlwt()
```


或者如下方式

```python
def write_xls_excel(url,sheet_name,two_dimensional_data):
  """
    写入xls格式文件
    参数：
        url:文件路径
        sheet_name:表名
        two_dimensional_data：将要写入表格的数据（二维列表）
    """
    # 创建工作簿对象
    workbook = xlwt.Workbook()
    # 创建工作表对象
    sheet = workbook.add_sheet(sheet_name)
    # 遍历每一行数据
    for i in range(0,len(two_dimensional_data)):
        # 遍历每一列数据
        for j in range(0,len(two_dimensional_data[i])):
            # 写入数据
            sheet.write(i,j,two_dimensional_data[i][j])
    # 保存
    workbook.save(url)
    print("写入成功")
```




使用xlwt模块把数据写入Excel文件的整体思路如下：

1. xlwt创建生成临时Excel对象。
2. 添加WorkSheets对象。
3. 单元格的位置由行列索引决定，索引从0开始。
4. 数据写入主要由write_merge()和write()实现，两者分别是合并单元格再写入和单元格写入。
5. 设置数据格式是在写入（write_merge()和write()）的数据中传入参数style。

除此之外，xlwt还可以设置单元格背景颜色、添加单元格边框、设置单元格高宽度、设置字体颜色和数据类型等，由于篇幅较大，本书就不详细讲解了。



#### 2.1.2 xls文件追加写入数据

```python
def write_xls_excel_add(url, two_dimensional_data, index):
    """
    追加写入xls格式文件
    参数：
        url:文件路径
        two_dimensional_data：将要写入表格的数据（二维列表）
        index：指定要追加的表的序号（第几个工作表，传入参数从1开始数）
    """
    # 打开指定的工作簿
    workbook = xlrd.open_workbook(url)
    # 获取工作簿中的所有表格
    sheets = workbook.sheet_names()
    # 获取指定的表
    worksheet = workbook.sheet_by_name(sheets[index-1])
    # 获取表格中已存在的数据的行数
    rows_old = worksheet.nrows
    # 将xlrd对象拷贝转化为xlwt对象
    new_workbook = copy(workbook)
    # 获取转化后工作簿中的第index个表格
    new_worksheet = new_workbook.get_sheet(index-1)
    # 遍历每一行数据
    for i in range(0, len(two_dimensional_data)):
        # 遍历每一列数据
        for j in range(0, len(two_dimensional_data[i])):
            # 追加写入数据，注意是从i+rows_old行开始写入
            new_worksheet.write(i+rows_old, j, two_dimensional_data[i][j])
    # 保存工作簿
    new_workbook.save(url)
    print("追加写入成功")
```


#### 2.1.3 使用xlrd读取文件数据


```python
def Using_xlrd():
    """
    使用xlrd读取xls的excel文件
    :return:
    """
    df = xlrd.open_workbook('./瓜子二手车1.xls')
    table = df.sheet_by_name('瓜子二手车')
    for i in range(table.nrows):
        print(table.row_values(i))
```


或者如下方式

```python

def read_xls_excel(url,index):
    """
    读取xls格式文件
    参数：
        url:文件路径
        index：工作表序号（第几个工作表，传入参数从1开始数）
    返回：
        data:表格中的数据
    """
    # 打开指定的工作簿
    workbook = xlrd.open_workbook(url)
    # 获取工作簿中的所有表格
    sheets = workbook.sheet_names()
    # 获取工作簿中所有表格中的的第 index 个表格
    worksheet = workbook.sheet_by_name(sheets[index-1])
    # 定义列表存储表格数据
    data = []
    # 遍历每一行数据
    for i in range(0, worksheet.nrows):
        # 定义表格存储每一行数据
        da = []
        # 遍历每一列数据
        for j in range(0, worksheet.ncols):
            # 将行数据存储到da列表
            da.append(worksheet.cell_value(i, j))
        # 存储每一行数据
        data.append(da)
    # 返回数据
    return data
```


读取Excel文件的数据思路大致如下：

1. xlrd生成Workbook对象，并指向Excel文件。
2. 选择Workbook里面某个WorkSheets对象。
3. 获取WorkSheets里面的数据已占用的总行数和总列数(某个单元格的数据)。
4. 循环总行数和总列数，读取每一个单元格的数据。





### 2.2 使用openpyxl读写Excel

#### 2.2.1 读取Excel文件

```python
import openpyxl


def read_xlsx_excel(url, sheet_name):
    """
    读取xlsx格式文件
    参数：
        url:文件路径
        sheet_name:表名
    返回：
        data:表格中的数据
    """
    # 使用openpyxl加载指定路径的Excel文件并得到对应的workbook对象
    workbook = openpyxl.load_workbook(url)
    # 根据指定表名获取表格并得到对应的sheet对象
    sheet = workbook[sheet_name]
    # 定义列表存储表格数据
    data = []
    # 遍历表格的每一行
    for row in sheet.rows:
        # 定义表格存储每一行数据
        da = []
        # 从每一行中遍历每一个单元格
        for cell in row:
            # 将行数据存储到da列表
            da.append(cell.value)
        # 存储每一行数据
        data.append(da)
    # 返回数据
    return data


if __name__ == '__main__':
    fn = '瓜子二手车2.xlsx'
    sheet_name = "默认title"
    for i in read_xlsx_excel(fn, sheet_name):
        print(i)
```




#### 2.2.2 写入Excel文件


```python
import openpyxl

def write_xlsx_excel(url, sheet_name, two_dimensional_data, header=None):
    """
    写入xlsx格式文件
    参数：
        url:文件路径
        sheet_name:表名
        two_dimensional_data：将要写入表格的数据（二维列表）
        header:表头数据（可选）
    """
    # 创建工作簿对象
    workbook = openpyxl.Workbook()
    # 创建工作表对象
    sheet = workbook.active
    # 设置该工作表的名字
    sheet.title = sheet_name

    # 写入表头
    if header:
        for j in range(0, len(header)):
            sheet.cell(row=1, column=j + 1, value=str(header[j]))

    # 遍历表格的每一行
    for i in range(len(two_dimensional_data)):
        # 遍历表格的每一列
        for j in range(len(two_dimensional_data[i])):
            # 写入数据（注意openpyxl的行和列是从1开始的）
            sheet.cell(row=i + 2, column=j + 1, value=str(two_dimensional_data[i][j]))
    
    # 保存到指定位置
    workbook.save(url)
    print("写入成功")
```

调用方式如下：

```python
data = [
    ["姓名", "年龄", "性别"],
    ["张三", 20, "男"],
    ["李四", 25, "女"],
    ["王五", 30, "男"]
]

write_xlsx_excel("example.xlsx", "Sheet1", data, header=["Name", "Age", "Gender"])
```




#### 2.2.3 xlsx文件追加写入数据

```python
def write_xlsx_excel_add(url, sheet_name, two_dimensional_data):
    """
    追加写入xlsx格式文件
    参数：
        url:文件路径
        sheet_name:表名
        two_dimensional_data：将要写入表格的数据（二维列表）
    """
    # 使用openpyxl加载指定路径的Excel文件并得到对应的workbook对象
    workbook = openpyxl.load_workbook(url)
    # 根据指定表名获取表格并得到对应的sheet对象
    sheet = workbook[sheet_name]
    for tdd in two_dimensional_data:
        sheet.append(tdd)
    # 保存到指定位置
    workbook.save(url)
    print("追加写入成功")
```



### 2.3 案例-合并多个Excel到一个Excel中

```python
#!/usr/bin/python
import os
import glob

import openpyxl


def merge_xlsx_files(xlsx_files):
    wb = openpyxl.load_workbook(xlsx_files[0])
    ws = wb.active
    ws.title = "merged result"

    for filename in xlsx_files[1:]:
        workbook = openpyxl.load_workbook(filename)
        sheet = workbook.active
        for row in sheet.iter_rows(min_row=2):
            values = [cell.value for cell in row]
            ws.append(values)

    return wb


def get_all_xlsx_files(path):
    xlsx_files = glob.glob(os.path.join(path, '*.xlsx'))
    sorted(xlsx_files, key=str.lower)
    return xlsx_files


def main():
    xlsx_files = get_all_xlsx_files(os.path.expanduser('./'))
    wb = merge_xlsx_files(xlsx_files)
    wb.save('merged_form.xlsx')


if __name__ == '__main__':
    main()
```


在这个例子中，我们首先通过glob获取了指定目录下所有的Excel文档。然后，我们将这些文档按照文件名称进行了排序。
排序以后，在`merge_xlsx_files`函数中尝试合并多个Excel文档。我们合并Excel的思路也很简单：

1. 获取第一个文档中的表格(我们的Excel文档中只有一个表格)
2. 依次遍历其他文件中的报名表，并通过`iter_rows函数`忽略报名表中的首行内容；
3. 通过列表推导获取报名表中的数据，然后调用Worksheet的`append函数`将数据添加到汇总表的末尾。
4. 上述操作完成以后，返回Workbook对象。在main函数中，我们调用Workbook的save方法将汇总表保存到merged form.xlsx文件中。


我们只花费几分钟时间编写了不到30行的Python代码，就实现了将多个Excel文档合并成单个文件的功能。

因为是Python程序进行处理，所以无论有多少张表需要合并都能够快速处理，并且不会出错，也不会抱怨处理的表格太多。







!!!info "扩展阅读"



        [Python读写操作Excel数据](https://www.yuque.com/fcant/python/av5mti#NALtM)

        [Python 操作 Excel库对比](https://www.yuque.com/fcant/python/dgofgp#kE9F7)
        
        [Python 操作 Excel库对比总结整理](https://www.yuque.com/fcant/python/fpmbgy#4UX38)
        
        [用Python自动化操作Excel制作报表](https://www.yuque.com/fcant/python/kwuqai#KeCxK)
        
        [Python实现数据写入 Excel 的三种模块](https://www.yuque.com/fcant/python/ckep3q#EwRGy)




## 3.使用python-docx读写Word文件

如果将数据存储在Word文件中，一般以文章、新闻报道和小说这类文字内容较长的数据为主。Python读写Word文件需要第三方库扩展支持，使用pip安装：


```shell
pip install python-docx
```

模块安装后，验证模块是否安装成功，在Python交互式命令行查看python-docx模块的版本信息：

```shell
>>> import docx
>>> docx.__version__
```


### 3.1 将数据写入Word文件


```python
# 数据写入
from docx import Document
from docx.shared import Inches

# 创建对象
document = Document()
# 添加标题，其中“0”代表标题类型，共有4种类型，具体可在Word的“开始”→“样式”中查看
document.add_heading('Python 爬虫', 0)
# 添加正文内容并设置部分内容格式
p = document.add_paragraph('Python 爬虫开发-')
# 设置内容加粗
p.runs[0].bold = True
# 添加内容并加粗
p.add_run('数据存储-').bold = True
# 添加内容
p.add_run('Word-')
# 添加内容并设置字体斜体
p.add_run('存储实例。').italic = True
# 添加正文，设置“样式”→“明显引用”
document.add_paragraph('样式'  '明显引用', style='IntenseQuote')
# 添加正文，设置“项目符号”
document.add_paragraph(
    '项目符号1', style='ListBullet'
)
document.add_paragraph(
    '项目符号2', style='ListNumber'
)
# 添加图片
document.add_picture('test.png', width=Inches(1.25))
# 添加表格
table = document.add_table(rows=1, cols=3)
hdr_cells = table.rows[0].cells
hdr_cells[0].text = 'Qty'
hdr_cells[1].text = 'Id'
hdr_cells[2].text = 'Desc'
for item in range(2):
    row_cells = table.add_row().cells
    row_cells[0].text = 'a'
    row_cells[1].text = 'b'
    row_cells[2].text = 'c'
# 保存文件
document.add_page_break()
document.save('test.docx')
```

分析上述代码，在Word文件中写入数据的整体思路如下：

1. 创建生成临时Word对象。
2. 分别使用`add_paragraph()`和`add_heading()`对Word对象添加标题和正文内容。
3. 如果想设置正文内容的字体加粗和斜体等，那么可以将正文内容p对象的属性`runs[0].bold`和`add_run('XX').italic`设置为True。
4. 如果要插入图片和添加表格，那么可以在Word对象中使用方法`add_picture()`和`add_table()`。
5. 完成数据写入，需要将Word对象保存成Word文件。



### 3.2 读取Word数据

读取Word数据比写入数据相对简单，因为不用设置内容格式，直接获取数据即可，实现代码如下：

```python
# 数据读取
import docx


def readDocx(docName):
    fullText = []
    doc = docx.Document(docName)
    # 读取全部内容
    paras = doc.paragraphs
    # 将每行数据存入列表
    for p in paras:
        fullText.append(p.text)
        # 将列表数据转换成字符串
    return '\n'.join(fullText)


print(readDocx('test.docx'))
```

分析上述代码，在Word文件中读取数据的整体思路如下：

1. 生成Word对象，并指向Word文件。
2. 使用`paragraphs()`获取Word对象全部内容。
3. 循环paragraphs对象，获取每行数据并写入列表。
4. 将列表转换为字符串，每个列表元素使用换行符连接，转换后数据的段落布局与Word文件相似。




## 4.实践-多文件读写功能

样本文件

`test.txt`


```
[settings]
username = hujianli
password = 123123
```


main.py

```python
import csv
import configparser
import xlrd
import docx
import xlwt


class ReadWrite():
    def __init__(self, name):
        self.name = name
        self.fileStyle = name.split(".")[1]

    def reads(self):
        value = None
        if self.fileStyle == 'txt':
            f = open(self.name, 'r', encoding='utf-8')
            value = f.read()
            f.close()
        if self.fileStyle == 'csv':
            csvfile = open(self.name, 'r')
            value = csv.DictReader(csvfile)
        if self.fileStyle == 'ini':
            value = configparser.ConfigParser()
            value.read(self.name)
        if self.fileStyle in ['xls', 'xlsx']:
            value = xlrd.open_workbook(self.name)
        if self.fileStyle in ['doc', 'docx']:
            doc = docx.Document(self.name)
            value = doc.paragraphs
        return value

    def writes(self):
        target = None
        if self.fileStyle == 'txt':
            target = open(self.name, 'w', encoding='utf-8')
        if self.fileStyle == 'csv':
            csvfile = open(self.name, 'w', newline='')
            target = csv.writer(csvfile)
        if self.fileStyle == 'ini':
            target = configparser.ConfigParser()
            target.read(self.name)
        if self.fileStyle in ['xls', 'xlsx']:
            target = xlwt.Workbook()
        if self.fileStyle in ['doc', 'docx']:
            target = docx.Document()
        return target


if __name__ == '__main__':
    f = ReadWrite('test1.ini')
    # 读取数据
    value = f.reads()
    username = value.get("settings", "username")
    password = value.getint("settings", "password")
    print(f'用户名为：{username}，密码为：{password}')
    # 写入数据
    target = f.writes()
    target.set("settings", "address", "GZ")
    with open("test1.ini", "w+") as f:
        target.write(f)
```


我们定义了ReadWrite类，并重写了类的初始化方法__init__()，定义了实例方法reads()和writes()，每个方法的说明如下：


1. 初始化方法__init__()设置类实例化的参数，在类的实例化过程中必须传入参数name，该参数代表文件的路径信息。
2. 实例方法reads()通过判断文件后缀名的方式选择相应的文件读取操作，由于每个文件的读取方式各不相同，只有TXT、CSV和Docx文件是读取文件内容，INI和Excel文件是返回文件对象。
3. 实例方法writes()也是通过判断文件后缀名的方式选择相应的文件写入操作，每个文件的数据写入方式不同，所以该方法返回相应的文件对象，具体的写入过程不在方法内实现。





## 5.使用Python操作PDF文档
