# 19.Python 数据库编程

## 1.Redis

### 1.1 基础操作

#### Redis set get

```python
#!/usr/bin/env python
# -*- coding:utf8 -*-


import redis

r = redis.StrictRedis(host="127.0.0.1", port=6379)
# 写入两条数据
r.set('name', 'hujianli')
r.set('url', 'www.baidu.com')

# 获取一条数据
print(r.get('name'))
print(r.get('url'))

```

#### Redis list keys

```python
#!/usr/bin/env python
# -*- coding:utf8 -*-


import redis

r = redis.StrictRedis(host="127.0.0.1", port=6379)
# 获取所有key
for k in r.keys('*'):
    print(k)
```

#### Redis incr

将 “key” 的值递增 “amount”。如果不存在键，则该值将初始化为 “amount”

```python
#!/usr/bin/env python
# -*- coding:utf8 -*-


import redis
r = redis.StrictRedis(host="127.0.0.1", port=6379)

r.set("counter", 40)
print(r.get("counter"))
print(r.incr("counter"))
print(r.incr("counter"))
print(r.get("counter"))

# 输出
# b'40'
# 41
# 42
# b'42'
```

#### Redis incrby

```python
#!/usr/bin/env python
# -*- coding:utf8 -*-


import redis
r = redis.StrictRedis(host="127.0.0.1", port=6379)

r.set("counter", 19)
print(r.get("counter"))
print(r.incrby("counter", 23))
print(r.get("counter"))

# b'19'
# 42
# b'42'
```

#### Redis setex

```python
#!/usr/bin/env python
# -*- coding:utf8 -*-
import redis
import time
r = redis.StrictRedis(host="127.0.0.1", port=6379)

r.setex("login", 2, 'foobar')
print(r.get("login")) # 'foobar'
time.sleep(1)
print(r.get("login")) # 'foobar'
time.sleep(1)
print(r.get("login")) # None
```

### 1.2 使用连接池连接到 Redis

```python
#!/usr/bin/env python
# -*- coding:utf8 -*-
import redis
pool = redis.ConnectionPool(host="127.0.0.1", port=6379)
conn = redis.Redis(connection_pool=pool)
print(conn.set('hello', 'world'))
print(conn.get('hello'))
```

### 1.3 API

```sh
# redis-py 提供的 API 用来操作 redis

# String API
set(name, value, ex=None, px=None, nx=False, xx=False)

# 参数 描述
# ex 过期时间（秒）
# px 过期时间（毫秒）
# nx 如果设置为 True，则只有 name 不存在时，当前 set 操作才执行
# xx 如果设置为 True，则只有 name 存在时，岗前 set 操作才执行
```

### 1.4 hash

```python
#!/usr/bin/env python
# -*- coding:utf8 -*-
import redis

r = redis.StrictRedis(host="localhost", port=6379, db=0)

p1 = {
    "name": "胡建力",
    "age": 18,
    "sex": "Man",
}

p2 = {
    "name": "科比",
    "age": 30,
    "sex": "Man",
}

# 将数据保存到Redis中
for key, value in p1.items():
    r.hset("person:1", key, value)

for key, value in p2.items():
    r.hset("person:2", key, value)

# 关闭连接
r.connection_pool.disconnect()
```

### 1.5 封装 Redis 的类

```python
#!/usr/bin/env python
# -*- coding:utf8 -*-
import redis


class MyRedis():
    def __init__(self, ip, passwd, port=6379, db=0):
        # 构造函数
        try:
            self.r = redis.Redis(host=ip, password=passwd, port=port, db=db)

        except Exception as e:
            print('redis连接失败，错误信息%s' % e)

    def str_get(self, k):
        res = self.r.get(k)
        if res:
            return res.decode()

    def str_set(self, k, v, time=None):
        self.r.set(k, v, time)

    def delete(self, k):
        tag = self.r.exists(k)  # 判断这个Key是否存在
        if tag:
            self.r.delete(k)
            print('删除成功')
        else:
            print('这个key不存在')

    def hash_hget(self, name, key):
        res = self.r.hget(name, key)
        if res:
            return res.decode()

    def hash_hset(self, name, k, v):
        self.r.hset(name, k, v)

    def hash_getall(self, name):
        res = self.r.hgetall()
        new_dict = {}
        if res:
            for k, v in res.items():
                k = k.decode()
                v = v.decode()
                new_dict[k] = v
        return new_dict

    def hash_del(self, name, k):
        res = self.r.hdel(name, k)
        if res:
            print('删除成功')
            return True
        else:
            print('删除失败.该key不存在')
            return False

    def list_lpush(self, name, *values):
        self.r.lpush(name, *values)

    def list_rpush(self, name, *values):
        self.r.rpush(name, *values)

    def list_lpop(self, name):
        res = self.r.lpop(name)
        if res:
            return res.decode()

    def list_rpop(self, name):
        res = self.r.rpop(name)
        if res:
            return res.decode()

    def set_sadd(self, name, *values):
        self.r.sadd(name, *values)

    def set_srem(self, name, *values):
        res = self.r.srem(name, *values)
        return res

    def set_smembers(self, name):
        res = self.r.smembers(name)
        new_set = set()
        for member in res:
            new_set.add(member.decode())
        return new_set

    @property
    def clean_redis(self):
        self.r.flushdb()  # 清空redis
        print('清空redis成功.')
        return 0

a = MyRedis('127.0.0.1', '')
a.clean_redis

p1 = {
    "name": "胡建力",
    "age": 18,
    "sex": "Man",
}
# 将数据保存到Redis中
for key, value in p1.items():
    a.hash_hset("person:1", key, value)

a.list_lpush("name","hujianli")
print(a.list_lpop("name"))
```

## 2.PyMySQL

pymysql 是 Python 中操作 MySQL 的模块，其使用方法和 MySQLdb 几乎相同。

但目前 pymysql 支持 python3.x 而后者不支持 3.x 版本。

### 2.1 安装 pymysql 模块

pymysql 是第三方模块，需要单独安装，首选通过 pip 安装 PyMySQL:

```sh
pip3 install pymysql
```

### 2.2 pymysql 使用

官方文档：https://pypi.org/project/PyMySQL/#documentation

根据官方文档做一个示例，先登录 Mysql 实例创建一个 test 库和一张 users 表，如下：

### 2.4 封装 mysql

#### 封装类方法 1

`创建mysql_env.py文件`

```python
#!/usr/bin/env python
# -*- coding:utf8 -*-

mysql_info = {
     "host": "127.0.0.1",
     "user": "hujianli",
     "passwd": "123.com",
     "dbName": "school"
}
```

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
__author__ = 'xiaojian'
import pymysql
from mysql_env import mysql_info


class Mysql_SQL():
    def __init__(self, host, user, passwd, dbName):
        self.host = host
        self.user = user
        self.passwd = passwd
        self.dbName = dbName

    def connet(self):
        self.db = pymysql.connect(self.host, self.user,
                                  self.passwd, self.dbName)
        self.cursor = self.db.cursor()

    def close(self):
        self.cursor.close()
        self.db.close()

    def get_one(self, sql):
        rest = None
        try:
            self.connet()
            self.cursor.execute(sql)
            res1 = self.cursor.fetchone()
            title = self.cursor.description
            # print(res)
            # print(title)
            rest = dict(zip([k[0] for k in title], res1))
            self.close()
        except:
            print("查询数据失败")
        return rest

    def get_all(self, sql):
        res1 = ()
        try:
            self.connet()
            self.cursor.execute(sql)
            res = self.cursor.fetchall()
            title = self.cursor.description
            rest1 = [dict(zip([k[0] for k in title], row)) for row in res]
            self.close()
        except:
            print("查询数据失败")
        return rest1

    def insert(self, sql):
        return self.__edit_one(sql)

    def update(self, sql):
        return self.__edit_one(sql)

    def delete(self, sql):
        return self.__edit_one(sql)

    def __edit_one(self, sql):
        """
        #准备SQL
        #获取链接和cursor
        #提交数据到数据库
        #提交事务
        #关闭cursor和链接
        :param sql:
        :return:
        """
        count = 0
        try:
            # 连接数据库
            self.connet()
            count = self.cursor.execute(sql)
            # 提交事务
            self.db.commit()
            # 关闭数据库
            self.close()
            print("数据库语句执行完毕！")
        except:
            print("事务提交失败！")
            self.db.rollback()
        return count


if __name__ == '__main__':
    hu_mysql = Mysql_SQL(**mysql_info)
    hu_mysql.connet()
    # get_one = hu_mysql.get_one("select * from students1;")
    # print(get_one)

    # find_all = hu_mysql.get_all("select * from students1;")
    # for i in find_all:
    #     print(i)
    # sql = 'INSERT INTO students1 (`name`,`nickname`,`sex`) VALUES ("hu2","xiaojian2","男");'
    # hu_mysql.insert(sql)

    sql = 'INSERT INTO students1 (`name`,`nickname`,`sex`) VALUES ({},{},{});'
    sql = sql.format('"hu3"','"xiaojian3"','"男"')
    hu_mysql.insert(sql)
```

使用 mysql 封装类中的方法

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
__author__ = 'xiaojian'
from Mysql_base_class import Mysql_SQL

hu = Mysql_SQL("192.168.2.122","root","123456","ttmgrportal")

res = hu.get_all("select * from student4 where money>100")
for row in res:
    print("%d -- %d" % (row[0], row[1]))
```

#### 封装类方法 2

```python
import pymysql
from configparser import ConfigParser

class MySQLDao:
    def __init__(self, config_file):
        self.config = ConfigParser()
        self.config.read(config_file)
        self.db_config = self.config['dbMysql']
        self.connection = None
        self.cursor = None

    def connect(self):
        host = self.db_config.get('host')
        port = self.db_config.getint('port')
        user = self.db_config.get('user')
        password = self.db_config.get('password')
        self.connection = pymysql.connect(host=host, port=port, user=user, password=password)
        self.cursor = self.connection.cursor()

    def execute_query(self, query, params=None):
        self.cursor.execute(query, params)
        result = self.cursor.fetchall()
        return result

    def execute_update(self, query, params=None):
        self.cursor.execute(query, params)
        return self.cursor.rowcount

    def execute_transaction(self, queries):
        try:
            self.connection.begin()
            for query, params in queries:
                self.cursor.execute(query, params)
            self.connection.commit()
            return True
        except Exception as e:
            self.connection.rollback()
            return False

    def insert_records(self, table, data_list):
        queries = []
        for data in data_list:
            columns = ', '.join(data.keys())
            values = ', '.join(['%s'] * len(data))
            query = f"INSERT INTO {table} ({columns}) VALUES ({values})"
            queries.append((query, tuple(data.values())))
        return self.execute_transaction(queries)

    def delete_records(self, table, condition):
        query = f"DELETE FROM {table} WHERE {condition}"
        return self.execute_update(query)

    def update_records(self, table, data_list, condition):
        queries = []
        for data in data_list:
            set_clause = ', '.join([f"{key} = %s" for key in data.keys()])
            query = f"UPDATE {table} SET {set_clause} WHERE {condition}"
            queries.append((query, tuple(data.values())))
        return self.execute_transaction(queries)

    def select_records(self, table, condition=None):
        query = f"SELECT * FROM {table}"
        if condition:
            query += f" WHERE {condition}"
        return self.execute_query(query)

    def close_connection(self):
        if self.cursor:
            self.cursor.close()
        if self.connection:
            self.connection.close()
```

小结：pymysql 模块主要为我们提供连接数据库和获取执行 sql 结果的方法。
