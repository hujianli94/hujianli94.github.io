# 10.自动化运维系统的开发

## 10.1 MySQL 自动化运维背景

在小规模的生产环境中，DBA 常通过直连客户端的方式，通过命令行来执行管理数据库的操作。

但是当 MySQL 实例数量不断增长时，仅凭人工去逐台登录服务器来完成诸如安装配置 MySQL、部署监控等操作将会增加大量重复性的工作，同时也会增加配置出错的概率。

在这种情况下，DBA 通过编写定制化脚本，通过批量管理工具在多台服务器上执行命令或脚本，减少了重复性工作，在一定程度上提升了运维的效率。

但这种方式也会出现如数据库信息统计困难、监控时效性差、脚本多版本难以管理等问题，或者从根本上说仍然是运维人员登录服务器进行操作，并没有实质上提升运维效率。

因此我们需要一个自动化运维平台，提供清晰简洁的可视化客户端界面，有一套后台系统管理资产信息与数据库信息，后台能调度管理所有脚本，从而完成 MySQL 部署与监控的工作，并能自动地收集数据库运行时的监控信息，将异常报警信息发送给运维人员。

这样在 MySQL 节点数量与压力高速增长时，运维仍能保证系统的稳定运行。下面介绍平台的基本架构。

如图所示，一个 MySQL 自动化运维平台通常分为后台管理系统、任务调度系统、客户端三大模块。

(1)后台管理系统，也被称为 CMDB(Configuration Management Database),具体包括以下 3 个模块。

- CMDB 数据库：存储了服务器的资产信息，MySQL 部署信息与监控运行信息等系统的内部信息，使用的数据库和存储的内容依据业务内部逻辑制定。为保证数据的一致性与可靠性，系统仅通过 API 与 CMDB 数据库进行数据的交互。

- 批量管理系统：通过批量的执行相同任务，完成管理多个 MySOL 实例的系统。系统可以直接在主机上执行指令，或是传递指令给任务调度系统调度执行，从而实现在一台主机上操作多台主机的功能。我们使用 SaltStack 做批量管理工具。

- 后台 API:主要提供数据库信息的调度服务，CMDB 数据库的信息都通过 API 来读取与存储。后台 API 提供了客户端，数据库和批量管理系统间的命令调度方法。我们使用 Django REST Framework 来完成 API 的开发。

![](https://cdn.jsdelivr.net/gh/hujianli94/Picgo-atlas@main/img/202312302032936.png){: .zoom}

(2)任务调度系统，主要功能是帮助批量管理系统处理任务。由批量管理系统传递到任务调度系统的任务，由该系统进行队列分发，通过异步或定时的方式执行相关操作，完成诸
如安装 MySQL 这类耗时较长的任务或 MySQL 运行状态的定期监控这类定时任务。我们选用 Celery 作为任务调度的工具。

(3)客户端，提供了查看各类信息的可视化界面，如显示数据库信息、任务的调度状态、日志信息、监控信息等内容。本章选用 Vujs 作为客户端开发的工具。

下面来详细介绍每个部分的系统架构设计和搭建方式。

## 10.2 CMDB 系统搭建

CMDB 系统是整个平台的核心部分，支持系统中数据的调度与持久化，发送任务请求，管理平台上的所有服务器等功能，需要有较高的可靠性。下面我们逐个介绍组成 CMDB 系统的主要组件。

### 10.2.1 CMDB 数据库

CMDB 数据库是自动化运维平台的数据基础，记录了系统所有必要的数据信息，如服务器信息、MySQL 实例信息、监控信息、配置项、数据变动信息、任务调度信息等多项内容。

为了保证配置库中数据与实际线上业务数据的一致性，CMDB 数据库中信息只能通过 API 调度来实现修改。

为了方便理解，本章以服务器和数据库信息两个配置表为例来介绍 CMDB 数据库，而在实际的应用中还需要记录配置信息、监控信息、任务信息等多种信息。

服务器和数据库信息两表中记录的主要信息如下。

- 服务器信息表：至少需要记录服务器名称、网络信息、类型、状态等内容。

- 数据库信息表：至少需要记录数据库所属服务器、启动端口、版本、实例用户、配置文件信息、状态等内容。
