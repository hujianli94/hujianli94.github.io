# 7.Python自动化管理


## 7.1 使用SSH访问远程服务器

SSH(Secure Shell)是一种由IETF的网络工作小组制定、创建在应用层和传输层基础上的安全协议，为计算机上的Shell提供安全的传输和使用环境。


### 7.1.1 SSH 协议

在互联网早期，通信都是明文的，如rsh、FTP、POP和Telnet。

一旦通信报文被截获内容就泄漏无疑。

1995年，芬兰学者Tatu Ylonen设计了SSH协议，将登录信息全部加密，成为互联网安全的一个基本解决方案。

这个方案迅速在全世界获得推广，目前已经成为Linux系统的标准配置。


SSH只是一种协议，存在多种实现，既有商业实现，也有开源实现。目前，在Liux下广泛使用的是OpenSSH,它是一款应用广泛的开源软件。

即将介绍的paramiko是SSH协议的一种Python实现。


S$H除了提供安全的传输和登录以外，还可以进行批量命令执行，使用非常方便。

正是由于SSH简单好用的特点，常见的Ansible工具,都依赖SSH进行远程服务器的管理。


使用SSH的好处非常明显，既充分利用了现成的机制，又省去了在远程服务器安装代理（Agent)程序。因此，诸多自动化工具都依赖于SSH。



### 7.1.2 OpenSSH实现

OpenSSH客户端是一个名为ssh可执行程序，ssh命令连接远程服务器，示例如下
```sh
ssh username@remote_host
```

非22端口号

```sh
ssh username@remote_host -p port
```


不进入交互式的shell

```sh
ssh username@remote_host 'COMMANDS'
```

## 7.2 使用Polysh批量管理服务器









## 7.3 使用paramiko免密远程执行shell

使用paramiko库：https://github.com/paramiko/paramiko


账号密码登录执行命令

```python
#!/usr/bin/python
#ssh
import paramiko
import sys,os

host = '10.152.15.200'
user = 'peterli
password = '123456'

s = paramiko.SSHClient()                                 # 绑定实例
s.load_system_host_keys()                                # 加载本地HOST主机文件
s.set_missing_host_key_policy(paramiko.AutoAddPolicy())  # 允许连接不在know_hosts文件中的主机
s.connect(host,22,user,password,timeout=5)               # 连接远程主机
while True:
        cmd=raw_input('cmd:')
        stdin,stdout,stderr = s.exec_command(cmd)        # 执行命令
        cmd_result = stdout.read(),stderr.read()         # 读取命令结果
        for line in cmd_result:
                print line,
s.close()
```


```python
#!/usr/bin/env python
#-*- coding:utf8 -*-
import paramiko
import time

ip = "172.16.10.10"
port= 22
username="root"
passwd="superadmin"


def ssh2(ip,port,username,passwd,cmd):
    try:
        ssh = paramiko.SSHClient()
        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        ssh.connect(ip,port,username,passwd,timeout=5)
        chan=ssh.invoke_shell()
        print(chan.recv(1024))
        for m in cmd:
            res = chan.sendall(m+"\n")
            time.sleep(float(1))
        print(chan.recv(1024))
        ssh.close()
    except Exception as e:
        print(e)

cmd=['ls']
ssh2(ip,port,username,passwd,cmd)
```

使用ssh公钥登录执行命令

```python
#!/usr/bin/env python
#-*- coding:utf8 -*-
import paramiko,sys
# 创建SSHClient对象
hostname = "172.16.10.10"
port=22
username="root"
password="superadmin"

#使用公钥登录ssh，进行连接
def ssh_connect_key(host,user,key_file,cmd):
    ssh=paramiko.SSHClient()
    ssh.load_system_host_keys()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    key=paramiko.RSAKey.from_private_key_file(key_file)
    ssh.connect(hostname=host,username=user,pkey=key,timeout=30)
    stdin,stdout,stderr=ssh.exec_command(cmd)
    result=stdout.read().decode()     #python3 bytes格式转换为sting,python2无需decode,result=str(stdout.read(),'utf8)
    ssh.close()
    return result

#使用用户名、密码来登录
def ssh_connect(host,user,password,cmd):
    ssh=paramiko.SSHClient()
    ssh.load_system_host_keys()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(hostname=host,username=user,password=password,timeout=30)
    stdin,stdout,stderr=ssh.exec_command(cmd)
    result=stdout.read()
    ssh.close()
    return result

if __name__ == '__main__':
    # a=len(sys.argv)
    # if a!=5:
    #     print ("参数个数不对，请输入四个参数!")
    # else:
    #     host=sys.argv[1]
    #     user=sys.argv[2]
    #     password=sys.argv[3]
    #     cmd=sys.argv[4]
    #     try:
    #         out=ssh_connect(host,user,password,cmd)
    #         print (out)
    #     except:
    #         print ("usages:python ssh2.py '192.168.10.129' 'root' '123456' 'ls /root'")

    ssh_connect(hostname,username,password,"df -Th")
```



简单封装SSH类

```python
import paramiko


class SSH:

    def __init__(self, host, port, user, ssh_key_path, timeout=1800):
        self.host = host
        self.port = port
        self.user = user
        self.ssh_key_path = ssh_key_path
        self.timeout = timeout
        self.connect()

    def connect(self):
        client = paramiko.SSHClient()
        client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        pkey = paramiko.RSAKey.from_private_key_file(self.ssh_key_path)
        client.connect(hostname=self.host, username=self.user, port=self.port, pkey=pkey, timeout=self.timeout)
        self.client = client

    def exec(self, shell, timeout=1800):
        stdin, stdout, stderr = self.client.exec_command(command=shell, bufsize=1, timeout=timeout)
        while True:
            line = stdout.readline()
            if not line:
                break
            print(line)
        print(stderr.read())
        code = stdout.channel.recv_exit_status()
        return code

    def close(self):
        self.client.close()
```