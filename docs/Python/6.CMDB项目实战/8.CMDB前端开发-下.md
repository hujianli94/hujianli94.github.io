# 8.CMDB前端开发-下



CMDB前端开发-IDC管理



## IDC管理

1.首先需要将布局做一下调整， 目录结构如下

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.839ry6y01e.webp){: .zoom}



2.删除原先的A~D.vue文件，修改 `router/index.js` 路由文件如下：

```js
import {createRouter, createWebHistory} from 'vue-router'
import Layout from '../views/Layout.vue'

const routes = [
    {
        path: '/login',
        name: '登录',
        component: () => import('../views/Login.vue')
    },
    {
        path: '/',
        name: '首页',
        component: Layout,
        redirect: '/dashboard',
        children: [
            {
                path: '/dashboard',
                name: '仪表盘',
                icon: 'Monitor',
                component: () => import('../views/dashboard/Dashboard.vue')
            }
        ]
    },
    {
        path: '/server',
        name: '主机管理',
        icon: 'Setting',
        component: Layout,
        children: [
            {
                path: '/idc',
                name: '机房管理',
                component: () => import('../views/idc/Idc')
            },
            {
                path: '/server_group',
                name: '主机分组',
                component: () => import('../views/servergroup/ServerGroup')
            },
            {
                path: '/server',
                name: '服务器管理',
                component: () => import('../views/server/Server')
            },
        ]
    },
    {
        path: '/sysconfig',
        name: '系统配置',
        icon: 'PieChart',
        component: Layout,
        children: [
            {
                path: '/credential',
                name: '凭据管理',
                component: () => import('../views/credential/Credential')
            }
        ]
    }
]

const router = createRouter({
    history: createWebHistory(process.env.BASE_URL),
    routes
})

// 添加导航守卫
router.beforeEach((to, from, next) => {
    // 如果用户访问登录页，直接放行
    if (to.path == '/login') {
        return next()
    }
    // 从sessionStorage获取token值
    const token = window.sessionStorage.getItem('token');
    // 如果没有获取到token值，跳转到登录页
    if (!token) {
        return next('/login')
    }
    // 正常跳转
    next()
});

export default router
```

### IDC列表雏形

1.启动cmdb后端

2.根据card， table文档实现初步布局： `views/idc/Idc.vue`


```html
<template>
  <el-card class="box-card">
    <el-table :data="tableData" style="width: 100%">
      <el-table-column prop="name" label="机房名称" width="180"/>
      <el-table-column prop="city" label="所在城市" width="180"/>
      <el-table-column prop="provider" label="提供商"/>
      <el-table-column prop="note" label="备注"/>
      <el-table-column prop="create_time" label="创建时间"/>
      <el-table-column flexd="right" label="操作栏" width="120px">
        <template #default>
          <el-button link type="primary" size="small" @click="EditIdc">编辑</el-button>
          <el-button link type="primary" size="small" @click="DeleteIdc">删除</el-button>
        </template>
      </el-table-column>
    </el-table>
  </el-card>
</template>

<script>
export default {
  name: "Idc",
  data() {
    return {
      tableData: ''
    }
  },
  methods: {
    getData() {
      this.$http.get('cmdb/idc/')
          .then(res => {
            this.tableData = res.data.data
          })
    }
  },
  mounted() {
    this.getData()
  }
}
</script>

<style scoped>

</style>
```

3.登录之后初步效果展示如下

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.361b4cy4uc.webp){: .zoom}



4.为了美观，调整一下 logo-title 图标的显示，调整代码如下

```html
<template>
  <div class="common-layout">
    <el-container>
      <el-aside :width="isCollapse ? '64px' : '200px'">
        <el-menu
            default-active="2"
            background-color="#304156"
            text-color="#FFFFFF"
            active-text-color="#ffd04b"
            class="el-menu"
            @open="handleOpen"
            @close="handleClose"
            :collapse="isCollapse"
            :collapse-transition="false"
            router
        >
          <div class="logo-title">
            <router-link to="/">
              <img src="../assets/cmdb.png" style="margin-top: 15px;"/>
            </router-link>
            <!--默认显示logo字体，侧边栏搜索隐藏logo字体-->
            <span v-if="isTitle">运维管理系统</span>
          </div>
          <template v-for="menu in this.$router.options.routes" :key="menu">

            <!--处理一级菜单没有子路由-->
            <!--            <el-menu-item v-if="!menu.children && menu.path != '/login'" :index="menu.path">-->
            <!--              &lt;!&ndash;字体图标&ndash;&gt;-->
            <!--              <el-icon>-->
            <!--                <component :is="menu.icon" color="#79bbff"></component>-->
            <!--              </el-icon>-->
            <!--              <span>{{ menu.name }}</span>-->
            <!--            </el-menu-item>-->

            <!-- 处理仪表盘 -->
            <el-menu-item v-if="menu.path == '/'" :index="menu.children[0].path">
              <!--字体图标-->
              <el-icon>
                <component :is="menu.children[0].icon" color="#79bbff"/>
              </el-icon>
              <span>{{ menu.children[0].name }}</span>
            </el-menu-item>

            <!--处理一级菜单有子路由-->
            <el-sub-menu v-else-if="menu.children" :index="menu.path">
              <template #title>
                <!--字体图标-->
                <el-icon>
                  <component :is="menu.icon" color="#79bbff"></component>
                </el-icon>
                <span>{{ menu.name }}</span>
              </template>

              <!--循环二级菜单-->
              <el-menu-item v-for="child in menu.children" :key="child" :index="child.path">
                {{ child.name }}
              </el-menu-item>
            </el-sub-menu>

          </template>
        </el-menu>
      </el-aside>
      <el-container>
        <el-header>
          <!-- 导航栏折叠-->
          <div class="toggleCollapse">
            <el-icon :size="25" @click="toggleCollapse">
              <Fold/>
            </el-icon>
          </div>
          <!-- 头像-->
          <el-dropdown>
            <span class="el-dropdown-link">
              <img src="../assets/touxiang.jpeg" alt="">
              <span> {{ username }} </span>
            </span>
            <template #dropdown>
              <el-dropdown-menu>
                <el-dropdown-item icon="Avatar" command="PersonalCenter">个人中心</el-dropdown-item>
                <el-dropdown-item icon="EditPen" @click="dialogVisible=true">密码修改</el-dropdown-item>
                <el-dropdown-item icon="Operation" @click="logout">退出登录</el-dropdown-item>
              </el-dropdown-menu>
            </template>
          </el-dropdown>
        </el-header>
        <el-main>
          <!-- 占位符，显示路由跳转后加载的内容-->
          <router-view></router-view>
        </el-main>
      </el-container>
    </el-container>
  </div>

  <!--  修改密码对话框 dialogVisible 在修改密码按钮处有click事件调起-->
  <el-dialog
      v-model="dialogVisible"
      title="修改密码"
      width="30%"
  >
    <el-form :model="UserPasswordForm" label-position="right" label-width="100px" :rules="rules" ref="UserPasswordForm">
      <el-form-item label="原密码：" prop="old_password">
        <el-input
            v-model="UserPasswordForm.old_password"
            type="password"
            show-password
        ></el-input>
      </el-form-item>
      <el-form-item label="新密码：" prop="new_password">
        <el-input
            v-model="UserPasswordForm.new_password"
            type="password"
            show-password
        ></el-input>
      </el-form-item>
      <el-form-item label="再次确认：" prop="confirm_password">
        <el-input
            v-model="UserPasswordForm.confirm_password"
            type="password"
            show-password
        ></el-input>
      </el-form-item>
    </el-form>
    <template #footer>
      <span class="dialog-footer">
        <el-button @click="dialogVisible = false">取消</el-button>
        <el-button type="primary" @click="changePasswordSubmit">确定</el-button>
      </span>
    </template>
  </el-dialog>
</template>


<script>
export default {
  name: 'Layout',
  data() {
    // 新旧密码校验规则
    const checkNewOldPassword = (rule, value, callback) => {
      if (value == this.UserPasswordForm.old_password) {
        callback(new Error('新密码不能与旧密码一样！'))
      } else {
        return callback()
      }
    };
    const checkNewPassword = (rule, value, callback) => {
      if (value != this.UserPasswordForm.new_password) {
        callback(new Error('两次输入密码不一致！'))
      } else {
        return callback()
      }
    };
    return {
      isCollapse: false,
      isTitle: true,
      username: window.sessionStorage.getItem('username'),
      dialogVisible: false,
      UserPasswordForm: {
        old_password: '',
        new_password: '',
        confirm_password: ''
      },
      rules: {
        old_password: [
          {required: true, message: '请输入原密码', trigger: 'blur'},
          {min: 6, message: '密码长度应不小于6个字符', trigger: 'blur'}
        ],
        new_password: [
          {required: true, message: '请输入新密码', trigger: 'blur'},
          {min: 6, message: '密码长度应不小于6个字符', trigger: 'blur'},
          {validator: checkNewOldPassword, trigger: 'blur'}
        ],
        confirm_password: [
          {required: true, message: '请确认新密码', trigger: 'blur'},
          {min: 6, message: '密码长度应不小于6个字符', trigger: 'blur'},
          {validator: checkNewPassword, trigger: 'blur'}
        ]
      },
    }
  },
  methods: {
    // 触发折叠按钮
    toggleCollapse() {
      // 根据已有的值进行取反，是true就取false，是false取反就是true
      this.isCollapse = !this.isCollapse
      this.isTitle = !this.isTitle
    },
    //退出登录函数
    logout() {
      window.sessionStorage.clear()
      this.$router.push('/login')
    },
    changePasswordSubmit() {
      // 提交前预验证
      this.$refs.UserPasswordForm.validate((valid) => {
        // 回调函数中valid布尔值
        console.log(this.UserPasswordForm)
        if (valid) {
          //获取用户名
          const username = window.sessionStorage.getItem('username')
          this.UserPasswordForm['username'] = username
          this.$http.post('/change_password/', this.UserPasswordForm)
              .then(res => {
                if (res.data.code == 200) {
                  this.$message.success(res.data.msg);
                  this.dialogVisible = false
                }
              })
        }
      })
    }
  }

}
</script>
<style>
.common-layout, .el-container, .el-menu {
  height: 100%;
}

.el-header {
  border-bottom: 1px lightgrey solid;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.el-aside {
  background: grey;
}

.el-main {
  background-color: #E9EEF3;
}

.collapse-transition {
  cursor: pointer;
}

.logo img {
  width: 200px;
  height: 60px;
  /*margin-left: 10px;*/
}

.el-dropdown-link {
  display: flex;
  align-items: center;
}

.el-dropdown-link img {
  width: 30px; /* 图像宽度 */
  height: 30px; /* 图像高度 */
  border-radius: 50%; /* 设置为圆形 */
  margin-right: 5px; /* 图像和用户名之间的间距 */
}

.el-dropdown-link span {
  font-size: 14px; /* 用户名字体大小 */
}

.logo-title {
  background-color: #2b2f3a;
  margin-bottom: 10px;
  height: 50px;
  border: none;
  line-height: 50px;
  display: flex;
  align-items: center;
  padding-left: 15px;
  color: #fff;
}

.logo-title img {
  width: 32px;
  height: 32px;
  margin-right: 10px;
}

.logo-title span {
  font-weight: bold;
  font-size: 16px;
  line-height: 50px;
  font-family: Averir, Helvetica Neue, Arial, Helvetica, sans-serif;
  vertical-align: middle;
}
</style>
```

5.效果展示如下

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.99t36tr46b.webp){: .zoom}



### 添加IDC列表分页

1.确认后端需要具备分页能力

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.92pvbefbfw.webp){: .zoom}



2.调整idc视图，配置分页相关内容: `views/idc/Idc.vue`

```html
<template>
  <el-card class="box-card">
    <el-table
        :data="tableData"
        border="1px"
        style="width: 100%"
    >
      <el-table-column prop="name" label="机房名称" width="180"/>
      <el-table-column prop="city" label="所在城市" width="180"/>
      <el-table-column prop="provider" label="提供商"/>
      <el-table-column prop="note" label="备注"/>
      <el-table-column prop="create_time" label="创建时间"/>
      <el-table-column flexd="right" label="操作栏" width="150px">
        <template #default>
          <el-button type="primary" size="small" @click="EditIdc">编辑</el-button>
          <el-button type="danger" size="small" @click="DeleteIdc">删除</el-button>
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页-->
    <div style="margin-top: 20px">
      <el-pagination
          v-model:currentPage="currentPage"
          :page-sizes="[10, 15, 20, 25, 30]"
          :page-size="pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="total"
          background
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
      >
      </el-pagination>
    </div>
  </el-card>
</template>

<script>
export default {
  name: "Idc",
  data() {
    return {
      tableData: '',
      currentPage: 1,  //默认第一页
      pageSize: 10,   //默认每页10条
      total: 0,       //总条数
      urlParams: {
        page_num: 1,
        page_size: 10
      }
    }
  },
  methods: {
    getData() {
      this.$http.get('cmdb/idc/', {params: this.urlParams})
          .then(res => {
            this.tableData = res.data.data;
            this.total = res.data.count;

          })
    },
    //监听每页数量的事件
    handleSizeChange(pageSize) {
      this.pageSize = pageSize;
      this.urlParams.page_size = pageSize;
      this.getData()
    },
    //监听页码变动的事件
    handleCurrentChange(currentPage) {
      this.currentPage = currentPage; // 重新设置分页显示
      this.urlParams.page_num = currentPage;
      this.getData()
    }
  },
  mounted() {
    this.getData()
  }
}
</script>

<style scoped>

</style>
```


3.前端效果展示

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.lvgrr89fc.webp){: .zoom}



> 注意，鼠标挫滚轮调整大小时，会有如下报错：`ResizeObserver loop completed with undelivered notifications.`


在vue3中使用element-plus页面重置报 ResizeObserver loop completed with undelivered notifications.

[解决办法如下](https://blog.csdn.net/qq_59502044/article/details/132140503)



4.后端效果展示

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.7smy53f6l3.webp){: .zoom}



### IDC 信息编辑

- 使用子组件 `IdcEdit.vue` 方式来简化 `Idc.vue` 的代码量

1.新增子组件， 并配置好数据校验等： `views/idc/IdcEdit.vue`

```html
<template>
  <!--操作栏：编辑对话框-->
  <el-dialog
      :model-value="visible"
      width="30%"
      title="修改机房信息"
      @close="dialogClose"
  >
    <el-form :model="row" ref="formRef" :rules="formRules" label-width="100px">
      <el-form-item label="机房名称：" prop="name">
        <el-input v-model="row.name"></el-input>
      </el-form-item>
      <el-form-item label="城市：" prop="city">
        <el-input v-model="row.city"></el-input>
      </el-form-item>
      <el-form-item label="运营商：" prop="provider">
        <el-input v-model="row.provider"></el-input>
      </el-form-item>
      <el-form-item label="备注：">
        <el-input v-model="row.note" type="textarea"></el-input>
      </el-form-item>
    </el-form>

    <template #footer>
      <span class="dialog-footer">
        <el-button @click="dialogClose">取消</el-button>
        <el-button type="primary" @click="submit">确定</el-button>
      </span>
    </template>
  </el-dialog>
</template>

<script>
export default {
  name: "IdcEdit",
  props: {
    visible: Boolean,
    row: '', //父组件传递过来的当前行数据
  },
  data() {
    return {
      //校验规则
      formRules: {
        name: [
          {required: true, message: '请输入机房名称', trigger: 'blur'},
          {min: 2, message: '机房名称长度应不小于2个字符', trigger: 'blur'}
        ],
        city: [
          {required: true, message: '请输入城市', trigger: 'blur'},
          {min: 2, message: '城市长度应不小于2个字符', trigger: 'blur'}
        ],
        provider: [
          {required: true, message: '请输入运营商', trigger: 'blur'},
          {min: 2, message: '运营商长度应不小于2个字符', trigger: 'blur'}
        ]
      }
    }

  },
  methods: {
    //提交更新
    submit() {
      this.$refs.formRef.validate((valid) => {
        if (valid) {
          this.$http.put('/cmdb/idc/' + this.row.id + '/', this.row)
              .then(res => {
                if (res.data.code == 200) {
                  this.$message.success(res.data.msg);
                  this.$parent.getData();  // 调用父组件方法，更新数据
                  this.dialogClose()  // 关闭窗口
                }
              })
        } else {
          this.$message.error('格式错误！')
        }
      })
    },
    //关闭对话框，需要emit父组件关闭对话框
    dialogClose() {
      // 父组件必须使用 v-model
      this.$emit('update:visible', false)
    }
  }
}
</script>

<style scoped>

</style>
```

2.需要修改idc后端视图：`devops_api/cmdb/views.py`

```python
class IdcViewSet(ModelViewSet):
    queryset = Idc.objects.all()
    serializer_class = IdcSerializers
    filter_backends = [filters.SearchFilter, filters.OrderingFilter, DjangoFilterBackend]
    search_fields = ('name', 'city', 'provider')  # 指定可搜索的字段
    filterset_fields = ('name', 'city',)  # 指定可过滤的字段
    # 排序
    # 注意 filter_backends多了一个filters.OrderingFilter
    ordering_fields = ["id", "name"]

    # 认证&权限配置
    # authentication_classes = [SessionAuthentication]
    permission_classes = [IsAuthenticated]

    def destroy(self, request, *args, **kwargs):
        instance = self.get_object()
        try:
            self.perform_destroy(instance)
            res = {'code': 200, 'msg': '删除成功'}
        except Exception as e:
            res = {'code': 500, 'msg': '该IDC机房管理关联其他应用，请删除关联的应用再操作'}
        return Response(res)

    # 重写更新方法
    def update(self, request, *args, **kwargs):
        partial = kwargs.pop('partial', False)
        instance = self.get_object()
        serializer = self.get_serializer(instance, data=request.data, partial=partial)
        serializer.is_valid(raise_exception=True)
        self.perform_update(serializer)
        # res = {'code': 500, 'msg': '主机配置信息同步失败，错误信息： %s' % result['msg']}
        res = {'code': 200, 'msg': '修改成功'}
        return Response(res)
```

3.修改前端Idc.vue, 实现父组件引用子组件：`views/idc/Idc.vue`


```html
<template>
  <el-card class="box-card">
    <el-table
        :data="tableData"
        border="1px"
        style="width: 100%"
    >
      <el-table-column prop="name" label="机房名称" width="180"/>
      <el-table-column prop="city" label="所在城市" width="180"/>
      <el-table-column prop="provider" label="提供商"/>
      <el-table-column prop="note" label="备注"/>
      <el-table-column prop="create_time" label="创建时间"/>
      <el-table-column flexd="right" label="操作栏" width="150px">
        <template #default="scope">
          <el-button type="primary" size="small" @click="EditIdc(scope.$index,scope.row)">编辑</el-button>
          <el-button type="danger" size="small" @click="DeleteIdc=(scope.$index,scope.row)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页-->
    <div style="margin-top: 20px">
      <el-pagination
          v-model:currentPage="currentPage"
          :page-sizes="[10, 15, 20, 25, 30]"
          :page-size="pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="total"
          background
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
      >
      </el-pagination>
    </div>
  </el-card>
  <!--  idc编辑-->
  <IdcEdit v-model:visible="editDialogVisible" :row="currentRow"></IdcEdit>
</template>

<script>
import IdcEdit from "@/views/idc/IdcEdit";

export default {
  components: {
    IdcEdit
  },
  name: "Idc",
  data() {
    return {
      tableData: '',
      currentPage: 1,   //默认第一页
      pageSize: 10,  //默认每页10条
      total: 0,      //总条数
      urlParams: {
        page_num: 1,
        page_size: 10
      },
      currentRow: '',
      editDialogVisible: false
    }
  },
  methods: {
    getData() {
      this.$http.get('cmdb/idc/', {params: this.urlParams})
          .then(res => {
            this.tableData = res.data.data;
            this.total = res.data.count;

          })
    },
    //监听每页数量的事件
    handleSizeChange(pageSize) {
      this.pageSize = pageSize;
      this.urlParams.page_size = pageSize;
      this.getData()
    },
    //监听页码变动的事件
    handleCurrentChange(currentPage) {
      this.currentPage = currentPage; // 重新设置分页显示
      this.urlParams.page_num = currentPage;
      this.getData()
    },
    EditIdc(index, row) {
      this.editDialogVisible = true;
      this.currentRow = row; //将当前行内容传递到子组件
    },
    DeleteIdc(index) {
    }
  },
  mounted() {
    this.getData()
  },
}
</script>

<style scoped>

</style>
```

4.效果展示

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.1lbk4z95vy.webp){: .zoom}


### IDC 信息删除

1.idc后端视图调整： `devops_api/cmdb/views.py`

```python
# ....
class IdcViewSet(ModelViewSet):
    queryset = Idc.objects.all()
    serializer_class = IdcSerializers
    filter_backends = [filters.SearchFilter, filters.OrderingFilter, DjangoFilterBackend]
    search_fields = ('name', 'city', 'provider')  # 指定可搜索的字段
    filterset_fields = ('name', 'city',)  # 指定可过滤的字段
    # 排序
    # 注意 filter_backends多了一个filters.OrderingFilter
    ordering_fields = ["id", "name"]

    # 认证&权限配置
    # authentication_classes = [SessionAuthentication]
    permission_classes = [IsAuthenticated]
    # 重写删除方法
    def destroy(self, request, *args, **kwargs):
        instance = self.get_object()
        try:
            self.perform_destroy(instance)
            res = {'code': 200, 'msg': '删除成功'}
        except Exception as e:
            res = {'code': 500, 'msg': '该IDC机房管理关联其他应用，请删除关联的应用再操作'}
        return Response(res)

    # 重写更新方法
    def update(self, request, *args, **kwargs):
        partial = kwargs.pop('partial', False)
        instance = self.get_object()
        serializer = self.get_serializer(instance, data=request.data, partial=partial)
        serializer.is_valid(raise_exception=True)
        self.perform_update(serializer)
        # res = {'code': 500, 'msg': '主机配置信息同步失败，错误信息： %s' % result['msg']}
        res = {'code': 200, 'msg': '修改成功'}
        return Response(res)
```

2.前端删除配置: `views/idc/Idc.vue`


```html
<!-- ... -->
  <el-card class="box-card">
    <el-table
        :data="tableData"
        border="1px"
        style="width: 100%"
    >
      <el-table-column prop="name" label="机房名称" width="180"/>
      <el-table-column prop="city" label="所在城市" width="180"/>
      <el-table-column prop="provider" label="提供商"/>
      <el-table-column prop="note" label="备注"/>
      <el-table-column prop="create_time" label="创建时间"/>
      <el-table-column flexd="right" label="操作栏" width="150px">
        <template #default="scope">
          <el-button type="primary" size="small" @click="EditIdc(scope.$index,scope.row)">编辑</el-button>
          <el-button type="danger" size="small" @click="DeleteIdc=(scope.$index,scope.row)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>
<!-- .... -->
<script>
import IdcEdit from "@/views/idc/IdcEdit";
export default {
  components: {
    IdcEdit
  },
  name: "Idc",
  data() {
    return {
      tableData: '',
      currentPage: 1,   //默认第一页
      pageSize: 10,  //默认每页10条
      total: 0,      //总条数
      urlParams: {
        page_num: 1,
        page_size: 10
      },
      currentRow: '',
      editDialogVisible: false
    }
  },
  methods: {
    getData() {
      this.$http.get('cmdb/idc/', {params: this.urlParams})
          .then(res => {
            this.tableData = res.data.data;
            this.total = res.data.count;

          })
    },
    //监听每页数量的事件
    handleSizeChange(pageSize) {
      this.pageSize = pageSize;
      this.urlParams.page_size = pageSize;
      this.getData()
    },
    //监听页码变动的事件
    handleCurrentChange(currentPage) {
      this.currentPage = currentPage; // 重新设置分页显示
      this.urlParams.page_num = currentPage;
      this.getData()
    },
    EditIdc(index, row) {
      this.editDialogVisible = true;
      this.currentRow = row; //将当前行内容传递到子组件
    },
    DeleteIdc(index, row) {
      this.$confirm("你确定要删除选中的吗？", "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning"
      })
          .then(() => {  // 点击确定
            this.$http.delete('/cmdb/idc/' + row.id + '/')
                .then(res => {
                  if (res.data.code === 200) {
                    this.$message.success(res.data.msg);
                    this.tableData.splice(index, 1); // 根据表格索引临时删除数据
                  }
                });
          })
    }
  },
  mounted() {
    this.getData()
  },
}
</script>
<!-- .... -->
```

3.效果展示

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.73tol4vk4r.webp){: .zoom}


![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.361b4glae3.webp){: .zoom}



### IDC 搜索功能

1.在前端 `views/idc/Idc.vue` 进行配置

```html
<template>
  <el-card class="box-card">
    <div class="tools">
      <!--  搜索框-->
      <div class="tools-left">
        <el-input
            v-model="urlParams.search"
            placeholder="请输入关键字"
            @keyup.enter="onSearch"
            clearable
            @clear="onSearch"
            class="search"
        />
        <el-button type="primary" @click="onSearch">
          <el-icon>
            <search/>
          </el-icon>&nbsp;搜索
        </el-button>
      </div>

      <div class="tools-right">
        <el-button type="primary" @click="onSearch">
          <el-icon>
            <search/>
          </el-icon>&nbsp;创建
        </el-button>
        <el-button type="primary" @click="onSearch">
          <el-icon>
            <search/>
          </el-icon>&nbsp;展示列
        </el-button>
      </div>

    </div>
    <el-table
        :data="tableData"
        border="1px"
        style="width: 100%"
    >
      <el-table-column prop="name" label="机房名称" width="180"/>
      <el-table-column prop="city" label="所在城市" width="180"/>
      <el-table-column prop="provider" label="提供商"/>
      <el-table-column prop="note" label="备注"/>
      <el-table-column prop="create_time" label="创建时间"/>
      <el-table-column flexd="right" label="操作栏" width="150px">
        <template #default="scope">
          <el-button type="primary" size="small" @click="EditIdc(scope.$index,scope.row)">编辑</el-button>
          <el-button type="danger" size="small" @click="DeleteIdc(scope.$index,scope.row)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页-->
    <div style="margin-top: 20px">
      <el-pagination
          v-model:currentPage="currentPage"
          :page-sizes="[10, 15, 20, 25, 30]"
          :page-size="pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="total"
          background
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
      >
      </el-pagination>
    </div>
  </el-card>
  <!--  idc编辑-->
  <IdcEdit v-model:visible="editDialogVisible" :row="currentRow"></IdcEdit>
</template>

<script>
import IdcEdit from "@/views/idc/IdcEdit";

export default {
  components: {
    IdcEdit
  },
  name: "Idc",
  data() {
    return {
      tableData: '',
      currentPage: 1,   //默认第一页
      pageSize: 10,  //默认每页10条
      total: 0,      //总条数
      urlParams: {
        page_num: 1,
        page_size: 10,
        search: ''
      },
      currentRow: '',
      editDialogVisible: false
    }
  },
  methods: {
    getData() {
      this.$http.get('cmdb/idc/', {params: this.urlParams})
          .then(res => {
            this.tableData = res.data.data;
            this.total = res.data.count;

          })
    },
    //监听每页数量的事件
    handleSizeChange(pageSize) {
      this.pageSize = pageSize;
      this.urlParams.page_size = pageSize;
      this.getData()
    },
    //监听页码变动的事件
    handleCurrentChange(currentPage) {
      this.currentPage = currentPage; // 重新设置分页显示
      this.urlParams.page_num = currentPage;
      this.getData()
    },
    EditIdc(index, row) {
      this.editDialogVisible = true;
      this.currentRow = row; //将当前行内容传递到子组件
    },
    DeleteIdc(index, row) {
      this.$confirm("你确定要删除选中的吗？", "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning"
      })
          .then(() => {  // 点击确定
            this.$http.delete('/cmdb/idc/' + row.id + '/')
                .then(res => {
                  if (res.data.code === 200) {
                    this.$message.success(res.data.msg);
                    this.tableData.splice(index, 1); // 根据表格索引临时删除数据
                  }
                });
          })
    },
    onSearch() {
      this.getData()
    }
  },
  mounted() {
    this.getData()
  },
}
</script>

<style scoped>
.tools {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
}

.tools-left {
  display: flex;
}

.tools-right {
  display: flex;
}

.search {
  width: 150px;
  margin-right: 10px;
}
</style>
```



2.效果展示

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.4910fcu5nm.png){: .zoom}



### IDC 新增数据

1.修改后端代码，新建视图调整： `devops_api/cmdb/views.py`

```python
# ....
class IdcViewSet(ModelViewSet):
    queryset = Idc.objects.all()
    serializer_class = IdcSerializers
    filter_backends = [filters.SearchFilter, filters.OrderingFilter, DjangoFilterBackend]
    search_fields = ('name', 'city', 'provider')  # 指定可搜索的字段
    filterset_fields = ('name', 'city',)  # 指定可过滤的字段
    # 排序
    # 注意 filter_backends多了一个filters.OrderingFilter
    ordering_fields = ["id", "name"]

    # 认证&权限配置
    # authentication_classes = [SessionAuthentication]
    permission_classes = [IsAuthenticated]

    # 重写删除方法
    def destroy(self, request, *args, **kwargs):
        instance = self.get_object()
        try:
            self.perform_destroy(instance)
            res = {'code': 200, 'msg': '删除成功'}
        except Exception as e:
            res = {'code': 500, 'msg': '该IDC机房管理关联其他应用，请删除关联的应用再操作'}
        return Response(res)

    # 重写更新方法
    def update(self, request, *args, **kwargs):
        partial = kwargs.pop('partial', False)
        instance = self.get_object()
        serializer = self.get_serializer(instance, data=request.data, partial=partial)
        serializer.is_valid(raise_exception=True)
        self.perform_update(serializer)
        # res = {'code': 500, 'msg': '主机配置信息同步失败，错误信息： %s' % result['msg']}
        res = {'code': 200, 'msg': '修改成功'}
        return Response(res)

    # 重写创建方法
    def create(self, request, *args, **kwargs):
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        try:
            self.perform_create(serializer)
            res = {'code': 200, 'msg': '创建idc成功'}
        except Exception as e:
            res = {'code': 500, 'msg': '创建idc失败%s' % e}
        return Response(res)
```

2.前端创建idc子组件： `views/idc/IdcCreate.vue`

```html
<template>
  <el-dialog :model-value="visible" width="30%" @close="dialogClose">
    <!--标题-->
    <template #header>
      <div style="font-size:18px; color:#409eff; font-weight:bold;">创建机房信息</div>
    </template>

    <el-form :model="form" ref="formRef" :rules="formRules" label-width="100px">
      <el-form-item label="机房名称：" prop="name">
        <el-input v-model="form.name"></el-input>
      </el-form-item>
      <el-form-item label="城市：" prop="city">
        <el-input v-model="form.city"></el-input>
      </el-form-item>
      <el-form-item label="运营商：" prop="provider">
        <el-input v-model="form.provider"></el-input>
      </el-form-item>
      <el-form-item label="备注：" prop="note">
        <el-input v-model="form.note" type="textarea"></el-input>
      </el-form-item>
    </el-form>

    <template #footer>
      <span class="dialog-footer">
        <el-button @click="dialogClose">取消</el-button>
        <el-button type="primary" @click="submit">确定</el-button>
      </span>
    </template>
  </el-dialog>
</template>

<script>
export default {
  name: 'IdcCreate',
  props: {
    visible: Boolean
  },
  data() {
    return {
      form: {
        name: '',
        city: '',
        provider: '',
        note: ''
      },
      formRules: {
        name: [
          {required: true, message: '请输入机房名称', trigger: 'blur'},
          {min: 2, message: '机房名称长度应不小于2个字符', trigger: 'blur'}
        ],
        city: [
          {required: true, message: '请输入城市', trigger: 'blur'},
          {min: 2, message: '城市长度应不小于2个字符', trigger: 'blur'}
        ],
        provider: [
          {required: true, message: '请输入运营商', trigger: 'blur'},
          {min: 2, message: '运营商长度应不小于2个字符', trigger: 'blur'}
        ]
      }
    }
  },
  methods: {
    submit() {
      this.$refs.formRef.validate(valid => {
        if (valid) {
          console.log(this.form)
          this.$http.post('/cmdb/idc/', this.form).then(res => {
            if (res.data.code == 200) {
              this.$message.success('创建成功')
              this.$parent.getData();// 调用父组件方法，更新数据
              this.dialogClose() // 关闭窗口
              this.$refs.formRef.resetFields() // 清空表单数据
            }
          })
        } else {
          this.$message.error('格式错误！')
        }
      })
    },
    // 点击关闭，子组件通知父组件更新属性
    dialogClose() {
      this.$emit('update:visible', false) // 父组件必须使用v-model
    }
  }
}
</script>
```



3.父组件引用： `views/idc/Idc.vue`

```html
<template>
  <el-card class="box-card">
    <div class="tools">
      <!--  搜索框-->
      <div class="tools-left">
        <el-input
            v-model="urlParams.search"
            placeholder="请输入关键字"
            @keyup.enter="onSearch"
            clearable
            @clear="onSearch"
            class="search"
        />
        <el-button type="primary" @click="onSearch">
          <el-icon>
            <search/>
          </el-icon>&nbsp;搜索
        </el-button>
      </div>

      <div class="tools-right">
        <el-button type="primary" @click="createDialogVisible=true"><el-icon><Plus/></el-icon>&nbsp;创建</el-button>
        <el-button type="primary" @click="onSearch"><el-icon><Setting/></el-icon>&nbsp;展示列</el-button>
      </div>
    </div>
    <el-table
        :data="tableData"
        border="1px"
        style="width: 100%"
    >
      <el-table-column prop="name" label="机房名称" width="180"/>
      <el-table-column prop="city" label="所在城市" width="180"/>
      <el-table-column prop="provider" label="提供商"/>
      <el-table-column prop="note" label="备注"/>
      <el-table-column prop="create_time" label="创建时间"/>
      <el-table-column flexd="right" label="操作栏" width="150px">
        <template #default="scope">
          <el-button type="primary" size="small" @click="EditIdc(scope.$index,scope.row)">编辑</el-button>
          <el-button type="danger" size="small" @click="DeleteIdc(scope.$index,scope.row)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页-->
    <div style="margin-top: 20px">
      <el-pagination
          v-model:currentPage="currentPage"
          :page-sizes="[10, 15, 20, 25, 30]"
          :page-size="pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="total"
          background
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
      >
      </el-pagination>
    </div>
  </el-card>
  <!--  idc编辑-->
  <IdcEdit v-model:visible="editDialogVisible" :row="currentRow"></IdcEdit>

  <!--  idc创建-->
  <IdcCreate v-model:visible="createDialogVisible"></IdcCreate>

</template>

<script>
import IdcEdit from "@/views/idc/IdcEdit";
import IdcCreate from "@/views/idc/IdcCreate";
export default {
  components: {
    IdcEdit,
    IdcCreate
  },
  name: "Idc",
  data() {
    return {
      tableData: '',
      currentPage: 1,   //默认第一页
      pageSize: 10,  //默认每页10条
      total: 0,      //总条数
      urlParams: {
        page_num: 1,
        page_size: 10,
        search: ''
      },
      currentRow: '',
      editDialogVisible: false,
      createDialogVisible: false
    }
  },
  methods: {
    getData() {
      this.$http.get('cmdb/idc/', {params: this.urlParams})
          .then(res => {
            this.tableData = res.data.data;
            this.total = res.data.count;

          })
    },
    //监听每页数量的事件
    handleSizeChange(pageSize) {
      this.pageSize = pageSize;
      this.urlParams.page_size = pageSize;
      this.getData()
    },
    //监听页码变动的事件
    handleCurrentChange(currentPage) {
      this.currentPage = currentPage; // 重新设置分页显示
      this.urlParams.page_num = currentPage;
      this.getData()
    },
    EditIdc(index, row) {
      this.editDialogVisible = true;
      this.currentRow = row; //将当前行内容传递到子组件
    },
    DeleteIdc(index, row) {
      this.$confirm("你确定要删除选中的吗？", "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning"
      })
          .then(() => {  // 点击确定
            this.$http.delete('/cmdb/idc/' + row.id + '/')
                .then(res => {
                  if (res.data.code === 200) {
                    this.$message.success(res.data.msg);
                    this.tableData.splice(index, 1); // 根据表格索引临时删除数据
                  }
                });
          })
    },
    onSearch() {
      this.getData()
    }
  },
  mounted() {
    this.getData()
  },
}
</script>

<style scoped>
.tools {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
}

.tools-left {
  display: flex;
}

.tools-right {
  display: flex;
}

.search {
  width: 150px;
  margin-right: 10px;
}
</style>
```


4.效果展示

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.6pn8uagrmp.webp){: .zoom}



### IDC 展示功能

1.展示列配置  `views/idc/Idc.vue`

```html
<template>
  <el-card class="box-card">
    <div class="tools">
      <!--  搜索框-->
      <div class="tools-left">
        <el-input
            v-model="urlParams.search"
            placeholder="请输入关键字"
            @keyup.enter="onSearch"
            clearable
            @clear="onSearch"
            class="search"
        />
        <el-button type="primary" @click="onSearch">
          <el-icon>
            <search/>
          </el-icon>&nbsp;搜索
        </el-button>
      </div>

      <div class="tools-right">
        <el-button type="primary" @click="createDialogVisible=true">
          <el-icon>
            <Plus/>
          </el-icon>&nbsp;创建
        </el-button>
        <!--展示列弹出框-->
        <el-popover placement="left" :width="100" v-model:visible="columnVisible">
          <template #reference>
            <el-button type="primary" @click="columnVisible=true">
              <el-icon>
                <setting/>
              </el-icon>&nbsp;展示列
            </el-button>
          </template>
          <el-checkbox v-model="showColumn.name" disabled>机房名称</el-checkbox>
          <el-checkbox v-model="showColumn.city">城市</el-checkbox>
          <el-checkbox v-model="showColumn.provider">运营商</el-checkbox>
          <el-checkbox v-model="showColumn.note">备注</el-checkbox>
          <el-checkbox v-model="showColumn.create_time">创建时间</el-checkbox>
          <!--    新增选择内容持久化配置-->
          <div style="text-align: right; margin: 0">
            <el-button size="small" type="text" @click="columnVisible = false">取消</el-button>
            <el-button size="small" type="primary" @click="saveColumn">确认</el-button>
          </div>
        </el-popover>
      </div>
    </div>
    <el-table
        :data="tableData"
        border="1px"
        style="width: 100%"
    >
      <el-table-column prop="name" label="机房名称"/>
      <el-table-column prop="city" label="所在城市" v-if="showColumn.city"/>
      <el-table-column prop="provider" label="提供商" v-if="showColumn.provider"/>
      <el-table-column prop="note" label="备注" v-if="showColumn.note"/>
      <el-table-column prop="create_time" label="创建时间" v-if="showColumn.create_time"/>
      <el-table-column flexd label="操作栏" width="150px">
        <template #default="scope">
          <el-button type="primary" size="small" @click="EditIdc(scope.$index,scope.row)">编辑</el-button>
          <el-button type="danger" size="small" @click="DeleteIdc(scope.$index,scope.row)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页-->
    <div style="margin-top: 20px">
      <el-pagination
          v-model:currentPage="currentPage"
          :page-sizes="[10, 15, 20, 25, 30]"
          :page-size="pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="total"
          background
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
      >
      </el-pagination>
    </div>
  </el-card>
  <!--  idc编辑-->
  <IdcEdit v-model:visible="editDialogVisible" :row="currentRow"></IdcEdit>

  <!--  idc创建-->
  <IdcCreate v-model:visible="createDialogVisible"></IdcCreate>

</template>

<script>
import IdcEdit from "@/views/idc/IdcEdit";
import IdcCreate from "@/views/idc/IdcCreate";

export default {
  components: {
    IdcEdit,
    IdcCreate
  },
  name: "Idc",
  data() {
    return {
      tableData: '',
      currentPage: 1,   //默认第一页
      pageSize: 10,  //默认每页10条
      total: 0,      //总条数
      urlParams: {
        page_num: 1,
        page_size: 10,
        search: ''
      },
      currentRow: '',
      editDialogVisible: false,
      createDialogVisible: false,
      columnVisible: false, // 可展示列显示与隐藏
      showColumn: {
        name: true,
        city: true,
        provider: true,
        note: true,
        create_time: true
      }
    }
  },
  methods: {
    getData() {
      this.$http.get('cmdb/idc/', {params: this.urlParams})
          .then(res => {
            this.tableData = res.data.data;
            this.total = res.data.count;

          })
    },
    //监听每页数量的事件
    handleSizeChange(pageSize) {
      this.pageSize = pageSize;
      this.urlParams.page_size = pageSize;
      this.getData()
    },
    //监听页码变动的事件
    handleCurrentChange(currentPage) {
      this.currentPage = currentPage; // 重新设置分页显示
      this.urlParams.page_num = currentPage;
      this.getData()
    },
    EditIdc(index, row) {
      this.editDialogVisible = true;
      this.currentRow = row; //将当前行内容传递到子组件
    },
    DeleteIdc(index, row) {
      this.$confirm("你确定要删除选中的吗？", "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning"
      })
          .then(() => {  // 点击确定
            this.$http.delete('/cmdb/idc/' + row.id + '/')
                .then(res => {
                  if (res.data.code === 200) {
                    this.$message.success(res.data.msg);
                    this.tableData.splice(index, 1); // 根据表格索引临时删除数据
                  }
                });
          })
    },
    onSearch() {
      this.getData()
    },
    saveColumn() {
      // 将可显示的字段存储到浏览器本地存储
      localStorage.setItem(this.$route.path + '-columnSet', JSON.stringify(this.showColumn));
      this.columnVisible = false;
    },
  },
  mounted() {
    this.getData()
    const columnSet = localStorage.getItem(this.$route.path + '-columnSet');
    if (columnSet) {
      this.showColumn = JSON.parse(columnSet)
    }
  },
}
</script>

<style scoped>
.tools {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
}

.tools-left {
  display: flex;
}

.tools-right {
  display: flex;
}

.search {
  width: 150px;
  margin-right: 10px;
}
</style>
```

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.syonaqb9w.webp){: .zoom}


![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.b8mypq6zl.webp){: .zoom}


![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.45f3a4z6w.webp){: .zoom}



2.效果展示

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.9gwb2dx0di.webp){: .zoom}





