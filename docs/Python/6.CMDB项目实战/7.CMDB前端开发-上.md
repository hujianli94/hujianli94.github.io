# 7.CMDB前端开发-上


## 大纲

- 登录页面
- 后台基本布局



## 登录页面

前端代码架构可以参考：  https://blog.51cto.com/devwanghui/6193473

开发前预览页面

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.231ls9hb42.webp){: .zoom}



### 仪表盘占位页面开发

1.创建视图： `devops_web/src/views/dashboard/Dashboard.vue`

```html
<template>
  这是仪表盘
</template>

<script>
export default {
  name: "Dashboard"
}
</script>

<style scoped>

</style>
```

2.dashboard路由处理： `devops_web/src/router/index.js`

```js
import {createRouter, createWebHistory} from 'vue-router'
import Layout from '../views/Layout.vue'

const routes = [
    {
        path: '/',
        name: '仪表盘',
        icon: 'Monitor',
        component: Layout,
        redirect: '/dashboard',
        children: [
            {
                path: '/dashboard',
                name: '仪表盘',
                icon: 'Monitor',
                component: () => import('../views/dashboard/Dashboard.vue')
            }
        ]
    },
    // .....
]

const router = createRouter({
    history: createWebHistory(process.env.BASE_URL),
    routes
})

export default router
```

3.Layout页面修改(将默认的首页设置为dashboard，并且是一级菜单)： `devops_web/src/views/Layout.vue`

```html
<template>
  <div class="common-layout">
    <el-container>
      <el-aside :width="isCollapse ? '64px' : '200px'">
        <el-menu
            default-active="2"
            background-color="#304156"
            text-color="#FFFFFF"
            active-text-color="#ffd04b"
            class="el-menu"
            @open="handleOpen"
            @close="handleClose"
            :collapse="isCollapse"
            :collapse-transition="false"
            router
        >
          <router-link to="/">
            <div class="logo-title">
              <img src="../assets/cmdb.png"/>
              <!--默认显示logo字体，侧边栏搜索隐藏logo字体-->
              <span v-if="isTitle">运维管理系统</span>
            </div>
          </router-link>
          <template v-for="menu in this.$router.options.routes" :key="menu">
            <!--处理一级菜单没有子路由-->
            <el-menu-item v-if="!menu.children && menu.path != '/login'" :index="menu.path">
              <!--字体图标-->
              <el-icon>
                <component :is="menu.icon" color="#79bbff"></component>
              </el-icon>
              <span>{{ menu.name }}</span>
            </el-menu-item>
          </template>
          <template v-for="menu in this.$router.options.routes" :key="menu">
            <!-- 处理仪表盘 -->
            <el-menu-item v-if="menu.path == '/'" :index="menu.children[0].path">
              <!--字体图标-->
              <el-icon>
                <component :is="menu.children[0].icon" color="#79bbff"/>
              </el-icon>
              <span>{{ menu.children[0].name }}</span>
            </el-menu-item>
            <!--处理一级菜单有子路由-->
            <el-sub-menu v-else-if="menu.children" :index="menu.path">
              <template #title>
                <!--字体图标-->
                <el-icon>
                  <component :is="menu.icon" color="#79bbff"></component>
                </el-icon>
                <span>{{ menu.name }}</span>
              </template>
              <!--循环二级菜单-->
              <el-menu-item v-for="child in menu.children" :key="child" :index="child.path">
                {{ child.name }}
              </el-menu-item>
            </el-sub-menu>
          </template>
        </el-menu>
      </el-aside>
      <el-container>
        <el-header>
          <!-- 导航栏折叠-->
          <div class="toggleCollapse">
            <el-icon :size="25" @click="toggleCollapse">
              <Fold/>
            </el-icon>
          </div>
          <!-- 头像-->
          <el-dropdown>
            <span class="el-dropdown-link">
              <img src="../assets/touxiang.jpeg" alt="">
            </span>
            <template #dropdown>
              <el-dropdown-menu>
                <el-dropdown-item>密码修改</el-dropdown-item>
                <el-dropdown-item>退出登录</el-dropdown-item>
              </el-dropdown-menu>
            </template>
          </el-dropdown>
        </el-header>
        <el-main>
          <!-- 占位符，显示路由跳转后加载的内容-->
          <router-view></router-view>
        </el-main>
      </el-container>
    </el-container>
  </div>
</template>


<script>
export default {
  name: 'Layout',
  data() {
    return {
      isCollapse: false,
      isTitle: true,
    }
  },
  methods: {
    // 触发折叠按钮
    toggleCollapse() {
      // 根据已有的值进行取反，是true就取false，是false取反就是true
      this.isCollapse = !this.isCollapse
      this.isTitle = !this.isTitle
    }
  }

}
</script>
<style>
.common-layout, .el-container, .el-menu {
  height: 100%;
}

.el-header {
  border-bottom: 1px lightgrey solid;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.el-aside {
  background: grey;
}

.el-main {
  background-color: #E9EEF3;
}

.collapse-transition {
  cursor: pointer;
}

.logo img {
  width: 200px;
  height: 60px;
  /*margin-left: 10px;*/
}

.el-dropdown-link img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  flex: auto;
}


.logo-title {
  background-color: rgba(82, 183, 109, 1);
  margin-bottom: 10px;
  height: 50px;
  border: none;
  line-height: 50px;
  display: flex;
  align-items: center;
  padding-left: 15px;
  color: #fff;
}

.logo-title img {
  width: 32px;
  height: 32px;
  margin-right: 10px;
  border-radius: 50%;
}

.logo-title span {
  font-weight: bold;
  font-size: 16px;
  line-height: 50px;
  font-family: Averir, Helvetica Neue, Arial, Helvetica, sans-serif;
  vertical-align: middle;
}
</style>
```


![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.39kx0vksnq.webp){: .zoom}


4.页面测试

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.6f0eztg8yy.webp){: .zoom}



### 登录页面大体布局和数据提交


#### 静态页面布局

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.pf2o8o7rf.webp){: .zoom}



1.登录页面准备独立页面：`devops_web/src/views/Login.vue`


```html
<template>
  <div class="main">
    <div class="login_box">
      <div class="title">
        欢迎访问DevOps运维平台
      </div>
      <div class="login_form">
        <el-form label-width="30px">
          <el-form-item>
            <el-input
                :prefix-icon="User"
                placeholder="用户名"
                v-model="form.username"
            ></el-input>
          </el-form-item>
          <el-form-item>
            <el-input
                :prefix-icon="Lock"
                placeholder="密码"
                type="password"
                v-model="form.password"
                show-password
            ></el-input>
          </el-form-item>
          <el-form-item class="btn">
            <el-button type="primary" @click="onSubmit">登录</el-button>
          </el-form-item>
        </el-form>

      </div>
    </div>
  </div>
</template>
<script>
// input里加图标必须单独按需导入
import {User, Lock} from "@element-plus/icons-vue";

export default {
  name: 'Login',
  data() {
    return {
      form: {
        username: '',
        password: ''
      }
    }
  },
  methods: {
    onSubmit() {
      console.log("aaa")
    }
  },
  // 需要用setup导入
  setup() {
    return {
      User, Lock
    }
  }
}
</script>

<style scoped>
.main {
  background-image: url("../assets/img/login.webp");
  background-size: 100% 100%;
  height: 100%;
}

.login_box {
  width: 400px;
  height: 300px;
  background-color: #FFFFFF;
  box-shadow: 0 5px 20px 0 #e8e8e8;
  border-radius: 20px;
  position: absolute;
  top: 0;
  bottom: 0;
  right: 0;
  left: 0;
  margin: auto;
}

.title {
  font-size: 20px;
  font-weight: bold;
  color: #409eff;
  text-align: center;
  margin-top: 30px;
}

.login_form {
  margin-top: 40px;
  margin-right: 30px;
}

.btn {
  margin-left: 36%;
}

.btn .el-button {
  width: 140px;
}
</style>
```

2.登录页面路由： `devops_web/src/router/index.js`

```js
import {createRouter, createWebHistory} from 'vue-router'
import Layout from '../views/Layout.vue'

const routes = [
    {
        path: '/login',
        name: '登录',
        component: () => import('../views/Login.vue')
    },
    {
        path: '/',
        name: '仪表盘',
        icon: 'Monitor',
        component: Layout,
        redirect: '/dashboard',
        children: [
            {
                path: '/dashboard',
                name: '仪表盘',
                icon: 'Monitor',
                component: () => import('../views/dashboard/Dashboard.vue')
            }
        ]
    },
    // ....
]

const router = createRouter({
    history: createWebHistory(process.env.BASE_URL),
    routes
})

export default router
```

3.页面测试

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.969h7wi6sy.png){: .zoom}



#### 数据提交

1.项目安装axios

```sh
cd devops_web
npm install axios
```

2.配置 axios: `devops_web/src/api/http.js`

```js
import axios from "axios"
import {ElMessage} from "element-plus"

const instance = axios.create({
    baseURL: 'http://127.0.0.1:8000/api',
    timeout: 5000
})
//请求拦截器
instance.interceptors.request.use(config => {
    //在请求api之前携带token
    const token = window.sessionStorage.getItem('token')
    if (token) {
        config.headers = {
            'Authorization': 'Token ' + token
        }
    }
    return config;
}, error => {
    return Promise.reject(error)
})
//响应拦截器
instance.interceptors.response.use(response => {
    //处理响应数据
    if (response.data.code != 200) {
        ElMessage.error(response.data.msg)
    }
    return response
}, error => {
    //处理catch的地方
    ElMessage('连接服务器失败，请稍后再试！！')
    return Promise.reject(error)
})

export default instance
```


3.全局注册axios：`devops_web/src/main.js`

```js
import {createApp} from 'vue'
import App from './App.vue'
import router from './router'
import ElementPlus from 'element-plus';
import 'element-plus/dist/index.css';
import * as ElIconModules from '@element-plus/icons-vue'

// 导入axios, 重新封装的axios
import axios from "./api/http";

const app = createApp(App)

app.use(ElementPlus)
for (let iconName in ElIconModules) {
    app.component(iconName, ElIconModules[iconName])
}
app.config.globalProperties.$http = axios;
app.use(router).mount('#app')
```

4.登录提交函数： `devops_web/src/views/Login.vue`


```html
<template>
  <div class="main">
    <div class="login_box">
      <div class="title">
        欢迎访问DevOps运维平台
      </div>
      <div class="login_form">
        <el-form :model="form" ref="form" :rules="rules" label-width="30px">
          <el-form-item prop="username">
            <el-input
                :prefix-icon="User"
                placeholder="用户名"
                v-model="form.username"
            ></el-input>
          </el-form-item>
          <el-form-item prop="password">
            <el-input
                :prefix-icon="Lock"
                placeholder="密码"
                type="password"
                v-model="form.password"
                show-password
            ></el-input>
          </el-form-item>
          <el-form-item class="btn">
            <el-button type="primary" @click="onSubmit">登录</el-button>
          </el-form-item>
        </el-form>

      </div>
    </div>
  </div>
</template>
<script>
// input里加图标必须单独按需导入
import {User, Lock} from "@element-plus/icons-vue";

export default {
  name: 'Login',
  data() {
    return {
      form: {
        username: '',
        password: ''
      },
      rules: {
        username: [
          {required: true, message: '请输入用户名', trigger: 'blur'},
          {min: 3, message: '用户名长度应不小于3个字符', trigger: 'blur'}
        ],
        password: [
          {required: true, message: '请输入密码', trigger: 'blur'},
          {min: 6, message: '用户名长度应不小于6个字符', trigger: 'blur'}
        ]
      },
    }
  },
  methods: {
    onSubmit() {
      // 提交前预验证
      this.$refs.form.validate((valid) => {
        // 回调函数中valid布尔值
        if (valid) {
          // 登陆成功并给消息提示
          this.$http.post('/login/', this.form)
              .then(res => {
                if (res.data.code == 200) {
                  this.$message.success('登录成功');
                  // 保存token和用户到会话存储
                  window.sessionStorage.setItem('token', res.data.token)
                  window.sessionStorage.setItem('username', res.data.username)
                  this.$router.push('/dashboard/')
                }
              })
        } else {
          this.$message.warning('用户名或密码格式错误！')
        }
      })
    }
  },
  // 需要用setup导入
  setup() {
    return {
      User, Lock
    }
  }
}
</script>

<style scoped>
.main {
  background-image: url("../assets/img/login.webp");
  background-size: 100% 100%;
  height: 100%;
}

.login_box {
  width: 400px;
  height: 300px;
  background-color: #FFFFFF;
  box-shadow: 0 5px 20px 0 #e8e8e8;
  border-radius: 20px;
  position: absolute;
  top: 0;
  bottom: 0;
  right: 0;
  left: 0;
  margin: auto;
}

.title {
  font-size: 20px;
  font-weight: bold;
  color: #409eff;
  text-align: center;
  margin-top: 30px;
}

.login_form {
  margin-top: 40px;
  margin-right: 30px;
}

.btn {
  margin-left: 36%;
}

.btn .el-button {
  width: 140px;
}
</style>
```

5.配置Layout隐藏没有子路由的项目：`devops_web/src/views/Layout.vue`

```html
<template>
  <div class="common-layout">
    <el-container>
      <el-aside :width="isCollapse ? '64px' : '200px'">
        <el-menu
            default-active="2"
            background-color="#304156"
            text-color="#FFFFFF"
            active-text-color="#ffd04b"
            class="el-menu"
            @open="handleOpen"
            @close="handleClose"
            :collapse="isCollapse"
            :collapse-transition="false"
            router
        >
          <router-link to="/">
            <div class="logo-title">
              <img src="../assets/cmdb.png"/>
              <!--默认显示logo字体，侧边栏搜索隐藏logo字体-->
              <span v-if="isTitle">运维管理系统</span>
            </div>
          </router-link>
          <template v-for="menu in this.$router.options.routes" :key="menu">

            <!--处理一级菜单没有子路由-->
<!--            <el-menu-item v-if="!menu.children && menu.path != '/login'" :index="menu.path">-->
<!--              &lt;!&ndash;字体图标&ndash;&gt;-->
<!--              <el-icon>-->
<!--                <component :is="menu.icon" color="#79bbff"></component>-->
<!--              </el-icon>-->
<!--              <span>{{ menu.name }}</span>-->
<!--            </el-menu-item>-->

            <!-- 处理仪表盘 -->
            <el-menu-item v-if="menu.path == '/'" :index="menu.children[0].path">
              <!--字体图标-->
              <el-icon>
                <component :is="menu.children[0].icon" color="#79bbff"/>
              </el-icon>
              <span>{{ menu.children[0].name }}</span>
            </el-menu-item>

            <!--处理一级菜单有子路由-->
            <el-sub-menu v-else-if="menu.children" :index="menu.path">
              <template #title>
                <!--字体图标-->
                <el-icon>
                  <component :is="menu.icon" color="#79bbff"></component>
                </el-icon>
                <span>{{ menu.name }}</span>
              </template>

              <!--循环二级菜单-->
              <el-menu-item v-for="child in menu.children" :key="child" :index="child.path">
                {{ child.name }}
              </el-menu-item>
            </el-sub-menu>

          </template>
        </el-menu>
      </el-aside>
      <el-container>
        <el-header>
          <!-- 导航栏折叠-->
          <div class="toggleCollapse">
            <el-icon :size="25" @click="toggleCollapse">
              <Fold/>
            </el-icon>
          </div>
          <!-- 头像-->
          <el-dropdown>
            <span class="el-dropdown-link">
              <img src="../assets/touxiang.jpeg" alt="">
            </span>
            <template #dropdown>
              <el-dropdown-menu>
                <el-dropdown-item>密码修改</el-dropdown-item>
                <el-dropdown-item>退出登录</el-dropdown-item>
              </el-dropdown-menu>
            </template>
          </el-dropdown>
        </el-header>
        <el-main>
          <!-- 占位符，显示路由跳转后加载的内容-->
          <router-view></router-view>
        </el-main>
      </el-container>
    </el-container>
  </div>
</template>
```

6.解决后端跨域问题: 安装 `django-cors-headers`

```sh
pip install django-cors-headers
```

7.配置后端跨域app: `devops_api/devops_api/settings.py`

```python
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'rest_framework.authtoken',
    'rest_framework_swagger',
    'django_filters',
    'cmdb',
    'system_config',
    'corsheaders'
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'corsheaders.middleware.CorsMiddleware'
]
CORS_ORIGIN_ALLOW_ALL = True
```


### 配置导航守卫，控制访问权限

目前虽然已经实现登录功能，即使没有登录情况下直接访问任何页面都还可以访问的，我们希望如果用户没有登录情况下，访问任何页面都重新导航到登录页面

1.退出登录功能完善：`devops_web/src/views/Layout.vue`

```html
<template>
  <div class="common-layout">
    <el-container>
      <el-aside :width="isCollapse ? '64px' : '200px'">
        <el-menu
            default-active="2"
            background-color="#304156"
            text-color="#FFFFFF"
            active-text-color="#ffd04b"
            class="el-menu"
            @open="handleOpen"
            @close="handleClose"
            :collapse="isCollapse"
            :collapse-transition="false"
            router
        >
          <router-link to="/">
            <div class="logo-title">
              <img src="../assets/cmdb.png"/>
              <!--默认显示logo字体，侧边栏搜索隐藏logo字体-->
              <span v-if="isTitle">运维管理系统</span>
            </div>
          </router-link>
          <template v-for="menu in this.$router.options.routes" :key="menu">

            <!--处理一级菜单没有子路由-->
            <!--            <el-menu-item v-if="!menu.children && menu.path != '/login'" :index="menu.path">-->
            <!--              &lt;!&ndash;字体图标&ndash;&gt;-->
            <!--              <el-icon>-->
            <!--                <component :is="menu.icon" color="#79bbff"></component>-->
            <!--              </el-icon>-->
            <!--              <span>{{ menu.name }}</span>-->
            <!--            </el-menu-item>-->

            <!-- 处理仪表盘 -->
            <el-menu-item v-if="menu.path == '/'" :index="menu.children[0].path">
              <!--字体图标-->
              <el-icon>
                <component :is="menu.children[0].icon" color="#79bbff"/>
              </el-icon>
              <span>{{ menu.children[0].name }}</span>
            </el-menu-item>

            <!--处理一级菜单有子路由-->
            <el-sub-menu v-else-if="menu.children" :index="menu.path">
              <template #title>
                <!--字体图标-->
                <el-icon>
                  <component :is="menu.icon" color="#79bbff"></component>
                </el-icon>
                <span>{{ menu.name }}</span>
              </template>

              <!--循环二级菜单-->
              <el-menu-item v-for="child in menu.children" :key="child" :index="child.path">
                {{ child.name }}
              </el-menu-item>
            </el-sub-menu>

          </template>
        </el-menu>
      </el-aside>
      <el-container>
        <el-header>
          <!-- 导航栏折叠-->
          <div class="toggleCollapse">
            <el-icon :size="25" @click="toggleCollapse">
              <Fold/>
            </el-icon>
          </div>
          <!-- 头像-->
          <el-dropdown>
            <span class="el-dropdown-link">
              <img src="../assets/touxiang.jpeg" alt="">
            </span>
            <template #dropdown>
              <el-dropdown-menu>
                <el-dropdown-item>密码修改</el-dropdown-item>
                <el-dropdown-item @click="logout">退出登录</el-dropdown-item>
              </el-dropdown-menu>
            </template>
          </el-dropdown>
        </el-header>
        <el-main>
          <!-- 占位符，显示路由跳转后加载的内容-->
          <router-view></router-view>
        </el-main>
      </el-container>
    </el-container>
  </div>
</template>


<script>
export default {
  name: 'Layout',
  data() {
    return {
      isCollapse: false,
      isTitle: true,
    }
  },
  methods: {
    // 触发折叠按钮
    toggleCollapse() {
      // 根据已有的值进行取反，是true就取false，是false取反就是true
      this.isCollapse = !this.isCollapse
      this.isTitle = !this.isTitle
    },
    //退出登录函数
    logout() {
      window.sessionStorage.clear()
      this.$router.push('/login')
    }
  }

}
</script>
<style>
.common-layout, .el-container, .el-menu {
  height: 100%;
}

.el-header {
  border-bottom: 1px lightgrey solid;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.el-aside {
  background: grey;
}

.el-main {
  background-color: #E9EEF3;
}

.collapse-transition {
  cursor: pointer;
}

.logo img {
  width: 200px;
  height: 60px;
  /*margin-left: 10px;*/
}

.el-dropdown-link img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  flex: auto;
}


.logo-title {
  background-color: rgba(82, 183, 109, 1);
  margin-bottom: 10px;
  height: 50px;
  border: none;
  line-height: 50px;
  display: flex;
  align-items: center;
  padding-left: 15px;
  color: #fff;
}

.logo-title img {
  width: 32px;
  height: 32px;
  margin-right: 10px;
  border-radius: 50%;
}

.logo-title span {
  font-weight: bold;
  font-size: 16px;
  line-height: 50px;
  font-family: Averir, Helvetica Neue, Arial, Helvetica, sans-serif;
  vertical-align: middle;
}
</style>
```





2.配置导航守卫，登录token获取才能查看页面，否则不能正常访问页面: `devops_web/src/router/index.js`

```js
// ...
const router = createRouter({
    history: createWebHistory(process.env.BASE_URL),
    routes
})

// 添加导航守卫
router.beforeEach((to, from, next) => {
    // 如果用户访问登录页，直接放行
    if (to.path == '/login') {
        return next()
    }
    // 从sessionStorage获取token值
    const token = window.sessionStorage.getItem('token');
    // 如果没有获取到token值，跳转到登录页
    if (!token) {
        return next('/login')
    }
    // 正常跳转
    next()
});

export default router
```

3.页面token检查

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.2ruvdb5um2.webp){: .zoom}





### nprogress 浏览器顶部的进度条

1.添加进度条模块

```sh
npm install nprogress
```



2.添加进度条 `router/index.js`

```js
import {createRouter, createWebHistory} from 'vue-router'
import Layout from '../views/Layout.vue'

const routes = [
    {
        path: '/login',
        name: '登录',
        meta: {title: "登录", requireAuth: false}, // 定义meta元数据
        component: () => import('../views/Login.vue')  // 视图组件
    },
    {
        path: '/',
        name: '首页',
        component: Layout,
        redirect: '/dashboard',
        children: [
            {
                path: '/dashboard',
                name: '仪表盘',
                icon: 'Monitor',
                //定义meta元数据
                meta: {title: "仪表盘", requireAuth: false},
                component: () => import('../views/dashboard/Dashboard.vue')
            }
        ]
    },
    {
        path: '/server',
        name: '主机管理',
        icon: 'Setting',
        component: Layout,
        children: [
            {
                path: '/idc',
                name: '机房管理',
                meta: {title: "机房管理", requireAuth: false},
                component: () => import('../views/idc/Idc')
            },
            {
                path: '/server_group',
                name: '主机分组',
                meta: {title: "主机分组", requireAuth: false},
                component: () => import('../views/servergroup/ServerGroup')
            },
            {
                path: '/server',
                name: '服务器管理',
                meta: {title: "服务器管理", requireAuth: false},
                component: () => import('../views/server/Server')
            },
        ]
    },
    {
        path: '/sysconfig',
        name: '系统配置',
        icon: 'PieChart',
        component: Layout,
        children: [
            {
                path: '/credential',
                name: '凭据管理',
                meta: {title: "凭据管理", requireAuth: false},
                component: () => import('../views/credential/Credential')
            }
        ]
    }
]

const router = createRouter({
    history: createWebHistory(process.env.BASE_URL),
    routes
})

// 添加导航守卫
router.beforeEach((to, from, next) => {
    // 如果用户访问登录页，直接放行
    if (to.path == '/login') {
        return next()
    }
    // 从sessionStorage获取token值
    const token = window.sessionStorage.getItem('token');
    // 如果没有获取到token值，跳转到登录页
    if (!token) {
        return next('/login')
    }
    // 正常跳转
    next()
});


// 抛出路由实例, 在 main.js 中引用
export default router


//导入进度条组件
import NProgress from 'nprogress'
import 'nprogress/nprogress.css'
//递增进度条，这将获取当前状态值并添加0.2直到状态为0.994
NProgress.inc(100)
//easing 动画字符串
// speed 动画速度
// showSpinner 进度环显示隐藏
NProgress.configure({easing: 'ease', speed: 600, showSpinner: false})
//router.beforeEach（）一般用来做一些进入页面的限制。比如没有登录，就不能进入某些
// 页面，只有登录了之后才有权限查看某些页面。。。说白了就是路由拦截。
// to 要去到某个页面的属性
// from 从哪个页面来的属性
// next 处理路由跳转及放行
router.beforeEach((to, from, next) => {
    // 启动进度条
    NProgress.start()
    // 设置头部
    if (to.meta.title) {
        document.title = to.meta.title
    } else {
        document.title = "devops_web"
    }
    //放行
    next()
})
router.afterEach(() => {
    // 关闭进度条
    NProgress.done()
})
```





3.效果展示

在路由导航时，会通过 to.meta.title 来获取目标页面的标题，从而实现页面标题的动态展示, 同时也有进度条展示，如下所示

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.92pvbjgzfi.webp){: .zoom}


### 404 页面

1.安装依赖 SCSS

因为后续会用到 SCSS 编写页面样式，所以先安装好 SCSS。

```sh
npm install sass-loader node-sass --dev
```

2.如何使用

在页面代码 style 标签中把 lang 设置成 scss 即可。

```css
<style lang="scss">

</style>
```

3.404使用测试

丰富一下 404 页面内容，加入 scss 样式，移除 App.vue 的 logo 图片。

```html
<template>
  <div class="site-wrapper site-page--not-found">
    <div class="site-content__wrapper">
      <div class="site-content">
        <h2 class="not-found-title">404</h2>
        <p class="not-found-desc">抱歉！您访问的页面<em>失联</em>啦 ...</p>
        <el-button @click="$router.go(-1)">返回上一页</el-button>
        <el-button type="primary" class="not-found-btn-gohome" @click="$router.push('/')">进入首页</el-button>
      </div>
    </div>
  </div>
</template>

<script>
export default {}
</script>

<style lang="scss">
.site-wrapper.site-page--not-found {
  position: absolute;
  top: 60px;
  right: 0;
  bottom: 0;
  left: 0;
  overflow: hidden;

  .site-content__wrapper {
    padding: 0;
    margin: 0;
    background-color: #fff;
  }

  .site-content {
    position: fixed;
    top: 15%;
    left: 50%;
    z-index: 2;
    padding: 30px;
    text-align: center;
    transform: translate(-50%, 0);
  }

  .not-found-title {
    margin: 20px 0 15px;
    font-size: 8em;
    font-weight: 500;
    color: rgb(55, 71, 79);
  }

  .not-found-desc {
    margin: 0 0 30px;
    font-size: 26px;
    text-transform: uppercase;
    color: rgb(118, 131, 143);

    > em {
      font-style: normal;
      color: #ee8145;
    }
  }

  .not-found-btn-gohome {
    margin-left: 30px;
  }
}
</style>
```

4.页面路由： `devops_web/src/router/index.js`

```js
// ....
const routes = [
    {
        path: '/login',
        name: '登录',
        meta: {title: "登录", requireAuth: false}, // 定义meta元数据
        component: () => import('../views/login/Login.vue')  // 视图组件
    },
    {
        path: '/',
        name: '首页',
        component: Layout,
        redirect: '/dashboard',
        children: [
            {
                path: '/dashboard',
                name: '仪表盘',
                icon: 'Monitor',
                //定义meta元数据
                meta: {title: "仪表盘", requireAuth: false},
                component: () => import('../views/dashboard/Dashboard.vue')
            }
        ]
    },
    {
        path: '/server',
        name: '主机管理',
        icon: 'Setting',
        component: Layout,
        children: [
            {
                path: '/idc',
                name: '机房管理',
                meta: {title: "机房管理", requireAuth: false},
                component: () => import('../views/idc/Idc.vue')
            },
            {
                path: '/server_group',
                name: '主机分组',
                meta: {title: "主机分组", requireAuth: false},
                component: () => import('../views/servergroup/ServerGroup.vue')
            },
            {
                path: '/server',
                name: '服务器管理',
                meta: {title: "服务器管理", requireAuth: false},
                component: () => import('../views/server/Server.vue')
            },
        ]
    },
    {
        path: '/sysconfig',
        name: '系统配置',
        icon: 'PieChart',
        component: Layout,
        children: [
            {
                path: '/credential',
                name: '凭据管理',
                meta: {title: "凭据管理", requireAuth: false},
                component: () => import('../views/credential/Credential.vue')
            }
        ]
    },
    // 404
    {
        path: "/:pathMatch(.*)*",
        name: "NotFound",
        meta: {title: "NotFound", requireAuth: false}, // 定义meta元数据
        component: () => import('@/views/error/404.vue'),
    },
]

// ....
```

5.效果如下

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.6m3mxw3p30.webp){: .zoom}




## 后台基本布局

### 显示用户名

1.上述例子已经在保存 token 的时候保存了 username


2.只需要在头像旁边配置 usernam e显示即可： `devops_web/src/views/Layout.vue`

```html
<template>
  <div class="common-layout">
    <el-container>
      <el-aside :width="isCollapse ? '64px' : '200px'">
        <el-menu
            default-active="2"
            background-color="#304156"
            text-color="#FFFFFF"
            active-text-color="#ffd04b"
            class="el-menu"
            @open="handleOpen"
            @close="handleClose"
            :collapse="isCollapse"
            :collapse-transition="false"
            router
        >
          <router-link to="/">
            <div class="logo-title">
              <img src="../assets/cmdb.png"/>
              <!--默认显示logo字体，侧边栏搜索隐藏logo字体-->
              <span v-if="isTitle">运维管理系统</span>
            </div>
          </router-link>
          <template v-for="menu in this.$router.options.routes" :key="menu">

            <!--处理一级菜单没有子路由-->
            <!--            <el-menu-item v-if="!menu.children && menu.path != '/login'" :index="menu.path">-->
            <!--              &lt;!&ndash;字体图标&ndash;&gt;-->
            <!--              <el-icon>-->
            <!--                <component :is="menu.icon" color="#79bbff"></component>-->
            <!--              </el-icon>-->
            <!--              <span>{{ menu.name }}</span>-->
            <!--            </el-menu-item>-->

            <!-- 处理仪表盘 -->
            <el-menu-item v-if="menu.path == '/'" :index="menu.children[0].path">
              <!--字体图标-->
              <el-icon>
                <component :is="menu.children[0].icon" color="#79bbff"/>
              </el-icon>
              <span>{{ menu.children[0].name }}</span>
            </el-menu-item>

            <!--处理一级菜单有子路由-->
            <el-sub-menu v-else-if="menu.children" :index="menu.path">
              <template #title>
                <!--字体图标-->
                <el-icon>
                  <component :is="menu.icon" color="#79bbff"></component>
                </el-icon>
                <span>{{ menu.name }}</span>
              </template>

              <!--循环二级菜单-->
              <el-menu-item v-for="child in menu.children" :key="child" :index="child.path">
                {{ child.name }}
              </el-menu-item>
            </el-sub-menu>

          </template>
        </el-menu>
      </el-aside>
      <el-container>
        <el-header>
          <!-- 导航栏折叠-->
          <div class="toggleCollapse">
            <el-icon :size="25" @click="toggleCollapse">
              <Fold/>
            </el-icon>
          </div>
          <!-- 头像-->
          <el-dropdown>
            <span class="el-dropdown-link">
              <img src="../assets/touxiang.jpeg" alt="">
              <span> {{ username }} </span>
            </span>
            <template #dropdown>
              <el-dropdown-menu>
                <el-dropdown-item icon="Avatar" command="PersonalCenter">个人中心</el-dropdown-item>
                <el-dropdown-item icon="EditPen">密码修改</el-dropdown-item>
                <el-dropdown-item icon="Operation" @click="logout">退出登录</el-dropdown-item>
              </el-dropdown-menu>
            </template>
          </el-dropdown>
        </el-header>
        <el-main>
          <!-- 占位符，显示路由跳转后加载的内容-->
          <router-view></router-view>
        </el-main>
      </el-container>
    </el-container>
  </div>
</template>


<script>
export default {
  name: 'Layout',
  data() {
    return {
      isCollapse: false,
      isTitle: true,
      username: window.sessionStorage.getItem('username')
    }
  },
  mounted() {
    console.log(this.username)
  },
  methods: {
    // 触发折叠按钮
    toggleCollapse() {
      // 根据已有的值进行取反，是true就取false，是false取反就是true
      this.isCollapse = !this.isCollapse
      this.isTitle = !this.isTitle
    },
    //退出登录函数
    logout() {
      window.sessionStorage.clear()
      this.$router.push('/login')
    }
  }

}
</script>
<style>
.common-layout, .el-container, .el-menu {
  height: 100%;
}

.el-header {
  border-bottom: 1px lightgrey solid;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.el-aside {
  background: grey;
}

.el-main {
  background-color: #E9EEF3;
}

.collapse-transition {
  cursor: pointer;
}

.logo img {
  width: 200px;
  height: 60px;
  /*margin-left: 10px;*/
}

.el-dropdown-link {
  display: flex;
  align-items: center;
}

.el-dropdown-link img {
  width: 30px; /* 图像宽度 */
  height: 30px; /* 图像高度 */
  border-radius: 50%; /* 设置为圆形 */
  margin-right: 5px; /* 图像和用户名之间的间距 */
}

.el-dropdown-link span {
  font-size: 14px; /* 用户名字体大小 */
}

.logo-title {
  background-color: rgba(82, 183, 109, 1);
  margin-bottom: 10px;
  height: 50px;
  border: none;
  line-height: 50px;
  display: flex;
  align-items: center;
  padding-left: 15px;
  color: #fff;
}

.logo-title img {
  width: 32px;
  height: 32px;
  margin-right: 10px;
  border-radius: 50%;
}

.logo-title span {
  font-weight: bold;
  font-size: 16px;
  line-height: 50px;
  font-family: Averir, Helvetica Neue, Arial, Helvetica, sans-serif;
  vertical-align: middle;
}
</style>
```


3.效果展示
![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.7egie5nas0.webp){: .zoom}



### 修改密码

1.修改密码后端接口

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.9nzixn9rk9.webp){: .zoom}



2.前端需要使用的dialog对话框: https://element-plus.gitee.io/zh-CN/component/dialog.html


3.修改密码对话框添加: `devops_web/src/views/Layout.vue`

```html
<template>
  <div class="common-layout">
    <el-container>
      <el-aside :width="isCollapse ? '64px' : '200px'">
        <el-menu
            default-active="2"
            background-color="#304156"
            text-color="#FFFFFF"
            active-text-color="#ffd04b"
            class="el-menu"
            @open="handleOpen"
            @close="handleClose"
            :collapse="isCollapse"
            :collapse-transition="false"
            router
        >
          <router-link to="/">
            <div class="logo-title">
              <img src="../assets/cmdb.png"/>
              <!--默认显示logo字体，侧边栏搜索隐藏logo字体-->
              <span v-if="isTitle">运维管理系统</span>
            </div>
          </router-link>
          <template v-for="menu in this.$router.options.routes" :key="menu">

            <!--处理一级菜单没有子路由-->
            <!--            <el-menu-item v-if="!menu.children && menu.path != '/login'" :index="menu.path">-->
            <!--              &lt;!&ndash;字体图标&ndash;&gt;-->
            <!--              <el-icon>-->
            <!--                <component :is="menu.icon" color="#79bbff"></component>-->
            <!--              </el-icon>-->
            <!--              <span>{{ menu.name }}</span>-->
            <!--            </el-menu-item>-->

            <!-- 处理仪表盘 -->
            <el-menu-item v-if="menu.path == '/'" :index="menu.children[0].path">
              <!--字体图标-->
              <el-icon>
                <component :is="menu.children[0].icon" color="#79bbff"/>
              </el-icon>
              <span>{{ menu.children[0].name }}</span>
            </el-menu-item>

            <!--处理一级菜单有子路由-->
            <el-sub-menu v-else-if="menu.children" :index="menu.path">
              <template #title>
                <!--字体图标-->
                <el-icon>
                  <component :is="menu.icon" color="#79bbff"></component>
                </el-icon>
                <span>{{ menu.name }}</span>
              </template>

              <!--循环二级菜单-->
              <el-menu-item v-for="child in menu.children" :key="child" :index="child.path">
                {{ child.name }}
              </el-menu-item>
            </el-sub-menu>

          </template>
        </el-menu>
      </el-aside>
      <el-container>
        <el-header>
          <!-- 导航栏折叠-->
          <div class="toggleCollapse">
            <el-icon :size="25" @click="toggleCollapse">
              <Fold/>
            </el-icon>
          </div>
          <!-- 头像-->
          <el-dropdown>
            <span class="el-dropdown-link">
              <img src="../assets/touxiang.jpeg" alt="">
              <span> {{ username }} </span>
            </span>
            <template #dropdown>
              <el-dropdown-menu>
                <el-dropdown-item icon="Avatar" command="PersonalCenter">个人中心</el-dropdown-item>
                <el-dropdown-item icon="EditPen" @click="dialogVisible=true">密码修改</el-dropdown-item>
                <el-dropdown-item icon="Operation" @click="logout">退出登录</el-dropdown-item>
              </el-dropdown-menu>
            </template>
          </el-dropdown>
        </el-header>
        <el-main>
          <!-- 占位符，显示路由跳转后加载的内容-->
          <router-view></router-view>
        </el-main>
      </el-container>
    </el-container>
  </div>

  <!--  修改密码对话框 dialogVisible 在修改密码按钮处有click事件调起-->
  <el-dialog
      v-model="dialogVisible"
      title="修改密码"
      width="30%"
  >
    <el-form :model="UserPasswordForm" label-position="right" label-width="100px" :rules="rules" ref="UserPasswordForm">
      <el-form-item label="原密码：" prop="old_password">
        <el-input
            v-model="UserPasswordForm.old_password"
            type="password"
            show-password
        ></el-input>
      </el-form-item>
      <el-form-item label="新密码：" prop="new_password">
        <el-input
            v-model="UserPasswordForm.new_password"
            type="password"
            show-password
        ></el-input>
      </el-form-item>
      <el-form-item label="再次确认：" prop="confirm_password">
        <el-input
            v-model="UserPasswordForm.confirm_password"
            type="password"
            show-password
        ></el-input>
      </el-form-item>
    </el-form>
    <template #footer>
      <span class="dialog-footer">
        <el-button @click="dialogVisible = false">取消</el-button>
        <el-button type="primary" @click="changePasswordSubmit">确定</el-button>
      </span>
    </template>
  </el-dialog>
</template>


<script>
export default {
  name: 'Layout',
  data() {
    // 新旧密码校验规则
    const checkNewOldPassword = (rule, value, callback) => {
      if (value == this.UserPasswordForm.old_password) {
        callback(new Error('新密码不能与旧密码一样！'))
      } else {
        return callback()
      }
    };
    const checkNewPassword = (rule, value, callback) => {
      if (value != this.UserPasswordForm.new_password) {
        callback(new Error('两次输入密码不一致！'))
      } else {
        return callback()
      }
    };
    return {
      isCollapse: false,
      isTitle: true,
      username: window.sessionStorage.getItem('username'),
      dialogVisible: false,
      UserPasswordForm: {
        old_password: '',
        new_password: '',
        confirm_password: ''
      },
      rules: {
        old_password: [
          {required: true, message: '请输入原密码', trigger: 'blur'},
          {min: 6, message: '密码长度应不小于6个字符', trigger: 'blur'}
        ],
        new_password: [
          {required: true, message: '请输入新密码', trigger: 'blur'},
          {min: 6, message: '密码长度应不小于6个字符', trigger: 'blur'},
          {validator: checkNewOldPassword, trigger: 'blur'}
        ],
        confirm_password: [
          {required: true, message: '请确认新密码', trigger: 'blur'},
          {min: 6, message: '密码长度应不小于6个字符', trigger: 'blur'},
          {validator: checkNewPassword, trigger: 'blur'}
        ]
      },
    }
  },
  mounted() {
    console.log(this.username)
  },
  methods: {
    // 触发折叠按钮
    toggleCollapse() {
      // 根据已有的值进行取反，是true就取false，是false取反就是true
      this.isCollapse = !this.isCollapse
      this.isTitle = !this.isTitle
    },
    //退出登录函数
    logout() {
      window.sessionStorage.clear()
      this.$router.push('/login')
    },
    changePasswordSubmit() {
      // 提交前预验证
      this.$refs.UserPasswordForm.validate((valid) => {
        // 回调函数中valid布尔值
        console.log(this.UserPasswordForm)
        if (valid) {
          //获取用户名
          const username = window.sessionStorage.getItem('username')
          this.UserPasswordForm['username'] = username
          this.$http.post('/change_password/', this.UserPasswordForm)
              .then(res => {
                if (res.data.code == 200) {
                  this.$message.success(res.data.msg);
                  this.dialogVisible = false
                }
              })
        }
      })
    }
  }

}
</script>
<style>
.common-layout, .el-container, .el-menu {
  height: 100%;
}

.el-header {
  border-bottom: 1px lightgrey solid;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.el-aside {
  background: grey;
}

.el-main {
  background-color: #E9EEF3;
}

.collapse-transition {
  cursor: pointer;
}

.logo img {
  width: 200px;
  height: 60px;
  /*margin-left: 10px;*/
}

.el-dropdown-link {
  display: flex;
  align-items: center;
}

.el-dropdown-link img {
  width: 30px; /* 图像宽度 */
  height: 30px; /* 图像高度 */
  border-radius: 50%; /* 设置为圆形 */
  margin-right: 5px; /* 图像和用户名之间的间距 */
}

.el-dropdown-link span {
  font-size: 14px; /* 用户名字体大小 */
}

.logo-title {
  background-color: rgba(82, 183, 109, 1);
  margin-bottom: 10px;
  height: 50px;
  border: none;
  line-height: 50px;
  display: flex;
  align-items: center;
  padding-left: 15px;
  color: #fff;
}

.logo-title img {
  width: 32px;
  height: 32px;
  margin-right: 10px;
  border-radius: 50%;
}

.logo-title span {
  font-weight: bold;
  font-size: 16px;
  line-height: 50px;
  font-family: Averir, Helvetica Neue, Arial, Helvetica, sans-serif;
  vertical-align: middle;
}
</style>
```


4.测试密码修改功能

![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.969h92kp5d.webp){: .zoom}


![image](https://cdn.jsdelivr.net/gh/hujianli94/picx-images-hosting@master/image.3go4xhr0qj.png){: .zoom}

