# 1.Ansible入门和实践


相比较于Puppet和Saltstack而言，Ansible是一款轻量级的服务器集中管理软件。


Ansible默认采用SSH的方式管理客户端，部署简单，只需要在跳板机或主控端部署Ansible环境即可，被控端无须进行任何操作。

Ansible是基于Python开发的，由Paramiko和PyYAML两个关键模块构建，我们可以使用它的各种模块来实现对客户端的批量管理
(执行命令、安装软件、指定特定任务等)，对于一些较为复杂的需要重复执行的任务，我们可以通过Ansible下的playbook来管理这些复杂的任务。


Ansible是基于Paramiko开发的。


那么Paramiko到底是什么呢？Paramiko是用Python语言编写的一个模块，遵循SSH2协议，支持以加密和认
证的方式，进行远程服务器的连接。


与常用软件xshell、xftp的功能一样，不过Paramiko可以连接多台服务器，进行复杂的操作。


Ansible与轻量级的自动化运维工具Fabric还有一个共同点，那就是不需要在远程主机上安装客户端，因为它们都是基于SSH来与远程主机进行通信的。



相比较于其他自动化运维工具，Ansible的优势也有很多，具体如下。

+ 轻量级，无须在客户端安装Aget,更新时只需要在操作机上进行一次更新即可。

+ 批量任务执行可以写成脚本，而且不用分发到远程就可以执行。

+ 使用Python编写，维护简单，二次开发更方便。

+ 支持非root用户管理操作，支持sudo。

+支持云计算、大数据平台（如AWS、OpenStack、CloudStack等）。

+ Ansible社区非常活跃，Ansible本身提供的模块也非常丰富，第三方资源众多。

2015年，红帽公司宣布收购Ansible,在产品层面，Ansible符合Red Hat希望通过开放式开发提供无障碍设计和模块化架构的目标，主要体现在以下几个方面。


**Ansible易于使用**：这一点从下面的两个例子得以体现。一是，Ansible的playbook使用的是人类可读的YAML代码编写，简化了自动化流程的编写和维护；
二是，Ansible使用标准的SSH连接来执行自动化流程，不需要代理，更容易融入已有的企业IT环境。



**Ansible是模块化的**：Ansible提供了400多个模块，而且还在不断增加，这些模块可以用于扩展Ansible的功能。这是Red Hat希望在其管理的产品中提供的一个重要的功能。


**Ansible是一个非常受欢迎的开源项目**：在GitHub上，Ansible有将近13000颗星和4000个分支。另外，根据Redmonk统计，Hacker News提及Ansible的次数也在飞速
增长。

在资产组合方面，Ansible符合Red Hat希望提供多层架构、多层一致性和多供应商支持的目标，主要体现在以下几个方面。


**Ansible支持多层部署**：按照设计，Ansible通过VM和容器为多层应用程序的部署和配置提供支持。这意味着组织可以将同一应用程序的不同组件自动部署到运行效率最
高的层上。比如，Ansible可以同时在VMware vSphere服务器虚拟环境中管理VM和客户操作系统，在OpenStack laaS云上部署和管理实例，在OpenShift PaaS云上部署应用
程序。


**Ansible为架构的多个层次带来一致性**：惜助Ansible,我们可以通过编程来操作计算
架构中从基础设施到应用程序之间的每一层。比如，Ansible可以自动化包括网络、存储、OS、中间件和应用程序层在内的所有配置工作。


**Ansible支持异构IT环境**：Ansible可以自动配置来自许多供应商的各种技术，而不只是Red Hat的技术。比如，Ansible既支持Linux,也支持Windows;Ansible使IT组织可
以管理各种ISV和IHV技术，比如硬件F5Big-IP和Citrix NetScaler到Amazon Web服务和Google云计算平台。


从Ansible1.7版本开始，Ansbile加入了支持管理Windows系统的模块,有兴趣的朋友可以参考Ansible官网。




## 1.YAML介绍

YAML是一个可读性高的用于表达资料序列的格式。它的主要特点是可读性好、语法简单明了、表达能力强、扩展性和通用性强等。

为什么这里不用大家所熟悉的XML呢？具体原因如下。

+ YAML的可读性好。
  
+ YAML和脚本语言的交互性好。

+ YAML使用实现语言的数据类型。

+ YAML有一个一致的信息模型。
  
+ YAML易于实现。

上面5条也是XML不足的地方。此外，YAML也具有XML所具有的下列优点。
+ YAML可以基于流来处理。

+ YAML表达能力强，扩展性好。

总之，YAML试图用一种比XML更敏捷的方式，来完成XML所完成的任务。另外，建议所有的YAML文件都以“-”作为开始行，这是YAML文件格式的一部分，表明是一个文件的开始。

YAML的语法与其他高阶语言类似，并且可以简单地表达列表、字典等数据结构，除此之外，它还支持纯量这种数据结构。

+ 字典(dictionary):键值对的集合，又称为映射(mapping)。

+ 列表(1ist):一组按次序排列的值。

+ 常量(scalars):单个的、不可再分的值。


### 1.1 通用结构

下面是一个通用示例，文件内容如下所示：

```yaml
---
name: Tome smith
age: 37
spouse:
  name: Jane smith
  age: 35

children:
  - name: Jimmy smith
    age: 15
  - name1: Jenny smith
    age1: 12

# YAML中的多行字符事可以使用“”保留换行符，也可以使用“>”折叠换行，示例
this: |
  Foo
  Bar

that: >
  Foo
  Bar

# list结构
Fruit:
  - apple
  - banana
  - orange
  - pear
```

使用python读取yaml文件，代码如下

```python
# -*- coding:utf8 -*-

import yaml

file = open("test.yaml", 'r',encoding='utf-8')

x = yaml.load(file, Loader=yaml.FullLoader)

print(x)
```

对应Python结果如下：

```shell
{'name': 'Tome smith', 'age': 37, 'spouse': {'name': 'Jane smith', 'age': 35}, 'children': [{'name': 'Jimmy smith', 'age': 15}, {'name1': 'Jenny smith', 'age1': 12}], 'this': 'Foo\nBar\n', 'that': 'Foo Bar\n', 'Fruit': ['apple', 'banana', 'orange', 'pear']}
```


### 1.2 字典结构

```yaml
node_a:
  conntimeout:300

external:
  iface: eth0
  port: 556


internal:
  iface: eth0
  port: 778


broadcast:
  client: 1000
  server: 2000

node_b:
  0:
    ip: 10.0.0.1
    name: bl
  1:
    ip: 10.0.0.2
    name: b2
```

对应Python结果如下：

```shell
{'node_a': 'conntimeout:300', 'external': {'iface': 'eth0', 'port': 556}, 'internal': {'iface': 'eth0', 'port': 778}, 'broadcast': {'client': 1000, 'server': 2000}, 'node_b': {0: {'ip': '10.0.0.1', 'name': 'bl'}, 1: {'ip': '10.0.0.2', 'name': 'b2'}}}
```

### 1.3 列表和字典混用

```yaml
#一位职工记录
name: Example Developer
job: Developer
skill: Elite
employed: True

foods:
  - Apple
  - Orange
  - Strawberry
  - Mango

languages:
  Python: edite
  Java: edite
  C++: edite
```

使用python代码读取文件

```python
# -*- coding:utf8 -*-
import yaml

with open("list_dict.yaml", 'r', encoding='utf-8') as file:
    x = yaml.safe_load(file)

print(x)

```

对应Python结果如下：

```shell
{'name': 'Example Developer', 'job': 'Developer', 'skill': 'Elite', 'employed': True, 'foods': ['Apple', 'Orange', 'Strawberry', 'Mango'], 'languages': {'Python': 'edite', 'Java': 'edite', 'C++': 'Lame'}}
```


### 1.4 多种常量结构使用


```yaml
boolean:
  - TRUE    # true,TRUE都可以
  - FALSE   #false,False都可以

float:
  - 3.14
  - 6.8523015e+5   #可以使用科学计数法

int:
  - 123
  - 0b10100111010010101110   #二进制表示


nu11:
  nodeName: 'node'
  parent: ~  #使用“~”表示nul1

string:
  - 'hello,yhc'
  - 'He11owor1d'      #可以使用双引号或者单引号包裹特殊字符
  - newline
      newline2        #字符串可以拆成多行，每一行都会被转化成一个空格

date:
  - 2018-02-17        #日期必须使用IS08601格式，即yyyy-MM-dd

datetime:
  - 2018-02-17T15:02:31+08:00 # 时间使用IS08601格式，时间和日期之间使用T连接，最后使用“+”代表时区
```


对应Python结果如下：

```shell
{'boolean': [True, False], 'float': [3.14, 685230.15], 'int': [123, 685230], 'nu11': {'nodeName': 'node', 'parent': None}, 'string': ['hello,yhc', 'He11owor1d', 'newline newline2'], 'date': [datetime.date(2018, 2, 17)], 'datetime': [datetime.datetime(2018, 2, 17, 15, 2, 31, tzinfo=datetime.timezone(datetime.timedelta(seconds=28800)))]}
```


列举了这么多例子，最后我们在此总结一下YAML的基本语法规则，大家在工作中请记得遵循，语法规则具体如下所示。

- YAML文件对大小写敏感。

- 使用缩进代表层级关系。

- 缩进只能使用空格，不能使用TAB,空格个数不作要求，只需要相同层级左对齐(一般为2个或4个空格)即可。

- YAML文件是以“#”作为注释，YAML中只有行注释。





!!!info "参考文档"


      [Playbooks 采用YMAL 语法结构，基本的YMAL 语法请参考](http://docs.ansible.com/YAMLSyntax.html)

      [python利用pyyaml模块进行解析yaml语言](http://pyyaml.org/wiki/PyYAMLDocumentation)

      [yaml格式在线检查](http://yaml-online-parser.appspot.com/)




## 2.Ansible的安装和配置


=== "ubuntu"


    ```shell
    $ sudo apt update
    $ sudo apt install software-properties-common
    $ sudo apt-add-repository --yes --update ppa:ansible/ansible
    $ sudo apt install ansible
    ```



=== "pip"


    ```shell
    curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
    python get-pip.py
    pip install ansible==2.12.10 -i https://mirrors.ustc.edu.cn/pypi/web/simple

    # 通过此方式安装的没有生成/etc/ansible文件，可以手动生成，配置文件示例到https://github.com/ansible/ansible/tree/devel/examples
    ```



=== "python3"


    ```shell
    yum install -y python36 python36-tools
    curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
    python3.6 get-pip.py 
    pip3.6 install ansible==2.12.10 -i https://mirrors.ustc.edu.cn/pypi/web/simple
    # 通过此方式安装的没有生成/etc/ansible文件，可以手动生成，配置文件示例到https://github.com/ansible/ansible/tree/devel/examples
    ```



Ansible的安装过程非常简便，安装步骤具体如下。

1. 这里采用的是pip安装方式，建议带上Ansible版本号，因为Ansible2.x的API语法与Ansible1.9的API语法差别很大（我们内容主要基于Ansible1.9.6),命令如下示：

```shell
pip install ansible==2.12.10 -i https://mirrors.ustc.edu.cn/pypi/web/simple
```

2. 安装完毕后，查看版本

```shell
ansible --version
ansible [core 2.12.9]
  config file = /etc/ansible/ansible.cfg
  configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/local/lib/python3.8/dist-packages/ansible
  ansible collection location = /root/.ansible/collections:/usr/share/ansible/collections
  executable location = /usr/local/bin/ansible
  python version = 3.8.10 (default, Nov 14 2022, 12:59:47) [GCC 9.4.0]
  jinja version = 3.1.2
  libyaml = True
```

3. Ansible配置文件ansible.cfg可以存储于系统中的不同位置，但只有一个可用。

在下列列表中，Ansible会从上往下依次检查，检查到哪个可用就用哪个。

+ ANSIBLE CFG环境变量，可以定义配置文件的位置。

+ ansible.cfg存储于当前工作目录。

+ ansible.cfg存储于当前用户的家目录。

+ 默认存储位置：/etc/ansible/ansible.cfg。

Ansible配置文件默认存储于/etc/ansible/ansible.cfg,hosts文件默认存储于/etc/ansible/hosts,在这里我们采用默认值。


如下为Ansible.cfg常用参数详解


| 配置项                     | 描述                                                     |
| ------------------------ | -------------------------------------------------------- |
|inventory      = /etc/ansible/hosts |指定Ansible的主机清单文件路径。|
| remote_user              | 远程连接的用户名。                                                |
| private_key_file         | 远程连接的私钥文件路径。                                             |
| become                   | 是否切换到特权用户进行操作。                                           |
| become_user              | 切换到的特权用户。                                                 |
| become_method            | 切换特权用户的方法。                                               |
| gather_facts             | 是否收集主机信息。                                                 |
| fact_caching             | 是否缓存收集到的主机信息。                                             |
| fact_caching_connection   | 用于主机信息缓存的连接信息。                                             |
| roles_path               | 角色目录的搜索路径。                                                |
| host_key_checking=False  | 是否检查主机密钥。                                                 |
| log_path                 | 日志文件路径。                                                   |
| forks=5                    | 并发执行任务的数量。                                                |
| max_fail_percentage      | 最大失败百分比，超过则停止执行。                                         |
| timeout=10               | 连接超时时间。                                                   |
| module_lang=C            | 默认模块之间的计算机语言,默认C语言|
| ssh_args                 | SSH参数。                                                    |
| log_path = ~/ansible.log | Ansible日志存放具体路径                                       |
| scp_if_ssh               | 如果SSH可用，则使用SCP传输文件。                                       |
| control_path             | SSH控制套接字路径。                                                |
| allow_world_readable_tmp | 是否允许临时文件可由其他用户读取。                                       |
| roles                    | 定义要在主机上执行的角色列表。                                            |
| tasks                    | 定义要在主机上执行的任务列表。                                            |
| handlers                 | 定义处理程序任务列表，可以在触发特定事件时调用这些处理程序。                              |
| vars                     | 定义变量和值的键值对，可以在剧本中引用这些变量。                                   |
| environment              | 指定环境变量的键值对。                                               |
| pre_tasks                | 在角色或任务之前执行的任务列表。                                           |
| post_tasks               | 在角色或任务之后执行的任务列表。                                           |
| any_errors_fatal         | 如果任何任务错误，则设置所有任务都失败。                                      |
| ignore_errors            | 如果任务失败，则忽略错误并继续执行。                                         |
| max_parallel             | 并行执行任务的最大数量。                                              |
| serial                   | 一次在目标主机上执行的批处理数量。                                         |
| strategy                 | 允许您选择执行策略（linear、free、mitogen等）。见官方文档以获取其他可用选项。                       |
| tags                     | 标记将允许您选择要运行的特定任务或角色。                                        |
| skip_tags                | 如果标记匹配，则跳过运行特定任务或角色。                                        |
| check_mode               | 是否以检查模式运行剧本，不会对主机执行任何更改。只报告将做出什么更改而不实际执行它们。                    |
| gather_subset            | 选择要收集的特定子集，如`hardware`、`network`、`virtual`等。                           |
| diff_mode                | 是否启用差异模式，显示更改的文件内容。配合使用`register`模块来收集更改的文件列表。            |



### 2.1 Ansible的常用设置

```conf
# /etc/ansible/ansible.cfg

[defaults]
# Set the log_path
log_path = ~/ansible.log

# Additional default options for Ansible
forks = 20
host_key_checking = False
retry_files_enabled = False
retry_files_save_path = ~/ansible-installer-retries
nocows = True
remote_user = root
roles_path = roles/
gathering = smart
fact_caching = jsonfile
fact_caching_connection = $HOME/ansible/facts
fact_caching_timeout = 600
callback_whitelist = profile_tasks
inventory_ignore_extensions = secrets.py, .pyc, .cfg, .crt, .ini
# work around privilege escalation timeouts in ansible:
timeout = 30
host_key_checking = False

# Uncomment to use the provided example inventory
#inventory = inventory/hosts.example

ansible_managed = Ansible managed: {file} modified by {uid} on {host}

[inventory]
# fail more helpfully when the inventory file does not parse (Ansible 2.4+)
unparsed_is_failed=true

# Additional ssh options for OpenShift Ansible
[ssh_connection]
retries = 15
pipelining = True
ssh_args = -o ControlMaster=auto -o ControlPersist=600s
timeout = 10
# shorten the ControlPath which is often too long; when it is,
# ssh connection reuse silently fails, making everything slower.
control_path = %(directory)s/%%h-%%r
```


### 2.2 设置免密登录

使用 ssh 秘钥连接主机

```shell
echo 'PubkeyAuthentication yes' >> /etc/ssh/sshd_config
systemctl restart sshd
```

配置远程主机秘钥
```shell
#生成SSH秘钥的连接

# 在主控端主机（SN2013-08-020）创建密钥，执行：ssh-keygen-t
# rsa，有询问直接按回车键即可，将在/root/.ssh/下生成一对密钥，其中
# id_rsa为私钥，id_rsa.pub为公钥（需要下发到被控主机用户.ssh目录，同时要求重命名成authorized_keys文件）

# ssh-keygen -t rsa
# ssh-copy-id root@<client_ip> -p 22

# 或者如下
# ssh-keygen -t rsa -P '' -b 4096 -f ~/.ssh/id_rsa


# 或者生成自定义的rsa key认证
ssh-keygen  -N "" -b 4096 -t rsa -C "stanley@magedu.com" -f /root/.ssh/stanley.rsa



# 为本机添加密钥认证
ssh-copy-id –i /root/.ssh/stanley.rsa root@localhost
ssh-copy-id –i /root/.ssh/stanley.rsa root@192.xx.xx.100
```


[Ansible Role: ssh keys](https://ansible.leops.cn/roles/env/ssh-keys/)


### 2.3 配置主机清单

示例

```
[k8s_cluster_work]
172.18.0.1
172.18.0.2
172.18.0.3
172.18.0.4
172.18.0.5

[k8s_cluster_master]
172.18.0.1
172.18.0.2
172.18.0.3

[k8s_cluster:children]
k8s_cluster_work
k8s_cluster_master

[k8s_cluster:vars]
ansible_ssh_user=root

[app]
172.18.0.15
172.18.0.13
172.18.0.12
172.18.0.14


[russia:children]
k8s_cluster
gitaly


[russia:vars]
ansible_ssh_user=root
ansible_ssh_pass='xxxx'
```


### 2.4 执行ansible命令

```shell
# 测试连接状态
ansible 192.168.77.135 -m ping

# 安装Nginx
ansible 192.168.77.135 -m yum -a 'name=nginx'

# 启动Nginx
ansible 192.168.77.135 -m yum -a 'name=nginx'
```



## 3.定义主机与组规则(Inventory)

Ansible通过定义好的主机与组规则（Inventory文件)指定了Ansible作用的主机列表，

Ansible默认读取/etc/ansible/hosts文件。

当然，这里也可以通过ANSIBLE_HOSTS环境变量来指定，或者在运行ansible-hoc及ansible-playbook时用“-i”参数指定临时主机列表文件。

下面是Inventory文件的一个例子：

```conf
mail.example.com

[webservers]
foo.example.com
bar.example.com

[dbservers]
one.example.com
two.example.com
Three.example.com

```
其中，中括号内的是组名称，一台主机可以属于多个组。
一台属于多个组的主机会读取多个组的变量文件，这样可能就会产生冲突，工作中尽量避免这样的写法。

定义好Inventory文件以后，就可以用下面的命令来验证主机列表内容了，代码如下所示：

```bash
ansible webservers --list-hosts
```
或者：

```bash
ansible dbserver --ilst-hosts
```

有一个主机会被Ansible默认自动添加到Inventory中，那就是localhost。
Ansible以为localhost就代表本地主机，所以在需要它的时候会直接在本机执行而不是通过SSH连接。


如果SSH采用的不是默认的22端口，那么可以在主机后面指定SSH端口，代码如下所示：
```bash
badwolf.example.com:5309
```

使用静态IP时，如果我们希望在hosts文件中使用别名或通过通道进行连接，则可以采用类似如下的方式，代码如下所示：
```bash
jumper ansible_ssh_port=5555 ansible_ssh_host=192.168.1.50
```


如果有很多类似的主机名称，则在没必要时不用一一列出，代码如下所示：
```conf
[webservers]
www[01:50].example.com
db-[a:f].example.com
```

其中，数字开头的0可以省略，中括号是闭合的。


也可以指定每个主机的连接类型和用户名：
```conf

[targets]
localhost ansible_connection=local
otherl.example.com ansible_connection=ssh ansible_ssh user=mpdehaan
other2.example.com ansible_connection=ssh ansible_ssh user=mdehaan
```

如上述代码所示，直接在Inventory文件中添加参数的方式并不是一个好的选择，后面会介绍更好的方法，那就是在单独的host_vars目录中定义参数。

### 3.1 定义主机变量

主机可以指定变量，以便后续供playbooks配置使用，例如下面的代码定义了主机host1和host2上面Apache的参数http_port及maxRequestsPerChild:

```conf
[atlanta]
host1 http_port=80 maxRequestsPerchild=808
host2 http_port=303 maxRequestsPerchild=909
```

### 3.2 定义组变量

组变量的作用是覆盖组中的所有成员，下面定义一个新块，块名由组名+"：vas"组成，示例代码如下所示：
```conf
[atlanta]
host1
host2

[atlanta:vars]
ntp server=ntp.atlanta.example.com
proxy=proxy.atlanta.example.com
```


组的组也可以称为组嵌套。


组嵌套是定义一个新块，块名由组名+"：children"组成，示例代码如下所示：

```conf
[atlanta]
hostl
host2

[raleigh]
host2
host3

[southeast:children]
atlanta
raleigh

[usa:children]
southeast
northeast
southwest
Northwest
```


### 3.3 分离主机和组变量

在ansible中更好的实践并不是把变量放到Inventory文件中，而是使用YAML格式保存到单独的文件中，不要与Inventory放置到一起。


假设Inventory文件的路径为/etc/ansible/hosts,其中有个主机名为foosbal,属于raleigh和webservers两个组，那么以下位置的YAML文件会对foosball主机有效：

```shell
/etc/ansible/group_vars/raleigh
/etc/ansible/group_vars/webservers
/etc/ansible/host_vars/foosball
```

例如，/etc/ansible/group_.vars/raleigh文件看起来可能类似于下面这样：

```shell
ntp server:acme.example.org
database server:storage.example.org
```

事实上，上面涉及的内容全部属于静态Inventory的范畴。

在实际运维自动化的工作中，动态Inventory文件应用得更多，主要用于要编写Python脚本（不一定局限于Python
语言，但推荐采用Python),以便从公司的CMDB(资产管理)系统提供的API拉取所有的主机信息，然后再使用Ansible来进行管理，这样就能很方便地将Ansible与其他运维系统
结合起来使用了。


!!!info "参考文献"


    [使用动态主机](https://ansible.leops.cn/advanced/dynamic-hosts/)


## 4.Ansible常用模块介绍

Ansible常用模块有很多，包括云计算、命令行、包管理、系统服务、用户管理等，可以通过[官方网站](https://docs.ansible.com/ansible/latest/module_plugin_guide/index.html)
查看相应的模块，也可以在命令行下通过`ansible--doc -l`命令查看模块，或者通过`ansible-doc -s`模块名查看具
体某个模块的使用方法。

示例

```shell
ansible-doc -l
ansible-doc -s yum
ansible-doc yum
```

官网的介绍比较详细，建议查看官网介绍。“ansible-doc -l”命令部分显示结果如下所示：

```shell
.....
purestorage.flashblade.purefb_s3user                                                     Create or delete FlashBlade Object Store account users
purestorage.flashblade.purefb_smtp                                                       Configure SMTP for Pure Storage FlashBlade
purestorage.flashblade.purefb_snap                                                       Manage filesystem snapshots on Pure Storage FlashBlades
purestorage.flashblade.purefb_snmp_agent                                                 Configure the FlashBlade SNMP Agent
purestorage.flashblade.purefb_snmp_mgr                                                   Configure FlashBlade SNMP Managers
purestorage.flashblade.purefb_subnet                                                     Manage network subnets in a Pure Storage FlashBlade
purestorage.flashblade.purefb_syslog                                                     Configure Pure Storage FlashBlade syslog settings
purestorage.flashblade.purefb_target                                                     Manage remote S3-capable targets for a FlashBlade
purestorage.flashblade.purefb_timeout                                                    Configure Pure Storage FlashBlade GUI idle timeout
purestorage.flashblade.purefb_user                                                       Modify FlashBlade local user account password
purestorage.flashblade.purefb_userpolicy                                                 Manage FlashBlade Object Store User Access Policies
purestorage.flashblade.purefb_virtualhost                                                Manage FlashBlade Object Store Virtual Hosts
raw                                                                                      Executes a low-down and dirty command
reboot                                                                                   Reboot a machine
replace                                                                                  Replace all instances of a particular string in a file using a back-referenced regular expression
rpm_key                                                                                  Adds or removes a gpg key from the rpm db
script                                                                                   Runs a local script on a remote node after transferring it
sensu.sensu_go.ad_auth_provider                                                          Manage Sensu AD authent
.....
```

下面介绍运维工作中经常用到的几个模块，其他模块不再逐一介绍，建议大家参考官文档。

+ setup模块
+ copy模块
+ synchronize模块
+ file模块
+ ping模块
+ group模块
+ user模块
+ shell模块
+ script模块
+ get url模块
+ yum模块
+ cron模块
+ service模块


Ansible命令行调用模块的语法格式如下所示：
```shell

ansible 操作目标 -m 模块名 -a 模块参数
```



### setup模块

(1)功能

setup 模块来收集主机的系统信息，这些 facts 信息可以直接以变量的形式使用，但是如果主机较多，会影响执行速度，可以使用gather_facts: no来禁止 Ansible 收集 facts 信息

`ansible-doc -s setup`



(2) 举例

```shell
# 查看已经安装的东西
ansible all  -m setup

# 查看所有节点的ansible_python的版本
ansible all  -m  setup -a 'filter=ansible_python_version'  
```



### copy模块

(1)功能


Ansible 中的copy模块用于实现文件复制和批量下发文件，src来定义本地源文件路径，使用dest定义被管理主机文件路径，使用content定义信息内容来生成目标文件

该模块可实现Ansible主机向客户端传送文件的功能，文件的变化是通过md5值来判断的，大家需要记住应提前关闭客户端机器的SELinux。

`ansible-doc -s copy`




(2) 举例

```shell 
src: # 源文件  指定拷贝文件的本地路径  (如果有/ 则拷贝目录内容,比拷贝目录本身)     
dest: # 指定目标路径     
mode: # 设置权限    
  backup: # 备份源文件  
  content: # 代替src  指定本机文件内容,生成目标主机文件
```

```shell
# 进行复制dest=/tmp/test.txt"
ansible webserver -m copy -a "content='test content\nxxx' dest=/tmp/test.txt"


# 进行查看
ansible webserver  -a "cat /tmp/test.txt" 



ansible webservers -m copy -a "src=/home/test.sh dest=/tmp/ owner=root group=root mode=0755"
ansible dbservers -m copy -a 'src=/etc/fstab dest=/tmp/fstab.ansible owner=root mode=640'

#将“Hello Ansible Hi Ansible”写入管理主机的/tmp/test.ansible文件中
ansible dbservers -m copy -a 'content="Hello Ansible Hi Ansible" dest=/tmp/test.ansible'

# 拷贝是设置权限，force强制覆盖，默认。 backup参考，拷贝覆盖前进行备份
ansible webserver -m copy -a "src=/usr/local/src/test.py dest=/tmp/owner=root group=root mode=0755 force=yes"

ansible web -m copy -a "src=/mine/ntp.conf dest=/etc/ntp.conf owner=root group=root mode=644 backup=yes force=yes"
```


### synchronize模块

(1)功能

由于synchronize模块会调用rsync命令，因此首先要记得提前安装好rsync软件包，不然执行的时候会出现`"msg":"[Errno2]No such file or directory'"`这种报错信息。

`ansible-doc -s synchronize`




(2)举例

synchronize模块用于将Ansible机器的指定目录推送(push)到客户机器的指定目录下，命令如下：

```shell
ansible 192.168.1.206 -m synchronize -a "src=/usr/local/src/ dest=/usr/local/ src/delete=yes compress=yes
```

其中，delete=-yes用来实现使两边的内容一样(即以push方式为主)，实现效果与`rsync-delete`一样，
如果是客户端不存在的文件或目录则增补，如果存在着不同的文件或目录则删除，以保证两边内容一致。

compress=yes用于开启压缩，默认为开启。

另外，由于synchronize模块调用的是rsync命令，因此如果路径使用“/”来结尾，则只复制目录里的内容，如果没有使用“/”来结尾，则包含目录在内的整个内容全部都要复
制过去(源目标目录作为目的目录的一个子目录存在)。




### file模块

(1)功能

Ansible中使用file模块来设置文件属性，path指定文件路径，sec指定源文件路径，使用name或dest来替换创建文件的符号链接

`ansible-doc -s file`




(2)举例

```shell
# 更改文件的用户及权限
ansible web -m file -a "dest=/tmp/a.txt mode=600 owner=user group=user"


# 创建目录，类似mkdir -p
ansible web -m file -a "dest=/tmp/test mode=755 owner=user group=user state=directory"


# 删除文件或者目录
ansible web -m file -a "dest=/tmp/test state=absent"


# 创建软连接，并设置所属用户和用户组
ansible web -m file -a  "src=/file/to/link/to dest=/path/to/symlink owner=user group=user state=link"


# touch 一个文件并添加用户读写权限，用户组去除写执行权限，其他组减去读写执行权限
ansible web -m file -a  "path=/etc/foo.conf state=touch mode='u+rw,g-wx,o-rwx'"


ansible webserver -m file -a 'path=/app/test.txt state=touch'       #创建文件   
ansible webserver -m file -a "path=/data/testdir state=directory"   #创建目录         
ansible webserver -m file -a "path=/root/test.sh owner=wang mode=755"  #设置权限755     
ansible webserver -m file -a 'src=/data/testfile dest=/data/testfile-link state=link' #创建软链接  
```


### ping模块

ping模块，其可用于检测与被控端机器的连通性，命令如下：

```shell
ansible all -m ping
```


### group模块


(1)功能

Ansible中的group模块用于对用户组进行管理

`ansible-doc -s group`



（2）例子

```shell
# 创建mysql组，将mysql用户添加到mysql组中
ansible dbservers -m group -a 'name=mysql gid=306 system=yes'
ansible dbservers -m user -a 'name=mysql uid=306 system=yes group=mysql'

# 创建一个组名为test gid为2018的组
ansible webserver -m group -a gid=2018 name='test'

# 查看创建的组 
ansible webserver -m shell -a 'cat /etc/group|grep test'

```

注意这里使用了shell模块，没有使用默认的command模块，

ansible的默认模块command，它不会通过shell进行处理，所以像`$HOME`和像`“<”，“>”，“|”，“;”`和`“＆”`将不工作。


### user模块

(1)功能

Ansible中的user模块用于创建新用户和更改、删除已存在的用户。其中name选项用来这么创建的用户名称。

远程主机系统用户管理。

`ansible-doc -s user`


(2)示例

```shell
#创建用户
ansible dbservers -m user -a 'name="user1"'

#该场景中我们可以掌握如下技能点。
# 1）groups设定：groups=用户组1，用户组2……
# 2）增量添加属组：append=yes
# 3）表明属组状态为新建：state=present

ansible db -m user -a "name=dba shell=/bin/bash groups=admins,dbagroup append=yes home=/home/dba/ state=present"

#设置系统用户tom的密码为redhat123。
ansible db -m user -a "name=tom shell=/bin/bash password=to46pW3GOukvA update_password=always"

#删除用户
ansible dbservers -m user -a 'name="user1" state=absent'
ansible db -m user -a "name=dba state=absent remove=yes"



######## windows 用户管理 ###########

#新增用户stanley，密码为magedu@123，属组为Administrators。
ansible windows -m win_user -a "name=stanley passwd=magedu@123 group=Administrators"

######## 应用层用户管理 ####################

#新增MySQL用户stanley，设置登录密码为magedu@bj，对zabbix.*表有ALL权限
ansible db -m mysql_user -a 'login_host=localhost login_password=magedu login_user=root name=stanley password=magedu@bj priv=zabbix.*:ALL state=present'
```


### shell模块

(1) 功能

command模块作为Ansible的默认模块，可以运行被控端机器权限范围内的所有shell命令，前面已多次提到，这里不再重复。

而shell模块用于执行被控端机器的Shell脚本文件，与另一个模块raw的功能类似，并且支持管道符。

`ansible-doc -s shell`

(2) 示例

获取web组里得eth0接口信息

```shell
ansible web -m shell -a "ifconfig eth0|grep addr"
```

### raw模块

如果说远程主机没有python 模块时，可以使用raw 模块执行命令

```shell
ansible web -m raw -a "ifconfig eth0|grep addr"
```


### scritp模块

(1) 功能
script模块用于在远程被控端主机执行本地Ansible机器中的Shell脚本文件，相当于“scp+shell”的组合命令。



(2) 示例
```shell
# 执行脚本
ansible web -m script -a ip.sh

ansible webserver -m script -a 'data/test.sh'
```


### get_url模块


(1) 功能

实现在远程主机下载指定URL到本地，支持sha256sum文件校验



(2) 例子

```shell
ansible webservers -m get_url -a "url=http://www.baidu.com dest=/tmp/index.html mode=0440 force=yes"
```


### yum模块

Ansible中的yum模块负责在被管理的主机数安装与卸载软件包，前提是在每个节点配置自己的YUM仓库，name指定要安装的软件包

带上软件包的版本号，state指定安装软件包的状态，present、latest用来表示安装，absent表示卸载

`ansible-doc -s yum`



(1) 功能

Linux平台软件包管理操作，常见有yum、apt管理方式。


(2) 例子

```shell
# 安装zsh软件包
ansible dbservers -m yum -a 'name=zsh'

# 卸载zsh软件包
ansible dbservers -m yum -a 'name=zsh,state=absent'

ansible webservers -m yum -a "name=curl state=latest"

#Redis安装命令：
ansible db-m yum -a "name=redis state=present"。

#Redis安装检查：
ansible db-m command -a "redis-cli--version"。

# 安装MariaDB-server
ansible db -m yum -a "name=MariaDB-server state=present"

# #安装MySQL-python和python-setuptools依赖包。
ansible app -m yum -a "name=MySQL-python state=present"
ansible app -m yum -a "name=python-setuptools state=present"
```

### apt模块

Ubuntu/Debian系统

```shell
# 更新仓库缓存，并安装"curl"
ansible webservers -m apt -a "name=curl update_cache=yes"

## 安装
ansible webservers -m apt -a "pkg=curl state=present"

# 安装最新得"curl"
ansible all -m apt -a "name=curl state=latest"

## 删除
ansible webservers -m apt -a "pkg=curl state=absent"
```



### cron模块

(1)功能

Ansible中的cron模块用于定义任务计划，其中有两种状态，(state):present表示添加(省略状态时默认使用),absent表示移除。


`ansible-doc -s cron`

(2) 例子

```shell
#添加计划任务
ansible dbservers -m cron -a 'minute="*/10" job="/bin/echo hello" name="test cron job"'
192.168.1.108 | CHANGED => {
    "changed": true,
    "envs": [],
    "jobs": [
        "test cron job"
    ]

#查看crontab计划任务
ansible dbservers -a 'crontab -l'
192.168.1.108 | CHANGED | rc=0 >>
#Ansible: test cron job
*/10 * * * * /bin/echo hello

#移除计划任务
ansible dbservers -m cron -a 'minute="*/10" job="/bin/echo hello" name="test cron job" state=absent'

```

### service模块


(1) 功能

远程主机系统服务管理。


`ansible-doc -s service`


在 Ansible中使用service模块来控制管理服务器的运行状态，enable表示是否开机自启动， 值为true或者false，

使用name来定义服务名称使用state指定服务状态，取值为started、stoped、restarted


(2) 示例

```shell
ansible webservers -m service -a "name=nginx state=stopped"
ansible webservers -m service -a "name=nginx state=restarted"
ansible webservers -m service -a "name=nginx state=reloaded"

#安装httpd服务
ansible webservers -m yum -a "name=httpd state=latest"

#查看httpd服务的状态
ansible dbservers -a 'service httpd status'
#查看http服务开机启动状态
ansible dbservers -a 'chkconfig httpd status'

#设置httpd服务为开机自启动
ansible dbservers -m service -a 'enable=ture name=httpd state=started'

ansible webservers -m service -a "name=nginx state=stopped"
ansible webservers -m service -a "name=nginx state=restarted"
ansible webservers -m service -a "name=nginx state=reloaded"
```



## 5. playbook介绍

