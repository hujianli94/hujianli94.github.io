# 10.oslo.log

OpenStack 的 oslo.log 是一个为 OpenStack 项目提供日志记录功能的库。

其对 python logging 的封装，可以快速便捷地写出我们的日志模块。

官网上有许多参考示例，但实例永远是实例，其配合 oslo_config 模块，快捷注册日志，从而获取进程启动运行中的所有日志。

官网资料详尽，参考 https://docs.openstack.org/oslo.log/

## python_logging

```python
#!/usr/bin/env python3
# -*- coding:utf8 -*-
# Copyright: (c)  : @Time 2024/9/20 15:23  @Author  : hjl
# @Author  : hujl
# @File    : python_logging.py.py
# @Software: PyCharm
# @Desc    :
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

import logging

LOG = logging.getLogger(__name__)

# Define a default handler at INFO logging level
logging.basicConfig(level=logging.INFO)

LOG.info("Python Standard Logging")
LOG.warning("Python Standard Logging")
LOG.error("Python Standard Logging")
```

## oslo_log

日志级别

- DEBUG: 打印全级别日志
- INFO: 打印 info/warning/error/critical 级别日志
- WARNING: 打印 warning/error/critical 级别日志
- ERROR: 打印 error/critical 级别日志
- CRITICAL: 打印 critical 级别

### 1.oslo_log 日志写入文件

在程序中，只需要将这些配置注册到 oslo_config 中，参考 ceilometer 的源码，编写一个例子，将进程的调用日志记录在文件中。

#### demo 实践

```python
#!/usr/bin/env python3
# -*- coding:utf8 -*-
from oslo_log import log
from oslo_config import cfg
import sys

LOG = log.getLogger(__name__)


def prepare_service(argv=None, config_file=None):
    log.register_options(cfg.CONF)  # 注册配置项
    log_level = cfg.CONF.default_log_levels  # 设置默认日志级别INFO
    log.set_defaults(default_log_levels=log_level)
    if argv is None:
        argv = sys.argv
    cfg.CONF(argv[1:], project='ceilometer', default_config_files=config_file)  # 将进程中配置文件或日志文件注册在配置项中
    log.setup(cfg.CONF, 'ceilometer')  #


def print_log():
    LOG.info("===>I LOVE YOU CAESAR<=====")


prepare_service()
print_log()
```

```sh
(venv) python log_test.py --log-file=./caesar.log

$ cat caesar.log
2024-09-20 15:36:12.710 29092 INFO __main__ [-] ===>I LOVE YOU CAESAR<=====
```

进程启动时，带上日志路径参数，执行完成后，可在日志文件中看到执行结果。

### 2.oslo_config 对配置项的默认管理

以上通过 --config-file 传入服务配置，--log-file 传入服务日志位置。

#### demo 实践

对于 config-file 中未配置项，使用默认的配置，其定义、注册和调用，举例说明：

设置项目结构：

```sh
$ tree -L 1
.
├── oslo_log_example.conf
├── oslo_log_example.py
```

`oslo_log_example.conf`

```ini
[DEFAULT]
max_retries = 5
retry_interval = 30
connection = mongodb://192.168.1.123:17017/

[MONGO]
database = mydatabase

[LOG]
log_file = my_log.log
log_level = 20
debug = true
```

`oslo_log_example.py`

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import sys
from oslo_config import cfg
from oslo_log import log as logging
import itertools
import time

# 定义配置选项
mongo_OPTS = [
    cfg.StrOpt('database',
               default='mongodb',
               help='database'),
]

OPTS = [
    cfg.IntOpt('max_retries',
               default=3,
               help="max connection to database times"),
    cfg.IntOpt('retry_interval',
               default=60,
               help='connection timeout 60 seconds'),
    cfg.StrOpt('connection',
               default='mongodb://192.168.1.111:27017,'
                       '192.168.1.112:27017,'
                       '192.168.1.113:27017/test',
               help='connection mongodb url'),
]

LOGGING_OPTS = [
    cfg.StrOpt('log_file',
               default='example.log',
               help='Log file to output to.'),
    cfg.IntOpt('log_level',
               default=logging.INFO,
               help='Log level.'),
    cfg.BoolOpt('debug',
                default=False,
                help='Enable debug logging.'),
]


# 将配置项注册到相应的分组中
def list_opts():
    return [
        ('MONGO', itertools.chain(mongo_OPTS)),
        ('DEFAULT', itertools.chain(OPTS)),
        ('log', itertools.chain(LOGGING_OPTS))
    ]


# 初始化配置对象
conf = cfg.ConfigOpts()

# 注册配置项
for group, options in list_opts():
    conf.register_opts(list(options), group=None if group == "DEFAULT" else group)

# 设置日志
logging.register_options(conf)

if __name__ == '__main__':
    # 解析命令行参数
    conf(sys.argv[1:], project='oslo_log_example', default_config_files=['./oslo_log_example.conf'])

    # 获取日志文件位置
    log_file = conf.log.log_file
    log_level = conf.log.log_level
    debug_mode = conf.log.debug

    # 设置日志输出
    logging.setup(conf, 'oslo_log_example')
    LOG = logging.getLogger(__name__)

    # 设置日志级别
    if debug_mode:
        LOG.setLevel(logging.DEBUG)
    else:
        LOG.setLevel(log_level)

    # 输出日志信息
    LOG.info(f'Logging to {log_file} with log level {log_level}')


    def connect_to_database():
        max_retries = conf.max_retries
        retry_interval = conf.retry_interval
        connection_str = conf.connection

        db = conf.MONGO.database

        for attempt in range(max_retries):
            try:
                LOG.info(f'Attempting to connect to MongoDB at {connection_str}{db}...')
                time.sleep(1)  # 模拟连接延迟
                LOG.info('Connected to MongoDB successfully!')
                return
            except Exception as e:
                LOG.error(f'Connection attempt {attempt + 1} failed: {e}')
                time.sleep(retry_interval)

        LOG.critical('Failed to connect to the database after multiple attempts.')


    connect_to_database()
```

运行结果：

```sh
$ python oslo_log_example.py --config-file=./oslo_log_example.conf
2024-09-20 17:16:14.520 27632 INFO __main__ [-] Logging to example.log with log level 20
2024-09-20 17:16:14.521 27632 INFO __main__ [-] Attempting to connect to MongoDB at mongodb://192.168.1.123:17017/mydatabase...
2024-09-20 17:16:15.531 27632 INFO __main__ [-] Connected to MongoDB successfully!

$ python oslo_log_example.py --config-file=./oslo_log_example.conf --log-file=./mylog.log
```

## 参考文献

- https://docs.openstack.org/oslo.log/latest/user/usage.html

- https://docs.openstack.org/oslo.log/latest/user/examples.html

- https://www.cnblogs.com/CaesarLinsa/p/8729796.html
