# 09.oslo.db

oslo.db 是针对 SQLAlchemy 访问的抽象。

代码库位于：https://github.com/openstack/oslo.db

项目主页为：https://bugs.launchpad.net/oslo

参考文档在：http://docs.openstack.org/developer/oslo.db

这个库主要用于 OpenStack 各个项目中的数据库操作，但它也可以被其他项目使用。

下面是一个简单的示例，展示了如何使用 `oslo.db` 来定义一个数据库模型，并进行基本的创建表、添加数据和查询数据操作。

首先，你需要安装 oslo.db 和其他依赖库：

```sh
pip install oslo.db sqlalchemy
```

安装 SQL 后端

```shell
# PostgreSQL
$ pip install psycopg2
# mysql
$ pip install pymysql
# sqlite
$ pip install pysqlite
```

使用 PostgreSQL

如果您使用PostgreSQL，请确保为您的发行版安装PostgreSQL客户端开发包。在Ubuntu上完成如下：
```shell
$ sudo apt-get install libpq-dev
$ pip install psycopg2
```



## 示例1 SQLite

使用 SQLite
如果您使用SQLite，请确保为您的发行版安装SQLite客户端开发包。在Ubuntu上完成如下：
```shell
$ sudo apt-get install libsqlite3-dev
$ pip install pysqlite
```

目录结构

```sh
tree oslo-db/
oslo-db/
├── __init__.py
├── config.ini
├── example1.py
```

`config.ini`

```ini
[database]
connection = sqlite:///example.db
;connection = mysql+pymysql://root:password@localhost/database
;connection = postgresql://user:password@localhost/database
```

然后，你可以编写一个 Python 脚本来使用 oslo.db：

`example.py`

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
import os
from oslo_config import cfg
from oslo_db import options as db_options
from oslo_db.sqlalchemy import session
from sqlalchemy import Column, Integer, String, create_engine
from sqlalchemy.orm import declarative_base
from sqlalchemy.orm import sessionmaker

# 注册数据库配置选项
# db_options.set_defaults(cfg.CONF, connection='mysql+pymysql://root:123456@localhost:3306/test')
db_options.set_defaults(cfg.CONF)

# 定义配置文件路径
config_file = 'config.ini'
if os.path.exists(config_file):
    CONF = cfg.CONF
    # 加载配置文件
    CONF([], project='myapp', default_config_files=[config_file])
else:
    print(f"Config file '{config_file}' does not exist.")

# 创建数据库引擎
engine = create_engine(CONF.database.connection, echo=True)

# 定义模型基础类
Base = declarative_base()


# 定义一个简单的用户模型
class User(Base):
    __tablename__ = 'users'

    id = Column(Integer, primary_key=True)
    name = Column(String)
    age = Column(Integer)


# 创建表
Base.metadata.create_all(engine)

# 创建一个 Session 类
Session = sessionmaker(bind=engine)

# 创建一个数据库会话
with Session() as session:
    # 添加用户
    user = User(name='Alice', age=30)
    session.add(user)
    session.commit()

    # 查询用户
    users = session.query(User).all()
    for u in users:
        print(f'User ID: {u.id}, Name: {u.name}, Age: {u.age}')
```

确保 config.ini 文件和 Python 脚本位于同一目录中，或者提供正确的文件路径。

这样，当脚本运行时，它会读取配置文件中的数据库连接信息，并使用这些信息来连接数据库。



## 示例2 MySQL

使用 MySQL
如果您使用MySQL，请确保为您的发行版安装MySQL客户端开发包。在Ubuntu上完成如下：
```shell
$ sudo apt-get install libmysqlclient-dev
$ pip install cryptography
$ pip install pymysql
```


目录结构

```sh
tree oslo-db/
oslo-db/
├── __init__.py
├── config.ini
├── example2.py
```

`config.ini`

```ini
[database]
connection = mysql+pymysql://root:xxxx@localhost/users
```

`example2.py`

```python
from oslo_config import cfg
from oslo_log import log
from oslo_db import options as db_options
from oslo_db.sqlalchemy import enginefacade
from sqlalchemy import Column, Integer, String
from sqlalchemy.orm import declarative_base

"""
需要先创建一个数据库
CREATE DATABASE users;
"""

# 初始化logger
LOG = log.getLogger(__name__)

# 配置数据库选项
db_options.set_defaults(cfg.CONF)
CONF = cfg.CONF

# 注册日志选项
log.register_options(CONF)

# 使用 SQLAlchemy 的 declarative_base
Base = declarative_base()

# 从配置文件加载配置，这一步会解析命令行参数
CONF(default_config_files=['config.ini'])

# 设置日志
log.setup(CONF, __name__)


# 创建正确的上下文管理器（在文件顶部添加）
@enginefacade.transaction_context_provider
class Context(object):
    pass


context = Context()


class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, primary_key=True)
    name = Column(String(255))
    email = Column(String(255))


# 创建数据库引擎
engine = enginefacade.writer.get_engine()


# 初始化数据库（创建表）
def initialize_db():
    Base.metadata.create_all(engine)


# 在数据库中创建一个用户
def create_user(name, email):
    session = enginefacade.writer.get_sessionmaker()()
    try:
        user = User(name=name, email=email)
        session.add(user)
        session.commit()
        return user
    finally:
        session.close()


def get_user_by_name(name):
    session = enginefacade.reader.get_sessionmaker()()
    try:
        return session.query(User).filter(User.name == name).first()
    finally:
        session.close()


def main():
    # 初始化数据库（创建表）
    initialize_db()

    # 创建一个新用户
    new_user = create_user('John Doe', 'johndoe@example.com')
    LOG.info(f'Created new user: {new_user.name}, {new_user.email}')

    # 根据用户名查询用户
    user = get_user_by_name('John Doe')
    if user:
        LOG.info(f'Found user: {user.name}, {user.email}')
    else:
        LOG.info('User not found.')


if __name__ == '__main__':
    main()
```


输出
```sh
$ python example2.py
2025-03-25 17:42:11.098 156876 INFO __main__ [-] Created new user: John Doe, johndoe@example.com
2025-03-25 17:42:11.103 156876 INFO __main__ [-] Found user: John Doe, johndoe@example.com
```


参考文献：

- https://magiceses.github.io/2018/10/05/openstack-oslo.packages-oslo.db/
