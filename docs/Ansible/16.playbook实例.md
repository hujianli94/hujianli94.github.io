# 16.playbook 实例

## 服务部署自动化

### 部署 Redis 服务端

redis_server.yml

```yaml
---
- hosts: dbservers

tasks:
  - name: Installed Redis Server
    yum:
      name: redis
      state: present
  
  - name: Configure Redis Server
    copy:
      src: ./files/redis.conf.j2
      dest: /etc/redis.conf
      owner: redis
      group: root
      mode: 0640
      notify: Restart Redis Server
  
  - name: Systemd Redis Server
    systemd:
      name: redis
      state: started
      enabled: yes

handlers:
  - name: Restart Redis Server
    systemd:
      name: redis
      state: restarted
```

### 创建 mysql 用户

范例：mysql_user.yml

```yaml
---
- hosts: dbsrvs
  remote_user: root
  gather_facts: no

tasks:
  - name: create group
    group: name=mysql system=yes gid=306

  - name: create user
    user: name=mysql shell=/sbin/nologin system=yes group=mysql uid=306 home=/data/mysql create_home=no
```

### 部署 NFS 服务端

```sh
[root@ansbile playbook]# cat ./exports.j2
/nfs_test 10.0.0.0/24(rw,all_squash,anonuid=666,anongid=666)
```

install_nfs_server.yml

```yaml
---
- hosts: webservers

tasks:
  - name: 1.Installed NFS Server
    yum:
      name: nfs-utils
      state: present
 
  - name: 2.Configure NFS Server
    copy:
      src: ./exports.j2
      dest: /etc/exports
      notify: Restart NFS Server

  - name: 3.Init Group
    group:
      name: www
      gid: 666
 
  - name: 4.Init User
    user:
      name: www
      uid: 666
      group: www
      shell: /sbin/nologin
      create_home: no
   
  - name: 5.Init Create Directory
    file:
     path: /nfs_test
     state: directory
     owner: www
     group: www
     mode: "0755"
 
  - name: 6.Started NFS Server
    systemd:
     name: nfs
     state: started
     enabled: yes

handlers:
 - name: Restart NFS Server
   systemd:
     name: nfs
     state: restarted
```

### 部署 nginx

范例：install_nginx.yml

```yaml
---
# install nginx
- hosts: websrvs
  remote_user: root
  gather_facts: no

tasks:
  - name: add group nginx
    group: name=nginx state=present

  - name: add user nginx
    user: name=nginx state=present group=nginx

  - name: Install Nginx
    yum: name=nginx state=present

  - name: web page
    copy: src=files/index.html dest=/usr/share/nginx/html/index.html

  - name: Start Nginx
    service: name=nginx state=started enabled=yes
```

### 一个系统初始化剧本

```yaml
- name: copy to /root/.bash_profile
  copy: src={{ item.src }} dest={{ item.dest }}
  loop:
    - { src: ".bash_profile", dest: "/root/.bash_profile" }
    - { src: "su", dest: "/etc/pam.d/su" }
    - { src: "bashrc", dest: "/etc/bashrc" }
    - { src: "/etc/hosts", dest: "/etc/hosts" }

- name: copy sshd_config
  copy: src=sshd_config dest=/etc/ssh/
  notify: restart sshd

- name: yum install
  yum: name={{ item }} state=latest
  loop:
    - iotop
    - unzip
    - bash-completion
    - wget
    - tree
    - lsof
    - telnet

- name: change rc.local privileges
  file: path=/etc/rc.d/rc.local mode=0755
```

### 系统更新自动化

```yaml
---
- name: Update and clean up Linux OS
  hosts: Linux
  # 添加一个批处理大小和最大失败百分比参数。可用于启用一定程度的保护：
  # max_fail_percentage: 20
  # serial: 5
  become: yes
  # become_user: setup
  gather_facts: yes

  tasks:
    - name: Update Debian Linux packages with Index updated
      apt:
        upgrade: dist
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Update Red Hat Linux packages with Index updated
      yum:
        name: "*"
        state: latest
        update_cache: yes
      when: ansible_os_family == "RedHat"

    - name: Clean up Debian Linux from cache and unused packages
      apt:
        autoremove: yes
        autoclean: yes
      when: ansible_os_family == "Debian"

    - name: Clean up Red Hat Linux from cache and unused packages
      shell: yum clean all; yum autoremove
      when: ansible_os_family == "RedHat"
      ignore_errors: yes

   - name: Check if Debian system requires a reboot
     shell: "[ -f /var/run/reboot-required ]"
     failed_when: False
     register: reboot_required
     changed_when: reboot_required.rc == 0
     notify: reboot
     when: ansible_os_family == "Debian"
     ignore_errors: yes

   - name: Check if Red Hat system requires a reboot
     shell: "[ $(rpm -q kernel|tail -n 1) != kernel-$(uname -r) ]"
     failed_when: False
     register: reboot_required
     changed_when: reboot_required.rc == 0
     notify: reboot
     when: ansible_os_family == "RedHat"
     ignore_errors: yes

  handlers:
    - name: reboot
      command: shutdown -r 1 "A system reboot triggered after and Ansible automated system update"
      async: 0
      poll: 0
      ignore_errors: true
```

### 自动网络驱动器挂载（NFS，SMB）

现在我们将设置一些远程主机作为 NFS 和 SMB 客户端。我们还将配置一些驱动器以使用 AutoFS 自动连接，这是在之前的用例中安装的。

以下代码安装依赖项，配置客户端，然后启动服务。这本手册适用于 Debian 和 Red Hat Linux 系列：

```yaml
---
- name: Setup and connect network shared folders
  hosts: Linux
  become: yes
  gather_facts: yes
  tasks:
    - name: Install the dependencies to enable NFS and SMB clients on Linux Debian family
      apt:
        name: "{{ item }}"
        state: latest
      with_items:
        - nfs-common
        - rpcbind
        - cifs-utils
        - autofs
      when: ansible_os_family == 'Debian'

    - name: Install the dependencies to enable NFS and SMB clients on Linux Red Hat family
      yum:
        name: "{{ item }}"
        state: latest
      with_items:
        - nfs-common
        - rpcbind
        - cifs-utils
        - nfs-utils
        - nfs-utils-lib
        - autofs
      when: ansible_os_family == 'RedHat'

    - name: Block none authorised NFS servers using rpcbind
      lineinfile:
        path: /etc/hosts.deny
        line: "rpcbind: ALL"
        state: present
        create: yes

    - name: Allow the target NFS servers using rpcbind
      lineinfile:
        path: /etc/hosts.allow
        line: "rpcbind: 192.168.10.20"
        state: present
        create: yes

    - name: Configure NFS share on Fstab
      mount:
        name: nfs shared
        path: /nfs/shared
        src: "192.168.10.20:/media/shared"
        fstype: nfs
        opts: defaults
        state: present

    - name: Create the shared drive directories
      file:
        name: "{{ item }}"
        state: directory
        with_items:
          - "/nfs/shared"
          - "/cifs/winshared"

    - name: Configure NFS share on AutoFS
      lineinfile:
        path: /etc/auto.nfs
        line: "shared -fstype=nfs,rw, 192.168.10.20:/media/shared"
        state: present

    - name: Configure SMB share on AutoFS
      lineinfile:
        path: /etc/auto.cifs
        line: "winshared -fstype=cifs,rw,noperm,credentials=/etc/crd.txt ://192.168.11.20/winshared"
        state: present

    - name: Restart AutoFS service to apply NFS and SMB changes
      systemd:
        name: autofs
        state: restarted
```

### 安装 jdk

```yaml
# cat /etc/ansible/roles/install/jdk/tasks/main.yml
---
- name: copy jdk
  copy:
    src: "{{ jdk_version }}.tar.gz"
    dest: /usr/local/src/

- name: create install dir
  file:
    path: /application
    state: directory

- name: unarchive jdk
  unarchive:
    src: "/usr/local/src/{{ jdk_version }}.tar.gz"
    dest: /application
    remote_src: yes

- name: link jdk
  file:
    src: "/application/jdk1.8.0_131"
    dest: /application/jdk
    state: link

- name: add profile
  lineinfile:
    path: /etc/profile
    line: "{{ item }}"
  with_items:
    - "export JAVA_HOME=/application/jdk"
    - "export PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH"
    - "export CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar"

- name: yum install rngd
  yum: name=rng-tools state=present

- name: started rngd
  service: name=rngd state=started enabled=yes
```

### 重要文档的自动备份

在这个用例中，我们试图构建一个备份解决方案，它不会使用太多的带宽，通过归档需要备份的所有内容。我们基本上将选择一个要压缩并移动到安全主机的文件夹。

以下代码确保安装了所有必要的依赖项，准备备份文件夹，压缩它，然后发送它。我们将使用一个称为同步的模块，它基本上是 rsync 的包装器，这个著名的数据同步工具。它经常用于提供快速备份解决方案：

```yaml
# 可以添加到crontab作业中，以安排定期备份到特定文件夹。
---
- name: Setup and connect network shared folders
  hosts: Linux
  become: yes
  gather_facts: yes
  tasks:
    - name: Install the dependencies to for archiving the backup
      package:
        name: "{{ item }}"
        state: latest
      with_items:
        - zip
        - unzip
        - gunzip
        - gzip
        - bzip2
        - rsync

    - name: Backup the client folder to the vault datastore server
      synchronize:
        mode: push
        src: /home/client1
        dest: client@vault.lab.edu:/media/vault1/client1
        archive: yes
        copy_links: yes
        delete: no
        compress: yes
        recursive: yes
        checksum: yes
        links: yes
        owner: yes
        perms: yes
        times: yes
        set_remote_user: yes
        private_key: /home/admin/users_SSH_Keys/id_rsa
      delegate_to: "{{ inventory_hostname }}"
```

### 部署和卸载 httpd

范例：install_httpd.yml

```yaml
---
#install httpd
- hosts: websrvs
  remote_user: root
  gather_facts: no


tasks:
  - name: Instal1 httpd
    yum: name=httpd
  
  - name: Modify config list port
    lineinfile:
      path: /etc/httpd/conf/httpd.conf
      regexp: '^Listen'
      line: 'Listen 8080'
  
  - name: Modify config data1
    lineinfile:
      path: /etc/httpd/conf/httpd.conf
      regexp: '^DocumentRoot "/var/www/html"'
      line: 'DocumentRoot "/data/html"'

  - name: Modify config data2
    lineinfile:
      path: /etc/httpd/conf/httpd.conf
      regexp: '^<Directory "/var/www/html">'
      line: '<Directory "/data/html">'
  
  - name: Mkdir website dir
    file: path=/data/html state=directory
  
  - name: Web html
    copy: src=files/index.html dest=/data/html/
  
  - name: Start service
    service: name=httpd state=started enabled=yes
```

```sh
# --limit 主机列表
# 只针对主机列表中的特定主机执行
ansible-playbook  install_httpd.yml --limit 10.0.0.8
```

范例：remove_httpd.yml

```yaml
#remove_httpd.yml
---
- hosts: websrvs
  remote_user: root
  gather_facts: no

tasks:
 - name: remove httpd package
   yum: name=httpd state=absent

 - name: remove apache user
   user: name=apache state=absent

 - name: remove config file
   file: name=/etc/httpd state=absent

 - name: remove web html
   file: name=/data/html/ state=absent
```

### 部署 LAMP 服务器

我们将设置一个 LAMP 服务器，基本上是一个 Web 服务器，Apache2；一个内容管理器 PHP；和一个数据库管理器，MySQL 服务器。我们还将添加一些插件和配置，符合最佳实践标准。以下脚本仅适用于 Debian Linux 系列：

```yaml
---
- name: Install a LAMP on Linux hosts
  hosts: webservers
  become: yes
  gather_facts: yes
  tasks:
    - name: Install Lamp packages
      apt:
        name: "{{ item }}"
        state: latest
        update_cache: yes
      with_items:
        - apache2
        - mysql-server
        - php
        - libapache2-mod-php
        - python-mysqldb

    - name: Create the Apache2 web folder
      file:
        dest: "/var/www"
        state: directory
        mode: 0700
        owner: "www-data"
        group: "www-data"

    - name: Setup Apache2 modules
      command: a2enmod {{ item }} creates=/etc/apache2/mods-enabled/{{ item }}.load
      with_items:
        - deflate
        - expires
        - headers
        - macro
        - rewrite
        - ssl

    - name: Setup PHP modules
      apt:
        name: "{{ item }}"
        state: latest
        update_cache: yes
      with_items:
        - php-ssh2
        - php-apcu
        - php-pear
        - php-curl
        - php-gd
        - php-imagick
        - php-mcrypt
        - php-mysql
        - php-json

    - name: Remove MySQL test database
      mysql_db: db=test state=absent login_user=root login_password="DBp@55w0rd"

    - name: Restart mysql server
      service:
        name: mysql
        state: restarted

    - name: Restart Apache2
      service:
        name: apache2
        state: restarted
```

### 部署 MySQL 5.6

范例：安装 mysql-5.6.46-linux-glibc2.12

```shell
[root@ansible ~]#ls -l /data/ansible/files/mysql-5.6.46-linux-glibc2.12-
x86_64.tar.gz
-rw-r--r-- 1 root root 403177622 Dec  4 13:05 /data/ansible/files/mysql-5.6.46-
linux-glibc2.12-x86_64.tar.gz

[root@ansible ~]#cat /data/ansible/files/my.cnf
[mysqld]
socket=/tmp/mysql.sock
user=mysql
symbolic-links=0
datadir=/data/mysql
innodb_file_per_table=1
log-bin
pid-file=/data/mysql/mysqld.pid
[client]
port=3306
socket=/tmp/mysql.sock
[mysqld_safe]
log-error=/var/log/mysqld.log

[root@ansible ~]#cat /data/ansible/files/secure_mysql.sh
#!/bin/bash
/usr/local/mysql/bin/mysql_secure_installation <<EOF
y
magedu
magedu
y
y
y
y
EOF
[root@ansible ~]#tree /data/ansible/files/
/data/ansible/files/
├── my.cnf
├── mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz
└── secure_mysql.sh
0 directories, 3 files
```

/data/ansible/install_mysql.yml

```yaml
---
# install mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz
- hosts: dbsrvs
  remote_user: root
  gather_facts: no


tasks:
  - name: install packages
    yum: name=libaio,perl-Data-Dumper,perl-Getopt-Long
  
  - name: create mysql group
    group: name=mysql gid=306

  - name: create mysql user
    user: name=mysql uid=306 group=mysql shell=/sbin/nologin system=yes create_home=no home=/data/mysql
  
  - name: copy tar to remote host and file mode
    unarchive: src=/data/ansible/files/mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz dest=/usr/local/ owner=root group=root
  
  - name: create linkfile /usr/local/mysql
    file: src=/usr/local/mysql-5.6.46-linux-glibc2.12-x86_64 dest=/usr/local/mysql state=link
  
  - name: data dir
    shell: chdir=/usr/local/mysql/ ./scripts/mysql_install_db --datadir=/data/mysql --user=mysql
    tags: data

  - name: config my.cnf
    copy: src=/data/ansible/files/my.cnf  dest=/etc/my.cnf
  
  - name: service script
    shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld

  - name: enable service
    shell: /etc/init.d/mysqld start;chkconfig --add mysqld;chkconfig mysqld on
    tags: service
  
  - name: PATH variable
    copy: content='PATH=/usr/local/mysql/bin:$PATH' dest=/etc/profile.d/mysql.sh
  
  - name: secure script
  script: /data/ansible/files/secure_mysql.sh
  tags: script
```

### 部署 Mariadb Server

install_mariadb.yml

```yaml
---
#Installing MariaDB Binary Tarballs
- hosts: dbsrvs
  remote_user: root
  gather_facts: no


tasks:
  - name: create group
    group: name=mysql gid=27 system=yes
  
  - name: create user
    user: name=mysql uid=27 system=yes group=mysql shell=/sbin/nologin home=/data/mysql create_home=no

  - name: mkdir datadir
    file: path=/data/mysql owner=mysql group=mysql state=directory
  
  - name: unarchive package
    unarchive: src=/data/ansible/files/mariadb-10.2.27-linux-x86_64.tar.gz dest=/usr/local/ owner=root group=root
  
  - name: link
    file: src=/usr/local/mariadb-10.2.27-linux-x86_64 path=/usr/local/mysql state=link
  
  - name: install database
    shell: chdir=/usr/local/mysql  ./scripts/mysql_install_db --datadir=/data/mysql --user=mysql

  - name: config file
    copy: src=/data/ansible/files/my.cnf  dest=/etc/ backup=yes
  
  - name: service script
    shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld

  - name: start service
    service: name=mysqld state=started enabled=yes
  
  - name: PATH variable
    copy: content='PATH=/usr/local/mysql/bin:$PATH' dest=/etc/profile.d/mysql.sh
```

### 利用 register 注册变量批量部署 MySQL5.7 或 8.0

install_mysql5.7or8.0.yml

```yaml
---
# install mysql-5.7.33-linux-glibc2.12-x86_64.tar.gz
# install mysql-8.0.23-linux-glibc2.12-x86_64.tar.xz
- hosts: dbsrvs
  remote_user: root
  gather_facts: no

vars:
 mysql_version: 5.7.33
 mysql_file: mysql-{{mysql_version}}-linux-glibc2.12-x86_64.tar.gz
 mysql_root_password: Magedu@123

tasks:
  - name: install packages
    yum:
     name:
       - libaio
       - numactl-libs
       - MySQL-python
     state: latest

  - name: create mysql group
    group: name=mysql gid=306

  - name: create mysql user
    user: name=mysql uid=306 group=mysql shell=/sbin/nologin system=yes create_home=no home=/data/mysql

  - name: copy tar to remote host and file mode
    unarchive: src=/data/ansible/files/{{mysql_file}} dest=/usr/local/ owner=root group=root

  - name: create linkfile /usr/local/mysql
    file: src=/usr/local/mysql-{{ mysql_version }}-linux-glibc2.12-x86_64 dest=/usr/local/mysql state=link

  - name: data dir
    shell: /usr/local/mysql/bin/mysqld --initialize --user=mysql --datadir=/data/mysql
    tags: data
  
  - name: config my.cnf
    copy: src=/data/ansible/files/my.cnf  dest=/etc/my.cnf
  
  - name: service script
    shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld

  - name: PATH variable
    copy: content='PATH=/usr/local/mysql/bin:$PATH' dest=/etc/profile.d/mysql.sh
  
  - name: enable service
    shell: chkconfig --add mysqld;/etc/init.d/mysqld start
    tags: service
  
  - name: get password
    shell: awk '/A temporary password/{print $NF}' /data/mysql/mysql.log
    register: password
  
  - name: change password
    # debug:
    # msg: "{{ password.stdout }}"
    shell: /usr/local/mysql/bin/mysqladmin  -uroot -p'{{password.stdout}}' password {{mysql_root_password}}
```

```sh
[root@centos8 ansible]#ansible-playbook install_mysql5.7or8.0.yml
#注意:第一次执行无法修改密码,需要在目标主机上执行下面操作后再一次playbook
[root@centos8 ansible]#ansible dbsrvs -m shell -a "service mysqld stop ;rm -rf /data/mysql/*"
#再次执行成功
[root@centos8 ansible]#ansible-playbook install_mysql5.7or8.0.yml
```

### 变量实现部署 MySQL

```sh
[root@centos8 ~]#grep ^inventory /etc/ansible/ansible.cfg
inventory    = /data/ansible/hosts
[root@centos8 ~]#mkdir -p /data/ansible/files
[root@centos8 ~]#cd /data/ansible
[root@centos8 ansible]#tree
.
├── files
│  ├── my.cnf
│  ├── mysql-5.7.33-linux-glibc2.12-x86_64.tar.gz
│  └── mysql-8.0.23-linux-glibc2.12-x86_64.tar.xz
├── hosts
└── install_mysql5.7or8.0-v2.ym

root@centos8 ansible]#cat /data/ansible/hosts
[dbsrvs]
10.0.0.1[7:8]
[root@centos8 ansible]#cat files/my.cnf
[mysqld]
server-id=1
log-bin
datadir=/data/mysql
socket=/data/mysql/mysql.sock                         
                       
log-error=/data/mysql/mysql.log
pid-file=/data/mysql/mysql.pid
[client]
socket=/data/mysql/mysql.sock
```

install_mysql5.7or8.0-v2.yml

```yaml
---
# install mysql-5.7.33-linux-glibc2.12-x86_64.tar.gz
# install mysql-8.0.23-linux-glibc2.12-x86_64.tar.xz
- hosts: dbsrvs
  remote_user: root
  gather_facts: no

vars:
 mysql_version: 8.0.23
 mysql_file: mysql-{{mysql_version}}-linux-glibc2.12-x86_64.tar.xz
 mysql_root_password: 123456

tasks:
  - name: install packages
    yum:
      name:
        - libaio
        - numactl-libs
      state: latest
  
  - name: create mysql group
    group: name=mysql gid=306
  
  - name: create mysql user
    user: name=mysql uid=306 group=mysql shell=/sbin/nologin system=yes create_home=no home=/data/mysql

  - name: copy tar to remote host and file mode
    unarchive: src=/data/ansible/files/{{mysql_file}} dest=/usr/local/ owner=root group=root

  - name: create linkfile /usr/local/mysql
    file: src=/usr/local/mysql-{{ mysql_version }}-linux-glibc2.12-x86_64 dest=/usr/local/mysql state=link
  
  - name: data dir
    shell: /usr/local/mysql/bin/mysqld --initialize-insecure --user=mysql --datadir=/data/mysql
    tags: data
  
  - name: config my.cnf
    copy: src=/data/ansible/files/my.cnf  dest=/etc/my.cnf
  
  - name: service script
    shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld
  
  - name: PATH variable
    copy: content='PATH=/usr/local/mysql/bin:$PATH' dest=/etc/profile.d/mysql.sh
  
  - name: enable service
    shell: chkconfig --add mysqld;/etc/init.d/mysqld start
    tags: service
  
  - name: change password
    shell: /usr/local/mysql/bin/mysqladmin  -uroot password {{mysql_root_password}}
```

### 编译安装部署 httpd-2.4

install_httpd.yml

```yaml
---
- hosts: websrvs
  remote_user: root

vars:
  download_dir: /usr/local/src
  install_dir: /apps/httpd
  httpd_version: httpd-2.4.46
  apr_version: apr-1.7.0
  apr_util_version: apr-util-1.6.1
  httpd_url: https://mirrors.tuna.tsinghua.edu.cn/apache/httpd
  apr_url: https://mirrors.tuna.tsinghua.edu.cn/apache/apr

tasks:
  - name: install packages
    yum: name=gcc,make,pcre-devel,openssl-devel,expat-devel,bzip2 state=installed
 
  - name: download httpd file
    unarchive: src="{{ httpd_url }}/{{ httpd_version }}.tar.bz2" dest={{download_dir }} owner=root remote_src=yes
 
  - name: download apr file
    unarchive: src="{{ apr_url }}/{{ apr_version }}.tar.bz2" dest={{download_dir }} owner=root remote_src=yes
 
  - name: download apr_util file
    unarchive: src="{{ apr_url }}/{{ apr_util_version }}.tar.bz2" dest={{download_dir }} owner=root remote_src=yes
 
  - name: prepare apr dir
    shell: chdir={{ download_dir }}  mv {{ apr_version }} {{ download_dir }}/{{httpd_version }}/srclib/apr
 
  - name: prepare apr_util dir
    shell: chdir={{ download_dir }}  mv {{ apr_util_version }} {{ download_dir}}/{{ httpd_version }}/srclib/apr-util
 
  - name: build httpd
    shell: |
      chdir={{ download_dir }}/{{ httpd_version }} ./configure --prefix={{install_dir }} --enable-so  --enable-ssl            --enable-cgi  --enable-rewrite  --with-zlib  --with-pcre --with-included-apr  --enable-modules=most  --enable-mpms-shared=all  --with-mpm=prefork &&  make -j {{ ansible_processor_vcpus }} && make install
    args:
      executable: /bin/bash

  - name: create group
    group: name=apache gid=80 system=yes

  - name: create user
    user: name=apache uid=80 group=apache shell=/sbin/nologin system=yes create_home=no home={{ install_dir }}/conf/httpd
 
  - name: set httpd user
    lineinfile: path={{ install_dir }}/conf/httpd.conf regexp='^User' line='User apache'

  - name: set httpd group
    lineinfile: path={{ install_dir }}/conf/httpd.conf regexp='^Group' line='Group apache'

  - name: set variable PATH
    shell: echo PATH={{ install_dir }}/bin:$PATH >> /etc/profile.d/httpd.sh

  - name: prepare service file
    template: src=./httpd.service.j2 dest=/usr/lib/systemd/system/httpd.service

  - name: start service
    service: name=httpd state=started enabled=yes
```

```sh
[root@ansible ansible]#cat httpd.service.j2
[Unit]
Description=The Apache HTTP Server
After=network.target remote-fs.target nss-lookup.target
Documentation=man:httpd(8)
Documentation=man:apachectl(8)
[Service]
Type=forking
#EnvironmentFile=/etc/sysconfig/httpd
ExecStart={{ install_dir }}/bin/apachectl start
#ExecStart={{ install_dir }}/bin/httpd $OPTIONS -k start
ExecReload={{ install_dir }}/bin/apachectl graceful
#ExecReload={{ install_dir }}/bin/httpd $OPTIONS -k graceful
ExecStop={{ install_dir }}/bin/apachectl stop
KillSignal=SIGCONT
PrivateTmp=true
[Install]
WantedBy=multi-user.target


[root@ansible ansible]#ansible-playbook  install_httpd.yml
```

### 部署 MySQL 5.7

```sh
[root@centos8 ansible]#cat files/my.cnf
[mysqld]
server-id=1
log-bin
datadir=/data/mysql
socket=/data/mysql/mysql.sock                         
                       
log-error=/data/mysql/mysql.log
pid-file=/data/mysql/mysql.pid
[client]
socket=/data/mysql/mysql.sock
```

mysql_install.yml

```yaml
---
- hosts: dbsrvs

vars:
 password: 123456

tasks:
  - name: download mysql-package
    get_url:
      url: http://mirrors.163.com/mysql/Downloads/MySQL-5.7/mysql-5.7.31-linux-glibc2.12-x86_64.tar.gz
      dest: /usr/local/mysql-5.7.31-linux-glibc2.12-x86_64.tar.gz
      force: yes
 
  - name: tar mysql-package
    unarchive:
      src: /usr/local/mysql-5.7.31-linux-glibc2.12-x86_64.tar.gz
      dest: /usr/local
      owner: root
      group: root
      mode: 0755
      copy: no
  
  - name: create linkfile /usr/local/mysql
    file:
      src: /usr/local/mysql-5.7.31-linux-glibc2.12-x86_64
      dest: /usr/local/mysql
      state: link

  - name: create bin link
    shell: "ln -s /usr/local/mysql/bin/* /usr/bin/"
    ignore_errors: yes

  - name: copy my.cnf
    copy:
      src: files/my.cnf
      dest: /etc/my.cnf

  - name: install packages
    yum:
      name: libaio,perl-Data-Dumper,perl-Getopt-Long
      state: present
 
  - name: create mysql group
    group:
      name: mysql
      gid: 306
  
  - name: create mysql user
    user:
      name: mysql
      uid: 306
      group: mysql
      shell: /sbin/nologin
      system: yes
  
  - name: crate work directory
    file:
      path: /data/mysql
      state: directory
      mode: 0755
      owner: mysql
      group: mysql

  - name: Initialization mysql
    shell: "mysqld --initialize --user=mysql --datadir=/data/mysql"
    ignore_errors: yes
  
  - name: serivce script
    shell: "/bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld;chkconfig --add mysqld;chkconfig mysqld on"
  
  - name: start service
    service:
      name: mysqld
      state: started
      enabled: yes

  - name: set root password
    shell: "mysqladmin -uroot -p\"`awk '/A temporary password/ {print $NF}' /data/mysql/mysql.log`\" password {{ password }}"
    register: error
    ignore_errors: yes
  
  - name: retry set new password
    shell: "mysqladmin -uroot -p'{{ password }}' password {{ password }}"
    when: error.failed
```

### 利用 shell 脚本部署 MySQL

```sh
[root@centos8 ansible]# mkdir files

[root@centos8 ansible]# ls files/
mysql-5.7.33-linux-glibc2.12-x86_64.tar.gz

[root@centos8 ansible]# vim files/my.cnf
[mysqld]
server-id=1
log-bin
datadir=/data/mysql
socket=/data/mysql/mysql.sock                         
                       
log-error=/data/mysql/mysql.log
pid-file=/data/mysql/mysql.pid
[client]
socket=/data/mysql/mysql.sock

[root@centos8 ansible]# vim vars.yml
---
# variables file
mysql_version: 5.7.33

[root@centos8 ansible]# cat files/set_password.sh
#!/bin/bash
MYSQL_ROOT_PASSWORD=123456
MYSQL_OLDPASSWORD=`awk '/A temporary password/{print $NF}'
/data/mysql/mysql.log`
mysqladmin  -uroot -p$MYSQL_OLDPASSWORD password $MYSQL_ROOT_PASSWORD &>/dev/null
```

install_mysql5.7.yml

```yaml
---
# install mysql-5.7.33-linux-glibc2.12-x86_64.tar.gz
- hosts: dbsrvs
  remote_user: root
  gather_facts: yes


vars_files:
  - vars.yml

tasks:
  - name: install packages for centos7
    yum: name=libaio,perl-Data-Dumper
    when: ansible_facts['distribution_major_version'] == "7"
  
  - name: install packages for centos8
    yum: name=libaio,perl-Data-Dumper,ncurses-compat-libs
    when: ansible_facts['distribution_major_version'] == "8"
  
  - name: cteate mysql group
    group: name=mysql gid=306
  
  - name: create mysql user
    user: name=mysql uid=306 group=mysql shell=/sbin/nologin system=yes create_home=no home=/data/mysql
  
  - name: copy tar to remote host and file mode
    unarchive: src=/data/ansible/files/mysql-{{mysql_version}}-linux-glibc2.12-x86_64.tar.gz dest=/usr/local/ owner=root group=root
  
  - name: create linkfile /usr/local/mysql
    file: src=/usr/local/mysql-{{mysql_version}}-linux-glibc2.12-x86_64 dest=/usr/local/mysql state=link
  
  - name: PATH variable
    copy: content='PATH=/usr/local/mysql/bin:$PATH' dest=/etc/profile.d/mysql.sh
  
  - name: PATH variable entry
    shell: . /etc/profile.d/mysql.sh
  
  - name: config my.cnf
    copy: src=/data/ansible/files/my.cnf dest=/etc/my.cnf
  
  - name: data dir
    shell: chdir=/usr/local/mysql ./bin/mysqld --initialize --user=mysql --datadir=/data/mysql
  
  - name: service script
    shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld
  
  - name: enable service
    shell: /etc/init.d/mysqld start;chkconfig --add mysqld;chkconfig mysqld on
    tags: service
  
  - name: set mysql user password
    script: /data/ansible/files/set_password.sh
    tags: script
```

```sh
[root@centos8 ansible]# tree
.
├── files
│  ├── my.cnf
│  ├── mysql-5.7.33-linux-glibc2.12-x86_64.tar.gz
│  └── set_password.sh
├── install_mysql5.7.yml
└── vars.yml
1 directory, 5 files
[root@centos8 ansible]# ansible-playbook install_mysql5.7.yml
```

### 安装 docker

```sh
[root@centos8 ansible]# vim /etc/ansible/hosts
[ubuntu]
10.0.0.100
10.0.0.200

[root@centos8 ansible]# vim vars.yml
docker_version: 5:19.03.15~3-0~ubuntu-
ubuntu1804: bionic
ubuntu2004: focal

[root@centos8 ansible]# vim files/daemon.json
{ 
  "registry-mirrors": ["https://si7y70hh.mirror.aliyuncs.com"]                    
}
```

install_docker.yml

```yaml
---
#install docker
- hosts: ubuntu
  remote_user: root

vars_files:
  - vars.yml

tasks:
  - name: install packages
    apt: name=apt-transport-https,ca-certificates,curl,software-properties-common state=present

  - name: import key
    shell: curl -fsSL https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu/gpg | sudo apt-key add -

  - name: import installation source on ubuntu1804
    shell: add-apt-repository  "deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu {{ubuntu1804}} stable"
    when:
      - ansible_facts['distribution_major_version'] == "18"

  - name: import installation source on ubuntu2004
    shell: add-apt-repository  "deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu {{ubuntu2004}} stable"
    when:
      - ansible_facts['distribution_major_version'] == "20"

  - name: install docker for ubuntu1804
    apt: name=docker-ce={{docker_version}}{{ubuntu1804}},docker-ce-cli={{docker_version}}{{ubuntu1804}}
    when:
      - ansible_facts['distribution_major_version'] == "18"

  - name: install docker for ubuntu2004
    apt: name=docker-ce={{docker_version}}{{ubuntu2004}},docker-ce-cli={{docker_version}}{{ubuntu2004}}
    when:
      - ansible_facts['distribution_major_version'] == "20"

  - name: mkdir /etc/docker
    file: path=/etc/docker state=directory
  
  - name: aliyun Mirror acceleration
    copy: src=/data/ansible/files/daemon.json dest=/etc/docker/
  
  - name: load daemon
    shell: systemctl daemon-reload
  
  - name: start docker
    service: name=docker state=started enabled=yes
```

```sh
[root@centos8 ansible]# ansible-playbook install_docker.yml
#验证安装是否成功
[root@centos8 ansible]# ansible ubuntu -a "docker version"
```

### 安装 docker harbor

```sh
[root@centos8 ansible]# vim vars.yml
docker_version: 5:19.03.15~3-0~ubuntu-
ubuntu1804: bionic
ubuntu2004: focal
docker_compose_version: 1.27.4
harbor_version: 1.7.6

[root@centos8 ansible]# vim files/harbor.sh
#!/bin/bash
IPADDR=`hostname -I|awk '{print $1}'`
HARBOR_ADMIN_PASSWORD=123456
sed -i.bak -e 's/^hostname =.*/hostname = '$IPADDR'/' -e
's/^harbor_admin_password =.*/harbor_admin_password = '$HARBOR_ADMIN_PASSWORD'/'
/apps/harbor/harbor.cfg

[root@centos8 files]# vim files/harbor.service
[Unit]
Description=Harbor
After=docker.service systemd-networkd.service systemd-resolved.service
Requires=docker.service
Documentation=http://github.com/vmware/harbor
[Service]
Type=simple
Restart=on-failure
RestartSec=5
ExecStart=/usr/bin/docker-compose -f /apps/harbor/docker-compose.yml up
ExecStop=/usr/bin/docker-compose -f /apps/harbor/docker-compose.yml down
[Install]
WantedBy=multi-user.target

[root@centos8 ansible]# vim files/daemon.json
{
 "registry-mirrors": ["https://si7y70hh.mirror.aliyuncs.com"]         
             
}
                         
[root@centos8 ansible]# ls files/
daemon.json docker-compose-Linux-x86_64-1.27.4 harbor-offline-installer-
v1.7.6.tgz harbor.service harbor.sh
```

install_docker_harbor.yml

```yaml
---
#install docker harbor
- hosts: ubuntu
  remote_user: root

vars_files:
  - vars.yml

tasks:
  - name: install packages
    apt: name=apt-transport-https,ca-certificates,curl,software-properties-common state=present
  
  - name: import key
    shell: curl -fsSL https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu/gpg | sudo apt-key add -
  
  - name: import installation source on ubuntu1804
    shell: add-apt-repository  "deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu {{ubuntu1804}} stable"
    when:
      - ansible_facts['distribution_major_version'] == "18"
  
  - name: import installation source on ubuntu2004
    shell: add-apt-repository  "deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu {{ubuntu2004}} stable"
    when:
      - ansible_facts['distribution_major_version'] == "20"
  
  - name: install docker for ubuntu1804
    apt: name=docker-ce={{docker_version}}{{ubuntu1804}},docker-ce-cli={{docker_version}}{{ubuntu1804}}
    when:
      - ansible_facts['distribution_major_version'] == "18"
  
  - name: install docker for ubuntu2004
    apt: name=docker-ce={{docker_version}}{{ubuntu2004}},docker-ce-cli={{docker_version}}{{ubuntu2004}}
    when:
      - ansible_facts['distribution_major_version'] == "20"
  
  - name: mkdir /etc/docker
    file: path=/etc/docker state=directory
  
  - name: aliyun Mirror acceleration
    copy: src=/data/ansible/files/daemon.json dest=/etc/docker/
  
  - name: load daemon
    shell: systemctl daemon-reload
  
  - name: start docker
    service: name=docker state=started enabled=yes
  
  - name: install compose
    copy: src=/data/ansible/files/docker-compose-Linux-x86_64-{{docker_compose_version}} dest=/usr/bin/docker-compose
  
  - name: set excute permission
    file: path=/usr/bin/docker-compose mode=755
  
  - name: mkdir /apps
    file: path=/apps state=directory
  
  - name: unarchive harbor package
    unarchive: src=/data/ansible/files/harbor-offline-installer-v{{harbor_version}}.tgz dest=/apps/
  
  - name: set harbor.cfg
    script: /data/ansible/files/harbor.sh
  
  - name: install python
    apt: name=python
  
  - name: install harbor
    shell: /apps/harbor/install.sh
  
  - name: copy harbor.service
    copy: src=/data/ansible/files/harbor.service dest=/lib/systemd/system/
  
  - name: service enable
    shell: systemctl daemon-reload;systemctl enable harbor
```

## VMware 自动化

### 从模板创建虚拟机

这个用例展示了如何从预定义模板创建虚拟机。之后，我们确保所有虚拟机都已根据正确的参数添加到清单中：

```yaml
---
- name: Create a virtual machine from a template
  hosts: localhost
  gather_facts: False
  tasks:
    - name: Create a virtual machine
       vmware_guest:
          hostname: 'vcenter.edu.lab'
          username: 'vmadmin@lab.edu'
          password: 'VMp@55w0rd'
          datecenter: 'vcenter.edu.lab'
          validate_certs: no
          esxi_hostname: 'esxi1.lab.edu'
          template: ubuntu1404Temp
          folder: '/DeployedVMs'
          name: '{{ item.hostname }}'
          state: poweredon
          disk:
            - size_gb: 50
               type: thin
               datastore: 'datastore1'
          networks:
            - name: 'LabNetwork'
                ip: '{{ item.ip }}'
                netmask: '255.255.255.0'
                gateway: '192.168.13.1'
                dns_servers:
                  - '8.8.8.8'
                  - '8.8.4.4'
          hardware:
              memory_mb: '1024'
              num_cpus: '2'
          wait_for_ip_address: yes
        delegate_to: localhost
        with_items:
            - { hostname: vm1, ip: 192.168.13.10 }
            - { hostname: vm2, ip: 192.168.13.11 }
            - { hostname: vm3, ip: 192.168.13.12 }

    - name: add newly created VMs to the Ansible inventory
        add_host:
          hostname: "{{ item.hostname }}"
          ansible_host: "{{ item.ip }}"
          ansible_ssh_user: setup
          ansible_ssh_pass: "L1nuxP@55w0rd"
          ansible_connection: ssh
          groupname: Linux
        with_items:
          - { hostname: vm1, ip: 192.168.13.10 }
          - { hostname: vm2, ip: 192.168.13.11 }
          - { hostname: vm3, ip: 192.168.13.12 }
```

此 playbook 中的项目可以通过使用预定义变量进行更改。

### ESXi 主机和集群管理

我们现在将尝试进行一些更高级的基础设施管理。我们将尝试创建一个 VMware 集群并将一个 ESXi 主机添加到其中：

```yaml
---
- name: Create a VMware cluster and populate it
  hosts: localhost
  gather_facts: False
  tasks:
    - name: Create a VMware virtual cluster
      vmware_cluster:
        hostname: "vcenter.edu.lab"
        username: "vmadmin@lab.edu"
        password: "VMp@55w0rd"
        datecenter: "vcenter.edu.lab"
        validate_certs: no
        cluster_name: "LabCluster"
        state: present
        enable_ha: yes
        enable_drs: yes
        enable_vsan: no

    - name: Add a VMware ESXi host to the newly created Cluster
      vmware_host:
        hostname: "vcenter.edu.lab"
        username: "vmadmin@lab.edu"
        password: "VMp@55w0rd"
        datecenter: "vcenter.edu.lab"
        validate_certs: no
        cluster_name: " LabCluster "
        esxi_hostname: "esxi1.lab.edu"
        esxi_username: "root"
        esxi_password: "E5X1P@55w0rd"
        state: present
```

这些 playbook 可以替代用于管理 VCenter 的 PowerCLI 命令，也可以替代手动访问 Windows 客户端或 Web 界面来管理主机和集群的过程。
