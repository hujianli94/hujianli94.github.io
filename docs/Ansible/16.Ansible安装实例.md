# 16.Ansible 安装实例

## Playbook 案例

### 利用 Playbook 实现 Redis 服务端

redis_server.yml

```yaml
- hosts: dbservers

tasks:
  - name: Installed Redis Server
    yum:
      name: redis
      state: present
  
  - name: Configure Redis Server
    copy:
      src: ./files/redis.conf.j2
      dest: /etc/redis.conf
      owner: redis
      group: root
      mode: 0640
      notify: Restart Redis Server
  
  - name: Systemd Redis Server
    systemd:
      name: redis
      state: started
      enabled: yes

handlers:
  - name: Restart Redis Server
    systemd:
      name: redis
      state: restarted
```

### 利用 playbook 创建 mysql 用户

范例：mysql_user.yml

```yaml
---
- hosts: dbsrvs
  remote_user: root
  gather_facts: no

tasks:
  - name: create group
    group: name=mysql system=yes gid=306

  - name: create user
    user: name=mysql shell=/sbin/nologin system=yes group=mysql uid=306 home=/data/mysql create_home=no
```

### 利用 Playbook 实现 NFS 服务端

```sh
[root@ansbile playbook]# cat ./exports.j2
/nfs_test 10.0.0.0/24(rw,all_squash,anonuid=666,anongid=666)
```

install_nfs_server.yml

```yaml
---
- hosts: webservers

tasks:
  - name: 1.Installed NFS Server
    yum:
      name: nfs-utils
      state: present
 
  - name: 2.Configure NFS Server
    copy:
      src: ./exports.j2
      dest: /etc/exports
      notify: Restart NFS Server

  - name: 3.Init Group
    group:
      name: www
      gid: 666
 
  - name: 4.Init User
    user:
      name: www
      uid: 666
      group: www
      shell: /sbin/nologin
      create_home: no
   
  - name: 5.Init Create Directory
    file:
     path: /nfs_test
     state: directory
     owner: www
     group: www
     mode: "0755"
 
  - name: 6.Started NFS Server
    systemd:
     name: nfs
     state: started
     enabled: yes

handlers:
 - name: Restart NFS Server
   systemd:
     name: nfs
     state: restarted
```

### 利用 playbook 安装 nginx

范例：install_nginx.yml

```yaml
---
# install nginx
- hosts: websrvs
  remote_user: root
  gather_facts: no

tasks:
  - name: add group nginx
    group: name=nginx state=present

  - name: add user nginx
    user: name=nginx state=present group=nginx

  - name: Install Nginx
    yum: name=nginx state=present

  - name: web page
    copy: src=files/index.html dest=/usr/share/nginx/html/index.html

  - name: Start Nginx
    service: name=nginx state=started enabled=yes
```

### 利用 playbook 安装和卸载 httpd

范例：install_httpd.yml

```yaml
---
#install httpd
- hosts: websrvs
  remote_user: root
  gather_facts: no


tasks:
  - name: Instal1 httpd
    yum: name=httpd
  
  - name: Modify config list port
    lineinfile:
      path: /etc/httpd/conf/httpd.conf
      regexp: '^Listen'
      line: 'Listen 8080'
  
  - name: Modify config data1
    lineinfile:
      path: /etc/httpd/conf/httpd.conf
      regexp: '^DocumentRoot "/var/www/html"'
      line: 'DocumentRoot "/data/html"'

  - name: Modify config data2
    lineinfile:
      path: /etc/httpd/conf/httpd.conf
      regexp: '^<Directory "/var/www/html">'
      line: '<Directory "/data/html">'
  
  - name: Mkdir website dir
    file: path=/data/html state=directory
  
  - name: Web html
    copy: src=files/index.html dest=/data/html/
  
  - name: Start service
    service: name=httpd state=started enabled=yes
```

```sh
# --limit 主机列表
# 只针对主机列表中的特定主机执行
ansible-playbook  install_httpd.yml --limit 10.0.0.8
```

范例：remove_httpd.yml

```yaml
#remove_httpd.yml
---
- hosts: websrvs
  remote_user: root
  gather_facts: no

tasks:
 - name: remove httpd package
   yum: name=httpd state=absent

 - name: remove apache user
   user: name=apache state=absent

 - name: remove config file
   file: name=/etc/httpd state=absent

 - name: remove web html
   file: name=/data/html/ state=absent
```

### 利用 playbook 安装 MySQL 5.6

范例：安装 mysql-5.6.46-linux-glibc2.12

```shell
[root@ansible ~]#ls -l /data/ansible/files/mysql-5.6.46-linux-glibc2.12-
x86_64.tar.gz
-rw-r--r-- 1 root root 403177622 Dec  4 13:05 /data/ansible/files/mysql-5.6.46-
linux-glibc2.12-x86_64.tar.gz

[root@ansible ~]#cat /data/ansible/files/my.cnf
[mysqld]
socket=/tmp/mysql.sock
user=mysql
symbolic-links=0
datadir=/data/mysql
innodb_file_per_table=1
log-bin
pid-file=/data/mysql/mysqld.pid
[client]
port=3306
socket=/tmp/mysql.sock
[mysqld_safe]
log-error=/var/log/mysqld.log

[root@ansible ~]#cat /data/ansible/files/secure_mysql.sh
#!/bin/bash
/usr/local/mysql/bin/mysql_secure_installation <<EOF
y
magedu
magedu
y
y
y
y
EOF
[root@ansible ~]#tree /data/ansible/files/
/data/ansible/files/
├── my.cnf
├── mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz
└── secure_mysql.sh
0 directories, 3 files
```

/data/ansible/install_mysql.yml

```yaml
---
# install mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz
- hosts: dbsrvs
  remote_user: root
  gather_facts: no


tasks:
  - name: install packages
    yum: name=libaio,perl-Data-Dumper,perl-Getopt-Long
  
  - name: create mysql group
    group: name=mysql gid=306

  - name: create mysql user
    user: name=mysql uid=306 group=mysql shell=/sbin/nologin system=yes create_home=no home=/data/mysql
  
  - name: copy tar to remote host and file mode
    unarchive: src=/data/ansible/files/mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz dest=/usr/local/ owner=root group=root
  
  - name: create linkfile /usr/local/mysql
    file: src=/usr/local/mysql-5.6.46-linux-glibc2.12-x86_64 dest=/usr/local/mysql state=link
  
  - name: data dir
    shell: chdir=/usr/local/mysql/ ./scripts/mysql_install_db --datadir=/data/mysql --user=mysql
    tags: data

  - name: config my.cnf
    copy: src=/data/ansible/files/my.cnf  dest=/etc/my.cnf
  
  - name: service script
    shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld

  - name: enable service
    shell: /etc/init.d/mysqld start;chkconfig --add mysqld;chkconfig mysqld on
    tags: service
  
  - name: PATH variable
    copy: content='PATH=/usr/local/mysql/bin:$PATH' dest=/etc/profile.d/mysql.sh
  
  - name: secure script
  script: /data/ansible/files/secure_mysql.sh
  tags: script
```

### 利用 playbook 安装 Mariadb Server

install_mariadb.yml

```yaml
---
#Installing MariaDB Binary Tarballs
- hosts: dbsrvs
  remote_user: root
  gather_facts: no


tasks:
  - name: create group
    group: name=mysql gid=27 system=yes
  
  - name: create user
    user: name=mysql uid=27 system=yes group=mysql shell=/sbin/nologin home=/data/mysql create_home=no

  - name: mkdir datadir
    file: path=/data/mysql owner=mysql group=mysql state=directory
  
  - name: unarchive package
    unarchive: src=/data/ansible/files/mariadb-10.2.27-linux-x86_64.tar.gz dest=/usr/local/ owner=root group=root
  
  - name: link
    file: src=/usr/local/mariadb-10.2.27-linux-x86_64 path=/usr/local/mysql state=link
  
  - name: install database
    shell: chdir=/usr/local/mysql  ./scripts/mysql_install_db --datadir=/data/mysql --user=mysql

  - name: config file
    copy: src=/data/ansible/files/my.cnf  dest=/etc/ backup=yes
  
  - name: service script
    shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld

  - name: start service
    service: name=mysqld state=started enabled=yes
  
  - name: PATH variable
    copy: content='PATH=/usr/local/mysql/bin:$PATH' dest=/etc/profile.d/mysql.sh
```

### 利用 register 注册变量批量部署 MySQL5.7 或 8.0

install_mysql5.7or8.0.yml

```yaml
---
# install mysql-5.7.33-linux-glibc2.12-x86_64.tar.gz
# install mysql-8.0.23-linux-glibc2.12-x86_64.tar.xz
- hosts: dbsrvs
  remote_user: root
  gather_facts: no

vars:
 mysql_version: 5.7.33
 mysql_file: mysql-{{mysql_version}}-linux-glibc2.12-x86_64.tar.gz
 mysql_root_password: Magedu@123

tasks:
  - name: install packages
    yum:
     name:
       - libaio
       - numactl-libs
       - MySQL-python
     state: latest

  - name: create mysql group
    group: name=mysql gid=306

  - name: create mysql user
    user: name=mysql uid=306 group=mysql shell=/sbin/nologin system=yes create_home=no home=/data/mysql

  - name: copy tar to remote host and file mode
    unarchive: src=/data/ansible/files/{{mysql_file}} dest=/usr/local/ owner=root group=root

  - name: create linkfile /usr/local/mysql
    file: src=/usr/local/mysql-{{ mysql_version }}-linux-glibc2.12-x86_64 dest=/usr/local/mysql state=link

  - name: data dir
    shell: /usr/local/mysql/bin/mysqld --initialize --user=mysql --datadir=/data/mysql
    tags: data
  
  - name: config my.cnf
    copy: src=/data/ansible/files/my.cnf  dest=/etc/my.cnf
  
  - name: service script
    shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld

  - name: PATH variable
    copy: content='PATH=/usr/local/mysql/bin:$PATH' dest=/etc/profile.d/mysql.sh
  
  - name: enable service
    shell: chkconfig --add mysqld;/etc/init.d/mysqld start
    tags: service
  
  - name: get password
    shell: awk '/A temporary password/{print $NF}' /data/mysql/mysql.log
    register: password
  
  - name: change password
    # debug:
    # msg: "{{ password.stdout }}"
    shell: /usr/local/mysql/bin/mysqladmin  -uroot -p'{{password.stdout}}' password {{mysql_root_password}}
```

```sh
[root@centos8 ansible]#ansible-playbook install_mysql5.7or8.0.yml
#注意:第一次执行无法修改密码,需要在目标主机上执行下面操作后再一次playbook
[root@centos8 ansible]#ansible dbsrvs -m shell -a "service mysqld stop ;rm -rf /data/mysql/*"
#再次执行成功
[root@centos8 ansible]#ansible-playbook install_mysql5.7or8.0.yml
```

### 变量实现部署 MySQL

```sh
[root@centos8 ~]#grep ^inventory /etc/ansible/ansible.cfg
inventory    = /data/ansible/hosts
[root@centos8 ~]#mkdir -p /data/ansible/files
[root@centos8 ~]#cd /data/ansible
[root@centos8 ansible]#tree
.
├── files
│  ├── my.cnf
│  ├── mysql-5.7.33-linux-glibc2.12-x86_64.tar.gz
│  └── mysql-8.0.23-linux-glibc2.12-x86_64.tar.xz
├── hosts
└── install_mysql5.7or8.0-v2.ym

root@centos8 ansible]#cat /data/ansible/hosts
[dbsrvs]
10.0.0.1[7:8]
[root@centos8 ansible]#cat files/my.cnf
[mysqld]
server-id=1
log-bin
datadir=/data/mysql
socket=/data/mysql/mysql.sock                         
                       
log-error=/data/mysql/mysql.log
pid-file=/data/mysql/mysql.pid
[client]
socket=/data/mysql/mysql.sock
```

install_mysql5.7or8.0-v2.yml

```yaml
---
# install mysql-5.7.33-linux-glibc2.12-x86_64.tar.gz
# install mysql-8.0.23-linux-glibc2.12-x86_64.tar.xz
- hosts: dbsrvs
  remote_user: root
  gather_facts: no

vars:
 mysql_version: 8.0.23
 mysql_file: mysql-{{mysql_version}}-linux-glibc2.12-x86_64.tar.xz
 mysql_root_password: 123456

tasks:
  - name: install packages
    yum:
      name:
        - libaio
        - numactl-libs
      state: latest
  
  - name: create mysql group
    group: name=mysql gid=306
  
  - name: create mysql user
    user: name=mysql uid=306 group=mysql shell=/sbin/nologin system=yes create_home=no home=/data/mysql

  - name: copy tar to remote host and file mode
    unarchive: src=/data/ansible/files/{{mysql_file}} dest=/usr/local/ owner=root group=root

  - name: create linkfile /usr/local/mysql
    file: src=/usr/local/mysql-{{ mysql_version }}-linux-glibc2.12-x86_64 dest=/usr/local/mysql state=link
  
  - name: data dir
    shell: /usr/local/mysql/bin/mysqld --initialize-insecure --user=mysql --datadir=/data/mysql
    tags: data
  
  - name: config my.cnf
    copy: src=/data/ansible/files/my.cnf  dest=/etc/my.cnf
  
  - name: service script
    shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld
  
  - name: PATH variable
    copy: content='PATH=/usr/local/mysql/bin:$PATH' dest=/etc/profile.d/mysql.sh
  
  - name: enable service
    shell: chkconfig --add mysqld;/etc/init.d/mysqld start
    tags: service
  
  - name: change password
    shell: /usr/local/mysql/bin/mysqladmin  -uroot password {{mysql_root_password}}
```

### 部署 MySQL 5.7

```sh
[root@centos8 ansible]#cat files/my.cnf
[mysqld]
server-id=1
log-bin
datadir=/data/mysql
socket=/data/mysql/mysql.sock                         
                       
log-error=/data/mysql/mysql.log
pid-file=/data/mysql/mysql.pid
[client]
socket=/data/mysql/mysql.sock
```

mysql_install.yml

```yaml
---
- hosts: dbsrvs

vars:
 password: 123456

tasks:
  - name: download mysql-package
    get_url:
      url: http://mirrors.163.com/mysql/Downloads/MySQL-5.7/mysql-5.7.31-linux-glibc2.12-x86_64.tar.gz
      dest: /usr/local/mysql-5.7.31-linux-glibc2.12-x86_64.tar.gz
      force: yes
 
  - name: tar mysql-package
    unarchive:
      src: /usr/local/mysql-5.7.31-linux-glibc2.12-x86_64.tar.gz
      dest: /usr/local
      owner: root
      group: root
      mode: 0755
      copy: no
  
  - name: create linkfile /usr/local/mysql
    file:
      src: /usr/local/mysql-5.7.31-linux-glibc2.12-x86_64
      dest: /usr/local/mysql
      state: link

  - name: create bin link
    shell: "ln -s /usr/local/mysql/bin/* /usr/bin/"
    ignore_errors: yes

  - name: copy my.cnf
    copy:
      src: files/my.cnf
      dest: /etc/my.cnf

  - name: install packages
    yum:
      name: libaio,perl-Data-Dumper,perl-Getopt-Long
      state: present
 
  - name: create mysql group
    group:
      name: mysql
      gid: 306
  
  - name: create mysql user
    user:
      name: mysql
      uid: 306
      group: mysql
      shell: /sbin/nologin
      system: yes
  
  - name: crate work directory
    file:
      path: /data/mysql
      state: directory
      mode: 0755
      owner: mysql
      group: mysql

  - name: Initialization mysql
    shell: "mysqld --initialize --user=mysql --datadir=/data/mysql"
    ignore_errors: yes
  
  - name: serivce script
    shell: "/bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld;chkconfig --add mysqld;chkconfig mysqld on"
  
  - name: start service
    service:
      name: mysqld
      state: started
      enabled: yes

  - name: set root password
    shell: "mysqladmin -uroot -p\"`awk '/A temporary password/ {print $NF}' /data/mysql/mysql.log`\" password {{ password }}"
    register: error
    ignore_errors: yes
  
  - name: retry set new password
    shell: "mysqladmin -uroot -p'{{ password }}' password {{ password }}"
    when: error.failed
```

### 利用 Playbook 安装 docker

```sh
[root@centos8 ansible]# vim /etc/ansible/hosts
[ubuntu]
10.0.0.100
10.0.0.200

[root@centos8 ansible]# vim vars.yml
docker_version: 5:19.03.15~3-0~ubuntu-
ubuntu1804: bionic
ubuntu2004: focal

[root@centos8 ansible]# vim files/daemon.json
{ 
  "registry-mirrors": ["https://si7y70hh.mirror.aliyuncs.com"]                    
}
```

install_docker.yml

```yaml
---
#install docker
- hosts: ubuntu
  remote_user: root

vars_files:
  - vars.yml

tasks:
  - name: install packages
    apt: name=apt-transport-https,ca-certificates,curl,software-properties-common state=present

  - name: import key
    shell: curl -fsSL https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu/gpg | sudo apt-key add -

  - name: import installation source on ubuntu1804
    shell: add-apt-repository  "deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu {{ubuntu1804}} stable"
    when:
      - ansible_facts['distribution_major_version'] == "18"

  - name: import installation source on ubuntu2004
    shell: add-apt-repository  "deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu {{ubuntu2004}} stable"
    when:
      - ansible_facts['distribution_major_version'] == "20"

  - name: install docker for ubuntu1804
    apt: name=docker-ce={{docker_version}}{{ubuntu1804}},docker-ce-cli={{docker_version}}{{ubuntu1804}}
    when:
      - ansible_facts['distribution_major_version'] == "18"

  - name: install docker for ubuntu2004
    apt: name=docker-ce={{docker_version}}{{ubuntu2004}},docker-ce-cli={{docker_version}}{{ubuntu2004}}
    when:
      - ansible_facts['distribution_major_version'] == "20"

  - name: mkdir /etc/docker
    file: path=/etc/docker state=directory
  
  - name: aliyun Mirror acceleration
    copy: src=/data/ansible/files/daemon.json dest=/etc/docker/
  
  - name: load daemon
    shell: systemctl daemon-reload
  
  - name: start docker
    service: name=docker state=started enabled=yes
```

```sh
[root@centos8 ansible]# ansible-playbook install_docker.yml
#验证安装是否成功
[root@centos8 ansible]# ansible ubuntu -a "docker version"
```

### 利用 Playbook 安装 docker harbor

```sh
[root@centos8 ansible]# vim vars.yml
docker_version: 5:19.03.15~3-0~ubuntu-
ubuntu1804: bionic
ubuntu2004: focal
docker_compose_version: 1.27.4
harbor_version: 1.7.6

[root@centos8 ansible]# vim files/harbor.sh
#!/bin/bash
IPADDR=`hostname -I|awk '{print $1}'`
HARBOR_ADMIN_PASSWORD=123456
sed -i.bak -e 's/^hostname =.*/hostname = '$IPADDR'/' -e
's/^harbor_admin_password =.*/harbor_admin_password = '$HARBOR_ADMIN_PASSWORD'/'
/apps/harbor/harbor.cfg

[root@centos8 files]# vim files/harbor.service
[Unit]
Description=Harbor
After=docker.service systemd-networkd.service systemd-resolved.service
Requires=docker.service
Documentation=http://github.com/vmware/harbor
[Service]
Type=simple
Restart=on-failure
RestartSec=5
ExecStart=/usr/bin/docker-compose -f /apps/harbor/docker-compose.yml up
ExecStop=/usr/bin/docker-compose -f /apps/harbor/docker-compose.yml down
[Install]
WantedBy=multi-user.target

[root@centos8 ansible]# vim files/daemon.json
{
 "registry-mirrors": ["https://si7y70hh.mirror.aliyuncs.com"]         
             
}
                         
[root@centos8 ansible]# ls files/
daemon.json docker-compose-Linux-x86_64-1.27.4 harbor-offline-installer-
v1.7.6.tgz harbor.service harbor.sh
```

install_docker_harbor.yml

```yaml
---
#install docker harbor
- hosts: ubuntu
  remote_user: root

vars_files:
  - vars.yml

tasks:
  - name: install packages
    apt: name=apt-transport-https,ca-certificates,curl,software-properties-common state=present
  
  - name: import key
    shell: curl -fsSL https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu/gpg | sudo apt-key add -
  
  - name: import installation source on ubuntu1804
    shell: add-apt-repository  "deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu {{ubuntu1804}} stable"
    when:
      - ansible_facts['distribution_major_version'] == "18"
  
  - name: import installation source on ubuntu2004
    shell: add-apt-repository  "deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu {{ubuntu2004}} stable"
    when:
      - ansible_facts['distribution_major_version'] == "20"
  
  - name: install docker for ubuntu1804
    apt: name=docker-ce={{docker_version}}{{ubuntu1804}},docker-ce-cli={{docker_version}}{{ubuntu1804}}
    when:
      - ansible_facts['distribution_major_version'] == "18"
  
  - name: install docker for ubuntu2004
    apt: name=docker-ce={{docker_version}}{{ubuntu2004}},docker-ce-cli={{docker_version}}{{ubuntu2004}}
    when:
      - ansible_facts['distribution_major_version'] == "20"
  
  - name: mkdir /etc/docker
    file: path=/etc/docker state=directory
  
  - name: aliyun Mirror acceleration
    copy: src=/data/ansible/files/daemon.json dest=/etc/docker/
  
  - name: load daemon
    shell: systemctl daemon-reload
  
  - name: start docker
    service: name=docker state=started enabled=yes
  
  - name: install compose
    copy: src=/data/ansible/files/docker-compose-Linux-x86_64-{{docker_compose_version}} dest=/usr/bin/docker-compose
  
  - name: set excute permission
    file: path=/usr/bin/docker-compose mode=755
  
  - name: mkdir /apps
    file: path=/apps state=directory
  
  - name: unarchive harbor package
    unarchive: src=/data/ansible/files/harbor-offline-installer-v{{harbor_version}}.tgz dest=/apps/
  
  - name: set harbor.cfg
    script: /data/ansible/files/harbor.sh
  
  - name: install python
    apt: name=python
  
  - name: install harbor
    shell: /apps/harbor/install.sh
  
  - name: copy harbor.service
    copy: src=/data/ansible/files/harbor.service dest=/lib/systemd/system/
  
  - name: service enable
    shell: systemctl daemon-reload;systemctl enable harbor
```

## 其他

### openstack-ansible

- https://github.com/openstack/openstack-ansible

### ansible-role-go

- https://github.com/PyratLabs/ansible-role-go

### k3s-ansible

- https://github.com/k3s-io/k3s-ansible

- https://github.com/techno-tim/k3s-ansible

- https://github.com/PyratLabs/ansible-role-k3s

### ansible-k8s-install

- https://github.com/iKubernetes/learning-k8s/tree/master/ansible-k8s-install

### ansible-install-k8s

- https://gitee.com/scajy/ansible-install-k8s

- https://gitee.com/zhenliangli/ansible-install-k8s

- https://gitee.com/xiaoqingyu/ansible-k8sPython-1.18.6

- https://gitee.com/phpdavid/ansible-k8s-v1.20

### kolla-ansible

https://gitee.com/yinianzhiyue/kolla-ansible

```

```

```

```
