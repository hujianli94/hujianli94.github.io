# 安装

## 1. Docker安装

=== "Centos系统"

    ```shell
    curl -o /etc/yum.repos.d/docker-ce.repo https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo
    sed -i 's#download.docker.com#mirrors.ustc.edu.cn/docker-ce#g' /etc/yum.repos.d/docker-ce.repo
    yum -y install docker-ce bash-completion
    cp /usr/share/bash-completion/completions/docker /etc/bash_completion.d/
    
    mkdir  /etc/docker
    cat > /etc/docker/daemon.json <<EOF
    {
      "data-root": "/var/lib/docker",
      "log-driver": "json-file",
      "log-opts": {
        "max-size": "200m",
        "max-file": "5"
      },
      "default-ulimits": {
        "nofile": {
          "Name": "nofile",
          "Hard": 655360,
          "Soft": 655360
        },
        "nproc": {
          "Name": "nproc",
          "Hard": 655360,
          "Soft": 655360
        }
      },
      "live-restore": true,
      "oom-score-adjust": -1000,
      "max-concurrent-downloads": 10,
      "max-concurrent-uploads": 10,
      "storage-driver": "overlay2",
      "storage-opts": ["overlay2.override_kernel_check=true"],
      "exec-opts": ["native.cgroupdriver=systemd"],
      "registry-mirrors": [
        "https://yssx4sxy.mirror.aliyuncs.com/"
      ]
    }
    EOF
    systemctl enable --now docker
    
    # 删除
    yum autoremove docker-ce
    rm -rf /var/lib/docker
    ```


=== "Ubuntu系统"

    ```shell
    sudo apt-get update
    sudo apt-get install apt-transport-https ca-certificates curl software-properties-common
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
    sudo apt-key fingerprint 0EBFCD88
    sudo add-apt-repository \
       "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
       $(lsb_release -cs) \
       stable"
    sudo apt-get update   
    apt-get install -y docker-ce bash-completion
    cp /usr/share/bash-completion/completions/docker /etc/bash_completion.d/
    
    cat > /etc/docker/daemon.json <<EOF
    {
      "data-root": "/var/lib/docker",
      "log-driver": "json-file",
      "log-opts": {
        "max-size": "200m",
        "max-file": "5"
      },
      "default-ulimits": {
        "nofile": {
          "Name": "nofile",
          "Hard": 655360,
          "Soft": 655360
        },
        "nproc": {
          "Name": "nproc",
          "Hard": 655360,
          "Soft": 655360
        }
      },
      "live-restore": true,
      "oom-score-adjust": -1000,
      "max-concurrent-downloads": 10,
      "max-concurrent-uploads": 10,
      "storage-driver": "overlay2",
      "storage-opts": ["overlay2.override_kernel_check=true"],
      "exec-opts": ["native.cgroupdriver=systemd"],
      "registry-mirrors": [
        "https://yssx4sxy.mirror.aliyuncs.com/"
      ]
    }
    EOF

    systemctl enable docker && systemctl restart docker
    
    # 删除
    apt-get remove -y docker docker-engine docker.io containerd runc
    rm -rf /var/lib/docker
    ```


=== "离线安装"

    ```shell
    $ wget https://download.docker.com/linux/static/stable/aarch64/docker-20.10.9.tgz
    $ tar zxf docker-20.10.9.tgz
    $ cp docker/* /usr/bin
    $ cat >/etc/systemd/system/docker.service <<EOF
    [Unit]
    Description=Docker Application Container Engine
    Documentation=https://docs.docker.com
    After=network-online.target firewalld.service
    Wants=network-online.target
    [Service]
    Type=notify
    ExecStart=/usr/bin/dockerd
    ExecReload=/bin/kill -s HUP $MAINPID
    LimitNOFILE=infinity
    LimitNPROC=infinity
    TimeoutStartSec=0
    Delegate=yes
    KillMode=process
    Restart=on-failure
    StartLimitBurst=3
    StartLimitInterval=60s
    [Install]
    WantedBy=multi-user.target
    EOF
    
    # 增加可执行权限
    $ sudo chmod +x /etc/systemd/system/docker.service
    # 重新加载配置文件
    $ sudo systemctl daemon-reload
    
    # 启动容器和设置开机自启
    $ sudo systemctl enable --now docker.service
    # 查看状态
    $ sudo systemctl status docker
    
    $ docker version
    # 配置镜像加速器
    $ cat > /etc/docker/daemon.json <<'EOF'
    {
      "graph": "/data/docker",
      "storage-driver": "overlay2",
      "insecure-registries": ["hub.gitee.com"],
      "registry-mirrors": ["https://25bxwt20.mirror.aliyuncs.com"],
      "live-restore": true,
      "bip": "172.16.200.1/24",
      "exec-opts": ["native.cgroupdriver=systemd"],
      "hosts": ["tcp://0.0.0.0:2375", "unix:///var/run/docker.sock"],
      "log-opts": {
        "max-size":"100M",
        "max-file":"3"
      }
    }
    EOF
    
    $ systemctl restart docker
    ```
    
    !!! tip "说明"
    
          说明：使用阿里云镜像加速，需要注册阿里云账号，通过进入功能菜单“弹性计算”->“容器镜像服务”->“管理控制台”->“镜像中心”->“镜像加速器”，找到操作指引。
    
    
    **Docker权限配置**
    
    Docker进程使用Unix Socket而不是TCP端口。而默认情况下，Unix socket属于root用户，因此需要root权限才能访问。所以需要创建用户组来访问和使用。
    
    ```shell
    # 添加docker用户组，如果docker用户组存在，则会提示“docker组已存在”
    sudo groupadd docker
    
    # 将当前用户（自定义用户，如：vagrant）添加至docker用户组中（语法：gpasswd -a $USER docker）
    # 检测当前用户（vagrant）是否已经在docker组中，检测不存在，则可将当前用户（USER=vagrant）添加至docker组
    sudo gpasswd -a vagrant docker 
    
    # 更新docker用户组
    newgrp docker
    ```
    
    
    **卸载Docker**
    
    ```shell
    # 1. 查找已安装介质
    yum list installed | grep docker
    # 2. 删除安装的软件包
    yum -y remove docker-ce.x86_64
    yum -y remove docker-ce-cli.x86_64
    # 3. 删除镜像/容器等
    rm -rf /var/lib/docker
    ```



=== "一键安装"
    
    官方提供的shell脚本
    ```shell
    $ curl -fsSL https://get.docker.com/ | sh
    
    # 或者
    $ wget -qO- https://get.docker.com/ | sh

    # 如果想尝鲜使用最新功能，可以使用下面的脚本来安装预发布版本。但要注意，预发布版本往往意味着功能还不够稳定，不要在生产环境中使用：
    $ curl -fsSL https://test.docker.com/ | sh
    ```
    

    阿里云安装脚本
    ```shell
    $ curl -sSL http://acs-public-mirror.oss-cn-hangzhou.aliyuncs.com/docker-engine/internet | sh -
    ```

    DaoCloud 的安装脚本
    ```shell
    $ curl -sSL https://get.daocloud.io/docker | sh
    ```



=== "docker-compose安装"

    ```shell
    $ sudo curl -L https://get.daocloud.io/docker/compose/releases/download/v2.4.1/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
    
    $ sudo chmod +x /usr/local/bin/docker-compose
    $ sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
    
    $ docker-compose version
    Docker Compose version v2.4.1
    ```

## 2. 开启Docker服务器的端口


=== "方式1"
上面是默认启动 docker，此时 docker 生成的文件都在 `/var/lib/docker`下面。

为了便于管理，可以做下面几个方面的优化：
- 指定新的数据目录。 
- 指定新的存储引擎。 
- 注册点设置，并指定国内的注册点，加速镜像下载。 
- 设置 docker 网络，默认 docker 网络指定的本地 docker0 网卡的网段为 172.17 。 
- 设置日志和其它。

配置方法，新增配置文件：
```shell
$ cat > /etc/docker/daemon.json << EOF
{
  "graph": "/data/docker",
  "storage-driver": "overlay2",
  "insecure-registries": ["registry.access.redhat.com", "quay.io"],
  "registry-mirrors": ["https://docker.mirrors.ustc.edu.cn"],
  "bip": "172.16.200.1/24",
  "exec-opts": ["native.cgroupdriver=systemd"],
  "hosts": ["tcp://0.0.0.0:2375", "unix:///var/run/docker.sock"],
  "log-opts": {
    "max-size":"100M",
    "max-file":"3"
  }
}
EOF
```


修改启动参数：
`vim /usr/lib/systemd/system/docker.service`
内容如下：删除掉启动参数后面的部分

`ExecStart=/usr/bin/dockerd`

此时重启docker：
```shell
$ systemctl daemon-reload
$ systemctl restart docker
```


!!! info "Docker配置文件说明"

    https://www.cnblogs.com/wt645631686/p/13356743.html




=== "方式2"

```shell
# 1.修改配置文件执行命令： 
vim /lib/systemd/system/docker.service
# 注释掉这行
#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock


# 2.将管理地址写入 /etc/profile
# 执行命令：
echo 'export DOCKER_HOST=tcp://0.0.0.0:2375' >> /etc/profile
source /etc/profile

# 3.重启服务
# 执行命令： 
systemctl daemon-reload && systemctl restart docker
```


